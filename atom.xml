<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>HelloDog</title>
  
  <subtitle>Keep Calm and Carry On</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://wsgzao.github.io/"/>
  <updated>2019-08-20T12:08:49.438Z</updated>
  <id>https://wsgzao.github.io/</id>
  
  <author>
    <name>wsgzao</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Google Chrome 浏览器插件和油猴脚本推荐</title>
    <link href="https://wsgzao.github.io/post/chrome-extensions/"/>
    <id>https://wsgzao.github.io/post/chrome-extensions/</id>
    <published>2019-08-20T06:59:49.000Z</published>
    <updated>2019-08-20T12:08:49.438Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>到了新加坡再也不用考虑科学上网的问题，加上 macOS 跨平台浏览器做得比较成熟的自然是 Google Chrome 和 Firefox，在 Windows 平台用了十几年的 Maxthon，期间也尝试过无数第三方浏览器，傲游浏览器努力改变着世界却也渐行渐远，有着同样命运的应该还包括我从 M8 用到 MX2 的魅族吧。回到 Google Chrome 浏览器插件和油猴脚本推荐正题，Google Chrome 除了最重要的快以外，更重要的是 Chrome Web Store 上一系列好用插件，我很喜欢 Chrome 简单纯粹的设计和极致的性能。在插件的推荐上分为 <code>通用</code> 和 <code>开发者</code> 两部分来写方便区分，大部分 Chrome 可用的插件 Firefox 也同样适用，如果有遗漏或有更好用的同类型插件和脚本欢迎留言分享。</p><blockquote><p>Google Chrome 浏览器插件和油猴脚本推荐</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 08 月 20 日 - 添加自用部分插件和脚本<br>2019 年 08 月 01 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/chrome-extensions/">https://wsgzao.github.io/post/chrome-extensions/</a></p><p><strong> 扩展阅读 </strong></p><p><a href="https://www.pcmag.com/article/247971/the-100-best-free-google-chrome-extensions" target="_blank" rel="noopener">The 100 Best Free Google Chrome Extensions</a></p><p><a href="https://www.runningcheese.com/extensions" target="_blank" rel="noopener">Chrome Firefox 双修，2019 年度最喜欢浏览器拓展</a></p><p><a href="https://www.runningcheese.com/userscripts" target="_blank" rel="noopener">脚本里的 “赤兔”，2019 年度最喜欢油猴脚本</a></p><hr><h2 id="Chrome-插件推荐"><a href="#Chrome-插件推荐" class="headerlink" title="Chrome 插件推荐"></a>Chrome 插件推荐</h2><blockquote><p>以下链接大部分都是 Google Chrome Webstore，如果无法访问可以考虑从第三方下载到本地导入</p></blockquote><p><a href="https://chrome.google.com/webstore/category/extensions" target="_blank" rel="noopener">Chrome Web Store</a></p><p><a href="https://www.crx4chrome.com/" target="_blank" rel="noopener">Crx4Chrome</a></p><p><a href="https://chrome-extension-downloader.com/" target="_blank" rel="noopener">Chrome Extension Downloader</a></p><h3 id="通用"><a href="#通用" class="headerlink" title="通用"></a>通用</h3><p><a href="https://chrome.google.com/webstore/detail/simpleextmanager/kniehgiejgnnpgojkdhhjbgbllnfkfdk" target="_blank" rel="noopener">SimpleExtManager</a> - 我个人首推的管理插件小工具，对于插件控们一定灰常有帮助</p><p><a href="https://chrome.google.com/webstore/detail/ie-tab/hehijbfgiekmjfkfjpbkbammjbdenadd" target="_blank" rel="noopener">IE Tab</a> - 为了向下兼容那些没有与时俱进的网站，大多数时候我们只能选择妥协</p><p><a href="https://chrome.google.com/webstore/detail/undo-closed-tabs-button/ieehkmoiljghfkejgahoheemdjpdinml" target="_blank" rel="noopener">Undo Closed Tabs Button</a> - Google 原生取消了恢复网页的按钮的设计，你可以通过快捷键或者历史记录恢复，但这个小工具确实可以帮到我</p><p><a href="https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo" target="_blank" rel="noopener">Tampermonkey</a> - 老牌的油猴管理工具，和 Violentmonkey 暴力猴相比哪款用得顺手选择哪个</p><p><a href="https://chrome.google.com/webstore/detail/cdonnmffkdaoajfknoeeecmchibpmkmg?hl=en" target="_blank" rel="noopener">沙拉查词 - 聚合词典划词翻译</a> - 我个人觉得这是目前 Chrome 划词翻译插件中体验最好的</p><p><a href="https://chrome.google.com/webstore/detail/grammarly-for-chrome/kbfnbcaeplbcioakkpcpgfkobkghlhen" target="_blank" rel="noopener">Grammarly for Chrome</a> - 智能检查英文语法拼写错误，在 Web 写邮件和文档时会发现它的重要价值</p><p><a href="https://chrome.google.com/webstore/detail/evernote-web-clipper/pioclpoplcdbaefihamjohnefbikjilc" target="_blank" rel="noopener">Evernote Web Clipper</a> - 中文称为印象笔记，平时会把优质的内容保存到 Evernote 中，虽然没有 OneNote 功能强大但胜在简单方便可跨平台同步</p><p><a href="https://chrome.google.com/webstore/detail/enable-right-click/gpeddepmnbmkjfnhifmggnjdggibjjkf" target="_blank" rel="noopener">破解右键锁</a> - 比 Enable Copy 更加强大，不过大众点评的评论好像无解</p><p><a href="https://chrome.google.com/webstore/detail/mbklgpngoohbbagagdfoccaclpdhgihd" target="_blank" rel="noopener">爱搜资源云盘助手</a> - 插件方便是方便，但是可能会涉及用户隐私数据，如果介意需要慎用类似插件</p><p><a href="https://chrome.google.com/webstore/detail/take-webpage-screenshots/mcbpblocgmgfnpjjppndjkmgjaogfceg" target="_blank" rel="noopener">FireShot</a> - 捕捉网页截图</p><p><a href="https://chrome.google.com/webstore/detail/proxy-switchyomega/padekgcemlokbadohgkifijomclgjgif" target="_blank" rel="noopener">Proxy SwitchyOmega</a> - 轻松快捷地管理和切换多个代理设置</p><p><a href="https://chrome.google.com/webstore/detail/ublock-origin/cjpalhdlnbpafiamejdnhcphjbkeiagm" target="_blank" rel="noopener">uBlock Origin</a> - 类似 Adblock Plus(ABP)，用于代替一款高效的网络请求过滤工具，占用极低的内存和 CPU，推荐额外添加适合自己的规则效果更佳</p><h3 id="开发者"><a href="#开发者" class="headerlink" title="开发者"></a>开发者</h3><p><a href="https://github.com/jaywcjlove/oscnews" target="_blank" rel="noopener">oscnews</a> - jaywcjlove 制作的新插件，目前我的主要用途是辅助新建标签页浏览开源中国更新资讯和 GitHub 趋势榜，从作者 TODO 计划来看，Github Start 管理和集成 octotree 部分功能都非常吸引人，加油</p><p><a href="https://github.com/zxlie/FeHelper" target="_blank" rel="noopener">FeHelper</a> - WEB 前端助手，All In One 的一个工具，包含多个独立小应用，比如：Json 工具、代码美化、代码压缩、二维码、Postman、markdown、网页油猴、便签笔记、信息加密与解密、随机密码生成、Crontab 等等</p><p><a href="https://github.com/openstyles/stylus" target="_blank" rel="noopener">Stylus</a> - Stylus 是基于 Stylish 调整网页外观的用户样式管理器</p><p><a href="https://chrome.google.com/webstore/detail/octotree/bkhaagjahfmjljalopjnoealnfndnagc" target="_blank" rel="noopener">Octotree</a> - 在 GitHub 上显示代码树</p><p><a href="http://www.pullywood.com/ImageAssistant/" target="_blank" rel="noopener">ImageAssistant</a> - 国人开发的图片助手 (ImageAssistant) 批量图片下载器</p><p><a href="https://github.com/BlackGlory/copycat" target="_blank" rel="noopener">Copycat</a> - 我主要是为了复制网页直接转化为 markdown</p><p><a href="https://github.com/oppoic/JSONViewer/" target="_blank" rel="noopener">JSONViewer</a> - 一个页面格式化多条 JSON，提升工作效率</p><p><a href="https://github.com/gildas-lormeau/SingleFile" target="_blank" rel="noopener">SingleFile</a> - 将完整的页面保存到一个 HTML 文件中</p><p><a href="https://www.uku.im" target="_blank" rel="noopener">Unblock Youku</a> - 我平时很少看国内在线视频，不过这款良心插件已经坚持了 5 年，作者不容易。如果速度不稳定大家也可以购买国内的阿里云、腾讯云等，我始终相信云即未来</p><p><a href="https://github.com/vinta/pangu.js" target="_blank" rel="noopener">为什么你们就是不能加个空格呢？</a> - 对文字排版有强迫症的福音吧</p><p><a href="https://github.com/sciooga/v2ex-plus" target="_blank" rel="noopener">v2ex plus</a> - 可能是 v2ex 最好用的扩展</p><h2 id="油猴脚本推荐"><a href="#油猴脚本推荐" class="headerlink" title="油猴脚本推荐"></a>油猴脚本推荐</h2><blockquote><p>我个人的选择是 TemperMoneky &gt; ViolentMoneky</p></blockquote><p><a href="https://www.tampermonkey.net" target="_blank" rel="noopener">Tampermonkey</a> - Tampermonkey 是一款免费的浏览器扩展和最为流行的用户脚本管理器</p><p><a href="https://greasyfork.org/zh-CN" target="_blank" rel="noopener">Greasy Fork</a> - 这里是一个提供用户脚本的网站</p><h3 id="通用-1"><a href="#通用-1" class="headerlink" title="通用"></a>通用</h3><p><a href="https://greasyfork.org/zh-CN/scripts/329484" target="_blank" rel="noopener">豆瓣资源下载大师</a> - 装这一个脚本就够了！可能是你遇到的最好的豆瓣增强脚本</p><p><a href="https://greasyfork.org/zh-CN/scripts/29762" target="_blank" rel="noopener">网盘自动填写密码【威力加强版】</a> - 这个功能比插件弱一些，好处就是不涉及上传隐私数据</p><p><a href="https://greasyfork.org/zh-CN/scripts/370634" target="_blank" rel="noopener">懒人专用，自用组合型多功能脚本</a> - 为避免争议，各位可以阅读脚本描述后决定是否使用</p><p><a href="https://greasyfork.org/zh-CN/scripts/25718" target="_blank" rel="noopener">解除 B 站区域限制</a> - 通过替换获取视频地址接口的方式，实现解除 B 站区域限制</p><p><a href="https://tiansh.github.io/yawf/" target="_blank" rel="noopener">YAWF</a> - 新浪微博根据关键词、作者、话题、来源等过滤微博，清理版面，以及其他改造功能</p><p><a href="https://tiansh.github.io/us-else/zhihu_visitor/" target="_blank" rel="noopener">知乎免登录</a> - 如题</p><p><a href="https://greasyfork.org/zh-CN/scripts/2312" target="_blank" rel="noopener">右键在新标签中打开图片时显示最优化图像质量</a> - 支持：谷歌 (G+ blogspot YouTube)、Tumblr、推特、Steam、新浪微博、知乎、豆瓣、百度贴吧、淘宝（天猫）、ArtStation、Pinimg 等</p><h3 id="开发者-1"><a href="#开发者-1" class="headerlink" title="开发者"></a>开发者</h3><blockquote><p>不解释，大伙都是为了努力学习新知识，但你值得拥有一种更舒服的姿势</p></blockquote><p><a href="https://greasyfork.org/zh-CN/scripts/23840" target="_blank" rel="noopener">大人的 Greasyfork</a></p><p><a href="https://sleazyfork.org/zh-CN/scripts/25781" target="_blank" rel="noopener">JAV 老司机</a></p><p><a href="https://greasyfork.org/zh-CN/scripts/23316" target="_blank" rel="noopener">琉神转</a></p>]]></content>
    
    <summary type="html">
    
      Google Chrome浏览器插件和油猴脚本推荐
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>泰国普吉岛和甲米的旅游经历分享</title>
    <link href="https://wsgzao.github.io/post/thailand/"/>
    <id>https://wsgzao.github.io/post/thailand/</id>
    <published>2019-08-16T06:59:49.000Z</published>
    <updated>2019-08-16T10:39:31.787Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>2017/2018 年末加上 2019 年 8 月分别去了泰国的普吉岛和甲米旅游，说实话泰国普吉岛的蜜月旅行也是我的第一次出国经历，当然没想到的是一年后我已经从上海飞到了新加坡，如果你对新加坡的工作和生活感兴趣可以搜索《从国内跳槽至新加坡工作的经验分享》。这篇文章算是对泰国之旅的补交作业吧，大部分以文字描述为主不做剧透，不吹不黑列举和点评自己购买的第三方服务体验感受，想去泰国旅游的朋友可以参考下。</p><blockquote><p>泰国普吉岛和甲米的旅游经历分享</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 08 月 16 日 - 更新泰国普吉岛第 2 次旅游<br>2019 年 01 月 20 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/thailand/">https://wsgzao.github.io/post/thailand/</a></p><p><strong> 扩展阅读 </strong></p><p>泰国国家旅游局 - <a href="http://amazingthailand.org.cn/" target="_blank" rel="noopener">http://amazingthailand.org.cn/</a></p><hr><h2 id="普吉岛-Phuket-2017"><a href="#普吉岛-Phuket-2017" class="headerlink" title="普吉岛. Phuket 2017"></a>普吉岛. Phuket 2017</h2><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190816165407.jpeg" alt=""></p><p>时间: 20171206-20171212<br>行程: 半自由行<br>签证: 普通旅游签，爱游蜜月套餐<br>通信: Happy 卡，爱游蜜月套餐<br>人数: 2<br>天数: 7 天 5 晚<br>机票: 上海至泰国普吉岛直飞往返，吉祥航空，爱游蜜月套餐<br>酒店: 卡里玛水疗度假村 3 晚 + 卡塔塔尼海滩度假村 2 晚，爱游蜜月套餐</p><p>提前预定项目: 价格为 1 人单价</p><ul><li>爱游泰国旅游普吉岛自由行 7 天 5 星蜜月春节机票飞猪，￥8699.00</li><li>浦发龙腾出行礼宾车机场接送机</li><li>浪花朵朵旅行 普吉岛王权免税店一日游骑大象自助餐泰国 KingPower，￥9.79</li><li>浪花朵朵旅行泰国普吉岛素可 Sukko Spa 90 分钟蜜月套餐 泰式按摩，￥492.37</li><li>浪花朵朵旅行普吉岛一日游大小皇帝岛浮潜海钓泰国旅游女神号游艇，￥592.23</li><li>浪花朵朵旅行普吉岛绿洲 SPA 水疗馆 The Oasis Spa 泰国绿洲 泰式按摩，￥463.69</li></ul><p>当地购买项目: 行程比较紧凑，去了班赞海鲜市场也没有购买欲望</p><p>小结:</p><ol><li>首次出国就是蜜月旅行，在选择地点时也受到《欢乐颂》安迪最后选择去普吉岛，出于稳妥的考虑选择了半自由行 + 当地游的方式，缺点自然是花钱买省心。如果你往下看第二次去甲米的行程基本就是自由行 + 当地游，费用大幅减少而时间成本其实也没有增加很多</li><li>这次普吉岛只安排 1 天出海行程，我没有选择斯米兰因为不考虑深潜。结合下面甲米 2 次出海经历，我这里推荐大家尽可能选择靠谱的精致小团，在长时间坐游艇和游玩项目过程中体验会提升不少</li><li>普吉岛的整体商业化程度高体现在吃喝玩乐各个方面，而普吉岛 SPA 的 2 次体验都非常棒，尤其是最后一天绿洲 SPA 是目前我所接触过最舒服的一次双人 SPA，连洗澡都贴心的配置了 2 个花洒，安静且私密性极好，价格也没有很贵，非常值得二刷</li><li>虽然酒店是爱游搭配的，但是我现在可以理解 7 天行程住 2 种不同酒店的意义，高中搭配会带来新鲜的感受，成本上也会节约不少，就是中间牺牲更换酒店的时间有一点折腾</li><li>普吉岛的项目由于安排的有些紧凑导致没有太多睡到自然醒的休闲时间，毕竟出国一次也不容易想着到处多转转长长见识。如果条件允许推荐大家采用自由行 + 当地游的组合，出发前签证等重要材料一定要准备充分，不要辜负自己宝贵的假期哈</li></ol><h2 id="甲米-Krabi-2018"><a href="#甲米-Krabi-2018" class="headerlink" title="甲米. Krabi 2018"></a>甲米. Krabi 2018</h2><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190816165012.jpeg" alt=""></p><p>时间: 20181204-20181209<br>行程: 自由行<br>签证: 落地签，免费<br>通信: 华为天际通，泰国 5 日行￥58.00<br>人数: 2<br>天数: 6 天 5 晚<br>机票: 酷航 TR686 新加坡 - 甲米, TR689 甲米 - 新加坡, ￥1192.00, 飞猪<br>酒店: Sugar Marina CLIFFHANGER 池景高级房, ￥1992.25, 飞猪</p><p>提前预定项目: 价格为 1 人单价</p><ul><li>浪花朵朵旅行泰国甲米接送机接机送机机场接送服务中文可急单，￥245.69</li><li>浪花朵朵 甲米翡翠池一日游温泉瀑布虎窟寺 ATV 皮划艇骑大象半日游，￥340.92</li><li>浪花朵朵泰国曼谷 lets relax spa 普吉岛清迈芭提雅甲米泰式按摩，￥299.52</li><li>浪花朵朵旅行 甲米一日游皮皮岛 pp 岛竹子岛四岛兰塔岛 快艇浮潜，￥329.57</li><li>浪花朵朵 洛克岛一日游兰塔 Rok 哈岛 游艇浮潜水 泰国甲米旅游中文，￥494.35</li></ul><p>当地购买项目: 记不清楚价格，仅列举自己推荐的店</p><ul><li>奥南按摩角中心</li><li>Jungle Kitchen</li><li>Ton Ma Yom Thai Food Restaurant</li><li>Kodam Kitchen</li></ul><p>小结:</p><ol><li>如果我可以重新选择会去掉翡翠池，lets relax spa，2 天的出海。翡翠池和九寨沟相比就是小巫见大巫，关于出海我不喜欢深潜，所以浮潜的效果会差好多，而且非常容易晒伤皮肤，需要很早出发然后长时间航行，对于不喜欢坐船的小伙伴来说是挺难受的。</li><li>体验过奥南按摩角中心基本就不会再考虑其它按摩馆了，技师年龄加手法都很成熟，整过过程没有过多的闲聊和休息，做足了时长。</li><li>由于时间和路程原因没有体验甲米镇的夜市，奥南夜市很一般，还是推荐大家多体验我上面写的 3 家餐厅，对食物如果没有忌口可以从热门推荐菜开始尝试。</li><li>落地签需要稍微多花一些填表时间，不过我们没有被要求重新现场拍照，省去了 2000 泰铢签证费用还是很划算的。</li></ol><h2 id="普吉岛-Phuket-2019"><a href="#普吉岛-Phuket-2019" class="headerlink" title="普吉岛. Phuket 2019"></a>普吉岛. Phuket 2019</h2><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190816165431.jpeg" alt=""></p><p>时间: 20190804-20190809<br>行程: 自由行<br>签证: 落地签免费，入境时需要交纳 200 泰铢服务费名曰快速通道<br>通信: 华为天际通，泰国 7 日行￥89.00<br>人数: 2<br>天数: 6 天 5 晚<br>机票: 捷星亚洲航空 3K535 新加坡 - 普吉岛, 3K536 普吉岛 - 新加坡, ￥556.00, 飞猪<br>酒店: 普吉自然酒店 (The Nature Phuket) 池景豪华房, ￥2328.70, 飞猪</p><p>提前预定项目: 价格为 1 人单价</p><ul><li>浪花朵朵旅行普吉岛接机送机服务普吉接送机机场接机 24 时泰国旅游，￥78.15</li><li>浪花朵朵旅行 普吉岛王权免税店自助餐 king power 可接送泰国旅游，￥0.01</li><li>浪花朵朵旅行 普吉岛 Dream Spa 梦水疗馆泰式按摩赠网红小吃可接送，￥355.11</li></ul><p>当地购买项目: 这次没有订任何出海项目，就是盯着当地美食和 SPA 上</p><ul><li>MOONTREE | Elemental Spa(Patong Beach) ，钻石梦幻 3200 泰铢现金 1 人</li><li>Doo Dee Thai Food</li><li>6 号餐厅 No. 6 Restaurant</li><li>Dang Restaurant </li><li>After You</li><li>椰子冰激凌</li></ul><p>小结:</p><ol><li>第二次来普吉岛，这次没有安排出海行程，所以每天都可以睡到自然醒，行程没有那么紧凑人也不会像之前那么累。本来计划想考取 padi 潜水证或者去斯米兰体验下深潜，可惜时间没开放，建议大家出行前确认下开放时间和天气情况。</li><li>这次住的酒店 The Nature 和第一次 Kalima 离得蛮近都在芭东海滩，因为没有选择去很远的地方所以整个行程没有单独花钱坐车，酒店有班车往返 Jungceylon 江西冷购物中心，一般购物可以去 Big C 或者对面的 Central，网红的吃饭点也都在附近，十分方便。</li><li>因为行程很宽松所以我们特意岔开饭点时间去体验了泰国当地的网红美食，虽然不用排队但非饭点吃饭的人还是挺多的，不是第一次来泰国之前也吃过甲米的美食，整体都还行吧。这里友情提醒下各位慎重前往大众点评上长期霸榜的两兄弟和第一海鲜，600 泰铢一斤的超大龙虾或者皮皮虾会贵上一倍都不止，都不知道这么高评价怎么来的，店里一个外国人都没有和 6 号餐厅相比真是天壤之别。如果你不喜欢被热情的拉扯和激烈的砍价我也不建议你去班赞海鲜，若是喜欢吃海鲜回国内去盒马现做现吃也挺自在。</li><li>关于 SPA 我引用一下大众点评的一条评价，作为一个体验过 Divana、绿洲、Let’s relax、万豪酒店 Spa、Deep relax 等等的顾客，这家店绝对物有所值，我赞同大部分观点，MOONTREE 和 Oasis Spa 可以打个平手吧，也许未来真应该去体验下传说中悦榕庄 SPA。</li></ol><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote><p>3 次泰国旅游经历可以为将来更远的旅行打下扎实的基础</p></blockquote><ol><li>通过 3 次的泰国旅行，浮潜可能不是我的菜，大家注意水下安全和晒伤，美食和 SPA 的体验都非常棒</li><li>确认目的地的天气，开放项目和人流量，除了机票和酒店推荐提前预定接送机，出海和 SPA 等项目，虽然一定比当地预定贵一丢丢，但节约了时间成本，辅助你规划行程，不过千万不要把行程安排的过于紧凑，避免牵一发而动全身，旅游嘛开心最重要。</li><li>旅行攻略除了国内的美团点评和小红书等以外，推荐 TripAdvisor，俗称猫头鹰</li><li>东南亚移动支付越来越普及，真的可以期待未来走出国门也无需带钱包那一刻到来</li><li>无论选择去哪里旅游切记人身安全才是第一位的，祝大家旅途愉快哈</li></ol>]]></content>
    
    <summary type="html">
    
      泰国普吉岛和甲米的旅游经历分享
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>基于 bash find 命令执行 log 日志备份和清理的一次简单实践</title>
    <link href="https://wsgzao.github.io/post/find/"/>
    <id>https://wsgzao.github.io/post/find/</id>
    <published>2019-07-29T06:59:49.000Z</published>
    <updated>2019-08-02T11:28:45.878Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>find 作为最基础的 bash shell 命令之一我就不多做介绍了，由于每月压缩后的日志增长量已经超过 20TB，和 PB 相比应该还不算很大，选择的日志归档同步方案是 <a href="https://github.com/facebookarchive/scribe" target="_blank" rel="noopener">Facebook Scribe</a>，之后或许会基于<a href="https://www.elastic.co/cn/what-is/elk-stack" target="_blank" rel="noopener">ELK</a> 或<a href="https://grafana.com/oss/loki" target="_blank" rel="noopener">Grafana Loki</a>搭建日志实时分析平台，不过眼下的问题还是想办法在没有商业化集中式存储和软件定义分布式存储的支持下，用比较简单粗暴的方法苦苦支撑，本文分享了一些简单的小技巧方便回顾和二次利用。</p><blockquote><p>基于 bash find 命令执行 log 日志备份和清理日志简单实践</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 07 月 29 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/find/">https://wsgzao.github.io/post/find/</a></p><p><strong> 扩展阅读 </strong></p><p><a href="https://linux.die.net/man/1/find" target="_blank" rel="noopener">find</a></p><hr><h2 id="find"><a href="#find" class="headerlink" title="find"></a>find</h2><p>find - search for files in a directory hierarchy</p><p><a href="https://linux.die.net/man/1/find" target="_blank" rel="noopener">https://linux.die.net/man/1/find</a></p><p>find 命令用来在指定目录下查找文件。任何位于参数之前的字符串都将被视为欲查找的目录名。如果使用该命令时，不设置任何参数，则 find 命令将在当前目录下查找子目录与文件。并且将查找到的子目录和文件全部进行显示。</p><p><a href="https://man.linuxde.net/find" target="_blank" rel="noopener">https://man.linuxde.net/find</a></p><h2 id="How-to-use"><a href="#How-to-use" class="headerlink" title="How to use"></a>How to use</h2><blockquote><p>log archive</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SHELL=/bin/bash</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">MAILTO=root</span><br><span class="line"></span><br><span class="line"><span class="comment"># For details see man 4 crontabs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example of job definition:</span></span><br><span class="line"><span class="comment"># .---------------- minute (0 - 59)</span></span><br><span class="line"><span class="comment"># |  .------------- hour (0 - 23)</span></span><br><span class="line"><span class="comment"># |  |  .---------- day of month (1 - 31)</span></span><br><span class="line"><span class="comment"># |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...</span></span><br><span class="line"><span class="comment"># |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat</span></span><br><span class="line"><span class="comment"># |  |  |  |  |</span></span><br><span class="line"><span class="comment"># *  *  *  *  * user-name  command to be executed</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#zip</span></span><br><span class="line"><span class="comment">#15 3 * * * root cd /opt/sa_scripts/archive_from_date &amp;&amp; bash run.sh   /data/gop/live/primary/gop 2</span></span><br><span class="line">15 3 * * * root bash /opt/sa_scripts/archive_from_date/one_run_2d.sh</span><br></pre></td></tr></table></figure><blockquote><p>log backup and cleanup</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/scripts</span><br><span class="line">./check_original_log.sh 2019-05</span><br><span class="line">./move_backup.sh 2019-05</span><br><span class="line">./check_backup_log.sh 2019-05</span><br><span class="line">nohup sh rsync_backup_10-71-12-61.sh &gt; <span class="built_in">log</span>/2019-04.rsync.out 2&gt;&amp;1 &amp;</span><br><span class="line">nohup sh rsync_backup_10-71-14-132.sh &gt; <span class="built_in">log</span>/2019-05.rsync.out 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><h2 id="log-archive"><a href="#log-archive" class="headerlink" title="log archive"></a>log archive</h2><blockquote><p>archive_from_date.sh</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#to compress all files like:</span></span><br><span class="line"><span class="comment">#auth_data-2017-01-11_00000</span></span><br><span class="line"><span class="comment">#auth_data-2017-01-11_00001</span></span><br><span class="line"><span class="comment">#auth_data-2017-01-11_00002</span></span><br><span class="line"><span class="comment">#auth_data-2017-01-11_00003</span></span><br><span class="line"><span class="comment">#auth_data-2017-01-12_00000</span></span><br><span class="line"><span class="comment">#auth_data-2017-01-12_00001</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#by day till the specified date</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$#</span>"</span> -lt 2 ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Usage: <span class="variable">$0</span> path archive_days [trailing_digit]"</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">FILE_PATH=<span class="variable">$1</span></span><br><span class="line">ARCHIVE_DAYS=<span class="variable">$2</span></span><br><span class="line"><span class="comment">#seems no need traling digit param here</span></span><br><span class="line">TRAILING_DIGIT=<span class="variable">$3</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$&#123;TRAILING_DIGIT//&#125;</span>"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">TRAILING_DIGIT=6</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">start_date=<span class="string">"2017-01-01"</span></span><br><span class="line"></span><br><span class="line">end_date=`date`</span><br><span class="line">end_date=`date -d -<span class="variable">$&#123;ARCHIVE_DAYS&#125;</span>days +%Y-%m-%d`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Scanning from <span class="variable">$start_date</span> to <span class="variable">$end_date</span> (not inclusive)"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"=================================="</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">"<span class="variable">$end_date</span>"</span> &lt; <span class="string">"<span class="variable">$start_date</span>"</span> ]]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Invalid end date: <span class="variable">$end_date</span>,it should be later than start date: <span class="variable">$&#123;start_date&#125;</span>. Exit..."</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">RESULT_PATH=/tmp/log_archive</span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="string">"<span class="variable">$RESULT_PATH</span>"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">mkdir -p <span class="variable">$RESULT_PATH</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$FILE_PATH</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> [ <span class="string">"<span class="variable">$start_date</span>"</span> != <span class="string">"<span class="variable">$end_date</span>"</span> ]</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="keyword">if</span> ls *<span class="variable">$&#123;start_date&#125;</span>*[0-9] 1&gt;/dev/null 2&gt;&amp;1</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Compressing: <span class="variable">$start_date</span>"</span></span><br><span class="line">first_file=`ls *<span class="variable">$&#123;start_date&#125;</span>*[0-9]|head -1`</span><br><span class="line">file_name=<span class="variable">$&#123;first_file%_*&#125;</span></span><br><span class="line">tar cvzf <span class="variable">$&#123;file_name&#125;</span>.tgz <span class="variable">$&#123;file_name&#125;</span>*[0-9]</span><br><span class="line"></span><br><span class="line"><span class="comment">##Case 1: compare tar size with origin, uncomment if needed</span></span><br><span class="line"><span class="comment">#original_size=`ls -l *$&#123;start_date&#125;*[0-9]|awk '&#123;sum+=$5&#125; END &#123;print sum&#125;'`</span></span><br><span class="line"><span class="comment">#weighted_size=$((original_size/20))</span></span><br><span class="line"><span class="comment">#tar_size=`ls -l $&#123;file_name&#125;.tgz|awk '&#123;print $5&#125;'`</span></span><br><span class="line"><span class="comment">#echo $tar_size,$weighted_size</span></span><br><span class="line"><span class="comment">#if (( $tar_size &lt; $weighted_size ))</span></span><br><span class="line"><span class="comment">#then</span></span><br><span class="line"><span class="comment">#echo "tar size: $&#123;tar_size&#125;; weighted size:$&#123;weighted_size&#125;"</span></span><br><span class="line"><span class="comment">#echo "tar size too small; not deleting origin"</span></span><br><span class="line"><span class="comment">#echo "`pwd`: $file_name" &gt;&gt;/opt/sa_scripts/archive/result</span></span><br><span class="line"><span class="comment">#else</span></span><br><span class="line"><span class="comment">#echo "Done.Deleting origin."</span></span><br><span class="line"><span class="comment">#rm $&#123;file_name&#125;*[0-9]</span></span><br><span class="line"><span class="comment">#fi</span></span><br><span class="line"><span class="comment">##End of Case 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##############</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Case 2, compare tar size with 0</span></span><br><span class="line">tar_size=`ls -l <span class="variable">$&#123;file_name&#125;</span>.tgz|awk <span class="string">'&#123;print $5&#125;'</span>`</span><br><span class="line"><span class="keyword">if</span> (( <span class="variable">$tar_size</span> &gt; 0 ))</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Done.Deleting origin."</span></span><br><span class="line">rm <span class="variable">$&#123;file_name&#125;</span>*[0-9]</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"tar file size is ZERO!"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"`pwd`: <span class="variable">$file_name</span>"</span> &gt;&gt;<span class="variable">$RESULT_PATH</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment">#End of Case 2</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">start_date=$(date -I -d <span class="string">"<span class="variable">$start_date</span> +1day"</span>)</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><blockquote><p>archive_from_day.sh</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># bash one_day.sh /data/gop/live/primary/gop 2017-01-11</span></span><br><span class="line"></span><br><span class="line">FILE_PATH=<span class="variable">$1</span></span><br><span class="line">ARCHIVE_DAYS=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line">start_date=<span class="variable">$ARCHIVE_DAYS</span></span><br><span class="line"></span><br><span class="line">end_date=<span class="variable">$ARCHIVE_DAYS</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Scanning from <span class="variable">$start_date</span> to <span class="variable">$end_date</span> (not inclusive)"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"=================================="</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RESULT_PATH=/tmp/log_archive</span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="string">"<span class="variable">$RESULT_PATH</span>"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">mkdir -p <span class="variable">$RESULT_PATH</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$FILE_PATH</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ls *<span class="variable">$&#123;start_date&#125;</span>*[0-9] 1&gt;/dev/null 2&gt;&amp;1</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Compressing: <span class="variable">$start_date</span>"</span></span><br><span class="line">first_file=`ls *<span class="variable">$&#123;start_date&#125;</span>*[0-9]|head -1`</span><br><span class="line">file_name=<span class="variable">$&#123;first_file%_*&#125;</span></span><br><span class="line">tar cvzf <span class="variable">$&#123;file_name&#125;</span>.tgz <span class="variable">$&#123;file_name&#125;</span>*[0-9]</span><br><span class="line"><span class="comment">#Case 2, compare tar size with 0</span></span><br><span class="line">tar_size=`ls -l <span class="variable">$&#123;file_name&#125;</span>.tgz|awk <span class="string">'&#123;print $5&#125;'</span>`</span><br><span class="line"><span class="keyword">if</span> (( <span class="variable">$tar_size</span> &gt; 0 ))</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Done.Deleting origin."</span></span><br><span class="line">rm <span class="variable">$&#123;file_name&#125;</span>*[0-9]</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"tar file size is ZERO!"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"`pwd`: <span class="variable">$file_name</span>"</span> &gt;&gt;<span class="variable">$RESULT_PATH</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment">#End of Case 2</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><blockquote><p>run.sh</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">PARENT_PATH=<span class="variable">$1</span></span><br><span class="line">ARCHIVE_DAY=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$#</span>"</span> -ne 2 ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Usage: <span class="variable">$0</span> parent_path archive_day"</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> folder <span class="keyword">in</span> $(find <span class="variable">$PARENT_PATH</span> -<span class="built_in">type</span> d -links 2)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"processing:<span class="variable">$&#123;folder&#125;</span>..."</span></span><br><span class="line">./archive_from_date.sh <span class="variable">$folder</span> <span class="variable">$ARCHIVE_DAY</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><blockquote><p>one_run_2d.sh</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">end_date=`date -d -2days +%Y-%m-%d`</span><br><span class="line"></span><br><span class="line">nohup bash /opt/sa_scripts/archive_from_date/one_run.sh /data/gop/live/primary/gop <span class="variable">$end_date</span> &gt; /opt/sa_scripts/archive_from_date/logs/<span class="variable">$end_date</span>.<span class="built_in">log</span> 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><blockquote><p>one_run.sh</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">PARENT_PATH=<span class="variable">$1</span></span><br><span class="line">ARCHIVE_DAY=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$#</span>"</span> -ne 2 ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Usage: <span class="variable">$0</span> parent_path archive_day"</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> folder <span class="keyword">in</span> $(find <span class="variable">$PARENT_PATH</span> -<span class="built_in">type</span> d -links 2)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"processing:<span class="variable">$&#123;folder&#125;</span>..."</span></span><br><span class="line">/opt/sa_scripts/archive_from_date/day.sh <span class="variable">$folder</span> <span class="variable">$ARCHIVE_DAY</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><blockquote><p>log example</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line">total 2197444</span><br><span class="line">-rw-r--r-- 1 root root 35386495 Jun  3 21:20 gop-live-point_txn_aggregator-data-2019-06-01.tgz</span><br><span class="line">-rw-r--r-- 1 root root 33273034 Jun  4 20:37 gop-live-point_txn_aggregator-data-2019-06-02.tgz</span><br><span class="line">-rw-r--r-- 1 root root 33390884 Jun  5 20:23 gop-live-point_txn_aggregator-data-2019-06-03.tgz</span><br><span class="line">-rw-r--r-- 1 root root 35553038 Jun  6 20:18 gop-live-point_txn_aggregator-data-2019-06-04.tgz</span><br><span class="line">-rw-r--r-- 1 root root 35081679 Jun  7 19:16 gop-live-point_txn_aggregator-data-2019-06-05.tgz</span><br><span class="line">-rw-r--r-- 1 root root 35397705 Jun  8 19:17 gop-live-point_txn_aggregator-data-2019-06-06.tgz</span><br><span class="line">-rw-r--r-- 1 root root 36039754 Jun  9 18:55 gop-live-point_txn_aggregator-data-2019-06-07.tgz</span><br><span class="line">-rw-r--r-- 1 root root 38596404 Jun 10 20:22 gop-live-point_txn_aggregator-data-2019-06-08.tgz</span><br><span class="line">-rw-r--r-- 1 root root 38048982 Jun 11 20:26 gop-live-point_txn_aggregator-data-2019-06-09.tgz</span><br><span class="line">-rw-r--r-- 1 root root 33026017 Jun 12 19:16 gop-live-point_txn_aggregator-data-2019-06-10.tgz</span><br><span class="line">-rw-r--r-- 1 root root 29198108 Jun 13 19:56 gop-live-point_txn_aggregator-data-2019-06-11.tgz</span><br><span class="line">-rw-r--r-- 1 root root 25771109 Jun 14 19:19 gop-live-point_txn_aggregator-data-2019-06-12.tgz</span><br><span class="line">-rw-r--r-- 1 root root 26092930 Jun 15 19:09 gop-live-point_txn_aggregator-data-2019-06-13.tgz</span><br><span class="line">-rw-r--r-- 1 root root 35349519 Jun 16 19:13 gop-live-point_txn_aggregator-data-2019-06-14.tgz</span><br><span class="line">-rw-r--r-- 1 root root 31780817 Jun 17 21:27 gop-live-point_txn_aggregator-data-2019-06-15.tgz</span><br><span class="line">-rw-r--r-- 1 root root 36549729 Jun 18 21:57 gop-live-point_txn_aggregator-data-2019-06-16.tgz</span><br><span class="line">-rw-r--r-- 1 root root 26007332 Jun 19 19:58 gop-live-point_txn_aggregator-data-2019-06-17.tgz</span><br><span class="line">-rw-r--r-- 1 root root 25114440 Jun 20 19:20 gop-live-point_txn_aggregator-data-2019-06-18.tgz</span><br><span class="line">-rw-r--r-- 1 root root 22494565 Jun 21 19:25 gop-live-point_txn_aggregator-data-2019-06-19.tgz</span><br><span class="line">-rw-r--r-- 1 root root 25132986 Jun 22 19:19 gop-live-point_txn_aggregator-data-2019-06-20.tgz</span><br><span class="line">-rw-r--r-- 1 root root 30698833 Jun 23 20:08 gop-live-point_txn_aggregator-data-2019-06-21.tgz</span><br><span class="line">-rw-r--r-- 1 root root 38639032 Jun 24 21:12 gop-live-point_txn_aggregator-data-2019-06-22.tgz</span><br><span class="line">-rw-r--r-- 1 root root 31422932 Jun 25 21:27 gop-live-point_txn_aggregator-data-2019-06-23.tgz</span><br><span class="line">-rw-r--r-- 1 root root 25262186 Jun 26 19:57 gop-live-point_txn_aggregator-data-2019-06-24.tgz</span><br><span class="line">-rw-r--r-- 1 root root 25402079 Jun 27 19:30 gop-live-point_txn_aggregator-data-2019-06-25.tgz</span><br><span class="line">-rw-r--r-- 1 root root 22227072 Jun 28 17:09 gop-live-point_txn_aggregator-data-2019-06-26.tgz</span><br><span class="line">-rw-r--r-- 1 root root 26174268 Jun 29 19:59 gop-live-point_txn_aggregator-data-2019-06-27.tgz</span><br><span class="line">-rw-r--r-- 1 root root 27484303 Jun 30 20:43 gop-live-point_txn_aggregator-data-2019-06-28.tgz</span><br><span class="line">-rw-r--r-- 1 root root 25607704 Jul  1 21:37 gop-live-point_txn_aggregator-data-2019-06-29.tgz</span><br><span class="line">-rw-r--r-- 1 root root 23545276 Jul  2 21:34 gop-live-point_txn_aggregator-data-2019-06-30.tgz</span><br><span class="line">-rw-r--r-- 1 root root 28956480 Jul  3 21:03 gop-live-point_txn_aggregator-data-2019-07-01.tgz</span><br><span class="line">-rw-r--r-- 1 root root 27250475 Jul  4 20:21 gop-live-point_txn_aggregator-data-2019-07-02.tgz</span><br><span class="line">-rw-r--r-- 1 root root 26443417 Jul  5 20:56 gop-live-point_txn_aggregator-data-2019-07-03.tgz</span><br><span class="line">-rw-r--r-- 1 root root 23445274 Jul  6 20:28 gop-live-point_txn_aggregator-data-2019-07-04.tgz</span><br><span class="line">-rw-r--r-- 1 root root 35914567 Jul  7 21:01 gop-live-point_txn_aggregator-data-2019-07-05.tgz</span><br><span class="line">-rw-r--r-- 1 root root 42759699 Jul  8 21:46 gop-live-point_txn_aggregator-data-2019-07-06.tgz</span><br><span class="line">-rw-r--r-- 1 root root 41146298 Jul  9 23:28 gop-live-point_txn_aggregator-data-2019-07-07.tgz</span><br><span class="line">-rw-r--r-- 1 root root 30890861 Jul 10 21:50 gop-live-point_txn_aggregator-data-2019-07-08.tgz</span><br><span class="line">-rw-r--r-- 1 root root 29505781 Jul 11 22:16 gop-live-point_txn_aggregator-data-2019-07-09.tgz</span><br><span class="line">-rw-r--r-- 1 root root 25130694 Jul 12 21:04 gop-live-point_txn_aggregator-data-2019-07-10.tgz</span><br><span class="line">-rw-r--r-- 1 root root 30355468 Jul 13 21:44 gop-live-point_txn_aggregator-data-2019-07-11.tgz</span><br><span class="line">-rw-r--r-- 1 root root 32142222 Jul 14 22:47 gop-live-point_txn_aggregator-data-2019-07-12.tgz</span><br><span class="line">-rw-r--r-- 1 root root 30846192 Jul 15 22:54 gop-live-point_txn_aggregator-data-2019-07-13.tgz</span><br><span class="line">-rw-r--r-- 1 root root 32435568 Jul 17 00:21 gop-live-point_txn_aggregator-data-2019-07-14.tgz</span><br><span class="line">-rw-r--r-- 1 root root 24601862 Jul 17 23:54 gop-live-point_txn_aggregator-data-2019-07-15.tgz</span><br><span class="line">-rw-r--r-- 1 root root 26708856 Jul 19 00:54 gop-live-point_txn_aggregator-data-2019-07-16.tgz</span><br><span class="line">-rw-r--r-- 1 root root 21915660 Jul 19 23:23 gop-live-point_txn_aggregator-data-2019-07-17.tgz</span><br><span class="line">-rw-r--r-- 1 root root 19324816 Jul 21 00:01 gop-live-point_txn_aggregator-data-2019-07-18.tgz</span><br><span class="line">-rw-r--r-- 1 root root 29234368 Jul 22 00:47 gop-live-point_txn_aggregator-data-2019-07-19.tgz</span><br><span class="line">-rw-r--r-- 1 root root 32138171 Jul 23 02:44 gop-live-point_txn_aggregator-data-2019-07-20.tgz</span><br><span class="line">-rw-r--r-- 1 root root 31359175 Jul 24 04:05 gop-live-point_txn_aggregator-data-2019-07-21.tgz</span><br><span class="line">-rw-r--r-- 1 root root 26123344 Jul 24 23:36 gop-live-point_txn_aggregator-data-2019-07-22.tgz</span><br><span class="line">-rw-r--r-- 1 root root 25337107 Jul 26 00:10 gop-live-point_txn_aggregator-data-2019-07-23.tgz</span><br><span class="line">-rw-r--r-- 1 root root 23113614 Jul 26 23:52 gop-live-point_txn_aggregator-data-2019-07-24.tgz</span><br><span class="line">-rw-r--r-- 1 root root 22578291 Jul 28 00:37 gop-live-point_txn_aggregator-data-2019-07-25.tgz</span><br><span class="line">-rw-r--r-- 1 root root 28572628 Jul 29 01:21 gop-live-point_txn_aggregator-data-2019-07-26.tgz</span><br><span class="line">-rw-r--r-- 1 root root 29820440 Jul 30 01:18 gop-live-point_txn_aggregator-data-2019-07-27.tgz</span><br><span class="line">-rw-r--r-- 1 root root 25214160 Jul 31 01:26 gop-live-point_txn_aggregator-data-2019-07-28.tgz</span><br><span class="line">-rw-r--r-- 1 root root 20978337 Aug  1 00:27 gop-live-point_txn_aggregator-data-2019-07-29.tgz</span><br><span class="line">-rw-r--r-- 1 root root 22192620 Aug  1 23:12 gop-live-point_txn_aggregator-data-2019-07-30.tgz</span><br><span class="line">-rw-r--r-- 1 root root  6329205 Jul 31 00:59 gop-live-point_txn_aggregator-data-2019-07-31_00000</span><br><span class="line">-rw-r--r-- 1 root root  5786176 Jul 31 02:00 gop-live-point_txn_aggregator-data-2019-07-31_00001</span><br><span class="line">-rw-r--r-- 1 root root  5451181 Jul 31 03:00 gop-live-point_txn_aggregator-data-2019-07-31_00002</span><br><span class="line">-rw-r--r-- 1 root root  5621760 Jul 31 04:00 gop-live-point_txn_aggregator-data-2019-07-31_00003</span><br><span class="line">-rw-r--r-- 1 root root  5820921 Jul 31 05:00 gop-live-point_txn_aggregator-data-2019-07-31_00004</span><br><span class="line">-rw-r--r-- 1 root root  6088472 Jul 31 05:59 gop-live-point_txn_aggregator-data-2019-07-31_00005</span><br><span class="line">-rw-r--r-- 1 root root  6048663 Jul 31 06:59 gop-live-point_txn_aggregator-data-2019-07-31_00006</span><br><span class="line">-rw-r--r-- 1 root root  6434107 Jul 31 08:00 gop-live-point_txn_aggregator-data-2019-07-31_00007</span><br><span class="line">-rw-r--r-- 1 root root  6937321 Jul 31 09:00 gop-live-point_txn_aggregator-data-2019-07-31_00008</span><br><span class="line">-rw-r--r-- 1 root root  6717315 Jul 31 09:59 gop-live-point_txn_aggregator-data-2019-07-31_00009</span><br><span class="line">-rw-r--r-- 1 root root  6667836 Jul 31 10:59 gop-live-point_txn_aggregator-data-2019-07-31_00010</span><br><span class="line">-rw-r--r-- 1 root root  6559363 Jul 31 12:00 gop-live-point_txn_aggregator-data-2019-07-31_00011</span><br><span class="line">-rw-r--r-- 1 root root  6107832 Jul 31 12:59 gop-live-point_txn_aggregator-data-2019-07-31_00012</span><br><span class="line">-rw-r--r-- 1 root root  6323896 Jul 31 13:59 gop-live-point_txn_aggregator-data-2019-07-31_00013</span><br><span class="line">-rw-r--r-- 1 root root  6389052 Jul 31 15:00 gop-live-point_txn_aggregator-data-2019-07-31_00014</span><br><span class="line">-rw-r--r-- 1 root root  6504740 Jul 31 16:00 gop-live-point_txn_aggregator-data-2019-07-31_00015</span><br><span class="line">-rw-r--r-- 1 root root  6796378 Jul 31 17:00 gop-live-point_txn_aggregator-data-2019-07-31_00016</span><br><span class="line">-rw-r--r-- 1 root root  7878303 Jul 31 18:00 gop-live-point_txn_aggregator-data-2019-07-31_00017</span><br><span class="line">-rw-r--r-- 1 root root  8900771 Jul 31 19:00 gop-live-point_txn_aggregator-data-2019-07-31_00018</span><br><span class="line">-rw-r--r-- 1 root root  9379681 Jul 31 20:00 gop-live-point_txn_aggregator-data-2019-07-31_00019</span><br><span class="line">-rw-r--r-- 1 root root 10435828 Jul 31 21:00 gop-live-point_txn_aggregator-data-2019-07-31_00020</span><br><span class="line">-rw-r--r-- 1 root root 10127803 Jul 31 22:00 gop-live-point_txn_aggregator-data-2019-07-31_00021</span><br><span class="line">-rw-r--r-- 1 root root  8788741 Jul 31 22:59 gop-live-point_txn_aggregator-data-2019-07-31_00022</span><br><span class="line">-rw-r--r-- 1 root root  7747234 Jul 31 23:59 gop-live-point_txn_aggregator-data-2019-07-31_00023</span><br><span class="line">-rw-r--r-- 1 root root  6983387 Aug  1 00:59 gop-live-point_txn_aggregator-data-2019-08-01_00000</span><br><span class="line">-rw-r--r-- 1 root root  6572435 Aug  1 02:00 gop-live-point_txn_aggregator-data-2019-08-01_00001</span><br><span class="line">-rw-r--r-- 1 root root  5959884 Aug  1 03:00 gop-live-point_txn_aggregator-data-2019-08-01_00002</span><br><span class="line">-rw-r--r-- 1 root root  5834298 Aug  1 04:00 gop-live-point_txn_aggregator-data-2019-08-01_00003</span><br><span class="line">-rw-r--r-- 1 root root  6008950 Aug  1 04:59 gop-live-point_txn_aggregator-data-2019-08-01_00004</span><br><span class="line">-rw-r--r-- 1 root root  6614511 Aug  1 06:00 gop-live-point_txn_aggregator-data-2019-08-01_00005</span><br><span class="line">-rw-r--r-- 1 root root  6934464 Aug  1 07:00 gop-live-point_txn_aggregator-data-2019-08-01_00006</span><br><span class="line">-rw-r--r-- 1 root root  7501841 Aug  1 08:00 gop-live-point_txn_aggregator-data-2019-08-01_00007</span><br><span class="line">-rw-r--r-- 1 root root  8018389 Aug  1 09:00 gop-live-point_txn_aggregator-data-2019-08-01_00008</span><br><span class="line">-rw-r--r-- 1 root root  8113113 Aug  1 10:00 gop-live-point_txn_aggregator-data-2019-08-01_00009</span><br><span class="line">-rw-r--r-- 1 root root  8247397 Aug  1 11:00 gop-live-point_txn_aggregator-data-2019-08-01_00010</span><br><span class="line">-rw-r--r-- 1 root root  9334051 Aug  1 12:00 gop-live-point_txn_aggregator-data-2019-08-01_00011</span><br><span class="line">-rw-r--r-- 1 root root  8284898 Aug  1 12:59 gop-live-point_txn_aggregator-data-2019-08-01_00012</span><br><span class="line">-rw-r--r-- 1 root root  9218796 Aug  1 14:00 gop-live-point_txn_aggregator-data-2019-08-01_00013</span><br><span class="line">-rw-r--r-- 1 root root  7875013 Aug  1 15:00 gop-live-point_txn_aggregator-data-2019-08-01_00014</span><br><span class="line">-rw-r--r-- 1 root root  4420827 Aug  1 16:00 gop-live-point_txn_aggregator-data-2019-08-01_00015</span><br><span class="line">-rw-r--r-- 1 root root  7999875 Aug  1 16:59 gop-live-point_txn_aggregator-data-2019-08-01_00016</span><br><span class="line">-rw-r--r-- 1 root root  9480688 Aug  1 18:00 gop-live-point_txn_aggregator-data-2019-08-01_00017</span><br><span class="line">-rw-r--r-- 1 root root 10069991 Aug  1 19:00 gop-live-point_txn_aggregator-data-2019-08-01_00018</span><br><span class="line">-rw-r--r-- 1 root root 11397317 Aug  1 20:00 gop-live-point_txn_aggregator-data-2019-08-01_00019</span><br><span class="line">-rw-r--r-- 1 root root 12597957 Aug  1 21:00 gop-live-point_txn_aggregator-data-2019-08-01_00020</span><br><span class="line">-rw-r--r-- 1 root root 11541451 Aug  1 22:00 gop-live-point_txn_aggregator-data-2019-08-01_00021</span><br><span class="line">-rw-r--r-- 1 root root 10813577 Aug  1 23:00 gop-live-point_txn_aggregator-data-2019-08-01_00022</span><br><span class="line">-rw-r--r-- 1 root root  9507499 Aug  2 00:00 gop-live-point_txn_aggregator-data-2019-08-01_00023</span><br><span class="line">-rw-r--r-- 1 root root  8110763 Aug  2 01:00 gop-live-point_txn_aggregator-data-2019-08-02_00000</span><br><span class="line">-rw-r--r-- 1 root root  7238339 Aug  2 02:00 gop-live-point_txn_aggregator-data-2019-08-02_00001</span><br><span class="line">-rw-r--r-- 1 root root  6577030 Aug  2 02:59 gop-live-point_txn_aggregator-data-2019-08-02_00002</span><br><span class="line">-rw-r--r-- 1 root root  6586196 Aug  2 04:00 gop-live-point_txn_aggregator-data-2019-08-02_00003</span><br><span class="line">-rw-r--r-- 1 root root  6883540 Aug  2 05:00 gop-live-point_txn_aggregator-data-2019-08-02_00004</span><br><span class="line">-rw-r--r-- 1 root root  7172237 Aug  2 06:00 gop-live-point_txn_aggregator-data-2019-08-02_00005</span><br><span class="line">-rw-r--r-- 1 root root  7293336 Aug  2 07:00 gop-live-point_txn_aggregator-data-2019-08-02_00006</span><br><span class="line">-rw-r--r-- 1 root root  7728992 Aug  2 08:00 gop-live-point_txn_aggregator-data-2019-08-02_00007</span><br><span class="line">-rw-r--r-- 1 root root  8154425 Aug  2 09:00 gop-live-point_txn_aggregator-data-2019-08-02_00008</span><br><span class="line">-rw-r--r-- 1 root root  8036346 Aug  2 09:59 gop-live-point_txn_aggregator-data-2019-08-02_00009</span><br><span class="line">-rw-r--r-- 1 root root  7940669 Aug  2 11:00 gop-live-point_txn_aggregator-data-2019-08-02_00010</span><br><span class="line">-rw-r--r-- 1 root root  7901900 Aug  2 12:00 gop-live-point_txn_aggregator-data-2019-08-02_00011</span><br><span class="line">-rw-r--r-- 1 root root  8501400 Aug  2 13:00 gop-live-point_txn_aggregator-data-2019-08-02_00012</span><br><span class="line">-rw-r--r-- 1 root root  8024730 Aug  2 13:59 gop-live-point_txn_aggregator-data-2019-08-02_00013</span><br><span class="line">-rw-r--r-- 1 root root  8413981 Aug  2 14:59 gop-live-point_txn_aggregator-data-2019-08-02_00014</span><br><span class="line">-rw-r--r-- 1 root root  5899646 Aug  2 15:50 gop-live-point_txn_aggregator-data-2019-08-02_00015</span><br><span class="line">lrwxrwxrwx 1 root root       51 Aug  2 15:00 gop-live-point_txn_aggregator-data_current -&gt; gop-live-point_txn_aggregator-data-2019-08-02_00015</span><br></pre></td></tr></table></figure><h2 id="backup-and-rsync-scripts"><a href="#backup-and-rsync-scripts" class="headerlink" title="backup and rsync scripts"></a>backup and rsync scripts</h2><blockquote><p>check_original_log.sh</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">var_date=<span class="variable">$1</span></span><br><span class="line">var_src=<span class="string">"/data/gop/live/primary/gop"</span></span><br><span class="line">find <span class="variable">$&#123;var_src&#125;</span> | grep -i <span class="variable">$&#123;var_date&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>check_backup_log.sh</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">var_date=<span class="variable">$1</span></span><br><span class="line">var_src=<span class="string">"/data/backup/"</span></span><br><span class="line">find <span class="variable">$&#123;var_src&#125;</span> | grep -i <span class="variable">$&#123;var_date&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>move_backup.sh</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">var_date=\<span class="variable">$1</span></span><br><span class="line">var_path=<span class="string">"/data/gop/live/primary/gop"</span></span><br><span class="line">var_str=<span class="string">"/data/backup"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># analyze log</span></span><br><span class="line"></span><br><span class="line">find <span class="variable">$&#123;var_path&#125;</span> | grep -i <span class="variable">$&#123;var_date&#125;</span> &gt; <span class="built_in">log</span>/<span class="variable">$&#123;var_date&#125;</span>.ori.out</span><br><span class="line">cp <span class="built_in">log</span>/<span class="variable">$&#123;var_date&#125;</span>.ori.out <span class="built_in">log</span>/<span class="variable">$&#123;var_date&#125;</span>.mod.out</span><br><span class="line">sed -i <span class="string">"s:/data/gop/live/primary/gop:<span class="variable">$&#123;var_str&#125;</span>:g"</span> <span class="built_in">log</span>/\<span class="variable">$&#123;var_date&#125;</span>.mod.out</span><br><span class="line"></span><br><span class="line"><span class="comment"># merge move action</span></span><br><span class="line"></span><br><span class="line">paste -d <span class="string">"|"</span> <span class="built_in">log</span>/<span class="variable">$&#123;var_date&#125;</span>.ori.out <span class="built_in">log</span>/<span class="variable">$&#123;var_date&#125;</span>.mod.out &gt; <span class="built_in">log</span>/\<span class="variable">$&#123;var_date&#125;</span>.out</span><br><span class="line"></span><br><span class="line"><span class="comment"># move files</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `cat <span class="built_in">log</span>/<span class="variable">$&#123;var_date&#125;</span>.out`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">var_a=`<span class="built_in">echo</span> <span class="variable">$&#123;i&#125;</span> | cut -f1 -d<span class="string">"|"</span>`</span><br><span class="line">var_b=`<span class="built_in">echo</span> <span class="variable">$&#123;i&#125;</span> | cut -f2 -d<span class="string">"|"</span>`</span><br><span class="line">mv <span class="variable">$&#123;var_a&#125;</span> <span class="variable">$&#123;var_b&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><blockquote><p>rsync_backup.sh</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">var_src=<span class="string">"/data/backup/"</span></span><br><span class="line">var_des=<span class="string">"rsync://10.71.12.61:873/backup/"</span></span><br><span class="line">rsync -aP <span class="variable">$&#123;var_src&#125;</span> <span class="variable">$&#123;var_des&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>clean_backup_log.sh</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">var_date=<span class="variable">$1</span></span><br><span class="line">var_src=<span class="string">"/data/backup/"</span></span><br><span class="line">find <span class="variable">$&#123;var_src&#125;</span> | grep -i <span class="variable">$&#123;var_date&#125;</span> | xargs rm -f</span><br></pre></td></tr></table></figure><blockquote><p>log out samples</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"># 2019-05.ori.out</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-25.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-27.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-23.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-30.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-31.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-28.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-24.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-26.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-29.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_line_data_server-daemon/gop-live-gop_line_data_server-daemon-2019-05-31.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_line_data_server-daemon/gop-live-gop_line_data_server-daemon-2019-05-29.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_line_data_server-daemon/gop-live-gop_line_data_server-daemon-2019-05-23.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_line_data_server-daemon/gop-live-gop_line_data_server-daemon-2019-05-30.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_line_data_server-daemon/gop-live-gop_line_data_server-daemon-2019-05-27.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_line_data_server-daemon/gop-live-gop_line_data_server-daemon-2019-05-28.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_line_data_server-daemon/gop-live-gop_line_data_server-daemon-2019-05-24.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_line_data_server-daemon/gop-live-gop_line_data_server-daemon-2019-05-25.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_line_data_server-daemon/gop-live-gop_line_data_server-daemon-2019-05-26.tgz</span><br><span class="line"></span><br><span class="line"># 2019-05.mod.out</span><br><span class="line">/data/backup/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-25.tgz</span><br><span class="line">/data/backup/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-27.tgz</span><br><span class="line">/data/backup/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-23.tgz</span><br><span class="line">/data/backup/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-30.tgz</span><br><span class="line">/data/backup/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-31.tgz</span><br><span class="line">/data/backup/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-28.tgz</span><br><span class="line">/data/backup/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-24.tgz</span><br><span class="line">/data/backup/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-26.tgz</span><br><span class="line">/data/backup/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-29.tgz</span><br><span class="line">/data/backup/gop-live-gop_line_data_server-daemon/gop-live-gop_line_data_server-daemon-2019-05-31.tgz</span><br><span class="line">/data/backup/gop-live-gop_line_data_server-daemon/gop-live-gop_line_data_server-daemon-2019-05-29.tgz</span><br><span class="line">/data/backup/gop-live-gop_line_data_server-daemon/gop-live-gop_line_data_server-daemon-2019-05-23.tgz</span><br><span class="line">/data/backup/gop-live-gop_line_data_server-daemon/gop-live-gop_line_data_server-daemon-2019-05-30.tgz</span><br><span class="line">/data/backup/gop-live-gop_line_data_server-daemon/gop-live-gop_line_data_server-daemon-2019-05-27.tgz</span><br><span class="line">/data/backup/gop-live-gop_line_data_server-daemon/gop-live-gop_line_data_server-daemon-2019-05-28.tgz</span><br><span class="line">/data/backup/gop-live-gop_line_data_server-daemon/gop-live-gop_line_data_server-daemon-2019-05-24.tgz</span><br><span class="line">/data/backup/gop-live-gop_line_data_server-daemon/gop-live-gop_line_data_server-daemon-2019-05-25.tgz</span><br><span class="line">/data/backup/gop-live-gop_line_data_server-daemon/gop-live-gop_line_data_server-daemon-2019-05-26.tgz</span><br><span class="line"></span><br><span class="line"># 2019-05.out</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-25.tgz|/data/backup/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-25.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-27.tgz|/data/backup/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-27.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-23.tgz|/data/backup/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-23.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-30.tgz|/data/backup/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-30.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-31.tgz|/data/backup/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-31.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-28.tgz|/data/backup/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-28.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-24.tgz|/data/backup/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-24.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-26.tgz|/data/backup/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-26.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-29.tgz|/data/backup/gop-live-gop_huawei_data_server-daemon/gop-live-gop_huawei_data_server-daemon-2019-05-29.tgz</span><br><span class="line">/data/gop/live/primary/gop/gop-live-gop_line_data_server-daemon/gop-live-gop_line_data_server-daemon-2019-05-31.tgz|/data/backup/gop-live-gop_line_data_server-daemon/gop-live-gop_line_data_server-daemon-2019-05-31.tgz</span><br><span class="line"></span><br><span class="line"># 2019-05.rsync.out</span><br><span class="line">nohup: ignoring input</span><br><span class="line">sending incremental file list</span><br><span class="line">./</span><br><span class="line">gop-live-account.garena.com-access/</span><br><span class="line">gop-live-account.garena.com-access/gop-live-account.garena.com-access-2019-05-01.tgz</span><br><span class="line">^M         32,768   0%    0.00kB/s    0:00:00  ^M     75,551,185 100%  188.53MB/s    0:00:00 (xfr#1, ir-chk=1053/1441)</span><br><span class="line">gop-live-account.garena.com-access/gop-live-account.garena.com-access-2019-05-02.tgz</span><br><span class="line">^M         32,768   0%   81.01kB/s    0:15:24  ^M     74,896,153 100%   82.01MB/s    0:00:00 (xfr#2, ir-chk=1052/1441)</span><br></pre></td></tr></table></figure><h2 id="log-cleanup-exclude-list"><a href="#log-cleanup-exclude-list" class="headerlink" title="log cleanup exclude list"></a>log cleanup exclude list</h2><p>/data/nc_backup</p><p>gop-live-tcp_server<br>gop-live-sso_website<br>gop-live-app_point<br>gop-live-gop_vk_data_server<br>gop-live-gop_huawei_data_server<br>gop-live-gop_line_data_server<br>gop-live-gop_google_data_server<br>gop-live-gop_fb_data_server<br>gop-live-gop_data_server<br>gop-live-general-api_server<br>gop-live-payment_center<br>gop-live-msdk_api<br>gop-live-cron_autofix<br>gop-live-shell_api_server<br>gop-live-api_server<br>gop-staging-payment_center<br>gop-staging-msdk_api</p><blockquote><p>create python script to combine multiple lines</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">data=open(<span class="string">"file"</span>).readlines()</span><br><span class="line"><span class="keyword">for</span> n,line <span class="keyword">in</span> enumerate(data):</span><br><span class="line">    <span class="keyword">if</span> line.startswith(<span class="string">"line"</span>):</span><br><span class="line">       data[n] = <span class="string">"\n"</span>+line.rstrip()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">       data[n]=line.rstrip()</span><br><span class="line"><span class="keyword">print</span> (<span class="string">'|'</span>.join(data))</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># simple example</span><br><span class="line">Englist</span><br><span class="line">中文</span><br><span class="line"></span><br><span class="line">Englist | 中文</span><br><span class="line"></span><br><span class="line"># can change line.startwith</span><br><span class="line">line1</span><br><span class="line">text1</span><br><span class="line">text2</span><br><span class="line">text3</span><br><span class="line">line2</span><br><span class="line">something1</span><br><span class="line">something2</span><br><span class="line"></span><br><span class="line">line1|text1|text2|text3|</span><br><span class="line">line2|something1|something2</span><br></pre></td></tr></table></figure><blockquote><p>use find to filter the log</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># use find command filter directory</span></span><br><span class="line">find /data/nc_backup -<span class="built_in">type</span> d &gt; log_source</span><br><span class="line">find /data/nc_backup -<span class="built_in">type</span> d | egrep -v <span class="string">"gop-live-tcp_server|gop-live-sso_website|gop-live-app_point|gop-live-gop_vk_data_server|gop-live-gop_huawei_data_server|gop-live-gop_line_data_server|gop-live-gop_google_data_server|gop-live-gop_fb_data_server|gop-live-gop_data_server|gop-live-general-api_server|gop-live-payment_center|gop-live-msdk_api|gop-live-cron_autofix|gop-live-shell_api_server|gop-live-api_server|gop-staging-payment_center|gop-staging-msdk_api"</span> &gt; log_target</span><br><span class="line"><span class="comment"># remove the fist line</span></span><br><span class="line">sed -i <span class="string">'1d'</span> log_source</span><br><span class="line">sed -i <span class="string">'1d'</span> log_target</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      基于bash find命令执行log日志备份和清理日志简单实践
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>InfluxDB 安装部署</title>
    <link href="https://wsgzao.github.io/post/influxdb/"/>
    <id>https://wsgzao.github.io/post/influxdb/</id>
    <published>2019-07-25T06:59:49.000Z</published>
    <updated>2019-07-25T11:35:43.094Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>InfluxDB 是专为时序数据设计的数据库，能支撑大量的读写负载，是一个高性能的时序数据 datastore。</p><blockquote><p>InfluxDB is the Time Series Database in the TICK Stack</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 07 月 25 日 - 更新 influx 命令使用技巧<br>2019 年 04 月 05 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/influxdb/">https://wsgzao.github.io/post/influxdb/</a></p><p><strong> 扩展阅读 </strong></p><p>InfluxDB - <a href="https://www.influxdata.com/time-series-platform/influxdb/" target="_blank" rel="noopener">https://www.influxdata.com/time-series-platform/influxdb/</a></p><hr><h2 id="InfluxDB-简介"><a href="#InfluxDB-简介" class="headerlink" title="InfluxDB 简介"></a>InfluxDB 简介</h2><blockquote><p>InfluxDB is the Time Series Database in the TICK Stack</p></blockquote><p>InfluxData’s TICK Stack is built around InfluxDB to handle massive amounts of time-stamped information. This time series database provides support for your metrics analysis needs, from DevOps Monitoring, IoT Sensor data, and Real-Time Analytics. Users can adapt their SQL skills with InfluxQL, so they can get up to speed on this time series database.</p><p><img src="https://www.influxdata.com/wp-content/uploads/Tick-Stack-InfluxDB-2.png" alt=""></p><p>默认预留端口:</p><p>8086，HTTP API<br>8088，RPC 端口，用于备份和恢复</p><p>NTP 服务:<br>InfluxDB 使用机器本地时间作为 timestamp，需要机器之间使用 NTP 进行同步；如果没有同步的话，写入的时间序列数据可能会不准确</p><h2 id="InfluxDB-安装"><a href="#InfluxDB-安装" class="headerlink" title="InfluxDB 安装"></a>InfluxDB 安装</h2><p>InfluxDB 里存储的数据被称为时间序列数据, InfluxDB 存储方式跟传统关系型数据库不同的是：传统关系型数据库通过数据库 + 表 + 字段组织数据，InfluxDB 通过指标、标签、字段组织数据，时间戳是默认的索引列，标签跟字段其实就相当于关系型数据库中的字段，只不过标签会被索引，而字段不会。</p><p>Grafana 默认支持的数据源：Graphite，InfluxDB，OpenTSDB，Prometheus，Elasticsearch，CloudWatch<br>Grafana 支持同时绑定多套数据源，根据自己需求管理即可，这里以 InfluxDB 为例。</p><p><a href="https://portal.influxdata.com/downloads" target="_blank" rel="noopener">https://portal.influxdata.com/downloads</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install influxdb</span></span><br><span class="line">cat &gt; /etc/yum.repos.d/influxdb.repo &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">[influxdb]</span><br><span class="line">name = InfluxDB Repository - RHEL \<span class="variable">$releasever</span></span><br><span class="line">baseurl = https://repos.influxdata.com/rhel/\<span class="variable">$releasever</span>/\<span class="variable">$basearch</span>/stable</span><br><span class="line">enabled = 1</span><br><span class="line">gpgcheck = 1</span><br><span class="line">gpgkey = https://repos.influxdata.com/influxdb.key</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># yum install influxdb</span></span><br><span class="line">yum install -y influxdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># start and enable influxdb</span></span><br><span class="line">sudo systemctl start influxdb</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> influxdb</span><br><span class="line">sudo systemctl status influxdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过 influx 命令进入 cli 命令行 </span></span><br><span class="line">influx</span><br><span class="line">Connected to http://localhost:8086 version 1.4.2</span><br><span class="line">InfluxDB shell version: 1.4.2</span><br><span class="line">&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看用户 </span></span><br><span class="line">SHOW USERS</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建用户 </span></span><br><span class="line">CREATE USER influx WITH PASSWORD <span class="string">'influx'</span> WITH ALL PRIVILEGES</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看用户 </span></span><br><span class="line">SHOW USERS</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建数据库 </span></span><br><span class="line">CREATE DATABASE <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看数据库 </span></span><br><span class="line">SHOW DATABASES</span><br><span class="line"></span><br><span class="line"><span class="comment"># Using 数据库 </span></span><br><span class="line">USE <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 插入数据 </span></span><br><span class="line">INSERT cpu,host=192.168.1.1 load=0.1,usage=0.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询所有数据 </span></span><br><span class="line">SELECT * FROM <span class="string">"cpu"</span></span><br><span class="line">SELECT <span class="string">"host"</span>,<span class="string">"load"</span>,<span class="string">"usage"</span> FROM <span class="string">"cpu"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据条件查询 </span></span><br><span class="line">SELECT <span class="string">"host"</span>,<span class="string">"load"</span>,<span class="string">"usage"</span> FROM <span class="string">"cpu"</span> WHERE <span class="string">"host"</span> = <span class="string">'192.168.1.1'</span></span><br><span class="line">SELECT <span class="string">"host"</span>,<span class="string">"load"</span>,<span class="string">"usage"</span> FROM <span class="string">"cpu"</span> WHERE <span class="string">"usage"</span> &gt; 0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建数据库 </span></span><br><span class="line">CREATE DATABASE <span class="string">"db_name"</span></span><br><span class="line"><span class="comment"># 显示所有数据库 </span></span><br><span class="line">SHOW DATABASES</span><br><span class="line"><span class="comment"># 删除数据库 </span></span><br><span class="line">DROP DATABASE <span class="string">"db_name"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用数据库 </span></span><br><span class="line">USE mydb</span><br><span class="line"><span class="comment"># 显示该数据库中的表 </span></span><br><span class="line">SHOW MEASUREMENTS</span><br><span class="line"><span class="comment"># 删除表 </span></span><br><span class="line">DROP MEASUREMENT <span class="string">"t_name"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 简单查询 </span></span><br><span class="line">SELECT * FROM codis_usage ORDER BY time DESC LIMIT 3</span><br><span class="line"><span class="comment"># 最近 60min 内的数据 </span></span><br><span class="line">SELECT * FROM codis_usage WHERE time &gt;= now() - 60m;</span><br><span class="line"><span class="comment"># 获取最近更新数据，并转换为当前时间 </span></span><br><span class="line">precision rfc3339</span><br><span class="line">select * from codis_usage order by time desc <span class="built_in">limit</span> 10;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询保存策略 </span></span><br><span class="line">show retention policies on codis</span><br><span class="line">name    duration shardGroupDuration replicaN default</span><br><span class="line">----    -------- ------------------ -------- -------</span><br><span class="line">autogen 0s       168h0m0s           1        <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建新的 Retention Policies 并设置为默认值 </span></span><br><span class="line"><span class="comment"># duration 保留多少天 </span></span><br><span class="line"><span class="comment"># replication 副本数 </span></span><br><span class="line">create retention policy <span class="string">"rp_14d"</span> ON <span class="string">"codis"</span> duration 14d replication 1 default</span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复默认策略（永久保存）</span></span><br><span class="line">alter retention policy <span class="string">"autogen"</span> on <span class="string">"codis"</span> duration 0s replication 1 default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建数据库 API</span></span><br><span class="line">curl -i -XPOST http://localhost:8086/query --data-urlencode <span class="string">"q=CREATE DATABASE test"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入数据 API</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入单条 </span></span><br><span class="line">curl -i -XPOST http://localhost:8086/write?db=<span class="built_in">test</span> --data-binary <span class="string">"cpu,host=192.168.1.3 load=0.1,usage=0.33"</span></span><br><span class="line">curl -i -XPOST http://localhost:8086/write?db=<span class="built_in">test</span> --data-binary <span class="string">"cpu,host=192.168.1.3 load=0.1,usage=0.33 6666666666666666666"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入多条 </span></span><br><span class="line">curl -i -XPOST http://localhost:8086/write?db=<span class="built_in">test</span> --data-binary <span class="string">"cpu,host=192.168.1.2 load=0.1,usage=0.22 1666666666666666661 </span></span><br><span class="line"><span class="string">cpu,host=192.168.1.3 load=0.1,usage=0.33 1666666666666666661 </span></span><br><span class="line"><span class="string">cpu,host=192.168.1.2 load=0.2,usage=0.22 1666666666666666662 </span></span><br><span class="line"><span class="string">cpu,host=192.168.1.3 load=0.2,usage=0.33 1666666666666666662"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询数据 API</span></span><br><span class="line">curl -G http://localhost:8086/query?db=<span class="built_in">test</span> --data-urlencode <span class="string">"q=SELECT * FROM  \"cpu\""</span></span><br></pre></td></tr></table></figure><h2 id="influx-命令"><a href="#influx-命令" class="headerlink" title="influx 命令"></a>influx 命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@sg-gop-10-71-12-145 wangao]# influx</span><br><span class="line">Connected to http://localhost:8086 version 1.7.7</span><br><span class="line">InfluxDB shell version: 1.7.7</span><br><span class="line">&gt; help</span><br><span class="line">Usage:</span><br><span class="line">        connect &lt;host:port&gt;   connects to another node specified by host:port</span><br><span class="line">        auth                  prompts for username and password</span><br><span class="line">        pretty                toggles pretty print for the json format</span><br><span class="line">        chunked               turns on chunked responses from server</span><br><span class="line">        chunk size &lt;size&gt;     sets the size of the chunked responses.  Set to 0 to reset to the default chunked size</span><br><span class="line">        use &lt;db_name&gt;         sets current database</span><br><span class="line">        format &lt;format&gt;       specifies the format of the server responses: json, csv, or column</span><br><span class="line">        precision &lt;format&gt;    specifies the format of the timestamp: rfc3339, h, m, s, ms, u or ns</span><br><span class="line">        consistency &lt;level&gt;   sets write consistency level: any, one, quorum, or all</span><br><span class="line">        history               displays command history</span><br><span class="line">        settings              outputs the current settings for the shell</span><br><span class="line">        clear                 clears settings such as database or retention policy.  run &apos;clear&apos; for help</span><br><span class="line">        exit/quit/ctrl+d      quits the influx shell</span><br><span class="line"></span><br><span class="line">        show databases        show database names</span><br><span class="line">        show series           show series information</span><br><span class="line">        show measurements     show measurement information</span><br><span class="line">        show tag keys         show tag key information</span><br><span class="line">        show field keys       show field key information</span><br><span class="line"></span><br><span class="line">        A full list of influxql commands can be found at:</span><br><span class="line">        https://docs.influxdata.com/influxdb/latest/query_language/spec/</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure><h3 id="用户权限管理"><a href="#用户权限管理" class="headerlink" title="用户权限管理"></a>用户权限管理</h3><p>InfluxDB 的权限设置比较简单，只有读、写、ALL 三种，详细参考 官方文档 。默认不开启用户认证，需要修改配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[http]</span><br><span class="line">auth-enabled = true</span><br></pre></td></tr></table></figure></p><p><a href="https://docs.influxdata.com/influxdb/v1.7/administration/authentication_and_authorization/" target="_blank" rel="noopener">https://docs.influxdata.com/influxdb/v1.7/administration/authentication_and_authorization/</a></p><p>常见命令如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 授权 </span><br><span class="line">GRANT [READ,WRITE,ALL] ON &lt;database_name&gt; TO &lt;username&gt;</span><br><span class="line">GRANT ALL PRIVILEGES TO &quot;username&quot;</span><br><span class="line"></span><br><span class="line"># 撤销权限 </span><br><span class="line">REVOKE [READ,WRITE,ALL] ON &lt;database_name&gt; FROM &lt;username&gt;</span><br><span class="line">REVOKE ALL PRIVILEGES FROM &quot;username&quot;</span><br><span class="line"></span><br><span class="line"># 查看权限 </span><br><span class="line">SHOW GRANTS FOR &lt;user_name&gt;</span><br><span class="line"></span><br><span class="line"># 显示用户 </span><br><span class="line">SHOW USERS</span><br><span class="line"></span><br><span class="line"># 创建用户 </span><br><span class="line">CREATE USER &quot;readonly&quot; WITH PASSWORD &apos;password&apos;</span><br><span class="line"></span><br><span class="line"># 创建管理员权限的用户 </span><br><span class="line">CREATE USER &quot;readonly&quot; WITH PASSWORD &apos;password&apos; WITH ALL PRIVILEGES</span><br><span class="line"></span><br><span class="line"># 删除用户 </span><br><span class="line">DROP USER &quot;readonly&quot;</span><br><span class="line"></span><br><span class="line"># 修改密码 </span><br><span class="line">SET PASSWORD FOR &lt;username&gt; = &apos;&lt;password&gt;&apos;</span><br></pre></td></tr></table></figure><h3 id="数据保存策略"><a href="#数据保存策略" class="headerlink" title="数据保存策略"></a>数据保存策略</h3><p>也就是 Retention Policies，可以设置保存的时间，例如保存 30 天<br><a href="https://docs.influxdata.com/influxdb/v1.7/guides/downsampling_and_retention/" target="_blank" rel="noopener">https://docs.influxdata.com/influxdb/v1.7/guides/downsampling_and_retention/</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 查询 </span><br><span class="line">SHOW RETENTION POLICIES ON &quot;database_name&quot;;</span><br><span class="line"></span><br><span class="line"># 新建 </span><br><span class="line">CREATE RETENTION POLICY &quot;rp_name&quot; ON &quot;db_name&quot; DURATION 30d REPLICATION 1 DEFAULT;</span><br><span class="line"></span><br><span class="line"># 修改 </span><br><span class="line">ALTER RETENTION POLICY &quot;rp_name&quot; ON db_name DURATION 3w DEFAULT;</span><br><span class="line"></span><br><span class="line"># 删除 </span><br><span class="line">DROP RETENTION POLICY &quot;rp_name&quot; ON &quot;db_name&quot;;</span><br></pre></td></tr></table></figure><h3 id="连续查询"><a href="#连续查询" class="headerlink" title="连续查询"></a>连续查询</h3><p>也就是 Continuous Queries，当数据超过保存策略里指定的时间之后，就会被删除；可以通过连续查询把原来的秒级数据，保存为分钟级或者小时级的数据，从而减小数据的占用空间。<br><a href="https://docs.influxdata.com/influxdb/v1.7/query_language/continuous_queries/" target="_blank" rel="noopener">https://docs.influxdata.com/influxdb/v1.7/query_language/continuous_queries/</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 查看 </span><br><span class="line">SHOW CONTINUOUS QUERIES;</span><br><span class="line"></span><br><span class="line"># 创建 </span><br><span class="line">CREATE CONTINUOUS QUERY cq-name ON db-name BEGIN</span><br><span class="line">    SELECT mean(tbl-name) INTO newtbl-name FROM tbl-name GROUP BY time(30m) END;</span><br><span class="line"></span><br><span class="line"># 删除 </span><br><span class="line">DROP CONTINUOUS QUERY &lt;cq-name&gt; ON &lt;db-name&gt;;</span><br></pre></td></tr></table></figure><h3 id="备份恢复"><a href="#备份恢复" class="headerlink" title="备份恢复"></a>备份恢复</h3><p>只支持全量备份，不支持增量，包括了元数据以及增量数据的备份，可以参考 官方文档<br><a href="https://docs.influxdata.com/influxdb/v1.7/administration/backup_and_restore/" target="_blank" rel="noopener">https://docs.influxdata.com/influxdb/v1.7/administration/backup_and_restore/</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 元数据备份 </span><br><span class="line">influxd backup &lt;path-to-backup&gt;</span><br><span class="line"></span><br><span class="line"># 数据备份 </span><br><span class="line">influxd backup -database &lt;mydatabase&gt; &lt;path-to-backup&gt;</span><br><span class="line">influxd backup -database telegraf -retention autogen -since 2016-02-01T00:00:00Z /tmp/backup</span><br><span class="line">influxd backup -database mydatabase -host 10.0.0.1:8088 /tmp/remote-backup</span><br><span class="line"></span><br><span class="line"># 恢复 </span><br><span class="line">influxd restore -metadir /var/lib/influxdb/meta /tmp/backup</span><br><span class="line">influxd restore -database telegraf -datadir /var/lib/influxdb/data /tmp/backup</span><br></pre></td></tr></table></figure><h3 id="time-格式显示设置"><a href="#time-格式显示设置" class="headerlink" title="time 格式显示设置"></a>time 格式显示设置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 方法 1</span><br><span class="line">$ influx -precision rfc3339</span><br><span class="line"></span><br><span class="line"># 方法 2</span><br><span class="line">$ influx</span><br><span class="line">  Connected to http://localhost:8086 version 0.xx.x</span><br><span class="line">  InfluxDB shell 0.xx.x</span><br><span class="line">  &gt; precision rfc3339</span><br><span class="line"></span><br><span class="line">&gt; precision rfc3339</span><br><span class="line">&gt; select * from codis_usage order by time desc limit 10;</span><br><span class="line">name: codis_usage</span><br><span class="line">time                           admin_addr         hostname              ops_fails ops_qps ops_redis_errors ops_total   product_name   proxy_addr        runtime_gc_num runtime_gc_total_pausems runtime_num_cgo_call runtime_num_goroutines runtime_num_mem_offheap runtime_num_procs rusage_cpu          rusage_mem sessions_alive sessions_total token</span><br><span class="line">----                           ----------         --------              --------- ------- ---------------- ---------   ------------   ----------        -------------- ------------------------ -------------------- ---------------------- ----------------------- ----------------- ----------          ---------- -------------- -------------- -----</span><br><span class="line">2019-07-25T10:48:43.186693914Z 10.71.15.97:11080  sg-gop-xxx-xxx-xxx-xx                                                gop-codis-misc 10.71.15.97:6389                                          2455469                                     49217536                8                                     456200192  58                            2bdaa076222fec82f9204310255cc2e3</span><br><span class="line">2019-07-25T10:48:43.160702877Z 10.71.15.98:11080  sg-gop-xxx-xxx-xxx-xx 0         44      12258            8381660     gop-codis-misc 10.71.15.98:6389  5099           426                      2455685              266                    48037888                8                 0                   390696960  56             12404          b2d20caf9f3c9af555cb9a9fa5c07844</span><br><span class="line">2019-07-25T10:48:42.838745142Z 10.71.15.96:11080  sg-gop-xxx-xxx-xxx-xx 0         0       0                0           gop-codis-data 10.71.15.96:6389  79             6                        37247                26                     0                       8                 0                   142471168  0              0              47629170465564037278443f7fc0a2b0</span><br><span class="line">2019-07-25T10:48:42.786535306Z 10.71.14.113:11080 localhost.localdomain 0         9740    4                32159612367 gop-codis      10.71.15.112:6389 27922          10471                    76744489             8754                   1073741824              8                 0.809847412599755   4961280000 4304           45663317       e72634f3a81e4edcf24dca9454e22c1b</span><br><span class="line">2019-07-25T10:48:42.727826769Z 10.71.14.112:11080 localhost.localdomain 0         9602    2                33816047337 gop-codis      10.71.15.112:6389 31458          11034                    77809963             8806                   1073741824              8                 0.7998623956727604  4950290432 4330           45663036       646f70b8381ca449cad4bb1316e17b78</span><br><span class="line">2019-07-25T10:48:42.598859131Z 10.71.15.95:11080  sg-gop-xxx-xxx-xxx-xx 0         0       0                0           gop-codis-data 10.71.15.95:6389  80             5                        37771                26                     0                       8                 0                   140034048  0              0              939a496343900150dc87238b953bb14b</span><br><span class="line">2019-07-25T10:48:42.333392816Z 10.71.15.91:11080  sg-gop-xxx-xxx-xxx-xx 0         4034    0                93719633    gop-codis-pay  10.71.15.91:6389  5122           445                      2463785              4406                   876150784               8                 0.36992110507631487 1682124800 2126           4836           64ebb14da86e74313c0f5dca10336a4d</span><br><span class="line">2019-07-25T10:48:42.322101493Z 10.71.15.92:11080  sg-gop-xxx-xxx-xxx-xx 0         3721    0                89276911    gop-codis-pay  10.71.15.92:6389  5122           450                      2463671              4388                   895614976               8                 0.3399291832331154  1677733888 2117           4750           7b76feefc30f93483d7b8e5432084f34</span><br><span class="line">2019-07-25T10:48:42.227508795Z 10.71.15.93:11080  sg-gop-xxx-xxx-xxx-xx 0         405     0                15300438    gop-codis-auth 10.71.15.93:6389  5096           434                      2446269              1504                   414908416               8                 0.04998992792934094 613736448  675            1592           7a320ee2bb9fe9cecfdd685a5fbfbc1c</span><br><span class="line">2019-07-25T10:48:42.194695137Z 10.71.15.94:11080  sg-gop-xxx-xxx-xxx-xx 0         524     0                15128150    gop-codis-auth 10.71.15.94:6389  5096           421                      2446079              1486                   409600000               8                 0.04998935201807339 492064768  666            1546           6b516b3b0344063a6936fc13c40fc40a</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure><h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 获取最近更新数据，并转换为当前时间 </span><br><span class="line">select threads_running from mysql order by time desc limit 1;</span><br><span class="line">date -d @`echo 1483441750000000000 | awk &apos;&#123;print substr($0,1,10)&#125;&apos;` +&quot;%Y-%m-%d %H:%M:%S&quot;</span><br><span class="line"></span><br><span class="line"># 检查系统是否存活 </span><br><span class="line">$ curl -sl -I localhost:8086/ping</span><br><span class="line"></span><br><span class="line"># 简单查询 </span><br><span class="line">SELECT * FROM weather ORDER BY time DESC LIMIT 3;</span><br><span class="line"></span><br><span class="line"># 指定时间范围，时间格式也可以为 & apos;2017-01-03 00:00:00&apos;</span><br><span class="line">SELECT usage_idle FROM cpu WHERE time &gt;= &apos;2017-01-03T12:40:38.708Z&apos; AND time &lt;= &apos;2017-01-03T12:40:50.708Z&apos;;</span><br><span class="line"></span><br><span class="line"># 最近 40min 内的数据 </span><br><span class="line">SELECT * FROM mysql WHERE time &gt;= now() - 40m;</span><br><span class="line"></span><br><span class="line"># 最近 5 分钟的秒级差值 </span><br><span class="line">SELECT derivative(&quot;queries&quot;, 1s) AS &quot;queries&quot; from &quot;mysql&quot; where time &gt; now() - 5m;</span><br><span class="line"></span><br><span class="line"># 最近 5min 的秒级写入 </span><br><span class="line">$ influx -database &apos;_internal&apos; -precision &apos;rfc3339&apos;</span><br><span class="line">      -execute &apos;select derivative(pointReq, 1s) from &quot;write&quot; where time &gt; now() - 5m&apos;</span><br><span class="line"></span><br><span class="line"># 也可以通过日志查看 </span><br><span class="line">$ grep &apos;POST&apos; /var/log/influxdb/influxd.log | awk &apos;&#123; print $10 &#125;&apos; | sort | uniq -c</span><br><span class="line">$ journalctl -u influxdb.service | awk &apos;/POST/ &#123; print $10 &#125;&apos; | sort | uniq -c</span><br></pre></td></tr></table></figure><h2 id="InfluxDB-配置优化"><a href="#InfluxDB-配置优化" class="headerlink" title="InfluxDB 配置优化"></a>InfluxDB 配置优化</h2><p>配置文件默认全部注释掉，使用默认的配置项，可以根据需要配置。每个配置项有对应的、相同功能的环境变量。</p><p>配置文件：/etc/influxdb/influxdb.conf</p><p>查看配置：influxd config</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[meta]                                <span class="comment"># 元数据 </span></span><br><span class="line">dir = /var/lib/influxdb/meta  </span><br><span class="line"></span><br><span class="line">[data]                                <span class="comment"># 数据 / WAL</span></span><br><span class="line">dir = /var/lib/influxdb/data  </span><br><span class="line">wal-dir = /var/lib/influxdb/wal  </span><br><span class="line">cache-max-memory-size = <span class="string">"1g"</span>          <span class="comment"># Cache 最大可用内存 </span></span><br><span class="line"></span><br><span class="line">[coordinator]                         <span class="comment"># 查询相关 </span></span><br><span class="line">query-timeout = <span class="string">"0s"</span>                  <span class="comment"># 查询最大执行时间  </span></span><br><span class="line"><span class="built_in">log</span>-queries-after = <span class="string">"0s"</span>              <span class="comment"># 打印慢查询 </span></span><br><span class="line"></span><br><span class="line">[http]           <span class="comment"># HTTP 服务 </span></span><br><span class="line">auth-enabled = <span class="literal">false</span>                  <span class="comment"># 启用安全认证  </span></span><br><span class="line">max-connection-limit = 0              <span class="comment"># 最大连接数 </span></span><br></pre></td></tr></table></figure><p>更多帮助信息请参考官网<br>InfluxDB documentation - <a href="https://docs.influxdata.com/platform/introduction" target="_blank" rel="noopener">https://docs.influxdata.com/platform/introduction</a></p>]]></content>
    
    <summary type="html">
    
      InfluxDB is the Time Series Database in the TICK Stack
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>Redis(Codis) 分布式集群部署实践</title>
    <link href="https://wsgzao.github.io/post/codis/"/>
    <id>https://wsgzao.github.io/post/codis/</id>
    <published>2019-07-23T06:59:49.000Z</published>
    <updated>2019-08-09T07:50:35.601Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190724154111.png" alt=""></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Codis 3.x 稳定版本已经很久没更新了，虽然有缺点也称不上完美但确实可以有效解决横向扩展问题。Redis 5.0 因为所谓的 <code>政治正确</code> 把 master-slave 名字修改为 master-replica 上了开源社区热议排行榜，然而大家在选择 Redis 集群方案的时候除了自研和 Codis 以外依然没有太多的选择余地。我们使用 Codis 的原因也很简单，Redis 主从模式内存从 128GB 一路增加到 1TB 后硬件终于受不鸟了，要么像数据库借鉴 “拆” 的奥义做到庖丁解牛一般，不然摆在眼前的路基本只剩下相对成熟可靠的 Codis。本文分享了 Redis 高可用技术解决方案选型的参考文章和 Codis 集群搭建的过程，希望对大家有帮助。</p><blockquote><p>Redis(Codis)分布式集群部署实践</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 07 月 23 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/codis/">https://wsgzao.github.io/post/codis/</a></p><p><strong> 扩展阅读 </strong></p><p><a href="https://redis.io/" target="_blank" rel="noopener">Redis</a><br><a href="https://github.com/CodisLabs/codis" target="_blank" rel="noopener">Codis</a></p><hr><h2 id="Codis-简介"><a href="#Codis-简介" class="headerlink" title="Codis 简介"></a>Codis 简介</h2><p>Codis 是一个分布式 Redis 解决方案, 对于上层的应用来说, 连接到 Codis Proxy 和连接原生的 Redis Server 没有显著区别 (<a href="https://github.com/CodisLabs/codis/blob/release3.2/doc/unsupported_cmds.md" target="_blank" rel="noopener">不支持的命令列表</a>), 上层应用可以像使用单机的 Redis 一样使用, Codis 底层会处理请求的转发, 不停机的数据迁移等工作, 所有后边的一切事情, 对于前面的客户端来说是透明的, 可以简单的认为后边连接的是一个内存无限大的 Redis 服务。</p><blockquote><p>Compared with Twemproxy and Redis Cluster</p></blockquote><table><thead><tr><th></th><th>Codis</th><th>Twemproxy</th><th>Redis Cluster</th></tr></thead><tbody><tr><td>resharding without restarting cluster</td><td>Yes</td><td>No</td><td>Yes</td></tr><tr><td>pipeline</td><td>Yes</td><td>Yes</td><td>No</td></tr><tr><td>hash tags for multi-key operations</td><td>Yes</td><td>Yes</td><td>Yes</td></tr><tr><td>multi-key operations while resharding</td><td>Yes</td><td>-</td><td>No(<a href="http://redis.io/topics/cluster-spec#multiple-keys-operations" target="_blank" rel="noopener">details</a>)</td></tr><tr><td>Redis clients supporting</td><td>Any clients</td><td>Any clients</td><td>Clients have to support cluster protocol</td></tr></tbody></table><p>“Resharding” means migrating the data in one slot from one redis server to another, usually happens while increasing/decreasing the number of redis servers.</p><blockquote><p>为什么要选择 Codis</p></blockquote><p>Redis 获得动态扩容 / 缩容的能力，增减 redis 实例对 client 完全透明、不需要重启服务，不需要业务方担心 Redis 内存爆掉的问题. 也不用担心申请太大, 造成浪费. 业务方也不需要自己维护 Redis.</p><p>Codis 支持水平扩容 / 缩容，扩容可以直接界面的 “Auto Rebalance” 按钮，缩容只需要将要下线的实例拥有的 slot 迁移到其它实例，然后在界面上删除下线的 group 即可。</p><p><a href="https://github.com/CodisLabs/codis/blob/release3.2/doc/tutorial_zh.md" target="_blank" rel="noopener">Codis 使用文档</a><br><a href="https://github.com/CodisLabs/codis/blob/release3.2/doc/FAQ_zh.md" target="_blank" rel="noopener">Codis FAQ</a><br><a href="https://github.com/CodisLabs/codis/blob/release3.2/doc/unsupported_cmds.md" target="_blank" rel="noopener">Codis 不支持的命令列表</a><br><a href="https://github.com/CodisLabs/codis/blob/release3.2/doc/redis_change_zh.md" target="_blank" rel="noopener">redis 修改部分（增加若干指令）</a><br><a href="https://github.com/CodisLabs/codis/blob/release3.2/doc/benchmark.md" target="_blank" rel="noopener">Performance (Benchmark)</a></p><h2 id="Codis-架构"><a href="#Codis-架构" class="headerlink" title="Codis 架构"></a>Codis 架构</h2><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190724162130.png" alt=""></p><p>集群配置前需要了解架构，集群分片主要分三种：</p><ol><li>客户端分片：这个需要自己开发，对客户端要求严格，集群很难扩容</li><li>代理端分片：如 codis，对客户端几乎无要求，集群容易扩容</li><li>服务端分片：如 redis 集群，需要智能客户端支持集群协议的，集群容易扩容</li></ol><p>Codis 3.x 由以下组件组成：</p><ul><li><p><strong>Codis Server</strong>：基于 redis-3.2.8 分支开发。增加了额外的数据结构，以支持 slot 有关的操作以及数据迁移指令。具体的修改可以参考文档 <a href="https://github.com/CodisLabs/codis/blob/release3.2/doc/redis_change_zh.md" target="_blank" rel="noopener">redis 的修改</a>。</p></li><li><p><strong>Codis Proxy</strong>：客户端连接的 Redis 代理服务, 实现了 Redis 协议。 除部分命令不支持以外(<a href="https://github.com/CodisLabs/codis/blob/release3.2/doc/unsupported_cmds.md" target="_blank" rel="noopener">不支持的命令列表</a>)，表现的和原生的 Redis 没有区别（就像 Twemproxy）。</p><ul><li>对于同一个业务集群而言，可以同时部署多个 codis-proxy 实例；</li><li>不同 codis-proxy 之间由 codis-dashboard 保证状态同步。</li></ul></li><li><p><strong>Codis Dashboard</strong>：集群管理工具，支持 codis-proxy、codis-server 的添加、删除，以及据迁移等操作。在集群状态发生改变时，codis-dashboard 维护集群下所有 codis-proxy 的状态的一致性。</p><ul><li>对于同一个业务集群而言，同一个时刻 codis-dashboard 只能有 0 个或者 1 个；</li><li>所有对集群的修改都必须通过 codis-dashboard 完成。</li></ul></li><li><p><strong>Codis Admin</strong>：集群管理的命令行工具。</p><ul><li>可用于控制 codis-proxy、codis-dashboard 状态以及访问外部存储。</li></ul></li><li><p><strong>Codis FE</strong>：集群管理界面。</p><ul><li>多个集群实例共享可以共享同一个前端展示页面；</li><li>通过配置文件管理后端 codis-dashboard 列表，配置文件可自动更新。</li></ul></li><li><p><strong>Storage</strong>：为集群状态提供外部存储。</p><ul><li>提供 Namespace 概念，不同集群的会按照不同 product name 进行组织；</li><li>目前仅提供了 Zookeeper、Etcd、Fs 三种实现，但是提供了抽象的 interface 可自行扩展。</li></ul></li></ul><h2 id="Codis-部署"><a href="#Codis-部署" class="headerlink" title="Codis 部署"></a>Codis 部署</h2><p>Codis 官方的 GitHub 教程已经写的比较详细了，这里重点分享 Ansible 自动化部署方案</p><h2 id="Codis-HA"><a href="#Codis-HA" class="headerlink" title="Codis HA"></a>Codis HA</h2><p>Codis 的架构本身分成 Proxy 集群 + Redis 集群，Proxy 集群的高可用，可以基于 Zookeeper 来做故障转移，而 Redis 集群的高可用是借助于 Redis Sentinel 开源的哨兵集群来实现，那边 Codis 作为非 Redis 组件，需要解决的一个问题就是如何集成 Redis 哨兵集群。</p><h2 id="Codis-监控"><a href="#Codis-监控" class="headerlink" title="Codis 监控"></a>Codis 监控</h2><h2 id="Redis-迁移至-Codis"><a href="#Redis-迁移至-Codis" class="headerlink" title="Redis 迁移至 Codis"></a>Redis 迁移至 Codis</h2><p>分两种情况:</p><ol><li>原来使用 twemproxy 的用户: 可以, 使用 codis 项目内的 redis-port 工具, 可以实时的同步 twemproxy 底下的 redis 数据到你的 codis 集群上. 搞定了以后, 只需要你修改一下你的配置, 将 twemproxy 的地址改成 codis 的地址就好了. 除此之外, 你什么事情都不用做.</li><li>原来使用 Redis 的用户: 如果你使用了 <a href="https://github.com/CodisLabs/codis/blob/release3.2/doc/unsupported_cmds.md" target="_blank" rel="noopener">doc/unsupported_cmds</a>中提到的命令，是无法直接迁移到 Codis 上的. 你需要修改你的代码, 用其他的方式实现.</li></ol><p>先搭建好 codis 集群并让 codis-proxy 正确运行起来。对线上每一个 redis 实例运行一个 redis-port 来向 codis 导入数据，例如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">for port in &#123;6379,6380,6479,6480&#125;; do</span><br><span class="line">    nohup redis-port sync --ncpu=4 --from=redis-server:$&#123;port&#125; \</span><br><span class="line">        --target=codis-proxy:19000 &gt; $&#123;port&#125;.log 2&gt;&amp;1 &amp;</span><br><span class="line">    sleep 5</span><br><span class="line">done</span><br><span class="line">tail -f *.log</span><br></pre></td></tr></table></figure><ul><li>每个 redis-port 负责将对应的 redis 数据导入到 codis</li><li>多个 redis-port 之间不互相干扰，除非多个 redis 上的 key 本身出现冲突</li><li>单个 redis-port 可以将负责的数据并行迁移以提高速度，通过 –ncpu 来指定并行数</li><li>导入速度受带宽以及 codis-proxy 处理速度限制(本质是大量的 slotsrestore 操作)</li><li>完成数据迁移，在适当的时候将服务指向 Codis，并将原 redis 下线，旧 redis 下线时，会导致 reids-port 链接断开，于是自动退出</li></ul><p><a href="https://github.com/CodisLabs/redis-port" target="_blank" rel="noopener">redis-port</a><br><a href="https://github.com/alibaba/RedisShake" target="_blank" rel="noopener">RedisShake</a><br><a href="https://github.com/sripathikrishnan/redis-rdb-tools" target="_blank" rel="noopener">redis-rdb-tools</a></p><h2 id="Codis-扩容"><a href="#Codis-扩容" class="headerlink" title="Codis 扩容"></a>Codis 扩容</h2><p>Codis 可以实现在线不停服务进行扩容，具体的步骤如下：</p><ol><li>安装配置 codis-server 主从</li><li>打开 codis 管理界面，新建 server group 并添加刚刚安装的 redis 实例（注意：codis 默认第一个添加的是 master）</li><li>规划 slot 分布，把部分 slot 迁移到新的 server group 中</li></ol><p><strong> 备注说明 </strong></p><ol><li>slot 迁移的过程中，Codis 服务可以正常访问，codis 的迁移机制可以保证数据的一致性</li><li>迁移时，key 都是单个进行迁移，并且不能同时运行多个迁移任务，所以 codis 的迁移时间会比较长。一定要在扩容前留有足够的时间和空间。</li></ol><h2 id="Codis-其他经验分享"><a href="#Codis-其他经验分享" class="headerlink" title="Codis 其他经验分享"></a>Codis 其他经验分享</h2><ol><li><p>关于 HOT KEY， HOT KEY 很影响 Codis/Redis 的性能，这点如果你监控不到位，你就得花一些力气去找到底是哪组出了问题，再 monitor 看看找出是哪个应用干的，比较费时费力，所以在交付 rd 上线时， 我们就严肃声明坚决不允许存在 HOT KEY，宁可使用笨方法多消耗一些内存，也要降低线上故障的风险。</p></li><li><p>关于 BIG KEY,  这点风险更为巨大：</p></li></ol><p>由于 Codis 支持 “resharding without restarting cluster”，如果迁移失败，所导致的后果也是不可简单衡量的。Redis 是串行提供服务的，所以当迁移该 BIG KEY 时，其他的请求就会被 BLOCK 住，这点是十分危险的，访问该组的请求皆会失败。</p><p>由于 Codis-ha 也会依赖该节点的返回来判断 Codis-server 是否挂掉，如果无响应超过设置时间，便会强制提升 SLAVE 至 MASTER，导致整个迁移任务失败。这时如果 Proxy 的信息没有更新的话，并且迁移故障的 KEY 所在 SLOT 可能会存在 KEY 的信息不完整，虽然服务恢复，但是仍有大量 key 失效。</p><p>所以一般不推荐使用 Codis 存大的 HASH 表，LIST 等等，并且在迁移之前，至少要对该 Group 做一次检查 BIG KEY 即：redis-cli –bigkeys 查看是否有 BIG KEY 存在，再酌情迁移。</p><ol start="3"><li>关于 Codis-server，一般 Codis-proxy 或者 Codis-dashboard 我们使用 supervisor 管理，在进程退出的情况下立即拉起来重新服务，而 Codis-Server 则不推荐使用该方式，原因是这样的：一般作为 Codis-server，是关闭 rdb dump 的，如果 Codis-server 挂掉，当重新启动时，是没有 rdb 文件的，或者 rdb 文件是上一次切换之前的。如果挂掉立即重新启动，则该 Codis 有可能是空的，或者数据不是最新，而同时，SLAVE 同步，也会清空数据库，或者同步旧数据。</li></ol><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a href="https://mp.weixin.qq.com/s/BoLsVKYyu8yRXZbxd1uuQw" target="_blank" rel="noopener">史上最全 Redis 高可用技术解决方案大全</a><br><a href="https://mp.weixin.qq.com/s/F68-e2umTQIq0aGfif58ow" target="_blank" rel="noopener">深入浅出百亿请求高可用 Redis (codis) 分布式集群揭秘</a><br><a href="https://cloud.tencent.com/developer/article/1006262" target="_blank" rel="noopener">大规模 codis 集群的治理与实践</a><br><a href="https://www.menina.cn/article/61" target="_blank" rel="noopener">避免 Redis (Codis) 的 Timeout 及监控</a><br><a href="https://mp.weixin.qq.com/s?__biz=MzA4Nzg5Nzc5OA==&amp;mid=2651678993&amp;idx=1&amp;sn=195b7e98450befb9bde04ea58756a731&amp;chksm=8bcbaab8bcbc23ae01f8288bcfb2c65d0e8b9ee4610420c252fa1ab5709b7909b26d4d5da67b&amp;mpshare=1&amp;scene=23&amp;srcid&amp;sharer_sharetime=1565249364003&amp;sharer_shareid=456ba82bbd1a1c9f32e5725824095308%23rd" target="_blank" rel="noopener">10 分钟彻底理解 Redis 的持久化和主从复制</a></p>]]></content>
    
    <summary type="html">
    
      Redis(Codis)分布式集群部署实践
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>使用 MegaCli64 快速查看 RAID 和定位故障硬盘实践</title>
    <link href="https://wsgzao.github.io/post/megacli64/"/>
    <id>https://wsgzao.github.io/post/megacli64/</id>
    <published>2019-07-21T06:59:49.000Z</published>
    <updated>2019-07-22T08:52:16.363Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>MegaCli 是 LSI 公司官方提供的 SCSI 卡管理工具，由于 LSI 被收购变成了现在的 Broadcom，所以想下载 MegaCli，需要去 Broadcom 官网查找。现在官方有 Storcli，整合了 LSI 和 3ware 所有产品，本文主要以 MegaCli64 为例，无论选择 MegaCli 还是 Storcli 只要在线上环境运行稳定可以获取正确数据就都是合适的方法。</p><blockquote><p>使用 MegaCli64 快速查看 RAID 和定位故障硬盘实践</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 07 月 21 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/megacli64/">https://wsgzao.github.io/post/megacli64/</a></p><p><strong> 扩展阅读 </strong></p><p><a href="https://www.broadcom.com/support/knowledgebase/1211161499760/lsi-command-line-interface-cross-reference-megacli-vs-twcli-vs-s" target="_blank" rel="noopener">MegaCLI vs tw_cli vs Storcli</a><br><a href="https://www.dell.com/support/article/sg/en/sgdhs1/sln292232/extracting-the-raid-controller-logs-via-megacli?lang=en" target="_blank" rel="noopener">Extracting the RAID-Controller Logs via MegaCLI</a></p><hr><h2 id="MegaCli-简介"><a href="#MegaCli-简介" class="headerlink" title="MegaCli 简介"></a>MegaCli 简介</h2><p>MegaRaid 阵列卡管理工具。他可以查看当前 RAID 卡的所有信息，包括 RAID 卡型号、类型、磁盘状态、电池状态等等。学会了如何使用 MegaCli，我们可以在硬盘没有彻底嗝屁（Failed）之前，监测到是否已经出现预告警报错，不需要现场逐台巡检磁盘状态灯。</p><ol><li>使用 Zabbix 监控硬盘或者使用 IPMI 接入 OOB(Out-of-Band) 监控硬件状态</li><li>使用更加成熟的商业化工具管理如 <a href="http://www.idcos.com/products/cloudboot-compare" target="_blank" rel="noopener">云霁科技 CloudBoot</a>，拒绝被单一厂商绑架</li></ol><p>MegaCli64 官网地址: <a href="http://docs.avagotech.com/docs/12351587" target="_blank" rel="noopener">http://docs.avagotech.com/docs/12351587</a></p><p>Linux 下默认路径: <code>/opt/MegaRAID/MegaCli/MegaCli64</code></p><h2 id="MegaCli-安装"><a href="#MegaCli-安装" class="headerlink" title="MegaCli 安装"></a>MegaCli 安装</h2><ol><li><p>Download the <a href="http://docs.avagotech.com/docs/12351587?_ga=2.81670295.1654370925.1557214314-814067834.1557214314" target="_blank" rel="noopener">MegaCli utility</a> from the Broadcom support site</p></li><li><p>Unzip the downloaded files and install them to any directory of your installed operating system (e.g.: Linux – /tmp/megacli)</p></li><li><p>From a terminal window in Linux, install the using the the following command:</p><p> <strong>Note</strong>: root priviledges required to install MegaCLI:</p><p> <code>rpm -i MegaCli-8.07.14-1.noarch.rpm</code></p></li><li><p>Then change directory into <strong>/opt/MegaRAID/MegaCLI/</strong> and run any of the commands from the table below:</p></li></ol><table><thead><tr><th>Command</th><th>Action</th></tr></thead><tbody><tr><td><code>./MegaCli64 -FwTermLog -Dsply -aALL &gt; /tmp/ttylog.txt</code></td><td>Creates the RAID controller log (ttylog)</td></tr><tr><td><code>./MegaCli64 -PDList -aALL &gt; /tmp/disks.txt</code></td><td>Creates a list with information about the RAID controllers, virtual disks and hard disks installed</td></tr><tr><td><code>./MegaCli64 -LDInfo -LALL -aALL &gt; /tmp/LDinfo.txt</code></td><td>Creates a list with information about existing RAID volumes and configurations</td></tr><tr><td><code>./MegaCli64 -AdpAllInfo -aALL &gt; /tmp/Adapterinfo.txt</code></td><td>Creates a list with information about RAID controller settings</td></tr><tr><td><code>./MegaCli64 -AdpBbuCmd -aALL &gt; /tmp/Battery.txt</code></td><td>Creates a detailed list of the battery status of the RAID controller (state of charge, learning cycle, etc.)</td></tr><tr><td><code>./MegaCli64 -AdpEventLog -IncludeDeleted -f deleted.txt -aALL</code></td><td>Creates the RAID controller log (ttylog) with all information since very first controller initialization( <strong>Note</strong>: This file will always be saved in the MegaCLI root folder)</td></tr></tbody></table><h2 id="使用-MegaCli64-查看硬盘信息"><a href="#使用-MegaCli64-查看硬盘信息" class="headerlink" title="使用 MegaCli64 查看硬盘信息"></a>使用 MegaCli64 查看硬盘信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost wangao]<span class="comment"># MegaCli -ShowSummary -aALL</span></span><br><span class="line"></span><br><span class="line">System</span><br><span class="line">Operating System:  Linux version 3.10.0-957.21.3.el7.x86_64</span><br><span class="line">Driver Version: 07.705.02.00-rh1</span><br><span class="line">CLI Version: 8.07.06</span><br><span class="line"></span><br><span class="line">Hardware</span><br><span class="line">        Controller</span><br><span class="line">                 ProductName       : PERC H730P Mini(Bus 0, Dev 0)</span><br><span class="line">                 SAS Address       : 51866da0a1306300</span><br><span class="line">                 FW Package Version: 25.5.0.0018</span><br><span class="line">                 Status            : Optimal</span><br><span class="line">        BBU</span><br><span class="line">                 BBU Type          : BBU</span><br><span class="line">                 Status            : Healthy</span><br><span class="line">        Enclosure</span><br><span class="line">                 Product Id        : BP13G+EXP</span><br><span class="line">                 Type              : SES</span><br><span class="line">                 Status            : OK</span><br><span class="line"></span><br><span class="line">        PD</span><br><span class="line">                Connector          : 00&lt;Internal&gt;&lt;Encl Pos 1 &gt;: Slot 0</span><br><span class="line">                Vendor Id          : HGST</span><br><span class="line">                Product Id         : HUS726060AL5214</span><br><span class="line">                State              : Online</span><br><span class="line">                Disk Type          : SAS,Hard Disk Device</span><br><span class="line">                Capacity           : 5.457 TB</span><br><span class="line">                Power State        : Active</span><br><span class="line"></span><br><span class="line">                Connector          : 00&lt;Internal&gt;&lt;Encl Pos 1 &gt;: Slot 1</span><br><span class="line">                Vendor Id          : HGST</span><br><span class="line">                Product Id         : HUS726060AL5214</span><br><span class="line">                State              : Online</span><br><span class="line">                Disk Type          : SAS,Hard Disk Device</span><br><span class="line">                Capacity           : 5.457 TB</span><br><span class="line">                Power State        : Active</span><br><span class="line"></span><br><span class="line">                Connector          : 00&lt;Internal&gt;&lt;Encl Pos 1 &gt;: Slot 2</span><br><span class="line">                Vendor Id          : HGST</span><br><span class="line">                Product Id         : HUS726060AL5214</span><br><span class="line">                State              : Online</span><br><span class="line">                Disk Type          : SAS,Hard Disk Device</span><br><span class="line">                Capacity           : 5.457 TB</span><br><span class="line">                Power State        : Active</span><br><span class="line"></span><br><span class="line">                Connector          : 00&lt;Internal&gt;&lt;Encl Pos 1 &gt;: Slot 3</span><br><span class="line">                Vendor Id          : HGST</span><br><span class="line">                Product Id         : HUS726060AL5214</span><br><span class="line">                State              : Online</span><br><span class="line">                Disk Type          : SAS,Hard Disk Device</span><br><span class="line">                Capacity           : 5.457 TB</span><br><span class="line">                Power State        : Active</span><br><span class="line"></span><br><span class="line">                Connector          : 00&lt;Internal&gt;&lt;Encl Pos 1 &gt;: Slot 4</span><br><span class="line">                Vendor Id          : HGST</span><br><span class="line">                Product Id         : HUS726060AL5214</span><br><span class="line">                State              : Online</span><br><span class="line">                Disk Type          : SAS,Hard Disk Device</span><br><span class="line">                Capacity           : 5.457 TB</span><br><span class="line">                Power State        : Active</span><br><span class="line"></span><br><span class="line">                Connector          : 00&lt;Internal&gt;&lt;Encl Pos 1 &gt;: Slot 5</span><br><span class="line">                Vendor Id          : HGST</span><br><span class="line">                Product Id         : HUS726060AL5214</span><br><span class="line">                State              : Online</span><br><span class="line">                Disk Type          : SAS,Hard Disk Device</span><br><span class="line">                Capacity           : 5.457 TB</span><br><span class="line">                Power State        : Active</span><br><span class="line"></span><br><span class="line">                Connector          : 00&lt;Internal&gt;&lt;Encl Pos 1 &gt;: Slot 6</span><br><span class="line">                Vendor Id          : HGST</span><br><span class="line">                Product Id         : HUS726060AL5214</span><br><span class="line">                State              : Online</span><br><span class="line">                Disk Type          : SAS,Hard Disk Device</span><br><span class="line">                Capacity           : 5.457 TB</span><br><span class="line">                Power State        : Active</span><br><span class="line"></span><br><span class="line">                Connector          : 00&lt;Internal&gt;&lt;Encl Pos 1 &gt;: Slot 7</span><br><span class="line">                Vendor Id          : HGST</span><br><span class="line">                Product Id         : HUS726060AL5214</span><br><span class="line">                State              : Online</span><br><span class="line">                Disk Type          : SAS,Hard Disk Device</span><br><span class="line">                Capacity           : 5.457 TB</span><br><span class="line">                Power State        : Active</span><br><span class="line"></span><br><span class="line">                Connector          : 00&lt;Internal&gt;&lt;Encl Pos 1 &gt;: Slot 8</span><br><span class="line">                Vendor Id          : HGST</span><br><span class="line">                Product Id         : HUS726060AL5214</span><br><span class="line">                State              : Online</span><br><span class="line">                Disk Type          : SAS,Hard Disk Device</span><br><span class="line">                Capacity           : 5.457 TB</span><br><span class="line">                Power State        : Active</span><br><span class="line"></span><br><span class="line">                Connector          : 00&lt;Internal&gt;&lt;Encl Pos 1 &gt;: Slot 9</span><br><span class="line">                Vendor Id          : HGST</span><br><span class="line">                Product Id         : HUS726060AL5214</span><br><span class="line">                State              : Online</span><br><span class="line">                Disk Type          : SAS,Hard Disk Device</span><br><span class="line">                Capacity           : 5.457 TB</span><br><span class="line">                Power State        : Active</span><br><span class="line"></span><br><span class="line">                Connector          : 00&lt;Internal&gt;&lt;Encl Pos 1 &gt;: Slot 10</span><br><span class="line">                Vendor Id          : HGST</span><br><span class="line">                Product Id         : HUS726060AL5214</span><br><span class="line">                State              : Online</span><br><span class="line">                Disk Type          : SAS,Hard Disk Device</span><br><span class="line">                Capacity           : 5.457 TB</span><br><span class="line">                Power State        : Active</span><br><span class="line"></span><br><span class="line">                Connector          : 00&lt;Internal&gt;&lt;Encl Pos 1 &gt;: Slot 11</span><br><span class="line">                Vendor Id          : HGST</span><br><span class="line">                Product Id         : HUS726060AL5214</span><br><span class="line">                State              : Online</span><br><span class="line">                Disk Type          : SAS,Hard Disk Device</span><br><span class="line">                Capacity           : 5.457 TB</span><br><span class="line">                Power State        : Active</span><br><span class="line"></span><br><span class="line">                Connector          : 00&lt;Internal&gt;&lt;Encl Pos 1 &gt;: Slot 12</span><br><span class="line">                Vendor Id          : ATA</span><br><span class="line">                Product Id         : ST9250610NS</span><br><span class="line">                State              : Online</span><br><span class="line">                Disk Type          : SATA,Hard Disk Device</span><br><span class="line">                Capacity           : 232.375 GB</span><br><span class="line">                Power State        : Active</span><br><span class="line"></span><br><span class="line">                Connector          : 00&lt;Internal&gt;&lt;Encl Pos 1 &gt;: Slot 13</span><br><span class="line">                Vendor Id          : ATA</span><br><span class="line">                Product Id         : ST9250610NS</span><br><span class="line">                State              : Online</span><br><span class="line">                Disk Type          : SATA,Hard Disk Device</span><br><span class="line">                Capacity           : 232.375 GB</span><br><span class="line">                Power State        : Active</span><br><span class="line"></span><br><span class="line">                Connector          : 00&lt;Internal&gt;&lt;Encl Pos 1 &gt;: Slot 14</span><br><span class="line">                Vendor Id          : HGST</span><br><span class="line">                Product Id         : HUS726060AL5214</span><br><span class="line">                State              : Online</span><br><span class="line">                Disk Type          : SAS,Hard Disk Device</span><br><span class="line">                Capacity           : 5.457 TB</span><br><span class="line">                Power State        : Active</span><br><span class="line"></span><br><span class="line">                Connector          : 00&lt;Internal&gt;&lt;Encl Pos 1 &gt;: Slot 15</span><br><span class="line">                Vendor Id          : HGST</span><br><span class="line">                Product Id         : HUS726060AL5214</span><br><span class="line">                State              : Online</span><br><span class="line">                Disk Type          : SAS,Hard Disk Device</span><br><span class="line">                Capacity           : 5.457 TB</span><br><span class="line">                Power State        : Active</span><br><span class="line"></span><br><span class="line">                Connector          : 00&lt;Internal&gt;&lt;Encl Pos 1 &gt;: Slot 16</span><br><span class="line">                Vendor Id          : HGST</span><br><span class="line">                Product Id         : HUS726060AL5214</span><br><span class="line">                State              : Online</span><br><span class="line">                Disk Type          : SAS,Hard Disk Device</span><br><span class="line">                Capacity           : 5.457 TB</span><br><span class="line">                Power State        : Active</span><br><span class="line"></span><br><span class="line">                Connector          : 00&lt;Internal&gt;&lt;Encl Pos 1 &gt;: Slot 17</span><br><span class="line">                Vendor Id          : HGST</span><br><span class="line">                Product Id         : HUS726060AL5214</span><br><span class="line">                State              : Online</span><br><span class="line">                Disk Type          : SAS,Hard Disk Device</span><br><span class="line">                Capacity           : 5.457 TB</span><br><span class="line">                Power State        : Active</span><br><span class="line"></span><br><span class="line">Storage</span><br><span class="line"></span><br><span class="line">       Virtual Drives</span><br><span class="line">                Virtual drive      : Target Id 0 ,VD name</span><br><span class="line">                Size               : 232.375 GB</span><br><span class="line">                State              : Optimal</span><br><span class="line">                RAID Level         : 1</span><br><span class="line"></span><br><span class="line">                Virtual drive      : Target Id 1 ,VD name</span><br><span class="line">                Size               : 81.862 TB</span><br><span class="line">                State              : Optimal</span><br><span class="line">                RAID Level         : 5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exit Code: 0x00</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check virutal disk / raid info</span></span><br><span class="line"><span class="keyword">if</span> [[ -f /opt/MegaRAID/MegaCli/MegaCli64 ]]; <span class="keyword">then</span></span><br><span class="line">    raidlevel=`sudo /opt/MegaRAID/MegaCli/MegaCli64 -LDInfo -Lall -aALL -NoLog | grep <span class="string">'RAID Level'</span> | awk -F <span class="string">":"</span> <span class="string">'&#123;print $2&#125;'</span> | awk -F <span class="string">","</span> &#123;<span class="string">'print $1&#125;'</span> | awk -F <span class="string">"-"</span> <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line">    disk_number=`sudo /opt/MegaRAID/MegaCli/MegaCli64 -PDList -aALL -NoLog | egrep <span class="string">'Device Id'</span> | awk <span class="string">'BEGIN &#123;RS=""; FS="\n"&#125; &#123;print NF&#125;'</span>`</span><br><span class="line">    disk_type=`sudo /opt/MegaRAID/MegaCli/MegaCli64 -PDList -aALL -NoLog | egrep <span class="string">'Media Type'</span> | head -1 | awk -F <span class="string">":"</span> <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    raidlevel=<span class="string">"none"</span></span><br><span class="line">    disk_number=<span class="string">"none"</span></span><br><span class="line">    disk_type=<span class="string">"none"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># test</span></span><br><span class="line">[root@localhost wangao]<span class="comment"># echo $raidlevel</span></span><br><span class="line">1 5</span><br><span class="line">[root@localhost wangao]<span class="comment"># echo $disk_number</span></span><br><span class="line">18</span><br><span class="line">[root@localhost wangao]<span class="comment"># echo $disk_type</span></span><br><span class="line">Hard Disk Device</span><br></pre></td></tr></table></figure><h2 id="Ansible-安装-MegaCLi64"><a href="#Ansible-安装-MegaCLi64" class="headerlink" title="Ansible 安装 MegaCLi64"></a>Ansible 安装 MegaCLi64</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  become:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  gather_facts:</span> <span class="literal">no</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">upload</span> <span class="string">MegaCli64</span></span><br><span class="line"><span class="attr">      copy:</span></span><br><span class="line"><span class="attr">        src:</span> <span class="string">files/MegaCli-8.07.14-1.noarch.rpm</span></span><br><span class="line"><span class="attr">        dest:</span> <span class="string">/tmp/MegaCli-8.07.14-1.noarch.rpm</span></span><br><span class="line">        </span><br><span class="line"><span class="attr">    - name:</span> <span class="string">install</span> <span class="string">MegaCli64</span> <span class="string">rpm</span> <span class="string">from</span> <span class="string">a</span> <span class="string">local</span> <span class="string">file</span></span><br><span class="line"><span class="attr">      yum:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">/tmp/MegaCli-8.07.14-1.noarch.rpm</span></span><br><span class="line"><span class="attr">        state:</span> <span class="string">present</span></span><br><span class="line">        </span><br><span class="line"><span class="attr">    - name:</span> <span class="string">create</span> <span class="string">symlink</span> <span class="string">for</span> <span class="string">MegaCli64</span></span><br><span class="line"><span class="attr">      file:</span></span><br><span class="line"><span class="attr">        src:</span> <span class="string">/opt/MegaRAID/MegaCli/MegaCli64</span></span><br><span class="line"><span class="attr">        dest:</span> <span class="string">/usr/sbin/MegaCli</span></span><br><span class="line"><span class="attr">        state:</span> <span class="string">link</span></span><br></pre></td></tr></table></figure><h2 id="Ansible-使用-MegaCli64-检查故障硬盘"><a href="#Ansible-使用-MegaCli64-检查故障硬盘" class="headerlink" title="Ansible 使用 MegaCli64 检查故障硬盘"></a>Ansible 使用 MegaCli64 检查故障硬盘</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  become:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  gather_facts:</span> <span class="literal">no</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Check</span> <span class="string">Disk</span> <span class="string">Status</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">./MegaCli64</span> <span class="bullet">-ShowSummary</span> <span class="bullet">-aALL</span></span><br><span class="line"><span class="attr">      args:</span></span><br><span class="line"><span class="attr">        chdir:</span> <span class="string">/opt/MegaRAID/MegaCli/</span></span><br><span class="line"><span class="attr">      register:</span> <span class="string">result</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Log</span> <span class="string">check</span> <span class="string">info</span></span><br><span class="line"><span class="attr">      lineinfile:</span></span><br><span class="line"><span class="attr">        dest:</span> <span class="string">"<span class="template-variable">&#123;&#123;inventory_dir&#125;&#125;</span>/ansible.log"</span></span><br><span class="line"><span class="attr">        line:</span> <span class="string">'[Ansiable Tasks: Disk Failure info] host=<span class="template-variable">&#123;&#123;inventory_hostname&#125;&#125;</span>'</span></span><br><span class="line"><span class="attr">        insertafter:</span> <span class="string">EOF</span> </span><br><span class="line"><span class="attr">        create:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">      when:</span> <span class="string">'"Failed" in result.stdout'</span></span><br><span class="line"><span class="attr">      delegate_to:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">      become:</span> <span class="literal">no</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check log</span></span><br><span class="line">cat ansible.log</span><br><span class="line">[Ansiable Tasks: Disk Failure info] host=10.71.12.89</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      使用MegaCli64快速查看RAID和定位故障硬盘实践
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>CPU 优化建议使用 cpupower 设置 CPU Performance 模式</title>
    <link href="https://wsgzao.github.io/post/cpupower/"/>
    <id>https://wsgzao.github.io/post/cpupower/</id>
    <published>2019-07-17T05:59:49.000Z</published>
    <updated>2019-07-19T02:57:25.284Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>CPU 动态节能技术用于降低服务器功耗，通过选择系统空闲状态不同的电源管理策略，可以实现不同程度降低服务器功耗，更低的功耗策略意味着 CPU 唤醒更慢对性能影响更大。对于对时延和性能要求高的应用，建议关闭 CPU 的动态调节功能，禁止 CPU 休眠，并把 CPU 频率固定到最高。通常建议在服务器 BIOS 中修改电源管理为 Performance，如果发现 CPU 模式为 conservative 或者 powersave，可以使用 cpupower 设置 CPU Performance 模式，效果也是相当显著的。</p><blockquote><p>CPU 优化建议使用 cpupower 设置 CPU Performance 模式</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 07 月 17 日 - 更新 cpupower 自启动设置脚本<br>2019 年 01 月 18 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/cpupower/">https://wsgzao.github.io/post/cpupower/</a></p><p><strong> 扩展阅读 </strong></p><p>CPU frequency scaling - <a href="https://wiki.archlinux.org/index.php/CPU_frequency_scaling" target="_blank" rel="noopener">https://wiki.archlinux.org/index.php/CPU_frequency_scaling</a></p><hr><h2 id="cpufreq-的五种模式"><a href="#cpufreq-的五种模式" class="headerlink" title="cpufreq 的五种模式"></a>cpufreq 的五种模式</h2><p>cpufreq 是一个动态调整 cpu 频率的模块，系统启动时生成一个文件夹 / sys/devices/system/cpu/cpu0/cpufreq/，里面有几个文件，其中 scaling_min_freq 代表最低频率，scaling_max_freq 代表最高频率，scalin_governor 代表 cpu 频率调整模式，用它来控制 CPU 频率。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /sys/devices/system/cpu/cpu0/cpufreq/</span><br><span class="line"></span><br><span class="line">affected_cpus</span><br><span class="line">bios_limit</span><br><span class="line">cpuinfo_cur_freq</span><br><span class="line">cpuinfo_max_freq</span><br><span class="line">cpuinfo_min_freq</span><br><span class="line">cpuinfo_transition_latency</span><br><span class="line">freqdomain_cpus</span><br><span class="line">related_cpus</span><br><span class="line">scaling_available_frequencies</span><br><span class="line">scaling_available_governors</span><br><span class="line">scaling_cur_freq</span><br><span class="line">scaling_driver</span><br><span class="line">scaling_governor</span><br><span class="line">scaling_max_freq</span><br><span class="line">scaling_min_freq</span><br><span class="line">scaling_setspeed</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前的调节器</span></span><br><span class="line">cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor</span><br><span class="line">conservative</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看频率信息</span></span><br><span class="line">cpupower frequency-info</span><br><span class="line"></span><br><span class="line">analyzing CPU 0:</span><br><span class="line">  driver: acpi-cpufreq</span><br><span class="line">  CPUs <span class="built_in">which</span> run at the same hardware frequency: 0</span><br><span class="line">  CPUs <span class="built_in">which</span> need to have their frequency coordinated by software: 0</span><br><span class="line">  maximum transition latency: 10.0 us</span><br><span class="line">  hardware limits: 800 MHz - 2.10 GHz</span><br><span class="line">  available frequency steps:  2.10 GHz, 2.10 GHz, 2.00 GHz, 1.90 GHz, 1.80 GHz, 1.70 GHz, 1.60 GHz, 1.50 GHz, 1.40 GHz, 1.30 GHz, 1.20 GHz, 1.10 GHz, 1000 MHz, 900 MHz, 800 MHz</span><br><span class="line">  available cpufreq governors: conservative userspace powersave ondemand performance</span><br><span class="line">  current policy: frequency should be within 800 MHz and 2.10 GHz.</span><br><span class="line">                  The governor <span class="string">"performance"</span> may decide <span class="built_in">which</span> speed to use</span><br><span class="line">                  within this range.</span><br><span class="line">  current CPU frequency: Unable to call hardware</span><br><span class="line">  current CPU frequency: 2.10 GHz (asserted by call to kernel)</span><br><span class="line">  boost state support:</span><br><span class="line">    Supported: yes</span><br><span class="line">    Active: yes</span><br></pre></td></tr></table></figure><ol><li>performance: 顾名思义只注重效率，将 CPU 频率固定工作在其支持的最高运行频率上，而不动态调节。</li><li>Userspace: 最早的 cpufreq 子系统通过 userspace governor 为用户提供了这种灵活性。系统将变频策略的决策权交给了用户态应用程序，并提供了相应的接口供用户态应用程序调节 CPU 运行频率使用。也就是长期以来都在用的那个模式。可以通过手动编辑配置文件进行配置</li><li>powersave: 将 CPU 频率设置为最低的所谓 “省电” 模式，CPU 会固定工作在其支持的最低运行频率上。因此这两种 governors 都属于静态 governor，即在使用它们时 CPU 的运行频率不会根据系统运行时负载的变化动态作出调整。这两种 governors 对应的是两种极端的应用场景，使用 performance governor 是对系统高性能的最大追求，而使用 powersave governor 则是对系统低功耗的最大追求。</li><li>ondemand: 按需快速动态调整 CPU 频率， 一有 cpu 计算量的任务，就会立即达到最大频率运行，等执行完毕就立即回到最低频率；ondemand：userspace 是内核态的检测，用户态调整，效率低。而 ondemand 正是人们长期以来希望看到的一个完全在内核态下工作并且能够以更加细粒度的时间间隔对系统负载情况进行采样分析的 governor。 在 ondemand governor 监测到系统负载超过 up_threshold 所设定的百分比时，说明用户当前需要 CPU 提供更强大的处理能力，因此 ondemand governor 会将 CPU 设置在最高频率上运行。但是当 ondemand governor 监测到系统负载下降，可以降低 CPU 的运行频率时，到底应该降低到哪个频率呢？ ondemand governor 的最初实现是在可选的频率范围内调低至下一个可用频率，例如 CPU 支持三个可选频率，分别为 1.67GHz、1.33GHz 和 1GHz ，如果 CPU 运行在 1.67GHz 时 ondemand governor 发现可以降低运行频率，那么 1.33GHz 将被选作降频的目标频率。</li><li>conservative: 与 ondemand 不同，平滑地调整 CPU 频率，频率的升降是渐变式的, 会自动在频率上下限调整，和 ondemand 的区别在于它会按需分配频率，而不是一味追求最高频率；</li></ol><h2 id="cpupower-设置-performance"><a href="#cpupower-设置-performance" class="headerlink" title="cpupower 设置 performance"></a>cpupower 设置 performance</h2><blockquote><p>从 conservative 或者 powersave 切换到 performance 的效果还是杠杠的</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CentOS 安装 kernel-tools</span></span><br><span class="line">yum install kernel-tools</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ubuntu 安装 CPU 模式无图形化切换器</span></span><br><span class="line">apt install cpufrequtils</span><br><span class="line"></span><br><span class="line"><span class="comment"># cpupower 设置 performance</span></span><br><span class="line">cpupower frequency-set -g performance</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前的调节器</span></span><br><span class="line">cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor</span><br><span class="line">performance</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 cpupower 配置文件</span></span><br><span class="line">cat &lt;&lt; EOF | sudo tee /etc/sysconfig/cpupower</span><br><span class="line"><span class="comment"># See 'cpupower help' and cpupower(1) for more info</span></span><br><span class="line">CPUPOWER_START_OPTS=<span class="string">"frequency-set -g performance"</span></span><br><span class="line">CPUPOWER_STOP_OPTS=<span class="string">"frequency-set -g ondemand"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建自启动服务</span></span><br><span class="line">cat &lt;&lt; EOF | sudo tee /usr/lib/systemd/system/cpupower.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Configure CPU power related settings</span><br><span class="line">After=syslog.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=oneshot</span><br><span class="line">RemainAfterExit=yes</span><br><span class="line">EnvironmentFile=/etc/sysconfig/cpupower</span><br><span class="line">ExecStart=/usr/bin/cpupower <span class="variable">$CPUPOWER_START_OPTS</span></span><br><span class="line">ExecStop=/usr/bin/cpupower <span class="variable">$CPUPOWER_STOP_OPTS</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 刷新 system 服务</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> cpupower.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># systemd.service — Service unit configuration</span></span><br><span class="line">https://www.freedesktop.org/software/systemd/man/systemd.service.html</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190702190945.png" alt=""></p><h2 id="无法使用-cpupower-调整-performance"><a href="#无法使用-cpupower-调整-performance" class="headerlink" title="无法使用 cpupower 调整 performance"></a>无法使用 cpupower 调整 performance</h2><blockquote><p>比如我们遇到相同类型 CPU 硬件和操作系统版本，但不同厂商会出现无法使用 cpupower 调整 performance 的情况</p></blockquote><p>Dell R440 CPU: Intel(R) Xeon(R) Silver 4116 CPU @ 2.10GHz <code>Failed</code></p><p>Dell R430 CPU: Intel(R) Xeon(R) CPU E5-2640 v4 @ 2.40GHz <code>Success</code></p><p>Huawei 1288H V5 CPU: Intel(R) Xeon(R) Silver 4116 CPU @ 2.10GHz <code>Success</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果遇到以下报错请确认硬件厂商是否做了限制，只能通过 BIOS 调节</span></span><br><span class="line">[root@sg-gop-10-71-14-91 wangao]<span class="comment"># cpupower frequency-set -g performance</span></span><br><span class="line">Setting cpu: 0</span><br><span class="line">Error setting new values. Common errors:</span><br><span class="line">- Do you have proper administration rights? (super-user?)</span><br><span class="line">- Is the governor you requested available and modprobed?</span><br><span class="line">- Trying to <span class="built_in">set</span> an invalid policy?</span><br><span class="line">- Trying to <span class="built_in">set</span> a specific frequency, but userspace governor is not available,</span><br><span class="line">   <span class="keyword">for</span> example because of hardware <span class="built_in">which</span> cannot be <span class="built_in">set</span> to a specific frequency</span><br><span class="line">   or because the userspace governor isn<span class="string">'t loaded?</span></span><br></pre></td></tr></table></figure><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://www.kernel.org/doc/Documentation/cpu-freq/governors.txt" target="_blank" rel="noopener">CPU frequency and voltage scaling code in the Linux(TM) kernel</a><br><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/power_management_guide/index" target="_blank" rel="noopener">POWER MANAGEMENT GUIDE</a></p>]]></content>
    
    <summary type="html">
    
      CPU优化建议使用cpupower设置CPU Performance模式
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>OKR 和 KPI</title>
    <link href="https://wsgzao.github.io/post/okr/"/>
    <id>https://wsgzao.github.io/post/okr/</id>
    <published>2019-07-12T06:59:49.000Z</published>
    <updated>2019-07-12T14:17:16.979Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>OKR 和 KPI 对于大家应该都是耳熟能详的绩效考核方式，因为部门在推行 OKR 和 360 度绩效考核，我阅读完《OKR 工作法》这本书后在组内也做了分享，结合我们小组的实践过程记录下自己的心得体会，我也非常赞同左耳朵耗子大大的观点: 绩效分应该打给项目，打给产品，打给部门，打给代码，而不是打给人。</p><blockquote><p>OKR 和 KPI</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 07 月 12 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/okr/">https://wsgzao.github.io/post/okr/</a></p><p><strong> 扩展阅读 </strong></p><p>SRE 和 DevOps - <a href="https://wsgzao.github.io/post/sre-vs-devops/">https://wsgzao.github.io/post/sre-vs-devops/</a></p><hr><h2 id="OKR-和-KPI-的概念"><a href="#OKR-和-KPI-的概念" class="headerlink" title="OKR 和 KPI 的概念"></a>OKR 和 KPI 的概念</h2><p>OKR（Objectives and Key Results），目标与关键成果法。从概念上能看出，OKR 本身是一种目标管理方法，用以评价员工是否称职，<strong> 并不是绩效考核工具 </strong>，一般不和工资挂钩。</p><p>KPI（Key Performance Indicator），关键绩效指标。是一种衡量员工表现，以及管理公司整体绩效的工具，<strong> 和员工收入直接关联。</strong></p><h2 id="OKR-工作法"><a href="#OKR-工作法" class="headerlink" title="OKR 工作法"></a>OKR 工作法</h2><blockquote><p>一句话讲清楚 OKR 核心：制定一个较长期的目标（Objective），并且将目标分解成为一些关键的结果（Key Results）</p></blockquote><p>《OKR 工作法》推荐一种四象限的 OKR 展示形式：</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190712180751.png" alt=""></p><p>本周关注的任务：列出 3~4 件最重要的事情，只有本周完成了这几件事情，团队的目标才能向前推进；明确这些事情的优先级。</p><p>未来四周的计划：有哪些事情需要其他团队成员做好准备或支持，都列在这个象限里。</p><p>OKR 当前的状态：如果你设定的信心指数是 5/10，那目前完成的概率是更高了还是更低了，团队一起讨论一下原因。</p><p>状态指标：挑出两个影响目标达成的其他因素，团队需要额外关注，比如客户关系、团队状态、系统状况等。当这些地方发生意外时，马上讨论找出应对方案，确保 OKR 不受影响。</p><p>这个文档会成为 OKR 执行过程中的会议工具，你应该学会这样讨论问题：</p><ul><li>这个优先级列表能确保我们的 OKR 完成吗？</li><li>团队的能力可以完成 OKR 吗？谁能帮助我们？</li><li>我们准备好新一轮的发力了吗？市场部知道产品部马上要做什么吗？</li><li>我们的团队已经筋疲力尽了吗？我们的产品是否存在什么隐患？</li></ul><p>团队成员坐下来开会时，讨论这四个象限就够了。如果只用它作为会议概要，可以用更具体的文档来补充说明每个象限的详细情况。每个团队对 OKR 盘点会议要求的精确程度不一样。</p><p>不过会议还是越简短越好，要不然 OKR 盘点会议将变成团队成员现场刷存在感，事无巨细地列出一堆他们上周完成的事情。要信任团队，他们每天都做了正确的选择，要把会议的基调定在大家为了共同的目标相互支持与配合上。</p><p>做好会议的时间安排。建议周一会议时间的 1/4 用来讲述进展，其余时间一起讨论下一步计划。提前结束会议也很正常，因为没有必要为了凑时间而拖延会议</p><p>《OKR 工作法》这本书还特意提到了 Scrum 敏捷开发，我之前也记录了一些心得方便大家理解和参考</p><p>敏捷开发 Agile 中 Scrum 与 Kanban 的实践心得 - <a href="https://wsgzao.github.io/post/agile/">https://wsgzao.github.io/post/agile/</a></p><h2 id="OKR-实践心得"><a href="#OKR-实践心得" class="headerlink" title="OKR 实践心得"></a>OKR 实践心得</h2><blockquote><p>KPI 和 OKR 没有好坏之分，选择适合团队的应用场景才是硬道理</p></blockquote><ol><li>我们小组制定目标（Objective）一般按季度以 3 个月为周期，目标不宜过短，理解任务和目标的区别</li><li>目标（Objective）数量一般保持在 1-3，初期不宜过多建议只设定 1 个目标，目标的信心指数建议控制在 50%-70%</li><li>关键结果（Key Result）一定是和目标（Objective）相关且便于衡量，不要存在模糊不清的表述</li><li>确定好本周需要推进的事项，以及其优先级（如 P1/P2)，每周 (如周一) review 目标和关键结果</li><li>确定好未来 4 周需要推进的事项，同样需要设定优先级</li></ol><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://www.barretlee.com/blog/2019/05/16/book-reading-about-okr-working-methods/" target="_blank" rel="noopener">读《OKR 工作法》</a><br><a href="http://blog.devtang.com/2019/03/29/okr-exp-from-huawei/" target="_blank" rel="noopener">华为的 OKR 实践心得 - 读《绩效使能 - 超越 OKR》</a><br><a href="http://blog.devtang.com/2018/11/22/okr-introduction/" target="_blank" rel="noopener">OKR 工作法简介</a><br><a href="http://www.sohu.com/a/118995624_376476" target="_blank" rel="noopener">微软、IBM 纷纷取消绩效评估，如何做员工绩效管理 </a><br><a href="http://www.ruanyifeng.com/blog/2016/03/performance-management.html" target="_blank" rel="noopener">谷歌的绩效管理</a><br><a href="https://coolshell.cn/articles/17972.html" target="_blank" rel="noopener">我看绩效考核</a></p>]]></content>
    
    <summary type="html">
    
      OKR和KPI
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>Zabbix 常见问题整理</title>
    <link href="https://wsgzao.github.io/post/zabbix-faq/"/>
    <id>https://wsgzao.github.io/post/zabbix-faq/</id>
    <published>2019-07-11T06:59:49.000Z</published>
    <updated>2019-07-12T06:21:14.245Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>根据安装和使用 Zabbix 中遇到的常见报错提示，结合 Zabbix 官网和 Google 到的一些解决方案，简单做下分享</p><blockquote><p>Zabbix 常见问题整理</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 07 月 11 日 - 增加[Z3005] query failed: [1062] Duplicate entry 错误解决方案<br>2019 年 03 月 05 日 - 完善内容<br>2018 年 11 月 02 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/zabbix-faq/">https://wsgzao.github.io/post/zabbix-faq/</a></p><p><strong> 扩展阅读 </strong></p><p>Zabbix - <a href="https://www.zabbix.com/" target="_blank" rel="noopener">https://www.zabbix.com/</a></p><hr><h2 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h2><p>Frequently asked questions / Troubleshooting</p><p><a href="https://www.zabbix.org/wiki/Troubleshooting" target="_blank" rel="noopener">https://www.zabbix.org/wiki/Troubleshooting</a><br><a href="https://www.zabbix.com/documentation/current/manual/appendix/faq" target="_blank" rel="noopener">https://www.zabbix.com/documentation/current/manual/appendix/faq</a></p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><blockquote><p>常见错误建议先查看 log，常见的问题通常由权限，防火墙，数据库，参数错误，性能瓶颈等问题导致</p></blockquote><p>zabbix_get [7189]: Check access restrictions in Zabbix agent configuration<br>zabbix 的服务器端与客户端连接的主要工具就是 zabbix 里 bin 文件夹下的 zabbix_get 文件，这个命令只能在 zabbix 的 server 端使用</p><p>Assuming that agent dropped connection because of access permissions（由于访问权限导致 agent 连接失败）<br>问题实现：zabbix_server 和 zabbix_agent 在同一台机器，server 监听全网地址，agent 监听内网地址。导致上面的报错发生<br>解决方案：把 zabbix_agentd.conf 中 的 server 把 zabbix_server 的公网和内网地址都加行。然后 agent 就可以正常获取到值了</p><p>解决 zabbix 中文乱码问题</p><p>方法一：下载文泉驿字体<br>yum -y install wqy-microhei-fonts<br>cp /usr/share/fonts/wqy-microhei/wqy-microhei.ttc /usr/share/fonts/dejavu/DejaVuSans.ttf</p><p>方法二：从 Windows 中拷贝<br>cd /usr/share/zabbix/fonts<br>从 windows 拷贝 simhei.ttf 字体到当前目录<br>替换配置文件<br>vim /usr/share/zabbix/include/defines.inc.php<br>define(‘ZBX_GRAPH_FONT_NAME’,           ‘simhei’)</p><p>Zabbix 报 No route to host<br>原来是被客户端的防火墙档掉了，关闭客户端防火墙或者配置相应规则即可</p><p>No active checks on server: host [] not found<br>查看监控机上的 / tmp/zabbix_server.log，显示日志：<br>cannot send list of active checks to [192.168.0.1]: host [Zabbix server] not found<br>查看被监控机上的 / tmp/zabbix_agentd.log，显示日志：<br>No active checks on server: host [Zabbix server] not found<br>这是因为通过 zabbix dashboard 页面配置的被监控主机名跟被监控主机上 zabbix_agentd.conf 中配置的 Hostname 不一致。修改为一致的名字后，重启 zabbix_agentd 即可。</p><p>Zabbix alerter processes more than 75% busy<br>zabbix 服务器邮件进程繁忙导致的，一般是因为在设置动作的时候，间隔太短，在一些特殊情况下，产生大量告警，例如几万封邮件，服务器发邮件，邮件进程发挂了。<br>建议通过导流解决。改发邮件的脚本，将邮件的动作改为打印时间，如下，待邮件都释放完了，再改回来。</p><p>Zabbix discoverer processes more than 75% busy<br>配置了自动发现的任务。每个自动发现的任务都会在一定时间内占用一个自动发现的进程。而默认配置项为 1，所以报警<br>修改配置文件的 StartDiscoverers 选项<br>StartDiscoverers=10</p><p>Zabbix poller processes more than 75% busy<br>轮询的负载量高，网上大多数说法是增加启动的 StartPollers 进程数，个人建议分析自己的 items 监控项设置是否合理，templates 模板应用是否恰当。<br>调整 StartPollers 数量<br>StartPollers=500<br>StartPollersUnreachable=100</p><p>Zabbix housekeeper processes more than 75% busy<br>为了防止数据库持续增大，zabbix 有个自动删除历史数据的机制，就是 housekeeper，而 mysql 数据库删数据的时候，性能会降低，就会报这个错。建议禁用采取数据库分区表优化自动清理。<br>HousekeepingFrequency=0            #间隔时间</p><p>2816:20170725:174352.675 [file:dbconfig.c,line:652] zbx_mem_realloc(): out of memory (requested 162664 bytes)<br>2816:20170725:174352.675 [file:dbconfig.c,line:652] zbx_mem_realloc(): please increase CacheSize configuration parameter<br>提示内存溢出，需要调整 zabbix 服务器配置 zabbix_server.conf<br>CacheSize=8G</p><p>PHP Fatal error: Allowed memory size of 134217728 bytes exhausted (tried to allocate 11 bytes)<br>zabbix 某些页面无法打开，查看 php 日志发现，当访问这个页面是，报错内存不足，不清楚是否内存泄露，最简单的方法是调大 php 进程的可用内存，memory_limit 默认值为 128M<br>grep ‘memory_limit’ /etc/httpd/conf.d/zabbix.conf<br>        php_value memory_limit 512M</p><p>Too many processes on zabbix server<br>zabbix 服务器进程太多报警，默认超过 300 个进程就报警。感觉默认值太小了，zabbix 配置调优后，进程就 500 多个了，所以我把触发值改为 600.</p><p>Zabbix value cache working in low memory mode<br>zabbix 历史记录 cache 大小默认值较低，如果出现这个报错调高 ValueCacheSize 即可</p><p>查看日志发现 zabbix-server 取到了数据插入数据库的 event_recovery 表时失败。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix]# tailf zabbix_server.log</span><br><span class="line">  8807:20190711:192713.951 [Z3005] query failed: [1062] Duplicate entry &apos;153816&apos; for key &apos;PRIMARY&apos; [insert into event_recovery (eventid,r_eventid,correlationid,c_eventid,userid) values (153816,16845596,null,null,null);</span><br><span class="line">]</span><br><span class="line">  8809:20190711:192713.966 [Z3005] query failed: [1062] Duplicate entry &apos;150935&apos; for key &apos;PRIMARY&apos; [insert into event_recovery (eventid,r_eventid,correlationid,c_eventid,userid) values (150935,16845597,null,null,null),(150880,16845598,null,null,null);</span><br><span class="line">]</span><br><span class="line">  8809:20190711:192716.050 [Z3005] query failed: [1062] Duplicate entry &apos;153757&apos; for key &apos;PRIMARY&apos; [insert into event_recovery (eventid,r_eventid,correlationid,c_eventid,userid) values (153757,16845599,null,null,null),(153758,16845600,null,null,null),(153713,16845601,null,null,null);</span><br></pre></td></tr></table></figure></p><p>经查看表结构确定了该表只是记录了事件恢复的全部数据信息，与 user、correlation、events 表相关联。<br>所以备份 event_recovery 表并 truncate 删除重建 event_recovery<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@zabbix:~# mysqldump -zabbix -p&apos;zabbix&apos; zabbix event_recovery &gt; event_recovery.sql</span><br><span class="line">root@zabbix:~# mysql -uzabbix -p&apos;zabbix&apos;</span><br><span class="line">mysql&gt; use zabbix</span><br><span class="line">mysql&gt; truncate table event_recovery;</span><br><span class="line">mysql&gt; optimize table event_recovery;</span><br></pre></td></tr></table></figure></p><h2 id="zabbix-server-conf-中英文解释"><a href="#zabbix-server-conf-中英文解释" class="headerlink" title="zabbix_server.conf 中英文解释"></a>zabbix_server.conf 中英文解释</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is a configuration file for Zabbix server daemon</span></span><br><span class="line"><span class="comment"># To get more information about Zabbix, visit http://www.zabbix.com</span></span><br><span class="line"><span class="comment">############ GENERAL PARAMETERS #################</span></span><br><span class="line"><span class="comment">### Option: ListenPort</span></span><br><span class="line"><span class="comment">#   Listen port for trapper.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1024-32767</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明: 服务端监听端口用于接收二级代理或直连 AGENT 的采集数据 </span></span><br><span class="line"><span class="comment"># ListenPort=10051</span></span><br><span class="line"><span class="comment">### Option: SourceIP</span></span><br><span class="line"><span class="comment">#   Source IP address for outgoing connections.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：服务端监听 IP，建议指定</span></span><br><span class="line"><span class="comment"># SourceIP=</span></span><br><span class="line"><span class="comment">### Option: LogType</span></span><br><span class="line"><span class="comment">#   Specifies where log messages are written to:</span></span><br><span class="line"><span class="comment">#       system  - syslog</span></span><br><span class="line"><span class="comment">#       file    - file specified with LogFile parameter</span></span><br><span class="line"><span class="comment">#       console - standard output</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># LogType=file</span></span><br><span class="line"><span class="comment">### Option: LogFile</span></span><br><span class="line"><span class="comment">#   Log file name for LogType 'file' parameter.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># LogFile=</span></span><br><span class="line"><span class="comment"># 说明：zabbix 服务端日志路径，视具体情况指定</span></span><br><span class="line">LogFile=/tmp/zabbix_server.log</span><br><span class="line"><span class="comment">### Option: LogFileSize</span></span><br><span class="line"><span class="comment">#   Maximum size of log file in MB.</span></span><br><span class="line"><span class="comment">#   0 - disable automatic log rotation.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-1024</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：日志达到多少 M 里就轮转；若此参数值为 0 时，则不轮转，日志将不断变大，建议设置成轮转</span></span><br><span class="line">LogFileSize=50</span><br><span class="line"><span class="comment">### Option: DebugLevel</span></span><br><span class="line"><span class="comment">#   Specifies debug level:</span></span><br><span class="line"><span class="comment">#   0 - basic information about starting and stopping of Zabbix processes</span></span><br><span class="line"><span class="comment">#   1 - critical information  灾难日志，日志量较少</span></span><br><span class="line"><span class="comment">#   2 - error information  错误级别，日志量大于 CRITICAL 级别</span></span><br><span class="line"><span class="comment">#   3 - warnings    告警级别，日志量大于 ERROR 级别</span></span><br><span class="line"><span class="comment">#   4 - for debugging (produces lots of information) 调试级别，日志量大于 WARNING</span></span><br><span class="line"><span class="comment">#   5 - extended debugging (produces even more information)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-5</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：日志级别 0~4，单位时间内生成日志的量不断增大</span></span><br><span class="line">DebugLevel=3</span><br><span class="line"><span class="comment">### Option: PidFile</span></span><br><span class="line"><span class="comment">#   Name of PID file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：zabbix 服务端程序 PID 路径</span></span><br><span class="line">PidFile=/tmp/zabbix_server.pid</span><br><span class="line"><span class="comment">### Option: DBHost</span></span><br><span class="line"><span class="comment">#   Database host name.</span></span><br><span class="line"><span class="comment">#   If set to localhost, socket is used for MySQL.</span></span><br><span class="line"><span class="comment">#   If set to empty string, socket is used for PostgreSQL.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：指定数据库信息，对于 mysql，若设置为 localhost 则 mysql 用 SOCKET 来连接(需配合参数 DBSocket 使用)，否则用 IP 连接；若 DHHOST 值为空，则默认连接 PostgreSQL</span></span><br><span class="line"><span class="comment"># DBHost=localhost</span></span><br><span class="line">DBHost=</span><br><span class="line"><span class="comment">### Option: DBName</span></span><br><span class="line"><span class="comment">#   Database name.</span></span><br><span class="line"><span class="comment">#   For SQLite3 path to database file must be provided. DBUser and DBPassword are ignored.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: yes</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># DBName=</span></span><br><span class="line"><span class="comment"># 说明：服务端连接数据库的库名</span></span><br><span class="line">DBName=</span><br><span class="line"><span class="comment">### Option: DBSchema</span></span><br><span class="line"><span class="comment">#   Schema name. Used for IBM DB2 and PostgreSQL.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：专门用于 IBM DB2 数据库的连接信息</span></span><br><span class="line"><span class="comment"># DBSchema=</span></span><br><span class="line"><span class="comment">### Option: DBUser</span></span><br><span class="line"><span class="comment">#   Database user. Ignored for SQLite.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：连接数据库的用户</span></span><br><span class="line"><span class="comment"># DBUser=</span></span><br><span class="line">DBUser=</span><br><span class="line"><span class="comment">### Option: DBPassword</span></span><br><span class="line"><span class="comment">#   Database password. Ignored for SQLite.</span></span><br><span class="line"><span class="comment">#   Comment this line if no password is used.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：连接数据库的密码</span></span><br><span class="line">DBPassword=</span><br><span class="line"><span class="comment">### Option: DBSocket</span></span><br><span class="line"><span class="comment">#   Path to MySQL socket.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：指定 MYSQL 的 SOCK 连接路径</span></span><br><span class="line">DBSocket=/tmp/mysql.sock</span><br><span class="line"><span class="comment">### Option: DBPort</span></span><br><span class="line"><span class="comment">#   Database port when not using local socket. Ignored for SQLite.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1024-65535</span></span><br><span class="line"><span class="comment"># Default (for MySQL):</span></span><br><span class="line"><span class="comment"># 说明：指定连接数据库的端口，默认 3306</span></span><br><span class="line">DBPort=3306</span><br><span class="line"><span class="comment">############ ADVANCED PARAMETERS ################</span></span><br><span class="line"><span class="comment"># 高级参数</span></span><br><span class="line"><span class="comment">### Option: StartPollers</span></span><br><span class="line"><span class="comment">#   Number of pre-forked instances of pollers.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-1000</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明; 初始化时，启动子进程数量，数量越多，则服务端吞吐能力越强，对系统资源消耗越大</span></span><br><span class="line">StartPollers=300</span><br><span class="line"><span class="comment">### Option: StartIPMIPollers</span></span><br><span class="line"><span class="comment">#   Number of pre-forked instances of IPMI pollers.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-1000</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 说明: 主要用于 IPmi 技术用于获取硬件状态场景。若无相关监控项，建议设置为 0</span></span><br><span class="line"><span class="comment"># StartIPMIPollers=0</span></span><br><span class="line"><span class="comment">### Option: StartPollersUnreachable</span></span><br><span class="line"><span class="comment">#   Number of pre-forked instances of pollers for unreachable hosts (including IPMI and Java).</span></span><br><span class="line"><span class="comment">#   At least one poller for unreachable hosts must be running if regular, IPMI or Java pollers</span></span><br><span class="line"><span class="comment">#   are started.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-1000</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：默认情况下，ZABBIX 会启用指定进程用于探测某些不可达主机的（含 IPMI 场景）；若使用场景中含有代理端，建议保持默认；若直接 agent 较多，可视具体情况调整</span></span><br><span class="line">StartPollersUnreachable=50</span><br><span class="line"><span class="comment">### Option: StartTrappers</span></span><br><span class="line"><span class="comment">#   Number of pre-forked instances of trappers.</span></span><br><span class="line"><span class="comment">#   Trappers accept incoming connections from Zabbix sender, active agents and active proxies.</span></span><br><span class="line"><span class="comment">#   At least one trapper process must be running to display server availability and view queue</span></span><br><span class="line"><span class="comment">#   in the frontend.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-1000</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：用于设置诸如 SNMP STRAPPER 场景提交来的数据的接收进程数，若客户机 SNMP TRAPPER 技术较多，建议加大此参数值</span></span><br><span class="line">StartTrappers=50</span><br><span class="line"><span class="comment">### Option: StartPingers</span></span><br><span class="line"><span class="comment">#   Number of pre-forked instances of ICMP pingers.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-1000</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：用于设置启用 icmp 协议 PING 主机方式启动线程数量，若单台代理所管理机器超过 500 台，建议加大此数值</span></span><br><span class="line"><span class="comment"># StartPingers=10</span></span><br><span class="line"><span class="comment">### Option: StartDiscoverers</span></span><br><span class="line"><span class="comment">#   Number of pre-forked instances of discoverers.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-250</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：用于设置自动发现主机的线程数量，若单台代理所管理机器超过 500 台，可以考虑加大此数值（仅适用于直接 AGENT 场景）</span></span><br><span class="line">StartDiscoverers=15</span><br><span class="line"><span class="comment">### Option: StartHTTPPollers</span></span><br><span class="line"><span class="comment">#   Number of pre-forked instances of HTTP pollers.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-1000</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：用于设置 WEB 拨测监控线程数，可视具体情况增加或减少此数值。</span></span><br><span class="line"><span class="comment"># StartHTTPPollers=1</span></span><br><span class="line"><span class="comment">### Option: StartTimers</span></span><br><span class="line"><span class="comment">#   Number of pre-forked instances of timers.</span></span><br><span class="line"><span class="comment">#   Timers process time-based trigger functions and maintenance periods.</span></span><br><span class="line"><span class="comment">#   Only the first timer process handles the maintenance periods.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1-1000</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：各实例计时器数量，主要用于触发器，标有维护标识的主机，但只第一个计时器用于计算维护标识主机。</span></span><br><span class="line"><span class="comment"># StartTimers=1</span></span><br><span class="line"><span class="comment">### Option: StartEscalators</span></span><br><span class="line"><span class="comment">#   Number of pre-forked instances of escalators.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-100</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：用于处理动作中的步骤的进程，zabbix 动作较多时建议调大。</span></span><br><span class="line">StartEscalators=30</span><br><span class="line"><span class="comment">### Option: JavaGateway</span></span><br><span class="line"><span class="comment">#   IP address (or hostname) of Zabbix Java gateway.</span></span><br><span class="line"><span class="comment">#   Only required if Java pollers are started.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：JAVAGATEWAY 场景下使用</span></span><br><span class="line">JavaGateway=10.238.0.180</span><br><span class="line"><span class="comment">### Option: JavaGatewayPort</span></span><br><span class="line"><span class="comment">#   Port that Zabbix Java gateway listens on.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1024-32767</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：JAVAGATEWAY 场景下使用</span></span><br><span class="line">JavaGatewayPort=10052</span><br><span class="line"><span class="comment">### Option: StartJavaPollers</span></span><br><span class="line"><span class="comment">#   Number of pre-forked instances of Java pollers.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-1000</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：JAVAGATEWAY 场景下使用</span></span><br><span class="line">StartJavaPollers=30</span><br><span class="line"><span class="comment">### Option: StartVMwareCollectors</span></span><br><span class="line"><span class="comment">#   Number of pre-forked vmware collector instances.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-250</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：用于设置监控 VMWARE Esxi 主机实例时使用，若为 0 则不启用，若要监控 ESXI 主机，此值最少为 1 ；视监控 ESXI 数量设置对应数值</span></span><br><span class="line"><span class="comment"># StartVMwareCollectors=0</span></span><br><span class="line"><span class="comment">### Option: VMwareFrequency</span></span><br><span class="line"><span class="comment">#   How often Zabbix will connect to VMware service to obtain a new data.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 10-86400</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：代理端访问 VMWARE service 的频率，单位: 秒</span></span><br><span class="line"><span class="comment"># VMwareFrequency=60</span></span><br><span class="line"><span class="comment">### Option: VMwarePerfFrequency</span></span><br><span class="line"><span class="comment">#   How often Zabbix will connect to VMware service to obtain performance data.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 10-86400</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># VMwarePerfFrequency=60</span></span><br><span class="line"><span class="comment">### Option: VMwareCacheSize</span></span><br><span class="line"><span class="comment">#   Size of VMware cache, in bytes.</span></span><br><span class="line"><span class="comment">#   Shared memory size for storing VMware data.</span></span><br><span class="line"><span class="comment">#   Only used if VMware collectors are started.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 256K-2G</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：划出多少共享内存用于存储 VMWARE 数据</span></span><br><span class="line">VMwareCacheSize=256M</span><br><span class="line"><span class="comment">### Option: VMwareTimeout</span></span><br><span class="line"><span class="comment">#   Specifies how many seconds vmware collector waits for response from VMware service.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1-300</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：等待 VMWare 返回数据的最长时间</span></span><br><span class="line">VMwareTimeout=10</span><br><span class="line"><span class="comment">### Option: SNMPTrapperFile</span></span><br><span class="line"><span class="comment">#   Temporary file used for passing data from SNMP trap daemon to the server.</span></span><br><span class="line"><span class="comment">#   Must be the same as in zabbix_trap_receiver.pl or SNMPTT configuration file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：指定 SNMP TRAPPER 时的临时文件，用于代理端启用 SNMP TRAPPER 功能时使用</span></span><br><span class="line"><span class="comment"># SNMPTrapperFile=/tmp/zabbix_traps.tmp</span></span><br><span class="line"><span class="comment">### Option: StartSNMPTrapper</span></span><br><span class="line"><span class="comment">#   If 1, SNMP trapper process is started.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-1</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：是否启用 snmptrapper 功能 ，默认不启用 = 0，启用 = 1（配合参数 SNMPTrapperFile 使用）</span></span><br><span class="line"><span class="comment"># StartSNMPTrapper=0</span></span><br><span class="line"><span class="comment">### Option: ListenIP</span></span><br><span class="line"><span class="comment">#   List of comma delimited IP addresses that the trapper should listen on.</span></span><br><span class="line"><span class="comment">#   Trapper will listen on all network interfaces if this parameter is missing.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：启用 SNMPTRAPPER 里 ，接收端监听的 IP，此参数与 StartSNMPTrapper，SNMPTrapperFile 联合使用</span></span><br><span class="line"><span class="comment"># ListenIP=0.0.0.0</span></span><br><span class="line">ListenIP=10.238.0.180</span><br><span class="line"><span class="comment">### Option: HousekeepingFrequency</span></span><br><span class="line"><span class="comment">#   How often Zabbix will perform housekeeping procedure (in hours).</span></span><br><span class="line"><span class="comment">#   Housekeeping is removing outdated information from the database.</span></span><br><span class="line"><span class="comment">#   To prevent Housekeeper from being overloaded, no more than 4 times HousekeepingFrequency</span></span><br><span class="line"><span class="comment">#   hours of outdated information are deleted in one housekeeping cycle, for each item.</span></span><br><span class="line"><span class="comment">#   To lower load on server startup housekeeping is postponed for 30 minutes after server start.</span></span><br><span class="line"><span class="comment">#   With HousekeepingFrequency=0 the housekeeper can be only executed using the runtime control option.</span></span><br><span class="line"><span class="comment">#   In this case the period of outdated information deleted in one housekeeping cycle is 4 times the</span></span><br><span class="line"><span class="comment">#   period since the last housekeeping cycle, but not less than 4 hours and not greater than 4 days.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-24</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：多少小时清理一次代理端数据库的 history, alert, and alarms，以保持代理端数据库轻便，建议保持默认</span></span><br><span class="line">HousekeepingFrequency=24</span><br><span class="line"><span class="comment">### Option: MaxHousekeeperDelete</span></span><br><span class="line"><span class="comment">#   The table "housekeeper" contains "tasks" for housekeeping procedure in the format:</span></span><br><span class="line"><span class="comment">#   [housekeeperid], [tablename], [field], [value].</span></span><br><span class="line"><span class="comment">#   No more than 'MaxHousekeeperDelete' rows (corresponding to [tablename], [field], [value])</span></span><br><span class="line"><span class="comment">#   will be deleted per one task in one housekeeping cycle.</span></span><br><span class="line"><span class="comment">#   SQLite3 does not use this parameter, deletes all corresponding rows without a limit.</span></span><br><span class="line"><span class="comment">#   If set to 0 then no limit is used at all. In this case you must know what you are doing!</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-1000000</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明: 每个 HouseKeeper 任务删除的最大记录数，1.8.2 开始支持</span></span><br><span class="line">MaxHousekeeperDelete=1000000</span><br><span class="line"><span class="comment">### Option: SenderFrequency</span></span><br><span class="line"><span class="comment">#   How often Zabbix will try to send unsent alerts (in seconds).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 5-3600</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明: 多少秒后重试发送失败的报警信息</span></span><br><span class="line">SenderFrequency=30</span><br><span class="line"><span class="comment">### Option: CacheSize</span></span><br><span class="line"><span class="comment">#   Size of configuration cache, in bytes.</span></span><br><span class="line"><span class="comment">#   Shared memory size for storing host, item and trigger data.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 128K-8G</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明; zabbix 初始化时占用多少系统共享内存用于存储配置信息，HOST,ITEM,TRIGGER 数据，视监控主机数量和监控项调整，建议调整到 32M 或者更大</span></span><br><span class="line">CacheSize=8G</span><br><span class="line"><span class="comment">### Option: CacheUpdateFrequency</span></span><br><span class="line"><span class="comment">#   How often Zabbix will perform update of configuration cache, in seconds.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1-3600</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：zabbix 更新操作系统 CACHE 频率，若管理页面操作不频繁，可以考虑加大参数值</span></span><br><span class="line">CacheUpdateFrequency=300</span><br><span class="line"><span class="comment">### Option: StartDBSyncers</span></span><br><span class="line"><span class="comment">#   Number of pre-forked instances of DB Syncers.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1-100</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明: 将采集数据从 CACHE 同步到数据库线程数量，视数据库服务器 I/O 繁忙情况，和数据库写能力调整。数值越大，写能力越强。对数据库服务器 I/O 压力越大。</span></span><br><span class="line">StartDBSyncers=20</span><br><span class="line"><span class="comment">### Option: HistoryCacheSize</span></span><br><span class="line"><span class="comment">#   Size of history cache, in bytes.</span></span><br><span class="line"><span class="comment">#   Shared memory size for storing history data.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 128K-2G</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：用于设置划分多少系统共享内存用于存储采集的历史数据，此数值越大，数据库读压力越小</span></span><br><span class="line">HistoryCacheSize=2048M</span><br><span class="line"><span class="comment">### Option: HistoryIndexCacheSize</span></span><br><span class="line"><span class="comment">#   Size of history index cache, in bytes.</span></span><br><span class="line"><span class="comment">#   Shared memory size for indexing history cache.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 128K-2G</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：3.0.0 开始支持，历史索引大小，一个监控项需要 100bytes 来存储</span></span><br><span class="line">HistoryIndexCacheSize=2048M</span><br><span class="line"><span class="comment">### Option: TrendCacheSize</span></span><br><span class="line"><span class="comment">#   Size of trend cache, in bytes.</span></span><br><span class="line"><span class="comment">#   Shared memory size for storing trends data.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 128K-2G</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：用于设置划分多少系统共享内存用于存储计算出来的趋势数据，此参数值从一定程度上可影响数据库读压力</span></span><br><span class="line">TrendCacheSize=512M</span><br><span class="line"><span class="comment">### Option: ValueCacheSize</span></span><br><span class="line"><span class="comment">#   Size of history value cache, in bytes.</span></span><br><span class="line"><span class="comment">#   Shared memory size for caching item history data requests.</span></span><br><span class="line"><span class="comment">#   Setting to 0 disables value cache.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0,128K-64G</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：划出系统多少共享内存用于已请求的存储监控项信息，若监控项较多，建议加大此数值</span></span><br><span class="line">ValueCacheSize=16G</span><br><span class="line"><span class="comment">### Option: Timeout</span></span><br><span class="line"><span class="comment">#   Specifies how long we wait for agent, SNMP device or external check (in seconds).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1-30</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># Timeout=3</span></span><br><span class="line"><span class="comment"># 说明：与 AGNET\SNMP 设备和其它外部设备通信超时设置，单位为秒；若采集数据不完整或网络繁忙，或从管理页面发现客户端状态变化频繁，可以考虑加大此数值。注意若此数值加大，应该考虑参数 StartPollers 是否有相应加大的必要。</span></span><br><span class="line">Timeout=10</span><br><span class="line"><span class="comment">### Option: TrapperTimeout</span></span><br><span class="line"><span class="comment">#   Specifies how many seconds trapper may spend processing new data.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1-300</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：启用 trapper 功能，用于进程等待超时设置。根据需要调整</span></span><br><span class="line">TrapperTimeout=50</span><br><span class="line"><span class="comment">### Option: UnreachablePeriod</span></span><br><span class="line"><span class="comment">#   After how many seconds of unreachability treat a host as unavailable.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1-3600</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：当 AGNET 端处于不可用状态下，间隔多少秒后，尝试重新连接。建议根据具体情况设置。注意，若此数值过小，右 agent 端业务系统繁忙时，有可能造成报警信息误报</span></span><br><span class="line"><span class="comment"># UnreachablePeriod=45</span></span><br><span class="line"><span class="comment">### Option: UnavailableDelay</span></span><br><span class="line"><span class="comment">#   How often host is checked for availability during the unavailability period, in seconds.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1-3600</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明: 当 AGENT 端处于可用状态下，间隔多少秒后，进行状态检查。若出现可正常采集数据，但管理页面 AGENT 状态不正常；若在网络，端口等均通畅情况下，AGENT 状态仍不正常，可以考虑加大此数值</span></span><br><span class="line"><span class="comment"># UnavailableDelay=60</span></span><br><span class="line"><span class="comment">### Option: UnreachableDelay</span></span><br><span class="line"><span class="comment">#   How often host is checked for availability during the unreachability period, in seconds.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1-3600</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：当 agent 端处于不可达状态下，延迟多少秒后，进行重新尝试，建议保持默认，在 AGENT 接入调试阶段，可考虑减少此数值</span></span><br><span class="line"><span class="comment"># UnreachableDelay=15</span></span><br><span class="line"><span class="comment">### Option: AlertScriptsPath</span></span><br><span class="line"><span class="comment">#   Full path to location of custom alert scripts.</span></span><br><span class="line"><span class="comment">#   Default depends on compilation options.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：监控报警脚本路径，非研发人员不建议修改此参数值</span></span><br><span class="line"><span class="comment"># AlertScriptsPath=$&#123;datadir&#125;/zabbix/alertscripts</span></span><br><span class="line">AlertScriptsPath=/home/zabbix/bin</span><br><span class="line"><span class="comment">### Option: ExternalScripts</span></span><br><span class="line"><span class="comment">#   Full path to location of external scripts.</span></span><br><span class="line"><span class="comment">#   Default depends on compilation options.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：自定义脚本存储路径，非研发人员不建议修改此参数值</span></span><br><span class="line"><span class="comment"># ExternalScripts=$&#123;datadir&#125;/zabbix/externalscripts</span></span><br><span class="line"><span class="comment">### Option: FpingLocation</span></span><br><span class="line"><span class="comment">#   Location of fping.</span></span><br><span class="line"><span class="comment">#   Make sure that fping binary has root ownership and SUID flag set.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：IPv4 FPING 命令路径，仅 ROOT 可用。注意使用此命令时，应该确认此命令是否存在</span></span><br><span class="line">FpingLocation=/usr/sbin/fping</span><br><span class="line"><span class="comment">### Option: Fping6Location</span></span><br><span class="line"><span class="comment">#   Location of fping6.</span></span><br><span class="line"><span class="comment">#   Make sure that fping6 binary has root ownership and SUID flag set.</span></span><br><span class="line"><span class="comment">#   Make empty if your fping utility is capable to process IPv6 addresses.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：IPv6 FPING 命令路径，仅 ROOT 可用。注意使用此命令时，应该确认此命令是否存在</span></span><br><span class="line"><span class="comment"># Fping6Location=/usr/sbin/fping6</span></span><br><span class="line"><span class="comment">### Option: SSHKeyLocation</span></span><br><span class="line"><span class="comment">#   Location of public and private keys for SSH checks and actions.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：在服务端需要 SSH 到 AGENT 端且采用用 KEY 验证方式时使用。非研发人员，不建议修改或设置</span></span><br><span class="line"><span class="comment"># SSHKeyLocation=</span></span><br><span class="line"><span class="comment">### Option: LogSlowQueries</span></span><br><span class="line"><span class="comment">#   How long a database query may take before being logged (in milliseconds).</span></span><br><span class="line"><span class="comment">#   Only works if DebugLevel set to 3, 4 or 5.</span></span><br><span class="line"><span class="comment">#   0 - don't log slow queries.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1-3600000</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明: 用于服务端数据库慢查询功能，单位是毫秒；1 毫秒 = 0.001 秒，若有服务端数据库监控慢查询的需求，可以视具体情况调整此数。</span></span><br><span class="line"><span class="comment"># LogSlowQueries=0</span></span><br><span class="line">LogSlowQueries=3000</span><br><span class="line"><span class="comment">### Option: TmpDir</span></span><br><span class="line"><span class="comment">#   Temporary directory.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：zabbix 服务端工作的临时目录</span></span><br><span class="line"><span class="comment"># TmpDir=/tmp</span></span><br><span class="line"><span class="comment">### Option: StartProxyPollers</span></span><br><span class="line"><span class="comment">#   Number of pre-forked instances of pollers for passive proxies.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-250</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明: 启用多少子进程与代理端通信，若代理端较多可考虑加大此数值</span></span><br><span class="line"><span class="comment"># StartProxyPollers=1</span></span><br><span class="line"><span class="comment">### Option: ProxyConfigFrequency</span></span><br><span class="line"><span class="comment">#   How often Zabbix Server sends configuration data to a Zabbix Proxy in seconds.</span></span><br><span class="line"><span class="comment">#   This parameter is used only for proxies in the passive mode.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1-3600*24*7</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：zabbix 服务端将配置文件数据同步到代理端的频率，仅适用于代理端为被动模式情况下</span></span><br><span class="line"><span class="comment"># ProxyConfigFrequency=3600</span></span><br><span class="line"><span class="comment">### Option: ProxyDataFrequency</span></span><br><span class="line"><span class="comment">#   How often Zabbix Server requests history data from a Zabbix Proxy in seconds.</span></span><br><span class="line"><span class="comment">#   This parameter is used only for proxies in the passive mode.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1-3600</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：zabbix 服务端请求代理端采集的数据的频率，仅适用代理端为被动模式情况下</span></span><br><span class="line"><span class="comment"># ProxyDataFrequency=1</span></span><br><span class="line"><span class="comment">### Option: AllowRoot</span></span><br><span class="line"><span class="comment">#   Allow the server to run as'root'. If disabled and the server is started by'root', the server</span></span><br><span class="line"><span class="comment">#   will try to switch to the user specified by the User configuration option instead.</span></span><br><span class="line"><span class="comment">#   Has no effect if started under a regular user.</span></span><br><span class="line"><span class="comment">#   0 - do not allow 不允许</span></span><br><span class="line"><span class="comment">#   1 - allow 允许</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：是否允许以 root 身份运行服务端</span></span><br><span class="line">AllowRoot=1</span><br><span class="line"><span class="comment">### Option: User</span></span><br><span class="line"><span class="comment">#   Drop privileges to a specific, existing user on the system.</span></span><br><span class="line"><span class="comment">#   Only has effect if run as'root'and AllowRoot is disabled.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：非 root 运行的账号</span></span><br><span class="line"><span class="comment"># User=zabbix</span></span><br><span class="line"><span class="comment">### Option: Include</span></span><br><span class="line"><span class="comment">#   You may include individual files or all files in a directory in the configuration file.</span></span><br><span class="line"><span class="comment">#   Installing Zabbix will create include directory in /usr/local/etc, unless modified during the compile time.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：在一些情况下，软件的参数配置文件很长，为了方便管理，将配置文件切割成 N 个配置文件，但为了主配置参数文件的简洁，便会启用 INCLUDE 参数，以方便程序读取指定目录下的所有配置文件</span></span><br><span class="line"><span class="comment"># Include=</span></span><br><span class="line"><span class="comment"># Include=/usr/local/etc/zabbix_server.general.conf</span></span><br><span class="line"><span class="comment"># Include=/usr/local/etc/zabbix_server.conf.d/</span></span><br><span class="line"><span class="comment"># Include=/usr/local/etc/zabbix_server.conf.d/*.conf</span></span><br><span class="line"><span class="comment">### Option: SSLCertLocation</span></span><br><span class="line"><span class="comment">#   Location of SSL client certificates.</span></span><br><span class="line"><span class="comment">#   This parameter is used only in web monitoring.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：SSL 客户端认证文件，2.4 开始支持</span></span><br><span class="line"><span class="comment"># SSLCertLocation=$&#123;datadir&#125;/zabbix/ssl/certs</span></span><br><span class="line"><span class="comment">### Option: SSLKeyLocation</span></span><br><span class="line"><span class="comment">#   Location of private keys for SSL client certificates.</span></span><br><span class="line"><span class="comment">#   This parameter is used only in web monitoring.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：SSL 私钥文件目录，2.4 开始支持</span></span><br><span class="line"><span class="comment"># SSLKeyLocation=$&#123;datadir&#125;/zabbix/ssl/keys</span></span><br><span class="line"><span class="comment">### Option: SSLCALocation</span></span><br><span class="line"><span class="comment">#   Override the location of certificate authority (CA) files for SSL server certificate verification.</span></span><br><span class="line"><span class="comment">#   If not set, system-wide directory will be used.</span></span><br><span class="line"><span class="comment">#   This parameter is used only in web monitoring and SMTP authentication.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：SSL CA 钥文件目录，2.4 开始支持</span></span><br><span class="line"><span class="comment"># SSLCALocation=</span></span><br><span class="line"><span class="comment">####### LOADABLE MODULES #######</span></span><br><span class="line"><span class="comment"># 可加载的模块</span></span><br><span class="line"><span class="comment">### Option: LoadModulePath</span></span><br><span class="line"><span class="comment">#   Full path to location of server modules.</span></span><br><span class="line"><span class="comment">#   Default depends on compilation options.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 指定本地模块路径，非研发人员不建议修改</span></span><br><span class="line"><span class="comment"># LoadModulePath=$&#123;libdir&#125;/modules</span></span><br><span class="line"><span class="comment">### Option: LoadModule</span></span><br><span class="line"><span class="comment">#   Module to load at server startup. Modules are used to extend functionality of the server.</span></span><br><span class="line"><span class="comment">#   Format: LoadModule=&lt;module.so&gt;</span></span><br><span class="line"><span class="comment">#   The modules must be located in directory specified by LoadModulePath.</span></span><br><span class="line"><span class="comment">#   It is allowed to include multiple LoadModule parameters.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 指定本地模块路径，非研发人员不建议修改</span></span><br><span class="line"><span class="comment"># LoadModule=</span></span><br><span class="line"><span class="comment">####### TLS-RELATED PARAMETERS #######</span></span><br><span class="line"><span class="comment">#TLS 相关参数</span></span><br><span class="line"><span class="comment">### Option: TLSCAFile</span></span><br><span class="line"><span class="comment">#   Full pathname of a file containing the top-level CA(s) certificates for</span></span><br><span class="line"><span class="comment">#   peer certificate verification.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：TLS 证书文件</span></span><br><span class="line"><span class="comment"># TLSCAFile=</span></span><br><span class="line"><span class="comment">### Option: TLSCRLFile</span></span><br><span class="line"><span class="comment">#   Full pathname of a file containing revoked certificates.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：TLS 证书文件</span></span><br><span class="line"><span class="comment"># TLSCRLFile=</span></span><br><span class="line"><span class="comment">### Option: TLSCertFile</span></span><br><span class="line"><span class="comment">#   Full pathname of a file containing the server certificate or certificate chain.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：TLS 证书文件</span></span><br><span class="line"><span class="comment"># TLSCertFile=</span></span><br><span class="line"><span class="comment">### Option: TLSKeyFile</span></span><br><span class="line"><span class="comment">#   Full pathname of a file containing the server private key.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：TLS 证书文件</span></span><br><span class="line"><span class="comment"># TLSKeyFile=</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      Zabbix常见问题整理
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>RPS 和 RFS 网卡多队列性能调优实践</title>
    <link href="https://wsgzao.github.io/post/rps/"/>
    <id>https://wsgzao.github.io/post/rps/</id>
    <published>2019-07-03T06:59:49.000Z</published>
    <updated>2019-07-05T12:03:24.286Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>为了解决 LVS ksoftirqd CPU 使用率 100% 导致网卡软中断丢包，我和同事们一起搜索了大量的资料去分析问题，特别是感谢美团技术团队的分享帮助我们快速梳理优化思路，最后明确了如何重构 RPS 和 RFS 网卡多队列的优化脚本。个人认为这是一个大家可能普遍会遇到的问题，文章内的分析思路和解决方案未必是最优解，也欢迎各位分享自己的解决方法。</p><blockquote><p>RPS 和 RFS 网卡多队列性能调优实践</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 07 月 03 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/rps/">https://wsgzao.github.io/post/rps/</a></p><p><strong> 扩展阅读 </strong></p><p>Redis 高负载下的中断优化 - <a href="https://tech.meituan.com/2018/03/16/redis-high-concurrency-optimization.html" target="_blank" rel="noopener">https://tech.meituan.com/2018/03/16/redis-high-concurrency-optimization.html</a></p><hr><h2 id="事故复盘"><a href="#事故复盘" class="headerlink" title="事故复盘"></a>事故复盘</h2><p>我们遇到的问题属于计划外的 incident，现象是某产品用户在线率突然降低，LVS Master 同时收到 CPU High Load 告警，检查发现该节点出现网卡大量断开重连和丢包情况，应急切换到 LVS Slave 也出现上述问题，在排除掉流量异常和外部攻击后选择切换 DNS 到背后的 Nginx Real Servers 后服务逐步恢复。</p><p>复盘核心原因在于系统初始化时 rps 优化脚本没有成功执行，这个脚本起初是因为早期 DBA 团队遇到过 CPU 负载较高导致网卡异常，这个优化脚本也一直传承至今，却已经没有人知道为什么添加。现在大多数服务器没有执行成功而被大家一直所忽视显然也是 post check 没有做到位。在早期大家都停留在 Bash Shell 运维的阶段，没有专职的团队来管理确实容易失控，好在现在可以基于 Ansible 来做初始化和检查，运维的压力也减轻了一部分。</p><p>通过 Google 搜索相关知识的过程中，我们也发现在不少人都会遇到这样类似的问题。比如这篇文章提到 <a href="http://xstarcd.github.io/wiki/sysadmin/lvs_irq.html" target="_blank" rel="noopener">lvs/irq</a></p><p><a href="http://zh.linuxvirtualserver.org/node/2500" title="http://zh.linuxvirtualserver.org/node/2500" target="_blank" rel="noopener">lvs 的性能问题，软中断耗尽 CPU 单核后到达处理极限</a></p><ul><li>瓶颈现象：当压力较大时，Lvs 服务器 CPU 的其中一个核使用率达到 100%（处理软中断）。<ul><li>当 Lvs 服务器处理软中断的那个核使用率达到 100%，就到达系统处理上限。</li><li>占用 CPU 的是进程 “ksoftirqd”，它未能使用到多核。</li></ul></li><li>做双网卡绑定，然后调试内核 SMP，中断主要是来自网卡的，不是 LVS 本身。需要把 2 个网卡来的 IRQ 均衡在双核 CPU 上面。</li></ul><p>和华为的工程师们在交换经验的时候对方分享了一个关于 RSS 和 RPS 关系图，之后的内容还会引用美团技术团队的分析<br><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190704111554.jpg" alt=""></p><p>我们遇到的情况是缺少可用服务器资源选择把用户外部请求流量和 Codis Cache Cluster 内部流量临时混在了同一个 LVS 上，虽然看上去 CPU 和 traffic 的整体压力都不算高，但是 CPU 的处理压力可能恰好集中在了和外网 Bond1 网卡相同的 Core 上最后引起了 ksoftirqd 软中断，而内网 Bond0 网卡就没有监控到任何丢包。虽然我们也有正常开启 <code>irqbalance</code>，但不清楚是不是因为受到 <code>cpupower performance</code> 和 <code>NUMA</code> 的影响最后也没能阻止事故的发生，最终的优化方案主要是手动开启 RPS 和 RFS，大致步骤如下：</p><ol><li>set cpupower <code>cpupower frequency-set -g performance</code>，<a href="https://wsgzao.github.io/post/cpupower/">CPU 优化建议使用 cpupower 设置 CPU Performance 模式</a></li><li>activate rps/rfs by script: <a href="https://gist.github.com/wsgzao/18828f69147635f3e38a14690a633daf" target="_blank" rel="noopener">rps.sh</a></li><li>double ring buffer size: <code>ethtool -G p1p1 [rx|tx] 4096</code>, check <code>ethtool -g p1p1</code></li><li>double NAPI poll budget: <code>sysctl -w net.core.netdev_budget=600</code></li><li>add zabbix monitor on net.if.in[eth0,errors,dropped,overruns], CPU softirq time system.cpu.util[,softirq]    </li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># chkconfig: 2345 90 60</span></span><br><span class="line"><span class="comment">### BEGIN INIT INFO</span></span><br><span class="line"><span class="comment"># Provides:          rps</span></span><br><span class="line"><span class="comment"># Required-Start:    $local_fs $remote_fs $network $syslog</span></span><br><span class="line"><span class="comment"># Required-Stop:     $local_fs $remote_fs $network $syslog</span></span><br><span class="line"><span class="comment"># Default-Start:     2 3 4 5</span></span><br><span class="line"><span class="comment"># Default-Stop:      0 1 6</span></span><br><span class="line"><span class="comment"># Short-Description: enable rps config for ubuntu</span></span><br><span class="line"><span class="comment"># Description:       enabele rps which is a kernel tweak for network performance</span></span><br><span class="line"><span class="comment">### END INIT INFO</span></span><br><span class="line"></span><br><span class="line">NAME=rps</span><br><span class="line">DESC=rps</span><br><span class="line"></span><br><span class="line"><span class="comment"># cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor</span></span><br><span class="line"><span class="comment"># cpupower frequency-set -g performance</span></span><br><span class="line"><span class="comment"># activate rps/rfs by script: https://gist.github.com/wsgzao/18828f69147635f3e38a14690a633daf</span></span><br><span class="line"><span class="comment"># double ring buffer size: ethtool -G p1p1 [rx|tx] 4096, ethtool -g p1p1</span></span><br><span class="line"><span class="comment"># double NAPI poll budget: sysctl -w net.core.netdev_budget=600</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">rps</span></span>() &#123;</span><br><span class="line">  net_interface=`ip link show | grep <span class="string">"state UP"</span> | awk <span class="string">'&#123;print $2&#125;'</span> | egrep -v <span class="string">'^docker|^veth'</span> | tr <span class="string">":\n"</span> <span class="string">""</span>`</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> em <span class="keyword">in</span> <span class="variable">$&#123;net_interface[@]&#125;</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">      rq_count=`ls /sys/class/net/<span class="variable">$em</span>/queues/rx-* -d | wc -l`</span><br><span class="line">      rps_flow_cnt_value=`expr 32768 / <span class="variable">$rq_count</span>`</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> ((i=0; i&lt; <span class="variable">$rq_count</span>; i++))</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">          <span class="built_in">echo</span> <span class="variable">$rps_flow_cnt_value</span> &gt; /sys/class/net/<span class="variable">$em</span>/queues/rx-<span class="variable">$i</span>/rps_flow_cnt</span><br><span class="line">      <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">      flag=0</span><br><span class="line">      <span class="keyword">while</span> [ -f /sys/class/net/<span class="variable">$em</span>/queues/rx-<span class="variable">$flag</span>/rps_cpus ]</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">          <span class="built_in">echo</span> `cat  /sys/class/net/<span class="variable">$em</span>/queues/rx-<span class="variable">$flag</span>/rps_cpus | sed <span class="string">'s/0/f/g'</span> ` &gt;  /sys/class/net/<span class="variable">$em</span>/queues/rx-<span class="variable">$flag</span>/rps_cpus</span><br><span class="line">          flag=$((<span class="variable">$flag</span>+1))</span><br><span class="line">      <span class="keyword">done</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  <span class="built_in">echo</span> 32768 &gt; /proc/sys/net/core/rps_sock_flow_entries</span><br><span class="line">  sysctl -p</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_rps</span></span>() &#123;</span><br><span class="line">  ni_list=`ip link show | grep <span class="string">"state UP"</span> | awk <span class="string">'&#123;print $2&#125;'</span> | egrep -v <span class="string">"^docker|^veth"</span> | tr <span class="string">":\n"</span> <span class="string">" "</span>`</span><br><span class="line">  <span class="keyword">for</span> n <span class="keyword">in</span> <span class="variable">$ni_list</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">      rx_queues=`ls /sys/class/net/<span class="variable">$n</span>/queues/ | grep <span class="string">"rx-[0-9]"</span>`</span><br><span class="line">      <span class="keyword">for</span> q <span class="keyword">in</span> <span class="variable">$rx_queues</span></span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">          rps_cpus=`cat /sys/class/net/<span class="variable">$n</span>/queues/<span class="variable">$q</span>/rps_cpus`</span><br><span class="line">          rps_flow_cnt=`cat /sys/class/net/<span class="variable">$n</span>/queues/<span class="variable">$q</span>/rps_flow_cnt`</span><br><span class="line"></span><br><span class="line">          <span class="built_in">echo</span> <span class="string">"[<span class="variable">$n</span>]"</span> <span class="variable">$q</span> <span class="string">"--&gt; rps_cpus ="</span> <span class="variable">$rps_cpus</span> <span class="string">", rps_flow_cnt ="</span> <span class="variable">$rps_flow_cnt</span></span><br><span class="line">      <span class="keyword">done</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  rps_sock_flow_entries=`cat /proc/sys/net/core/rps_sock_flow_entries`</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"rps_sock_flow_entries ="</span> <span class="variable">$rps_sock_flow_entries</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">  start)</span><br><span class="line">        <span class="built_in">echo</span> -n <span class="string">"Starting <span class="variable">$DESC</span>: "</span></span><br><span class="line">        rps</span><br><span class="line">        check_rps</span><br><span class="line">        ;;</span><br><span class="line">  stop)</span><br><span class="line">        <span class="built_in">echo</span> -n <span class="string">"Stop is not supported. "</span></span><br><span class="line">        ;;</span><br><span class="line">  restart|reload|force-reload)</span><br><span class="line">        <span class="built_in">echo</span> -n <span class="string">"Restart is not supported. "</span></span><br><span class="line">        ;;</span><br><span class="line">  status)</span><br><span class="line">        check_rps</span><br><span class="line">        ;;</span><br><span class="line">  *)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Usage: <span class="variable">$0</span> [start|status]"</span></span><br><span class="line">        ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure><h2 id="Scaling-in-the-Linux-Networking-Stack"><a href="#Scaling-in-the-Linux-Networking-Stack" class="headerlink" title="Scaling in the Linux Networking Stack"></a>Scaling in the Linux Networking Stack</h2><blockquote><p>了解 RSS、RPS、RFS 等基础知识很重要</p></blockquote><p>This document describes a set of complementary techniques in the Linux<br>networking stack to increase parallelism and improve performance for<br>multi-processor systems.</p><p>The following technologies are described:</p><ul><li>RSS: Receive Side Scaling</li><li>RPS: Receive Packet Steering</li><li>RFS: Receive Flow Steering</li><li>Accelerated Receive Flow Steering</li><li>XPS: Transmit Packet Steering</li></ul><p><a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt" target="_blank" rel="noopener">https://www.kernel.org/doc/Documentation/networking/scaling.txt</a></p><h2 id="RPS"><a href="#RPS" class="headerlink" title="RPS"></a>RPS</h2><p><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/performance_tuning_guide/network-rps" target="_blank" rel="noopener">RECEIVE PACKET STEERING (RPS)</a></p><p>Receive Packet Steering (RPS) is similar to RSS in that it is used to direct packets to specific CPUs for processing. However, RPS is implemented at the software level, and helps to prevent the hardware queue of a single network interface card from becoming a bottleneck in network traffic.</p><p>RPS has several advantages over hardware-based RSS:</p><ul><li><p>RPS can be used with any network interface card.</p></li><li><p>It is easy to add software filters to RPS to deal with new protocols.</p></li><li><p>RPS does not increase the hardware interrupt rate of the network device. However, it does introduce inter-processor interrupts.</p></li></ul><p>RPS is configured per network device and receive queue, in the <code>/sys/class/net/*device*/queues/*rx-queue*/rps_cpus</code> file, where <em>device</em> is the name of the network device (such as <code>eth0</code>) and <em>rx-queue</em> is the name of the appropriate receive queue (such as <code>rx-0</code>).</p><p>The default value of the <code>rps_cpus</code> file is zero. This disables RPS, so the CPU that handles the network interrupt also processes the packet.</p><p>To enable RPS, configure the appropriate <code>rps_cpus</code> file with the CPUs that should process packets from the specified network device and receive queue.</p><p>The <code>rps_cpus</code> files use comma-delimited CPU bitmaps. Therefore, to allow a CPU to handle interrupts for the receive queue on an interface, set the value of their positions in the bitmap to 1. For example, to handle interrupts with CPUs 0, 1, 2, and 3, set the value of <code>rps_cpus</code> to <code>00001111</code> (1+2+4+8), or <code>f</code> (the hexadecimal value for 15).</p><p>For network devices with single transmit queues, best performance can be achieved by configuring RPS to use CPUs in the same memory domain. On non-NUMA systems, this means that all available CPUs can be used. If the network interrupt rate is extremely high, excluding the CPU that handles network interrupts may also improve performance.</p><p>For network devices with multiple queues, there is typically no benefit to configuring both RPS and RSS, as RSS is configured to map a CPU to each receive queue by default. However, RPS may still be beneficial if there are fewer hardware queues than CPUs, and RPS is configured to use CPUs in the same memory domain.</p><h2 id="RFS"><a href="#RFS" class="headerlink" title="RFS"></a>RFS</h2><p><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/performance_tuning_guide/network-rfs" target="_blank" rel="noopener">RECEIVE FLOW STEERING (RFS)</a></p><p>Receive Flow Steering (RFS) extends RPS behavior to increase the CPU cache hit rate and thereby reduce network latency. Where RPS forwards packets based solely on queue length, RFS uses the RPS backend to calculate the most appropriate CPU, then forwards packets based on the location of the application consuming the packet. This increases CPU cache efficiency.</p><p>RFS is disabled by default. To enable RFS, you must edit two files:</p><p><code>/proc/sys/net/core/rps_sock_flow_entries</code></p><p>Set the value of this file to the maximum expected number of concurrently active connections. We recommend a value of <code>32768</code> for moderate server loads. All values entered are rounded up to the nearest power of 2 in practice.</p><p><code>/sys/class/net/*device*/queues/*rx-queue*/rps_flow_cnt</code></p><p>Replace <em>device</em> with the name of the network device you wish to configure (for example, <code>eth0</code>), and <em>rx-queue</em> with the receive queue you wish to configure (for example, <code>rx-0</code>).</p><p>Set the value of this file to the value of <code>rps_sock_flow_entries</code> divided by <code>N</code>, where <code>N</code> is the number of receive queues on a device. For example, if <code>rps_flow_entries</code> is set to <code>32768</code> and there are 16 configured receive queues, <code>rps_flow_cnt</code> should be set to <code>2048</code>. For single-queue devices, the value of <code>rps_flow_cnt</code> is the same as the value of <code>rps_sock_flow_entries</code>.</p><p>Data received from a single sender is not sent to more than one CPU. If the amount of data received from a single sender is greater than a single CPU can handle, configure a larger frame size to reduce the number of interrupts and therefore the amount of processing work for the CPU. Alternatively, consider NIC offload options or faster CPUs.</p><p>Consider using <code>numactl</code> or <code>taskset</code> in conjunction with RFS to pin applications to specific cores, sockets, or NUMA nodes. This can help prevent packets from being processed out of order.</p><h2 id="了解接收数据包的流程"><a href="#了解接收数据包的流程" class="headerlink" title="了解接收数据包的流程"></a>了解接收数据包的流程</h2><blockquote><p>这里摘取了美团技术团队的分析，在此表示感谢</p></blockquote><p>接收数据包是一个复杂的过程，涉及很多底层的技术细节，但大致需要以下几个步骤：</p><ol><li>网卡收到数据包。</li><li>将数据包从网卡硬件缓存转移到服务器内存中。</li><li>通知内核处理。</li><li>经过 TCP/IP 协议逐层处理。</li><li>应用程序通过 <code>read()</code> 从 <code>socket buffer</code> 读取数据。</li></ol><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190704163040.png" alt=""></p><h3 id="将网卡收到的数据包转移到主机内存（NIC-与驱动交互）"><a href="#将网卡收到的数据包转移到主机内存（NIC-与驱动交互）" class="headerlink" title="将网卡收到的数据包转移到主机内存（NIC 与驱动交互）"></a>将网卡收到的数据包转移到主机内存（NIC 与驱动交互）</h3><p>NIC 在接收到数据包之后，首先需要将数据同步到内核中，这中间的桥梁是 <code>rx ring buffer</code>。它是由 NIC 和驱动程序共享的一片区域，事实上，<code>rx ring buffer</code> 存储的并不是实际的 packet 数据，而是一个描述符，这个描述符指向了它真正的存储地址，具体流程如下：</p><ol><li>驱动在内存中分配一片缓冲区用来接收数据包，叫做 <code>sk_buffer</code>；</li><li>将上述缓冲区的地址和大小（即接收描述符），加入到 <code>rx ring buffer</code>。描述符中的缓冲区地址是 DMA 使用的物理地址；</li><li>驱动通知网卡有一个新的描述符；</li><li>网卡从 <code>rx ring buffer</code> 中取出描述符，从而获知缓冲区的地址和大小；</li><li>网卡收到新的数据包；</li><li>网卡将新数据包通过 DMA 直接写到 <code>sk_buffer</code> 中。</li></ol><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190704163052.png" alt=""></p><p>当驱动处理速度跟不上网卡收包速度时，驱动来不及分配缓冲区，NIC 接收到的数据包无法及时写到 <code>sk_buffer</code>，就会产生堆积，当 NIC 内部缓冲区写满后，就会丢弃部分数据，引起丢包。这部分丢包为 <code>rx_fifo_errors</code>，在 <code>/proc/net/dev</code> 中体现为 fifo 字段增长，在 ifconfig 中体现为 overruns 指标增长。</p><h3 id="通知系统内核处理（驱动与-Linux-内核交互）"><a href="#通知系统内核处理（驱动与-Linux-内核交互）" class="headerlink" title="通知系统内核处理（驱动与 Linux 内核交互）"></a>通知系统内核处理（驱动与 Linux 内核交互）</h3><p>这个时候，数据包已经被转移到了 <code>sk_buffer</code> 中。前文提到，这是驱动程序在内存中分配的一片缓冲区，并且是通过 DMA 写入的，这种方式不依赖 CPU 直接将数据写到了内存中，意味着对内核来说，其实并不知道已经有新数据到了内存中。那么如何让内核知道有新数据进来了呢？答案就是中断，通过中断告诉内核有新数据进来了，并需要进行后续处理。</p><p>提到中断，就涉及到硬中断和软中断，首先需要简单了解一下它们的区别：</p><ul><li>硬中断： 由硬件自己生成，具有随机性，硬中断被 CPU 接收后，触发执行中断处理程序。中断处理程序只会处理关键性的、短时间内可以处理完的工作，剩余耗时较长工作，会放到中断之后，由软中断来完成。硬中断也被称为上半部分。</li><li>软中断： 由硬中断对应的中断处理程序生成，往往是预先在代码里实现好的，不具有随机性。（除此之外，也有应用程序触发的软中断，与本文讨论的网卡收包无关。）也被称为下半部分。</li></ul><p><strong> 当 NIC 把数据包通过 DMA 复制到内核缓冲区 <code>sk_buffer</code> 后，NIC 立即发起一个硬件中断。CPU 接收后，首先进入上半部分，网卡中断对应的中断处理程序是网卡驱动程序的一部分，之后由它发起软中断，进入下半部分，开始消费 <code>sk_buffer</code> 中的数据，交给内核协议栈处理。</strong></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190704163113.png" alt=""></p><p>通过中断，能够快速及时地响应网卡数据请求，但如果数据量大，那么会产生大量中断请求，CPU 大部分时间都忙于处理中断，效率很低。为了解决这个问题，现在的内核及驱动都采用一种叫 NAPI（new API）的方式进行数据处理，其原理可以简单理解为 中断 + 轮询，在数据量大时，一次中断后通过轮询接收一定数量包再返回，避免产生多次中断。</p><h2 id="什么是中断？"><a href="#什么是中断？" class="headerlink" title="什么是中断？"></a>什么是中断？</h2><p>由于接收来自外围硬件 (相对于 CPU 和内存) 的异步信号或者来自软件的同步信号，而进行相应的硬件、软件处理；发出这样的信号称为进行中断请求 (interrupt request, IRQ)</p><h3 id="硬中断与软中断？"><a href="#硬中断与软中断？" class="headerlink" title=" 硬中断与软中断？"></a><a href="# 硬中断与软中断" title="硬中断与软中断?"></a> 硬中断与软中断？</h3><ul><li><strong> 硬中断 </strong>：外围硬件发给 CPU 或者内存的异步信号就称之为硬中断</li><li><strong> 软中断 </strong>：由软件系统本身发给操作系统内核的中断信号，称之为软中断。通常是由硬中断处理程序或进程调度程序对操作系统内核的中断，也就是我们常说的系统调用 (System Call)</li></ul><h3 id="硬中断与软中断之区别与联系？"><a href="#硬中断与软中断之区别与联系？" class="headerlink" title=" 硬中断与软中断之区别与联系？"></a><a href="# 硬中断与软中断之区别与联系？" title="硬中断与软中断之区别与联系？"></a> 硬中断与软中断之区别与联系？</h3><ol><li>硬中断是有外设硬件发出的，需要有中断控制器之参与。其过程是外设侦测到变化，告知中断控制器，中断控制器通过 CPU 或内存的中断脚通知 CPU，然后硬件进行程序计数器及堆栈寄存器之现场保存工作（引发上下文切换），并根据中断向量调用硬中断处理程序进行中断处理</li><li>软中断则通常是由硬中断处理程序或者进程调度程序等软件程序发出的中断信号，无需中断控制器之参与，直接以一个 CPU 指令之形式指示 CPU 进行程序计数器及堆栈寄存器之现场保存工作 (亦会引发上下文切换)，并调用相应的软中断处理程序进行中断处理 (即我们通常所言之系统调用)</li><li>硬中断直接以硬件的方式引发，处理速度快。软中断以软件指令之方式适合于对响应速度要求不是特别严格的场景</li><li>硬中断通过设置 CPU 的屏蔽位可进行屏蔽，软中断则由于是指令之方式给出，不能屏蔽</li><li>硬中断发生后，通常会在硬中断处理程序中调用一个软中断来进行后续工作的处理</li><li>硬中断和软中断均会引起上下文切换 (进程 / 线程之切换)，进程切换的过程是差不多的</li></ol><h3 id="查看中断情况"><a href="#查看中断情况" class="headerlink" title="查看中断情况"></a>查看中断情况</h3><p>1.top 按下数字键 1 </p><ul><li>hi : time spent servicing hardware interrupts</li><li>si : time spent servicing software interrupts</li></ul><p>2.mpstat -P ALL 2</p><ul><li>%irq 为硬中断</li><li>%soft 为软中断</li></ul><p>mpstat 使用介绍和输出参数详解 - <a href="https://wsgzao.github.io/post/mpstat/">https://wsgzao.github.io/post/mpstat/</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost wangao]<span class="comment"># top</span></span><br><span class="line">top - 19:17:57 up 7 days,  7:11,  1 user,  load average: 0.00, 0.01, 0.05</span><br><span class="line">Tasks: 338 total,   1 running, 337 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu0  :  0.0 us,  0.0 sy,  0.0 ni, 98.0 id,  0.0 wa,  0.0 hi,  2.0 si,  0.0 st</span><br><span class="line">%Cpu1  :  0.0 us,  0.0 sy,  0.0 ni, 96.7 id,  0.0 wa,  0.0 hi,  3.3 si,  0.0 st</span><br><span class="line">%Cpu2  :  0.0 us,  0.0 sy,  0.0 ni, 97.7 id,  0.0 wa,  0.0 hi,  2.3 si,  0.0 st</span><br><span class="line">%Cpu3  :  0.0 us,  0.0 sy,  0.0 ni, 97.4 id,  0.0 wa,  0.0 hi,  2.6 si,  0.0 st</span><br><span class="line">%Cpu4  :  0.0 us,  0.0 sy,  0.0 ni, 99.0 id,  0.0 wa,  0.0 hi,  1.0 si,  0.0 st</span><br><span class="line">%Cpu5  :  0.0 us,  0.0 sy,  0.0 ni, 96.7 id,  0.0 wa,  0.0 hi,  3.3 si,  0.0 st</span><br><span class="line">%Cpu6  :  0.0 us,  0.0 sy,  0.0 ni, 97.4 id,  0.0 wa,  0.0 hi,  2.6 si,  0.0 st</span><br><span class="line">%Cpu7  :  0.0 us,  0.0 sy,  0.0 ni, 97.7 id,  0.0 wa,  0.0 hi,  2.3 si,  0.0 st</span><br><span class="line">%Cpu8  :  0.0 us,  0.0 sy,  0.0 ni, 98.3 id,  0.0 wa,  0.0 hi,  1.7 si,  0.0 st</span><br><span class="line">%Cpu9  :  0.0 us,  0.0 sy,  0.0 ni, 97.0 id,  0.0 wa,  0.0 hi,  3.0 si,  0.0 st</span><br><span class="line">%Cpu10 :  0.0 us,  0.0 sy,  0.0 ni, 98.7 id,  0.0 wa,  0.0 hi,  1.3 si,  0.0 st</span><br><span class="line">%Cpu11 :  0.0 us,  0.0 sy,  0.0 ni, 97.4 id,  0.0 wa,  0.0 hi,  2.6 si,  0.0 st</span><br><span class="line">%Cpu12 :  0.0 us,  0.0 sy,  0.0 ni, 96.7 id,  0.0 wa,  0.0 hi,  3.3 si,  0.0 st</span><br><span class="line">%Cpu13 :  0.0 us,  0.0 sy,  0.0 ni, 98.3 id,  0.0 wa,  0.0 hi,  1.7 si,  0.0 st</span><br><span class="line">%Cpu14 :  0.0 us,  0.0 sy,  0.0 ni, 98.3 id,  0.0 wa,  0.0 hi,  1.7 si,  0.0 st</span><br><span class="line">%Cpu15 :  0.0 us,  0.0 sy,  0.0 ni, 96.7 id,  0.0 wa,  0.0 hi,  3.3 si,  0.0 st</span><br><span class="line">%Cpu16 :  0.0 us,  0.0 sy,  0.0 ni, 97.3 id,  0.0 wa,  0.0 hi,  2.7 si,  0.0 st</span><br><span class="line">%Cpu17 :  0.0 us,  0.0 sy,  0.0 ni, 97.7 id,  0.0 wa,  0.0 hi,  2.3 si,  0.0 st</span><br><span class="line">%Cpu18 :  0.3 us,  0.7 sy,  0.0 ni, 96.7 id,  0.0 wa,  0.0 hi,  2.3 si,  0.0 st</span><br><span class="line">%Cpu19 :  0.0 us,  0.0 sy,  0.0 ni, 98.3 id,  0.0 wa,  0.0 hi,  1.7 si,  0.0 st</span><br><span class="line">%Cpu20 :  0.0 us,  0.0 sy,  0.0 ni, 99.0 id,  0.0 wa,  0.0 hi,  1.0 si,  0.0 st</span><br><span class="line">%Cpu21 :  0.0 us,  0.0 sy,  0.0 ni, 97.0 id,  0.0 wa,  0.0 hi,  3.0 si,  0.0 st</span><br><span class="line">%Cpu22 :  0.0 us,  0.0 sy,  0.0 ni, 97.7 id,  0.0 wa,  0.0 hi,  2.3 si,  0.0 st</span><br><span class="line">%Cpu23 :  0.0 us,  0.0 sy,  0.0 ni, 97.4 id,  0.0 wa,  0.0 hi,  2.6 si,  0.0 st</span><br><span class="line">%Cpu24 :  0.0 us,  0.0 sy,  0.0 ni, 97.7 id,  0.0 wa,  0.0 hi,  2.3 si,  0.0 st</span><br><span class="line">%Cpu25 :  0.0 us,  0.0 sy,  0.0 ni, 97.0 id,  0.0 wa,  0.0 hi,  3.0 si,  0.0 st</span><br><span class="line">%Cpu26 :  0.0 us,  0.0 sy,  0.0 ni, 98.3 id,  0.0 wa,  0.0 hi,  1.7 si,  0.0 st</span><br><span class="line">%Cpu27 :  0.0 us,  0.0 sy,  0.0 ni, 98.3 id,  0.0 wa,  0.0 hi,  1.7 si,  0.0 st</span><br><span class="line">%Cpu28 :  0.0 us,  0.0 sy,  0.0 ni, 96.7 id,  0.0 wa,  0.0 hi,  3.3 si,  0.0 st</span><br><span class="line">%Cpu29 :  0.0 us,  0.0 sy,  0.0 ni, 97.4 id,  0.0 wa,  0.0 hi,  2.6 si,  0.0 st</span><br><span class="line">%Cpu30 :  0.0 us,  0.0 sy,  0.0 ni, 98.3 id,  0.0 wa,  0.0 hi,  1.7 si,  0.0 st</span><br><span class="line">%Cpu31 :  0.0 us,  0.0 sy,  0.0 ni, 97.4 id,  0.0 wa,  0.0 hi,  2.6 si,  0.0 st</span><br><span class="line">KiB Mem : 65688788 total, 62127224 free,  1742128 used,  1819436 buff/cache</span><br><span class="line">KiB Swap: 66060284 total, 66060284 free,        0 used. 63291844 avail Mem</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@localhost wangao]<span class="comment"># mpstat -P ALL 2</span></span><br><span class="line">Linux 3.10.0-957.21.3.el7.x86_64 (localhost.localdomain) 07/04/2019 _x86_64_(32 CPU)</span><br><span class="line"></span><br><span class="line">07:18:35 PM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle</span><br><span class="line">07:18:37 PM  all    0.02    0.00    0.02    0.00    0.00    2.14    0.00    0.00    0.00   97.83</span><br><span class="line">07:18:37 PM    0    0.00    0.00    0.00    0.00    0.00    2.50    0.00    0.00    0.00   97.50</span><br><span class="line">07:18:37 PM    1    0.00    0.00    0.00    0.00    0.00    4.41    0.00    0.00    0.00   95.59</span><br><span class="line">07:18:37 PM    2    0.00    0.00    0.00    0.00    0.00    2.51    0.00    0.00    0.00   97.49</span><br><span class="line">07:18:37 PM    3    0.00    0.00    0.00    0.00    0.00    2.96    0.00    0.00    0.00   97.04</span><br><span class="line">07:18:37 PM    4    0.00    0.00    0.00    0.00    0.00    1.01    0.00    0.00    0.00   98.99</span><br><span class="line">07:18:37 PM    5    0.00    0.00    0.00    0.00    0.00    2.99    0.00    0.00    0.00   97.01</span><br><span class="line">07:18:37 PM    6    0.00    0.00    0.00    0.00    0.00    1.01    0.00    0.00    0.00   98.99</span><br><span class="line">07:18:37 PM    7    0.00    0.00    0.00    0.00    0.00    2.99    0.00    0.00    0.00   97.01</span><br><span class="line">07:18:37 PM    8    0.00    0.00    0.00    0.00    0.00    1.50    0.00    0.00    0.00   98.50</span><br><span class="line">07:18:37 PM    9    0.00    0.00    0.00    0.00    0.00    2.01    0.00    0.00    0.00   97.99</span><br><span class="line">07:18:37 PM   10    0.00    0.00    0.00    0.00    0.00    1.50    0.00    0.00    0.00   98.50</span><br><span class="line">07:18:37 PM   11    0.00    0.00    0.00    0.00    0.00    1.50    0.00    0.00    0.00   98.50</span><br><span class="line">07:18:37 PM   12    0.00    0.00    0.00    0.00    0.00    1.01    0.00    0.00    0.00   98.99</span><br><span class="line">07:18:37 PM   13    0.00    0.00    0.00    0.00    0.00    2.49    0.00    0.00    0.00   97.51</span><br><span class="line">07:18:37 PM   14    0.00    0.00    0.00    0.00    0.00    1.01    0.00    0.00    0.00   98.99</span><br><span class="line">07:18:37 PM   15    0.00    0.00    0.00    0.00    0.00    3.94    0.00    0.00    0.00   96.06</span><br><span class="line">07:18:37 PM   16    0.00    0.00    0.00    0.00    0.00    2.50    0.00    0.00    0.00   97.50</span><br><span class="line">07:18:37 PM   17    0.00    0.00    0.00    0.00    0.00    2.97    0.00    0.00    0.00   97.03</span><br><span class="line">07:18:37 PM   18    0.00    0.00    0.00    0.00    0.00    2.02    0.00    0.00    0.00   97.98</span><br><span class="line">07:18:37 PM   19    0.00    0.00    0.00    0.00    0.00    1.49    0.00    0.00    0.00   98.51</span><br><span class="line">07:18:37 PM   20    0.00    0.00    0.00    0.00    0.00    1.01    0.00    0.00    0.00   98.99</span><br><span class="line">07:18:37 PM   21    0.00    0.00    0.00    0.00    0.00    2.50    0.00    0.00    0.00   97.50</span><br><span class="line">07:18:37 PM   22    0.00    0.00    0.00    0.00    0.00    1.50    0.00    0.00    0.00   98.50</span><br><span class="line">07:18:37 PM   23    0.00    0.00    0.00    0.00    0.00    3.48    0.00    0.00    0.00   96.52</span><br><span class="line">07:18:37 PM   24    0.00    0.00    0.00    0.00    0.00    0.51    0.00    0.00    0.00   99.49</span><br><span class="line">07:18:37 PM   25    0.00    0.00    0.00    0.00    0.00    2.97    0.00    0.00    0.00   97.03</span><br><span class="line">07:18:37 PM   26    0.00    0.00    0.00    0.00    0.00    1.99    0.00    0.00    0.00   98.01</span><br><span class="line">07:18:37 PM   27    0.00    0.00    0.00    0.00    0.00    0.51    0.00    0.00    0.00   99.49</span><br><span class="line">07:18:37 PM   28    0.00    0.00    0.00    0.00    0.00    1.51    0.00    0.00    0.00   98.49</span><br><span class="line">07:18:37 PM   29    0.00    0.00    0.00    0.00    0.00    3.45    0.00    0.00    0.00   96.55</span><br><span class="line">07:18:37 PM   30    0.00    0.00    0.00    0.00    0.00    1.50    0.00    0.00    0.00   98.50</span><br><span class="line">07:18:37 PM   31    0.00    0.00    0.00    0.00    0.00    2.97    0.00    0.00    0.00   97.03</span><br></pre></td></tr></table></figure><h2 id="优化建议和效果演示"><a href="#优化建议和效果演示" class="headerlink" title="优化建议和效果演示"></a>优化建议和效果演示</h2><ol><li>查看网卡支持多队列的情况，<code>ethtool -l eth0</code></li><li>开启 irqbalance 服务，让系统自动调整网络中断在多个 CPU 核上的分配, <code>systemctl start irqbalance</code></li><li>开启 RPS/RFS 特性，软件方式实现 CPU 均衡，接收包中断的优化</li></ol><h3 id="查看-RPS-RFS-优化前后变化"><a href="#查看-RPS-RFS-优化前后变化" class="headerlink" title="查看 RPS/RFS 优化前后变化"></a>查看 RPS/RFS 优化前后变化</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 优化前 </span></span><br><span class="line">[root@localhost wangao]<span class="comment"># service rps status</span></span><br><span class="line">[em1] rx-0 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[em1] rx-1 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[em1] rx-2 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[em1] rx-3 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-0 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-1 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-10 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-11 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-12 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-13 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-14 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-15 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-16 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-17 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-18 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-19 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-2 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-20 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-21 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-22 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-23 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-24 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-25 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-26 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-27 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-28 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-29 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-3 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-30 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-31 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-4 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-5 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-6 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-7 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-8 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p1] rx-9 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-0 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-1 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-10 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-11 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-12 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-13 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-14 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-15 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-16 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-17 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-18 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-19 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-2 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-20 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-21 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-22 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-23 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-24 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-25 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-26 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-27 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-28 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-29 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-3 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-30 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-31 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-4 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-5 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-6 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-7 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-8 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[p1p2] rx-9 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[bond0] rx-0 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[bond0] rx-1 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[bond0] rx-10 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[bond0] rx-11 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[bond0] rx-12 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[bond0] rx-13 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[bond0] rx-14 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[bond0] rx-15 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[bond0] rx-2 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[bond0] rx-3 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[bond0] rx-4 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[bond0] rx-5 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[bond0] rx-6 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[bond0] rx-7 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[bond0] rx-8 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">[bond0] rx-9 --&gt; rps_cpus = 00000000,00000000,00000000,00000000,00000000,00000000 , rps_flow_cnt = 0</span><br><span class="line">rps_sock_flow_entries = 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 优化后 </span></span><br><span class="line">[root@localhost wangao]<span class="comment"># service rps status</span></span><br><span class="line">[em1] rx-0 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 8192</span><br><span class="line">[em1] rx-1 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 8192</span><br><span class="line">[em1] rx-2 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 8192</span><br><span class="line">[em1] rx-3 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 8192</span><br><span class="line">[p1p1] rx-0 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-1 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-10 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-11 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-12 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-13 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-14 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-15 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-16 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-17 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-18 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-19 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-2 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-20 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-21 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-22 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-23 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-24 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-25 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-26 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-27 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-28 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-29 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-3 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-30 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-31 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-4 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-5 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-6 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-7 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-8 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p1] rx-9 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-0 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-1 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-10 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-11 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-12 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-13 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-14 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-15 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-16 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-17 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-18 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-19 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-2 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-20 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-21 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-22 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-23 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-24 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-25 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-26 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-27 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-28 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-29 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-3 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-30 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-31 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-4 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-5 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-6 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-7 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-8 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[p1p2] rx-9 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 1024</span><br><span class="line">[bond0] rx-0 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 2048</span><br><span class="line">[bond0] rx-1 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 2048</span><br><span class="line">[bond0] rx-10 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 2048</span><br><span class="line">[bond0] rx-11 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 2048</span><br><span class="line">[bond0] rx-12 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 2048</span><br><span class="line">[bond0] rx-13 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 2048</span><br><span class="line">[bond0] rx-14 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 2048</span><br><span class="line">[bond0] rx-15 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 2048</span><br><span class="line">[bond0] rx-2 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 2048</span><br><span class="line">[bond0] rx-3 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 2048</span><br><span class="line">[bond0] rx-4 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 2048</span><br><span class="line">[bond0] rx-5 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 2048</span><br><span class="line">[bond0] rx-6 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 2048</span><br><span class="line">[bond0] rx-7 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 2048</span><br><span class="line">[bond0] rx-8 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 2048</span><br><span class="line">[bond0] rx-9 --&gt; rps_cpus = 0000,00000000,00000000,00000000,ffffffff , rps_flow_cnt = 2048</span><br><span class="line">rps_sock_flow_entries = 32768</span><br></pre></td></tr></table></figure><h3 id="查看软中断变化"><a href="#查看软中断变化" class="headerlink" title="查看软中断变化"></a>查看软中断变化</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"># 优化前 </span><br><span class="line">[root@localhost wangao]# egrep &apos;cpu|p1p1&apos; /proc/interrupts</span><br><span class="line">  68:   14737707          0       7843          0     571920          0     265157          0          0          0       1610          0      15028          0     314078          0      54904          0     449958          0     126160          0     338804          0     668880          0     122459          0     174803          0      26147          0  IR-PCI-MSI-edge      p1p1-TxRx-0</span><br><span class="line">  69:      56960          0     115829          0    2669071          0      61425          0      25161          0    4573083          0      72772          0      30975          0      61705          0     189408          0      13134          0     212159          0      49345          0     104657          0    1475007          0      82145          0  IR-PCI-MSI-edge      p1p1-TxRx-1</span><br><span class="line">  70:      73053          0     118657          0      95018          0    8645414          0      60962          0      83141          0      53948          0       7465          0      99615          0     119273          0      26191          0      14160          0      45703          0     335306          0    4014649          0      94692          0  IR-PCI-MSI-edge      p1p1-TxRx-2</span><br><span class="line">  71:      46293          0      75419          0      57967          0       6088          0      44337          0      88437          0      22859          0      51370          0      45510          0     120119          0      53276          0    1105728          0      92556          0    7627687          0     374344          0      79394          0  IR-PCI-MSI-edge      p1p1-TxRx-3</span><br><span class="line">  74:      55261          0     738486          0      14860          0      76202          0     173074          0     215494          0    6385081          0    2691319          0     167374          0      60585          0      17804          0      63837          0    1267656          0      25655          0      94509          0     115839          0  IR-PCI-MSI-edge      p1p1-TxRx-4</span><br><span class="line">  75:      59182          0      58481          0      89362          0      49916          0      53663          0      40476          0      81847          0      48582          0    7661643          0      74951          0      81414          0      37247          0      58610          0     244719          0    1449948          0      53745          0  IR-PCI-MSI-edge      p1p1-TxRx-5</span><br><span class="line">  76:      46993          0     290826          0      58661          0      31146          0     112260          0      51531          0     124002          0      47309          0      74370          0    5474439          0    8948212          0      97511          0     184151          0     141408          0      60222          0      19645          0  IR-PCI-MSI-edge      p1p1-TxRx-6</span><br><span class="line">  77:      44716          0      30601          0     111528          0      61197          0      29883          0    1262486          0      44401          0      19157          0      55785          0      80069          0     143110          0      67065          0    8581759          0      75214          0     201489          0     116415          0  IR-PCI-MSI-edge      p1p1-TxRx-7</span><br><span class="line">  78:      68542          0      46913          0      60848          0      61158          0      66591          0    8619198          0    1284598          0      68180          0      88156          0    3904413          0      32320          0     158036          0      74480          0      36877          0      91269          0      66078          0  IR-PCI-MSI-edge      p1p1-TxRx-8</span><br><span class="line">  79:      45256          0      70914          0      57025          0      58231          0      70398          0      24195          0      29084          0      55756          0    8559005          0      91255          0     105623          0      66336          0      34652          0     161266          0    1555160          0      63201          0  IR-PCI-MSI-edge      p1p1-TxRx-9</span><br><span class="line">  80:      81984          0      71120          0    8853871          0    4829736          0      38789          0      66915          0      37601          0      55277          0      52352          0     226681          0      64967          0      68163          0     100074          0      48442          0     106219          0     120024          0  IR-PCI-MSI-edge      p1p1-TxRx-10</span><br><span class="line">  81:      69573          0      55072          0      98255          0      49468          0   11084926          0      50300          0      67870          0      91907          0      61667          0      69887          0      83711          0      80970          0      87310          0      47258          0    1438136          0      80672          0  IR-PCI-MSI-edge      p1p1-TxRx-11</span><br><span class="line">  82:      41874          0     141338          0      40619          0    9095415          0    2744017          0      63918          0     203991          0     314563          0    1205451          0     124044          0     112602          0     308959          0      43454          0     128518          0      46659          0      80356          0  IR-PCI-MSI-edge      p1p1-TxRx-12</span><br><span class="line">  83:      33080          0    8793595          0      53807          0      46637          0      62925          0      54755          0      72271          0      60842          0      93343          0      47785          0      82287          0      73409          0     745000          0     832425          0     102907          0      90783          0  IR-PCI-MSI-edge      p1p1-TxRx-13</span><br><span class="line">  84:      52045          0      52518          0      83353          0      64534          0      32414          0      35972          0      45190          0      36925          0      24817          0      79178          0    1443964          0    3712758          0    9480150          0     109740          0      82856          0      58387          0  IR-PCI-MSI-edge      p1p1-TxRx-14</span><br><span class="line">  85:      63117          0      22871          0     220711          0      75206          0      19498          0      70962          0      52117          0      97241          0     123345          0      67058          0     115891          0    7140767          0    1527076          0     230527          0      52956          0      36916          0  IR-PCI-MSI-edge      p1p1-TxRx-15</span><br><span class="line">  86:     341182          0      25306          0     436494          0      79810          0     336125          0      24769          0    1015036          0      56332          0     996708          0      46704          0      44728          0     171661          0      73625          0     112345          0     595442          0    1249696          0  IR-PCI-MSI-edge      p1p1-TxRx-16</span><br><span class="line">  87:      27329          0      55574          0     348849          0      43122          0     333589          0      68221          0     146119          0     264597          0      42572          0      84245          0     217853          0     446305          0      47318          0     202998          0     423085          0     961201          0  IR-PCI-MSI-edge      p1p1-TxRx-17</span><br><span class="line">  88:     270648          0      46600          0     217253          0      31500          0      38469          0    3095476          0      84290          0      52591          0      26967          0      34871          0      38145          0      87283          0      67059          0     270541          0     210215          0    3993171          0  IR-PCI-MSI-edge      p1p1-TxRx-18</span><br><span class="line">  89:     148447          0      48653          0     326406          0      53179          0     123863          0      66748          0     391198          0     159050          0      98765          0      54322          0     141506          0     173276          0    1397478          0     133225          0      78736          0     119593          0  IR-PCI-MSI-edge      p1p1-TxRx-19</span><br><span class="line">  90:      56503          0     135502          0     687704          0     380045          0     469732          0      37274          0     281894          0    1552891          0     121443          0      47009          0     173177          0     650010          0     104931          0     131578          0     217383          0     633766          0  IR-PCI-MSI-edge      p1p1-TxRx-20</span><br><span class="line">  91:     214823          0      61146          0     339177          0      49928          0     327002          0      64010          0     318068          0     541504          0      45756          0      20992          0     176829          0      57846          0     148528          0    1162846          0      94836          0     433683          0  IR-PCI-MSI-edge      p1p1-TxRx-21</span><br><span class="line">  92:     106435          0      26816          0     555204          0      31009          0     391325          0     125873          0     290335          0     567300          0      40470          0     341570          0      61671          0     192984          0     221575          0    3245714          0      80733          0     596397          0  IR-PCI-MSI-edge      p1p1-TxRx-22</span><br><span class="line">  93:     115951          0      70761          0     381334          0     143441          0     872170          0     118644          0     517816          0      60193          0     100746          0      41460          0      70866          0     102305          0     134298          0      79193          0      79264          0    1835037          0  IR-PCI-MSI-edge      p1p1-TxRx-23</span><br><span class="line">  94:     146101          0      35816          0     733832          0      29613          0     313268          0     202986          0     340662          0     100681          0    1993051          0     335538          0      71931          0      23162          0     246612          0     556509          0     224855          0     559908          0  IR-PCI-MSI-edge      p1p1-TxRx-24</span><br><span class="line">  95:     150668          0      36783          0     251091          0      36610          0     452604          0     118424          0     197907          0     471898          0     916471          0      25373          0      43497          0     170329          0     504482          0     504129          0      61751          0     349911          0  IR-PCI-MSI-edge      p1p1-TxRx-25</span><br><span class="line">  96:     175244          0      85547          0     149382          0      25817          0      27945          0      55507          0     297689          0    1877839          0      72682          0     294648          0      34613          0      54712          0     184015          0    5097111          0      62440          0     893488          0  IR-PCI-MSI-edge      p1p1-TxRx-26</span><br><span class="line">  97:     188255          0      79222          0     196770          0      93331          0      62542          0     197921          0     499815          0    1489952          0     685652          0     127194          0      39956          0      48082          0      46078          0     444262          0      89668          0     197128          0  IR-PCI-MSI-edge      p1p1-TxRx-27</span><br><span class="line">  98:     113119          0      44914          0     418302          0      17345          0      51941          0     187466          0      37948          0     572466          0      54668          0      27553          0     580539          0     366022          0    2375605          0      49572          0      73136          0    1132828          0  IR-PCI-MSI-edge      p1p1-TxRx-28</span><br><span class="line">  99:      94404          0      56968          0     407066          0      45791          0     302591          0     106122          0     261980          0     583169          0      32802          0      50997          0      47888          0      99704          0     129685          0     315057          0      38119          0    1544062          0  IR-PCI-MSI-edge      p1p1-TxRx-29</span><br><span class="line"> 100:      98958          0     178434          0     354708          0     111329          0     159026          0     156721          0     224555          0     188416          0     224497          0      30343          0     497511          0     121221          0     280827          0     354135          0      84543          0    1650501          0  IR-PCI-MSI-edge      p1p1-TxRx-30</span><br><span class="line"> 101:     199414          0      34177          0     506856          0      92717          0     246991          0     118922          0     123314          0     261694          0     145339          0     730269          0     397150          0      26237          0     541393          0     357194          0     174133          0     520104          0  IR-PCI-MSI-edge      p1p1-TxRx-31</span><br><span class="line"> 102:          5          0          0          0          0          0        130          0          0          0          4          0          5          0          2          0          1          0          0          0          2          0          0          0          0          0          0          0          0          0         57          0  IR-PCI-MSI-edge      p1p1</span><br><span class="line"></span><br><span class="line"># 优化后 </span><br><span class="line">[root@localhost wangao]# egrep &apos;cpu|enp175s0f0&apos; /proc/interrupts</span><br><span class="line"> 545:          0          0          0          0          0          0          0          0   78728441   66114965   52520832   41158901   65698825   55803106   20888551   23716200          0          0          0          0          0          0          0          0   41296940   19654307   42367407   68035795   31971316   73083489  109360661   60151057  IR-PCI-MSI-edge      enp175s0f0-TxRx-0</span><br><span class="line"> 546:          0          0          0          0          0          0          0          0  293334701   57784003   57947637  279907263   83003310   59328994   14582717   10594077          0          0          0          0          0          0          0          0   33844346   53425312  104463040  121835272   48115201   11875829  149517303   27888367  IR-PCI-MSI-edge      enp175s0f0-TxRx-1</span><br><span class="line"> 547:          0          0          0          0          0          0          0          0   65087834   74714070   70617455   50729188   50629957   53222216   29320338   43600286          0          0          0          0          0          0          0          0   78790098   21664768   53133919  104396382   28219169   98109898  106275780    6075631  IR-PCI-MSI-edge      enp175s0f0-TxRx-2</span><br><span class="line"> 548:          0          0          0          0          0          0          0          0  108290552   62484073   55417923   64030173   55771760   74127972   63180417   62512564          0          0          0          0          0          0          0          0  127950399   63170356   20177522  106969671   21966002  107295156  138414635    3139534  IR-PCI-MSI-edge      enp175s0f0-TxRx-3</span><br><span class="line"> 549:          0          0          0          0          0          0          0          0  175701987  134359768  118283034   93078181   56579608   43699849   83211249   72178065          0          0          0          0          0          0          0          0   67170073   21723454   56826677  103798934   14026848   39506854  136483492   11700838  IR-PCI-MSI-edge      enp175s0f0-TxRx-4</span><br><span class="line"> 550:          0          0          0          0          0          0          0          0  161298050   70517371   30581739  186350377  170422634  226218127   55471402   95255735          0          0          0          0          0          0          0          0  158450530   36931783   14121926   68432292   26086904    5561980   46129837      10039  IR-PCI-MSI-edge      enp175s0f0-TxRx-5</span><br><span class="line"> 551:          0          0          0          0          0          0          0          0   59810450   85668650   74748733   66956510   53509915   67475372   37312571   27187643          0          0          0          0          0          0          0          0   42998302   18434014   26932131   54190593   16723043   46515600   59603049   11897912  IR-PCI-MSI-edge      enp175s0f0-TxRx-6</span><br><span class="line"> 552:          0          0          0          0          0          0          0          0   37068253  137459908  126379700  132069647   44577185   92132779   18951865   48826631          0          0          0          0          0          0          0          0  168471567   18399908    9609939  156723119   45300251   47356473   71094409   13049049  IR-PCI-MSI-edge      enp175s0f0-TxRx-7</span><br><span class="line"> 553:          0          0          0          0          0          0          0          0    9148701   15294255  337628836   28379485   21729246   18839950    5383431    5064436          0          0          0          0          0          0          0          0   45773035    6898143    3359206    4497486  569915849    5649581  659950071  561102436  IR-PCI-MSI-edge      enp175s0f0-TxRx-8</span><br><span class="line"> 554:          0          0          0          0          0          0          0          0   45919755  648235162   90862075   82511196  121536855  775131101    5059996    2245523          0          0          0          0          0          0          0          0   39913983  123180793    4250458  117911846   13217963    4291001   72759615   11901382  IR-PCI-MSI-edge      enp175s0f0-TxRx-9</span><br><span class="line"> 555:          0          0          0          0          0          0          0          0   17252329   12804726  202960565  226950817  436490841   62135664  286074659    2405684          0          0          0          0          0          0          0          0    1937801    2774288  198336045   26598791    3834288  620409019    7956742          0  IR-PCI-MSI-edge      enp175s0f0-TxRx-10</span><br><span class="line"> 556:          0          0          0          0          0          0          0          0    2543207    1589549  378184536    5537639    2432570   10278492  370935530    2557214          0          0          0          0          0          0          0          0    2084807    2817750    3214825    3352447 1633147902    3067434    3704468          0  IR-PCI-MSI-edge      enp175s0f0-TxRx-11</span><br><span class="line"> 557:          0          0          0          0          0          0          0          0   35578276  274609699  253038113    4759061   62653759    2988138   24435129    2729652          0          0          0          0          0          0          0          0 1276874078    3470696  522229642    4623985    3795035    3779577    4484373      26368  IR-PCI-MSI-edge      enp175s0f0-TxRx-12</span><br><span class="line"> 558:          0          0          0          0          0          0          0          0    3282953    3151370   13102970   15841447    2290018  191758517  253118172    3139260          0          0          0          0          0          0          0          0    2245766    6169610 1545045398   30596340    4355187  163581051    4176977          0  IR-PCI-MSI-edge      enp175s0f0-TxRx-13</span><br><span class="line"> 559:          0          0          0          0          0          0          0          0   88746890    2665364   81746473  477713921    4323711   87193204   74776878    3650446          0          0          0          0          0          0          0          0    2540382  403859013    3537468  997197460  189897196    4592593    5480200          0  IR-PCI-MSI-edge      enp175s0f0-TxRx-14</span><br><span class="line"> 560:          0          0          0          0          0          0          0          0    6646487    5048477    4430038    8497796   18754540  225111260  231266854 1499236783          0          0          0          0          0          0          0          0  138682422    4968757   27628949   22916070    3702479   28557972   20003328          0  IR-PCI-MSI-edge      enp175s0f0-TxRx-15</span><br><span class="line"> 561:          0          0          0          0          0          0          0          0      60867      79129      72520      56561      47863      58682      37248      30413          0          0          0          0          0          0          0          0      31560      22821      36684      41662      23009      40489      40755   10139346  IR-PCI-MSI-edge      enp175s0f0-TxRx-16</span><br><span class="line"> 562:          0          0          0          0          0          0          0          0     704280    2485475    1162836     815515     762812     681074     684065     578558          0          0          0          0          0          0          0          0     384355     706857     392981     350292     339121     403073     201587      19983  IR-PCI-MSI-edge      enp175s0f0-TxRx-17</span><br><span class="line"> 563:          0          0          0          0          0          0          0          0     629722    2106933    1485145    1179751     579723     864401     771639     621684          0          0          0          0          0          0          0          0     357663     563356     465863     413412     351007     341288     208065      25611  IR-PCI-MSI-edge      enp175s0f0-TxRx-18</span><br><span class="line"> 564:          0          0          0          0          0          0          0          0     823889     835158     898125    1042075     479060     649698     488703     431781          0          0          0          0          0          0          0          0    3198859     368537     361450     268475     279292     335527     175329      21693  IR-PCI-MSI-edge      enp175s0f0-TxRx-19</span><br><span class="line"> 565:          0          0          0          0          0          0          0          0     676732    1450852    1388628     704602     644689     423264     404306     365596          0          0          0          0          0          0          0          0    3038526     391864     405727     263275     191222     248226     136003      21112  IR-PCI-MSI-edge      enp175s0f0-TxRx-20</span><br><span class="line"> 566:          0          0          0          0          0          0          0          0     566595    1175664    2031641     958319     714165     319767     349309     318957          0          0          0          0          0          0          0          0    2958683     218495     239817     214993     179935     191555     106269      22241  IR-PCI-MSI-edge      enp175s0f0-TxRx-21</span><br><span class="line"> 567:          0          0          0          0          0          0          0          0     832674    1176655    1652999     789321     736090     853359     748998     577413          0          0          0          0          0          0          0          0     498610     570634     823144     451361     350612     336046     200696      23342  IR-PCI-MSI-edge      enp175s0f0-TxRx-22</span><br><span class="line"> 568:          0          0          0          0          0          0          0          0     486851     946241    1375282     525162     582995     609945     696507     440446          0          0          0          0          0          0          0          0    2986687     390852     513487     317316     283314     320359     191080      21907  IR-PCI-MSI-edge      enp175s0f0-TxRx-23</span><br><span class="line"> 569:          0          0          0          0          0          0          0          0   51211317   79773036   82956204   46567489   42244838   62523416   34798214   31871168          0          0          0          0          0          0          0          0   89233552   34741833   45475248   56079776   44626874  112466556  127468577   26730942  IR-PCI-MSI-edge      enp175s0f0-TxRx-24</span><br><span class="line"> 570:          0          0          0          0          0          0          0          0   84554805   62689462  101496218   40518441   34792544  140921853   28422396   29428544          0          0          0          0          0          0          0          0   23860917   73164249   50084153   72011910   24525127  548979217  332764098   50908113  IR-PCI-MSI-edge      enp175s0f0-TxRx-25</span><br><span class="line"> 571:          0          0          0          0          0          0          0          0   69909137   55776777   94776131   63355410   42321451   74321693   45528982   50604702          0          0          0          0          0          0          0          0   56618040   31516738   58332108   69357737   20168247   58852410  137885013   28088790  IR-PCI-MSI-edge      enp175s0f0-TxRx-26</span><br><span class="line"> 572:          0          0          0          0          0          0          0          0   97305670   87729287   88586433   59983480   55828246   79305722   51064394   44409948          0          0          0          0          0          0          0          0   41248135   60491280   43010548   99696137   32513292   64373823   74114831   49645455  IR-PCI-MSI-edge      enp175s0f0-TxRx-27</span><br><span class="line"> 573:          0          0          0          0          0          0          0          0   72108897   76540055   69546704   69542158   46167801   57170600   48419068   58439907          0          0          0          0          0          0          0          0   68912196   27371642   58904860   82050006   79475074  107799031  109654468   81082896  IR-PCI-MSI-edge      enp175s0f0-TxRx-28</span><br><span class="line"> 574:          0          0          0          0          0          0          0          0   69014002   80647341   62399685   97216594   87591440  103529815   72314579   45731155          0          0          0          0          0          0          0          0   89557655   50919154   68754628  109583064   33891553   76526249  188283182   29596358  IR-PCI-MSI-edge      enp175s0f0-TxRx-29</span><br><span class="line"> 575:          0          0          0          0          0          0          0          0   70240109   84468547   61070305   57381753  122569467   76404910   51871561   47071056          0          0          0          0          0          0          0          0   97676445   22451436   44986642   93854970   51734947  141860090   97976950   63786565  IR-PCI-MSI-edge      enp175s0f0-TxRx-30</span><br><span class="line"> 576:          0          0          0          0          0          0          0          0   66395628   99188539   63355633   82424649  110498163  119343763  129927329   49811047          0          0          0          0          0          0          0          0   76096869   78511976   32199289  122850446  108523248   49641666  346741057  101551776  IR-PCI-MSI-edge      enp175s0f0-TxRx-31</span><br><span class="line"> 577:          0          0          0          0          0          0          0          0        307        422        349        309        268        317        222        167          0          0          0          0          0          0          0          0        139        126        215        193         95        182        231       7349  IR-PCI-MSI-edge      enp175s0f0</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190705111612.png" alt=""><br><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190705111633.png" alt=""><br><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190705111643.png" alt=""></p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://tech.meituan.com/2018/03/16/redis-high-concurrency-optimization.html" target="_blank" rel="noopener">Redis 高负载下的中断优化</a><br><a href="http://www.simlinux.com/2017/02/28/net-softirq.html" target="_blank" rel="noopener">网卡软中断过高问题优化总结</a><br><a href="https://ylgrgyq.github.io/2017/08/01/linux-receive-packet-3/" target="_blank" rel="noopener">Linux 网络协议栈收消息过程 - TCP Protocol Layer</a><br><a href="https://blog.packagecloud.io/eng/2016/06/22/monitoring-tuning-linux-networking-stack-receiving-data/#tuning-network-devices" target="_blank" rel="noopener">Monitoring and Tuning the Linux Networking Stack: Receiving Data</a><br><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/performance_tuning_guide/" target="_blank" rel="noopener">Performance Tuning Guide</a></p>]]></content>
    
    <summary type="html">
    
      RPS和RFS网卡多队列性能调优实践
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>使用 ELK(Elasticsearch + Logstash + Kibana) 搭建日志集中分析平台实践</title>
    <link href="https://wsgzao.github.io/post/elk/"/>
    <id>https://wsgzao.github.io/post/elk/</id>
    <published>2019-07-02T04:43:14.000Z</published>
    <updated>2019-07-05T03:34:23.125Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190705113413.png" alt=""></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Elasticsearch + Logstash + Kibana（ELK）是一套开源的日志管理方案，分析网站的访问情况时我们一般会借助 Google / 百度 / CNZZ 等方式嵌入 JS 做数据统计，但是当网站访问异常或者被攻击时我们需要在后台分析如 Nginx 的具体日志，而 Nginx 日志分割 / GoAccess/Awstats 都是相对简单的单节点解决方案，针对分布式集群或者数据量级较大时会显得心有余而力不足，而 ELK 的出现可以使我们从容面对新的挑战。</p><ul><li>Logstash：负责日志的收集，处理和储存</li><li>Elasticsearch：负责日志检索和分析</li><li>Kibana：负责日志的可视化</li></ul><blockquote><p>ELK(Elasticsearch + Logstash + Kibana) </p></blockquote><hr><h2 id="更新记录"><a href="#更新记录" class="headerlink" title="更新记录"></a>更新记录</h2><p>2019 年 07 月 02 日 - 转载同事整理的 ELK Stack 进行重构<br>2015 年 08 月 31 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/elk/">https://wsgzao.github.io/post/elk/</a></p><p><strong> 扩展阅读 </strong></p><p>elastic - <a href="https://www.elastic.co/cn/" target="_blank" rel="noopener">https://www.elastic.co/cn/</a><br>ELK - <a href="https://fainyang.github.io/post/elk/" target="_blank" rel="noopener">https://fainyang.github.io/post/elk/</a></p><hr><h2 id="ELK-简介"><a href="#ELK-简介" class="headerlink" title="ELK 简介"></a>ELK 简介</h2><p><a href="https://www.elastic.co/guide/index.html" target="_blank" rel="noopener">ELK 官方文档</a> 是一个分布式、可扩展、实时的搜索与数据分析引擎。目前我在工作中只用来收集 server 的 log, 开发锅锅们 debug 的好助手。</p><h2 id="安装设置单节点-ELK"><a href="#安装设置单节点-ELK" class="headerlink" title="安装设置单节点 ELK"></a>安装设置单节点 ELK</h2><p>如果你想快速的搭建单节点 ELK, 那么使用 docker 方式肯定是你的最佳选择。使用三合一的镜像，<a href="https://elk-docker.readthedocs.io/" target="_blank" rel="noopener">文档详情</a><br>注意：安装完 docker, 记得设置 <code>mmap counts</code> 大小至少 262144<br><a href="https://nieyong.github.io/wiki_cpu/mmap%E8%AF%A6%E8%A7%A3.html" target="_blank" rel="noopener">什么是 mmap</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置 mmap 命令</span></span><br><span class="line"><span class="comment"># 临时添加法</span></span><br><span class="line">sysctl -w vm.max_map_count=262144  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入 sysctl.conf 文件里</span></span><br><span class="line">vim /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line">vm.max_map_count=262144  </span><br><span class="line"><span class="comment"># 保存好文件执行以下命令</span></span><br><span class="line"></span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 docker</span></span><br><span class="line">sudo yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line"></span><br><span class="line">sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line">sudo yum install -y docker-ce</span><br><span class="line"></span><br><span class="line">sudo systemctl start docker</span><br></pre></td></tr></table></figure></p><p>单节点的机器，不必暴露 9200(Elasticsearch JSON interface) 和 9300(Elasticsearch transport interface) 端口。<br>如果想在 docker 上暴露端口，用 -p 如果没有填写监听的地址，默认是 0.0.0.0 所有的网卡。建议还是写明确监听的地址，安全性更好。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-p 监听的 IP: 宿主机端口: 容器内的端口</span><br><span class="line">-p 192.168.10.10:9300:9300</span><br></pre></td></tr></table></figure></p><h3 id="命令行启动一个-ELK"><a href="#命令行启动一个-ELK" class="headerlink" title="命令行启动一个 ELK"></a>命令行启动一个 ELK</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -p 5601:5601 -p 5044:5044 \</span><br><span class="line">-v /data/elk-data:/var/lib/elasticsearch  \</span><br><span class="line">-v /data/elk/logstash:/etc/logstash/conf.d  \</span><br><span class="line">-it -e TZ=<span class="string">"Asia/Singapore"</span> -e ES_HEAP_SIZE=<span class="string">"20g"</span>  \</span><br><span class="line">-e LS_HEAP_SIZE=<span class="string">"10g"</span> --name elk-ubuntu sebp/elk</span><br></pre></td></tr></table></figure><p>将配置和数据挂载出来，即使 docker container 出现了问题。可以立即销毁再重启一个，服务受影响的时间很短。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意挂载出来的文件夹的权限问题</span></span><br><span class="line">chmod 755 /data/elk-data </span><br><span class="line">chmod 755 /data/elk/logstash</span><br><span class="line">chown -R root:root /data </span><br><span class="line">-v /data/elk-data:/var/lib/elasticsearch   <span class="comment"># 将 elasticsearch 存储的数据挂载出来，数据持久化。</span></span><br><span class="line">-v /data/elk/logstash:/etc/logstash/conf.d <span class="comment"># 将 logstash 的配置文件挂载出来，方便在宿主机上修改。</span></span><br></pre></td></tr></table></figure></p><h3 id="elasticsearch-重要的参数调优"><a href="#elasticsearch-重要的参数调优" class="headerlink" title="elasticsearch 重要的参数调优"></a>elasticsearch 重要的参数调优</h3><ol><li>ES_HEAP_SIZE Elasticsearch will assign the entire heap specified in jvm.options via the Xms (minimum heap size) and Xmx (maximum heap size) settings. You should set these two settings to be equal to each other. Set Xmx and Xms to no more than 50% of your physical RAM.the exact threshold varies but is near 32 GB. the exact threshold varies but 26 GB is safe on most systems, but can be as large as 30 GB on some systems.<br>利弊关系: The more heap available to Elasticsearch, the more memory it can use for its internal caches, but the less memory it leaves available for the operating system to use for the filesystem cache. Also, larger heaps can cause longer garbage collection pauses.</li><li>LS_HEAP_SIZE 如果 heap size 过低，会导致 CPU 利用率到达瓶颈，造成 JVM 不断的回收垃圾。 不能设置 heap size 超过物理内存。 至少留 1G 给操作系统和其他的进程。</li></ol><h3 id="只需要配置-logstash"><a href="#只需要配置-logstash" class="headerlink" title="只需要配置 logstash"></a>只需要配置 logstash</h3><p>接下来，我们再来看一看 logstash.conf 记得看注释<br>参考链接:</p><ol><li><a href="https://documentation.wazuh.com/current/installation-guide/optional-configurations/elastic_ssl.html" target="_blank" rel="noopener">SSL 详情可参考</a></li><li><a href="https://doc.yonyoucloud.com/doc/logstash-best-practice-cn/filter/grok.html" target="_blank" rel="noopener">grok 正则捕获</a></li><li><a href="https://blog.csdn.net/qq_34021712/article/details/79746413" target="_blank" rel="noopener">grok 插件语法介绍</a></li><li><a href="http://www.ttlsa.com/elk/elk-logstash-configuration-syntax/" target="_blank" rel="noopener">logstash 配置语法</a></li><li><a href="https://github.com/logstash-plugins/logstash-patterns-core/tree/master/patterns" target="_blank" rel="noopener">grok 内置 pattern</a>  </li><li><a href="http://www.51niux.com/?id=205" target="_blank" rel="noopener">Logstash 详细记录</a></li></ol><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; <span class="number">5044</span></span><br><span class="line">    <span class="comment">#ssl =&gt; true</span></span><br><span class="line">    <span class="comment">#ssl_certificate =&gt; "/etc/logstash/logstash.crt"</span></span><br><span class="line">    <span class="comment">#ssl_key =&gt; "/etc/logstash/logstash.key"</span></span><br><span class="line"><span class="comment"># 1. SSL 详情可参考 </span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># filter 模块主要是数据预处理，提取一些信息，方便 elasticsearch 好归类存储。</span></span><br><span class="line"><span class="comment"># 2. grok 正则捕获 </span></span><br><span class="line"><span class="comment"># 3. grok 插件语法介绍 </span></span><br><span class="line"><span class="comment"># 4. logstash 配置语法 </span></span><br><span class="line"><span class="comment"># 5. grok 内置 pattern </span></span><br><span class="line">filter &#123;</span><br><span class="line">    grok &#123;  </span><br><span class="line">      match =&gt; &#123;<span class="string">"message"</span> =&gt; <span class="string">"%&#123;EXIM_DATE:timestamp&#125;\|%&#123;LOGLEVEL:log_level&#125;\|%&#123;INT:pid&#125;\|%&#123;GREEDYDATA&#125;"</span>&#125;</span><br><span class="line"><span class="comment"># message 字段是 log 的内容，例如 2018-12-11 23:46:47.051|DEBUG|3491|helper.py:85|helper._save_to_cache|shop_session</span></span><br><span class="line"><span class="comment"># 在这里我们提取出了 timestamp log_level pid，grok 有内置定义好的 patterns: EXIM_DATE, EXIM_DATE, INT</span></span><br><span class="line"><span class="comment"># GREEDYDATA 贪婪数据，代表任意字符都可以匹配 </span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment"># 我们在 filebeat 里面添加了这个字段[fields][function] 的话，那就会执行对应的 match 规则去匹配 path</span></span><br><span class="line"><span class="comment"># source 字段就是 log 的来源路径，例如 /var/log/nginx/feiyang233.club.access.log</span></span><br><span class="line"><span class="comment"># match 后我们就可以得到 path=feiyang233.club.access</span></span><br><span class="line">    <span class="keyword">if</span> [fields][function]==<span class="string">"nginx"</span> &#123;</span><br><span class="line">        grok &#123;         </span><br><span class="line">        match =&gt; &#123;<span class="string">"source"</span> =&gt; <span class="string">"/var/log/nginx/%&#123;GREEDYDATA:path&#125;.log%&#123;GREEDYDATA&#125;"</span>&#125;  </span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line"><span class="comment"># 例如 ims 日志来源是 /var/log/ims_logic/debug.log</span></span><br><span class="line"><span class="comment"># match 后我们就可以得到 path=ims_logic</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> [fields][function]==<span class="string">"ims"</span> &#123;</span><br><span class="line">        grok &#123;</span><br><span class="line">        match =&gt; &#123;<span class="string">"source"</span> =&gt; <span class="string">"/var/log/%&#123;GREEDYDATA:path&#125;/%&#123;GREEDYDATA&#125;"</span>&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        grok &#123;</span><br><span class="line">        match =&gt; &#123;<span class="string">"source"</span> =&gt; <span class="string">"/var/log/app/%&#123;GREEDYDATA:path&#125;/%&#123;GREEDYDATA&#125;"</span>&#125;</span><br><span class="line">            &#125;         </span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment"># filebeat 有定义 [fields][function] 时，我们就添加上这个字段，例如 QA</span></span><br><span class="line">    <span class="keyword">if</span> [fields][function] &#123;</span><br><span class="line">          mutate &#123;</span><br><span class="line">              add_field =&gt; &#123;</span><br><span class="line">                  <span class="string">"function"</span> =&gt; <span class="string">"%&#123;[fields][function]&#125;"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line"><span class="comment"># 因为线上的机器更多，线上的我默认不在 filebeat 添加 function，所以 else 我就添加上 live  </span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">          mutate &#123;</span><br><span class="line">              add_field =&gt; &#123;</span><br><span class="line">                  <span class="string">"function"</span> =&gt; <span class="string">"live"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment"># 在之前 filter message 时，我们得到了 timestamp，这里我们修改一下格式，添加上时区。</span></span><br><span class="line">    date &#123;</span><br><span class="line">      match =&gt; [<span class="string">"timestamp"</span> , <span class="string">"yyyy-MM-dd HH:mm:ss Z"</span>]</span><br><span class="line">      target =&gt; <span class="string">"@timestamp"</span></span><br><span class="line">      timezone =&gt; <span class="string">"Asia/Singapore"</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment"># 将之前获得的 path 替换其中的 / 替换为 - , 因为 elasticsearch index name 有要求</span></span><br><span class="line"><span class="comment"># 例如 feiyang/test  feiyang_test </span></span><br><span class="line">    mutate &#123;</span><br><span class="line">     gsub =&gt; [<span class="string">"path"</span>,<span class="string">"/"</span>,<span class="string">"-"</span>]</span><br><span class="line">      add_field =&gt; &#123;<span class="string">"host_ip"</span> =&gt; <span class="string">"%&#123;[fields][host]&#125;"</span>&#125;</span><br><span class="line">      remove_field =&gt; [<span class="string">"tags"</span>,<span class="string">"@version"</span>,<span class="string">"offset"</span>,<span class="string">"beat"</span>,<span class="string">"fields"</span>,<span class="string">"exim_year"</span>,<span class="string">"exim_month"</span>,<span class="string">"exim_day"</span>,<span class="string">"exim_time"</span>,<span class="string">"timestamp"</span>]</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment"># remove_field 去掉一些多余的字段</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 单节点 output 就在本机，也不需要 SSL, 但 index 的命名规则还是需要非常的注意</span></span><br><span class="line">output &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [<span class="string">"localhost:9200"</span>]</span><br><span class="line">    index =&gt; <span class="string">"sg-%&#123;function&#125;-%&#123;path&#125;-%&#123;+xxxx.ww&#125;"</span></span><br><span class="line"><span class="comment"># sg-nginx-feiyang233.club.access-2019.13  ww 代表周数</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最终的流程图如下所示<br><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190703115737.png" alt=""><br>index 的规则 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.4/indices-create-index.html" target="_blank" rel="noopener">参考链接</a></p><ul><li>Lowercase only</li><li>Cannot include \, /, *, ?, “, &lt;, &gt;, |, ` ` (space character), ,, #</li><li>Indices prior to 7.0 could contain a colon (:), but that’s been deprecated and won’t be supported in 7.0+</li><li>Cannot start with -, _, +</li><li>Cannot be . or ..</li><li>Cannot be longer than 255 bytes (note it is bytes, so multi-byte characters will count towards the 255 limit faster)</li></ul><h3 id="filebeat-配置"><a href="#filebeat-配置" class="headerlink" title="filebeat 配置"></a>filebeat 配置</h3><p>在 client 端，我们需要安装并且配置 filebeat <a href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-installation.html" target="_blank" rel="noopener">请参考</a><br><a href="https://www.imooc.com/article/70007" target="_blank" rel="noopener">Filebeat 模块与配置</a><br>配置文件 filebeat.yml<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">filebeat.inputs:</span></span><br><span class="line"><span class="attr">- type:</span> <span class="string">log</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  paths:</span> <span class="comment"># 需要收集的日志</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/var/log/app/**</span>  <span class="comment">## ** need high versiob filebeat can support recursive</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  fields:</span> <span class="comment"># 需要添加的字段</span></span><br><span class="line"><span class="attr">    host:</span> <span class="string">"<span class="template-variable">&#123;&#123;inventory_hostname&#125;&#125;</span>"</span> </span><br><span class="line"><span class="attr">    function:</span> <span class="string">"xxx"</span></span><br><span class="line"><span class="attr">  multiline:</span>  <span class="comment"># 多行匹配</span></span><br><span class="line"><span class="attr">    match:</span> <span class="string">after</span></span><br><span class="line"><span class="attr">    negate:</span> <span class="literal">true</span>  <span class="comment"># pay attention the format</span></span><br><span class="line"><span class="attr">    pattern:</span> <span class="string">'^\[[0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125;'</span>   <span class="comment">#\[</span></span><br><span class="line"><span class="attr">  ignore_older:</span> <span class="number">24</span><span class="string">h</span></span><br><span class="line"><span class="attr">  clean_inactive:</span> <span class="number">72</span><span class="string">h</span></span><br><span class="line"></span><br><span class="line"><span class="string">output.logstash:</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">["&#123;&#123;elk_server&#125;&#125;:25044"]</span></span><br><span class="line">  <span class="comment"># ssl:</span></span><br><span class="line">  <span class="comment">#   certificate_authorities: ["/etc/filebeat/logstash.crt"]</span></span><br></pre></td></tr></table></figure></p><p>批量部署 filebeat.yml 最好使用 ansible<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  become:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  gather_facts:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">stop</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">    service:</span> </span><br><span class="line"><span class="attr">      name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">      state:</span> <span class="string">stopped</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">yes</span></span><br><span class="line">      </span><br><span class="line"><span class="attr">  - name:</span> <span class="string">upload</span> <span class="string">filebeat.yml</span> </span><br><span class="line"><span class="attr">    template:</span></span><br><span class="line"><span class="attr">     src:</span> <span class="string">filebeat.yml</span></span><br><span class="line"><span class="attr">     dest:</span> <span class="string">/etc/filebeat/filebeat.yml</span></span><br><span class="line"><span class="attr">     owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">     group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">     mode:</span> <span class="number">0644</span>      </span><br><span class="line"></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">remove</span></span><br><span class="line"><span class="attr">    file:</span> <span class="comment">#delete all files in this directory</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/var/lib/filebeat/registry</span>    </span><br><span class="line"><span class="attr">      state:</span> <span class="string">absent</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">restart</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">    service:</span> </span><br><span class="line"><span class="attr">      name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">      state:</span> <span class="string">restarted</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure></p><h3 id="查看-filebeat-output"><a href="#查看-filebeat-output" class="headerlink" title="查看 filebeat output"></a>查看 filebeat output</h3><p>首先需要修改配置，将 filebeat 输出到本地的文件，输出的格式为 json.<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">filebeat.inputs:</span></span><br><span class="line"><span class="attr">- type:</span> <span class="string">log</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  paths:</span></span><br><span class="line"><span class="bullet">     -</span> <span class="string">/var/log/app/**</span></span><br><span class="line"><span class="attr">  fields:</span></span><br><span class="line"><span class="attr">    host:</span> <span class="string">"x.x.x.x"</span></span><br><span class="line"><span class="attr">    region:</span> <span class="string">"sg"</span></span><br><span class="line"><span class="attr">  multiline:</span></span><br><span class="line"><span class="attr">    match:</span> <span class="string">after</span></span><br><span class="line"><span class="attr">    negate:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    pattern:</span> <span class="string">'^[0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125;'</span></span><br><span class="line"><span class="attr">  ignore_older:</span> <span class="number">24</span><span class="string">h</span></span><br><span class="line"><span class="attr">  clean_inactive:</span> <span class="number">72</span><span class="string">h</span></span><br><span class="line"></span><br><span class="line"><span class="string">output.file:</span></span><br><span class="line"><span class="attr"> path:</span> <span class="string">"/home/feiyang"</span></span><br><span class="line"><span class="attr">  filename:</span> <span class="string">feiyang.json</span></span><br></pre></td></tr></table></figure></p><p>通过上述的配置，我们就可以在路径 /home/feiyang 下得到输出结果文件 feiyang.json 在这里需要注意的是，不同版本的 filebeat 输出结果的格式会有所不同，这会给 logstash 解析过滤造成一点点困难。下面举例说明 6.x 和 7.x filebeat 输出结果的不同</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"@timestamp"</span>: <span class="string">"2019-06-27T15:53:27.682Z"</span>,</span><br><span class="line">  <span class="attr">"@metadata"</span>: &#123;</span><br><span class="line">    <span class="attr">"beat"</span>: <span class="string">"filebeat"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"doc"</span>,</span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"6.4.2"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"fields"</span>: &#123;</span><br><span class="line">    <span class="attr">"host"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">    <span class="attr">"region"</span>: <span class="string">"sg"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"host"</span>: &#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"x.x.x.x"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"beat"</span>: &#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">    <span class="attr">"hostname"</span>: <span class="string">"feiyang-localhost"</span>,</span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"6.4.2"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"offset"</span>: <span class="number">1567983499</span>,</span><br><span class="line">  <span class="attr">"message"</span>: <span class="string">"[2019-06-27T22:53:25.756327232][Info][@http.go.177] [48552188]request"</span>,</span><br><span class="line">  <span class="attr">"source"</span>: <span class="string">"/var/log/feiyang/scripts/all.log"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>6.4 与 7.2 还是有很大的差异，在结构上。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"@timestamp"</span>: <span class="string">"2019-06-27T15:41:42.991Z"</span>,</span><br><span class="line">  <span class="attr">"@metadata"</span>: &#123;</span><br><span class="line">    <span class="attr">"beat"</span>: <span class="string">"filebeat"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"7.2.0"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"agent"</span>: &#123;</span><br><span class="line">    <span class="attr">"id"</span>: <span class="string">"3a38567b-e6c3-4b5a-a420-f0dee3a3bec8"</span>,</span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"7.2.0"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"filebeat"</span>,</span><br><span class="line">    <span class="attr">"ephemeral_id"</span>: <span class="string">"b7e3c0b7-b460-4e43-a9af-6d36c25eece7"</span>,</span><br><span class="line">    <span class="attr">"hostname"</span>: <span class="string">"feiyang-localhost"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"log"</span>: &#123;</span><br><span class="line">    <span class="attr">"offset"</span>: <span class="number">69132192</span>,</span><br><span class="line">    <span class="attr">"file"</span>: &#123;</span><br><span class="line">      <span class="attr">"path"</span>: <span class="string">"/var/log/app/feiyang/scripts/info.log"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"message"</span>: <span class="string">"2019-06-27 22:41:25.312|WARNING|14186|Option|data|unrecognized|fields=set([u'id'])"</span>,</span><br><span class="line">  <span class="attr">"input"</span>: &#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"log"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"fields"</span>: &#123;</span><br><span class="line">    <span class="attr">"region"</span>: <span class="string">"sg"</span>,</span><br><span class="line">    <span class="attr">"host"</span>: <span class="string">"x.x.x.x"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"ecs"</span>: &#123;</span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"1.0.0"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"host"</span>: &#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"feiyang-localhost"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Kibana-简单的使用"><a href="#Kibana-简单的使用" class="headerlink" title="Kibana 简单的使用"></a>Kibana 简单的使用</h3><p>在搭建 ELK 时，暴露出来的 5601 端口就是 Kibana 的服务。<br>访问 <a href="http://your_elk_ip:5601" target="_blank" rel="noopener">http://your_elk_ip:5601</a><br><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190703115809.png" alt=""></p><h2 id="安装设置集群-ELK-版本-6-7"><a href="#安装设置集群-ELK-版本-6-7" class="headerlink" title="安装设置集群 ELK 版本 6.7"></a>安装设置集群 ELK 版本 6.7</h2><p><a href="https://www.elastic.co/guide/en/elastic-stack/current/installing-elastic-stack.html" target="_blank" rel="noopener">ELK 安装文档</a>集群主要是高可用，多节点的 Elasticsearch 还可以扩容。本文中用的官方镜像 The base image is <a href="https://hub.docker.com/_/centos/" target="_blank" rel="noopener">centos:7</a></p><h3 id="Elasticsearch-多节点搭建"><a href="#Elasticsearch-多节点搭建" class="headerlink" title="Elasticsearch 多节点搭建"></a>Elasticsearch 多节点搭建</h3><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.7/docker.html" target="_blank" rel="noopener">官方安装文档 Elasticsearch</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 挂载出来的文件夹权限非常的重要</span></span><br><span class="line">mkdir -p /data/elk-data &amp;&amp; chmod 755 /data/elk-data</span><br><span class="line">chown -R root:root /data </span><br><span class="line">docker run -p WAN_IP:9200:9200 -p 10.66.236.116:9300:9300 \</span><br><span class="line">-v /data/elk-data:/usr/share/elasticsearch/data \</span><br><span class="line">--name feiy_elk \</span><br><span class="line">docker.elastic.co/elasticsearch/elasticsearch:6.7.0</span><br></pre></td></tr></table></figure></p><p>接下来是修改配置文件 elasticsearch.yml<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Master 节点 node-1</span></span><br><span class="line"><span class="comment"># 进入容器 docker exec -it [container_id] bash</span></span><br><span class="line"><span class="comment"># docker exec -it 70ada825aae1 bash</span></span><br><span class="line"><span class="comment"># vi /usr/share/elasticsearch/config/elasticsearch.yml</span></span><br><span class="line"><span class="string">cluster.name:</span> <span class="string">"feiy_elk"</span></span><br><span class="line"><span class="string">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="string">node.master:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">node.data:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">node.name:</span> <span class="string">node-1</span></span><br><span class="line"><span class="string">network.publish_host:</span> <span class="number">10.66</span><span class="number">.236</span><span class="number">.116</span></span><br><span class="line"><span class="string">discovery.zen.ping.unicast.hosts:</span> <span class="string">["10.66.236.116:9300","10.66.236.118:9300","10.66.236.115:9300"]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># exit</span></span><br><span class="line"><span class="comment"># docker restart  70ada825aae1</span></span><br></pre></td></tr></table></figure></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># slave 节点 node-2</span></span><br><span class="line"><span class="comment"># 进入容器 docker exec -it [container_id] bash</span></span><br><span class="line"><span class="comment"># vi /usr/share/elasticsearch/config/elasticsearch.yml</span></span><br><span class="line"><span class="string">cluster.name:</span> <span class="string">"feiy_elk"</span></span><br><span class="line"><span class="string">network.host:</span> <span class="string">"0.0.0.0"</span></span><br><span class="line"><span class="string">node.name:</span> <span class="string">node-2</span></span><br><span class="line"><span class="string">node.data:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">network.publish_host:</span> <span class="number">10.66</span><span class="number">.236</span><span class="number">.118</span></span><br><span class="line"><span class="string">discovery.zen.ping.unicast.hosts:</span> <span class="string">["10.66.236.116:9300","10.66.236.118:9300","10.66.236.115:9300"]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># exit</span></span><br><span class="line"><span class="comment"># docker restart  70ada825aae1</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># slave 节点 node-3</span></span><br><span class="line"><span class="comment"># 进入容器 docker exec -it [container_id] bash</span></span><br><span class="line"><span class="comment"># vi /usr/share/elasticsearch/config/elasticsearch.yml</span></span><br><span class="line"><span class="string">cluster.name:</span> <span class="string">"feiy_elk"</span></span><br><span class="line"><span class="string">network.host:</span> <span class="string">"0.0.0.0"</span></span><br><span class="line"><span class="string">node.name:</span> <span class="string">node-3</span></span><br><span class="line"><span class="string">node.data:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">network.publish_host:</span> <span class="number">10.66</span><span class="number">.236</span><span class="number">.115</span></span><br><span class="line"><span class="string">discovery.zen.ping.unicast.hosts:</span> <span class="string">["10.66.236.116:9300","10.66.236.118:9300","10.66.236.115:9300"]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># exit</span></span><br><span class="line"><span class="comment"># docker restart  70ada825aae1</span></span><br></pre></td></tr></table></figure><p>检查集群节点个数，状态等<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># curl http://wan_ip:9200/_cluster/health?pretty</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"feiy_elk"</span>,</span><br><span class="line">  <span class="string">"status"</span> : <span class="string">"green"</span>,</span><br><span class="line">  <span class="string">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"number_of_nodes"</span> : 3,</span><br><span class="line">  <span class="string">"number_of_data_nodes"</span> : 3,</span><br><span class="line">  <span class="string">"active_primary_shards"</span> : 9,</span><br><span class="line">  <span class="string">"active_shards"</span> : 18,</span><br><span class="line">  <span class="string">"relocating_shards"</span> : 0,</span><br><span class="line">  <span class="string">"initializing_shards"</span> : 0,</span><br><span class="line">  <span class="string">"unassigned_shards"</span> : 0,</span><br><span class="line">  <span class="string">"delayed_unassigned_shards"</span> : 0,</span><br><span class="line">  <span class="string">"number_of_pending_tasks"</span> : 0,</span><br><span class="line">  <span class="string">"number_of_in_flight_fetch"</span> : 0,</span><br><span class="line">  <span class="string">"task_max_waiting_in_queue_millis"</span> : 0,</span><br><span class="line">  <span class="string">"active_shards_percent_as_number"</span> : 100.0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>最终结果图在 kibana 上可以看到集群状态<br><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190703115910.png" alt=""></p><h3 id="Kibana-搭建"><a href="#Kibana-搭建" class="headerlink" title="Kibana 搭建"></a>Kibana 搭建</h3><p><a href="https://www.elastic.co/guide/en/kibana/6.7/docker.html" target="_blank" rel="noopener">官方安装文档  Kibana</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker run --link YOUR_ELASTICSEARCH_CONTAINER_NAME_OR_ID:elasticsearch -p 5601:5601 &#123;docker-repo&#125;:&#123;version&#125;</span></span><br><span class="line">docker run -p 外网 IP:5601:5601 --link elasticsearch 容器的 ID:elasticsearch docker.elastic.co/kibana/kibana:6.7.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意的是 --link 官方其实并不推荐的，推荐的是 use user-defined networks https://docs.docker.com/network/links/</span></span><br><span class="line"><span class="comment"># 测试不用 --link 也可以通。直接用容器的 IP</span></span><br><span class="line">docker run -p 外网 IP:5601:5601  docker.elastic.co/kibana/kibana:6.7.0</span><br></pre></td></tr></table></figure></p><p>we recommend that you use user-defined networks to facilitate communication between two containers instead of using –<a href="https://docs.docker.com/network/links/" target="_blank" rel="noopener">link</a></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /usr/share/kibana/config/kibana.yml</span></span><br><span class="line"><span class="comment"># 需要把 hosts IP 改为 elasticsearch 容器的 IP</span></span><br><span class="line"><span class="comment"># 我这里 elasticsearch 容器的 IP 是 172.17.0.2</span></span><br><span class="line"><span class="comment"># 如何查看 docker inspect elasticsearch_ID</span></span><br><span class="line"><span class="string">server.name:</span> <span class="string">kibana</span></span><br><span class="line"><span class="string">server.host:</span> <span class="string">"0.0.0.0"</span></span><br><span class="line"><span class="string">elasticsearch.hosts:</span> <span class="string">[</span> <span class="string">"http://172.17.0.2:9200"</span> <span class="string">]</span></span><br><span class="line"><span class="string">xpack.monitoring.ui.container.elasticsearch.enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 退出容器并重启</span></span><br><span class="line"><span class="string">docker</span> <span class="string">restart</span> <span class="string">[container_ID]</span></span><br></pre></td></tr></table></figure><h3 id="Logstash-搭建"><a href="#Logstash-搭建" class="headerlink" title="Logstash 搭建"></a>Logstash 搭建</h3><p>官方安装文档 <a href="https://www.elastic.co/guide/en/logstash/6.7/docker.html" target="_blank" rel="noopener">Logstash</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker -d 以后台的方式启动容器  --name 参数显式地为容器命名</span></span><br><span class="line">docker run -p 5044:5044 -d --name test_logstash  docker.elastic.co/logstash/logstash:6.7.0</span><br><span class="line"><span class="comment"># 也可以指定网卡，监听在内网或者外网 监听在内网 192.168.1.2</span></span><br><span class="line">docker run -p 192.168.1.2:5044:5044 -d --name test_logstash  docker.elastic.co/logstash/logstash:6.7.0</span><br></pre></td></tr></table></figure></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /usr/share/logstash/pipeline/logstash.conf</span></span><br><span class="line"><span class="comment"># 配置详情请参考下面的链接, 记得 output hosts IP 指向 Elasticsearch 的 IP</span></span><br><span class="line"><span class="comment"># Elasticsearch 的默认端口是 9200，在下面的配置中可以省略。</span></span><br><span class="line">hosts =&gt; [<span class="string">"IP Address 1:port1"</span>, <span class="string">"IP Address 2:port2"</span>, <span class="string">"IP Address 3"</span>]</span><br></pre></td></tr></table></figure><p><a href="# 只需要配置 logstash">logstash 过滤规则</a> 见上文的配置和 grok 语法规则<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /usr/share/logstash/config/logstash.yml</span></span><br><span class="line"><span class="comment"># 需要把 url 改为 elasticsearch master 节点的 IP</span></span><br><span class="line"><span class="string">http.host:</span> <span class="string">"0.0.0.0"</span></span><br><span class="line"><span class="string">xpack.monitoring.elasticsearch.url:</span> <span class="attr">http://elasticsearch_master_IP:9200</span></span><br><span class="line"><span class="string">node.name:</span> <span class="string">"feiy"</span></span><br><span class="line"><span class="string">pipeline.workers:</span> <span class="number">24</span> <span class="comment"># same with cores</span></span><br></pre></td></tr></table></figure></p><p>改完配置 exit 从容器里退出到宿主机，然后重启这个容器。更多配置详情，参见<a href="https://www.elastic.co/guide/en/logstash/current/logstash-settings-file.html" target="_blank" rel="noopener">官方文档</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如何查看 container_ID</span></span><br><span class="line">docker ps -a</span><br><span class="line"></span><br><span class="line">docker restart [container_ID]</span><br></pre></td></tr></table></figure></p><h3 id="容灾测试"><a href="#容灾测试" class="headerlink" title="容灾测试"></a>容灾测试</h3><p>我们把当前的 master 节点 node-1 关机，通过 kibana 看看集群的状态是怎样变化的。<br><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190703115946.png" alt=""><br>当前集群的状态变成了黄色，因为还有 3 个 Unassigned Shards。颜色含义请参考<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/_cluster_health.html" target="_blank" rel="noopener">官方文档</a>，再过一会发现集群状态变成了绿色。<br><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190703120000.png" alt=""></p><h2 id="kibana-控制台-Console"><a href="#kibana-控制台-Console" class="headerlink" title="kibana 控制台 Console"></a>kibana 控制台 Console</h2><p><strong>Quick intro to the UI</strong><br>The Console UI is split into two panes: an editor pane (left) and a response pane (right). Use the editor to type requests and submit them to Elasticsearch. The results will be displayed in the response pane on the right side.  </p><p>Console understands requests in a compact format, similar to cURL:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># index a doc</span></span><br><span class="line">PUT index/type/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"body"</span>: <span class="string">"here"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># and get it ...</span></span><br><span class="line">GET index/type/<span class="number">1</span></span><br></pre></td></tr></table></figure></p><p>While typing a request, Console will make suggestions which you can then accept by hitting Enter/Tab. These suggestions are made based on the request structure as well as your indices and types.  </p><p><strong>A few quick tips, while I have your attention</strong>   </p><ul><li>Submit requests to ES using the green triangle button.</li><li>Use the wrench menu for other useful things.</li><li>You can paste requests in cURL format and they will be translated to the Console syntax.</li><li>You can resize the editor and output panes by dragging the separator between them.</li><li>Study the keyboard shortcuts under the Help button. Good stuff in there!  </li></ul><h3 id="Console-常用的命令"><a href="#Console-常用的命令" class="headerlink" title="Console 常用的命令"></a>Console 常用的命令</h3><p><a href="https://www.elastic.co/guide/cn/kibana/current/console-kibana.html" target="_blank" rel="noopener">Kibana 控制台</a><br><a href="https://segmentfault.com/a/1190000015654154" target="_blank" rel="noopener">ELK 技术栈中的那些查询语法</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">GET _search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /_cat/health?v</span><br><span class="line"></span><br><span class="line">GET /_cat/nodes?v</span><br><span class="line"></span><br><span class="line">GET /_cluster/allocation/explain</span><br><span class="line"></span><br><span class="line">GET /_cluster/state</span><br><span class="line"></span><br><span class="line">GET /_cat/thread_pool?v</span><br><span class="line"></span><br><span class="line">GET /_cat/indices?health=red&amp;v</span><br><span class="line"></span><br><span class="line">GET /_cat/indices?v</span><br><span class="line"></span><br><span class="line"># 将当前所有的 index 的 replicas 设置为 0</span><br><span class="line"></span><br><span class="line">PUT /*/_settings</span><br><span class="line">&#123;</span><br><span class="line">   &quot;index&quot; : &#123;</span><br><span class="line">       &quot;number_of_replicas&quot; : 0,</span><br><span class="line">       &quot;refresh_interval&quot;: &quot;30s&quot;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /_template</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 在单节点的时候，不需要备份，所以将 replicas 设置为 0</span><br><span class="line">PUT _template/app-logstash</span><br><span class="line">&#123;</span><br><span class="line"> &quot;index_patterns&quot;: [&quot;app-*&quot;],</span><br><span class="line"> &quot;settings&quot;: &#123;</span><br><span class="line">   &quot;number_of_shards&quot;: 3,</span><br><span class="line">   &quot;number_of_replicas&quot;: 0,</span><br><span class="line">   &quot;refresh_interval&quot;: &quot;30s&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="Elasticsearch-数据迁移"><a href="#Elasticsearch-数据迁移" class="headerlink" title="Elasticsearch 数据迁移"></a>Elasticsearch 数据迁移</h2><p><a href="https://www.elastic.co/guide/en/cloud/current/ec-migrate-data.html" target="_blank" rel="noopener">Elasticsearch 数据迁移官方文档</a>感觉不是很详细。容器化的数据迁移，我太菜用 reindex 失败了，snapshot 也凉凉。<br>最后是用一个开源工具 <a href="https://github.com/medcl/esm-abandoned" target="_blank" rel="noopener">An Elasticsearch Migration Tool</a> 进行数据迁移的。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/medcl/esm-abandoned/releases/download/v0.4.2/linux64.tar.gz</span><br><span class="line">tar -xzvf linux64.tar.gz</span><br><span class="line">./esm  -s http://127.0.0.1:9200   -d http://192.168.21.55:9200 -x index_name  -w=5 -b=10 -c 10000 --copy_settings --copy_mappings --force  --refresh</span><br></pre></td></tr></table></figure><h2 id="Nginx-代理转发"><a href="#Nginx-代理转发" class="headerlink" title="Nginx 代理转发"></a>Nginx 代理转发</h2><p>因为有时候 docker 重启，iptables restart 也会刷新，所以导致了我们的限制规则会被更改，出现安全问题。这是由于 docker 的网络隔离基于 iptable 实现造成的问题。为了避免这个安全问题，我们可以在启动 docker 时，就只监听在内网，或者本地 127.0.0.1 然后通过 nginx 转发。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># cat kibana.conf</span><br><span class="line">server &#123;</span><br><span class="line"></span><br><span class="line">    listen 25601;</span><br><span class="line">    server_name x.x.x.x;</span><br><span class="line">    access_log /var/log/nginx/kibana.access.log;</span><br><span class="line">    error_log /var/log/nginx/kibana.error.log;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        allow x.x.x.x;</span><br><span class="line">        allow x.x.x.x;</span><br><span class="line">        deny all;</span><br><span class="line"></span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_buffer_size 64k;</span><br><span class="line">        proxy_buffers   32 32k;</span><br><span class="line">        proxy_busy_buffers_size 128k;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP       $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For  $proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">        proxy_pass    http://127.0.0.1:5601;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>! 这里需要注意的是， iptable filter 表 INPUT 链 有没有阻挡 172.17.0.0/16  docker 默认的网段。是否阻挡了 25601 这个端口。</p><h2 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h2><ul><li>iptables 防不住。需要看 <a href="/post/network/">上一篇博客</a> 里的 iptable 问题。或者监听在内网，用 Nginx 代理转发。</li><li>elk <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html" target="_blank" rel="noopener">网络问题</a> </li><li>elk <a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.7/modules-node.html" target="_blank" rel="noopener">node</a></li><li><code>discovery.type=single-node</code> 在测试单点时可用，搭建集群时不能设置这个环境变量，详情见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.7/bootstrap-checks.html#single-node-discovery" target="_blank" rel="noopener">官方文档</a></li><li>ELK 的一次<a href="https://www.leiyawu.com/2018/04/03/elk/" target="_blank" rel="noopener">吞吐量优化</a></li><li><p>filebeat 版本过低导致 recursive glob patterns <a href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-log.html#recursive_glob" target="_blank" rel="noopener">**</a> 不可用<br>用 ansible 升级 filebeat</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  become:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  gather_facts:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">upload</span> <span class="string">filebeat.repo</span> </span><br><span class="line"><span class="attr">    copy:</span></span><br><span class="line"><span class="attr">     src:</span> <span class="string">elasticsearch.repo</span></span><br><span class="line"><span class="attr">     dest:</span> <span class="string">/etc/yum.repos.d/elasticsearch.repo</span></span><br><span class="line"><span class="attr">     owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">     group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">     mode:</span> <span class="number">0644</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">install</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span> <span class="string">of</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">    yum:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">      state:</span> <span class="string">latest</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">restart</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">    service:</span> </span><br><span class="line"><span class="attr">      name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">      state:</span> <span class="string">restarted</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">yes</span></span><br><span class="line">      </span><br><span class="line"><span class="comment"># elasticsearch.repo</span></span><br><span class="line"><span class="string">[elasticsearch-6.x]</span></span><br><span class="line"><span class="string">name=Elasticsearch</span> <span class="string">repository</span> <span class="string">for</span> <span class="number">6.</span><span class="string">x</span> <span class="string">packages</span></span><br><span class="line"><span class="string">baseurl=https://artifacts.elastic.co/packages/6.x/yum</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">autorefresh=1</span></span><br><span class="line"><span class="string">type=rpm-md</span></span><br></pre></td></tr></table></figure></li><li><p>filebeat 7.x 与 6.x 不兼容问题. 关键字变化很大, 比如说 “sorce” 变为了 [log][file][path]</p></li></ul><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><ol><li><a href="https://cloud.tencent.com/developer/column/4008" target="_blank" rel="noopener">腾讯云 Elasticsearch Service</a> 这个腾讯云的专栏非常的不错，请您一定要点开看一眼，总有你想要的。  </li><li><a href="https://www.cnblogs.com/along21/p/8613115.html" target="_blank" rel="noopener">ELK 重难点总结和整体优化配置</a></li></ol>]]></content>
    
    <summary type="html">
    
      ELK(Elasticsearch + Logstash + Kibana)
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>mpstat 使用介绍和输出参数详解</title>
    <link href="https://wsgzao.github.io/post/mpstat/"/>
    <id>https://wsgzao.github.io/post/mpstat/</id>
    <published>2019-06-29T06:59:49.000Z</published>
    <updated>2019-07-04T11:20:29.168Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>mpstat 相比 top 来说使用频率未必很高，甚至还可能略低于 vmstat，top 进入交互式界面后，按 1 显示所有 cpu 的负载，结果和 mpstat 基本一致，本文对 mpstat 使用做下简单的记录，方便回顾输出参数的含义。</p><blockquote><p>mpstat 使用介绍和输出参数详解</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 06 月 29 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/mpstat/">https://wsgzao.github.io/post/mpstat/</a></p><p><strong> 扩展阅读 </strong></p><hr><h2 id="mpstat-简介"><a href="#mpstat-简介" class="headerlink" title="mpstat 简介"></a>mpstat 简介</h2><p>mpstat 是 Multiprocessor Statistics 的缩写，是实时系统监控工具。其报告与 CPU 的一些统计信息，这些信息存放在 /proc/stat 文件中。在多 CPU 系统里，其不但能查看所有 CPU 的平均状况信息，而且能够查看特定 CPU 的信息。</p><h2 id="mpstat-语法"><a href="#mpstat-语法" class="headerlink" title="mpstat 语法"></a>mpstat 语法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># mpstat 属于 sysstat</span><br><span class="line">yum provides mpstat</span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * base: mirror.vodien.com</span><br><span class="line"> * epel: download.nus.edu.sg</span><br><span class="line"> * extras: mirror.vodien.com</span><br><span class="line"> * updates: mirror.vodien.com</span><br><span class="line">sysstat-10.1.5-17.el7.x86_64 : Collection of performance monitoring tools for Linux</span><br><span class="line">Repo        : base</span><br><span class="line">Matched from:</span><br><span class="line">Filename    : /usr/bin/mpstat</span><br><span class="line"></span><br><span class="line">sysstat-10.1.5-17.el7.x86_64 : Collection of performance monitoring tools for Linux</span><br><span class="line">Repo        : @base</span><br><span class="line">Matched from:</span><br><span class="line">Filename    : /bin/mpstat</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mpstat [-P &#123;cpu|ALL&#125;] [internal [count]]</span><br></pre></td></tr></table></figure><p>其中，各参数含义如下：</p><table><thead><tr><th>参数</th><th>含义</th></tr></thead><tbody><tr><td>-P {cpu l ALL}</td><td>表示监控哪个 CPU， cpu 在 [0,cpu 个数 - 1] 中取值</td></tr><tr><td>internal</td><td>相邻的两次采样的间隔时间</td></tr><tr><td>count</td><td>采样的次数，count 只能和 delay 一起使用</td></tr></tbody></table><h2 id="使用-mpstat-命令"><a href="#使用-mpstat-命令" class="headerlink" title="使用 mpstat 命令"></a>使用 mpstat 命令</h2><p><strong>1. 直接使用 mpstat 命令：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mpstat</span><br><span class="line"></span><br><span class="line">Linux 3.10.0-862.el7.x86_64 07/04/2019 _x86_64_(32 CPU)</span><br><span class="line"></span><br><span class="line">11:45:19 AM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle</span><br><span class="line">11:45:19 AM  all    0.39    0.00    0.19    0.00    0.00    0.03    0.00    0.00    0.00   99.39</span><br></pre></td></tr></table></figure><p>当 mpstat 不带参数时，输出为从系统启动以来的平均值。</p><p><strong>2. 使用 mpstat -P ALL 5 2 命令 </strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mpstat -P ALL 5 2</span><br><span class="line"></span><br><span class="line">Linux 3.10.0-862.el7.x86_64 07/04/2019 _x86_64_(32 CPU)</span><br><span class="line"></span><br><span class="line">11:44:11 AM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle</span><br><span class="line">11:44:16 AM  all    0.38    0.00    0.21    0.00    0.00    0.03    0.00    0.00    0.00   99.38</span><br><span class="line">11:44:16 AM    0    0.20    0.00    0.20    0.00    0.00    0.00    0.00    0.00    0.00   99.60</span><br><span class="line">11:44:16 AM    1    0.20    0.00    0.20    0.00    0.00    0.00    0.00    0.00    0.00   99.60</span><br></pre></td></tr></table></figure><p>表示每 5 秒产生一个报告，总共产生 2 个。</p><p>上图表示每 5 秒产生了 2 个关于处理器的统计数据报告，一共产生 2 个 interval 的信息，然后再给出这 2 个 interval 的平均信息。默认时，输出是按照 CPU 号排序。第一个行给出了从系统引导以来的所有活跃数据。接下来每行对应一个处理器的活跃状态。</p><h2 id="输出参数含义"><a href="#输出参数含义" class="headerlink" title="输出参数含义"></a>输出参数含义</h2><p>当没有参数时，mpstat 则显示系统启动以后所有信息的平均值。有 interval 时，第一行的信息自系统启动以来的平均信息。从第二行开始，输出为前一个 interval 时间段的平均信息。</p><p>输出各参数含义：</p><table><thead><tr><th>参数</th><th>释义</th><th>从 /proc/stat 获得数据</th></tr></thead><tbody><tr><td>CPU</td><td>处理器 ID</td><td></td></tr><tr><td>%usr</td><td>在 internal 时间段里，用户态的 CPU 时间（%），不包含 nice 值为负进程</td><td>usr/total*100</td></tr><tr><td>%nice</td><td>在 internal 时间段里，nice 值为负进程的 CPU 时间（%）</td><td>nice/total*100</td></tr><tr><td>%sys</td><td>在 internal 时间段里，核心时间（%）</td><td>system/total*100</td></tr><tr><td>%iowait</td><td>在 internal 时间段里，硬盘 IO 等待时间（%）</td><td>iowait/total*100</td></tr><tr><td>%irq</td><td>在 internal 时间段里，硬中断时间（%）</td><td>irq/total*100</td></tr><tr><td>%soft</td><td>在 internal 时间段里，软中断时间（%）</td><td>softirq/total*100</td></tr><tr><td>%steal</td><td>显示虚拟机管理器在服务另一个虚拟处理器时虚拟 CPU 处在非自愿等待下花费时间的百分比</td><td>steal/total*100</td></tr><tr><td>%guest</td><td>显示运行虚拟处理器时 CPU 花费时间的百分比</td><td>guest/total*100</td></tr><tr><td>%gnice</td><td></td><td>gnice/total*100</td></tr><tr><td>%idle</td><td>在 internal 时间段里，CPU 除去等待磁盘 IO 操作外的因为任何原因而空闲的时间闲置时间（%）</td><td>idle/total*100</td></tr></tbody></table><p>CPU 总的工作时间：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">total_cur = user + system + nice + idle + iowait + irq + softirq</span><br><span class="line"></span><br><span class="line">total_pre = pre_user + pre_system + pre_nice + pre_idle + pre_iowait + pre_irq + pre_softirq</span><br><span class="line"></span><br><span class="line">user = user_cur – user_pre</span><br><span class="line"></span><br><span class="line">total = total_cur - total_pre</span><br></pre></td></tr></table></figure><p>其中 _cur 表示当前值，_pre 表示 interval 时间前的值。上表中的所有值可取到两位小数点。</p><p><strong>Note：</strong></p><ol><li><p>vmstat 和 mpstat 命令的差别：mpstat 可以显示每个处理器的统计，而 vmstat 显示所有处理器的统计。因此，编写糟糕的应用程序（不使用多线程体系结构）可能会运行在一个多处理器机器上，而不使用所有处理器。从而导致一个 CPU 过载，而其他 CPU 却很空闲。通过 mpstat 可以轻松诊断这些类型的问题。</p></li><li><p>vmstat 中所有关于 CPU 的总结都适合 mpstat。当您看到较低的 % idle 数字时，您知道出现了 CPU 不足的问题。当您看到较高的 % iowait 数字时，您知道在当前负载下 I/O 子系统出现了某些问题。</p></li></ol>]]></content>
    
    <summary type="html">
    
      mpstat使用介绍和输出参数详解
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>netperf 和 iperf 网络性能测试小结</title>
    <link href="https://wsgzao.github.io/post/netperf/"/>
    <id>https://wsgzao.github.io/post/netperf/</id>
    <published>2019-06-27T06:59:49.000Z</published>
    <updated>2019-07-04T06:42:11.074Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>为了解决 LVS ksoftirqd CPU 使用率 100% 软中断导致网卡丢包的问题，我们使用 netperf 来测试网络性能，目的是尽可能复现问题，在研究的过程中顺便记录自己使用 netperf 的过程，除了 netperf 之外还可以使用 iperf 作为 TCP/UDP 压力测试工具。</p><blockquote><p>netperf 和 iperf 网络性能测试小结</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 06 月 27 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/netperf/">https://wsgzao.github.io/post/netperf/</a></p><p><strong> 扩展阅读 </strong></p><p>netperf - <a href="https://github.com/HewlettPackard/netperf" target="_blank" rel="noopener">https://github.com/HewlettPackard/netperf</a><br>iperf - <a href="https://github.com/esnet/iperf" target="_blank" rel="noopener">https://github.com/esnet/iperf</a></p><hr><h2 id="网络性能测量的五项指标"><a href="#网络性能测量的五项指标" class="headerlink" title="网络性能测量的五项指标"></a>网络性能测量的五项指标</h2><p>可用性（availability）<br>响应时间（response time）<br>网络利用率（network utilization）<br>网络吞吐量（network throughput）<br>网络带宽容量（network bandwidth capacity）</p><h3 id="可用性"><a href="#可用性" class="headerlink" title="可用性"></a>可用性</h3><p>测试网络性能的第一步是确定网络是否正常工作，最简单的方法是使用 ping 命令。通过向远端的机器发送 icmp echo request，并等待接收 icmp echo reply 来判断远端的机器是否连通，网络是否正常工作。</p><p>Ping 命令有非常丰富的命令选项，比如 -c 可以指定发送 echo request 的个数，-s 可以指定每次发送的 ping 包大小。</p><p>网络设备内部一般有多个缓冲池，不同的缓冲池使用不同的缓冲区大小，分别用来处理不同大小的分组（packet）。例如交换机中通常具有三种类型的包缓冲：一类针对小的分组，一类针对中等大小的分组，还有一类针对大的分组。为了测试这样的网络设备，测试工具必须要具有发送不同大小分组的能力。Ping 命令的 -s 就可以使用在这种场合。</p><h3 id="响应时间"><a href="#响应时间" class="headerlink" title="响应时间"></a>响应时间</h3><p>Ping 命令的 echo request/reply 一次往返所花费时间就是响应时间。有很多因素会影响到响应时间，如网段的负荷，网络主机的负荷，广播风暴，工作不正常的网络设备等等。</p><p>在网络工作正常时，记录下正常的响应时间。当用户抱怨网络的反应时间慢时，就可以将现在的响应时间与正常的响应时间对比，如果两者差值的波动很大，就能说明网络设备存在故障。</p><h3 id="网络利用率"><a href="#网络利用率" class="headerlink" title="网络利用率"></a>网络利用率</h3><p>网络利用率是指网络被使用的时间占总时间（即被使用的时间 + 空闲的时间）的比例。比如，Ethernet 虽然是共享的，但同时却只能有一个报文在传输。因此在任一时刻，Ethernet 或者是 100% 的利用率，或者是 0% 的利用率。</p><p>计算一个网段的网络利用率相对比较容易，但是确定一个网络的利用率就比较复杂。因此，网络测试工具一般使用网络吞吐量和网络带宽容量来确定网络中两个节点之间的性能。</p><h3 id="网络吞吐量"><a href="#网络吞吐量" class="headerlink" title="网络吞吐量"></a>网络吞吐量</h3><p>网络吞吐量是指在某个时刻，在网络中的两个节点之间，提供给网络应用的剩余带宽。</p><p>网络吞吐量可以帮助寻找网络路径中的瓶颈。比如，即使 client 和 server 都被分别连接到各自的 100M Ethernet 上，但是如果这两个 100M 的 Ethernet 被 10M 的 Ethernet 连接起来，那么 10M 的 Ethernet 就是网络的瓶颈。</p><p>网络吞吐量非常依赖于当前的网络负载情况。因此，为了得到正确的网络吞吐量，最好在不同时间（一天中的不同时刻，或者一周中不同的天）分别进行测试，只有这样才能得到对网络吞吐量的全面认识。</p><p>有些网络应用程序在开发过程的测试中能够正常运行，但是到实际的网络环境中却无法正常工作（由于没有足够的网络吞吐量）。这是因为测试只是在空闲的网络环境中，没有考虑到实际的网络环境中还存在着其它的各种网络流量。所以，网络吞吐量定义为剩余带宽是有实际意义的。</p><h3 id="网络带宽容量"><a href="#网络带宽容量" class="headerlink" title="网络带宽容量"></a>网络带宽容量</h3><p>与网络吞吐量不同，网络带宽容量指的是在网络的两个节点之间的最大可用带宽。这是由组成网络的设备的能力所决定的。</p><p>测试网络带宽容量有两个困难之处：在网络存在其它网络流量的时候，如何得知网络的最大可用带宽；在测试过程中，如何对现有的网络流量不造成影响。网络测试工具一般采用 packet pairs 和 packet trains 技术来克服这样的困难。</p><h3 id="收集网络性能数据的方式"><a href="#收集网络性能数据的方式" class="headerlink" title="收集网络性能数据的方式"></a>收集网络性能数据的方式</h3><p>当确定了网络性能的测试指标以后，就需要使用网络测试工具收集相应的性能数据，分别有三种从网络获取数据的方式：</p><ol><li>通过 snmp 协议直接到网络设备中获取，如 net-snmp 工具</li><li>侦听相关的网络性能数据，典型的工具是 tcpdump</li><li>自行产生相应的测试数据，即本文中介绍的 iperf、netperf 等工具</li></ol><h2 id="Netperf"><a href="#Netperf" class="headerlink" title="Netperf"></a>Netperf</h2><p>Netperf 是一种网络性能的测量工具，主要针对基于 TCP 或 UDP 的传输。Netperf 根据应用的不同，可以进行不同模式的网络性能测试，即批量数据传输（bulk data transfer）模式和请求 / 应答（request/reponse）模式。</p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>-H host</td><td>指定远端运行 netserver 的 server IP 地址</td></tr><tr><td>-l testlen</td><td>指定测试的时间长度 (秒)</td></tr><tr><td>-t testname</td><td>指定进行的测试类型 (TCP_STREAM，UDP_STREAM，TCP_RR，TCP_CRR，UDP_RR)</td></tr></tbody></table><p>可选参数有如下几个：</p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>-s size</td><td>设置本地系统的 socket 发送与接收缓冲大小</td></tr><tr><td>-S size</td><td>设置远端系统的 socket 发送与接收缓冲大小</td></tr><tr><td>-m size</td><td>设置本地系统发送测试分组的大小</td></tr><tr><td>-M size</td><td>设置远端系统接收测试分组的大小</td></tr><tr><td>-D</td><td>对本地与远端系统的 socket 设置 TCP_NODELAY 选项</td></tr><tr><td>-r req,resp</td><td>设置 request 和 reponse 分组的大小</td></tr></tbody></table><p><strong> 实例：</strong></p><p>服务器端：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#./netserver</span><br></pre></td></tr></table></figure><p>客户端：</p><p><strong>1、批量 (bulk) 网络流量的性能 </strong></p><p><strong>1）TCP_STREAM</strong></p><p>Netperf 缺省情况下进行 TCP 批量传输，即 - t TCP_STREAM。测试过程中，netperf 向 netserver 发送批量的 TCP 数据分组，以确定数据传输过程中的吞吐量：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#./netperf -H 192.168.0.28 -l 60</span><br><span class="line">TCP STREAM TEST to 192.168.0.28</span><br><span class="line">Recv   Send    Send</span><br><span class="line">Socket Socket  Message  Elapsed</span><br><span class="line">Size   Size    Size     Time     Throughput</span><br><span class="line">bytes  bytes   bytes    secs.    10^6bits/sec</span><br><span class="line">87380  16384  16384    60.00      88.00</span><br></pre></td></tr></table></figure><p>从 netperf 的结果输出中，我们可以知道以下的一些信息：</p><ol><li>远端系统（即 server）使用大小为 87380 字节的 socket 接收缓冲</li><li>本地系统（即 client）使用大小为 16384 字节的 socket 发送缓冲</li><li>向远端系统发送的测试分组大小为 16384 字节</li><li>测试经历的时间为 60 秒</li><li>吞吐量的测试结果表明，TCP 带宽为 88Mbits / 秒</li></ol><p>通过修改可选参数，并观察结果的变化，我们可以确定是什么因素影响了连接的吞吐量。例如，如果怀疑路由器由于缺乏足够的缓冲区空间，使得转发大的分组时存在问题，就可以增加测试分组（-m）的大小，以观察吞吐量的变化：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#./netperf -H 192.168.0.28 -l 60 -- -m 2048</span><br><span class="line">TCP STREAM TEST to 192.168.0.28</span><br><span class="line">Recv   Send    Send</span><br><span class="line">Socket Socket  Message  Elapsed</span><br><span class="line">Size   Size    Size     Time     Throughput</span><br><span class="line">bytes  bytes   bytes    secs.    10^6bits/sec</span><br><span class="line">87380  16384   2048    60.00      87.62</span><br></pre></td></tr></table></figure><p>在这里，测试分组的大小减少到 2048 字节，而吞吐量却没有很大的变化（与前面例子中测试分组大小为 16K 字节相比）。相反，如果吞吐量有了较大的提升，则说明在网络中间的路由器确实存在缓冲区的问题。</p><p><strong>2）UDP_STREAM</strong></p><p>UDP_STREAM 用来测试进行 UDP 批量传输时的网络性能。需要特别注意的是，此时测试分组的大小不得大于 socket 的发送与接收缓冲大小，否则 netperf 会报出错提示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#./netperf -t UDP_STREAM -H 192.168.0.28 -l 60</span><br><span class="line">UDP UNIDIRECTIONAL SEND TEST to 192.168.0.28</span><br><span class="line">udp_send: data send error: Message too long</span><br></pre></td></tr></table></figure><p>为了避免这样的情况，可以通过命令行参数限定测试分组的大小，或者增加 socket 的发送 / 接收缓冲大小。UDP_STREAM 方式使用与 TCP_STREAM 方式相同的局部命令行参数，因此，这里可以使用 - m 来修改测试中使用分组的大小：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#./netperf -t UDP_STREAM -H 192.168.0.28 -- -m 1024</span><br><span class="line">UDP UNIDIRECTIONAL SEND TEST to 192.168.0.28</span><br><span class="line">Socket  Message  Elapsed      Messages</span><br><span class="line">Size    Size     Time         Okay Errors   Throughput</span><br><span class="line">bytes   bytes    secs            #      #   10^6bits/sec</span><br><span class="line">65535    1024    9.99        114127     0      93.55</span><br><span class="line">65535             9.99        114122            93.54</span><br></pre></td></tr></table></figure><p>UDP_STREAM 方式的结果中有两行测试数据<br>第一行显示的是本地系统的发送统计，这里的吞吐量表示 netperf 向本地 socket 发送分组的能力。但是，我们知道，UDP 是不可靠的传输协议，发送出去的分组数量不一定等于接收到的分组数量。</p><p>第二行显示的就是远端系统接收的情况，由于 client 与 server 直接连接在一起，而且网络中没有其它的流量，所以本地系统发送过去的分组几乎都被远端系统正确的接收了，远端系统的吞吐量也几乎等于本地系统的发送吞吐量。但是，在实际环境中，一般远端系统的 socket 缓冲大小不同于本地系统的 socket 缓冲区大小，而且由于 UDP 协议的不可靠性，远端系统的接收吞吐量要远远小于发送出去的吞吐量。</p><p><strong>2、请求 / 应答 (request/response) 网络流量的性能 </strong></p><p>另一类常见的网络流量类型是应用在 client/server 结构中的 request/response 模式。在每次交易（transaction）中，client 向 server 发出小的查询分组，server 接收到请求，经处理后返回大的结果数据。</p><p><strong>1） TCP_RR</strong></p><p>TCP_RR 方式的测试对象是多次 TCP request 和 response 的交易过程，但是它们发生在同一个 TCP 连接中，这种模式常常出现在数据库应用中。数据库的 client 程序与 server 程序建立一个 TCP 连接以后，就在这个连接中传送数据库的多次交易过程。 用户可以通过 - r 参数来改变 request 和 response 分组的大小，进行更有实际意义的测试：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#./netperf -t TCP_RR -H 192.168.0.28 -- -r 32,1024</span><br><span class="line">TCP REQUEST/RESPONSE TEST to 192.168.0.28</span><br><span class="line">Local /Remote</span><br><span class="line">Socket Size   Request  Resp.   Elapsed  Trans.</span><br><span class="line">Send   Recv   Size     Size    Time     Rate</span><br><span class="line">bytes  Bytes  bytes    bytes   secs.    per sec</span><br><span class="line">16384  87380  32       1024    10.00    4945.97</span><br><span class="line">16384  87380</span><br></pre></td></tr></table></figure><p>从结果中可以看出，增加 request/reponse 分组的大小，会导致交易率明显的下降。<br>注：相对于实际的系统，这里交易率的计算没有充分考虑到交易过程中的应用程序处理时延，因此结果往往会高于实际情况</p><p><strong>2） TCP_CRR</strong></p><p>与 TCP_RR 不同，TCP_CRR 为每次交易建立一个新的 TCP 连接。最典型的应用就是 HTTP，每次 HTTP 交易是在一条单独的 TCP 连接中进行的。因此，由于需要不停地建立新的 TCP 连接，并且在交易结束后拆除 TCP 连接，交易率一定会受到很大的影响。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#./netperf -t TCP_CRR -H 192.168.0.28</span><br><span class="line">TCP Connect/Request/Response TEST to 192.168.0.28</span><br><span class="line">Local /Remote</span><br><span class="line">Socket Size   Request  Resp.   Elapsed  Trans.</span><br><span class="line">Send   Recv   Size     Size    Time     Rate</span><br><span class="line">bytes  Bytes  bytes    bytes   secs.    per sec</span><br><span class="line">131070 131070 1        1       9.99     2662.20</span><br><span class="line">16384  87380</span><br></pre></td></tr></table></figure><p>即使是使用一个字节的 request/response 分组，交易率也明显的降低了，只有 2662.20 次 / 秒。</p><p><strong>3） UDP_RR</strong></p><p>UDP_RR 方式使用 UDP 分组进行 request/response 的交易过程。由于没有 TCP 连接所带来的负担，所以我们推测交易率一定会有相应的提升。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#./netperf -t UDP_RR -H 192.168.0.28</span><br><span class="line">UDP REQUEST/RESPONSE TEST to 192.168.0.28</span><br><span class="line">Local /Remote</span><br><span class="line">Socket Size   Request  Resp.   Elapsed  Trans.</span><br><span class="line">Send   Recv   Size     Size    Time     Rate</span><br><span class="line">bytes  Bytes  bytes    bytes   secs.    per sec</span><br><span class="line">65535  65535  1        1       9.99     10141.16</span><br><span class="line">65535  65535</span><br></pre></td></tr></table></figure><p>结果证实了我们的推测，交易率为 10141.16 次 / 秒，高过 TCP_RR 的数值。不过，如果出现了相反的结果，即交易率反而降低了，也不需要担心，因为这说明了在网络中，路由器或其它的网络设备对 UDP 采用了与 TCP 不同的缓冲区空间和处理技术。</p><h2 id="iperf"><a href="#iperf" class="headerlink" title="iperf"></a>iperf</h2><p>iperf 是一个网络性能测试工具。iperf 可以测试最大 TCP 和 UDP 带宽性能，具有多种参数和 UDP 特性，可以根据需要调整，可以报告带宽、延迟抖动和数据包丢失。<br>0<br><strong> 客户端与服务器共用选项 </strong></p><table><thead><tr><th>命令行选项</th><th>描述</th></tr></thead><tbody><tr><td>-u</td><td>–udp：使用 UDP 方式而不是 TCP 方式。需要客户端与服务器端同时使用此参数。</td></tr><tr><td>-p</td><td>–port : 设置端口，与服务器端的监听端口一致。默认是 5001 端口。</td></tr><tr><td>-l</td><td>–len : 设置读写缓冲区的长度。TCP 方式默认为 8KB，UDP 方式默认为 1470 字节。</td></tr><tr><td>-w</td><td>–window : 设置套接字缓冲区为指定大小。对于 TCP 方式，此设置为 TCP 窗口大小。对于 UDP 方式，此设置为接受 UDP 数据包的缓冲区大小，限制可以接受数据包的最大值。</td></tr><tr><td>-m</td><td>–print_mss : 输出 TCP MSS 值（通过 TCP_MAXSEG 支持）。MSS 值一般比 MTU 值小 40 字节。通常情况</td></tr></tbody></table><p><strong> 服务器端专用选项 </strong></p><table><thead><tr><th>命令行选项</th><th>描述</th></tr></thead><tbody><tr><td>-s</td><td>–server : iperf 服务器模式</td></tr><tr><td>-c</td><td>–client host : 如果 iperf 运行在服务器模式，并且用 - c 参数指定一个主机，那么 iperf 将只接受指定主机的连接。此参数不能工作于 UDP 模式。</td></tr><tr><td>-P</td><td>–parallel： 服务器关闭之前保持的连接数。默认是 0，这意味着永远接受连接。</td></tr></tbody></table><p><strong> 客户端端专用选项 </strong></p><table><thead><tr><th>命令行选项</th><th>描述</th></tr></thead><tbody><tr><td>-c</td><td>–client host ： 运行 iperf 的客户端模式，连接到指定的 iperf 服务器端。</td></tr><tr><td>-b</td><td>–bandwidth ：UDP 模式使用的带宽，必须配合 - u 参数，默认值是 1 Mbit/sec。</td></tr><tr><td>-d</td><td>–dualtest ： 运行双测试模式。这将使服务器端反向连接到客户端，使用 - L 参数中指定的端口（或默认使用客户端连接到服务器端的端口）。这些在操作的同时就立即完成了。如果你想要一个交互的测试，请尝试 - r 参数。</td></tr><tr><td>-r</td><td>–tradeoff ： 往复测试模式。当客户端到服务器端的测试结束时，服务器端通过 - l 选项指定的端口（或默认为客户端连接到服务器端的端口），反向连接至客户端。当客户端连接终止时，反向连接随即开始。如果需要同时进行双向测试，请尝试 - d 参数。</td></tr><tr><td>-L</td><td>–listenport ： 指指定服务端反向连接到客户端时使用的端口。默认使用客户端连接至服务端的端口。</td></tr><tr><td>-t</td><td>–time ： 设置传输的总时间。iperf 在指定的时间内，重复的发送指定长度的数据包。默认是 10 秒钟。</td></tr><tr><td>-P</td><td>–parallel： 线程数。指定客户端与服务端之间使用的线程数。默认是 1 线程。需要客户端与服务器端同时使用此参数。</td></tr></tbody></table><h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><p>带宽测试通常采用 UDP 模式，因为能测出极限带宽、时延抖动、丢包率。在进行测试时，首先以链路理论带宽作为数据发送速率进行测试，例如，从客户端到服务器之间的链路的理论带宽为 100Mbps，先用 - b 100M 进行测试，然后根据测试结果（包括实际带宽，时延抖动和丢包率），再以实际带宽作为数据发送速率进行测试，会发现时延抖动和丢包率比第一次好很多，重复测试几次，就能得出稳定的实际带宽。</p><p><strong>UDP 模式 </strong></p><p>服务器端：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iperf -u -s</span><br></pre></td></tr></table></figure><p>客户端：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/* 在 udp 模式下，以 100Mbps 为数据发送速率，客户端到服务器 192.168.1.1 上传带宽测试，测试时间为 60 秒 */</span><br><span class="line">iperf -u -c 192.168.1.1 -b 100M -t 60</span><br><span class="line"></span><br><span class="line">/* 客户端以 5Mbps 为数据发送速率, 同时向服务器端发起 30 个连接线程 */</span><br><span class="line">iperf -u -c 192.168.1.1 -b 5M -P 30 -t 60</span><br><span class="line"></span><br><span class="line">/* 以 100M 为数据发送速率，进行上下行带宽测试,-L 参数指定本端双测试监听的端口 */</span><br><span class="line">iperf -u -c 192.168.1.1 -b 100M -d -t 60 -L 30000</span><br></pre></td></tr></table></figure><p><strong>TCP 模式 </strong></p><p>服务器端：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iperf -s</span><br></pre></td></tr></table></figure><p>客户端：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/* 在 tcp 模式下，客户端到服务器 192.168.1.1 上传带宽测试，测试时间为 60 秒 */</span><br><span class="line">iperf -c 192.168.1.1 -t 60</span><br><span class="line"></span><br><span class="line">/* 进行上下行带宽测试 */</span><br><span class="line">iperf -c 192.168.1.1 -d -t 60</span><br><span class="line"></span><br><span class="line">/* 测试单线程 TCP*/</span><br><span class="line">iperf –c 192.168.1.1 –p 12345 –i 1 –t 10 –w 20K</span><br><span class="line"></span><br><span class="line">-c：客户端模式，后接服务器 ip</span><br><span class="line">-p：后接服务端监听的端口 </span><br><span class="line">-i：设置带宽报告的时间间隔，单位为秒</span><br><span class="line">-t：设置测试的时长，单位为秒</span><br><span class="line">-w：设置 tcp 窗口大小，一般可以不用设置，默认即可</span><br><span class="line"></span><br><span class="line"> 对应服务器端：</span><br><span class="line">iperf –s –p 12345 –i 1 –t 10 –m -y</span><br><span class="line"></span><br><span class="line">/* 测试多线程 TCP: 客户端同时向服务器端发起 30 个连接线程 */</span><br><span class="line">iperf -c 192.168.1.1 -P 30 -t 60</span><br></pre></td></tr></table></figure><p>发包完成后，可以通过 ifconfig ethx 和 ethtool -S ethx 查看对应收发包情况，确定发包数、包长、是否丢包等。</p><h2 id="Netperf-测试实践"><a href="#Netperf-测试实践" class="headerlink" title="Netperf 测试实践"></a>Netperf 测试实践</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install netperf</span></span><br><span class="line">wget -c <span class="string">"https://codeload.github.com/HewlettPackard/netperf/tar.gz/netperf-2.7.0"</span> -O netperf-2.7.0.tar.gz</span><br><span class="line">tar -zxvf netperf-2.7.0.tar.gz</span><br><span class="line"><span class="built_in">cd</span> netperf-netperf-2.7.0</span><br><span class="line">./configure &amp;&amp; make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># add path</span></span><br><span class="line">vim ~/.bash_profile</span><br><span class="line">PATH=<span class="variable">$PATH</span>:/usr/<span class="built_in">local</span>/bin/</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># test</span></span><br><span class="line"><span class="built_in">cd</span> src</span><br><span class="line">netperf -h</span><br><span class="line">netserver -h</span><br><span class="line"></span><br><span class="line"><span class="comment"># server</span></span><br><span class="line">netserver -4 -p 7777</span><br><span class="line">ps -ef | grep netserver</span><br><span class="line"></span><br><span class="line"><span class="comment"># client</span></span><br><span class="line">netperf -H 10.71.14.122 -p 7777 -l 60</span><br><span class="line"></span><br><span class="line">netperf -t TCP_RR -H 10.71.14.122 -p 7777 -c -C -l 60</span><br><span class="line">netperf -t TCP_RR -H 10.71.14.122 -p 7777 -c -C -l 60 -- -r256,256</span><br><span class="line"></span><br><span class="line"><span class="comment"># check result</span></span><br><span class="line">bmon</span><br><span class="line">mpstat -P ALL 2</span><br></pre></td></tr></table></figure><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://www.ibm.com/developerworks/cn/linux/l-netperf/" target="_blank" rel="noopener">netperf 与网络性能测量</a><br><a href="https://www.alibabacloud.com/help/zh/faq-detail/55757.htm" target="_blank" rel="noopener">网络性能测试方法</a></p>]]></content>
    
    <summary type="html">
    
      netperf和iperf网络性能测试小结
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>SRE 和 DevOps</title>
    <link href="https://wsgzao.github.io/post/sre-vs-devops/"/>
    <id>https://wsgzao.github.io/post/sre-vs-devops/</id>
    <published>2019-06-25T06:59:49.000Z</published>
    <updated>2019-06-26T07:54:32.450Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190626155041.png" alt=""></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在搜索 SRE 和 DevOps 相关概念的过程中偶然发现 Google Cloud 的 Blog 专门制作了这样一篇文章，国内虽然有不少翻译但并没有完全做到翻译术语中的 “信，雅，达”，这里转载 Google 官方的文章和 YouTube 视频，同时也选择了网友精心翻译的文章并把视频搬运至 bilibili 也就是 B 站方便大家浏览，相信大家可以对 SRE 和 DevOps 有更深入的理解。</p><blockquote><p>SRE vs. DevOps: competing standards or close friends?</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 06 月 25 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/sre-vs-devops/">https://wsgzao.github.io/post/sre-vs-devops/</a></p><p><strong> 扩展阅读 </strong></p><p>SRE vs. DevOps: competing standards or close friends? - <a href="https://cloud.google.com/blog/products/gcp/sre-vs-devops-competing-standards-or-close-friends" target="_blank" rel="noopener">https://cloud.google.com/blog/products/gcp/sre-vs-devops-competing-standards-or-close-friends</a><br>DevOps 和 SRE - <a href="https://blog.alswl.com/2018/09/devops-and-sre/" target="_blank" rel="noopener">https://blog.alswl.com/2018/09/devops-and-sre/</a></p><hr><h2 id="英文原文"><a href="#英文原文" class="headerlink" title="英文原文"></a>英文原文</h2><p><a href="https://cloud.google.com/blog/products/gcp/sre-vs-devops-competing-standards-or-close-friends" target="_blank" rel="noopener">SRE vs. DevOps: competing standards or close friends?</a></p><p>Seth Vargo: Staff Developer Advocate<br>Liz Fong-Jones: Site Reliability Engineer<br>May 9, 2018</p><iframe width="560" height="315" src="https://www.youtube.com/embed/uTEL8Ff1Zvk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><p>Site Reliability Engineering (SRE) and DevOps are two trending disciplines with quite a bit of overlap. In the past, some have called SRE a competing set of practices to DevOps. But we think they’re not so different after all.</p><p>What exactly is SRE and how does it relate to DevOps? Earlier this year, we (<a href="https://twitter.com/lizthegrey" target="_blank" rel="noopener">Liz Fong-Jones</a> and <a href="https://twitter.com/sethvargo" target="_blank" rel="noopener">Seth Vargo</a>) launched a video series to help answer some of these questions and reduce the friction between the communities. This blog post summarizes the themes and lessons of each video in the series to offer actionable steps toward better, more reliable systems.</p><h3 id="1-The-difference-between-DevOps-and-SRE"><a href="#1-The-difference-between-DevOps-and-SRE" class="headerlink" title="1. The difference between DevOps and SRE"></a>1. The difference between DevOps and SRE</h3><p>It’s useful to start by understanding the differences and similarities between SRE and DevOps to lay the groundwork for future conversation.</p><p>The <a href="https://itrevolution.com/devops-culture-part-1/" target="_blank" rel="noopener">DevOps movement</a> began because developers would write code with little understanding of how it would run in production. They would throw this code over the proverbial wall to the operations team, which would be responsible for keeping the applications up and running. This often resulted in tension between the two groups, as each group’s priorities were misaligned with the needs of the business. DevOps emerged as a culture and a set of practices that aims to reduce the gaps between software development and software operation. However, the DevOps movement <a href="https://www.sethvargo.com/the-ten-myths-of-devops/" target="_blank" rel="noopener">does not explicitly define <em>how</em> to succeed</a> in these areas. In this way, DevOps is like an abstract class or interface in programming. It defines the overall behavior of the system, but the implementation details are left up to the author.</p><p>SRE, which evolved at Google to meet internal needs in the early 2000s independently of the DevOps movement, happens to embody the philosophies of DevOps, but has a much more prescriptive way of measuring and achieving reliability through engineering and operations work. In other words, SRE prescribes how to succeed in the various DevOps areas. For example, the table below illustrates the five DevOps pillars and the corresponding SRE practices:</p><table><thead><tr><th></th><th>DevOps</th><th>SRE</th></tr></thead><tbody><tr><td></td><td>Reduce organization silos</td><td>Share ownership with developers by using the same tools and techniques across the stack</td><td></td></tr><tr><td></td><td>Accept failure as normal</td><td>Have a formula for balancing accidents and failures against new releases</td><td></td></tr><tr><td></td><td>Implement gradual change</td><td>Encourage moving quickly by reducing costs of failure</td><td></td></tr><tr><td></td><td>Leverage tooling &amp; automation</td><td>Encourages “automating this year’s job away” and minimizing manual systems work to focus on efforts that bring long-term value to the system</td><td></td></tr><tr><td></td><td>Measure everything</td><td>Believes that operations is a software problem, and defines prescriptive ways for measuring availability, uptime, outages, toil, etc.</td><td></td></tr></tbody></table><p>If you think of DevOps like an interface in a programming language, <strong>class SRE implements DevOps</strong>. While the SRE program did not explicitly set out to satisfy the DevOps interface, both disciplines independently arrived at a similar set of conclusions. But just like in programming, classes often include more behavior than just what their interface defines, or they might implement multiple interfaces. SRE includes additional practices and recommendations that are not necessarily part of the DevOps interface.</p><p>DevOps and SRE are not two competing methods for software development and operations, but rather close friends designed to break down organizational barriers to deliver better software faster. If you prefer books, check out <a href="https://www.safaribooksonline.com/library/view/how-sre-relates/9781492030645/" target="_blank" rel="noopener">How SRE relates to DevOps</a> (Betsy Beyer, Niall Richard Murphy, Liz Fong-Jones) for a more thorough explanation.</p><h3 id="2-SLIs-SLOs-and-SLAs"><a href="#2-SLIs-SLOs-and-SLAs" class="headerlink" title="2. SLIs, SLOs, and SLAs"></a>2. SLIs, SLOs, and SLAs</h3><p>The SRE discipline collaboratively decides on a system’s availability targets and measures availability with input from engineers, product owners and customers.</p><iframe width="560" height="315" src="https://www.youtube.com/embed/tEylFyxbDLE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><p>It can be challenging to have a productive conversation about software development without a consistent and agreed-upon way to describe a system’s uptime and availability. Operations teams are constantly putting out fires, some of which end up being bugs in developer’s code. But without a clear measurement of uptime and a clear prioritization on availability, product teams may not agree that reliability is a problem. This very challenge affected Google in the early 2000s, and it was one of the motivating factors for developing the SRE discipline.</p><p>SRE ensures that everyone agrees on how to measure availability, and what to do when availability falls out of specification. This process includes individual contributors at every level, all the way up to VPs and executives, and it creates a shared responsibility for availability across the organization. SREs work with stakeholders to decide on Service Level Indicators (SLIs) and Service Level Objectives (SLOs).</p><ul><li>SLIs are metrics over time such as request latency, throughput of requests per second, or failures per request. These are usually aggregated over time and then converted to a rate, average or percentile subject to a threshold.</li><li>SLOs are targets for the cumulative success of SLIs over a window of time (like “last 30 days” or “this quarter”), agreed-upon by stakeholders</li></ul><p>The video also discusses Service Level Agreements (SLAs). Although not specifically part of the day-to-day concerns of SREs, an SLA is a promise by a service provider, to a service consumer, about the availability of a service and the ramifications of failing to deliver the agreed-upon level of service. SLAs are usually defined and negotiated by account executives for customers and offer a lower availability than the SLO. After all, you want to break your own internal SLO before you break a customer-facing SLA.</p><p>SLIs, SLOs and SLAs tie back closely to the DevOps pillar of “measure everything” and one of the reasons we say <strong>class SRE implements DevOps</strong>.</p><h3 id="3-Risk-and-error-budgets"><a href="#3-Risk-and-error-budgets" class="headerlink" title="3. Risk and error budgets"></a>3. Risk and error budgets</h3><p>We focus here on measuring risk through error budgets, which are quantitative ways in which SREs collaborate with product owners to balance availability and feature development. This video also discusses why 100% is not a viable availability target.</p><iframe width="560" height="315" src="https://www.youtube.com/embed/y2ILKr8kCJU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><p>Maximizing a system’s stability is both counterproductive and pointless. Unrealistic reliability targets limit how quickly new features can be delivered to users, and users typically won’t notice extreme availability (like 99.999999%) because the quality of their experience is dominated by less reliable components like ISPs, cellular networks or WiFi. Having a 100% availability requirement severely limits a team or developer’s ability to deliver updates and improvements to a system. Service owners who want to deliver many new features should opt for less stringent SLOs, thereby giving them the freedom to continue shipping in the event of a bug. Service owners focused on reliability can choose a higher SLO, but accept that breaking that SLO will delay feature releases. The SRE discipline quantifies this acceptable risk as an “error budget.” When error budgets are depleted, the focus shifts from feature development to improving reliability.</p><p>As mentioned in the second video, leadership buy-in is an important pillar in the SRE discipline. Without this cooperation, nothing prevents teams from breaking their agreed-upon SLOs, forcing SREs to work overtime or waste too much time toiling to just keep the systems running. If SRE teams do not have the ability to enforce error budgets (or if the error budgets are not taken seriously), the system fails.</p><p>Risk and error budgets quantitatively accept failure as normal and enforce the DevOps pillar to implement gradual change. Non-gradual changes risk exceeding error budgets.</p><h3 id="4-Toil-and-toil-budgets"><a href="#4-Toil-and-toil-budgets" class="headerlink" title="4. Toil and toil budgets"></a>4. Toil and toil budgets</h3><p>An important component of the SRE discipline is toil, toil budgets and ways to reduce toil. Toil occurs each time a human operator needs to manually touch a system during normal operations—but the definition of “normal” is constantly changing.</p><iframe width="560" height="315" src="https://www.youtube.com/embed/IvQ-15-yE_c" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><p>Toil is not simply “work I don’t like to do.” For example, the following tasks are overhead, but are specifically not toil: submitting expense reports, attending meetings, responding to email, commuting to work, etc. Instead, toil is specifically tied to the running of a production service. It is work that tends to be manual, repetitive, automatable, tactical and devoid of long-term value. Additionally, toil tends to scale linearly as the service grows. Each time an operator needs to touch a system, such as responding to a page, working a ticket or unsticking a process, toil has likely occurred.</p><p>The SRE discipline aims to reduce toil by focusing on the “engineering” component of Site Reliability Engineering. When SREs find tasks that can be automated, they work to engineer a solution to prevent that toil in the future. While minimizing toil is important, it’s realistically impossible to completely eliminate. Google aims to ensure that at least 50% of each SRE’s time is spent doing engineering projects, and these SREs individually report their toil in quarterly surveys to identify operationally overloaded teams. That being said, toil is not always bad. Predictable, repetitive tasks are great ways to onboard a new team member and often produce an immediate sense of accomplishment and satisfaction with low risk and low stress. Long-term toil assignments, however, quickly outweigh the benefits and can cause career stagnation.</p><p>Toil and toil budgets are closely related to the DevOps pillars of “measure everything” and “reduce organizational silos.”</p><h3 id="5-Customer-Reliability-Engineering-CRE"><a href="#5-Customer-Reliability-Engineering-CRE" class="headerlink" title="5. Customer Reliability Engineering (CRE)"></a>5. Customer Reliability Engineering (CRE)</h3><p>Finally, Customer Reliability Engineering (CRE) completes the tenets of SRE (with the help in the video of a futuristic friend). CRE aims to teach SRE practices to customers and service consumers.</p><iframe width="560" height="315" src="https://www.youtube.com/embed/GQPzaq-owYM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><p>In the past, Google did not talk publicly about SRE. We thought of it as a competitive advantage we had to keep secret from the world. However, every time a customer had a problem because they used a system in an unexpected way, we had to stop innovating and help solve the problem. That tiny bit of friction, spread across billions of users, adds up very quickly. It became clear that we needed to start talking about SRE publicly and teaching our customers about SRE practices so they could replicate them within their organizations.</p><p>Thus, in 2016, we <a href="https://cloudplatform.googleblog.com/2016/10/introducing-a-new-era-of-customer-support-Google-Customer-Reliability-Engineering.html" target="_blank" rel="noopener">launched the CRE program</a> as both a means of helping our Google Cloud Platform (GCP) customers with improving their reliability, and a means of exposing Google SREs directly to the challenges customers face. The CRE program aims to reduce customer anxiety by teaching them SRE principles and helping them adopt SRE practices.</p><p>CRE aligns with the DevOps pillars of “reduce organization silos” by forcing collaboration across organizations, and it also closely relates to the concepts of “accepting failure as normal” and “measure everything” by creating a shared responsibility among all stakeholders in the form of shared SLOs.</p><h3 id="Looking-forward-with-SRE"><a href="#Looking-forward-with-SRE" class="headerlink" title="Looking forward with SRE"></a>Looking forward with SRE</h3><p>We are working on some exciting new content across a variety of mediums to help showcase how users can adopt DevOps and SRE on Google Cloud, and we cannot wait to share them with you. What SRE topics are you interested in hearing about? Please <a href="https://twitter.com/GCPcloud" target="_blank" rel="noopener">give us a tweet</a> or <a href="https://www.youtube.com/watch?v=uTEL8Ff1Zvk&amp;list=PLIivdWyY5sqJrKl7D2u-gmis8h9K66qoj&amp;index=1" target="_blank" rel="noopener">watch our videos</a>.</p><p>Posted in:</p><ul><li><a href="https://cloud.google.com/blog/products/devops-sre" target="_blank" rel="noopener">DevOps &amp; SRE</a></li><li><a href="https://cloud.google.com/blog/products/application-development" target="_blank" rel="noopener">Application Development</a></li></ul><h2 id="中文翻译"><a href="#中文翻译" class="headerlink" title="中文翻译"></a>中文翻译</h2><blockquote><p>中文翻译原文为繁体中文，我转化为简体中文，视频替换为 B 站</p></blockquote><p><a href="https://medium.com/kkstream/%E5%A5%BD%E6%96%87%E7%BF%BB%E8%AD%AF-%E4%BD%A0%E5%9C%A8%E6%89%BE%E7%9A%84%E6%98%AF-sre-%E9%82%84%E6%98%AF-devops-2ded43c2852" target="_blank" rel="noopener">[好文翻譯] 你在找的是 SRE 還是 DevOps？</a></p><p>Neil Wei in KKStream<br>Aug 3, 2018</p><p>敝社这半年来开始 <a href="https://jobs.lever.co/kkstream" target="_blank" rel="noopener">大举征才</a>，其中不乏 DevOps 和 SRE 的职缺，然而 HR (或其他部门的同事) 对于两者的相异之处并不了解，甚至认为 SRE 和传统维运单位一样，只是换个名字，从管机房到管云端而已，究竟两者到底有什么差别呢？</p><p>这对前来的面试的应征者会有负面的影响，好像连我们自己要找什么样的人都不清楚似的。于是，花了点时间跟 HR 介绍两者的差异，也在支援了 SRE 团队四个月后留下这篇翻译文加一点点心得。</p><blockquote><p>请先记得…</p><p>SRE <strong>is</strong> a DevOps (香蕉是一种水果)</p><p>DevOps <strong>is</strong> NOT a SRE (水果不是香蕉)</p><p>DevOps 并不是一个 “工作职称”，SRE 才是</p></blockquote><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190626154902.png" alt=""></p><p>《本文已取得原作者之一 <a href="https://mobile.twitter.com/sethvargo" target="_blank" rel="noopener">Seth Vargo</a> 同意翻译刊登》</p><p>原文网址：<a href="https://cloudplatform.googleblog.com/2018/05/SRE-vs-DevOps-competing-standards-or-close-friends.html?m=1" target="_blank" rel="noopener">https://cloudplatform.googleblog.com/2018/05/SRE-vs-DevOps-competing-standards-or-close-friends.html?m=1</a></p><hr><blockquote><p>正文开始</p></blockquote><p>Site Reliability Engineering (SRE) 和 DevOps 是目前相当热门的开发与维运文化，有着很高的相似程度。然而，早期有些人会把 SRE 视为和 DevOps 不同的实践方式，认为两者不一样，必需选择其一来执行，但是现在大家更倾向两者其实其实很相似。</p><p>究竟 SRE 和 DevOps 有什么相同点呢？在年初，Google 的工程师 (<a href="https://twitter.com/lizthegrey" target="_blank" rel="noopener">Liz Fong-Jones</a> 与 <a href="https://twitter.com/sethvargo" target="_blank" rel="noopener">Seth Vargo</a>) 准备了一系列的影片去解答这些问题以及尝试跳出来去减少社群间的意见分歧，本篇文章总结了影片中所涵盖到的主题，以及如何实际去建置一个更加可靠的系统。</p><hr><blockquote><p>1. SRE 和 DevOps 的差异</p></blockquote><p>在开始之前，先了解一下 SRE 和 DevOps 有什么相同之处？又有什么相异之处？</p><iframe src="//player.bilibili.com/player.html?aid=56870162&cid=99334829&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe><p>DevOps 文化的兴起是因为在早期 (约十年前)，有许多开发者对于自己的程式是怎么跑在真实世界，其实所知有限。开发者要做的事情就是将程式打包好，然后扔给维运部门后，自己的工作周期就结束了，而维运部门会负责将程式安装与部署到所有生产环境的机器上，同时也要想尽各种辨法与善用各种工具，确保这些程式持续正常地执行，即使维运部门完全不了解这些程式的实作细节。</p><p>这样的工作模式很容易造成两个部门之间的对立，各自的部门都有自己的目标，而各自的目标和公司商业需求可能会不一致。DevOps 的出现是为了带来一种 <strong> 新的软体开发文化，用以降低开发与维运之间的鸿沟。</strong></p><p>然而，DevOps 的本质并不是教导大家 <strong> 怎么做 </strong> 才会成功，而是订定一些 <strong> 基本原则让大家各自发挥 </strong>，以程式设计的术语来说，DevOps 比较像是一个抽象类别 (abstract class)，或是介面 (interface)，定义了这种文化该有什么样的行为，实作则是靠各个部门成员一起决定，只要符合这个「介面」，就可以说是 DevOps 文化的实践。</p><p>SRE 一词由 Google 提出，是 Google 在这十多年间为了解决内部日渐庞大的系统而制定出一连串的规范和实作，和 DevOps 不同的是，它实作了 DevOps 的所定义的抽象方法，而且规范了更多关于 <strong> 如何用软体工程的方法与从维运的角度出发，以达成让系统稳定的目的 </strong>。简单来说，SRE 实作了 DevOps 这个介面 (interface)，以下列出五点 DevOps 定义的 <strong> 介面 </strong> 以及 SRE 如何 <strong> 实作 </strong>：</p><blockquote><p><strong>DevOps：</strong> 减少组织之间的谷仓效应</p><p><strong>SRE：</strong> 在整个开发周期中，和开发团队使用相同的工具以及一起分享与所有权。(注：<a href="https://medium.com/kkstream/infrastructure-as-code-%E5%A6%82%E4%BD%95%E6%94%B9%E5%96%84%E6%88%91%E5%80%91%E7%9A%84%E7%94%9F%E6%B4%BB%E5%93%81%E8%B3%AA-ee11e9d67b71" target="_blank" rel="noopener">Infra as code</a>, <a href="https://medium.com/kkstream/%E5%B0%8E%E5%85%A5-configuration-as-code-%E5%AE%8C%E6%88%90%E4%B8%89%E4%BD%8D%E4%B8%80%E9%AB%94-all-are-codes-ede2c1470513" target="_blank" rel="noopener">configuration as code</a>)</p><p><strong>DevOps</strong>：接受失效，视失效为开发周期中的一个元素</p><p><strong>SRE：</strong> 对于新的版本，建立一套可以量化的指标去衡量 “意外” 和 “失效”</p><p><strong>DevOps：</strong> 逐渐改变</p><p><strong>SRE</strong>：鼓励团队透过降低排除故障的成本来达成速交付的目的 (就是不需要一次做到最好，而是逐渐改变)</p><p><strong>DevOps</strong>：善用工具和自动化</p><p><strong>SRE</strong>：鼓励团队把自己今年的工作自动化，最小化” 工人智慧” 要做的事，把精力放在中长期的系统改善。</p><p><strong>DevOps</strong>：任何事都是可以被量测的</p><p><strong>SRE</strong>：相信维运是软体工程的范筹，规范关于可用性，运行时间 (uptime)，停机时间 (outages)，哪些是苦工等量测值。</p></blockquote><p>如果你已经认同 DevOps 是一个 “介面 (interface)”，那么以程式语言的角度来说就是：</p><blockquote><p><em>class SRE implements DevOps</em></p></blockquote><p>虽然实际上两者之间仍有需多独立的原则，SRE 并非完全 1:1 实作了 DevOps 的所有的概念，但最终他们两个的结论是相同的，也和程式语言相同，类别在继承介面之后，可以做更多的延伸，也可以实作更多不同的介面，SRE 包含了更多细节是 DevOps 原本所没有定义的。</p><p>在软体开发和维运的领域中，<strong>DevOps 和 SRE 并非互相竞争谁才是业界标准 </strong>，相反地，两者都是为了减少组职之间的隔阂与更快更好的软体所设计出来的方法，如果你想看更多细节的话，<a href="https://www.safaribooksonline.com/library/view/how-sre-relates/9781492030645/" target="_blank" rel="noopener">How SRE relates to DevOps</a> (Betsy Beyer, Niall Richard Murphy, Liz Fong-Jones) 这本书值得一看。</p><hr><blockquote><p>2. SLIs, SLOs, and SLAs</p></blockquote><p>SRE 的原则之一是针对不同的职务，给出不同的量测值。对于工程师，PM，和客户来说，整个系统的可用程度是多少，以及该如何测量，都有不同的呈现方式。</p><iframe src="//player.bilibili.com/player.html?aid=56870270&cid=99335415&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe><p>如果无法衡量一个系统的运行时间与可用程度的话，是非常难以维运已经上线的系统，常常会造成维运团队持续处在一个救火队的状态，而最终找到问题的根源时，可能会是开发团队写的 code 出了问题。</p><p>如果无法定出运行时间与可用程度的量测方法的话，开发团队往往不会将「稳定度」视为一个潜在的问题，这个问题已经困扰了 Google 好多年，这也是为什么要发展出 SRE 原则的动机之一。</p><p>SRE 确保每一个人都知道怎么去衡量可靠度以及当服务失效时该做什么事。这会细到当问题发生时，从 VP 或是 CxO，至最组织内部的每一个相关员工，都有做己该做的事。每一个「人」，该做什么「事」都被规范清楚，SRE 会和所有的相关人员沟通，去决定出 Service Level Indicators (SLIs) 与 Service Level Objectives (SLOs)。</p><blockquote><p>SLIs 定义了和系统「回应时间」相关的指标，例如回应时间，每秒的吞吐量，请求量，等等，常常会将这个指标转化为比率或平均值。</p><p>SLOs 则是和相关人员讨论后，得出的一个时间区间，期望 SLIs 所能维持一定水准的数字，例如「每个月 SLIs 要有如何的水准」，比较偏内部的指标。</p></blockquote><p>该影片也讨论到了 Service Level Agreements (SLAs)，即使这不是 SRE 每天所关心的数字。作为一个线上服务的提供者，<strong>SLA 是对客户的承诺 </strong>，确保服务持续运行的百分比，通常是和客户「谈」出来的，每年 (或每月) 的停机时间不得低于几分钟。</p><p>SLI, SLO, SLA 的概念和 DevOps 所提的「任何事都可以被量测」非常相似，这也就是为什么会说 class SRE implements DevOps 的原因之一了。</p><hr><blockquote><p>3. 风险和犯错预算</p></blockquote><p>对于风险，我们会用犯错预算来评估，犯错预算是一个量化的值，用来描述服务每天 (或每月) 可以失效的时间，若服务的 SLAs 是 99.9%，那么开发团队就等于有 0.1％的犯错预算通可以用。这个值是一个和 Product Owner 和开发团队谈过之后取得平衡的值，以下的影片也讲到了为什么 0 犯错预算并不是一个适合的值。</p><iframe src="//player.bilibili.com/player.html?aid=56870355&cid=99335555&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe><p>致力于将一个系统的可用程度维持在 100% 是一件会累死你又无意义的事情，不切实际的目标会限制了开发团队推出新功能到使用者手上速度，而且使用者多半也不会注意到这件事 (例如可靠度是 99.999999%)，因为他们的 ISP 业者，3G/4G 网路，或是家里的 WiFi 可能都小于这个数字。致力维持一个 100% 不间断的服务会严重限制开发团队将新功能交付出去的时间。为了要达成这个严酷的限制，开发人员往往会选择不要修 bug，不要增加功能，不要改进系统，反之，应该要保留一些弹性让开发团队可以自由发挥。</p><p>SRE 的原则之一就是计算出可以容忍的「犯错预算」，一旦这个预算耗尽，才应该开始将重点放在可靠性的改善而非持续开发新功能。</p><p>如第二个影片提到的，这个文化能让管理阶层买单是最重要的事，因为 SLIs 是大家一起订出来的，如果不照游戏规则走的话，SRE 又会沦为持续为了让系统维持一定的稳定度了而一直做苦力的事，但是没人知道 (因为没有订标准)，最终这个服务一定会失败。风险和犯错预算会将犯错视为正常的事，而改善的方式之一是让新功能持续且小规模的发布，这也和 DevOps 的原则相符合。</p><hr><blockquote><p>4. 琐事和琐事预算</p></blockquote><p>另一个 SRE 的原则是琐事的控管，如何减少琐事？何谓琐事？</p><blockquote><p>维运中需要手动性操作的、重复的，可以被自动化的</p><p>或是一次性，没有持久价值的工作，都是琐事。</p></blockquote><iframe src="//player.bilibili.com/player.html?aid=56870600&cid=99336041&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe><p>然而琐事并不是「我不想做的事」，举例来说，公司会有许多经常性的事务，一再的发生，例如开会，沟通，回 email，这些都不是琐事。</p><p>反之，像是每天手动登入某台机器，取得某个档案后做后续的处理，然后做成报告寄出来，这种就是琐事，因为他是手动，重复，可以被自动化的。</p><p>SRE 的原则是尝试使用软体工程的方法消除这些事情，当 SRE 发现事情可以被自动化后，便会着手执行自动化流程的开发，避免之后再做一样的事情，虽然使琐事最小化很重要，但实际上，这是不可能完全消除的，<strong>Google 致力于将 SRE 的日常琐事缩小到 50% 以下 </strong>，使得 SRE 成员可以将时间发费在更有意义的事情上，每季的回顾也都会检视成果。</p><p>然而琐事也并非完全是坏事，对于新进成员来说，先参与这事例行事务有助于了解这个服务该做些什么事情，这是相对低风险与低压力的，但是长远来看，任何一个工程师都不该一直在做琐事。</p><p>琐事管理也和 DevOps 的原则 — 任何事都是可被测量与减少组织之间的谷仓效应相符。</p><hr><blockquote><p>5. 客户可靠性工程 (Customer Reliability Engineering, CRE)</p></blockquote><p>个人觉得这个主题对目前而言稍微走远了，就不逐句翻译。</p><p>大意如何将 SRE 的概念传达出去，让 GCP 的客户知道该怎么正确的使用 GCP 的各项服务以及推广 SRE 的风气。</p><iframe src="//player.bilibili.com/player.html?aid=56870699&cid=99336238&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe><hr><blockquote><p>个人后记</p></blockquote><p>其实目前敝社渐渐转型中，的确处在一个从传统开发与维运转互相独立，到目前渐渐实做 DevOps 文化的路上，在支援了 SRE 部门 4 个月后，参与了很多现实面会碰到的挑战，也和大家一起制定自动化流程与改善目前现有的琐事，也渐渐朝 DevOps 的文化前进中，希望让大家可以知道：</p><blockquote><p>SRE 是软体工程，不该只是维运人员或是系统管理员。</p><p>DevOps 并不是一个职称，SRE 才是，就像你不会到市场菜摊跟老板说我要买 “青菜”，而且会说要买高丽菜还是小白菜吧！</p></blockquote><p>不过理想总是完美的，还是要面对现实，我们的公司不叫 Google，大部份的人也进不去 Google，Google 的 SRE 可能比大多数公司的软体开发工程师还要会写 code，比网路工程师还要懂网路，比维运工程师还要懂维运，在我们周围的环境所开的 SRE 职缺，其实很多都不是想象中的这样美好，琐事 / 手动的事可能还是占大多数，部门间还是存在隔阂，不会写 code 的 SRE 可能也很多，维运还是占日常工作的多数等现况。</p><p>传统维运人员或 IT 网管人员若想往 SRE 发展的话，也必需改变一下思维，跳脱舒适圈，在这个什么都 as code，什么都 as a service 的年代，不写 code 就等著等淘汰了。</p><p>改变是缓慢而且需要慢慢培养的，就让我们… 咦… P0 事件发生了！先这样啦！</p><h2 id="延伸阅读"><a href="#延伸阅读" class="headerlink" title="延伸阅读"></a>延伸阅读</h2><blockquote><p>在此感谢所有人的分享，推动技术的不断进步</p></blockquote><ul><li><a href="https://www.ithome.com.tw/news/105366" target="_blank" rel="noopener">Google 储存 SRE 团队负责人第一手经验大公开</a></li><li><a href="https://rickhw.github.io/categories/DevOps/SRE/" target="_blank" rel="noopener">https://rickhw.github.io/categories/DevOps/SRE/</a></li><li><a href="https://mp.weixin.qq.com/s/mQCofTmfWOhZPiga6nHKOA" target="_blank" rel="noopener">一篇文章彻底读懂 DevOps 与 SRE 来龙去脉 (译)?</a></li><li><a href="https://landing.google.com/sre/book.html" target="_blank" rel="noopener">Site Reliability Engineering</a></li><li><a href="https://blog.alswl.com/2018/09/devops-and-sre/" target="_blank" rel="noopener">DevOps 和 SRE</a></li></ul>]]></content>
    
    <summary type="html">
    
      SRE vs. DevOps: competing standards or close friends?
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>OSI 七层模型与 TCP/IP 四层模型</title>
    <link href="https://wsgzao.github.io/post/osi/"/>
    <id>https://wsgzao.github.io/post/osi/</id>
    <published>2019-06-20T06:59:49.000Z</published>
    <updated>2019-07-04T06:41:35.317Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>偶然从微信上看到《两地书》–K8s 基础知识 这篇文章，虽然是概括，但是配图和基础介绍都不错，本文单独把 OSI 七层模型与 TCP/IP 四层模型 方便自己回顾。</p><blockquote><p>OSI 七层模型与 TCP/IP 四层模型</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 06 月 26 日 - 更新 TCP/IP 的三次握手与四次挥手<br>2019 年 06 月 20 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/osi/">https://wsgzao.github.io/post/osi/</a></p><p><strong> 扩展阅读 </strong></p><p>《两地书》–K8s 基础知识<br><a href="https://mp.weixin.qq.com/s?__biz=MzUzNjAxODg4MQ==&amp;mid=2247483841&amp;idx=1&amp;sn=c236d6829a2cce8ad56236bf75085bbf&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?__biz=MzUzNjAxODg4MQ==&amp;mid=2247483841&amp;idx=1&amp;sn=c236d6829a2cce8ad56236bf75085bbf&amp;scene=21#wechat_redirect</a></p><p>简单的回顾下 TCP/IP 的三次握手与四次挥手 - <a href="https://blog.ansheng.me/article/tcp-ip-three-handshakes-and-four-waving/" target="_blank" rel="noopener">https://blog.ansheng.me/article/tcp-ip-three-handshakes-and-four-waving/</a></p><hr><h2 id="OSI-七层模型"><a href="#OSI-七层模型" class="headerlink" title="OSI 七层模型"></a>OSI 七层模型</h2><p>OSI 模型（Open System Interconnection Reference Model，缩写为 OSI）, 全名 “开放式系统互联通信参考模型”，是一个试图使各种计算机在全世界范围内互联为网络的标准框架。1983 年，国际标准组织（ISO）发布了著名的 ISO/IEC 7498 标准，它定义了网络互联的 7 层框架，也就是开放式系统互联参考模型。</p><p>7 层是指 OSI 七层协议模型，主要是：</p><ul><li>应用层（Application）</li><li>表示层（Presentation）</li><li>会话层（Session）</li><li>传输层（Transport）</li><li>网络层（Network）</li><li>数据链路层（Data Link）</li><li>物理层（Physical）</li></ul><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190625105716.png" alt=""></p><p>第 7 层应用层 (Application Layer)</p><p><strong> 主要功能：</strong> 为应用软件提供接口，使应用程序能够使用网络服务<br><strong> 典型设备：</strong> 网关<br><strong> 典型协议、标准和应用：</strong> http(80)、ftp(20/21)、smtp(25)、pop3(110)、telnet(23)、dns(53)</p><p>第 6 层表示层 (Presentation Layer)</p><p><strong> 主要功能：</strong> 数据的解码和编码，数据的加密和解密，数据的压缩和解压缩<br><strong> 典型设备：</strong> 网关<br><strong> 典型协议、标准和应用：</strong> ASCLL、PICT、TIFF、JPEG、 MIDI、MPEG</p><p>第 5 层会话层 (Session Layer)</p><p><strong> 主要功能：</strong> 建立、维护、管理应用程序之间的会话<br><strong> 典型设备：</strong> 网关<br><strong> 典型协议、标准和应用：</strong> RPC、SQL、NFS 、X WINDOWS、ASP</p><p>第 4 层传输层 (Transport Layer)</p><p><strong> 主要功能：</strong> 负责建立端到端的链接，保证保温在端到端之间的传输<br><strong> 典型设备：</strong> 网关<br><strong> 典型协议、标准和应用：</strong> TCP、UDP、SPX</p><p>第 3 层网络层 (Network Layer)</p><p><strong> 主要功能：</strong> 负责将分组数据从源端传输到目的端，网络层的主要作用就是路由和寻址<br><strong> 典型设备：</strong> 路由器<br><strong> 典型协议、标准和应用：</strong> IP、IPX、APPLETALK、ICMP</p><p>第 2 层数据链接层 (Data Link Layer)</p><p><strong> 主要功能：</strong> 在不可靠的物理链路上，提供可靠的数据传输服务<br><strong> 典型设备：</strong> 交换机、网桥、网卡<br><strong> 典型协议、标准和应用：</strong> 802.2、802.3ATM、HDLC、FRAME RELAY</p><p>第 1 层物理层 (Physical Layer)</p><p><strong> 主要功能：</strong> 利用传输介质为数据链路层提供物理连接，实现比特流的透明传输<br><strong> 典型设备：</strong> 集线器、中继器<br><strong> 典型协议、标准和应用：</strong> V.35、EIA/TIA-232</p><h3 id="TCP-IP-协议族常用协议"><a href="#TCP-IP-协议族常用协议" class="headerlink" title="TCP/IP 协议族常用协议"></a>TCP/IP 协议族常用协议</h3><p><strong> 应用层：</strong> TFTP，HTTP，SNMP，FTP，SMTP，DNS，Telnet 等等<br><strong> 传输层：</strong> TCP，UDP<br><strong> 网络层：</strong> IP，ICMP，OSPF，EIGRP，IGMP<br><strong> 数据链路层：</strong> SLIP，CSLIP，PPP，MTU</p><h2 id="TCP-IP-四层模型"><a href="#TCP-IP-四层模型" class="headerlink" title="TCP/IP 四层模型"></a>TCP/IP 四层模型</h2><p>互联网协议族（英语：Internet Protocol Suite，缩写为 IPS），是一个网络通信模型，以及一整个网络传输协议家族，为互联网的基础通信架构。它常被通称为 TCP/IP 协议族（英语：TCP/IP Protocol Suite，或 TCP/IP Protocols），简称 TCP/IP。因为这个协议家族的两个核心协议，包括 TCP（传输控制协议）和 IP（网际协议），为这个家族中最早通过的标准 。由于在网络通讯协议普遍采用分层的结构，当多个层次的协议共同工作时，类似计算机科学中的堆栈，因此又被称为 TCP/IP 协议栈（英语：TCP/IP Protocol Stack）。这些协议最早发源于美国国防部（缩写为 DoD）的 ARPA 网项目，因此也被称作 DoD 模型（DoD Model）。这个协议套组由互联网工程任务组负责维护。</p><p>TCP/IP 提供点对点的链接机制，将数据应该如何封装、定址、传输、路由以及在目的地如何接收，都加以标准化。它将软件通信过程抽象化为四个抽象层，采取协议堆栈的方式，分别实现出不同通信协议。协议套组下的各种协议，依其功能不同，被分别归属到这四个层次结构之中，常被视为是简化的七层 OSI 模型</p><p>TCP/IP 和 OSI 模型组并不能精确的匹配，但是我们可以尽可能的参考 OSI 模型并在其中找到 TCP/IP 的对应位置。如上图所示，我们已经标出了 TCP/IP 对应的四层位置所在。通常人们认为 OSI 模型最上面三层（应用层、表示层、会话层）在 TCP/IP 中是一个应用层。由于 TCP/IP 有一个相对比较弱的会话层，由 TCP 和 RTP 下的打开和关闭连接组成，并在 TCP/UDP 下的各种应用提供不同的端口号，这些功能被单个的应用程序添加。</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190625113518.png" alt=""></p><h3 id="TCP-IP-三次握手"><a href="#TCP-IP-三次握手" class="headerlink" title="TCP/IP 三次握手"></a>TCP/IP 三次握手</h3><p>在建立 TCP 连接之前需要进行三次握手，以便于链接到服务器，如果要断开服务器需要进行四次挥手，具体流程如下。</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190627120046.png" alt=""></p><ul><li><strong> 第一次握手：</strong> Client 将标志位 syn 设置为 1，随机产生一个 Number 值 seq=100，并将数据发送给 Server，Client 进入 SYN_SENT 状态，等待 Server 确认；</li><li><strong> 第二次握手：</strong> Server 收到数据包后 Client 设置的标志位 syn=1 知道 Client 要求建立连接，Server 将标志位 syn 和 ack 都置为 1，并且发送一个确认序号 ack=100+1，然后随机产生一个值 seq=130，并将该数据包发送给 CLient 以确认连接请求，Server 进入 SYN_RCVD 状态。</li><li><strong> 第三次握手：</strong> Client 收到确认后，检查 ack 状态是否为 100+1，ACK 是否为 1，如果正确则将标志位 ACK 置为 1，ack=130+1，并将该数据包发送给 Server，Server 检查 ack 是否为 130+1，ACK 是否为 1，如果正确则连接建立成功，Client 和 Server 进入 ESTABLISHED 状态，完成三次握手，随后 Client 与 Server 之间可以开始传输数据了。</li></ul><p>一个完整的三次握手也就是 <strong> 请求 — 应答 — 再次确认 </strong></p><h3 id="TCP-IP-四次挥手"><a href="#TCP-IP-四次挥手" class="headerlink" title="TCP/IP 四次挥手"></a>TCP/IP 四次挥手</h3><p>为什么要挥手，简单点来说就是既然建立了链接，那么肯定还要断开连接吖，连接总不能一直占用吧，这样多浪费系统该资源，下面让我们来看看四次挥手的流程。</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190704144039.png" alt=""></p><ul><li><strong> 第一次挥手：</strong> Client 发送一个 FIN，用来关闭 Client 到 Server 的数据传送，Client 进入 FIN_WAIT_1 状态。</li><li><strong> 第二次挥手：</strong> Server 收到 FIN 后，发送一个 ACK 给 Client，确认序号为 ack=100+1（与 SYN 相同，一个 FIN 占用一个序号），Server 进入 CLOSE_WAIT 状态。</li><li><strong> 第三次挥手：</strong> Server 发送一个 FIN，用来关闭 Server 到 Client 的数据传送，Server 进入 LAST_ACK 状态。</li><li><strong> 第四次挥手：</strong> Client 收到 FIN 后，Client 进入 TIME_WAIT 状态，接着发送一个 ACK 给 Server，确认序号为 131+1，Server 进入 CLOSED 状态，完成四次挥手。</li></ul><h2 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q &amp; A"></a>Q &amp; A</h2><ol><li><strong> 第一次挥手：</strong> Client 发送一个 FIN，用来关闭 Client 到 Server 的数据传送，Client 进入 FIN_WAIT_1 状态。</li><li><strong> 第二次挥手：</strong> Server 收到 FIN 后，发送一个 ACK 给 Client，确认序号为 ack=100+1（与 SYN 相同，一个 FIN 占用一个序号），Server 进入 CLOSE_WAIT 状态。</li><li><strong> 第三次挥手：</strong> Server 发送一个 FIN，用来关闭 Server 到 Client 的数据传送，Server 进入 LAST_ACK 状态。</li><li><strong> 第四次挥手：</strong> Client 收到 FIN 后，Client 进入 TIME_WAIT 状态，接着发送一个 ACK 给 Server，确认序号为 131+1，Server 进入 CLOSED 状态，完成四次挥手。</li></ol><h2 id="Q-A"><a href="#Q-A" class="headerlink" title="Q/A"></a>Q/A</h2><h3 id="为什么建立连接是三次握手，而关闭连接却是四次挥手呢？"><a href="#为什么建立连接是三次握手，而关闭连接却是四次挥手呢？" class="headerlink" title="为什么建立连接是三次握手，而关闭连接却是四次挥手呢？"></a>为什么建立连接是三次握手，而关闭连接却是四次挥手呢？</h3><p>这是因为服务端在 LISTEN 状态下，收到建立连接请求的 SYN 报文后，把 ACK 和 SYN 放在一个报文里发送给客户端。而关闭连接时，当收到对方的 FIN 报文时，仅仅表示对方不再发送数据了但是还能接收数据，己方也未必全部数据都发送给对方了，所以己方可以立即 close，也可以发送一些数据给对方后，再发送 FIN 报文给对方来表示同意现在关闭连接，因此，己方 ACK 和 FIN 一般都会分开发送。</p><h3 id="为什么建立连接要三次握手？"><a href="#为什么建立连接要三次握手？" class="headerlink" title="为什么建立连接要三次握手？"></a>为什么建立连接要三次握手？</h3><p><strong> 目的：</strong> 防止已经失效的连接请求到达服务端，创建无效的连接，浪费资源。<br><strong> 说明：</strong> 当客户端发出的第一个连接请求在网络上的某个节点被滞留了（网络会存在许多不可靠的因素），过一段时间后突然又到达了服务端，服务端误以为这是一个新的建立连接的请求，于是就会向客户端发出确认包并建立连接。<br>实际上客户端当前并没有发出创建连接的请求，就会丢弃服务端的确认包。而服务端却创建了连接并等待客户端发送数据，浪费了相关的资源。</p><h3 id="SYN-攻击"><a href="#SYN-攻击" class="headerlink" title="SYN 攻击"></a>SYN 攻击</h3><p>在三次握手过程中，服务器 <code>发送 SYN-ACK 之后，收到客户端的 ACK 之前</code> 的 TCP 连接称为半连接 (half-open connect)。此时服务器处于 SYN_RECV 状态，当收到 ACK 后，服务器转入 ESTABLISHED 状态.</p><p>SYN 攻击就是：攻击客户端在短时间内伪造大量不存在的 IP 地址，向服务器不断地发送 SYN 包，服务器回复 ACK 确认包，并等待客户的确认从而建立连接。由于源地址是不存在的，不会再发送 ACK 确认包，所以服务器需要不断的重发直至超时，这些伪造的 SYN 包将长时间占用未连接队列，正常的 SYN 请求被丢弃，目标系统运行缓慢，严重者引起网络堵塞甚至系统瘫痪。</p><p>SYN 攻击是一个典型的 DDOS 攻击。检测 SYN 攻击非常的方便，当你在服务器上看到大量的半连接状态时，特别是源 IP 地址是随机的，基本上可以断定这是一次 SYN 攻击</p><h3 id="为什么-TIME-WAIT-状态需要经过-2MSL-最大报文段生存时间-才能返回到-CLOSE-状态？"><a href="#为什么-TIME-WAIT-状态需要经过-2MSL-最大报文段生存时间-才能返回到-CLOSE-状态？" class="headerlink" title="为什么 TIME_WAIT 状态需要经过 2MSL (最大报文段生存时间) 才能返回到 CLOSE 状态？"></a>为什么 TIME_WAIT 状态需要经过 2MSL (最大报文段生存时间) 才能返回到 CLOSE 状态？</h3><p>虽然按道理，四个报文都发送完毕，我们可以直接进入 CLOSE 状态了，但是我们必须假象网络是不可靠的，有可以最后一个 ACK 丢失。所以 TIME_WAIT 状态就是用来重发可能丢失的 ACK 报文。</p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://coolshell.cn/articles/11564.html" target="_blank" rel="noopener">TCP 的那些事儿（上）</a><br><a href="https://coolshell.cn/articles/11609.html" target="_blank" rel="noopener">TCP 的那些事儿（下）</a></p>]]></content>
    
    <summary type="html">
    
      OSI 七层模型与 TCP/IP 四层模型
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>从国内跳槽至新加坡工作的经验分享</title>
    <link href="https://wsgzao.github.io/post/singapore/"/>
    <id>https://wsgzao.github.io/post/singapore/</id>
    <published>2019-06-09T06:59:49.000Z</published>
    <updated>2019-08-02T10:57:03.075Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://wx3.sinaimg.cn/large/7207510dgy1fv6xrebwasj21jj0uzqe6.jpg" alt=""></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>为什么会写这样一篇长文记录和分享自己在新加坡的工作生活，主要是我在 2018 年 6 月 9 日前需要了解新加坡的时候网上的参考信息屈指可数，出于这个原因我决定顺手记录来新加坡的经历方便自己回顾也方便他人参考。非常感谢在 2019 年出现的<a href="https://996.icu" target="_blank" rel="noopener">996.icu</a>，让更多人看到了一个不一样的世界，里面也有很多朋友分享了新加坡的生活经历。不管你现在的生活是 996 还是 669，我都希望大家可以从电视剧《都挺好》里发现那个最真实的自己。如果你只想了解我是如何来到新加坡的可以直接跳到最后一章。</p><blockquote><p>为帮助大家玩转新加坡，快速适应当地生活</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 06 月 09 日 - 更新新加坡一周年经历<br>2019 年 02 月 14 日 - 更新半年的经历以及 PR 申请流程<br>2018 年 09 月 09 日 - 增加新加坡 3 个月工作生活感受<br>2018 年 08 月 01 日 - 更新个人经验<br>2018 年 05 月 15 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/singapore/">https://wsgzao.github.io/post/singapore/</a></p><p><strong> 扩展阅读 </strong></p><p>逃离 996 - <a href="https://github.com/623637646/996.Leave" target="_blank" rel="noopener">https://github.com/623637646/996.Leave</a></p><hr><h2 id="认识狮城"><a href="#认识狮城" class="headerlink" title="认识狮城"></a>认识狮城</h2><p>姓名：新加坡</p><p>年龄：53 岁（成立于 1965 年，国庆日为每年的 8 月 9 日）</p><p>家庭住址：北半球赤道地区，位于马来半岛最南端 （北纬 1°22′，东经 103°48′）</p><p>住房面积：新加坡国土面积 710.3 平方公里 （新加坡面积是上海的 1/9，北京的 1/23）</p><p>家庭成员：人口约 520 万，密度达到每平方公里 7700 多人（排在世界前列）</p><p>相貌特征：新加坡多元种族和文化的相互融合是其极具魅力的原因之一，由华族（占全国人口约四分之三）、欧亚族、印度族、马来族、土生华人构成。</p><p>性格特征：新加坡以实行严格的法律和制度著称，无论是居民还是游客，都需要予以足够重视，否则可能会被课以重罚。当然，如果您遵循当地法律规章，也不必过分担心。</p><blockquote><p>所获荣誉：或许这些荣誉只属于过去，我们更需要关心的是现在和未来会怎样</p></blockquote><p>让人最想移民的国家全球排名第一<br>全球最具竞争力国家排名第一<br>最适应亚洲人士居住的地方全球排名第一<br>城市基础设施建设全球排名第一<br>全球化程度最高的城市排名第一</p><p>其他方面：<a href="http://www.visitsingapore.com.cn/travel-guide-tips/about-singapore/" target="_blank" rel="noopener">http://www.visitsingapore.com.cn/travel-guide-tips/about-singapore/</a></p><h2 id="旅游出入境"><a href="#旅游出入境" class="headerlink" title="旅游出入境"></a>旅游出入境</h2><blockquote><p>签证</p></blockquote><p>中国公民去新加坡须提前申请有效签证，不可以落地签。</p><p>中国公民申请的新加坡旅游 / 商务签证为电子签证（e-Visa），在获得签证后，建议上网打印多份有效签证以防遗失。签证费为每人 SG$30。</p><p>新加坡签证可多次入境，有效期分别有 35 天 / 62 天 / 2 年，由签证官根据申请人资料而定。逗留时间则由入境官决定，通常为 14-30 天。从 2015 年 6 月 1 日起新加坡将给予符合条件的中国公民有效期长达 10 年的多次入境签证。</p><p><a href="http://www.visitsingapore.com.cn/travel-guide-tips/travelling-to-singapore/" target="_blank" rel="noopener">http://www.visitsingapore.com.cn/travel-guide-tips/travelling-to-singapore/</a></p><blockquote><p>申请途径 How to Apply</p></blockquote><p>2014 年 12 月 8 日起大使馆及各领事馆停止接收签证申请，可登录新加坡外交部官网，查询中国国内官方指定的签证机构，办理新加坡签证。</p><blockquote><p>所需资料 Required Information</p></blockquote><ol><li>个人信息表（登录新加坡外交部官网下载表格，链接：<a href="http://www.mfa.gov.sg）" target="_blank" rel="noopener">www.mfa.gov.sg）</a></li><li>户口本（原件或扫描电子版，户主 + 个人页复印件）</li><li>身份证（原件或正反面扫描电子版，正反面复印件）</li><li>护照（原件或个人页扫描电子版，个人页复印件，有效期 6 个月以上）</li><li>2 张 2 寸白底免冠照片</li><li>在职证明原件或相关职业证书</li></ol><blockquote><p>出入境</p></blockquote><p>从 2018 年 10 月 4 日起，新加坡纸质入境卡（人称 “白卡”）即将走入历史！取而代之的是电子化入境卡。</p><p>访客可通过移民关卡局官方网站 <a href="https://www.ica.gov.sg/" target="_blank" rel="noopener">https://www.ica.gov.sg/</a> 或下载手机应用程序填写资料。通过手机填写资料还有自动储存功能，以方便下一次入境时使用。而与家人或小组团体同游新加坡的人，能够以团体方式提交入境资料。</p><p>离境前别忘了退税，在附有 “退税” 标志的场所消费满 100 新币以上，即可退回 7% 的商品及服务税，退税时需出示购物发票或收据。具体的退税要求，可咨询工作人员。</p><blockquote><p>其它注意事项</p></blockquote><p>电源插座：新加坡使用的标准电流是 220-240 伏特交流电（50 赫兹），在这里，您可以使用三眼电源插座。</p><p><a href="http://www.visitsingapore.com.cn/travel-guide-tips/" target="_blank" rel="noopener">http://www.visitsingapore.com.cn/travel-guide-tips/</a></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190802161219.png" alt=""></p><h2 id="新加坡工作准证"><a href="#新加坡工作准证" class="headerlink" title="新加坡工作准证"></a>新加坡工作准证</h2><blockquote><p>关于工作准证的最新信息请以新加坡人力部 (MOM) 发布的为准</p></blockquote><p><a href="https://www.mom.gov.sg/" target="_blank" rel="noopener">https://www.mom.gov.sg/</a></p><p>在新加坡工作，新加坡人力部 Ministry Of Manpower (MOM) 是最常打交道的政府部门，工作准证不仅是由人力部批准和颁发所有文件提交最终也是到达人力部</p><p>注意：所有提交给 MOM 的资料原件，都需要在入境的时候随身携带。以便在去人力部办卡的时候，让长官核实和查阅。</p><ol><li>新版卡片上将不再印刷准证的到期日期，新版卡片会印上二维码（QR Code），下载 SGWorkPass 的手机 APP 后，可以扫码查看持卡人的职务、证件是否有效等信息</li><li>如果过海关或签合约等需要核对卡片截止日期时，不再可以只看卡面信息，还需要扫码或在线上核对截止日期等，建议保存 SGWorkPass 截图至手机中以防万一</li></ol><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190802161307.png" alt=""></p><p><a href="https://docs.qq.com/sheet/DeVh5ZEhKWnhCTldK" target="_blank" rel="noopener">如果发现表有错误请点击链接申请编辑更新，谢谢</a></p><h3 id="Work-Permit-WP"><a href="#Work-Permit-WP" class="headerlink" title="Work Permit (WP)"></a>Work Permit (WP)</h3><p>WP 是人力部设置的给外国低水准员工提供的工作准证。</p><p>对申请者的要求：薪水和学历：无要求<br>年龄：马来西亚人（18-58 周岁），非马来西亚人（18-50 周岁）；<br>对公司的要求：需要为其购买保额至少 15000 新币的保险；缴纳 5000 新币担保金<br>注意事项：<br>公司需要先为雇员申请好 WP 并办理保险，才可以持 WP 准证进入新加坡。在申请的状态中，本人不可以进入新加坡。</p><h3 id="S-PASS-SP"><a href="#S-PASS-SP" class="headerlink" title="S PASS (SP)"></a>S PASS (SP)</h3><p>SP 是人力部设置的给外国中级技术水准雇员提供的工作准证。</p><p>对申请者的要求：学历：大专，本科，或者技术资质认证（需要至少一年全职学习获得的技术认证）；<br>工作年限：虽然没有明文规定最少需要多少年的工作经验，但工作经验会作为一个审核标准；<br>对公司的要求：所付起薪 2200 新币；</p><p>注意事项：<br>也有公司人头配额限制：服务行业 SP 人数不可超过总员工的 15%，其它行业是 20%。<br>你在申请之前需要确保学历在 Dataflow，学信网及中国学位与研究生教育信息网上可以查到。另外，针对不同的行业，也有可能需要提交相关的专业证明。</p><h3 id="Employment-Pass（EP）"><a href="#Employment-Pass（EP）" class="headerlink" title="Employment Pass（EP）"></a>Employment Pass（EP）</h3><p>EP 是人力部设置的给外国专业人员（管理层，主管或专业职位）提供的工作准证. 是工作准证中级别最高的。</p><p>对申请者的要求：<br>年轻的申请者需拥有优秀院校的毕业证书，且达到 3600 的雇佣薪水以及拥有相关专业经验才可以申请。<br>至于年长的申请人，则必须拥有更高的薪水以及相应工作经验和工作质量。</p><p>对雇主的要求：<br>所付起薪 3600 新币</p><p>注意事项：<br>和申请 SP 一样，在申请之前需要确保学历在 Dataflow，学信网及中国学位与研究生教育信息网上可以查到。另外，针对不同的行业，也有可能需要提交相关的专业证明。<br>根据对应的准证类型，提交人力部 (MOM) 所要求的材料</p><ul><li>有效的护照信息</li><li>必要的技能证书</li><li>有效的毕业证</li></ul><p>2018 年 1 月 1 日起两件重要变化</p><ul><li>EP 准证持有人月薪至少 6000 新币以上可以给配偶和孩子申请相关准证(DP)</li><li>EP 准证持有人月薪至少 12000 新币以上可以申请父母长期探访准证（LTVP)</li></ul><h2 id="家庭成员准证"><a href="#家庭成员准证" class="headerlink" title="家庭成员准证"></a>家庭成员准证</h2><h3 id="Dependant‘s-Pass-家属准证（DP）"><a href="#Dependant‘s-Pass-家属准证（DP）" class="headerlink" title="Dependant‘s Pass 家属准证（DP）"></a>Dependant‘s Pass 家属准证（DP）</h3><p>家属准证，在新加坡工作或经商，并持有 EP SP 或 Enptrpass 的人士，可为自己的配偶及 21 岁以下小孩申请的一种准证。持家属准证的小孩，可直接入学新加坡政府中小学。</p><p>薪水：担保人固定月薪薪水需达到 5,000 新币以上。（2018 年 1 月 1 日起至少达到 6000 新币以上）。</p><p>工作：EP 或创业准证家属，可通过公司向人力部申请新加坡工作的凭证 LOC（Letter of consent），批准后，可直接工作（不占用公司配额）。SP 家属准证，需申请工作准证后才能工作。家属准证（DP）持有人申请到工作准证（EP 或 SP）后需取消 DP，SP 家属取得的工作准证有效期与 SP 持有人准证有效期相关。</p><h3 id="Long-Term-Visit-Pass-长期探访准证（LTVP）"><a href="#Long-Term-Visit-Pass-长期探访准证（LTVP）" class="headerlink" title="Long Term Visit Pass 长期探访准证（LTVP）"></a>Long Term Visit Pass 长期探访准证（LTVP）</h3><p>长期探访准证，是新加坡政府颁发的一种可以在新加坡长期居住的准证，期限从半年到十年不等。其中新加坡公民的配偶又可以申请获得 LTVP+。目前的审批部门有两个，一个是 ICA 移民厅，一个是 MOM 人力部。</p><p>需要去移民厅申请的：</p><ol><li>新加坡公民的配偶<br>2.PR 的配偶</li><li>新加坡公民 / PR 未满 21 周岁的小孩</li><li>新加坡公民 / 21 周岁以上 PR 的父母</li><li>寻求在新加坡工作的有关高校毕业生</li><li>小孩 / 孙辈在新加坡持学生准证读书的母亲或外祖母</li><li>寻求准许在新加坡分娩者</li></ol><p>新加坡移民局网址<br><a href="https://www.ica.gov.sg/" target="_blank" rel="noopener">https://www.ica.gov.sg/</a></p><p>需要去人力部申请的：</p><ol><li>EP/SP 准证持有者的配偶（2018 年 1 月 1 日起至少 6000 新币）</li><li>EP/SP 准证持有者未满 21 周岁的未婚残疾子女（2018 年 1 月 1 日起至少 6000 新币）</li><li>EP/SP 准证持有者未满 21 周岁的未婚继子女（2018 年 1 月 1 日起至少 6000 新币）</li><li>EP/SP 准证持有者的父母（2018 年 1 月 1 日起至少 12000 新币）</li><li>Entrepass（创业准证）的父母</li></ol><p>新加坡人力部网址：<br><a href="https://www.mom.gov.sg/" target="_blank" rel="noopener">https://www.mom.gov.sg/</a></p><h2 id="新加坡通讯指南"><a href="#新加坡通讯指南" class="headerlink" title="新加坡通讯指南"></a>新加坡通讯指南</h2><p>国内的手机大部分都可以在新加坡直接换卡使用，除非你的手机是中国移动 4G 定制版本，由于网络制式的区别，无法使用新加坡 4G 网络，新加坡目前 2G 网络停止服务。</p><blockquote><p>小贴士：建议使用全网通手机，去国外任何地方都可以直接换卡使用。</p></blockquote><p>运营商：新电信（Singtel）、星河（Starhub）和 M1（Mobile One）</p><p>在新加坡机场、邮局、7-11 便利店和代理商都可以购买和充值电话卡，记得一定要带上护照，新加坡的手机卡采用实名制。推荐大家下载所用运营商的 App，查询和购买话费、流量等。</p><blockquote><p>Zero1: Get Ready For Unlimited Data | Plans</p></blockquote><p>我自己办理的是 Zero1 的 9.9 新币 / 月无限流量套餐</p><p>详情请参考官网：<a href="https://zero1.sg/" target="_blank" rel="noopener">https://zero1.sg/</a></p><h2 id="新加坡交通指南"><a href="#新加坡交通指南" class="headerlink" title="新加坡交通指南"></a>新加坡交通指南</h2><p>新加坡主要交通出行方式：地铁（MRT）、轻轨（LRT）、巴士（Bus）和德士（Taxi）。</p><p>其中地铁（MRT）是新加坡最便捷的交通工具，也是日常最佳的出行方式。根据官方 2017 年 1 月份提供的最新信息显示，全岛共设有 142 个车站，目前主要的运营线中，南北运营线以 “NS” 红线标明，东西运营线以 “EW” 绿线标明，东北运营线以 “NE” 紫线标明，环线以 “CC” 黄线标明，市区运营线以 “DT” 蓝线。</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190802161743.png" alt=""></p><p>新加坡地铁图</p><p><a href="https://www.lta.gov.sg/content/ltaweb/en/public-transport/mrt-and-lrt-trains/train-system-map.html" target="_blank" rel="noopener">https://www.lta.gov.sg/content/ltaweb/en/public-transport/mrt-and-lrt-trains/train-system-map.html</a><br><a href="https://exploresg.com/ditie/" target="_blank" rel="noopener">https://exploresg.com/ditie/</a></p><p>新加坡地铁和巴士车 (站) 内规定</p><ol><li>不可吃喝、吸烟、携带榴莲、大声喧哗和带宠物 </li><li>Bus 不报站、上下车需要刷卡</li></ol><p>温馨提示</p><ol><li>地铁和巴士上冷气很足，建议携带薄外套</li><li>在 20 分钟内，地铁和巴士之间转换，车资有优惠</li><li>在地铁或者商场等使用扶梯时，左侧是站立侧，右侧是快速通道</li></ol><h2 id="新加坡房屋指南"><a href="#新加坡房屋指南" class="headerlink" title="新加坡房屋指南"></a>新加坡房屋指南</h2><blockquote><p>组屋(HDB)</p></blockquote><p>新加坡的“组屋”，全称为组合房屋。由新加坡建屋发展局（HDB）不以盈利为目的承担建筑的楼房，为大部分新加坡人（80%）的住所。</p><p>组屋一般分为三房式、四房式和五房式。三房式指一厅两房，使用面积约 60 平方米；四房式是一厅三房，使用面积约 90 平方米；五房式是两厅三房，使用面积大致在 110 平方米。</p><p>组屋的区分都是按照地区名 + 数字，例如：PasirRis Block 186（巴西立大牌 186）、YishunBlock 210（义顺大牌 210）等。</p><p>屋内客厅，厨房，卫生间都是公用设施，一般会配备冰箱，洗衣机，空调或者风扇。</p><p>租房费用（一般情况下）：</p><p>新型组屋 (近 10 年内建成的) 相对条件会好很多 (平均价格 S$1000-1200 / 间)<br>单人单间：500-1000 新币<br>二人间：350-550 新币 / 人<br>四人间：270-350 新币 / 人</p><p><strong> 小贴士 </strong></p><ol><li>新加坡政府规定租住的房子必须要能在建屋局上注册。正常情况下，注册要求至少住 6 个月。如果不能注册，就是不合法的房屋。</li><li>如果退租，一定要提前一月声明，以防押金不退。</li><li>仔细看合同，仔细看合同，仔细看合同。</li></ol><blockquote><p>私人公寓(Condo)</p></blockquote><p>公寓，常见两房式或三房式，相当于国内的高档成熟社区，内有免费游泳池、健身房，BBQ 等公共设施，住宿环境相对较好，价格也相对高一些；大部分的 condo 房间都有主人房与非主人房之分，主人房有自己独立的洗手间和相对宽敞的卧室，当然价格也比非主人房高 200-300 / 月(非主人房平均价格<br>S$1,000-1,500 / 间 / 月)</p><blockquote><p>排屋(Terrace)</p></blockquote><p>独门不独栋的联排别墅，此类出租房源相对较少，住宿环境、价格与房子位置、条件有相当大的关系。</p><blockquote><p>独栋别墅(Landedproperty)</p></blockquote><p>少见于房间出租。</p><h2 id="租房"><a href="#租房" class="headerlink" title="租房"></a>租房</h2><blockquote><p>如果英语不是太差，不推荐狮城 BBS 或者微博租房，如果你有认识的新加坡房产中介自然是最佳选择</p></blockquote><p>Property Guru - <a href="http://www.propertyguru.com.sg/" target="_blank" rel="noopener">http://www.propertyguru.com.sg/</a></p><p>新加坡本地发布平台，房源多。使用下来感觉 Property Guru 信息发布是最多的，信息筛选条件多，容易搜索到希望的房源。多为中介发布，有中介费。</p><p>Nestia - <a href="https://www.nestia.com/" target="_blank" rel="noopener">https://www.nestia.com/</a></p><p>新加坡本地发布平台，功能强。Nestia 上的房源也比较多，但感觉不如 Property Guru。不过 Nestia 可以以某一建筑（公司地址）为中心从远及近的搜索房源。找步行距离的房源就很合适了。另外自带的导航也不错。所以我是 Property Guru 和 Nestia 结合使用。</p><p>99.co - <a href="https://www.99.co/" target="_blank" rel="noopener">https://www.99.co/</a></p><p>新加坡本地发布平台，平台新。和上面两个相比算是一个比较新的平台，数据没有 Property Guru 多但是针对房屋本身的介绍更加详细，房源信息相对真实。</p><p>在新加坡租房，有哪些经验可以分享？<br><a href="https://www.zhihu.com/question/22430961" target="_blank" rel="noopener">https://www.zhihu.com/question/22430961</a></p><h2 id="在新加坡买房与中国有何不同？"><a href="#在新加坡买房与中国有何不同？" class="headerlink" title="在新加坡买房与中国有何不同？"></a>在新加坡买房与中国有何不同？</h2><blockquote><p>无论在中国还是新加坡买房前后都记得关注下政策上的变化，新加坡买房的流程很简单，首付 = 房屋价格 + 税 + 中介费 - 贷款额度。</p></blockquote><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190802162119.png" alt=""></p><p>① 面积</p><p>说到面积，首先让中国买家摸不着头脑的，就是面积单位的换算。中国买家习惯用平方米（也称平方公尺）计算面积，来新加坡选购房子时听到的都是平方英尺，往往脑子得转一圈才知道个大概。1 平方米约等于 10.8 平方英尺。100 平方米就是 1080 平方英尺。</p><p>除了计算单位不同，“面积”一词在两地公寓市场上的定义也不一样。在中国，面积指的是建筑面积；新加坡算的是实用面积。建筑面积的算法比较繁琐。简单来讲，是根据各套房屋的套内建筑面积，求得各套房屋分摊所得的共有建筑分摊面积，比如门口的面积、楼梯等，都按比例算进每一个单位的建筑面积。</p><p>所以，同一个公寓单位，其建筑面积一定会大于实用面积，通常后者比前者少 20％左右。在中国买一个 “100 平方米” 的单位，和在新加坡买一个“1080 平方英尺”（相当于 100 平方米）相比，后者明显感觉宽敞一点，就是这个道理。</p><p>② 地契</p><p>中国的房产地契通常是 70 年左右，而新加坡的则有 99 年、999 年和永久地契之分。新加坡的房产因为地契年限长，颇受外籍人士青睐。其中，永久地契的房产一般要比 99 年地契的贵 20％。尽管如此，永久地契一直很抢手，也深受中国买家欢迎，因为买家看准这块市场的保值与增值。</p><p>这其中很大程度上因为新加坡的地皮比较少，想要建新楼必须拆掉现有的建筑。不像中国地皮比较多，还有可开发的地段。新加坡永久地契的地段价值比较高，所以如果进行集体出售、或是被政府征用的话，永久地契房地产的房主会可得到较高的补偿。</p><p>物以稀为贵，永久地契房产越是少见，也就越炙手可热。此外，永久地契对中国买家还有另一大吸引力，那就是永久地契满足了 “总觉得要给后代留下点什么” 的传统华人心愿。所以说，新加坡房产能如此吸引外国买家，与地契久脱不了关系。</p><p>③ 贷款</p><p>在新加坡首次购房的买家，可向金融机构贷款的房贷比率顶限为 80％，外籍人士一般则最高 70％。在中国，外国人一般不能向本土中国银行贷款，只能通过外资银行或中国银行境外支行。</p><p>原本新加坡和中国在房贷比率顶限方面有很大差别。不过两国都不断调整房贷比率顶限，因此两国的房贷比率顶限差别已缩小。</p><p>④ 税收</p><p>在新加坡，如果在一定期限里卖掉公寓，卖家需要上缴印花税。在 2011 年 1 月 14 日过后买房的购屋者，只要在四年内卖房屋都需要支付卖方印花税，第一、二、三和四年卖掉房产的税率分别是 16％、12％、8％和 4％。此后就不必上缴卖家印花税。</p><p>在中国，除了印花税外，还需要上缴增值税。为了给中国房地产市场降温，中国政府在 2013 年实施 20％的房地产买卖增值税。所谓增值税，就是对卖家卖房所得的利润征收的税。譬如，150 万人民币买的房子在几年后以 200 万人民币卖掉，卖家所赚得的 50 万就将需要以一定的比率交税。</p><p>⑤ 车位</p><p>在中国购买中高档住宅，需要另外购买车位。而在新加坡，买家不需要另付车位费，发展商一般会为每个新单位赠送一个车位。可不能小瞧这个车位费。近年来，车位费在中国节节攀升，动辄十几、二十万人民币，是一笔不小的开销。</p><p>新加坡私人公寓不收车位费，而是将停车场的修建和维护等费用，包括在每月的项目管理费之中。管理费除了车库，还包括游泳池、健身房等设施，每月一般是几百元新元。如果每月的管理费是 300 元新元（约 1400 元人民币），一年就是 1 万 7000 元人民币，15 年刚好是 25 万 5000 元人民币。总体来讲，这要比中国的车位 “划算” 得多。</p><h2 id="新加坡医疗指南"><a href="#新加坡医疗指南" class="headerlink" title="新加坡医疗指南"></a>新加坡医疗指南</h2><p>新加坡是一个热带国家，从国内刚过去有可能因水土不服引起的伤风、感冒、皮肤敏感或蚊虫叮咬等。出行之前可以带一些三九胃泰、牛黄解毒等日常药品之类的药品，防范于未然是最好的。</p><p>看医生：在新加坡持有工作签证，所在的公司会按照新加坡劳工部规定给每位员工会购买医疗保险或者费用报销。</p><p>医疗保险：一般是三种模式</p><ol><li>直接去合作门诊，提供公司信息，看病不用自己拿钱。</li><li>直接去合作门诊，提供公司信息，看病前给门诊 5 新币（每个公司不一样），其它的费用不用自己拿。</li><li>直接去合作门诊，自己先付产生的费用，然后去公司报销。意外伤害险等（视公司合同规定）。</li></ol><h2 id="公立和私立医疗服务"><a href="#公立和私立医疗服务" class="headerlink" title="公立和私立医疗服务"></a>公立和私立医疗服务</h2><blockquote><p>中国人在新加坡看病就好比外国人在中国看病一样不是很方便，价格不便宜，小病也有可能看成大病</p></blockquote><p>新加坡的医疗服务体系以优质高效著称，选择面广, 综合医院，专科医院，私人诊所遍布全国, 随处可见；不仅为全新加坡的公民，永久居民，外籍工作人士提供服务，同时周边国家的高端人群, 包括东南亚、亚洲、欧洲、中东阿拉伯等国家的病患都会将新加坡的国际医疗服务作为他们的首选。</p><p>新加坡的公立医疗机构和私立医疗机构在整个医疗系统中扮演着不同的角色。基础医疗门诊 80% 由私立医疗机构 / 家庭医生诊所提供，另外 20% 则是由政府综合诊疗所提供；而综合医疗，包括各类科室的住院，专科和 24 小时急诊主要由公立医疗机构提供，占 80% 的比例，剩下的 20% 由私立医疗机构提供。由于政府的有效规划和管控，公立医院和私立医院相辅相成, 缺一不可。</p><p>在公立医疗机构就诊一般都需要提前预约, 候诊时间较长, 也不能自由选择医生。由于那里的医生要面对更多的患者, 为每个患者服务的时间相对较短；而私立医疗机构由于患者相对较少, 不需要预约, 候诊时间较短，还可以自己选择医生，医生也能与患者作更多的交流, 提供更细致的服务，收费就相应高一些。</p><p>一些新加坡的公立医院也为自费病人提供高端医疗服务, 设有针对性的部门和项目, 如体检，会诊，专科治疗等。基础的检查和服务, 公立医院比私立医院收费较低；对于外籍人士和高端的服务项目, 公立和私立医院的收费差异不大。</p><p><a href="https://mp.weixin.qq.com/s?__biz=MzIwMTQxODUxNw==&amp;mid=2650871863&amp;idx=3&amp;sn=b9536c73a1b6a0e0ed02019598d75c35&amp;chksm=8d1b8a4dba6c035b898a133fdf30ec613eb6826a0f4a66d5befe6364a04e24fb6bde9a981ce7&amp;scene=21" target="_blank" rel="noopener">8 家新加坡著名的公立和私立医院</a></p><h2 id="货币兑换和汇款"><a href="#货币兑换和汇款" class="headerlink" title="货币兑换和汇款"></a>货币兑换和汇款</h2><blockquote><p>如果时间宽裕，推荐走新加坡工商银行渠道</p></blockquote><p>新加坡实行货币开放政策，货币兑换中心随处可见，尤其是在牛车水 (China Town) 附近。如有汇款需求到国内，可以先去牛车水汇款 (珍珠坊二楼)，方便快捷。等周围熟悉后，推荐去淡宾尼(Tampines) 汇款到国内，汇率会比其它地方高一些。具体的地方，在地图搜索 Tampines Money Exchange Center。 </p><p>小贴士：汇款中心一般可以汇到中国邮政、中国农业、中国交通、中国招商和中国银行等。第一次汇钱到国内，当填写汇款单据的时候一定要知道对方银行卡是在 <strong> 省 </strong> 市 ** 银行支行开户的(很重要)。</p><h2 id="法律法规"><a href="#法律法规" class="headerlink" title="法律法规"></a>法律法规</h2><p>新加坡向来是给世人展示优美环境，井然秩序，舒适安全的名片，然而这些美好的展现离不开新加坡法律制度的约束和规范。Singaporeis a“fine”country 完整的诠释了这两方面。所以在新加坡生活，你需要注意以下细节：</p><ol><li>自动排队：公共场合最经常听到的一句话就是 please queue！</li><li>着装：不同场合穿不同衣服, 建议每天换衣服。</li><li>公共习惯：乘坐公共交通或者在公共场合用餐时, 切忌大声喧哗, 不然你一样会被当做异类奥! 而且记得再饿也要撑到下车再用餐。</li><li>言论：新加坡是多文化和宗教融合的国家, 公共场合不要发表敏感政治言论或者宗教话题, 这也体现互相尊重。</li><li>不当行为：竖中指可能会被当做种族歧视处理的</li><li>如厕：来也匆匆, 去也冲冲。如若不然请准备 500 新币吧。</li><li>口香糖：公共场所不允许嚼口香糖, 不可以随意买卖, 允许带少量入境, 正是这个奇葩的规定维护了公共环境的整洁。</li><li>吸烟：新加坡公共场所绝对禁烟。如若吸烟不幸被抓到, 恭喜你一个月的工资 (高达 2000 新币) 为国家做贡献了!</li><li>垃圾：乱丢垃圾初犯者将处高达 1000 新币罚款, 再犯者将罚款额提高至 2000 新币以及在劳改法令下受罚。</li><li>交通规则：闯红灯, 随便乱穿马路这些不多啰嗦。违反的是规则, 伤害的是人身安全, 因为小编也感觉马路上的车如同闪电般行驶。</li><li>不可非法聚会和使用暴力</li></ol><p>以上内容是提醒大家在生活细节方面应遵守的规则, 但有些行为未必就可以罚款结案的, 比如: 签证到期后逾期逗留、抢劫、公共场所涂鸦、纵火、携带毒品等这些可都是在鞭刑的定罪范围内的。</p><p><strong> 最后郑重的提醒各位：</strong> 在机场不要发扬助人为乐精神帮陌生人携带物品, 因为很有可能你同时把生命交给了别人(运输毒品和贩毒同罪)。</p><h2 id="工作准证遗失如何处理"><a href="#工作准证遗失如何处理" class="headerlink" title="工作准证遗失如何处理"></a>工作准证遗失如何处理</h2><ol><li>发现丢失后立即携带护照或者工作准证的复印件到任何一间警察局报案，记得保存报案记录原件。</li><li>通知雇主公司 HR, 让其在 7 天之内在新加坡人力部网上提交补办工作准证的申请。</li><li>费用: 首次补办 100 新币, 第二次是 300 新币(一般在提交申请补办 4 个工作日可去新卡)</li></ol><h2 id="银行卡遗失如何处理"><a href="#银行卡遗失如何处理" class="headerlink" title="银行卡遗失如何处理"></a>银行卡遗失如何处理</h2><ol><li>发现遗失后立即拨打银行客户服务中心热线挂失</li><li>银行客户专员会核对护照和工作准证信息, 然后等待新卡邮寄到住处或者去支行直接领取。</li></ol><p>POSB 用户请拨打 18003396963<br>DBS 用户请拨打 18001111111<br>UOB 用户请拨打 18002222121<br>OCBC 用户请拨打 18003633333</p><h2 id="护照遗失如何处理"><a href="#护照遗失如何处理" class="headerlink" title="护照遗失如何处理"></a>护照遗失如何处理</h2><p>如护照遗失或被盗, 请立即到中国驻新加坡大使馆如实填写《护照遗失陈述表》，提供关于护照遗失或被盗的情况说明, 以及提供报警记录原件及复印件。如护照损毁, 请提交损毁的护照, 以及护照损毁的原因说明。</p><p>具体的更换护照和网上预约等等详细流程请参考大使馆的官网：<a href="http://www.chinaembassy.org.sg/chn/" target="_blank" rel="noopener">http://www.chinaembassy.org.sg/chn/</a></p><p>中国驻新加坡大使馆信息:</p><p>地址: 150 TANGLIN ROAD,SINGAPORE 247969</p><p>领事部：64712117；92971517(仅限紧急领保求助, 不接受证件咨询)</p><p>Email: <a href="mailto:chinaemb_sg@mfa.gov.cn" target="_blank" rel="noopener">chinaemb_sg@mfa.gov.cn</a></p><p>办公时间：周一至周五(节假日除外)</p><p>上午 9:00-11:30</p><h2 id="新加坡日常-App-推荐"><a href="#新加坡日常-App-推荐" class="headerlink" title="新加坡日常 App 推荐"></a>新加坡日常 App 推荐</h2><blockquote><p>如果是 Android 记得安装 Google 框架，如果是 iOS 记得调整更改 Apple ID 国家或地区</p></blockquote><p>交通: Grab(类似国内滴滴)、Google Map(谷歌地图)、SG Buses(公交时刻表)、Mobike（摩拜单车国内账户通用）</p><p>社交: Facebook、WhatsApp、Twitter、Instagram</p><p>购物: Shopee、Lazada、eBay、Amazon、淘宝国际、京东国际、网易考拉、网易严选、小米有品、拼多多</p><p>娱乐: Youtube(视频必备)、 Golden Village(电影院)、CATHAY (电影院)</p><p>快递: <a href="http://www.xiaopodao.com/" target="_blank" rel="noopener">小坡岛集运</a>、淘宝直送 / 集运</p><p>微信公众号: 新加坡眼、新加坡狮城椰子</p><p>特别推荐: </p><ul><li><a href="https://zero1.sg/" target="_blank" rel="noopener">Zero1</a>: 9.9 每月无限流量手机卡</li><li>SG BusLeh: 更好用的公交时刻表</li><li><a href="http://refer.eatigo.com/eati17aqf-1v9" target="_blank" rel="noopener">eatigo</a>: 开启新加坡美食 5 折之旅</li><li><a href="http://www.xiaopodao.com/" target="_blank" rel="noopener">小坡岛集运</a>: 从中国寄送包裹到新加坡空运最低仅需 19RMB/kg, 海运小包 10RMB/kg</li></ul><p>推荐信息聚合平台:</p><ul><li><a href="https://toutiaosg.com/" target="_blank" rel="noopener">新加坡头条</a>: 聚合了主流的新加坡本地中文站点，用来搜索历史记录比较合适</li><li><a href="https://blog.seedly.sg/" target="_blank" rel="noopener">Seedly</a>: 熟悉新加坡本地的银行金融，保险，买房投资规则</li></ul><h2 id="新加坡至其他国家旅游"><a href="#新加坡至其他国家旅游" class="headerlink" title="新加坡至其他国家旅游"></a>新加坡至其他国家旅游</h2><blockquote><p>旅游可以具体向专业旅行社咨询，以政策变化为准</p></blockquote><p><a href="http://cs.mfa.gov.cn/wgrlh/lhqz/cjwdn_660600/t1175681.shtml" target="_blank" rel="noopener">境外中国公民赴香港特区怎么办理？</a></p><ol><li>持中华人民共和国护照，在海外过境香港特区前往中国内地或其他国家（或地区），凭有效护照和联程机票，可免办进入许可并在港停留 7 天。持中华人民共和国护照，自内地经香港特区前往其他国家（或地区），出示联程机票和前往国家或地区的签证，或合法居留证件 (如 “绿卡”) 后，可免办进入许可并在香港特区停留 7 天。 </li><li>如预计在香港特区停留超过 7 天，应事先申请进入许可。中国驻外使领馆可根据申请人情况签发 3 个月一次或两次有效，每次停留不超过 30 天的进入许可。持有外国永久居留证件，并在海外居住不少于 1 年者，可申请两年多次有效进入许可。</li></ol><p><a href="https://mp.weixin.qq.com/s?__biz=MzAxMjA4NzQzNA==&amp;mid=503621899&amp;idx=1&amp;sn=62d66af2463312f4d66adf0a272e71f8&amp;chksm=004730ee3730b9f8b6a0ece62952493af344cce03f3a9fb8504a3e3a9a15777f6e351d285d26&amp;mpshare=1&amp;scene=23&amp;srcid=08022k223Jxs2MD7XXeHCXxT&amp;sharer_sharetime=1564734537933&amp;sharer_shareid=456ba82bbd1a1c9f32e5725824095308%23rd" target="_blank" rel="noopener">新加坡到各国签证办理条例</a></p><h2 id="新加坡父母签证"><a href="#新加坡父母签证" class="headerlink" title="新加坡父母签证"></a>新加坡父母签证</h2><blockquote><p>网上找到的，忘记出处了，如果有错误描述请及时指正</p></blockquote><p>本人 PR，老婆七月份预产期。打算让父母 6 月中旬来。计划步骤如下:<br>1, 先买往返机票（返程可更改的）。<br>=== 对的。<br>2,5 月份申请父母旅游签证。<br>=== 旅游签证可提前一个月内申请，有效期多数 63 天，也有一年，两年，非固定。有效期内入境即可。<br>3, 父母来新后申请延期至 89 天。<br>=== 对的。<br>4, 同时申请 LTVP。<br>=== 也没错。<br>5, 悲剧后申诉。<br>=== 步骤没错。<br>请指点一下按这样做有什么不拖吗？<br>=== 有什么不妥是吧？没什么不妥的，如果觉得自己条件还可以，就可以早点安排申请 LTVP，如果觉得条件比较牵强，可以晚一点入境，晚一点延期，晚一点申请 ltvp，争取在月子后多待一点时间帮你们带孩子。<br>可以现在就申请旅行签证吗?<br>=== 提前一个月内申请，一个月内，内。<br>旅行签证有效期多久? 一年多次吗？<br>=== 上面已经回答了。<br>申请 LTVP 必须人在新加坡吗？<br>=== 是的。必须入境后申请。</p><p><a href="https://www.ica.gov.sg/" target="_blank" rel="noopener">https://www.ica.gov.sg/</a></p><h2 id="新加坡公民-永久居民-外国人的区别"><a href="#新加坡公民-永久居民-外国人的区别" class="headerlink" title="新加坡公民 / 永久居民 / 外国人的区别"></a>新加坡公民 / 永久居民 / 外国人的区别</h2><blockquote><p>我们大多数人的起点是外国人，这点与国内的户口制度类似，无论是中国还是新加坡始终绕不开买房和教育这两座大山</p></blockquote><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190802162244.png" alt=""></p><p><a href="https://docs.qq.com/sheet/B80RhZ2ZATLC0ge3Bi2bLYpr2iY5PC1nE3031LWRcK1rTcgj0Z2bvD00bDO63Ie3tz2ovOwW4" target="_blank" rel="noopener">如果发现表有错误请点击链接申请编辑更新，谢谢</a></p><h3 id="EP-申请-PR"><a href="#EP-申请-PR" class="headerlink" title="EP 申请 PR"></a>EP 申请 PR</h3><blockquote><p>在新加坡工作满半年即可申请 PR，不过大概率是被拒的，失败后等待半年继续申请挑战吧</p></blockquote><p>基本准备材料：</p><ol><li>护照 （资料页）</li><li>准证 / 身份证 （如有）</li><li>出生证明 （公证件）</li><li>更名证明（如有）</li><li>最高学历（成绩单，资格证，会员资质等也可提供）</li><li>护照尺寸照片</li></ol><blockquote><p>其他所需材料：</p></blockquote><p>A1：以前雇主的推荐信，说明就业的性质，持续时间以及基本工资（有最好了，没有也可以）<br>A2：过去 6 个月的薪资单（这个找 HR 开）<br>A3：现任雇主的信函，说明就业日期，过去 6 个月的每月工资，包括加班和津贴（找 HR 开）。这封信 To 谁呢，记得是 To Controller of Immigration，而且要在申请前一个月内开具<br>A4：IRAS 同意书，表示同意 ICA 获取和核实与此相关的财务信息</p><blockquote><p>已婚汪们还需要这些：</p></blockquote><p>B1：结婚证书（需要公证的记得公证）<br>B2：关于之前婚姻的死亡证明或离婚证明（如有）<br>B3：关于以前婚姻的子女的监护文件（如有）<br>B4：配偶的最高教育证书（包括大专学历），成绩单，职业资格证，能证明牛 X 的统统甩出来哈！</p><blockquote><p>如果配偶一同申请：</p></blockquote><p>B5：配偶的有效旅行证件及有效的入境通行证，护照（资料页）<br>B6：配偶的出生证明<br>B7：更名文件（如有）<br>B8：配偶的身份证（如适用）<br>B9：关于配偶以前的婚姻（如有）离婚证明以及孩子的监护文件，或者死亡证明</p><blockquote><p>如果孩子一起申请：</p></blockquote><p>C1：护照资料页<br>C2：孩子的出生证明，显示孩子和父母的姓名<br>C3：儿童收养文件（如适用）<br>C4：儿童改名证明（如适用）</p><h3 id="PR-申请公民"><a href="#PR-申请公民" class="headerlink" title="PR 申请公民"></a>PR 申请公民</h3><blockquote><p>等 PR 满两年后再申请</p></blockquote><p><a href="https://toutiaosg.com/%E5%90%90%E8%A1%80%E6%95%B4%E7%90%86%EF%BC%81%E5%A6%82%E4%BD%95%E5%9C%A8%E7%BD%91%E4%B8%8A%E7%94%B3%E8%AF%B7%E6%96%B0%E5%8A%A0%E5%9D%A1pr%E5%92%8C%E5%85%AC%E6%B0%91%E6%9C%80%E5%BC%BA%E6%94%BB%E7%95%A5/" target="_blank" rel="noopener">吐血整理！如何在网上申请新加坡 PR 和公民最强攻略！收藏~</a></p><h2 id="我的新加坡之旅时间轴"><a href="#我的新加坡之旅时间轴" class="headerlink" title="我的新加坡之旅时间轴"></a>我的新加坡之旅时间轴</h2><blockquote><p>时间轴不再描述细节，如果需要了解详细信息可以阅读后面的内容</p></blockquote><p>201804</p><ul><li>LinkedIn 收到 100offer 猎头来自 Sea 的工作邀请机会</li><li>经历 3 轮远程 Skype 视频面试，时间约为 3 周</li><li>提出辞职由 Sea HR 帮忙开始申请 EP，时间约为 3 周</li></ul><p>201805</p><ul><li>完成离职流程，时间约为 1 个月</li><li>收到 EP 的 IPA，由 Sea HR 帮忙开始申请 DP，时间约为 1 周(申请 DP 请提前准备好结婚证公正)</li><li>完成新加坡机票，住宿，货币，各种材料纸质化和电子扫描化的准备(可选为申请 PR 准备国内学历学位公证和出生证公证)</li></ul><blockquote><p>再强调一下出国前的建议</p></blockquote><ol><li>随身携带好护照和相关入境材料，非常重要，非常重要，非常重要</li><li>证件，学历和结婚证公正翻译等材料可以通过扫描全能王 (CamScanner) 录入为电子版，水印是可以很方便去除的，这里就不多说了。如果觉得好用请购买正版服务支持下总部位于上海的合合信息，名片全能王 (CamCard) 也是他们家的产品</li><li>提前规划好到达新加坡后的住宿(新加坡 Airbnb 违法)，交通出行，手机应用，SIM 卡，入职流程</li><li>准备好足够的新币现金建议 4k+，因为银行卡和租房都是大头，有条件至少准备一张以上的 Visa/Mastercard 信用卡</li><li>出国前检查下国内的银行，手机，社保，人事档案是否安排妥当，身份证和护照离过期更换时间是否可控</li><li>如果有条件出国前做下全面的体检至少对自己身体有一个清晰的认识，把牙齿之类的小毛小病尽可能提前扫除隐患</li><li>现在的网络通信都很发达，记得和家人保持联系，减少他们的担心，自己照顾好自己</li></ol><p>201806</p><ul><li>20180609 星期六晚上 20 点第一次来到新加坡</li><li>完成住宿，EZ-Link 交通卡和 Singtel Prepaid 手机卡，时间约为 1 天</li><li>入职一周左右由 HR 协助申请 EP，需要本人预约 MOM 现场办理 EP，收到 EP 实体卡时间约为 1 周内</li><li>收到 EP 实体卡使用 SGWorkPass 扫描获取有效期并保存照片，注册 SingPass，约 1 周左右收到密码信封然后激活</li><li>办理 Zero1.sg 的无合约限制，无限流量的 Postpaid 手机卡，背后运营商为 Singtel 质量靠谱</li><li>携带相关证明办理银行卡，我选择 UOB 但是推荐各位选择 DBS，如需转账回国可以再额外开通工商银行</li></ul><p>201903</p><ul><li>全年在新加坡工作满 183 天以上需要报税，新加坡税率较低平均缴税额度大概年收入 5%-8%，对外国人来说可以理解为税前≈税后或者到手收入</li><li>工作满半年可以开始申请 PR，但一般建议等满 2 年，可以提前准备各种材料，国内学历学位和出生证公证在新加坡本地认证机构都可以代办</li><li>在半年时间中根据自身状况可选办理信用卡，健身卡，意外 + 住院保险，保障自己的身体健康很重要</li><li>基本熟悉新加坡的生活节奏，明白新加坡的优缺点，规划自己下一个阶段目标</li></ul><p><img src="https://cdn-blog.seedly.sg/wp-content/uploads/2018/06/30020702/Personal-finance-guide-01.png" alt=""></p><p>READ ME FIRST: Your Personal Finance Journey Starts With This Article<br><a href="https://blog.seedly.sg/read-me-first-your-personal-finance-journey-starts-with-this-article/" target="_blank" rel="noopener">https://blog.seedly.sg/read-me-first-your-personal-finance-journey-starts-with-this-article/</a></p><h2 id="新加坡-1-个月感想"><a href="#新加坡-1-个月感想" class="headerlink" title="新加坡 1 个月感想"></a>新加坡 1 个月感想</h2><blockquote><p>选择新加坡的理由：给自己多一种选择</p></blockquote><ul><li>MOM: Ministry of Manpower 新加坡人力部</li><li>IPA: In-Principle Approval 批准信</li><li>EP: Employment Pass 人才准证</li><li>DP: Dependant’s Pass 家属准证</li><li>PR: Singapore Permanent Resident 新加坡永久居民</li><li>SC: Singapore Citizen 新加坡公民</li><li>HDB: Housing &amp; Development 政府组屋</li><li>Condo: 私人公寓</li><li>Food Court: 食阁</li><li>CPF: 公积金</li><li>NUS: National University of Singapore 新加坡国立大学</li><li>NTU: Nanyang Technological University 新加坡南洋理工大学</li></ul><ol><li>原始坐标：上海，无留学经验也没有去过新加坡</li><li>猎头推荐新加坡的职位，想想自己那被遗忘的蹩脚英语抱着试一试的心态</li><li>一共 3 轮 Skype 远程视频面试，约 4 周时间到最后确认 offer</li><li>约 1 天时间思考，离职申请，签电子合同</li><li>检查护照有效期，下载学信网英文翻译认证，由 HR 帮助提交申请 EP，约 3 周内收到 IPA</li><li>在上海户口所在区公证处办理结婚证公证翻译，约 3 周时间完成，又慢又麻烦</li><li>完成 EP 后由 HR 帮助提交申请 DP，约 1 周内收到 IPA</li><li>购买机票，打印 IPA，带上护照，打包行李，兑换 4000 新币，确认人事档案存放地址，选择不缴纳每月养老保险和医疗保险约 1500 元人民币(可由父母代缴，中断非连续缴纳暂时不影响回国养老，以政策变化为准)</li><li>飞机上填写好新加坡入境卡，完成入境登记，无需录入指纹，开启华为天际通</li><li>抵达公司提前安排好的住址，熟悉新加坡环境</li><li>办理 EZ-Link 交通卡和 Singtel Prepaid 手机卡(如果没有强需求可以暂时不办理)</li><li>公司 HR 提交 EP 现场办理申请，收到邮件后预约 MOM 办理时间（我没有被要求体检，根据不同公司情况而定）</li><li>约 1 周后收到 EP 绿色实体卡，使用 SGWorkPass 扫描保存照片，注册 SingPass 后约 1 周左右收到密码信封</li><li>公司开具证明办理银行卡，新加坡本地我选择 UOB(保持 1000 新币存款)，另外强烈推荐再办理工商银行卡(持卡 0 门槛，转账回国 0 费用)</li><li>网上申请 Zero1 的无限流量手机卡，约 3 个工作日收到直接使用，弃用 Singtel Prepaid（浪费了 25 新币）</li><li>新加坡日常消费以现金为主，我本人习惯手机支付无奈降级至刷信用卡阶段(持有浦发 AE 白 / Visa/Master)，怀念下国内的支付宝和微信</li></ol><p>我刚来新加坡 1 个多月，不用担心语言不通，大部分人都会说华语。新加坡真的不算大，地铁和公交都很方便，空气质量很好至少我的鼻炎消失了，天气没有国内那么热，居然没有蚊子，没有蚊子，没有蚊子。在这段时间里我幸运了结识了交大和复旦的校友，跟随专业的中介实地考察了新加坡的租房和买房市场，走遍了几个重要的核心区域，顺便吃了几顿亲民的米其林一星。之后我应该还会继续更新自己在新加坡的经历，比如健身、快递、看病等日常生活，希望对大家有所帮助。</p><h3 id="新加坡-3-个月感想"><a href="#新加坡-3-个月感想" class="headerlink" title="新加坡 3 个月感想"></a>新加坡 3 个月感想</h3><blockquote><p>咋们就从最传统的衣食住行说起吧</p></blockquote><p><strong> 衣 </strong></p><p>因为新加坡全年都是夏季，平时的正常温度基本在 30° 上下，对于我来说已经把家里的夏装的家底全部带过来了，所以也没有什么特别需要单独购买，作为男生如果以后缺衣服的话在新加坡线下就是优衣库，线上还是优衣库。</p><p>女生的选择实在太多了，乌节路和 VivoCity 等都可以逛好久，这里就跳过吧</p><p>新加坡本地的 Outlet(奥特莱斯)是 IMM，如果你喜欢跑步运动，那么只卖 80 新币的 adidas Ultraoost X 和 Asics GEL-Kayano 会有一定吸引力</p><p>在新加坡网购，和国内激烈竞争的胜出者相比，还有很长一段路要走，当然也证明东南亚市场是一块巨大的蛋糕等待挖掘</p><p>新加坡室内空调冷气普遍开得比较足，建议怕冷的同学多备件长袖外套在公司，长时间逛商场时注意冷热交替避免生病</p><p>从中国快递至新加坡我通常会选择和同事拼团 小坡岛新加坡集运</p><p><a href="http://www.xiaopodao.com" target="_blank" rel="noopener">http://www.xiaopodao.com</a></p><p><strong> 食 </strong></p><p>新加坡最有特点的饮食文化莫过于食阁(Food Court)，其实有点类似于上海的大食代，但价格亲民而且还有米其林一星的神奇存在，平均一顿的价格区间在 3-7 新币，整体口味偏重。每个食阁上方都会标注 A/B/C 卫生评级，新加坡本地的习惯一般不在家做饭，大家都出去吃所以种类也还算多，不知道吃什么可以认准 Singapore Best Foods 红色标志，和国内相比关键是放心。</p><p>如果平时想吃顿大餐类似国内海底捞、小龙坎那种，平均每人大概 30-50 新币左右，评级更高的餐厅价格自然也水涨船高</p><p>自己在家做饭的成本其实和外面吃也差不了多少，如果居住的房子允许大炒和大煮当然可以选择自己动手丰衣足食</p><p>新加坡的菜市场比较少见可能是我没有刻意去寻找或者需求的缘故吧，买蔬菜和肉类基本都在 Sheng Siong(昇菘)，FairPrice(NTUC)，Cold Storage，喜欢日本食物还可以选择 DON DON DONKI，我个人很喜欢这只萌企鹅的魔性主题曲</p><p><a href="https://www.bilibili.com/video/av32078102" target="_blank" rel="noopener">https://www.bilibili.com/video/av32078102</a></p><p>新加坡的便利店清一色 7-Eleven，部分大一点的屈臣氏 (Watsons) 支持支付宝(Alipay)，上面提到的 Sheng Siong 已经全部支持 Alipay</p><p>外卖大家就不要指望 GrabFood 或 Foodpanda 有饿了么和美团外卖的速度了，老老实实去附近的食阁按时吃饭才是正道</p><p>新增推荐 eatigo，我每个周末都会使用 eatigo 开启 5 折美食之旅</p><p><a href="https://eatigo.com/sg/singapore/en" target="_blank" rel="noopener">https://eatigo.com/sg/singapore/en</a></p><p><strong> 住 </strong></p><p>(1) 租房</p><p>我在租房这个环节基本上算是跳过了，刚来时建议找好房源，这边的酒店居住成本很高的。因为目前是长租在公司提供的组屋 (HDB) 内，毕竟室友都是公司自己人很放心，合同限制不多每月会安排阿姨定期打扫和保养空调等，手机银行转账支付租金也方便。回想当时刚来的 1 个月每周都跟随专业的中介校友出去找房子都十分辛苦，更不要说自己联系中介一家一家看了，说多了都是泪。这边的房产中介需要考证，据说通过率只有 10-15%，每个中介都会展示唯一的证书编号，所以不用太担心被骗，不过每个中介的态度千差万别，找到靠谱的中介能够加快找房的速度。</p><p>由于地理位置和房屋面积质量差异，下面的租房价格仅仅是一个参考区间，数字单位为新币 / 月<br>组屋(HBD)，普通房 600-800，主人房 1000-1200，整租 1000+<br>公寓(Condo)，普通房 800-1500，主人房 1200-2000，整租 1500+</p><p>房源信息可以来自于同事，也可以自己在线挑选，方法我都写在前面了，和同事咨询过新加坡租房的大致流程</p><ol><li>看准自己喜欢的房子</li><li>看清楚合同，看清楚合同，看清楚合同，签约</li><li>签 1 年一般押一付一，签 2 年押二付一</li><li>中介费是根据实际情况由房东或者租客来承担，一般根据合约长短支付 0.5 或 1 个月的房租作为中介费</li></ol><p>(2) 买房</p><p>虽然是否决定买房的话题为时尚早，但经历了魔都十几年房地产的上涨自然也不会错过对新加坡房地产的研究，如果你是冲着 30w 新币的组屋 (HDB) 那么找新加坡本地人结婚是最快的途径。新加坡在 2018 年 07 月 06 日 0 点开始调整了印花税，对于我们普通人来说 2-3 年内拿到永久居民 (PR) 已然不易。新加坡私人公寓 (Condo) 的价格和质量相对国内来说是有优势的，但是 1 室 80w，2 室 100w，3 室 120w 这样的价格加上印花税还是会让我们感到一丢丢肉疼，好在房地产市场涨幅长期平稳且退出机制清晰，租房市场也足够活跃，而且银行可以贷款 7 成 + 2% 左右的低利率还是足以让我们拥有奋力一搏的勇气，不用牺牲 6 个钱包。</p><p><strong> 行 </strong></p><p>现在无论在哪里手机的使用比重都是极高的，我自己来新加坡前把小米 6 替换为华为 P20 Pro，妻子还是用的小米 MIX2，在国内早已习惯电信乐享家 199 元全国无限流量，我们的老卡 1 个是移动，1 个是联通，来到新加坡之后选择了无合约限制价格为 29.99 新币无限流量的虚拟运营商 Zero1.sg，因为背后是 Singtel 所以质量有保障。在新加坡接收国内短信验证码之类不要钱，双卡双待都是没有问题的，不过我妻子还是很期待 iPhone 即将推出的双卡功能，毕竟她在美国时的 iPhone5s 也用了 4 年多，被我硬生生拖入 Android 阵营实属不易。 </p><p>新加坡公共交通发达，Google Map 在手说走就走。我的选择和国内类似，能坐地铁尽量就不会选择公交车，因为坐公交车有几点不爽，如果你不熟悉新加坡或者不会熟练使用 Google Map 建议不要轻易乘坐公交车。</p><blockquote><p>乘坐地铁切记不可吃喝、吸烟、携带榴莲、大声喧哗和带宠物，乘坐公交车的规定与地铁类似但有以下额外注意事项</p></blockquote><ol><li>公交车来之前一定要招手才会停</li><li>在到达下一站前一定要按 Stop 红色停车按钮，不然不会停</li><li>下车时还要再刷一次交通卡确认付款</li></ol><p>除了公交车和国内差异较大以外，平时过马路记得按一下身边的指示灯，你不按或者对面也没人按，那你就不用想着过去了</p><p>这边的公交卡称为 EZ-Link，想刷 NFC 不好意思没有小米和华为，请购买 NFC SIM card。虽然充值很方便支持国内双币信用卡，但我还是很想念上海二维码扫码进闸机。另外新加坡地铁站没有安检，没有安检，没有安检。</p><p>我丢过一次地铁卡，为了挽回里面 25 新币我第一次主动走进新加坡警察局开具丢失证明，他们做事确实负责而高效，不过我因为操作失误导致旧卡数据没有正常转移到新卡，超过 7 天申报时间我也没有办法无力回天，所以再一次怀念下国内的手机刷卡。</p><p>新加坡已经遍布 Mobike 和 ofo，摩拜的国内账户可以在这里直接使用，ofo 需要重新注册。</p><p>新加坡打车市场已经被 Grab 一统江湖，Uber 和滴滴出行都入股 Grab，另外 Grab 打车很安全而且支持支付宝(Alipay)，普通出租车都支持微信和支付宝</p><p>关于机票从上海往返新加坡的航班很多，价格和飞行时间比较透明就不多说了，我这里还是推荐大家体验下新加坡航空 (Singapore Airlines) 的服务，今年航空公司评选又站回全球第一，即使乘坐经济舱也不要忘记品尝一下新加坡司令哈。</p><p>今年国庆节期间我和老婆买了新加坡至四川成都的 5 日往返机票，新加坡航空旗下的胜安航空(SilkAir)，令我感到惊喜的是 2 人机票往返价格总共才 1600 人民币。</p><p>新加坡拥车成本比较高，虽然公共交通发达，但是开车的梦想还是要有的，万一实现了呢？</p><p>新加坡和国内的走位不一样，行走避让和司机开车位置与国内正好相反。</p><blockquote><p>传统的四大金刚扯完了，我们再聊一些逆转未来的话题</p></blockquote><p><strong> 安全 </strong></p><p>新加坡的安全本质上是基于严格的法律加上遍布各地的摄像头，你如果想挑战下不如先了解下鞭刑的酸爽和罚款罚到你肉疼的数字。</p><p>吸烟，喝酒，乱扔垃圾在法律中都有明确要求，虽然不能百分百杜绝抽烟现象，但你走在马路上不会遇到随意吐痰也不需要提防狗屎。穿过十字路口车辆都会早早的自觉停下来等你先过去，新加坡随处可见的就是无障碍设施，地铁沿线基本都设置了棚顶，既可以防晒又可以躲雨，即便每天都能遇到短时暴雨由于出色的排水系统也从来不会看到有积水。</p><p>在国内随时会收到的垃圾短信和房产金融中介等骚扰电话，在新加坡基本是看不到的，不过 Email 和 WhatsApp 这种网络骚扰还是无法消灭的。这边的违法成本比较高只要被投诉就会收到法律的严格制裁，当然注意保护自己的隐私安全始终不能掉以轻心，毕竟再文明的社会偶尔也会遇上小人。</p><p>在新加坡你基本不用担心丢失物品，因为大概率都能找回来，包包也不用刻意放在前面，拉链忘记拉上也没关系，不用担心人口贩子和小孩走丢，更不用担心一个人走夜路会不会不安全，犯罪成本高促成的低犯罪率给你带来的不仅仅是安全感更是幸福感。</p><p>由于新加坡的地理位置极好，无论是过去还是未来基本是不会受到任何灾难气候影响，台风、海啸或者地震是不存在的</p><p>新加坡的人际关系相对简单，与人为善的过程中也不要忘记多留个心眼谨慎一些，在这边和他人发生误会大多数都会听到 Sorry 和 I am fine 而不是争吵，规规矩矩排队而很少有人随意插队，政府办事效率高以廉洁著称也是难能可贵，在新加坡未必有国内这么亲切有人情味，但你能感受到的是相对的公平和简单。</p><p><strong> 健康 </strong></p><p>我在上海的时候就饱受着变态反应性鼻炎的痛苦，每次体检医生都开玩笑要不住到外环去吧，没想到现在离家这么远。至少来新加坡后我的鼻子就彻底舒畅了，我原来对空气质量也不以为然，买个小米净化器放在家里，直到离开上海前看见基因检测报告提醒风险最高的是鼻咽癌，我才明白空气对于每个人的未来都是如此重要。</p><p>新加坡的温度常年保持在 30° 上下，不会像上海夏季烈日炎炎，但新加坡比较像“蓝天白云 晴空万里 突然暴风雨”，有云有风有遮雨棚，身体其实会觉得很舒服.</p><p>之前已经说过新加坡的饮食文化以食阁 (Food Court) 为主，这些小店很多都有几十年的历史，食物未必都符合你的胃口但至少足够安全，不用担心地沟油。合理的饮食搭配以及规律的生活节奏才是根本。</p><p>新加坡本地人都注重健身，如果不想花太多钱在健身房可以考虑在小区附近的体育馆免费跑步或者花费 1.3 新币游泳。私人公寓 (Condo) 一般自带小型游泳池和健身房，虽然小但有总比没有好。如果公司有补贴健身房的价格 (一般 150-200 新币每月) 其实也不算太贵，每月 99 新币可以选择像 Fitness First or Pure Fitness(Pure Yoga)等专业健身房。</p><p>关于看病，因为前段时间工作比较忙抵抗力突然下降导致出现额头皮肤红肿，在国内经历过不注意小病而酿成大病的惨痛教训，<a href="https://wsgzao.github.io/post/wisdom-tooth/">我是如何做到花 8000 元拔智齿的</a>，所以这次特地请 1 天病假去公司合作的 Raffles Medical 私人诊所看病，事后看诊断结果比较准确且看病过程十分高科技 + 高效率，病因是 <code>带状疱疹</code>，总共 99 新币，30 是问诊费其余都是买药钱。只不过第二天我发现未有起色且眼皮红肿都快睁不开了就先让昨天的医生开具的急症介绍信，然后直奔 Raffles Hospital，在了解基本无大碍和每位专科医生复查至少 300 新币起步的情况下果断申请放弃继续治疗赶紧溜回去休养生息，这一趟花了 199 新币，其中 130 为问诊费(节假日看病费用翻翻)。命固然重要，但人只要一生病真的可能失去一切甚至连累家人。</p><p>和同事回顾了他们看病的流程，作为外国人一般也是建议直接去附近的私人医院，价格其实差不多但不用排队。如果选择去政府医院比如 NUH 等可能存在排队现象，这个体验对于国内看病来说大家心里应该很明白有多痛苦，如果各位有足额的医疗保险在国内其实可以选择特需医疗(免排队 + 专家门诊)。关于新加坡医院的更多信息可以参考最上面的介绍。</p><p>印尼 “烧芭” 引发空气污染和马来西亚动不动就拿断水挑事也是新加坡需要持续努力解决的问题之一。</p><p>新加坡的蔬菜和水果算不上贵但也不会像国内一样便宜，除了猫山王榴莲和部分进口水果质量和价格有优势，也没有太多的种类可供选择，我自己会从网易考拉购买 Swisse 作为补充，话说新加坡的营养品真心贵，同样的 Swisse 一小瓶卖 56 新币，其它品牌价格也是高居不下。</p><p><strong> 娱乐消费 </strong></p><p>新加坡本身就很小，加上我和我妻子都倾向于工作，学习和健身。平时的娱乐活动也就停留在节假日出去寻找下亲民美食，慢慢游览新加坡仅有的几个景点，新加坡环球影城，S.E.A. 海洋馆，新加坡动物园，新加坡夜间动物园，滨海湾花园，金沙酒店附近的鱼尾狮和摩天轮，圣淘沙和赌场，其它像植物园，大学校园很多都是免费的，旅游一般 2 天可以快速结束，如果需要细细品味也就再多增加 1-2 天足够了。</p><p>新加坡娱乐设施真的不算很多，看电影还得去现场买票，网上购买需要多花钱。吃喝玩乐想看看附近的活动和评价都没有像美团点评类似的产品，毕竟需求不像国内这么大，但我觉得让国内的美团猫眼或者阿里淘票票来进攻新加坡市场，相信分分钟钟可以拿下。</p><p>新加坡本地目前小额仍然以现金为主，商场一般支持刷卡，而主要的景点和购物中心区域全部覆盖支付宝(Alipay)</p><p><strong> 教育培训 </strong></p><p>虽然现在谈教育太早但是新加坡本地的教育资源始终都是偏向本国公民的，对我们来说永久居民 (PR) 只是万里长征的第一步，要不要买学区房，要不要做义工，也是留给自己的问题。感觉这又有上海户口，学区房，拼父母，何其相似？</p><p>新加坡和中国一样都很注重基础教育，对子女的教育支出都很高，新加坡第三方教育机构或者成人专业类培训机构的市场也很大。最近在微信朋友圈看到英国 BBC 邀请 3 名威尔士的优等生体验韩国鸡血教育的文章，除了深刻感受到教育的重要性，更加理解韩国快速崛起的因素，成熟而完整的教育产业链对孩子很重要，对国家来说更重要。</p><p><strong> 工作生活 </strong></p><p>我目前在一家新加坡互联网公司上班，工作制度是弹性的，没有严格的打卡要求，正常时间为 09:30-19:00，周围以中国同事居多，大部分是在这边读书毕业工作，学校几乎清一色新加坡国立大学 (NUS) 和新加坡南洋理工大学(NTU)，工作语言为英文，核心生产力工具包括 Google Suite，顶配 MacBook Pro，Herman Miller，Dell 2417H，还有无限制的饮料，水果和零食。原以为只能在国内的创业公司和少数尊重技术的优质公司才能看到的办公环境，可能在国外是很常见的事情吧。新加坡互联网公司在 IT 方面的人才非常短缺，也许是因为本地人大都投身于金融行业，所以很多技术人才也是会考虑从中国引进，甚至直接在国内开设分公司。</p><p>因为我以 EP 身份把我老婆也带了过来，目前还是 DP。对她来说在新加坡找一份金融行业的工作真的非常不容易，花了 2 个多月时间扫光了 LinkedIn 在新加坡几乎所有公开招聘，遗憾的是很少有金融行业愿意招聘非新加坡公民 (SZ) 和永久居民 (PR) 以外的人群，得到的回复大多数都是 Sorry，毕竟新加坡政府在很多地方都会优先照顾本国人的利益，这个道理放在中国也很好理解。不过目前经历了 6 轮面试最终拿到了一个还不错的 offer，后续 DP 也要转成 EP，这是一件值得庆幸的事情。</p><p>在没有明显压缩新加坡生活成本，按 1 人每月估算为 1w 人民币，如果是 2 个人差不多是 1.5w 人民币</p><p>新加坡月薪中位数是 4500 新币左右，新加坡人力部公布了 2018 年全国的工资中位数 4437 新币 / 月</p><p>HDB 合租主人房: 1100<br>水电网: 50<br>移动套餐: 9.9<br>饭费: 20x30<br>交通: 2x30<br>健身: 99<br>理发: 12<br>其他: 100</p><p>≈2030.9 新币≈10000 人民币，如果你是单人还可以选择普通房大概 800 每月。不过我相信新加坡贵的部分体现在后期的看病和生娃教育上<br><a href="https://mp.weixin.qq.com/s?__biz=MzIwMTQxODUxNw==&amp;mid=2650896087&amp;idx=1&amp;sn=9eb1be6f3e8ff3a5acc908e2c983cb37&amp;chksm=8d1be4adba6c6dbbb26bb7a8f6e99cff210306f1f1f856297851bc10ed378f532081f08a298b&amp;mpshare=1&amp;scene=23&amp;srcid=0627SV9XjUJihYiNxW383bUB&amp;sharer_sharetime=1564742363597&amp;sharer_shareid=456ba82bbd1a1c9f32e5725824095308%23rd" target="_blank" rel="noopener">扒一扒新加坡的精英制度！月薪 14 万的人到底经历了什么？</a><br>中国 VS 新加坡，生娃养娃究竟要花多少钱？</p><p>中国：</p><ul><li>生娃：3000-1 万人民币</li><li>养娃：65 万元 - 130 万人民币</li><li>总计：约 65 万 - 131 万人民币</li></ul><p>新加坡：</p><ul><li>生娃：1003-18912 新币</li><li>养娃：至少 67 万新币</li><li>总计：约 69 万新币</li></ul><p>推荐下 Grammarly for Chrome，在写邮件和文档时可以快速发现并纠正语法错误，对提升英文书写能力非常有帮助。我自己也是第一次开始深度使用 MacBook，记录一些简单的入门过程在 Blog 中，也可以做下参考。</p><p><a href="https://wsgzao.github.io/post/macbook/">MacBook macOS 从小白到入门</a></p><p><strong> 养老政策 </strong></p><p>新加坡不养闲人，你在新加坡的食阁 (Food Court) 仔细观察过就会发现几乎所有打扫卫生的都是老年人，和中国相比新加坡的养老金 CPF 是交多少退多少，不会被平均，所以更多的本地人会提前了解基金股票保险和投资房地产等方式来为自己养老。新加坡、日本、韩国等国家的老龄化问题已经凸显，我们都可以看到未来国内严重的老龄化趋势，谁又能独善其身呢？</p><p>新加坡政府因为楼市过热而提高印花税的闪电行动，中国也吹响了全球征税的集结号，无论身在哪里我们始终躲不开政治不是吗？</p><h2 id="日用品推荐"><a href="#日用品推荐" class="headerlink" title="日用品推荐"></a>日用品推荐</h2><blockquote><p>回顾来新加坡前后的经历，我希望自己分享的一部分实用建议和商品可以帮助大家更好的适应新加坡生活。如果你不喜欢网易严选和网易考拉可以选择性跳过。</p></blockquote><p>我自己携带并且大家都能买到的产品分享：</p><ol><li>药品：我带的是泰诺和夫西地酸乳膏，这边初期看病成本还是比较高，建议最好带一些板蓝根、急用的抗生素、抗过敏药及自己习惯的常用药，如胃药、哮喘喷剂等等。</li><li>其他综合的日用品，我是分 3 批带过来的，这里按照重要性分成 2 部分来推荐，大部分来自网易严选和网易考拉工厂店，关于原因我也记录了自己的观点。</li></ol><p><a href="https://wsgzao.github.io/post/buy/">我的线上线下购物变迁史</a></p><h3 id="必备推荐"><a href="#必备推荐" class="headerlink" title="必备推荐"></a>必备推荐</h3><blockquote><p>我就只推荐适用于男同胞的产品了，虽然我妻子也是在严选和工厂店买，如果各位有需求我日后可以再补充，她的东西实在是多</p></blockquote><p>[手机 / 耳机 / 智能穿戴无推荐]<br>Follow Your Heart</p><p><a href="http://163.lu/I8OGX1" target="_blank" rel="noopener">28 寸 纯 PC“铝框”（非全铝）拉杆箱</a><br>新秀丽制造商，但是怎么看怎么觉得更像是日默瓦(RIMOWA)，虽然有小米 90 分旅行箱但 20 寸太小，为了追求更大容量就买了这款，使用感受非常可靠，五星推荐</p><p>[双肩包无推荐]<br>我自己背的是一加(OnePlus)1 代和 2 代，她带的是 Longchamp 和 Doughnut，都是多年的老包了</p><p><a href="http://wx.uniir.com/" target="_blank" rel="noopener">独美</a><br>眼镜我和妻子每人配了 2 副做主备, 我们买的都是来自京东众筹的独美，3.3g 镜架加镜片只要 398。小米有品太阳镜带了 1 副，不过来新加坡后我从来没佩戴过</p><p>[晴雨伞没有推荐]<br>新加坡经常短时暴雨，平日基本阳光明媚，建议携带一把晴雨伞，既能遮阳、又能挡雨。我自己带了 1 把天堂和 1 把小米晴雨两用，因为比较懒所以买的都是自动伞。只是可惜了 RealBrella 锐乐 不对称设计长柄伞留在家里吃灰，我好喜欢这款大红色啊。</p><p>[跑鞋无推荐]<br>自己带了 2 双旧鞋过来，严选上买过一双类似 Adidas UltraBoost 的鞋子还不错。我妻子带了 Asics GEL-Kayano 24，无论在网易考拉买还是在新加坡本地买 Asics 都很便宜，而且新加坡 NIKE EPIC REACT 新款居然只要 130 + 新币，这也是让我觉得很神奇</p><p><a href="http://163.lu/050tb0" target="_blank" rel="noopener">两带式男女款软木拖鞋 2.0</a><br><a href="http://163.lu/SpQlo1" target="_blank" rel="noopener">两带式男 / 女款拖鞋</a><br>Birkenstock 集团制造商，我特地在国内和新加坡的专卖店对比过，自己穿了 1 代非常舒服然后又买了 2 代，因为在新加坡基本是拖鞋 + 短裤的夏装，如果你的工作要求正装注意带好皮鞋和衣服套装</p><p><a href="http://163.lu/v4KrM2" target="_blank" rel="noopener">软弹速干男 / 女沐浴拖鞋</a><br>Crocs 制造商，浴室必备。本来想分享严选的人字拖，但不知道为什么严选把它下架了，反正我基本是放在室内穿，大家买自己觉得舒服的就好</p><p><a href="http://163.lu/CKQh21" target="_blank" rel="noopener">考拉工厂店 5 双 男士精梳棉防臭休闲袜</a><br>我在新加坡穿袜子的次数就和穿运动鞋的次数保持一致，除了健身和户外活动，几乎都是大拖鞋走起，上次登顶新加坡最高峰武吉知马山也是拖鞋，不过大家还是必要学我穿拖鞋爬山，以免自己给自己挖坑</p><p><a href="http://163.lu/uE5Uz3" target="_blank" rel="noopener">网易严选 男式丝滑莫代尔平角内裤</a><br><a href="http://163.lu/7ZOLU2" target="_blank" rel="noopener">考拉工厂店 男士莫代尔零束缚感内裤</a><br>我买过 CK 也买过网易严选和小米有品的纯棉内裤，但真正可以打动我的材质还是莫代尔，网易严选和网易考拉工厂店的两款我都买了，质感各有特色。严选上还有一款空气内裤，勇于尝鲜的同学要不试试？</p><p><a href="http://163.lu/aXBps0" target="_blank" rel="noopener">考拉工厂店 男式无缝插肩短袖 T 恤</a><br>我买了 3 件来自于严选和考拉工厂店的运动速干衣，但是从品质和舒适度上还是感觉不如自己再 Nike 实体店中购买的 Dri-FIT，考拉工厂店这款已经无限逼近了。小米有品也有很多运动衣，都是可以考虑的。我个人推荐备上 3 套运动衣，因为新加坡常年夏季，出汗是难免的，速干面料可以保持身体的舒适</p><p><a href="http://163.lu/Qxhpq2" target="_blank" rel="noopener">考拉工厂店 男式运动短裤</a><br>这款运动短裤我五星推荐，不仅做工精湛，口袋拉链等细节也非常到位，我自己直接买了 2 条，如果不是因为只有 2 种颜色，我还会继续买。另外还带了一条 Nike Dri-FIT 短裤，不过因为没有拉链所以来新加坡后基本没穿过，在上海的时候也仅仅是健身时穿的，现在因为设计问题算是彻底废了。</p><p><a href="http://163.lu/FPubq0" target="_blank" rel="noopener">考拉工厂店 男式针织轻薄运动裤</a><br>这款运动长裤我五星推荐，空气面料在夏天也依旧舒爽，内口袋拉链细节设计极赞，我索性买了 2 条一模一样的黑色款。新加坡平时上班我基本是穿这款长裤，原因和上面说过的新加坡室内空调温度较低有关，注意保暖。</p><p>[睡衣没有推荐]<br>我就直接把以前优衣库的全棉联名 T 恤全部带过来当睡衣穿了，有时候出门也可以穿哈</p><p>[外套没有推荐]<br>我自己带了 Under Armour 防风防雨衣，小米有品夜跑皮肤衣，小米有品防雨皮肤衣，除了 Under Armour 放在公司偶尔冷的时候会披一下，其它皮肤衣还没穿过。</p><p>[衬衫没有推荐]<br>我把原来公司定制的各种正装带过来了，可惜就入职时穿过一次，后来就是拖鞋加运动套装上班了</p><p><a href="http://163.lu/N7voR2" target="_blank" rel="noopener">成人款 高清时尚电镀泳镜</a><br><a href="http://163.lu/tDJJb2" target="_blank" rel="noopener">黑闪系列 硅胶防水泳帽 （男女通用）</a><br><a href="http://163.lu/Egc5c1" target="_blank" rel="noopener">男式基础泳裤</a><br>严选做了游泳装备也出乎我的意料，关键是和我之前买的 Speedo 相比那叫一个便宜啊，我本身是退休多年的游泳二级运动员，看似很简单的游泳装备严选的质量和价格都把控的不错，希望未来增加带度数的游泳镜。新加坡开放的普通游泳馆使用 EZ-link 刷卡，1.3 新币一次非常便宜，关键还多是训练使用的标准泳池人也少，定时清洁的规范让人放心。</p><p><a href="http://163.lu/rDAkF3" target="_blank" rel="noopener">全球通用转换插座</a><br>全球通用转换插座出国的人都应该明白是必备的，严选居然也做出来了，感觉又要干死一片坑爹厂商</p><p>[移动电源必须小米啊]<br>互联网上一直流传着这样的传说，小米什么产品都可以黑但是谁要是敢黑小米移动电源就被其他人反过来喷死。如果不是小米移动电源的出现干掉一众无良商家，现在市场上还不知道有多少人会受到低劣电池爆炸的影响，小米移动电源是真正用产品说话赢得用户口碑的最佳案例之一。我自己买的是紫米新款，我妻子买了一个超薄款就为了好看，哎</p><p><a href="http://163.lu/4ehYt4" target="_blank" rel="noopener">3 头浮动式电动剃须刀</a><br>科技类产品其实很想支持小米，可惜小米生态链不给力，就先用着严选高性价比的剃须刀好了</p><p><a href="http://163.lu/5cpvU0" target="_blank" rel="noopener">THREE SEVEN/777 进口指甲刀便携 4 件套 指甲剪小套装 三色可选</a><br>被淘宝坑过电动指甲刀和匠技指甲刀，也被严选坑过过于简约的指甲刀，没想到最后还是要选择韩国原装进口的 777 牌 4 件套，我以前不了解斜口指甲刀，后来才发现这货是剪脚指甲的神器啊，我以前剪脚指甲是有多痛苦哇</p><p><a href="http://163.lu/RNu3A1" target="_blank" rel="noopener">8 件装 折叠多功能衣架</a><br><a href="http://163.lu/dtCu31" target="_blank" rel="noopener">18 头多功能晾衣架</a><br>必备推荐，折叠携带很方便，18 头多功能晾衣架晾衣服的时候一个顶百，我都差点可以不用普通衣架了</p><p><a href="http://163.lu/pAmCc4" target="_blank" rel="noopener">旅行分装瓶套装</a><br>洗护用品我建议用分装瓶或者带最小包装的出国，因为这些日常用品本身价值不高但分量重，在当地超市购买就好了，除非你非常在意使用某些品牌</p><p><a href="http://163.wyh5.top/OsArG4" target="_blank" rel="noopener">考拉工厂店 智能清洁电动牙刷</a><br>我给父母买的也是同款，建议再带上 2 个以上刷头。如果你之前从来没有使用过电动牙刷，非常建议你尝试，清洁牙齿更加彻底和方便，爱上之后就无法回到过去手动刷牙啦</p><p><a href="http://163.lu/H03jR2" target="_blank" rel="noopener">电动式硅胶洁面仪</a><br>我还记得我给妻子送的第一个礼物就是 FOREO LUNA MINI2 Plus，这个也是我在网易考拉上买的第一个商品，当时这款网红洁面仪被招商银行垄断，没办法直接购买，逼着自己了解到网易考拉在国内海淘市场的领先地位，也算是缘分吧。现在严选自己也推出类似洁面仪才十分之一的价格，买个给自己吧</p><p><a href="http://163.lu/ZKkRz3" target="_blank" rel="noopener">韩国制造 硅胶洁面刷</a><br><a href="http://163.lu/RJS3r0" target="_blank" rel="noopener">韩国制造 硅胶沐浴按摩手套</a><br><a href="http://163.lu/Rv9KI2" target="_blank" rel="noopener">韩国制造 多功能硅胶清洁刷</a><br>严选从韩国引进来相当专业的硅胶产品制造商，其中这 3 件小东西在洗脸，沐浴，洗碗上极大的提升了我的幸福感，强烈推荐人手一件</p><p><a href="http://163.lu/womXA3" target="_blank" rel="noopener">皇室御用超柔毛巾</a><br>内野制造商，这是网易严选当年备受争议的产品之一，我不知道内野是什么，但我只知道这款毛巾确实舒服</p><p>[床单 / 床笠 / 被套 / 毯子]<br>我从家里带了 2 套旧的，然后又从考拉工厂店买了外国人比较喜欢的床笠，因为晚上睡觉都是关闭空调，没有被子就一层薄薄的毯子，一般租房子房东都会提供床板和床上用品，如果你不习惯或者运气不好，在新加坡本地宜家采购也很方便的</p><p><a href="http://163.lu/VY4v73" target="_blank" rel="noopener">考拉工厂店 100% 桑蚕丝双面美肤枕套</a><br>我和妻子一人一个，带过去非常方便，水洗之后也没有出现质量问题，面料实在丝滑</p><p><a href="http://163.lu/pBhg61" target="_blank" rel="noopener">AQR 创口贴</a><br>在新加坡常年夏装，像脚和皮肤很容易受伤，带上一盒以备不时之需</p><h3 id="可选推荐"><a href="#可选推荐" class="headerlink" title="可选推荐"></a>可选推荐</h3><blockquote><p>分享自己购买过的东西真的好累，没想到不知不觉买了这么多，但是能够对自己派上用场没有浪费也值了</p></blockquote><p><a href="http://163.lu/23D8k4" target="_blank" rel="noopener">泰国制造 天然乳胶枕 护颈优眠 升级抗菌</a><br>我买过记忆枕，空气枕，乳胶枕还有各种酒店的枕头体验。小米 8H 的乳胶枕和网易严选的相比我更推荐严选的升级款，这也属于严选的爆款商品了</p><p><a href="http://163.lu/6iWZ74" target="_blank" rel="noopener">日式多功能颈枕 舒滑款</a><br>第一次看到 MUJI 的微粒子 U 型枕就被深深吸引，现在小米和网易严选都有同样类型的，我自己购买的是光滑面料，毕竟新加坡非常热，原来在国内我还买过一个经典款</p><p><a href="http://163.lu/9iYPC2" target="_blank" rel="noopener">舒眠真丝眼罩</a><br>折叠床是带不过去了，很早之前买过零听眼罩，用过真丝眼罩后才明白丝的舒服，就和上面买真丝枕套的理由一样。如果你对声音也很敏感，除了戴耳机以外，再购置几副耳塞也是不错的选择</p><p>[鼻毛修剪器]<br>没有看到小米和严选有，看了张大妈的评测最后淘宝购入松下 ER-BN50，虽然不知道和国产的飞科相比有多大优势，至少用下来还行吧</p><p>[洗护 / 牙膏 / 洗面奶 / 防晒霜]<br>我推荐带上便携装，其实选择什么不重要，重要的是理解背后的成分，我唯一推荐的就是自己在上海和新加坡都长期使用的<a href="http://163.lu/lWFct2" target="_blank" rel="noopener"> 熊野油脂 无硅弱酸性马油洗发水</a></p><p><a href="http://163.lu/M8IW72" target="_blank" rel="noopener">Swisse 男士复合维生素 120 片 / 瓶</a><br>加上我在上海之前吃的半瓶，一共带了 2.5 瓶过去，现在回头看这个决定是非常明智的，因为新加坡本地蔬菜和水果不算便宜，关键是营养品价格奇高，一小瓶都要五六十新币。营养品不能代替药物，更不能代替你规律的饮食作息和身体锻炼，请记住这只是用来辅助身体营养平衡。我妻子还会购买 Swisse 的女士复合维生素片 + 葡萄籽和 Unichi 玫瑰果 + 葡萄籽</p><p><a href="http://163.lu/PsXds0" target="_blank" rel="noopener">考拉工厂店 便携式手持蒸汽挂烫机</a><br>我妻子要买的，方便小巧，出席正式场合会排上用场</p><p><a href="http://163.lu/WXcRz2" target="_blank" rel="noopener">考拉工厂店 强力除螨吸尘器</a><br>我没同意我妻子买养生壶和破壁料理机，原本这么大个头的除螨仪其实也是拒绝的，但是在阅读过网易浪潮工作室的一篇《中国人为什么爱晒被子》后我认为在美国或者韩国流行的洗衣烘干一体机可能不适合现在的我们，但是我不希望自己身边的人因为痘痘或者皮肤细菌感染而受到伤害，既然网易工厂店降低了除螨仪的购买门槛，为什么不尝试改变下自己的习惯呢？</p><p><a href="http://163.lu/oCJS84" target="_blank" rel="noopener">春风 TryFun 超润滑避孕套</a><br>好孩子就不要点击了，尤其是不要淘气切换到春风 TryFun 系列</p><h2 id="工作招聘"><a href="#工作招聘" class="headerlink" title="工作招聘"></a>工作招聘</h2><p><img src="http://wx1.sinaimg.cn/large/7207510dgy1fv3qi3vd5jj20by0bymyh.jpg" alt=""></p><p><a href="https://docs.qq.com/doc/BqI21X2yZIht1vALQM0Mf73G24se4c4wv0v31gLPCn3U4vsH0IQmKC2Cjyb927Q9Ok0PRkXB3WYpg82K1GXC4" target="_blank" rel="noopener">中金所技术公司最新招聘岗位</a></p><p><a href="https://docs.qq.com/doc/B80RhZ2ZATLC0DsTVf3kFjA01XR7Mg1x8BG42bVOrs1E5zYc01HWAZ0vDTku39xOdU3cS99t2" target="_blank" rel="noopener">Sea Job Openings</a></p><p>这是我第一次创建微信个人公众号，不会向大家推送文章，只是作为信息分享的渠道。我和上家公司以及现在公司的人力关系都还不错，在征得允许的前提下给大家分享上海和新加坡这两家公司目前的内部招聘动态，上海的职位真的的是进去的多出来的少，如果你希望相对稳定那这是很不错的机会。新加坡这边我会跟随公司内部招聘邮件每半个月左右更新，工作语言以英文为主，周围的中国同事还比较多，不用太担心在新加坡的语言关。这两家公司的介绍都可以在互联网上轻松获取，如果你相信自己的能力可以直接投递简历至文章内的联系方式。努力奋斗未必都能达到预想的结果，但至少你做出了自己的选择。</p><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><blockquote><p>如果你无法访问 github.io 的原文可以查看知乎专栏的文章，如果你想了解我前往新加坡的渠道可以看微信公众号的提炼内容</p></blockquote><p>从国内跳槽至新加坡工作的经验分享<br><a href="https://zhuanlan.zhihu.com/p/44280335" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/44280335</a></p><p>从国内跳槽至新加坡的最初半年，我都经历了什么？<br><a href="https://mp.weixin.qq.com/s/gDntToVrvFoQbyfrNf7XqA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/gDntToVrvFoQbyfrNf7XqA</a></p><p>从小到大我都没有离开过父母的保护，感谢你们的理解和支持，也同样感谢老婆的付出和双方家庭的包容。<br>引用领结婚证那天分享在朋友圈的一句话作为结语: I never grow up, but I never stop growing.</p>]]></content>
    
    <summary type="html">
    
      为帮助大家玩转新加坡、快速适应当地生活
    
    </summary>
    
      <category term="生活 | Life" scheme="https://wsgzao.github.io/categories/%E7%94%9F%E6%B4%BB-Life/"/>
    
    
  </entry>
  
  <entry>
    <title>敏捷开发 Agile 中 Scrum 与 Kanban 的实践心得</title>
    <link href="https://wsgzao.github.io/post/agile/"/>
    <id>https://wsgzao.github.io/post/agile/</id>
    <published>2019-06-07T06:59:49.000Z</published>
    <updated>2019-07-05T09:02:04.117Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>软件开发行业中常用的两种方法，一种是目前非常热门的敏捷开发 (Agile)，如 Scrum，Kanban 和 Lean 等，另一种是大家耳熟能详的传统瀑布模型 (Waterfall)。在 2017 年做自动化运维平台的项目中，我非常荣幸成为初始成员之一完整经历了项目的生命周期，感受到 Scrum 和 Kanban 的强大魅力。虽然项目已经过去很久了，但是敏捷开发 Agile 的思想在平时的工作中都能带给我非常多的帮助，我想把自己的心得和体会做下分享，本文主要通过分享几个简短有趣的视频让大家更快的熟悉 Agile，并强烈推荐各位可以在实际项目中实践和灵活应用。</p><blockquote><p>敏捷开发 Agile 中 Scrum 与 Kanban 的实践</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 06 月 07 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/agile/">https://wsgzao.github.io/post/agile/</a></p><p><strong> 扩展阅读 </strong></p><hr><h2 id="视频分享"><a href="#视频分享" class="headerlink" title="视频分享"></a>视频分享</h2><blockquote><p>以下视频建议优先观看，有助于理解 Agile 和 Scrum</p></blockquote><p>Agile Product Ownership in a Nutshell<br><a href="https://www.bilibili.com/video/av53884097" target="_blank" rel="noopener">https://www.bilibili.com/video/av53884097</a></p><p>7 分钟视频：什么是敏捷开发 Scrum<br><a href="https://www.bilibili.com/video/av21945150/" target="_blank" rel="noopener">https://www.bilibili.com/video/av21945150/</a></p><h2 id="Agile-基础知识扫盲"><a href="#Agile-基础知识扫盲" class="headerlink" title="Agile 基础知识扫盲"></a>Agile 基础知识扫盲</h2><blockquote><p>什么是敏捷开发？</p></blockquote><p>敏捷开发 (Agile Development) 是一种以人为核心、迭代、循序渐进的开发方法。</p><p>怎么理解呢？首先，我们要理解它不是一门技术，它是一种开发方法，也就是一种软件开发的流程，它会指导我们用规定的环节去一步一步完成项目的开发；而这种开发方式的主要驱动核心是人；它采用的是迭代式开发；</p><blockquote><p>为什么说是以人为核心？</p></blockquote><p>我们大部分人都学过瀑布开发模型，它是以文档为驱动的，为什么呢？因为在瀑布的整个开发过程中，要写大量的文档，把需求文档写出来后，开发人员都是根据文档进行开发的，一切以文档为依据；而敏捷开发它只写有必要的文档，或尽量少写文档，敏捷开发注重的是人与人之间，面对面的交流，所以它强调以人为核心。</p><blockquote><p>什么是迭代？</p></blockquote><p>迭代是指把一个复杂且开发周期很长的开发任务，分解为很多小周期可完成的任务，这样的一个周期就是一次迭代的过程；同时每一次迭代都可以生产或开发出一个可以交付的软件产品。</p><blockquote><p>什么是 Scrum？</p></blockquote><p>Scrum 的英文意思是橄榄球运动的一个专业术语，表示 “争球” 的动作；把一个开发流程的名字取名为 Scrum，我想你一定能想象出你的开发团队在开发一个项目时，大家像打橄榄球一样迅速、富有战斗激情、人人你争我抢地完成它，你一定会感到非常兴奋的。</p><p>而 Scrum 就是这样的一个开发流程，运用该流程，你就能看到你团队高效的工作。</p><h2 id="Scrum-框架"><a href="#Scrum-框架" class="headerlink" title="Scrum 框架"></a>Scrum 框架</h2><blockquote><p>Scrum 创造性地发明了很多概念，请大家结合实践来理解</p></blockquote><p>3 Roles：三种角色<br>产品经理 (Product Owner)，简称 PO，负责产品的需求、进度、目标。<br>项目经理 (Scrum Master)，简称 SM，俗称敏捷教练，负责阻挡外界对开发团队干扰，保证团队顺利工作。<br>团队成员 (Scrum Team) ，一般 5~10 人，包括开发、测试和运维等，不仅需要技术能力，还需要很强的沟通能力和自我管理能力。</p><p>4 Meetings：四种会议类型，项目开发周期，一般 2-4 周<br>冲刺规划会议（Sprint Plan Meeting），在启动每个 Sprint 前召开，PO 和团队成员将 backlog 分解小模块制定任务优先级，团队成员确认理解需求并计算小模块的工作量。<br>每日站立会议（Scrum Standup Meeting），开发团队成员召开，一般为 5-15 分钟站立式，每个开发成员汇报昨天做了什么，今天计划做什么，是否遇到障碍？<br>冲刺评审会议 (Sprint Review Meeting），在每个 Sprint 结束后，将这个 Sprint 的工作成果演示给 PO、客户、老板和其他相关的人员。<br>冲刺回顾会议（Sprint Retrospective Meeting），对刚结束的 Sprint 进行总结。会议的参与人员为团队开发的内部人员。一般该会议为 1 小时。</p><p>4 工作成果：<br>产品积压订单 (Product Backlog)，可以预知的所有任务，包括功能性的和非功能性的所有任务<br>冲刺积压订单: (Sprint Backlog)，在 1 个 Sprint 周期内所需要完成的任务<br>燃尽图: (Burndown Chart)，在 1 个 Sprint 周期内，工时 / 工作量的二维图表<br>障碍积压订单：(Impediments List)，Scrum 负责人要维护一个障碍列表</p><blockquote><p>参考文章</p></blockquote><p>浅谈 Scrum 敏捷开发：4 个输入 / 输出、3 个关键物、3 个会议<br><a href="http://www.woshipm.com/pd/797439.html" target="_blank" rel="noopener">http://www.woshipm.com/pd/797439.html</a></p><p>Scrum vs Waterfall vs Agile vs Lean vs Kanban<br><a href="https://www.archimetric.com/scrum-vs-%E7%80%91%E5%B8%83-vs-%E6%95%8F%E6%8D%B7-vs-%E7%B2%BE%E7%9B%8A-vs-%E7%9C%8B%E6%9D%BF/" target="_blank" rel="noopener">https://www.archimetric.com/scrum-vs-%E7%80%91%E5%B8%83-vs-%E6%95%8F%E6%8D%B7-vs-%E7%B2%BE%E7%9B%8A-vs-%E7%9C%8B%E6%9D%BF/</a></p><p>Scrum in 3 Minutes<br><a href="https://www.visual-paradigm.com/scrum/scrum-in-3-minutes/" target="_blank" rel="noopener">https://www.visual-paradigm.com/scrum/scrum-in-3-minutes/</a></p><h2 id="Kanban"><a href="#Kanban" class="headerlink" title="Kanban"></a>Kanban</h2><blockquote><p>最简单的模式莫过于 To Do | Doing | Done</p></blockquote><p>看板是日本的 “视觉信号” 或 “卡片”。丰田线路工人使用看板来表示制造过程中的步骤。作为精益的一部分，该系统的高度视觉性使得团队可以更轻松地沟通需要完成的工作和何时完成。它还标准化了线索和精炼过程，有助于减少浪费和最大化价值。与 scrum sprint board 类似，看板跟踪 “做 - 做 - 完成” 活动，但它限制了 “正在进行的” 活动的数量（该数量由团队经理定义，不能超过）。</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190705170200.png" alt=""></p><h2 id="项目管理工具推荐"><a href="#项目管理工具推荐" class="headerlink" title="项目管理工具推荐"></a>项目管理工具推荐</h2><p>Trello - <a href="https://trello.com/" target="_blank" rel="noopener">https://trello.com/</a></p><p>Jira - <a href="https://www.atlassian.com/software/jira" target="_blank" rel="noopener">https://www.atlassian.com/software/jira</a></p><p>Confluence - <a href="https://www.atlassian.com/software/confluence" target="_blank" rel="noopener">https://www.atlassian.com/software/confluence</a></p>]]></content>
    
    <summary type="html">
    
      敏捷开发Agile中Scrum与Kanban的实践心得
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>Cisco AnyConnect 客户端安装配置和默认地址修改技巧</title>
    <link href="https://wsgzao.github.io/post/cisco-anyconnect/"/>
    <id>https://wsgzao.github.io/post/cisco-anyconnect/</id>
    <published>2019-05-24T06:59:49.000Z</published>
    <updated>2019-07-17T08:49:09.490Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Cisco AnyConnect 为思科推出的 VPN 客户端，当前已有 Windows、Android、iOS、OS X、Ubuntu、WebOS 等操作系统的客户端。AnyConnect 主要作用是方便员工在任何设备上安全地办公。</p><blockquote><p>Cisco AnyConnect 客户端安装配置和默认地址修改技巧</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 05 月 24 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/cisco-anyconnect/">https://wsgzao.github.io/post/cisco-anyconnect/</a></p><p><strong> 扩展阅读 </strong></p><p>Cisco AnyConnect Secure Mobility Client</p><ul><li><a href="https://www.cisco.com/c/en/us/products/security/anyconnect-secure-mobility-client/index.html" target="_blank" rel="noopener">https://www.cisco.com/c/en/us/products/security/anyconnect-secure-mobility-client/index.html</a></li></ul><hr><h2 id="Cisco-AnyConnect-简介"><a href="#Cisco-AnyConnect-简介" class="headerlink" title="Cisco AnyConnect 简介"></a>Cisco AnyConnect 简介</h2><blockquote><p>无需介绍</p></blockquote><h2 id="Cisco-AnyConnect-配置"><a href="#Cisco-AnyConnect-配置" class="headerlink" title="Cisco AnyConnect 配置"></a>Cisco AnyConnect 配置</h2><ol><li>macOS 系统安装只安装 VPN 组件 , 其他功能都不需要安装</li><li>macOS 和 Windows 都建议取消勾选 <code>Block Connections to untrusted servers</code></li></ol><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190717164049.png" alt=""><br><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190717164900.png" alt=""></p><h2 id="Cisco-AnyConnect-修改默认链接地址"><a href="#Cisco-AnyConnect-修改默认链接地址" class="headerlink" title="Cisco AnyConnect 修改默认链接地址"></a>Cisco AnyConnect 修改默认链接地址</h2><p>Change Local Policy Parameters Manually</p><p><strong>Step 1</strong><br>Retrieve a copy of the AnyConnect Local Policy file (AnyConnectLocalPolicy.xml) from a client installation.</p><p>Table 1. Operating System and AnyConnect Local Policy File Installation Path<br>Operating System</p><table><thead><tr><th></th><th>Operating System</th><th>Installation Path</th></tr></thead><tbody><tr><td></td><td>Windows</td><td>C:\ProgramData\Cisco\Cisco AnyConnect Secure Mobility Client</td><td></td></tr><tr><td></td><td>Linux</td><td>/opt/cisco/anyconnect</td><td></td></tr><tr><td></td><td>macOS</td><td>/opt/cisco/anyconnect</td><td></td></tr></tbody></table><p><strong>Step 2</strong><br>Edit the parameter settings. You can either edit the AnyConnectLocalPolicy file manually, or use the VPN Local Policy editor, which is distributed with the AnyConnect Profile Editor installer.</p><p><strong>Step 3</strong><br>Save the file as AnyConnectLocalPolicy.xml and deploy the file to remote computers using a corporate software deployment system.</p><p><strong>Step 4</strong><br>Reboot the remote computers so that the changes to the local policy file take effect.</p><p><a href="https://www.cisco.com/c/en/us/td/docs/security/vpn_client/anyconnect/anyconnect40/administration/guide/b_AnyConnect_Administrator_Guide_4-0/anyconnect-profile-editor.html" target="_blank" rel="noopener">https://www.cisco.com/c/en/us/td/docs/security/vpn_client/anyconnect/anyconnect40/administration/guide/b_AnyConnect_Administrator_Guide_4-0/anyconnect-profile-editor.html</a></p><h3 id="macOS"><a href="#macOS" class="headerlink" title="macOS"></a>macOS</h3><p>注意修改 <code>中文备注</code></p><p>vim /opt/cisco/anyconnect/profile/Profile.xml</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;AnyConnectProfile xmlns=<span class="string">"http://schemas.xmlsoap.org/encoding/"</span>&gt; </span><br><span class="line">&lt;ServerList&gt; </span><br><span class="line">     &lt;HostEntry&gt;</span><br><span class="line">          &lt;User&gt; 用户名称 &lt;/User&gt;</span><br><span class="line">          &lt;HostName&gt; 自定义显示名称 &lt;/HostName&gt;</span><br><span class="line">          &lt;HostAddress&gt; 服务器地址 &lt;/HostAddress&gt;</span><br><span class="line">     &lt;/HostEntry&gt;</span><br><span class="line">     &lt;HostEntry&gt;</span><br><span class="line">          &lt;User&gt; 用户名称 &lt;/User&gt;</span><br><span class="line">          &lt;HostName&gt; 自定义显示名称 &lt;/HostName&gt;</span><br><span class="line">          &lt;HostAddress&gt; 服务器地址 &lt;/HostAddress&gt;</span><br><span class="line">     &lt;/HostEntry&gt;</span><br><span class="line">&lt;/ServerList&gt;</span><br><span class="line">&lt;/AnyConnectProfile&gt;</span><br></pre></td></tr></table></figure><h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p>注意修改 <code>中文备注</code></p><p>C:\Users \ 你的用户名 \ AppData\Local\Cisco\Cisco AnyConnect Secure Mobility Client 目录下的 <code>preferences.xml</code> 文件</p><p>比如</p><p>C:\Users\wangao\AppData\Local\Cisco\Cisco AnyConnect Secure Mobility Client</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">AnyConnectPreferences</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">DefaultUser</span>&gt;</span> 默认用户名 <span class="tag">&lt;/<span class="name">DefaultUser</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">DefaultSecondUser</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ClientCertificateThumbprint</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ServerCertificateThumbprint</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">DefaultHostName</span>&gt;</span> 默认 VPN 地址 <span class="tag">&lt;/<span class="name">DefaultHostName</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">DefaultHostAddress</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">DefaultGroup</span>&gt;</span> 默认组 <span class="tag">&lt;/<span class="name">DefaultGroup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ProxyHost</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ProxyPort</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SDITokenType</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ControllablePreferences</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">EnableAutomaticServerSelection</span>&gt;</span>false<span class="tag">&lt;/<span class="name">EnableAutomaticServerSelection</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LocalLanAccess</span>&gt;</span>false<span class="tag">&lt;/<span class="name">LocalLanAccess</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">BlockUntrustedServers</span>&gt;</span>false<span class="tag">&lt;/<span class="name">BlockUntrustedServers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ControllablePreferences</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">AnyConnectPreferences</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      Cisco AnyConnect 客户端安装配置和默认地址修改技巧
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>rsync 安装配置实践</title>
    <link href="https://wsgzao.github.io/post/rsync/"/>
    <id>https://wsgzao.github.io/post/rsync/</id>
    <published>2019-05-23T06:59:49.000Z</published>
    <updated>2019-05-24T07:04:59.373Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Rsync 代表 “remote sync”，它是本地和远程主机文件同步工具。它只同步更改的文件，以此实现最小化传输数据。rsync 的使用场景非常丰富，相信大家会经常使用，这里做下简单的总结。</p><blockquote><p>rsync 安装配置实践</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 05 月 23 日 - 更新 rsync 中文帮助和相关实践配置<br>2019 年 03 月 01 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/rsync/">https://wsgzao.github.io/post/rsync/</a></p><p><strong> 扩展阅读 </strong></p><p>rsync - <a href="https://www.samba.org/rsync/" target="_blank" rel="noopener">https://www.samba.org/rsync/</a></p><hr><h2 id="rsync-简介"><a href="#rsync-简介" class="headerlink" title="rsync 简介"></a>rsync 简介</h2><p>rsync is a file transfer program capable of efficient remote update via a fast differencing algorithm.</p><p>rsync 是类 unix 系统下的数据镜像备份工具，从软件的命名上就可以看出来了 ——remote sync。它的特性如下：</p><ol><li>可以镜像保存整个目录树和文件系统</li><li>可以很容易做到保持原来文件的权限、时间、软硬链接等等</li><li>无须特殊权限即可安装</li><li>优化的流程，文件传输效率高</li><li>可以使用 rsh、ssh 等方式来传输文件，当然也可以通过直接的 socket 连接</li><li>支持匿名传输</li></ol><p>在使用 rsync 进行远程同步时，可以使用两种方式：远程 Shell 方式（用户验证由 ssh 负责）和 C/S 方式（即客户连接远程 rsync 服务器，用户验证由 rsync 服务器负责）。</p><p>无论本地同步目录还是远程同步数据，首次运行时将会把全部文件拷贝一次，以后再运行时将只拷贝有变化的文件（对于新文件）或文件的变化部分（对于原有文件）。</p><h2 id="rsync-源配置文件示例"><a href="#rsync-源配置文件示例" class="headerlink" title="rsync 源配置文件示例"></a>rsync 源配置文件示例</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑 rsync 配置文件 </span></span><br><span class="line">vim /etc/rsync.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># /etc/rsyncd: configuration file for rsync daemon mode</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># See rsyncd.conf man page for more options.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># configuration example:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># uid = nobody</span></span><br><span class="line"><span class="comment"># gid = nobody</span></span><br><span class="line"><span class="comment"># use chroot = yes</span></span><br><span class="line"><span class="comment"># max connections = 4</span></span><br><span class="line"><span class="comment"># pid file = /var/run/rsyncd.pid</span></span><br><span class="line"><span class="comment"># exclude = lost+found/</span></span><br><span class="line"><span class="comment"># transfer logging = yes</span></span><br><span class="line"><span class="comment"># timeout = 900</span></span><br><span class="line"><span class="comment"># ignore nonreadable = yes</span></span><br><span class="line"><span class="comment"># dont compress   = *.gz *.tgz *.zip *.z *.Z *.rpm *.deb *.bz2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [ftp]</span></span><br><span class="line"><span class="comment">#        path = /home/ftp</span></span><br><span class="line"><span class="comment">#        comment = ftp export area</span></span><br></pre></td></tr></table></figure><p>rsyncd.conf 官方文档请参考 - <a href="https://www.samba.org/ftp/rsync/rsyncd.conf.html" target="_blank" rel="noopener">https://www.samba.org/ftp/rsync/rsyncd.conf.html</a></p><h2 id="rsync-常用参数"><a href="#rsync-常用参数" class="headerlink" title="rsync 常用参数"></a>rsync 常用参数</h2><p>注: 在指定复制源时，路径是否有最后的 “/” 有不同的含义，例如：</p><p>/data  表示将整个 /data 目录复制到目标目录<br>/data/ 表示将 /data/ 目录中的所有内容复制到目标目录</p><p>man rsync 翻译 (rsync 命令中文手册)<br><a href="http://www.cnblogs.com/f-ck-need-u/p/7221713.html" target="_blank" rel="noopener">http://www.cnblogs.com/f-ck-need-u/p/7221713.html</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">rsync is a file transfer program capable of efficient remote update via a fast differencing algorithm.</span><br><span class="line"></span><br><span class="line">Usage: rsync [OPTION]... SRC [SRC]... DEST</span><br><span class="line">  or   rsync [OPTION]... SRC [SRC]... [USER@]HOST:DEST</span><br><span class="line">  or   rsync [OPTION]... SRC [SRC]... [USER@]HOST::DEST</span><br><span class="line">  or   rsync [OPTION]... SRC [SRC]... rsync://[USER@]HOST[:PORT]/DEST</span><br><span class="line">  or   rsync [OPTION]... [USER@]HOST:SRC [DEST]</span><br><span class="line">  or   rsync [OPTION]... [USER@]HOST::SRC [DEST]</span><br><span class="line">  or   rsync [OPTION]... rsync://[USER@]HOST[:PORT]/SRC [DEST]</span><br><span class="line">The <span class="string">':'</span> usages connect via remote shell, <span class="keyword">while</span> <span class="string">'::'</span> &amp; <span class="string">'rsync://'</span> usages connect</span><br><span class="line">to an rsync daemon, and require SRC or DEST to start with a module name.</span><br><span class="line"></span><br><span class="line">Options</span><br><span class="line"> -v, --verbose               increase verbosity</span><br><span class="line">     --info=FLAGS            fine-grained informational verbosity</span><br><span class="line">     --debug=FLAGS           fine-grained debug verbosity</span><br><span class="line">     --msgs2stderr           special output handling <span class="keyword">for</span> debugging</span><br><span class="line"> -q, --quiet                 suppress non-error messages</span><br><span class="line">     --no-motd               suppress daemon-mode MOTD (see manpage caveat)</span><br><span class="line"> -c, --checksum              skip based on checksum, not mod-time &amp; size</span><br><span class="line"> -a, --archive               archive mode; equals -rlptgoD (no -H,-A,-X)</span><br><span class="line">     --no-OPTION             turn off an implied OPTION (e.g. --no-D)</span><br><span class="line"> -r, --recursive             recurse into directories</span><br><span class="line"> -R, --relative              use relative path names</span><br><span class="line">     --no-implied-dirs       don<span class="string">'t send implied dirs with --relative</span></span><br><span class="line"><span class="string"> -b, --backup                make backups (see --suffix &amp; --backup-dir)</span></span><br><span class="line"><span class="string">     --backup-dir=DIR        make backups into hierarchy based in DIR</span></span><br><span class="line"><span class="string">     --suffix=SUFFIX         set backup suffix (default ~ w/o --backup-dir)</span></span><br><span class="line"><span class="string"> -u, --update                skip files that are newer on the receiver</span></span><br><span class="line"><span class="string">     --inplace               update destination files in-place (SEE MAN PAGE)</span></span><br><span class="line"><span class="string">     --append                append data onto shorter files</span></span><br><span class="line"><span class="string">     --append-verify         like --append, but with old data in file checksum</span></span><br><span class="line"><span class="string"> -d, --dirs                  transfer directories without recursing</span></span><br><span class="line"><span class="string"> -l, --links                 copy symlinks as symlinks</span></span><br><span class="line"><span class="string"> -L, --copy-links            transform symlink into referent file/dir</span></span><br><span class="line"><span class="string">     --copy-unsafe-links     only"unsafe"symlinks are transformed</span></span><br><span class="line"><span class="string">     --safe-links            ignore symlinks that point outside the source tree</span></span><br><span class="line"><span class="string">     --munge-links           munge symlinks to make them safer (but unusable)</span></span><br><span class="line"><span class="string"> -k, --copy-dirlinks         transform symlink to a dir into referent dir</span></span><br><span class="line"><span class="string"> -K, --keep-dirlinks         treat symlinked dir on receiver as dir</span></span><br><span class="line"><span class="string"> -H, --hard-links            preserve hard links</span></span><br><span class="line"><span class="string"> -p, --perms                 preserve permissions</span></span><br><span class="line"><span class="string"> -E, --executability         preserve the file'</span>s executability</span><br><span class="line">     --chmod=CHMOD           affect file and/or directory permissions</span><br><span class="line"> -A, --acls                  preserve ACLs (implies --perms)</span><br><span class="line"> -X, --xattrs                preserve extended attributes</span><br><span class="line"> -o, --owner                 preserve owner (super-user only)</span><br><span class="line"> -g, --group                 preserve group</span><br><span class="line">     --devices               preserve device files (super-user only)</span><br><span class="line">     --copy-devices          copy device contents as regular file</span><br><span class="line">     --specials              preserve special files</span><br><span class="line"> -D                          same as --devices --specials</span><br><span class="line"> -t, --<span class="built_in">times</span>                 preserve modification <span class="built_in">times</span></span><br><span class="line"> -O, --omit-dir-times        omit directories from --<span class="built_in">times</span></span><br><span class="line"> -J, --omit-link-times       omit symlinks from --<span class="built_in">times</span></span><br><span class="line">     --super                 receiver attempts super-user activities</span><br><span class="line">     --fake-super            store/recover privileged attrs using xattrs</span><br><span class="line"> -S, --sparse                handle sparse files efficiently</span><br><span class="line">     --preallocate           allocate dest files before writing them</span><br><span class="line"> -n, --dry-run               perform a trial run with no changes made</span><br><span class="line"> -W, --whole-file            copy files whole (without delta-xfer algorithm)</span><br><span class="line"> -x, --one-file-system       don<span class="string">'t cross filesystem boundaries</span></span><br><span class="line"><span class="string"> -B, --block-size=SIZE       force a fixed checksum block-size</span></span><br><span class="line"><span class="string"> -e, --rsh=COMMAND           specify the remote shell to use</span></span><br><span class="line"><span class="string">     --rsync-path=PROGRAM    specify the rsync to run on the remote machine</span></span><br><span class="line"><span class="string">     --existing              skip creating new files on receiver</span></span><br><span class="line"><span class="string">     --ignore-existing       skip updating files that already exist on receiver</span></span><br><span class="line"><span class="string">     --remove-source-files   sender removes synchronized files (non-dirs)</span></span><br><span class="line"><span class="string">     --del                   an alias for --delete-during</span></span><br><span class="line"><span class="string">     --delete                delete extraneous files from destination dirs</span></span><br><span class="line"><span class="string">     --delete-before         receiver deletes before transfer, not during</span></span><br><span class="line"><span class="string">     --delete-during         receiver deletes during the transfer</span></span><br><span class="line"><span class="string">     --delete-delay          find deletions during, delete after</span></span><br><span class="line"><span class="string">     --delete-after          receiver deletes after transfer, not during</span></span><br><span class="line"><span class="string">     --delete-excluded       also delete excluded files from destination dirs</span></span><br><span class="line"><span class="string">     --ignore-missing-args   ignore missing source args without error</span></span><br><span class="line"><span class="string">     --delete-missing-args   delete missing source args from destination</span></span><br><span class="line"><span class="string">     --ignore-errors         delete even if there are I/O errors</span></span><br><span class="line"><span class="string">     --force                 force deletion of directories even if not empty</span></span><br><span class="line"><span class="string">     --max-delete=NUM        don'</span>t delete more than NUM files</span><br><span class="line">     --max-size=SIZE         don<span class="string">'t transfer any file larger than SIZE</span></span><br><span class="line"><span class="string">     --min-size=SIZE         don'</span>t transfer any file smaller than SIZE</span><br><span class="line">     --partial               keep partially transferred files</span><br><span class="line">     --partial-dir=DIR       put a partially transferred file into DIR</span><br><span class="line">     --delay-updates         put all updated files into place at transfer<span class="string">'s end</span></span><br><span class="line"><span class="string"> -m, --prune-empty-dirs      prune empty directory chains from the file-list</span></span><br><span class="line"><span class="string">     --numeric-ids           don'</span>t map uid/gid values by user/group name</span><br><span class="line">     --usermap=STRING        custom username mapping</span><br><span class="line">     --groupmap=STRING       custom groupname mapping</span><br><span class="line">     --chown=USER:GROUP      simple username/groupname mapping</span><br><span class="line">     --timeout=SECONDS       <span class="built_in">set</span> I/O timeout <span class="keyword">in</span> seconds</span><br><span class="line">     --contimeout=SECONDS    <span class="built_in">set</span> daemon connection timeout <span class="keyword">in</span> seconds</span><br><span class="line"> -I, --ignore-times          don<span class="string">'t skip files that match in size and mod-time</span></span><br><span class="line"><span class="string"> -M, --remote-option=OPTION  send OPTION to the remote side only</span></span><br><span class="line"><span class="string">     --size-only             skip files that match in size</span></span><br><span class="line"><span class="string">     --modify-window=NUM     compare mod-times with reduced accuracy</span></span><br><span class="line"><span class="string"> -T, --temp-dir=DIR          create temporary files in directory DIR</span></span><br><span class="line"><span class="string"> -y, --fuzzy                 find similar file for basis if no dest file</span></span><br><span class="line"><span class="string">     --compare-dest=DIR      also compare destination files relative to DIR</span></span><br><span class="line"><span class="string">     --copy-dest=DIR         ... and include copies of unchanged files</span></span><br><span class="line"><span class="string">     --link-dest=DIR         hardlink to files in DIR when unchanged</span></span><br><span class="line"><span class="string"> -z, --compress              compress file data during the transfer</span></span><br><span class="line"><span class="string">     --compress-level=NUM    explicitly set compression level</span></span><br><span class="line"><span class="string">     --skip-compress=LIST    skip compressing files with a suffix in LIST</span></span><br><span class="line"><span class="string"> -C, --cvs-exclude           auto-ignore files the same way CVS does</span></span><br><span class="line"><span class="string"> -f, --filter=RULE           add a file-filtering RULE</span></span><br><span class="line"><span class="string"> -F                          same as --filter='</span>dir-merge /.rsync-filter<span class="string">'</span></span><br><span class="line"><span class="string">                             repeated: --filter='</span>- .rsync-filter<span class="string">'</span></span><br><span class="line"><span class="string">     --exclude=PATTERN       exclude files matching PATTERN</span></span><br><span class="line"><span class="string">     --exclude-from=FILE     read exclude patterns from FILE</span></span><br><span class="line"><span class="string">     --include=PATTERN       don'</span>t exclude files matching PATTERN</span><br><span class="line">     --include-from=FILE     <span class="built_in">read</span> include patterns from FILE</span><br><span class="line">     --files-from=FILE       <span class="built_in">read</span> list of <span class="built_in">source</span>-file names from FILE</span><br><span class="line"> -0, --from0                 all *-from/filter files are delimited by 0s</span><br><span class="line"> -s, --protect-args          no space-splitting; only wildcard special-chars</span><br><span class="line">     --address=ADDRESS       <span class="built_in">bind</span> address <span class="keyword">for</span> outgoing socket to daemon</span><br><span class="line">     --port=PORT             specify double-colon alternate port number</span><br><span class="line">     --sockopts=OPTIONS      specify custom TCP options</span><br><span class="line">     --blocking-io           use blocking I/O <span class="keyword">for</span> the remote shell</span><br><span class="line">     --stats                 give some file-transfer stats</span><br><span class="line"> -8, --8-bit-output          leave high-bit chars unescaped <span class="keyword">in</span> output</span><br><span class="line"> -h, --human-readable        output numbers <span class="keyword">in</span> a human-readable format</span><br><span class="line">     --progress              show progress during transfer</span><br><span class="line"> -P                          same as --partial --progress</span><br><span class="line"> -i, --itemize-changes       output a change-summary <span class="keyword">for</span> all updates</span><br><span class="line">     --out-format=FORMAT     output updates using the specified FORMAT</span><br><span class="line">     --<span class="built_in">log</span>-file=FILE         <span class="built_in">log</span> what we<span class="string">'re doing to the specified FILE</span></span><br><span class="line"><span class="string">     --log-file-format=FMT   log updates using the specified FMT</span></span><br><span class="line"><span class="string">     --password-file=FILE    read daemon-access password from FILE</span></span><br><span class="line"><span class="string">     --list-only             list the files instead of copying them</span></span><br><span class="line"><span class="string">     --bwlimit=RATE          limit socket I/O bandwidth</span></span><br><span class="line"><span class="string">     --outbuf=N|L|B          set output buffering to None, Line, or Block</span></span><br><span class="line"><span class="string">     --write-batch=FILE      write a batched update to FILE</span></span><br><span class="line"><span class="string">     --only-write-batch=FILE like --write-batch but w/o updating destination</span></span><br><span class="line"><span class="string">     --read-batch=FILE       read a batched update from FILE</span></span><br><span class="line"><span class="string">     --protocol=NUM          force an older protocol version to be used</span></span><br><span class="line"><span class="string">     --iconv=CONVERT_SPEC    request charset conversion of filenames</span></span><br><span class="line"><span class="string">     --checksum-seed=NUM     set block/file checksum seed (advanced)</span></span><br><span class="line"><span class="string"> -4, --ipv4                  prefer IPv4</span></span><br><span class="line"><span class="string"> -6, --ipv6                  prefer IPv6</span></span><br><span class="line"><span class="string">     --version               print version number</span></span><br><span class="line"><span class="string">(-h) --help                  show this help (-h is --help only if used alone)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Use"rsync --daemon --help"to see the daemon-mode command-line options.</span></span><br><span class="line"><span class="string">Please see the rsync(1) and rsyncd.conf(5) man pages for full documentation.</span></span><br><span class="line"><span class="string">See http://rsync.samba.org/ for updates, bug reports, and answers</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rsync 常用参数 </span></span><br><span class="line">-v : 展示详细的同步信息 </span><br><span class="line">-a : 归档模式，相当于 -rlptgoD</span><br><span class="line">    -r : 递归目录 </span><br><span class="line">    -l : 同步软连接文件 </span><br><span class="line">    -p : 保留权限 </span><br><span class="line">    -t : 将源文件的 < span class="string">"modify time"</span> 同步到目标机器 <br><span class="line">    -g : 保持文件属组 </span><br><span class="line">    -o : 保持文件属主 </span><br><span class="line">    -D : 和 --devices --specials 一样，保持设备文件和特殊文件 </span><br><span class="line">-z : 发送数据前，先压缩再传输 </span><br><span class="line">-H : 保持硬链接 </span><br><span class="line">-n : 进行试运行，不作任何更改 </span><br><span class="line">-P same as --partial --progress</span><br><span class="line">    --partial : 支持断点续传 </span><br><span class="line">    --progress : 展示传输的进度 </span><br><span class="line">--delete : 如果源文件消失，目标文件也会被删除 </span><br><span class="line">--delete-excluded : 指定要在目的端删除的文件 </span><br><span class="line">--delete-after : 默认情况下，rsync 是先清理目的端的文件再开始数据同步；如果使用此选项，则 rsync 会先进行数据同步，都完成后再删除那些需要清理的文件。</span><br><span class="line">--exclude=PATTERN : 排除匹配 PATTERN 的文件 </span><br><span class="line">--exclude-from=FILE : 如果要排除的文件很多，可以统一写在某一文件中 </span><br><span class="line">-e ssh : 使用 SSH 加密隧道传输 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 远程 Shell 方式 </span></span><br><span class="line">rsync [OPTION]... SRC [SRC]... [USER@]HOST:DEST <span class="comment"># 执行 “推” 操作 </span></span><br><span class="line">or   rsync [OPTION]... [USER@]HOST:SRC [DEST]   <span class="comment"># 执行 “拉” 操作 </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 远程 C/S 方式 </span></span><br><span class="line">rsync [OPTION]... SRC [SRC]... [USER@]HOST::DEST                    <span class="comment"># 执行 “推” 操作 </span></span><br><span class="line">or   rsync [OPTION]... SRC [SRC]... rsync://[USER@]HOST[:PORT]/DEST <span class="comment"># 执行 “推” 操作 </span></span><br><span class="line">or   rsync [OPTION]... [USER@]HOST::SRC [DEST]                      <span class="comment"># 执行 “拉” 操作 </span></span><br><span class="line">or   rsync [OPTION]... rsync://[USER@]HOST[:PORT]/SRC [DEST]        <span class="comment"># 执行 “拉” 操作 </span></span><br></pre></td></tr></table></figure><h2 id="rsync-同步方式"><a href="#rsync-同步方式" class="headerlink" title="rsync 同步方式"></a>rsync 同步方式</h2><p>Rsync 远程同步主要有两种方式：使用远程 shell（ssh 或 rsh） 或使用 rsync 的 daemon 方式</p><p>rsync 命令和 ssh，scp 命令有点相似。</p><p>我们创建两个测试目录和一些文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mkdir dir1</span><br><span class="line">mkdir dir2</span><br><span class="line">touch dir1/somefile&#123;1..100&#125;</span><br><span class="line"><span class="comment"># dir1 中有 100 文件，dir2 中为空。使用 rsync 把 dir1 内容同步到 dir2，-r 选项代表递归，在同步目录时使用。</span></span><br><span class="line">rsync -r dir1/ dir2</span><br><span class="line"><span class="comment"># 你也可以使用 -a 选项，代表同步所有，包括修改时间、群组、权限、特殊文件、也包括递归。</span></span><br><span class="line">rsync -anv dir1/ dir2</span><br><span class="line"><span class="comment"># 注意上面的 dir1 / 中的 “/” 不能少，它代表同步目录下文件， 如果没有 “/” 代表同步这个目录。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 和远程主机进行同步目录首先，你要确保有远程主机的 SSH 访问权限 </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 把本地目录同步到远程主机：</span></span><br><span class="line">rsync -a dir1/ root@linux:~/dir2</span><br><span class="line"><span class="comment"># 把远程主机目录同步到本地：</span></span><br><span class="line">rsync -a root@linux:~/dir2/ dir1</span><br></pre></td></tr></table></figure><h3 id="本地文件同步"><a href="#本地文件同步" class="headerlink" title="本地文件同步"></a>本地文件同步</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果没有 desc 目录，会自动创建 </span></span><br><span class="line">rsync -avH /opt/resource/ /tmp/desc/</span><br></pre></td></tr></table></figure><h3 id="远程文件同步-–shell-方式"><a href="#远程文件同步-–shell-方式" class="headerlink" title="远程文件同步 –shell 方式"></a>远程文件同步 –shell 方式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从本地传到远端，目标文件会被写成 ssh 登录用户的属组和属主（如下 www）</span></span><br><span class="line">rsync -avH /opt/nginx-1.12.1/ www@172.18.50.125:/tmp/nginx/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 ssh 加密隧道方式传输，保障数据的安全性 </span></span><br><span class="line">rsync -avHe ssh /opt/nginx-1.12.1/ www@172.18.50.125:/tmp/nginx/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从远端传到本地，只要对目标文件有读的权限，就可以同步到本地 </span></span><br><span class="line">rsync -avH www@172.18.50.125:/tmp/nginx/ /tmp/nginx/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果远程服务器 ssh 端口不是默认的 22</span></span><br><span class="line">rsync -avHe <span class="string">"ssh -p 11222"</span> /opt/nginx-1.12.1/ www@172.18.50.125:/tmp/nginx/</span><br></pre></td></tr></table></figure><h3 id="远程文件同步-–daemon-方式"><a href="#远程文件同步-–daemon-方式" class="headerlink" title="远程文件同步 –daemon 方式"></a>远程文件同步 –daemon 方式</h3><blockquote><p>rsync 服务端配置</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 rsync 服务的目录和配置文件 (可选)</span></span><br><span class="line">mkdir /etc/rsync </span><br><span class="line"><span class="built_in">cd</span> /etc/rsync</span><br><span class="line">touch rsyncd.conf</span><br><span class="line">touch rsyncd.secrets</span><br><span class="line">touch rsyncd.motd</span><br><span class="line">chmod 600 rsyncd.secrets</span><br><span class="line"></span><br><span class="line"><span class="comment">### rsyncd.conf 文件的配置 </span></span><br><span class="line">vim /etc/rsync/rsyncd.conf</span><br><span class="line"><span class="comment"># /etc/rsyncd: configuration file for rsync daemon mode</span></span><br><span class="line"><span class="comment"># See rsyncd.conf man page for more options.</span></span><br><span class="line"><span class="comment"># 传输文件使用的用户和用户组，如果是从服务器 =&gt; 客户端，要保证 www 用户对文件有读取的权限；如果是从客户端 =&gt; 服务端，要保证 www 对文件有写权限。</span></span><br><span class="line">uid = www</span><br><span class="line">gid = www</span><br><span class="line"><span class="comment"># 允许 chroot，提升安全性，客户端连接模块，首先 chroot 到模块 path 参数指定的目录下，chroot 为 yes 时必须使用 root 权限，且不能备份 path 路径外的链接文件 </span></span><br><span class="line">use chroot = yes</span><br><span class="line"><span class="comment"># 只读 </span></span><br><span class="line"><span class="built_in">read</span> only = no</span><br><span class="line"><span class="comment"># 只写 </span></span><br><span class="line">write only = no</span><br><span class="line"><span class="comment"># 设定白名单，可以指定 IP 段（172.18.50.1/255.255.255.0）, 各个 Ip 段用空格分开 </span></span><br><span class="line">hosts allow = 172.18.50.110 172.18.50.111</span><br><span class="line">hosts deny = *</span><br><span class="line"><span class="comment"># 允许的客户端最大连接数 </span></span><br><span class="line">max connections = 4</span><br><span class="line"><span class="comment"># 欢迎文件的路径，非必须 </span></span><br><span class="line">motd file = /etc/rsync/rsyncd.motd</span><br><span class="line"><span class="comment"># pid 文件路径 </span></span><br><span class="line">pid file = /var/run/rsyncd.pid</span><br><span class="line"><span class="comment"># 记录传输文件日志 </span></span><br><span class="line">transfer logging = yes</span><br><span class="line"><span class="comment"># 日志文件格式 </span></span><br><span class="line"><span class="built_in">log</span> format = %t %a %m %f %b</span><br><span class="line"><span class="comment"># 指定日志文件 </span></span><br><span class="line"><span class="built_in">log</span> file = /var/<span class="built_in">log</span>/rsync.log</span><br><span class="line"><span class="comment"># 剔除某些文件或目录，不同步 </span></span><br><span class="line">exclude = lost+found/</span><br><span class="line"><span class="comment"># 设置超时时间 </span></span><br><span class="line">timeout = 900</span><br><span class="line">ignore nonreadable = yes</span><br><span class="line"><span class="comment"># 设置不需要压缩的文件 </span></span><br><span class="line">dont compress   = *.gz *.tgz *.zip *.z *.Z *.rpm *.deb *.bz2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模块，可以配置多个，使用如: sate@172.18.50.125::125to110</span></span><br><span class="line">[125to110]</span><br><span class="line"><span class="comment"># 模块的根目录，同步目录，要注意权限 </span></span><br><span class="line">path = /tmp/nginx</span><br><span class="line"><span class="comment"># 是否允许列出模块内容 </span></span><br><span class="line">list = no</span><br><span class="line"><span class="comment"># 忽略错误 </span></span><br><span class="line">ignore errors</span><br><span class="line"><span class="comment"># 添加注释 </span></span><br><span class="line">comment = ftp <span class="built_in">export</span> area</span><br><span class="line"><span class="comment"># 模块验证的用户名称，可使用空格或者逗号隔开多个用户名 </span></span><br><span class="line">auth users = sate</span><br><span class="line"><span class="comment"># 模块验证密码文件 可放在全局配置里 </span></span><br><span class="line">secrets file = /etc/rsync/rsyncd.secrets</span><br><span class="line"><span class="comment"># 剔除某些文件或目录，不同步 </span></span><br><span class="line">exclude = lost+found/ conf/ man/</span><br><span class="line"></span><br><span class="line"><span class="comment">### rsyncd.secrets 文件的配置 </span></span><br><span class="line">cat rsyncd.secrets </span><br><span class="line"><span class="comment"># 用户名: 密码 </span></span><br><span class="line">sate:111111</span><br><span class="line"></span><br><span class="line"><span class="comment">### rsync 启动 </span></span><br><span class="line">rsync --daemon --config=/etc/rsync/rsyncd.conf</span><br></pre></td></tr></table></figure><blockquote><p>rsync 客户端配置</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从 服务端 =&gt; 客户端 同步数据，会提示输入密码 </span></span><br><span class="line">rsync -avzP --delete sate@172.18.50.125::125to110 /tmp/sync/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从 客户端 =&gt; 服务端 同步数据，会提示输入密码 </span></span><br><span class="line">rsync -avzP --delete /tmp/sync/ sate@172.18.50.125::125to110</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注: 如果是 /tmp/sync，则同步 sync 目录；如果 /tmp/sync/，则同步 sync 目录下的文件 </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 免密码同步，将密码写到文件，再通过 --password-file 指定该文件，注：该文件的权限必须是 600</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"111111"</span> &gt; /tmp/secrets.file</span><br><span class="line">chmod 600 /tmp/secrets.file</span><br><span class="line">rsync -avzP --delete --password-file=/tmp/secrets.file sate@172.18.50.125::125to110 /tmp/sync/</span><br><span class="line"></span><br><span class="line"><span class="comment"># --exclude 排除文件目录时，如果有多个同名目录的情况 </span></span><br><span class="line"><span class="comment"># 目录结构 </span></span><br><span class="line">tree</span><br><span class="line">.</span><br><span class="line">├── dir1</span><br><span class="line">│   └── <span class="built_in">test</span></span><br><span class="line">│       ├── 3.file</span><br><span class="line">│       ├── 4.file</span><br><span class="line">│       └── 5.file</span><br><span class="line">├── dir2</span><br><span class="line">└── <span class="built_in">test</span></span><br><span class="line">    ├── 1.file</span><br><span class="line">    ├── 2.file</span><br><span class="line">    └── 3.file</span><br><span class="line"></span><br><span class="line"><span class="comment"># 情况一 ： 排除 /test 目录，同步其他目录（同步的是 / tmp/sync/ 下边的文件）</span></span><br><span class="line">rsync -avP --delete --password-file=/tmp/secrets.file --exclude=<span class="built_in">test</span>  /tmp/sync/ sate@172.18.50.125::125to110 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 会发现，该目录下所有 test 目录都被排除了，如果想只排除第一层目录的 test，可以如下（/ 代表所同步目录第一层）：</span></span><br><span class="line">rsync -avP --delete --password-file=/tmp/secrets.file --exclude=/<span class="built_in">test</span>/  /tmp/sync/ sate@172.18.50.125::125to110 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 情况二 ： 和情况一不同的是 同步的 /tmp/sync 这个目录（同步的是 / tmp/sync 目录本身，导致 exclude 后边的参数也会变化）</span></span><br><span class="line">rsync -avP --delete --password-file=/tmp/secrets.file --exclude=/sync/<span class="built_in">test</span>/  /tmp/sync sate@172.18.50.125::125to110</span><br></pre></td></tr></table></figure><h2 id="rsync-简化配置实践"><a href="#rsync-简化配置实践" class="headerlink" title="rsync 简化配置实践"></a>rsync 简化配置实践</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置服务端 rsyncd.conf</span></span><br><span class="line">vim /etc/rsyncd.conf</span><br><span class="line"></span><br><span class="line"><span class="built_in">read</span> only = no</span><br><span class="line">list = yes</span><br><span class="line">uid = root</span><br><span class="line">gid = root</span><br><span class="line"></span><br><span class="line">[backup]</span><br><span class="line">path= /data/</span><br><span class="line">hosts allow = 10.71.12.0/23</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置服务 </span></span><br><span class="line">systemctl start rsyncd</span><br><span class="line">systemctl <span class="built_in">enable</span> rsyncd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 rsync 客户端 </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑 backup.sh 同步脚本 </span></span><br><span class="line">vim backup.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">SOURCE=<span class="variable">$1</span></span><br><span class="line">DEST=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line">CMD=<span class="string">"rsync -ravz --bwlimit=2000 <span class="variable">$1</span> rsync://&#123;&#123;log_server_ip&#125;&#125;:873/backup/<span class="variable">$2</span>"</span></span><br><span class="line"></span><br><span class="line">PROCS=$(pgrep -f <span class="string">"&#123;&#123;log_server_ip&#125;&#125;:873/backup/<span class="variable">$2</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"x"</span> != <span class="string">"x<span class="variable">$PROCS</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">       <span class="built_in">echo</span> <span class="string">"not finished"</span></span><br><span class="line">       <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$CMD</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 crontab</span></span><br><span class="line">vim /etc/crontab</span><br><span class="line">15 * * * * root <span class="built_in">cd</span> /opt/sa_scripts/ &amp;&amp; ./backup.sh /var/<span class="built_in">log</span>/ocha/pos_python_server/  10.71.12.89/$(date +\%Y-\%m)</span><br></pre></td></tr></table></figure><h2 id="rsync-有用的选项和注意事项"><a href="#rsync-有用的选项和注意事项" class="headerlink" title="rsync 有用的选项和注意事项"></a>rsync 有用的选项和注意事项</h2><p>-z 选项，压缩传输的文件，对于已经压缩过的文件不建议添加该参数，针对大文件压缩包传输效率会降低 8 倍，且消耗 CPU</p><pre><code>rsync -az source dest</code></pre><p>-P 选项非常有用，它是 -progress 和 -partial 的组合。第一个选项是用来显示传输进度条，第二个选项允许断点续传和增量传输：</p><pre><code>rsync -azP source dest</code></pre><p>–bwlimit 选项，限制传输带宽，参数值的默认单位是 KBPS，也就是每秒多少 KB</p><pre><code>rsync -avzP --bwlimit=100 source dest</code></pre><p>–remove-source-files 该选项告诉 rsync 移除 sender 端已经成功传输到 receiver 端的文件 (不包括任何目录文件)。</p><pre><code>rsync -avP --remove-source-files source dest</code></pre><p>rsync 过滤模块比较复杂，建议参考官网和 Google 实例测试<br>–exclude 选项如果只有前者可以单独使用，多个规则需要写多条<br>–include 选项通常需要配合 –exclude 同时使用<br>过滤规则比较多可以写在文件里读取，由于 rsync 不支持正则表达式，复杂的逻辑建议先使用 bash shell 过滤</p><p><a href="https://rsync.samba.org/documentation.html" target="_blank" rel="noopener">https://rsync.samba.org/documentation.html</a></p><p>rsync (一)：基本命令和用法 - <a href="https://www.cnblogs.com/f-ck-need-u/p/7220009.html" target="_blank" rel="noopener">https://www.cnblogs.com/f-ck-need-u/p/7220009.html</a></p>]]></content>
    
    <summary type="html">
    
      rsync安装配置实践
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>sysctl.conf 和 limits.conf 学习和调优</title>
    <link href="https://wsgzao.github.io/post/sysctl/"/>
    <id>https://wsgzao.github.io/post/sysctl/</id>
    <published>2019-05-13T07:42:19.000Z</published>
    <updated>2019-06-25T11:03:37.516Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>记得第一次接触 <code>/etc/security/limits.conf</code> 和 <code>/etc/sysctl.conf</code> 时是因为部署 Oracle 时要按需修改内核参数。limits.conf 文件实际是 Linux PAM（插入式认证模块，Pluggable Authentication Modules）中 pam_limits.so 的配置文件，突破系统的默认限制，对系统访问资源有一定保护作用。 limits.conf 和 sysctl.conf 区别在于 limits.conf 是针对用户，而 sysctl.conf 是针对整个系统参数配置。 </p><blockquote><p>sysctl.conf 和 limits.conf 学习和调优</p></blockquote><hr><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 05 月 13 日 - 更新 limits.conf 的最佳实践<br>2015 年 08 月 10 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/sysctl/">https://wsgzao.github.io/post/sysctl/</a></p><p>扩展阅读</p><p>设置 Sysctl.conf 用以提高 Linux 的性能(最完整的 sysctl.conf 优化方案) - <a href="http://blog.csdn.net/21aspnet/article/details/6584792" target="_blank" rel="noopener">http://blog.csdn.net/21aspnet/article/details/6584792</a><br>limits.conf 工作原理 - <a href="http://my.oschina.net/987openlab/blog/94634" target="_blank" rel="noopener">http://my.oschina.net/987openlab/blog/94634</a><br>ulimit 命令 - <a href="http://man.linuxde.net/ulimit" target="_blank" rel="noopener">http://man.linuxde.net/ulimit</a><br>Sysctl 学习 - <a href="http://pengyao.org/sysctl-1.html" target="_blank" rel="noopener">http://pengyao.org/sysctl-1.html</a><br>Kernel sysctl configuration file for Linux - <a href="https://klaver.it/linux/sysctl.conf" target="_blank" rel="noopener">https://klaver.it/linux/sysctl.conf</a><br>LTMP 索引 - <a href="https://wsgzao.github.io/index/#LTMP">https://wsgzao.github.io/index/#LTMP</a></p><hr><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><h3 id="limits-conf-工作原理"><a href="#limits-conf-工作原理" class="headerlink" title="limits.conf 工作原理"></a>limits.conf 工作原理</h3><p>limits.conf 是 <code>pam_limits.so</code> 的配置文件，然后 <code>/etc/pam.d/</code> 下的应用程序调用 <code>pam_***.so</code> 模块。譬如说，当用户访问服务器，服务程序将请求发送到 PAM 模块，PAM 模块根据服务名称在 <code>/etc/pam.d</code> 目录下选择一个对应的服务文件，然后根据服务文件的内容选择具体的 PAM 模块进行处理。</p><h3 id="limits-conf-文件格式"><a href="#limits-conf-文件格式" class="headerlink" title="limits.conf 文件格式"></a>limits.conf 文件格式</h3><pre><code>username|@groupname   type  resource  limit </code></pre><p>1）username|@groupname<br>设置需要被限制的用户名，组名前面加 @和用户名区别。也可用通配符 * 来做所有用户的限制 </p><p>2）type<br>类型有 soft，hard 和 -，其中 soft 指的是当前系统生效的设置值。hard 表明系统中所能设定的最大值。soft 的限制不能比 hard 限制高。用 - 就表明同时设置了 soft 和 hard 的值 </p><p>3）resource： 表示要限制的资源</p><ol><li>nofile - 打开文件的最大数目 </li><li>noproc - 进程的最大数目 </li></ol><h3 id="ulimit-命令"><a href="#ulimit-命令" class="headerlink" title="ulimit 命令"></a>ulimit 命令</h3><blockquote><p>ulimit 命令用来限制系统用户对 shell 资源的访问，常用参数解释如下</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span>(选项)</span><br><span class="line"></span><br><span class="line">-a：显示目前资源限制的设定；</span><br><span class="line">-c &lt;core 文件上限 & gt;：设定 core 文件的最大值，单位为区块；</span><br><span class="line">-d &lt; 数据节区大小 & gt;：程序数据节区的最大值，单位为 KB；</span><br><span class="line">-f &lt; 文件大小 & gt;：shell 所能建立的最大文件，单位为区块；</span><br><span class="line">-H：设定资源的硬性限制，也就是管理员所设下的限制；</span><br><span class="line">-m &lt; 内存大小 & gt;：指定可使用内存的上限，单位为 KB；</span><br><span class="line">-n &lt; 文件数目 & gt;：指定同一时间最多可开启的文件数；</span><br><span class="line">-p &lt; 缓冲区大小 & gt;：指定管道缓冲区的大小，单位 512 字节；</span><br><span class="line">-s &lt; 堆叠大小 & gt;：指定堆叠的上限，单位为 KB；</span><br><span class="line">-S：设定资源的弹性限制；</span><br><span class="line">-t &lt;CPU 时间 & gt;：指定 CPU 使用时间的上限，单位为秒；</span><br><span class="line">-u &lt; 程序数目 & gt;：用户最多可开启的程序数目；</span><br><span class="line">-v &lt; 虚拟内存大小 & gt;：指定可使用的虚拟内存上限，单位为 KB。</span><br></pre></td></tr></table></figure><h3 id="sysctl-conf-工作原理"><a href="#sysctl-conf-工作原理" class="headerlink" title="sysctl.conf 工作原理"></a>sysctl.conf 工作原理</h3><p>sysctl 命令被用于在内核运行时动态地修改内核的运行参数，可用的内核参数在目录 <code>/proc/sys</code> 中。它包含一些 TCP/IP 堆栈和虚拟内存系统的高级选项， 这可以让有经验的管理员提高引人注目的系统性能。用 sysctl 可以读取设置超过五百个系统变量。</p><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="limits-conf-设置"><a href="#limits-conf-设置" class="headerlink" title="limits.conf 设置"></a>limits.conf 设置</h3><p>1）暂时生效，适用于通过 <code>ulimit</code> 命令登录 shell 会话期间</p><pre><code>ulimit -SHn 65535</code></pre><p>2）永久生效，通过将一个相应的 ulimit 语句添加到由登录 shell 读取的文件之一（例如 ~/.profile），即特定于 shell 的用户资源文件；或者通过编辑 <code>/etc/security/limits.conf</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 比如添加到 / etc/profile</span></span><br><span class="line"><span class="built_in">echo</span> <span class="built_in">ulimit</span> -SHn 65535 &gt;&gt; /etc/profile</span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改最大进程和最大文件打开数限制</span></span><br><span class="line">vi /etc/security/limits.conf</span><br><span class="line">*       soft    nofile  655350</span><br><span class="line">*       hard    nofile  655350</span><br><span class="line">*       soft    nproc   unlimited</span><br><span class="line">*       hard    nproc   unlimited</span><br><span class="line">*       soft    core    unlimited</span><br><span class="line">*       hard    core    unlimited</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生产环境中的配置，同时兼容 RedHat/CentOS/Ubuntu</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 / etc/security/limits.conf</span></span><br><span class="line">cat /etc/security/limits.conf</span><br><span class="line">*       soft    nofile  655350</span><br><span class="line">*       hard    nofile  655350</span><br><span class="line">*       soft    nproc   unlimited</span><br><span class="line">*       hard    nproc   unlimited</span><br><span class="line">*       soft    core    unlimited</span><br><span class="line">*       hard    core    unlimited</span><br><span class="line">root    soft    nofile  655350</span><br><span class="line">root    hard    nofile  655350</span><br><span class="line">root    soft    nproc   unlimited</span><br><span class="line">root    hard    nproc   unlimited</span><br><span class="line">root    soft    core    unlimited</span><br><span class="line">root    hard    core    unlimited</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建软链接</span></span><br><span class="line">[root@localhost wangao]<span class="comment"># cd /etc/security/limits.d/</span></span><br><span class="line">[root@localhost limits.d]<span class="comment"># ll</span></span><br><span class="line">total 4</span><br><span class="line">-rw-r--r--. 1 root root 191 Apr 11  2018 20-nproc.conf</span><br><span class="line">lrwxrwxrwx  1 root root  25 May 10 19:57 99-garena-server.conf -&gt; /etc/security/limits.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 system.conf 中 DefaultLimitNOFILE=655350</span></span><br><span class="line">cat /etc/systemd/system.conf</span><br><span class="line"><span class="comment">#  This file is part of systemd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  systemd is free software; you can redistribute it and/or modify it</span></span><br><span class="line"><span class="comment">#  under the terms of the GNU Lesser General Public License as published by</span></span><br><span class="line"><span class="comment">#  the Free Software Foundation; either version 2.1 of the License, or</span></span><br><span class="line"><span class="comment">#  (at your option) any later version.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Entries in this file show the compile time defaults.</span></span><br><span class="line"><span class="comment"># You can change settings by editing this file.</span></span><br><span class="line"><span class="comment"># Defaults can be restored by simply deleting this file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># See systemd-system.conf(5) for details.</span></span><br><span class="line"></span><br><span class="line">[Manager]</span><br><span class="line"><span class="comment">#LogLevel=info</span></span><br><span class="line"><span class="comment">#LogTarget=journal-or-kmsg</span></span><br><span class="line"><span class="comment">#LogColor=yes</span></span><br><span class="line"><span class="comment">#LogLocation=no</span></span><br><span class="line"><span class="comment">#DumpCore=yes</span></span><br><span class="line"><span class="comment">#CrashShell=no</span></span><br><span class="line"><span class="comment">#ShowStatus=yes</span></span><br><span class="line"><span class="comment">#CrashChVT=1</span></span><br><span class="line"><span class="comment">#CtrlAltDelBurstAction=reboot-force</span></span><br><span class="line"><span class="comment">#CPUAffinity=1 2</span></span><br><span class="line"><span class="comment">#JoinControllers=cpu,cpuacct net_cls,net_prio</span></span><br><span class="line"><span class="comment">#RuntimeWatchdogSec=0</span></span><br><span class="line"><span class="comment">#ShutdownWatchdogSec=10min</span></span><br><span class="line"><span class="comment">#CapabilityBoundingSet=</span></span><br><span class="line"><span class="comment">#SystemCallArchitectures=</span></span><br><span class="line"><span class="comment">#TimerSlackNSec=</span></span><br><span class="line"><span class="comment">#DefaultTimerAccuracySec=1min</span></span><br><span class="line"><span class="comment">#DefaultStandardOutput=journal</span></span><br><span class="line"><span class="comment">#DefaultStandardError=inherit</span></span><br><span class="line"><span class="comment">#DefaultTimeoutStartSec=90s</span></span><br><span class="line"><span class="comment">#DefaultTimeoutStopSec=90s</span></span><br><span class="line"><span class="comment">#DefaultRestartSec=100ms</span></span><br><span class="line"><span class="comment">#DefaultStartLimitInterval=10s</span></span><br><span class="line"><span class="comment">#DefaultStartLimitBurst=5</span></span><br><span class="line"><span class="comment">#DefaultEnvironment=</span></span><br><span class="line"><span class="comment">#DefaultCPUAccounting=no</span></span><br><span class="line"><span class="comment">#DefaultBlockIOAccounting=no</span></span><br><span class="line"><span class="comment">#DefaultMemoryAccounting=no</span></span><br><span class="line"><span class="comment">#DefaultTasksAccounting=no</span></span><br><span class="line"><span class="comment">#DefaultTasksMax=</span></span><br><span class="line"><span class="comment">#DefaultLimitCPU=</span></span><br><span class="line"><span class="comment">#DefaultLimitFSIZE=</span></span><br><span class="line"><span class="comment">#DefaultLimitDATA=</span></span><br><span class="line"><span class="comment">#DefaultLimitSTACK=</span></span><br><span class="line"><span class="comment">#DefaultLimitCORE=</span></span><br><span class="line"><span class="comment">#DefaultLimitRSS=</span></span><br><span class="line"><span class="comment">#DefaultLimitNOFILE=</span></span><br><span class="line"><span class="comment">#DefaultLimitAS=</span></span><br><span class="line"><span class="comment">#DefaultLimitNPROC=</span></span><br><span class="line"><span class="comment">#DefaultLimitMEMLOCK=</span></span><br><span class="line"><span class="comment">#DefaultLimitLOCKS=</span></span><br><span class="line"><span class="comment">#DefaultLimitSIGPENDING=</span></span><br><span class="line"><span class="comment">#DefaultLimitMSGQUEUE=</span></span><br><span class="line"><span class="comment">#DefaultLimitNICE=</span></span><br><span class="line"><span class="comment">#DefaultLimitRTPRIO=</span></span><br><span class="line"><span class="comment">#DefaultLimitRTTIME=</span></span><br><span class="line">DefaultLimitNOFILE=655350</span><br></pre></td></tr></table></figure><h3 id="sysctl-conf-设置"><a href="#sysctl-conf-设置" class="headerlink" title="sysctl.conf 设置"></a>sysctl.conf 设置</h3><blockquote><p>这是一个在网络上流传已久的 sysctl.conf 优化配置</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 优化 TCP</span></span><br><span class="line">vi /etc/sysctl.conf</span><br><span class="line"><span class="comment"># 禁用包过滤功能 </span></span><br><span class="line">net.ipv4.ip_forward = 0  </span><br><span class="line"><span class="comment"># 启用源路由核查功能 </span></span><br><span class="line">net.ipv4.conf.default.rp_filter = 1  </span><br><span class="line"><span class="comment"># 禁用所有 IP 源路由 </span></span><br><span class="line">net.ipv4.conf.default.accept_source_route = 0  </span><br><span class="line"><span class="comment"># 使用 sysrq 组合键是了解系统目前运行情况，为安全起见设为 0 关闭 </span></span><br><span class="line">kernel.sysrq = 0  </span><br><span class="line"><span class="comment"># 控制 core 文件的文件名是否添加 pid 作为扩展</span></span><br><span class="line">kernel.core_uses_pid = 1  </span><br><span class="line"><span class="comment"># 开启 SYN Cookies，当出现 SYN 等待队列溢出时，启用 cookies 来处理</span></span><br><span class="line">net.ipv4.tcp_syncookies = 1  </span><br><span class="line"><span class="comment"># 每个消息队列的大小（单位：字节）限制</span></span><br><span class="line">kernel.msgmnb = 65536  </span><br><span class="line"><span class="comment"># 整个系统最大消息队列数量限制</span></span><br><span class="line">kernel.msgmax = 65536  </span><br><span class="line"><span class="comment"># 单个共享内存段的大小（单位：字节）限制，计算公式 64G*1024*1024*1024(字节)</span></span><br><span class="line">kernel.shmmax = 68719476736  </span><br><span class="line"><span class="comment"># 所有内存大小（单位：页，1 页 = 4Kb），计算公式 16G*1024*1024*1024/4KB(页)</span></span><br><span class="line">kernel.shmall = 4294967296  </span><br><span class="line"><span class="comment">#timewait 的数量，默认是 180000</span></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 6000  </span><br><span class="line"><span class="comment"># 开启有选择的应答</span></span><br><span class="line">net.ipv4.tcp_sack = 1  </span><br><span class="line"><span class="comment"># 支持更大的 TCP 窗口. 如果 TCP 窗口最大超过 65535(64K), 必须设置该数值为 1</span></span><br><span class="line">net.ipv4.tcp_window_scaling = 1  </span><br><span class="line"><span class="comment">#TCP 读 buffer</span></span><br><span class="line">net.ipv4.tcp_rmem = 4096 131072 1048576</span><br><span class="line"><span class="comment">#TCP 写 buffer</span></span><br><span class="line">net.ipv4.tcp_wmem = 4096 131072 1048576   </span><br><span class="line"><span class="comment"># 为 TCP socket 预留用于发送缓冲的内存默认值（单位：字节）</span></span><br><span class="line">net.core.wmem_default = 8388608</span><br><span class="line"><span class="comment"># 为 TCP socket 预留用于发送缓冲的内存最大值（单位：字节）</span></span><br><span class="line">net.core.wmem_max = 16777216  </span><br><span class="line"><span class="comment"># 为 TCP socket 预留用于接收缓冲的内存默认值（单位：字节）  </span></span><br><span class="line">net.core.rmem_default = 8388608</span><br><span class="line"><span class="comment"># 为 TCP socket 预留用于接收缓冲的内存最大值（单位：字节）</span></span><br><span class="line">net.core.rmem_max = 16777216</span><br><span class="line"><span class="comment"># 每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目</span></span><br><span class="line">net.core.netdev_max_backlog = 262144  </span><br><span class="line"><span class="comment">#web 应用中 listen 函数的 backlog 默认会给我们内核参数的 net.core.somaxconn 限制到 128，而 nginx 定义的 NGX_LISTEN_BACKLOG 默认为 511，所以有必要调整这个值</span></span><br><span class="line">net.core.somaxconn = 262144  </span><br><span class="line"><span class="comment"># 系统中最多有多少个 TCP 套接字不被关联到任何一个用户文件句柄上。这个限制仅仅是为了防止简单的 DoS 攻击，不能过分依靠它或者人为地减小这个值，更应该增加这个值(如果增加了内存之后)</span></span><br><span class="line">net.ipv4.tcp_max_orphans = 3276800  </span><br><span class="line"><span class="comment"># 记录的那些尚未收到客户端确认信息的连接请求的最大值。对于有 128M 内存的系统而言，缺省值是 1024，小内存的系统则是 128</span></span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 262144  </span><br><span class="line"><span class="comment"># 时间戳可以避免序列号的卷绕。一个 1Gbps 的链路肯定会遇到以前用过的序列号。时间戳能够让内核接受这种“异常” 的数据包。这里需要将其关掉</span></span><br><span class="line">net.ipv4.tcp_timestamps = 0  </span><br><span class="line"><span class="comment"># 为了打开对端的连接，内核需要发送一个 SYN 并附带一个回应前面一个 SYN 的 ACK。也就是所谓三次握手中的第二次握手。这个设置决定了内核放弃连接之前发送 SYN+ACK 包的数量</span></span><br><span class="line">net.ipv4.tcp_synack_retries = 1  </span><br><span class="line"><span class="comment"># 在内核放弃建立连接之前发送 SYN 包的数量</span></span><br><span class="line">net.ipv4.tcp_syn_retries = 1  </span><br><span class="line"><span class="comment"># 开启 TCP 连接中 time_wait sockets 的快速回收</span></span><br><span class="line">net.ipv4.tcp_tw_recycle = 1  </span><br><span class="line"><span class="comment"># 开启 TCP 连接复用功能，允许将 time_wait sockets 重新用于新的 TCP 连接（主要针对 time_wait 连接）</span></span><br><span class="line">net.ipv4.tcp_tw_reuse = 1  </span><br><span class="line"><span class="comment">#1st 低于此值, TCP 没有内存压力, 2nd 进入内存压力阶段, 3rdTCP 拒绝分配 socket(单位：内存页)</span></span><br><span class="line">net.ipv4.tcp_mem = 94500000 915000000 927000000   </span><br><span class="line"><span class="comment"># 如果套接字由本端要求关闭，这个参数决定了它保持在 FIN-WAIT-2 状态的时间。对端可以出错并永远不关闭连接，甚至意外当机。缺省值是 60 秒。2.2 内核的通常值是 180 秒，你可以按这个设置，但要记住的是，即使你的机器是一个轻载的 WEB 服务器，也有因为大量的死套接字而内存溢出的风险，FIN- WAIT-2 的危险性比 FIN-WAIT-1 要小，因为它最多只能吃掉 1.5K 内存，但是它们的生存期长些。</span></span><br><span class="line">net.ipv4.tcp_fin_timeout = 15  </span><br><span class="line"><span class="comment"># 表示当 keepalive 起用的时候，TCP 发送 keepalive 消息的频度（单位：秒）</span></span><br><span class="line">net.ipv4.tcp_keepalive_time = 30  </span><br><span class="line"><span class="comment"># 对外连接端口范围</span></span><br><span class="line">net.ipv4.ip_local_port_range = 2048 65000</span><br><span class="line"><span class="comment"># 表示文件句柄的最大数量</span></span><br><span class="line">fs.file-max = 102400</span><br></pre></td></tr></table></figure><blockquote><p>这是我在实际生产系统自动化部署中用的配置，不做过渡优化</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sysctl settings are defined through files in</span></span><br><span class="line"><span class="comment"># /usr/lib/sysctl.d/, /run/sysctl.d/, and /etc/sysctl.d/.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Vendors settings live in /usr/lib/sysctl.d/.</span></span><br><span class="line"><span class="comment"># To override a whole file, create a new file with the same in</span></span><br><span class="line"><span class="comment"># /etc/sysctl.d/ and put new settings there. To override</span></span><br><span class="line"><span class="comment"># only specific settings, add a file with a lexically later</span></span><br><span class="line"><span class="comment"># name in /etc/sysctl.d/ and put new settings there.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For more information, see sysctl.conf(5) and sysctl.d(5).</span></span><br><span class="line">vm.dirty_writeback_centisecs=100</span><br><span class="line">vm.dirty_expire_centisecs=100</span><br><span class="line">vm.swappiness=1</span><br><span class="line">net.ipv4.ip_local_port_range=10000    65001</span><br><span class="line">net.ipv4.tcp_max_orphans=4000000</span><br><span class="line">net.ipv4.tcp_timestamps=0</span><br><span class="line">net.core.somaxconn=1024</span><br><span class="line">net.netfilter.nf_conntrack_max=121005752</span><br><span class="line">kernel.core_pattern=/var/coredump/core.%e.%p.%t</span><br></pre></td></tr></table></figure><blockquote><p>最后记得刷新立即生效</p></blockquote><pre><code>/sbin/sysctl -p</code></pre>]]></content>
    
    <summary type="html">
    
      sysctl.conf和limits.conf学习和调优
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
</feed>
