<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>HelloDog</title>
  
  <subtitle>Keep Calm and Carry On</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://wsgzao.github.io/"/>
  <updated>2020-01-20T09:26:35.073Z</updated>
  <id>https://wsgzao.github.io/</id>
  
  <author>
    <name>wsgzao</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>使用 Monit 替代 Supervisor 自动化管理和监控服务小结</title>
    <link href="https://wsgzao.github.io/post/monit/"/>
    <id>https://wsgzao.github.io/post/monit/</id>
    <published>2020-01-15T06:59:49.000Z</published>
    <updated>2020-01-20T09:26:35.073Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>对于进程的监控最常见的需求就是进程挂了如何被自动拉起来，现在可以由 Kubernetes 等先进的容器化技术来自动化管理，那原来再物理服务器或者虚拟机中的进程有什么好的办法呢？答案就是 Monit/Supervisor 等第三方应用来解决，因为线上环境我们分别使用了 Monit 来监控 Core Logical Service，Supervisor 用在 Codis Dashboard/FE/Proxy 上，使用下来的感受和网上的对比分析报告类似，具体内容会在文章内引用，我会更加推荐大家使用 Monit 替代 Supervisor 自动化管理和监控服务。</p><blockquote><p>使用 Monit 替代 Supervisor 自动化管理和监控服务小结</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2020 年 01 月 15 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/monit/">https://wsgzao.github.io/post/monit/</a></p><p><strong> 扩展阅读 </strong></p><p><a href="https://mmonit.com/" target="_blank" rel="noopener">Monit</a><br><a href="http://supervisord.org/" target="_blank" rel="noopener">Supervisor</a></p><hr><h2 id="Monit-介绍"><a href="#Monit-介绍" class="headerlink" title="Monit 介绍"></a>Monit 介绍</h2><blockquote><p>NAME</p></blockquote><p>Monit - utility for monitoring services on a Unix system</p><blockquote><p>SYNOPSIS</p></blockquote><p><strong>monit</strong> [options] <arguments></arguments></p><blockquote><p>DESCRIPTION</p></blockquote><p><strong>Monit</strong> is a utility for managing and monitoring processes, programs, files, directories and filesystems on a Unix system. Monit conducts automatic maintenance and repair and can execute meaningful causal actions in error situations. E.g. Monit can start a process if it does not run, restart a process if it does not respond and stop a process if it uses too much resources. You can use Monit to monitor files, directories and filesystems for changes, such as timestamps changes, checksum changes or size changes.</p><p>Monit is controlled via an easy to configure control file based on a free-format, token-oriented syntax. Monit logs to syslog or to its own log file and notifies you about error conditions via customisable alert messages. Monit can perform various TCP/IP network checks, protocol checks and can utilise SSL for such checks. Monit provides a HTTP(S) interface and you may use a browser to access the Monit program.</p><blockquote><p>WHAT TO MONITOR?</p></blockquote><p>You can use Monit to monitor daemon <strong>processes</strong> or similar programs running on localhost. Monit is particularly useful for monitoring daemon processes, such as those started at system boot time. For instance sendmail, sshd, apache and mysql. In contrast to many other monitoring systems, Monit can act if an error situation should occur, e.g.; if sendmail is not running, monit can start sendmail again automatically or if apache is using too many resources (e.g. if a DoS attack is in progress) Monit can stop or restart apache and send you an alert message. Monit can also monitor process characteristics, such as how much memory or cpu cycles a process is using.</p><p>You can also use Monit to monitor <strong>files</strong>, <strong>directories</strong> and <strong>filesystems</strong> on localhost. Monit can monitor these items for changes, such as timestamps changes, checksum changes or size changes. This is also useful for security reasons - you can monitor the md5 or sha1 checksum of files that should not change and get an alert or perform an action if they should change.</p><p>Monit can monitor <strong>network connections</strong> to various servers, either on localhost or on remote hosts. TCP, UDP and Unix Domain Sockets are supported. Network test can be performed on a protocol level; Monit has built-in tests for the main Internet protocols, such as HTTP, SMTP etc. Even if a protocol is not supported you can still test the server because you can configure Monit to send any data and test the response from the server.</p><p>Monit can be used to test <strong>programs</strong> or scripts at certain times, much like cron, but in addition, you can test the exit value of a program and perform an action or send an alert if the exit value indicates an error. This means that you can use Monit to perform any type of check you can write a script for.</p><p>Finally, Monit can be used to monitor general <strong>system</strong> resources on localhost such as overall CPU usage, Memory and System Load.</p><p><a href="https://mmonit.com/monit/documentation/monit.html" target="_blank" rel="noopener">https://mmonit.com/monit/documentation/monit.html</a></p><h2 id="Supervisor-介绍"><a href="#Supervisor-介绍" class="headerlink" title="Supervisor 介绍"></a>Supervisor 介绍</h2><h1 id="Supervisor-A-Process-Control-System"><a href="#Supervisor-A-Process-Control-System" class="headerlink" title="Supervisor: A Process Control System"></a>Supervisor: A Process Control System</h1><p>Supervisor is a client/server system that allows its users to monitor and control a number of processes on UNIX-like operating systems.</p><p>It shares some of the same goals of programs like <a href="http://supervisord.org/glossary.html#term-launchd" target="_blank" rel="noopener"><em>launchd</em></a>, <a href="http://supervisord.org/glossary.html#term-daemontools" target="_blank" rel="noopener"><em>daemontools</em></a>, and <a href="http://supervisord.org/glossary.html#term-runit" target="_blank" rel="noopener"><em>runit</em></a>. Unlike some of these programs, it is not meant to be run as a substitute for init as “process id 1”. Instead it is meant to be used to control processes related to a project or a customer, and is meant to start like any other program at boot time.</p><p><a href="http://supervisord.org/" target="_blank" rel="noopener">http://supervisord.org/</a></p><h2 id="Monit-VS-Supervisor"><a href="#Monit-VS-Supervisor" class="headerlink" title="Monit VS Supervisor"></a>Monit VS Supervisor</h2><h3 id="Monit-是什么"><a href="#Monit-是什么" class="headerlink" title="Monit 是什么"></a>Monit 是什么</h3><ul><li>Monit 是一个管理和监控 Unix 系统的小型开源组件.</li><li>Monit 可以在出现错误的情况下, 自动维护, 修复和做一些有意义的行为</li></ul><h3 id="为什么选择-Monit"><a href="#为什么选择-Monit" class="headerlink" title="为什么选择 Monit"></a>为什么选择 Monit</h3><p>除了 Monit 还有一些其他的第三方监控方案(eg. Supervisor), 我们考虑选择额 Monit 作为监控的原因有</p><ul><li>超轻量, 稳定, 高可用</li><li>依赖少, 安装配置方便, 尽量减少运维及学习成本(即使没有任何 Monit 基础的人, 都能轻易的读懂大部分监控文件)</li><li>非侵入式, 被监控的程序可以不用知道监控程序的存在(如果使用 Supervisor 监控, 则服务必须从 Supervisor 启动)</li><li>基本功能完备(9 种类型监控, 邮件报警, 支持用户自定义 shell 扩展)</li></ul><h3 id="Supervisor-优缺点"><a href="#Supervisor-优缺点" class="headerlink" title="Supervisor 优缺点"></a>Supervisor 优缺点</h3><p><strong> 优点 </strong></p><ol><li>轻量、特性丰富、内存友好(好客套的优点。。。)</li><li>对被监控进程的状态获取迅速且精确——通过子进程管理，没办法不精确</li></ol><p><strong> 缺点 </strong></p><ol><li>被监控进程必须运行在前台(可以理解为有自己的控制终端)——这也是最为致命的一点</li><li>无法管理依赖，也就是说无法控制服务启动先后顺序</li><li>无法管理被监控进程创建的子进程——重启服务时被监控进程的子进程无法正常退出，隐患大</li><li>无法控制进程失败重试的间隔时间——有些进程需要清理资源，不过这点还好</li></ol><h3 id="Monit-优缺点"><a href="#Monit-优缺点" class="headerlink" title="Monit 优缺点"></a>Monit 优缺点</h3><p><strong> 优点 </strong></p><ol><li>安装配置简单，同样轻量(似乎也是很客套了)</li><li>可以监控前台进程和非前台进程——完美的弥补了 supervisor 的致命缺点</li><li>除了监控进程还能监控文件、文件系统，甚至系统资源，CPU 利用率，内存使用也是可以的</li><li>被监控的进程可以设置依赖，控制启动顺序</li></ol><p><strong> 缺点 </strong></p><ol><li>无法监控没有 pid 文件的进程，如 shell 脚本</li><li>对进程监控的状态感知有延时，即精度不够——采用轮训决定了它无法像 supervisor 一样实时感知被监控进程状态</li></ol><p>这样看起来还是 monit 更为普适一点。</p><p>不过这催生了一个大胆的想法，使用 supervisor 管理容器内多进程，monit 作为一个被监控进程挂在 supervisor 之下。这样对于无法前台运行的程序，就可以通过 monit 监控，而对服务中断感知强烈的则直接挂在 supervisor 之下。看起来似乎是个好办法，有机会试试，哈哈哈。</p><p>从实际容器中运行的表现看，monit 经常出现各种未知异常，而 supervisor 表现得十分稳定。</p><h2 id="Monit-基本用法"><a href="#Monit-基本用法" class="headerlink" title="Monit 基本用法"></a>Monit 基本用法</h2><h3 id="Monit-常用命令"><a href="#Monit-常用命令" class="headerlink" title="Monit 常用命令"></a>Monit 常用命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># monit -h</span></span><br><span class="line">Usage: monit [options]+ [<span class="built_in">command</span>]</span><br><span class="line">Options are as follows:</span><br><span class="line"> -c file       Use this control file</span><br><span class="line"> -d n          Run as a daemon once per n seconds</span><br><span class="line"> -g name       Set group name <span class="keyword">for</span> monit commands</span><br><span class="line"> -l logfile    Print <span class="built_in">log</span> information to this file</span><br><span class="line"> -p pidfile    Use this lock file <span class="keyword">in</span> daemon mode</span><br><span class="line"> -s statefile  Set the file monit should write state information to</span><br><span class="line"> -I            Do not run <span class="keyword">in</span> background (needed when run from init)</span><br><span class="line"> --id          Print Monit<span class="string">'s unique ID</span></span><br><span class="line"><span class="string"> --resetid     Reset Monit'</span>s unique ID. Use with caution</span><br><span class="line"> -B            Batch <span class="built_in">command</span> line mode (<span class="keyword">do</span> not output tables or colors)</span><br><span class="line"> -t            Run syntax check <span class="keyword">for</span> the control file</span><br><span class="line"> -v            Verbose mode, work noisy (diagnostic output)</span><br><span class="line"> -vv           Very verbose mode, same as -v plus <span class="built_in">log</span> stacktrace on error</span><br><span class="line"> -H [filename] Print SHA1 and MD5 hashes of the file or of stdin <span class="keyword">if</span> the</span><br><span class="line">               filename is omited; monit will <span class="built_in">exit</span> afterwards</span><br><span class="line"> -V            Print version number and patchlevel</span><br><span class="line"> -h            Print this text</span><br><span class="line">Optional commands are as follows:</span><br><span class="line"> start all             - Start all services</span><br><span class="line"> start &lt;name&gt;          - Only start the named service</span><br><span class="line"> stop all              - Stop all services</span><br><span class="line"> stop &lt;name&gt;           - Stop the named service</span><br><span class="line"> restart all           - Stop and start all services</span><br><span class="line"> restart &lt;name&gt;        - Only restart the named service</span><br><span class="line"> monitor all           - Enable monitoring of all services</span><br><span class="line"> monitor &lt;name&gt;        - Only <span class="built_in">enable</span> monitoring of the named service</span><br><span class="line"> unmonitor all         - Disable monitoring of all services</span><br><span class="line"> unmonitor &lt;name&gt;      - Only <span class="built_in">disable</span> monitoring of the named service</span><br><span class="line"> reload                - Reinitialize monit</span><br><span class="line"> status [name]         - Print full status information <span class="keyword">for</span> service(s)</span><br><span class="line"> summary [name]        - Print short status information <span class="keyword">for</span> service(s)</span><br><span class="line"> report [up|down|..]   - Report state of services. See manual <span class="keyword">for</span> options</span><br><span class="line"> quit                  - Kill the monit daemon process</span><br><span class="line"> validate              - Check all services and start <span class="keyword">if</span> not running</span><br><span class="line"> procmatch &lt;pattern&gt;   - Test process matching pattern</span><br></pre></td></tr></table></figure><p>想要让 Monit 可靠的为我们工作, 学习成本非常低, 只需要学习一些 Monit 命令行和配置文件写法</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># options - 选项</span></span><br><span class="line">- monit</span><br><span class="line">- monit -t</span><br><span class="line">- monit -c /var/monit/monitrc  <span class="comment"># 指定配置文件</span></span><br><span class="line">- monit -g &lt;groupname&gt; start/stop <span class="comment"># Monit 可以对各个监控分组, 如果需要对某个分组统一操作, 可以用这个命令</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># arguments - 参数</span></span><br><span class="line">- monit reload</span><br><span class="line">- monit quit</span><br><span class="line">- monit start/stop/restart/monitor/unmonitor &lt;name&gt;/all  <span class="comment"># &lt;name&gt;: 每个监控都有一个独一无二的名字, 具体后面会提到; all: 所有监控服务</span></span><br></pre></td></tr></table></figure><h3 id="Monit-服务监控配置文件格式"><a href="#Monit-服务监控配置文件格式" class="headerlink" title="Monit 服务监控配置文件格式"></a>Monit 服务监控配置文件格式</h3><p>详细配置, 共计 9 种, 所有配置中, 都符合以下规则</p><ul><li>如果指定的 path 不存在, 而且配置块里包含 start 方法, 会调用这个 start 方法</li><li>如果 path 指定的文件类型不对, Monit 不能监控这个项目</li></ul><blockquote><ol><li>Process</li></ol></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CHECK PROCESS &lt;unique name&gt; &lt;PIDFILE &lt;path&gt; | MATCHING &lt;regex&gt;&gt;</span><br><span class="line"></span><br><span class="line">&lt;path&gt; pid-file 的绝对路径. 不存在 pid-file 文件或者 pid-file 文件没有对应的正在运行的程序, Monit 会执行 start 方法</span><br><span class="line"></span><br><span class="line">&lt;regex&gt; 进程名称的正则表达来监控进程, 可以通过命令行测试正则是否写对了: monit procmatch &quot;regex-pattern&quot;</span><br></pre></td></tr></table></figure><blockquote><ol start="2"><li>File</li></ol></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CHECK FILE &lt;unique name&gt; PATH &lt;path&gt;</span><br><span class="line"></span><br><span class="line">&lt;path&gt; file 的绝对路径.</span><br></pre></td></tr></table></figure><blockquote><ol start="3"><li>Fifo</li></ol></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CHECK FIFO &lt;unique name&gt; PATH &lt;path&gt;</span><br><span class="line">&lt;path&gt; fifo 的绝对路径.</span><br></pre></td></tr></table></figure><blockquote><ol start="4"><li>Filesystem</li></ol></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CHECK FILESYSTEM &lt;unique name&gt; PATH &lt;path&gt;</span><br><span class="line">&lt;path&gt; 设备 / 磁盘, 挂载点的路径 或 NFS/CIFS/FUSE 链接字符串. 如果文件系统不可用, Monit 会执行 start 方法</span><br></pre></td></tr></table></figure><blockquote><ol start="5"><li>Directory</li></ol></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CHECK DIRECTORY &lt;unique name&gt; PATH &lt;path&gt;</span><br><span class="line"></span><br><span class="line">&lt;path&gt; 目录问价的绝对路径</span><br></pre></td></tr></table></figure><blockquote><ol start="6"><li>Remote host</li></ol></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CHECK HOST &lt;unique name&gt; ADDRESS &lt;host&gt;</span><br><span class="line"></span><br><span class="line">&lt;host&gt; 可以是域名或者 IP 地址. eg: &quot;tildeslash.com&quot; or &quot;64.87.72.95&quot;.</span><br></pre></td></tr></table></figure><blockquote><ol start="7"><li>System</li></ol></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CHECK SYSTEM &lt;unique name&gt;</span><br><span class="line"></span><br><span class="line">&lt;unique name&gt; 通常来说是本机名称 (可以用 $HOST), 也可以是其他名称. 用于邮件报警或者 M/Monit 的初始化名称</span><br><span class="line"> 这类配置可以监控系统资源(CPU, memory, load average...)</span><br></pre></td></tr></table></figure><blockquote><ol start="8"><li>Program</li></ol></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CHECK PROGRAM &lt;unique name&gt; PATH &lt;executable file&gt; [TIMEOUT &lt;number&gt; SECONDS]</span><br><span class="line"></span><br><span class="line">&lt;path&gt; 可执行程序或脚本的绝对路径. 允许检查程序退出状态. 如果程序没能在 &lt;number&gt; 秒内执行完成, Monit 会终结这个程序, 默认是 300s</span><br><span class="line">程序的输出会被记录, 用于用户界面或者报警, 默认 512 bytes(可以通过 set limits 修改)</span><br></pre></td></tr></table></figure><blockquote><ol start="9"><li>Network</li></ol></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CHECK NETWORK &lt;unique name&gt; &lt;ADDRESS &lt;ipaddress&gt; | INTERFACE &lt;name&gt;&gt;</span><br><span class="line"></span><br><span class="line"># &lt;ipaddress&gt; 是被监控的 IPv4/IPv6 网卡地址. 用 eth0 也是可以的</span><br></pre></td></tr></table></figure><p>更多配置信息可以参考 Monit 官方文档和实例</p><p><a href="https://mmonit.com/documentation/" target="_blank" rel="noopener">https://mmonit.com/documentation/</a></p><p><a href="https://mmonit.com/wiki/Monit/ConfigurationExamples" target="_blank" rel="noopener">https://mmonit.com/wiki/Monit/ConfigurationExamples</a></p><h2 id="Monit-配置实践"><a href="#Monit-配置实践" class="headerlink" title="Monit 配置实践"></a>Monit 配置实践</h2><ol><li>创建 templates 模板，利用 python 生成 monit 配置文件</li><li>使用 ansible 推送到目标服务器中</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建通用配置，配置日志，邮件告警</span></span><br><span class="line">vim basic.j2</span><br><span class="line"></span><br><span class="line"><span class="comment"># log to monit.log</span></span><br><span class="line"><span class="built_in">set</span> logfile /var/<span class="built_in">log</span>/monit.log</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> daemon &#123;&#123; monit_poll_interval &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> eventqueue basedir /var/lib/monit/events slots 5000</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> mailserver smtp.xxx.com port 465</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> alert xxx@xxx.com &#123; nonexist, timeout, resource &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> mail-format &#123;</span><br><span class="line">  from: xxx@xxx.com</span><br><span class="line">  subject: monit alert -- <span class="variable">$SERVICE</span> <span class="variable">$EVENT</span> at <span class="variable">$DATE</span></span><br><span class="line">  message: <span class="variable">$EVENT</span> Service <span class="variable">$SERVICE</span></span><br><span class="line">                Date:        <span class="variable">$DATE</span></span><br><span class="line">                Action:      <span class="variable">$ACTION</span></span><br><span class="line">                Host:        <span class="variable">$HOST</span></span><br><span class="line">                Description: <span class="variable">$DESCRIPTION</span></span><br><span class="line"></span><br><span class="line">           Your faithful employee,</span><br><span class="line">           Monit</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建标准应用监控</span></span><br><span class="line">vim daemon_set.j2</span><br><span class="line"></span><br><span class="line">check process xxx with pidfile /run/xxx/daemon.pid</span><br><span class="line">    start program = <span class="string">"/usr/bin/python2  /bin/xxx restart"</span></span><br><span class="line">    stop program = <span class="string">"/usr/bin/python2 /bin/xxx stop"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> 10 restarts within 10 cycles <span class="keyword">then</span> unmonitor</span><br><span class="line"></span><br><span class="line">check process xxxx with matching xxxx</span><br><span class="line">start program = <span class="string">"/etc/init.d/xxxx start"</span></span><br><span class="line">stop program = <span class="string">"/etc/init.d/xxxx stop"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> 10 restarts within 10 cycles <span class="keyword">then</span> unmonitor</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建非标准应用监控</span></span><br><span class="line">vim logic_service.j2</span><br><span class="line"></span><br><span class="line">check process &#123;&#123; service_name &#125;&#125; with pidfile &#123;&#123; root_dir &#125;&#125;/&#123;&#123; service_name &#125;&#125;/deploy/&#123;&#123; monit_name &#125;&#125;.pid</span><br><span class="line">    start program = <span class="string">"/bin/bash -c'cd &#123;&#123; root_dir &#125;&#125;/&#123;&#123; service_name &#125;&#125;/deploy &amp;&amp; ./start.sh &amp;&gt;start.log '"</span></span><br><span class="line">    stop program = <span class="string">"/bin/bash -c 'cd &#123;&#123; root_dir &#125;&#125;/&#123;&#123; service_name &#125;&#125;/deploy &amp;&amp; ./stop.sh &amp;&gt;stop.log'"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> 5 restarts within 15 cycles <span class="keyword">then</span> unmonitor</span><br><span class="line">    &#123;% <span class="keyword">if</span> memory_usage is defined %&#125;</span><br><span class="line">    <span class="keyword">if</span> total memory usage &gt; &#123;&#123; memory_usage &#125;&#125; <span class="keyword">for</span> 10 cycles <span class="keyword">then</span> restart</span><br><span class="line">    &#123;% endif %&#125;</span><br></pre></td></tr></table></figure><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://mmonit.com/monit/documentation/monit.html" target="_blank" rel="noopener">Monit Document</a></p><p><a href="https://github.com/freeaquar/notebook/blob/master/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/Monit-%E7%AC%94%E8%AE%B0.md" target="_blank" rel="noopener">Monit 笔记</a></p><p><a href="https://blog.csdn.net/u010039418/article/details/83784195" target="_blank" rel="noopener">Docker 容器内多进程管理——supervisor VS monit</a></p>]]></content>
    
    <summary type="html">
    
      使用Monit替代Supervisor自动化管理和监控服务小结
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>YAML 入门教程</title>
    <link href="https://wsgzao.github.io/post/yaml/"/>
    <id>https://wsgzao.github.io/post/yaml/</id>
    <published>2020-01-08T06:59:49.000Z</published>
    <updated>2020-01-08T10:52:19.354Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>YAML 是 “YAML Ain’t a Markup Language”（YAML 不是一种标记语言）的递归缩写。在开发的这种语言时，YAML 的意思其实是：”Yet Another Markup Language”（仍是一种标记语言）。</p><p>YAML 的语法和其他高级语言类似，并且可以简单表达清单、散列表，标量等数据形态。它使用空白符号缩进和大量依赖外观的特色，特别适合用来表达或编辑数据结构、各种配置文件、倾印调试内容、文件大纲（例如：许多电子邮件标题格式和 YAML 非常接近）。</p><p>YAML 的配置文件后缀为 .yml，如：ansible-playbook.yml，Hexo 的配置文件也是_config.yml</p><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2020 年 01 月 09 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/yaml/">https://wsgzao.github.io/post/yaml/</a></p><p><strong> 扩展阅读 </strong></p><p><a href="https://yaml.org/" target="_blank" rel="noopener">YAML</a></p><hr><h2 id="YAML-简介"><a href="#YAML-简介" class="headerlink" title="YAML 简介"></a>YAML 简介</h2><p>YAML: YAML Ain’t Markup Language</p><p>What It Is: YAML is a human friendly data serialization standard for all programming languages.</p><p>YAML 语言（发音 /ˈjæməl/ ）的设计目标，就是方便人类读写。它实质上是一种通用的数据串行化格式。</p><p>它的基本语法规则如下。</p><ul><li>大小写敏感</li><li>使用缩进表示层级关系</li><li>缩进时不允许使用 Tab 键，只允许使用空格。</li><li>缩进的空格数目不重要，只要相同层级的元素左侧对齐即可</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># 表示注释，从这个字符一直到行尾，都会被解析器忽略。</span><br></pre></td></tr></table></figure><p>YAML 支持的数据结构有三种。</p><ul><li>对象：键值对的集合，又称为映射（mapping）/ 哈希（hashes） / 字典（dictionary）</li><li>数组：一组按次序排列的值，又称为序列（sequence） / 列表（list）</li><li>纯量（scalars）：单个的、不可再分的值</li></ul><h2 id="X-分钟速成-Y"><a href="#X-分钟速成-Y" class="headerlink" title="X 分钟速成 Y"></a>X 分钟速成 Y</h2><blockquote><p>其中 Y=yaml</p></blockquote><p>源代码下载： <a href="https://learnxinyminutes.com/docs/files/learnyaml-cn.yaml" target="_blank" rel="noopener">learnyaml-cn.yaml</a></p><p>YAML 是一个数据序列化语言，被设计成人类直接可写可读的。</p><p>它是 JSON 的严格超集，增加了语法显著换行符和缩进，就像 Python。但和 Python 不一样， YAML 根本不容许文字制表符。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># YAML 中的注解看起来像这样。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################</span></span><br><span class="line"><span class="comment"># 标量类型     #</span></span><br><span class="line"><span class="comment">################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 我们的根对象 (它们在整个文件里延续) 将会是一个映射，</span></span><br><span class="line"><span class="comment"># 它等价于在别的语言里的一个字典，哈希表或对象。</span></span><br><span class="line"><span class="attr">key:</span> <span class="string">value</span></span><br><span class="line"><span class="attr">another_key:</span> <span class="string">Another</span> <span class="string">value</span> <span class="string">goes</span> <span class="string">here.</span></span><br><span class="line"><span class="attr">a_number_value:</span> <span class="number">100</span></span><br><span class="line"><span class="comment"># 数字 1 会被解释为数值，而不是一个布尔值。</span></span><br><span class="line"><span class="comment"># 如果你想要的是一个布尔值，使用 true。</span></span><br><span class="line"><span class="attr">scientific_notation:</span> <span class="number">1e+12</span></span><br><span class="line"><span class="attr">boolean:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">null_value:</span> <span class="literal">null</span></span><br><span class="line"><span class="string">key</span> <span class="string">with</span> <span class="attr">spaces:</span> <span class="string">value</span></span><br><span class="line"><span class="comment"># 注意，字符串不必被括在引号中，但也可以被括起来。</span></span><br><span class="line"><span class="attr">however:</span> <span class="string">'A string, enclosed in quotes.'</span></span><br><span class="line"><span class="string">'Keys can be quoted too.'</span><span class="string">:</span> <span class="string">"Useful if you want to put a':'in your key."</span></span><br><span class="line"><span class="string">single</span> <span class="attr">quotes:</span> <span class="string">'have'</span><span class="string">'one'</span><span class="string">'escape pattern'</span></span><br><span class="line"><span class="string">double</span> <span class="attr">quotes:</span> <span class="string">"have many: \", \0, \t, \u263A, \x0d\x0a == \r\n, and more."</span></span><br><span class="line"><span class="comment"># UTF-8/16/32 字符需要被转义 (encoded)</span></span><br><span class="line"><span class="string">Superscript</span> <span class="attr">two:</span> <span class="string">\u00B2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 多行字符串既可以写成像一个'文字块'(使用 |)，</span></span><br><span class="line"><span class="comment"># 或像一个'折叠块'(使用'&gt;')。</span></span><br><span class="line"><span class="attr">literal_block:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    This entire block of text will be the value of the'literal_block'key,</span></span><br><span class="line"><span class="string">    with line breaks being preserved.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The literal continues until de-dented, and the leading indentation is</span></span><br><span class="line"><span class="string">    stripped.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Any lines that are'more-indented'keep the rest of their indentation -</span></span><br><span class="line"><span class="string">        these lines will be indented by 4 spaces.</span></span><br><span class="line"><span class="string"></span><span class="attr">folded_style:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">    This entire block of text will be the value of'folded_style', but this</span></span><br><span class="line"><span class="string">    time, all newlines will be replaced with a single space.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Blank lines, like above, are converted to a newline character.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'More-indented'lines keep their newlines, too -</span></span><br><span class="line"><span class="string">        this text will appear over two lines.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">####################</span></span><br><span class="line"><span class="string"># 集合类型         #</span></span><br><span class="line"><span class="string">####################</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 嵌套是通过缩进完成的。推荐使用 2 个空格的缩进（但非必须）</span></span><br><span class="line"><span class="string"></span><span class="attr">a_nested_map:</span></span><br><span class="line"><span class="attr">  key:</span> <span class="string">value</span></span><br><span class="line"><span class="attr">  another_key:</span> <span class="string">Another</span> <span class="string">Value</span></span><br><span class="line"><span class="attr">  another_nested_map:</span></span><br><span class="line"><span class="attr">    hello:</span> <span class="string">hello</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 映射的键不必是字符串。</span></span><br><span class="line"><span class="number">0.25</span><span class="string">:</span> <span class="string">a</span> <span class="string">float</span> <span class="string">key</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 键也可以是复合型的，比如多行对象 </span></span><br><span class="line"><span class="comment"># 我们用 ? 后跟一个空格来表示一个复合键的开始。</span></span><br><span class="line"><span class="string">?</span> <span class="string">|</span></span><br><span class="line"><span class="string">  This is a key</span></span><br><span class="line"><span class="string">  that has multiple lines</span></span><br><span class="line"><span class="string">: and this is its value</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># YAML 也允许使用复杂键语法表示序列间的映射关系。</span></span><br><span class="line"><span class="string"># 但有些语言的解析器可能会不支持。</span></span><br><span class="line"><span class="string"># 一个例子：</span></span><br><span class="line"><span class="string">? - Manchester United</span></span><br><span class="line"><span class="string">  - Real Madrid</span></span><br><span class="line"><span class="string">: [ 2001-01-01, 2002-02-02 ]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 序列 (等价于列表或数组) 看起来像这样：</span></span><br><span class="line"><span class="string"># 注意'-'算作缩进 </span></span><br><span class="line"><span class="string"></span><span class="attr">a_sequence:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">Item</span> <span class="number">1</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">Item</span> <span class="number">2</span></span><br><span class="line"><span class="bullet">  -</span> <span class="number">0.5</span> <span class="comment"># 序列可以包含不同类型。</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">Item</span> <span class="number">4</span></span><br><span class="line"><span class="attr">  - key:</span> <span class="string">value</span></span><br><span class="line"><span class="attr">    another_key:</span> <span class="string">another_value</span></span><br><span class="line"><span class="bullet">  -</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">This</span> <span class="string">is</span> <span class="string">a</span> <span class="string">sequence</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">inside</span> <span class="string">another</span> <span class="string">sequence</span></span><br><span class="line"><span class="bullet">  -</span> <span class="bullet">-</span> <span class="bullet">-</span> <span class="string">Nested</span> <span class="string">sequence</span> <span class="string">indicators</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">can</span> <span class="string">be</span> <span class="string">collapsed</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 因为 YAML 是 JSON 的超集，你也可以写 JSON 风格的映射和序列：</span></span><br><span class="line"><span class="attr">json_map:</span> <span class="string">&#123;"key":</span> <span class="string">"value"</span><span class="string">&#125;</span></span><br><span class="line"><span class="attr">json_seq:</span> <span class="string">[3,</span> <span class="number">2</span><span class="string">,</span> <span class="number">1</span><span class="string">,</span> <span class="string">"takeoff"</span><span class="string">]</span></span><br><span class="line"><span class="string">and</span> <span class="string">quotes</span> <span class="string">are</span> <span class="attr">optional:</span> <span class="string">&#123;key:</span> <span class="string">[3,</span> <span class="number">2</span><span class="string">,</span> <span class="number">1</span><span class="string">,</span> <span class="string">takeoff]&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#######################</span></span><br><span class="line"><span class="comment"># 其余的 YAML 特性    #</span></span><br><span class="line"><span class="comment">#######################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># YAML 还有一个方便的特性叫'锚'，它能让你很容易在文档中进行文本复用。</span></span><br><span class="line"><span class="comment"># 如下两个键会有相同的值：</span></span><br><span class="line"><span class="attr">anchored_content:</span> <span class="meta">&amp;anchor_name</span> <span class="string">This</span> <span class="string">string</span> <span class="string">will</span> <span class="string">appear</span> <span class="string">as</span> <span class="string">the</span> <span class="string">value</span> <span class="string">of</span> <span class="string">two</span> <span class="string">keys.</span></span><br><span class="line"><span class="attr">other_anchor:</span> <span class="meta">*anchor_name</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 锚也可被用来复制 / 继承属性 </span></span><br><span class="line"><span class="attr">base:</span> <span class="meta">&amp;base</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">Everyone</span> <span class="string">has</span> <span class="string">same</span> <span class="string">name</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The regexp &lt;&lt; is called Merge Key Language-Independent Type.</span></span><br><span class="line"><span class="comment"># 它表明指定映射的所有键值会插入到当前的映射中。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">foo:</span> <span class="meta">&amp;foo</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="meta">*base</span></span><br><span class="line"><span class="attr">  age:</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="attr">bar:</span> <span class="meta">&amp;bar</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="meta">*base</span></span><br><span class="line"><span class="attr">  age:</span> <span class="number">20</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># foo 和 bar 将都含有 name: Everyone has same name</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># YAML 还有标签，你可以用它显示地声明类型。</span></span><br><span class="line"><span class="attr">explicit_string:</span> <span class="type">!!str</span> <span class="number">0.5</span></span><br><span class="line"><span class="comment"># 一些解析器实现特定语言的标签，就像这个针对 Python 的复数类型。</span></span><br><span class="line"><span class="attr">python_complex_number:</span> <span class="type">!!python</span><span class="string">/complex</span> <span class="number">1</span><span class="string">+2j</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 我们也可以在 YAML 的复合键中使用特定语言的标签 </span></span><br><span class="line"><span class="string">?</span> <span class="type">!!python</span><span class="string">/tuple</span> <span class="string">[5,</span> <span class="number">7</span><span class="string">]</span></span><br><span class="line"><span class="string">:</span> <span class="string">Fifty</span> <span class="string">Seven</span></span><br><span class="line"><span class="comment"># 将会是 Python 中的  &#123;(5, 7):'Fifty Seven'&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">####################</span></span><br><span class="line"><span class="comment"># 其余的 YAML 类型 #</span></span><br><span class="line"><span class="comment">####################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 除了字符串和数字，YAML 还能理解其它标量。</span></span><br><span class="line"><span class="comment"># ISO 格式的日期和日期时间文本也可以被解析。</span></span><br><span class="line"><span class="attr">datetime:</span> <span class="number">2001</span><span class="bullet">-12</span><span class="bullet">-15</span><span class="attr">T02:59:43.1Z</span></span><br><span class="line"><span class="attr">datetime_with_spaces:</span> <span class="number">2001</span><span class="bullet">-12</span><span class="bullet">-14</span> <span class="number">21</span><span class="string">:59:43.10</span> <span class="bullet">-5</span></span><br><span class="line"><span class="attr">date:</span> <span class="number">2002</span><span class="bullet">-12</span><span class="bullet">-14</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这个 !!binary 标签表明这个字符串实际上 </span></span><br><span class="line"><span class="comment"># 是一个用 base64 编码表示的二进制 blob。</span></span><br><span class="line"><span class="attr">gif_file:</span> <span class="type">!!binary</span> <span class="string">|</span></span><br><span class="line"><span class="string">  R0lGODlhDAAMAIQAAP//9/X17unp5WZmZgAAAOfn515eXvPz7Y6OjuDg4J+fn5</span></span><br><span class="line"><span class="string">  OTk6enp56enmlpaWNjY6Ojo4SEhP/++f/++f/++f/++f/++f/++f/++f/++f/+</span></span><br><span class="line"><span class="string">  +f/++f/++f/++f/++f/++SH+Dk1hZGUgd2l0aCBHSU1QACwAAAAADAAMAAAFLC</span></span><br><span class="line"><span class="string">  AgjoEwnuNAFOhpEMTRiggcz4BNJHrv/zCFcLiwMWYNG84BwwEeECcgggoBADs=</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># YAML 还有一个集合类型，它看起来像这样：</span></span><br><span class="line"><span class="string"></span><span class="attr">set:</span></span><br><span class="line">  <span class="string">?</span> <span class="string">item1</span></span><br><span class="line">  <span class="string">?</span> <span class="string">item2</span></span><br><span class="line">  <span class="string">?</span> <span class="string">item3</span></span><br><span class="line"><span class="attr">or:</span> <span class="string">&#123;item1,</span> <span class="string">item2,</span> <span class="string">item3&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 集合只是值为 null 的映射；上面的集合等价于：</span></span><br><span class="line"><span class="attr">set2:</span></span><br><span class="line"><span class="attr">  item1:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">  item2:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">  item3:</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span>  <span class="comment"># document end</span></span><br></pre></td></tr></table></figure><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="http://yaml.org/" target="_blank" rel="noopener">YAML official website</a></p><p><a href="http://codebeautify.org/yaml-validator" target="_blank" rel="noopener">Online YAML Validator</a></p><p><a href="https://learnxinyminutes.com/docs/zh-cn/yaml-cn/" target="_blank" rel="noopener">X 分钟速成 Y</a></p><p><a href="https://www.runoob.com/w3cnote/yaml-intro.html" target="_blank" rel="noopener">YAML 入门教程</a></p>]]></content>
    
    <summary type="html">
    
      YAML入门教程
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>Jenkins export and import jobs 迁移导出导入任务实践小结</title>
    <link href="https://wsgzao.github.io/post/jenkins-import/"/>
    <id>https://wsgzao.github.io/post/jenkins-import/</id>
    <published>2020-01-06T06:59:49.000Z</published>
    <updated>2020-01-14T10:46:22.691Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我遇到的 Jenkins 迁移项目并非可以通过简单的物理文件复制就可以轻松解决，需要考虑上千个不同项目的 jobs 分离，Jenkins 1.x 和 2.x 大版本兼容性，Jenkins Plugins 插件，Jenkins Credentials 凭证，Jenkins Restrict 节点约束，按 view 分类不同项目的 jobs 等各种因素。这次对 Jenkins 迁移做了大量的研究和实践，希望总结出来的方法能对各位有帮助。</p><blockquote><p>Jenkins export and import jobs 迁移导出导入任务实践小结</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2020 年 01 月 06 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/jenkins-import/">https://wsgzao.github.io/post/jenkins-import/</a></p><p><strong> 扩展阅读 </strong></p><p><a href="https://plugins.jenkins.io/" target="_blank" rel="noopener">Jenkins Plugins Index</a></p><hr><h2 id="export-and-import-jobs-in-Jenkins"><a href="#export-and-import-jobs-in-Jenkins" class="headerlink" title="export and import jobs in Jenkins"></a>export and import jobs in Jenkins</h2><p>Is it possible to exchange jobs between 2 different Jenkins’? I’m searching for a way to export/import jobs.</p><h2 id="Solutions-Answers"><a href="#Solutions-Answers" class="headerlink" title="Solutions/Answers:"></a>Solutions/Answers:</h2><h3 id="Solution-1"><a href="#Solution-1" class="headerlink" title="Solution 1:"></a>Solution 1:</h3><p>Jenkins has a rather good wiki, albeit hard to read when you’re new to CI software…</p><p>They offer a simple solution for <a href="https://wiki.jenkins-ci.org/display/JENKINS/Administering+Jenkins#AdministeringJenkins-Moving%2Fcopying%2Frenamingjobs" target="_blank" rel="noopener">moving jobs between servers</a></p><p>The trick probably was the need to reload config from the Jenkins Configuration Page.</p><h3 id="Solution-2"><a href="#Solution-2" class="headerlink" title="Solution 2:"></a>Solution 2:</h3><p>Probably use jenkins command line is another option, see <a href="https://wiki.jenkins-ci.org/display/JENKINS/Jenkins+CLI" target="_blank" rel="noopener">https://wiki.jenkins-ci.org/display/JENKINS/Jenkins+CLI</a></p><ul><li>create-job: Creates a new job by reading stdin as a configuration XML file.</li><li>get-job: Dumps the job definition XML to stdout</li></ul><p>So you can do</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -jar jenkins-cli.jar -s http://server get-job myjob &gt; myjob.xml</span><br><span class="line">java -jar jenkins-cli.jar -s http://server create-job newmyjob &lt; myjob.xml</span><br></pre></td></tr></table></figure><p>It works fine for me and I am used to store in inside my version control system</p><h3 id="Solution-3"><a href="#Solution-3" class="headerlink" title="Solution 3:"></a>Solution 3:</h3><p>A one-liner:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s http://OLD_JENKINS/job/JOBNAME/config.xml | curl -X POST &apos;http://NEW_JENKINS/createItem?name=JOBNAME&apos; --header &quot;Content-Type: application/xml&quot; -d @-</span><br></pre></td></tr></table></figure><p>With authentication:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s http:///&lt;USER&gt;:&lt;API_TOKEN&gt;@OLD_JENKINS/job/JOBNAME/config.xml | curl -X POST &apos;http:///&lt;USER&gt;:&lt;API_TOKEN&gt;@NEW_JENKINS/createItem?name=JOBNAME&apos; --header &quot;Content-Type: application/xml&quot; -d @-</span><br></pre></td></tr></table></figure><p>With Crumb, if CSRF is active (<a href="https://stackoverflow.com/questions/38137760/jenkins-rest-api-create-job" target="_blank" rel="noopener">see details here</a>):</p><p>Get crumb with:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ CRUMB_OLD=$(curl -s &apos;http://&lt;USER&gt;:&lt;API_TOKEN&gt;@OLD_JENKINS/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,&quot;:&quot;,//crumb)&apos;)</span><br><span class="line">$ CRUMB_NEW=$(curl -s &apos;http://&lt;USER&gt;:&lt;API_TOKEN&gt;@NEW_JENKINS/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,&quot;:&quot;,//crumb)&apos;)</span><br></pre></td></tr></table></figure><p>Apply crumb with <code>-H CRUMB</code>:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s -H $CRUMB_OLD http:///&lt;USER&gt;:&lt;API_TOKEN&gt;@OLD_JENKINS/job/JOBNAME/config.xml | curl -X POST -H $CRUMB_NEW &apos;http:///&lt;USER&gt;:&lt;API_TOKEN&gt;@NEW_JENKINS/createItem?name=JOBNAME&apos; --header &quot;Content-Type: application/xml&quot; -d @-</span><br></pre></td></tr></table></figure><h3 id="Solution-4"><a href="#Solution-4" class="headerlink" title="Solution 4:"></a>Solution 4:</h3><p>There’s a plugin called <a href="https://wiki.jenkins-ci.org/display/JENKINS/Job+Import+Plugin" target="_blank" rel="noopener">Job Import Plugin</a> that may be what you are looking for. I have used it. It does have issues with importing projects from a server that doesn’t allow anonymous access.</p><p>For Completeness:<br>If you have command line access to both, you can do the procedure already mentioned by Khez for <a href="https://wiki.jenkins-ci.org/display/JENKINS/Administering+Jenkins#AdministeringJenkins-Moving/copying/renamingjobs" target="_blank" rel="noopener">Moving, Copying and Renaming Jenkins Jobs</a>.</p><h3 id="Solution-5"><a href="#Solution-5" class="headerlink" title="Solution 5:"></a>Solution 5:</h3><p>Go to your Jenkins server’s front page, click on REST API at the bottom of the page:</p><blockquote><p>Create Job</p></blockquote><p>To create a new job, post <code>config.xml</code> to this URL with query parameter <code>name=JOBNAME</code>. You need to send a <code>Content-Type: application/xml</code> header. You’ll get <code>200</code> status code if the creation is successful, or <code>4xx/5xx</code> code if it fails. <code>config.xml</code> is the format Jenkins uses to store the project in the file system, so you can see examples of them in the Jenkins home directory, or by retrieving the XML configuration of existing jobs from <code>/job/JOBNAME/config.xml</code>.</p><h3 id="Solution-6"><a href="#Solution-6" class="headerlink" title="Solution 6:"></a>Solution 6:</h3><p>In my Jenkins instance (version 1.548) the configuration file is at:</p><p><code>/var/lib/jenkins/jobs/-the-project-name-/config.xml</code></p><p>Owned by jenkins user and jenkins group with 644 permissions. Copying the file to and from here should work. I haven’t tried changing it directly but have backed-up the config from this spot in case the project needs to be setup again.</p><h3 id="Solution-7"><a href="#Solution-7" class="headerlink" title="Solution 7:"></a>Solution 7:</h3><p><strong><a href="https://wiki.jenkins.io/display/JENKINS/Job+Import+Plugin" target="_blank" rel="noopener">Job Import plugin</a></strong> is the easy way here to import jobs from another Jenkins instance. Just need to provide the URL of the source Jenkins instance. The Remote Jenkins URL can take any of the following types of URLs:</p><ul><li><p><code>http://$JENKINS</code> – get all jobs on remote instance</p></li><li><p><code>http://$JENKINS/job/$JOBNAME</code> – get a single job</p></li><li><p><code>http://$JENKINS/view/$VIEWNAME</code> – get all jobs in a particular view</p></li></ul><h3 id="Solution-8"><a href="#Solution-8" class="headerlink" title="Solution 8:"></a>Solution 8:</h3><p>Thanks to Larry Cai’s answer I managed to create a script to backup all my Jenkins jobs. I created a job that runs this every week. In case someone finds it useful, here it is:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#IFS for jobs with spaces.</span><br><span class="line">SAVEIFS=$IFS</span><br><span class="line">IFS=$(echo -en &quot;\n\b&quot;)</span><br><span class="line">for i in $(java -jar /run/jenkins/war/WEB-INF/jenkins-cli.jar -s http://server:8080/ list-jobs);</span><br><span class="line">do</span><br><span class="line">  java -jar /run/jenkins/war/WEB-INF/jenkins-cli.jar -s http://server:8080/ get-job $&#123;i&#125; &gt; $&#123;i&#125;.xml;</span><br><span class="line">done</span><br><span class="line">IFS=$SAVEIFS</span><br><span class="line">mkdir deploy</span><br><span class="line">tar cvfj &quot;jenkins-jobs.tar.bz2&quot; ./*.xml</span><br></pre></td></tr></table></figure><h3 id="Solution-9"><a href="#Solution-9" class="headerlink" title="Solution 9:"></a>Solution 9:</h3><p>Jenkins export jobs to a directory</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#! /bin/bash</span><br><span class="line">   SAVEIFS=$IFS</span><br><span class="line">   IFS=$(echo -en &quot;\n\b&quot;)</span><br><span class="line">   declare -i j=0</span><br><span class="line">   for i in $(java -jar jenkins-cli.jar -s http://server:8080/jenkins list-jobs  --username **** --password ***);</span><br><span class="line">   do</span><br><span class="line">   let &quot;j++&quot;;</span><br><span class="line">   echo $j;</span><br><span class="line">   if [ $j -gt 283 ] // If you have more jobs do it in chunks as it will terminate in the middle of the process. So Resume your job from where it ends.</span><br><span class="line">    then</span><br><span class="line">   java -jar jenkins-cli.jar -s http://lxvbmcbma:8080/jenkins get-job --username **** --password **** $&#123;i&#125; &gt; $&#123;i&#125;.xml;</span><br><span class="line">   echo &quot;done&quot;;</span><br><span class="line">   fi</span><br><span class="line">   done</span><br></pre></td></tr></table></figure><p>Import jobs</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for f in *.xml;</span><br><span class="line">do</span><br><span class="line">echo &quot;Processing $&#123;f%.*&#125; file..&quot;; //truncate the .xml extention and load the xml file for job creation</span><br><span class="line">java -jar jenkins-cli.jar -s http://server:8080/jenkins create-job $&#123;f%.*&#125;  &lt; $f</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="Solution-10"><a href="#Solution-10" class="headerlink" title="Solution 10:"></a>Solution 10:</h3><p>Simple php script worked for me.</p><p><strong>Export:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// add all job codes in the array</span><br><span class="line">$jobs = array(&quot;job1&quot;, &quot;job2&quot;, &quot;job3&quot;);</span><br><span class="line"></span><br><span class="line">foreach ($jobs as $value)</span><br><span class="line">&#123;</span><br><span class="line">    fwrite(STDOUT, $value. &quot; \n&quot;) or die(&quot;Unable to open file!&quot;);</span><br><span class="line">    $path = &quot;http://server1:8080/jenkins/job/&quot;.$value.&quot;/config.xml&quot;;</span><br><span class="line">    $myfile = fopen($value.&quot;.xml&quot;, &quot;w&quot;);</span><br><span class="line">    fwrite($myfile, file_get_contents($path));</span><br><span class="line">    fclose($myfile);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Import:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">// add all job codes in the array</span><br><span class="line">$jobs = array(&quot;job1&quot;, &quot;job2&quot;, &quot;job3&quot;);</span><br><span class="line"></span><br><span class="line">foreach ($arr as $value)</span><br><span class="line">&#123;</span><br><span class="line">    fwrite(STDOUT, $value. &quot; \n&quot;) or die(&quot;Unable to open file!&quot;);</span><br><span class="line">    $cmd = &quot;java -jar jenkins-cli.jar -s http://server2:8080/jenkins/ create-job &quot;.$value.&quot; &lt; &quot;.$value.&quot;.xml&quot;;</span><br><span class="line">    echo exec($cmd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Solution-11"><a href="#Solution-11" class="headerlink" title="Solution 11:"></a>Solution 11:</h3><p>This does not work for existing jobs, however there is <a href="http://docs.openstack.org/infra/jenkins-job-builder/" target="_blank" rel="noopener">Jenkins job builder</a>.</p><p>This allows one to keep job definitions in yaml files and in a git repo which is very portable.</p><h3 id="Solution-12"><a href="#Solution-12" class="headerlink" title="Solution 12:"></a>Solution 12:</h3><p>For those of us in the Windows world who may or may not have Bash available, here’s my PowerShell port of <strong>Katu</strong> and <strong>Larry Cai</strong>‘s approach. Hope it helps someone.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">##### Config vars #####</span><br><span class="line">$serverUri = &apos;http://localhost:8080/&apos; # URI of your Jenkins server</span><br><span class="line">$jenkinsCli = &apos;C:\Program Files (x86)\Jenkins\war\WEB-INF\jenkins-cli.jar&apos; # Path to jenkins-cli.jar on your machine</span><br><span class="line">$destFolder = &apos;C:\Jenkins Backup\&apos; # Output folder (will be created if it doesn&apos;t exist)</span><br><span class="line">$destFile = &apos;jenkins-jobs.zip&apos; # Output filename (will be overwritten if it exists)</span><br><span class="line">########################</span><br><span class="line"></span><br><span class="line">$work = Join-Path ([System.IO.Path]::GetTempPath()) ([System.IO.Path]::GetRandomFileName())</span><br><span class="line">New-Item -ItemType Directory -Force -Path $work | Out-Null # Suppress output noise</span><br><span class="line">echo &quot;Created a temp working folder: $work&quot;</span><br><span class="line"></span><br><span class="line">$jobs = (java -jar $jenkinsCli -s $serverUri list-jobs)</span><br><span class="line">echo &quot;Found $($jobs.Length) existing jobs: [$jobs]&quot;</span><br><span class="line"></span><br><span class="line">foreach ($j in $jobs)</span><br><span class="line">&#123;</span><br><span class="line">    $outfile = Join-Path $work &quot;$j.xml&quot;</span><br><span class="line">    java -jar $jenkinsCli -s $serverUri get-job $j | Out-File $outfile</span><br><span class="line">&#125;</span><br><span class="line">echo &quot;Saved $($jobs.Length) jobs to temp XML files&quot;</span><br><span class="line"></span><br><span class="line">New-Item -ItemType Directory -Force -Path $destFolder | Out-Null # Suppress output noise</span><br><span class="line">echo &quot;Found (or created) $destFolder folder&quot;</span><br><span class="line"></span><br><span class="line">$destPath = Join-Path $destFolder $destFile</span><br><span class="line">Get-ChildItem $work -Filter *.xml |</span><br><span class="line">    Write-Zip -Level 9 -OutputPath $destPath -FlattenPaths |</span><br><span class="line">    Out-Null # Suppress output noise</span><br><span class="line">echo &quot;Copied $($jobs.Length) jobs to $destPath&quot;</span><br><span class="line"></span><br><span class="line">Remove-Item $work -Recurse -Force</span><br><span class="line">echo &quot;Removed temp working folder&quot;</span><br></pre></td></tr></table></figure><h3 id="Solution-13"><a href="#Solution-13" class="headerlink" title="Solution 13:"></a>Solution 13:</h3><p>It is very easy just download plugin name</p><p><a href="https://wiki.jenkins.io/display/JENKINS/Job+Import+Plugin" target="_blank" rel="noopener">Job Import Plugin</a></p><p>Enter the URL of your Remote Jenkins server and it will import the jobs automatically</p><h3 id="Solution-14"><a href="#Solution-14" class="headerlink" title="Solution 14:"></a>Solution 14:</h3><p>The most easy way, with direct access to the machine is to copy the job folder from first jenkins to another one (you can exclude workspaces – <code>workspace</code> folder), because the whole job configuration is stored in the xml file on the disk.</p><p>Then in the new jenkins just <code>reload configuration</code> in the global settings (admin access is required) should be enough, if not, then you will need to restart Jenkins tool.</p><p>Another way can be to use plugins mentioned above this post.</p><p>edit:<br>– in case you can probably also exclude <code>modules</code> folders</p><h2 id="Jenkins-迁移方案小结"><a href="#Jenkins-迁移方案小结" class="headerlink" title="Jenkins 迁移方案小结"></a>Jenkins 迁移方案小结</h2><blockquote><p>上面列举有 14 种方法居多，但大多数是基于方案 4 进行扩展</p></blockquote><p>上面列举的方案基本已经非常全了，感觉是不是有点眼花？其实归纳总结主要有以下 4 种</p><ol><li>官方的 Moving/copying/renaming jobs，即所谓的物理文件迁移，如果情况复杂此方案不推荐</li><li>基于 Jenkins CLI，该方案需要依赖 jenkins-cli.jar 包括 java 使用范围具有一定局限性，不推荐</li><li>基于类似 Job Import Plugin 插件形式，该类方案普适性较差，不推荐</li><li>基于 Jenkins REST API，核心是获取 <code>&lt;jenkinshost&gt;/job/&lt;jobname&gt;/config.xml</code>，效果最佳</li></ol><h3 id="REST-API"><a href="#REST-API" class="headerlink" title="REST API"></a>REST API</h3><p>Many objects of Jenkins provide the remote access API. They are available at /…/api/ where “…” portion is the object for which you’d like to access.</p><blockquote><p>XML API</p></blockquote><p>Access data exposed in HTML as XML for machine consumption. Schema is also available.<br>You can also specify optional XPath to control the fragment you’d like to obtain (but see below). For example, ../api/xml?xpath=/<em>/</em>[0].</p><p>For XPath that matches multiple nodes, you need to also specify the “wrapper” query parameter to specify the name of the root XML element to be create so that the resulting XML becomes well-formed.</p><p>Similarly exclude query parameter can be used to exclude nodes that match the given XPath from the result. This is useful for trimming down the amount of data you fetch (but again see below). This query parameter can be specified multiple times.</p><p>XPath filtering is powerful, and you can have it only return a very small data, but note that the server still has to build a full DOM of the raw data, which could cause a large memory spike. To avoid overloading the server, consider using the tree parameter, or use the xpath parameter in conjunction with the tree parameter. When used together, the result of the tree parameter filtering is built into DOM, then the XPath is applied to compute the final return value. In this way, you can often substantially reduce the size of DOM built in memory.</p><blockquote><p>JSON API</p></blockquote><p>Access the same data as JSON for JavaScript-based access. tree may be used.</p><blockquote><p>Python API</p></blockquote><p>Access the same data as Python for Python clients. This can be parsed into Python object as eval(urllib.urlopen(“…”).read()) and the resulting object tree is identical to that of JSON. However, when you do this, beware of the security implication. If you are connecting to a non-trusted Jenkins, the server can send you malicious Python programs.</p><p>In Python 2.6 or later you can safely parse this output using ast.literal_eval(urllib.urlopen(“…”).read())</p><p>For more information about remote API in Jenkins, see the documentation.</p><p><a href="https://jenkins.io/redirect/remote-api" target="_blank" rel="noopener">https://jenkins.io/redirect/remote-api</a></p><h3 id="使用-cURL-和-Jenkins-REST-API"><a href="#使用-cURL-和-Jenkins-REST-API" class="headerlink" title="使用 cURL 和 Jenkins REST API"></a>使用 cURL 和 Jenkins REST API</h3><blockquote><p>使用 Jenkins REST API 建议关闭 CSRF 防护</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># To retrieve the job config.xml</span></span><br><span class="line">curl -X GET <span class="string">'&lt;jenkinshost&gt;/job/&lt;jobname&gt;/config.xml'</span> -u username:API_TOKEN -o &lt;jobname&gt;.xml</span><br><span class="line"></span><br><span class="line"><span class="comment"># to use this config to create a new job</span></span><br><span class="line">curl -s -XPOST <span class="string">'&lt;jenkinshost&gt;/createItem?name=&lt;jobname&gt;'</span> -u username:API_TOKEN --data-binary @&lt;jobname&gt;.xml -H <span class="string">"Content-Type:text/xml"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get all jenkins jobs</span></span><br><span class="line">curl -X GET <span class="string">'&lt;jenkinshost&gt;/api/json?pretty=true'</span> -u username:API_TOKEN -o jobs.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># get jenkins view</span></span><br><span class="line">curl -X GET <span class="string">'&lt;jenkinshost&gt;/view/&lt;viewname&gt;/api/json'</span> -u username:API_TOKEN -o view.json</span><br></pre></td></tr></table></figure><p>Obviously, replace:</p><ul><li>username API_TOKEN with your username and password/API_Token</li><li>jenkinshost with your Jenkins URL</li><li>jobname with the name of the job that you created via the UI</li></ul><p><a href="https://json-csv.com/" target="_blank" rel="noopener">JSON to CSV Converter</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">mkdir config_xml</span><br><span class="line">vim jobs.txt</span><br><span class="line">vim jenkins_jobs_migration.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#/bin/bash</span></span><br><span class="line">source_jenkins_host=<span class="string">"xxx"</span></span><br><span class="line">source_jenkins_username=<span class="string">"xxx"</span></span><br><span class="line">source_jenkins_password=<span class="string">"xxx"</span></span><br><span class="line"></span><br><span class="line">target_jenkins_host=<span class="string">"xxx"</span></span><br><span class="line">target_jenkins_username=<span class="string">"xxx"</span></span><br><span class="line">target_jenkins_password=<span class="string">"xxx"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">pull</span></span>() &#123;</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> `cat jobs.txt`</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$&#123;line&#125;</span></span><br><span class="line">        curl -X GET <span class="variable">$&#123;source_jenkins_host&#125;</span>job/<span class="variable">$&#123;line&#125;</span>/config.xml -u <span class="variable">$&#123;source_jenkins_username&#125;</span>:<span class="variable">$&#123;source_jenkins_password&#125;</span> -o config_xml/<span class="variable">$&#123;line&#125;</span>.xml</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">push</span></span>() &#123;</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> `cat jobs.txt`</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$line</span></span><br><span class="line">        httprc=$(curl -s -XPOST <span class="variable">$&#123;target_jenkins_host&#125;</span>job/<span class="variable">$&#123;line&#125;</span>/doDelete -u <span class="variable">$&#123;target_jenkins_username&#125;</span>:<span class="variable">$&#123;target_jenkins_password&#125;</span>)</span><br><span class="line">        curl -s -XPOST <span class="variable">$&#123;target_jenkins_host&#125;</span>createItem?name=<span class="variable">$&#123;line&#125;</span> -u <span class="variable">$&#123;target_jenkins_username&#125;</span>:<span class="variable">$&#123;target_jenkins_password&#125;</span> --data-binary @config_xml/<span class="variable">$&#123;line&#125;</span>.xml -H <span class="string">"Content-Type:text/xml"</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">    push)</span><br><span class="line">        push</span><br><span class="line">        ;;</span><br><span class="line">    pull)</span><br><span class="line">        pull</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Usage: <span class="variable">$NAME</span> &#123;pull|push&#125;"</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">        ;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure><h3 id="使用-python-编写-api-jenkins-py-核心逻辑"><a href="#使用-python-编写-api-jenkins-py-核心逻辑" class="headerlink" title="使用 python 编写 api_jenkins.py 核心逻辑"></a>使用 python 编写 api_jenkins.py 核心逻辑</h3><blockquote><p>暂不方便公开</p></blockquote><ol><li>支持读取 context.json 配置文件使用 pipeline.j2 模板自动生成不同类型的 pipeline.xml 导入文件</li><li>支持按 view 或者 job export 导出 job config.xml 配置信息</li><li>支持按 view 或者 job import 导入 job config.xml 配置信息</li></ol><h2 id="Jenkins-Plugin"><a href="#Jenkins-Plugin" class="headerlink" title="Jenkins Plugin"></a>Jenkins Plugin</h2><p>迁移插件可以通过上传 <code>.hpi</code> 一次性搞定，当然你也可用使用 REST API 或者 jenkins-cli</p><p><a href="https://jenkins.io/doc/book/managing/plugins/" target="_blank" rel="noopener">Managing Plugins</a></p><h2 id="Jenkins-Backup"><a href="#Jenkins-Backup" class="headerlink" title="Jenkins Backup"></a>Jenkins Backup</h2><blockquote><p>archive jenkins setting and plugins</p></blockquote><p>大家应该都知道 Jenkins 备份插件目前主要就 2 种选择:</p><ul><li><a href="https://plugins.jenkins.io/backup" target="_blank" rel="noopener">Backup</a></li><li><a href="https://plugins.jenkins.io/periodicbackup" target="_blank" rel="noopener">Periodic Backup</a></li></ul><p>严格意义上来说应该只能选择 Periodic Backup，但是如果是需要定期备份自然离不开编写 Bash 脚本</p><p><a href="https://github.com/sue445/jenkins-backup-script" target="_blank" rel="noopener">jenkins-backup-script</a></p><h2 id="Jenkins-API-Token"><a href="#Jenkins-API-Token" class="headerlink" title="Jenkins API Token"></a>Jenkins API Token</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hudson.model.*</span><br><span class="line"><span class="keyword">import</span> jenkins.model.*</span><br><span class="line"><span class="keyword">import</span> jenkins.security.*</span><br><span class="line"><span class="keyword">import</span> jenkins.security.apitoken.*</span><br><span class="line"></span><br><span class="line"><span class="comment">// you can change the "admin" name</span></span><br><span class="line"><span class="comment">// the false is to explicitely ask to not create a user who does not exist yet</span></span><br><span class="line"><span class="keyword">def</span> user = User.get(<span class="string">"gop.bot@garena.com"</span>, <span class="literal">false</span>)</span><br><span class="line"><span class="keyword">def</span> prop = user.getProperty(ApiTokenProperty.<span class="keyword">class</span>)</span><br><span class="line"><span class="comment">// the name is up to you</span></span><br><span class="line"><span class="keyword">def</span> result = prop.tokenStore.generateNewToken(<span class="string">"token-created-by-script"</span>)</span><br><span class="line">user.save()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> result.plainValue</span><br></pre></td></tr></table></figure><p><a href="https://issues.jenkins-ci.org/browse/JENKINS-52339" target="_blank" rel="noopener">New API Token system should allow tokens to be created for service accounts</a></p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://config9.com/apps/jenkins/export-import-jobs-in-jenkins/" target="_blank" rel="noopener">Export/import jobs in Jenkins</a></p><p><a href="https://wiki.jenkins.io/display/JENKINS/Administering+Jenkins#AdministeringJenkins-Moving%2Fcopying%2Frenamingjobs" target="_blank" rel="noopener">Moving/copying/renaming jobs</a></p><p><a href="https://wiki.jenkins.io/display/JENKINS/Jenkins+CLI" target="_blank" rel="noopener">Jenkins CLI</a></p><p><a href="https://support.cloudbees.com/hc/en-us/articles/220857567-How-to-create-a-job-using-the-REST-API-and-cURL-" target="_blank" rel="noopener">How to create a job using the REST API and cURL?</a></p><p><a href="https://wiki.jenkins-ci.org/display/JENKINS/Remote+access+API" target="_blank" rel="noopener">Jenkins Remote access API</a></p>]]></content>
    
    <summary type="html">
    
      Jenkins export and import jobs 迁移导出导入任务实践小结
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>从国内跳槽至新加坡工作的经验分享</title>
    <link href="https://wsgzao.github.io/post/singapore/"/>
    <id>https://wsgzao.github.io/post/singapore/</id>
    <published>2019-12-31T02:59:49.000Z</published>
    <updated>2020-01-09T03:21:31.734Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191007154135.png" alt=""></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>为什么会写这样一篇长文记录和分享自己在新加坡的工作生活，主要是我在 2018 年 6 月 9 日前需要了解新加坡的时候网上的参考信息屈指可数，出于这个原因我决定顺手记录来新加坡的经历方便自己回顾也方便他人参考。非常感谢在 2019 年出现的<a href="https://996.icu" target="_blank" rel="noopener">996.icu</a>，让更多人看到了一个不一样的世界，里面也有很多朋友分享了新加坡的生活经历。不管你现在的生活是 996 还是 669，我都希望大家可以从电视剧《都挺好》里发现那个最真实的自己。如果你只想了解我是如何来到新加坡的可以直接跳到最后一章。</p><blockquote><p>为帮助大家玩转新加坡，快速适应当地生活</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 12 月 31 日 - 增加新加坡保险购买经历的思考和新加坡 2020 年各行业工资数据<br>2019 年 10 月 16 日 - 更新 EP 申请 PR 材料细节，增加新加坡婚礼红包份子钱的礼仪<br>2019 年 06 月 09 日 - 更新新加坡一周年经历<br>2019 年 02 月 14 日 - 更新半年的经历以及 PR 申请流程<br>2018 年 09 月 09 日 - 增加新加坡 3 个月工作生活感受<br>2018 年 08 月 01 日 - 更新个人经验<br>2018 年 05 月 15 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/singapore/">https://wsgzao.github.io/post/singapore/</a></p><p><strong> 扩展阅读 </strong></p><p>逃离 996 - <a href="https://github.com/623637646/996.Leave" target="_blank" rel="noopener">https://github.com/623637646/996.Leave</a></p><hr><h2 id="认识狮城"><a href="#认识狮城" class="headerlink" title="认识狮城"></a>认识狮城</h2><p>姓名：新加坡</p><p>年龄：53 岁（成立于 1965 年，国庆日为每年的 8 月 9 日）</p><p>家庭住址：北半球赤道地区，位于马来半岛最南端 （北纬 1°22′，东经 103°48′）</p><p>住房面积：新加坡国土面积 710.3 平方公里 （新加坡面积是上海的 1/9，北京的 1/23）</p><p>家庭成员：人口约 520 万，密度达到每平方公里 7700 多人（排在世界前列）</p><p>相貌特征：新加坡多元种族和文化的相互融合是其极具魅力的原因之一，由华族（占全国人口约四分之三）、欧亚族、印度族、马来族、土生华人构成。</p><p>性格特征：新加坡以实行严格的法律和制度著称，无论是居民还是游客，都需要予以足够重视，否则可能会被课以重罚。当然，如果您遵循当地法律规章，也不必过分担心。</p><blockquote><p>所获荣誉：或许这些荣誉只属于过去，我们更需要关心的是现在和未来会怎样</p></blockquote><p>让人最想移民的国家全球排名第一<br>全球最具竞争力国家排名第一<br>最适应亚洲人士居住的地方全球排名第一<br>城市基础设施建设全球排名第一<br>全球化程度最高的城市排名第一</p><p>其他方面：<a href="http://www.visitsingapore.com.cn/travel-guide-tips/about-singapore/" target="_blank" rel="noopener">http://www.visitsingapore.com.cn/travel-guide-tips/about-singapore/</a></p><h2 id="旅游出入境"><a href="#旅游出入境" class="headerlink" title="旅游出入境"></a>旅游出入境</h2><blockquote><p>新加坡 5 件套</p></blockquote><ul><li>打疫苗</li><li>打 HPV</li><li>开账户</li><li>买保险</li><li>看学校</li></ul><blockquote><p>签证</p></blockquote><p>中国公民去新加坡须提前申请有效签证，不可以落地签。</p><p>中国公民申请的新加坡旅游 / 商务签证为电子签证（e-Visa），在获得签证后，建议上网打印多份有效签证以防遗失。签证费为每人 SG$30。</p><p>新加坡签证可多次入境，有效期分别有 35 天 / 62 天 / 2 年，由签证官根据申请人资料而定。逗留时间则由入境官决定，通常为 14-30 天。从 2015 年 6 月 1 日起新加坡将给予符合条件的中国公民有效期长达 10 年的多次入境签证。</p><p><a href="http://www.visitsingapore.com.cn/travel-guide-tips/travelling-to-singapore/" target="_blank" rel="noopener">http://www.visitsingapore.com.cn/travel-guide-tips/travelling-to-singapore/</a></p><blockquote><p>申请途径 How to Apply</p></blockquote><p>2014 年 12 月 8 日起大使馆及各领事馆停止接收签证申请，可登录新加坡外交部官网，查询中国国内官方指定的签证机构，办理新加坡签证。</p><blockquote><p>所需资料 Required Information</p></blockquote><ol><li>个人信息表（登录新加坡外交部官网下载表格，链接：<a href="http://www.mfa.gov.sg）" target="_blank" rel="noopener">www.mfa.gov.sg）</a></li><li>户口本（原件或扫描电子版，户主 + 个人页复印件）</li><li>身份证（原件或正反面扫描电子版，正反面复印件）</li><li>护照（原件或个人页扫描电子版，个人页复印件，有效期 6 个月以上）</li><li>2 张 2 寸白底免冠照片</li><li>在职证明原件或相关职业证书</li></ol><blockquote><p>出入境</p></blockquote><p>从 2018 年 10 月 4 日起，新加坡纸质入境卡（人称 “白卡”）即将走入历史！取而代之的是电子化入境卡。</p><p>访客可通过移民关卡局官方网站 <a href="https://www.ica.gov.sg/" target="_blank" rel="noopener">https://www.ica.gov.sg/</a> 或下载手机应用程序填写资料。通过手机填写资料还有自动储存功能，以方便下一次入境时使用。而与家人或小组团体同游新加坡的人，能够以团体方式提交入境资料。</p><p>离境前别忘了退税，在附有 “退税” 标志的场所消费满 100 新币以上，即可退回 7% 的商品及服务税，退税时需出示购物发票或收据。具体的退税要求，可咨询工作人员。</p><blockquote><p>其它注意事项</p></blockquote><p>电源插座：新加坡使用的标准电流是 220-240 伏特交流电（50 赫兹），在这里，您可以使用三眼电源插座。</p><p><a href="http://www.visitsingapore.com.cn/travel-guide-tips/" target="_blank" rel="noopener">http://www.visitsingapore.com.cn/travel-guide-tips/</a></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190802161219.png" alt=""></p><h2 id="新加坡工作准证"><a href="#新加坡工作准证" class="headerlink" title="新加坡工作准证"></a>新加坡工作准证</h2><blockquote><p>关于工作准证的最新信息请以新加坡人力部 (MOM) 发布的为准</p></blockquote><p><a href="https://www.mom.gov.sg/" target="_blank" rel="noopener">https://www.mom.gov.sg/</a></p><p>在新加坡工作，新加坡人力部 Ministry Of Manpower (MOM) 是最常打交道的政府部门，工作准证不仅是由人力部批准和颁发所有文件提交最终也是到达人力部</p><p>注意：所有提交给 MOM 的资料原件，都需要在入境的时候随身携带。以便在去人力部办卡的时候，让长官核实和查阅。</p><ol><li>新版卡片上将不再印刷准证的到期日期，新版卡片会印上二维码（QR Code），下载 SGWorkPass 的手机 APP 后，可以扫码查看持卡人的职务、证件是否有效等信息</li><li>如果过海关或签合约等需要核对卡片截止日期时，不再可以只看卡面信息，还需要扫码或在线上核对截止日期等，建议保存 SGWorkPass 截图至手机中以防万一</li></ol><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190802161307.png" alt=""></p><p><a href="https://docs.qq.com/sheet/DeVh5ZEhKWnhCTldK" target="_blank" rel="noopener">如果发现表有错误请点击链接申请编辑更新，谢谢</a></p><h3 id="Work-Permit-WP"><a href="#Work-Permit-WP" class="headerlink" title="Work Permit (WP)"></a>Work Permit (WP)</h3><p>WP 是人力部设置的给外国低水准员工提供的工作准证。</p><p>对申请者的要求：薪水和学历：无要求<br>年龄：马来西亚人（18-58 周岁），非马来西亚人（18-50 周岁）；<br>对公司的要求：需要为其购买保额至少 15000 新币的保险；缴纳 5000 新币担保金<br>注意事项：<br>公司需要先为雇员申请好 WP 并办理保险，才可以持 WP 准证进入新加坡。在申请的状态中，本人不可以进入新加坡。</p><h3 id="S-PASS-SP"><a href="#S-PASS-SP" class="headerlink" title="S PASS (SP)"></a>S PASS (SP)</h3><p>SP 是人力部设置的给外国中级技术水准雇员提供的工作准证。</p><p>对申请者的要求：学历：大专，本科，或者技术资质认证（需要至少一年全职学习获得的技术认证）；<br>工作年限：虽然没有明文规定最少需要多少年的工作经验，但工作经验会作为一个审核标准；<br>对公司的要求：所付起薪 2200 新币；</p><p>注意事项：<br>也有公司人头配额限制：服务行业 SP 人数不可超过总员工的 15%，其它行业是 20%。<br>你在申请之前需要确保学历在 Dataflow，学信网及中国学位与研究生教育信息网上可以查到。另外，针对不同的行业，也有可能需要提交相关的专业证明。</p><h3 id="Employment-Pass（EP）"><a href="#Employment-Pass（EP）" class="headerlink" title="Employment Pass（EP）"></a>Employment Pass（EP）</h3><p>EP 是人力部设置的给外国专业人员（管理层，主管或专业职位）提供的工作准证. 是工作准证中级别最高的。</p><p>对申请者的要求：<br>年轻的申请者需拥有优秀院校的毕业证书，且达到 3600 的雇佣薪水以及拥有相关专业经验才可以申请。<br>至于年长的申请人，则必须拥有更高的薪水以及相应工作经验和工作质量。</p><p>对雇主的要求：<br>所付起薪 3600 新币</p><p>注意事项：<br>和申请 SP 一样，在申请之前需要确保学历在 Dataflow，学信网及中国学位与研究生教育信息网上可以查到。另外，针对不同的行业，也有可能需要提交相关的专业证明。<br>根据对应的准证类型，提交人力部 (MOM) 所要求的材料</p><ul><li>有效的护照信息</li><li>必要的技能证书</li><li>有效的毕业证</li></ul><p>2018 年 1 月 1 日起两件重要变化</p><ul><li>EP 准证持有人月薪至少 6000 新币以上可以给配偶和孩子申请相关准证(DP)</li><li>EP 准证持有人月薪至少 12000 新币以上可以申请父母长期探访准证（LTVP)</li></ul><h2 id="家庭成员准证"><a href="#家庭成员准证" class="headerlink" title="家庭成员准证"></a>家庭成员准证</h2><h3 id="Dependant‘s-Pass-家属准证（DP）"><a href="#Dependant‘s-Pass-家属准证（DP）" class="headerlink" title="Dependant‘s Pass 家属准证（DP）"></a>Dependant‘s Pass 家属准证（DP）</h3><p>家属准证，在新加坡工作或经商，并持有 EP SP 或 Enptrpass 的人士，可为自己的配偶及 21 岁以下小孩申请的一种准证。持家属准证的小孩，可直接入学新加坡政府中小学。</p><p>薪水：担保人固定月薪薪水需达到 5,000 新币以上。（2018 年 1 月 1 日起至少达到 6000 新币以上）。</p><p>工作：EP 或创业准证家属，可通过公司向人力部申请新加坡工作的凭证 LOC（Letter of consent），批准后，可直接工作（不占用公司配额）。SP 家属准证，需申请工作准证后才能工作。家属准证（DP）持有人申请到工作准证（EP 或 SP）后需取消 DP，SP 家属取得的工作准证有效期与 SP 持有人准证有效期相关。</p><h3 id="Long-Term-Visit-Pass-长期探访准证（LTVP）"><a href="#Long-Term-Visit-Pass-长期探访准证（LTVP）" class="headerlink" title="Long Term Visit Pass 长期探访准证（LTVP）"></a>Long Term Visit Pass 长期探访准证（LTVP）</h3><p>长期探访准证，是新加坡政府颁发的一种可以在新加坡长期居住的准证，期限从半年到十年不等。其中新加坡公民的配偶又可以申请获得 LTVP+。目前的审批部门有两个，一个是 ICA 移民厅，一个是 MOM 人力部。</p><p>需要去移民厅申请的：</p><ol><li>新加坡公民的配偶<br>2.PR 的配偶</li><li>新加坡公民 / PR 未满 21 周岁的小孩</li><li>新加坡公民 / 21 周岁以上 PR 的父母</li><li>寻求在新加坡工作的有关高校毕业生</li><li>小孩 / 孙辈在新加坡持学生准证读书的母亲或外祖母</li><li>寻求准许在新加坡分娩者</li></ol><p>新加坡移民局网址<br><a href="https://www.ica.gov.sg/" target="_blank" rel="noopener">https://www.ica.gov.sg/</a></p><p>需要去人力部申请的：</p><ol><li>EP/SP 准证持有者的配偶（2018 年 1 月 1 日起至少 6000 新币）</li><li>EP/SP 准证持有者未满 21 周岁的未婚残疾子女（2018 年 1 月 1 日起至少 6000 新币）</li><li>EP/SP 准证持有者未满 21 周岁的未婚继子女（2018 年 1 月 1 日起至少 6000 新币）</li><li>EP/SP 准证持有者的父母（2018 年 1 月 1 日起至少 12000 新币）</li><li>Entrepass（创业准证）的父母</li></ol><p>新加坡人力部网址：<br><a href="https://www.mom.gov.sg/" target="_blank" rel="noopener">https://www.mom.gov.sg/</a></p><h2 id="新加坡通讯指南"><a href="#新加坡通讯指南" class="headerlink" title="新加坡通讯指南"></a>新加坡通讯指南</h2><p>国内的手机大部分都可以在新加坡直接换卡使用，除非你的手机是中国移动 4G 定制版本，由于网络制式的区别，无法使用新加坡 4G 网络，新加坡目前 2G 网络停止服务。</p><blockquote><p>小贴士：建议使用全网通手机，去国外任何地方都可以直接换卡使用。</p></blockquote><p>运营商：新电信（Singtel）、星河（Starhub）和 M1（Mobile One）</p><p>在新加坡机场、邮局、7-11 便利店和代理商都可以购买和充值电话卡，记得一定要带上护照，新加坡的手机卡采用实名制。推荐大家下载所用运营商的 App，查询和购买话费、流量等。</p><blockquote><p>Zero1: Get Ready For Unlimited Data | Plans</p></blockquote><p>我自己办理的是 Zero1 的 9.9 新币 / 月无限流量套餐</p><p>详情请参考官网：<a href="https://zero1.sg/" target="_blank" rel="noopener">https://zero1.sg/</a></p><h2 id="新加坡交通指南"><a href="#新加坡交通指南" class="headerlink" title="新加坡交通指南"></a>新加坡交通指南</h2><p>新加坡主要交通出行方式：地铁（MRT）、轻轨（LRT）、巴士（Bus）和德士（Taxi）。</p><p>其中地铁（MRT）是新加坡最便捷的交通工具，也是日常最佳的出行方式。根据官方 2017 年 1 月份提供的最新信息显示，全岛共设有 142 个车站，目前主要的运营线中，南北运营线以 “NS” 红线标明，东西运营线以 “EW” 绿线标明，东北运营线以 “NE” 紫线标明，环线以 “CC” 黄线标明，市区运营线以 “DT” 蓝线。</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190802161743.png" alt=""></p><p>新加坡地铁图</p><p><a href="https://www.lta.gov.sg/content/ltaweb/en/public-transport/mrt-and-lrt-trains/train-system-map.html" target="_blank" rel="noopener">https://www.lta.gov.sg/content/ltaweb/en/public-transport/mrt-and-lrt-trains/train-system-map.html</a><br><a href="https://exploresg.com/ditie/" target="_blank" rel="noopener">https://exploresg.com/ditie/</a></p><p>新加坡地铁和巴士车 (站) 内规定</p><ol><li>不可吃喝、吸烟、携带榴莲、大声喧哗和带宠物 </li><li>Bus 不报站、上下车需要刷卡</li></ol><p>温馨提示</p><ol><li>地铁和巴士上冷气很足，建议携带薄外套</li><li>在 20 分钟内，地铁和巴士之间转换，车资有优惠</li><li>在地铁或者商场等使用扶梯时，左侧是站立侧，右侧是快速通道</li></ol><h2 id="新加坡房屋指南"><a href="#新加坡房屋指南" class="headerlink" title="新加坡房屋指南"></a>新加坡房屋指南</h2><blockquote><p>组屋(HDB)</p></blockquote><p>新加坡的“组屋”，全称为组合房屋。由新加坡建屋发展局（HDB）不以盈利为目的承担建筑的楼房，为大部分新加坡人（80%）的住所。</p><p>组屋一般分为三房式、四房式和五房式。三房式指一厅两房，使用面积约 60 平方米；四房式是一厅三房，使用面积约 90 平方米；五房式是两厅三房，使用面积大致在 110 平方米。</p><p>组屋的区分都是按照地区名 + 数字，例如：PasirRis Block 186（巴西立大牌 186）、YishunBlock 210（义顺大牌 210）等。</p><p>屋内客厅，厨房，卫生间都是公用设施，一般会配备冰箱，洗衣机，空调或者风扇。</p><p>租房费用（一般情况下）：</p><p>新型组屋 (近 10 年内建成的) 相对条件会好很多 (平均价格 S$1000-1200 / 间)<br>单人单间：500-1000 新币<br>二人间：350-550 新币 / 人<br>四人间：270-350 新币 / 人</p><p><strong> 小贴士 </strong></p><ol><li>新加坡政府规定租住的房子必须要能在建屋局上注册。正常情况下，注册要求至少住 6 个月。如果不能注册，就是不合法的房屋。</li><li>如果退租，一定要提前一月声明，以防押金不退。</li><li>仔细看合同，仔细看合同，仔细看合同。</li></ol><blockquote><p>私人公寓(Condo)</p></blockquote><p>公寓，常见两房式或三房式，相当于国内的高档成熟社区，内有免费游泳池、健身房，BBQ 等公共设施，住宿环境相对较好，价格也相对高一些；大部分的 condo 房间都有主人房与非主人房之分，主人房有自己独立的洗手间和相对宽敞的卧室，当然价格也比非主人房高 200-300 / 月(非主人房平均价格<br>S$1,000-1,500 / 间 / 月)</p><blockquote><p>排屋(Terrace)</p></blockquote><p>独门不独栋的联排别墅，此类出租房源相对较少，住宿环境、价格与房子位置、条件有相当大的关系。</p><blockquote><p>独栋别墅(Landedproperty)</p></blockquote><p>少见于房间出租。</p><h2 id="租房"><a href="#租房" class="headerlink" title="租房"></a>租房</h2><blockquote><p>如果英语不是太差，不推荐狮城 BBS 或者微博租房，如果你有认识的新加坡房产中介自然是最佳选择</p></blockquote><p>PropertyGuru - <a href="http://www.propertyguru.com.sg/" target="_blank" rel="noopener">http://www.propertyguru.com.sg/</a></p><p>SRX - <a href="https://www.srx.com.sg/" target="_blank" rel="noopener">https://www.srx.com.sg/</a></p><p>新加坡本地发布平台，房源多。使用下来感觉 PropertyGuru 和 SRX 信息发布是最多的，信息筛选条件多，容易搜索到希望的房源。多为中介发布，有中介费。</p><p>我移除了 Nestia 和 99.co 因为根据新加坡房地产中介的建议他们只会在流量头部站点积极更新，其它站点基本疏于维护，租房房源一般 3 周以上就可能不用看已经租出去了。</p><p>在新加坡租房，有哪些经验可以分享？<br><a href="https://www.zhihu.com/question/22430961" target="_blank" rel="noopener">https://www.zhihu.com/question/22430961</a></p><h2 id="在新加坡买房与中国有何不同？"><a href="#在新加坡买房与中国有何不同？" class="headerlink" title="在新加坡买房与中国有何不同？"></a>在新加坡买房与中国有何不同？</h2><blockquote><p>无论在中国还是新加坡买房前后都记得关注下政策上的变化，新加坡买房的流程很简单，首付 = 房屋价格 + 税 + 中介费 - 贷款额度。</p></blockquote><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20200109111339.png" alt=""></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190802162119.png" alt=""></p><p>① 面积</p><p>说到面积，首先让中国买家摸不着头脑的，就是面积单位的换算。中国买家习惯用平方米（也称平方公尺）计算面积，来新加坡选购房子时听到的都是平方英尺，往往脑子得转一圈才知道个大概。1 平方米约等于 10.8 平方英尺。100 平方米就是 1080 平方英尺。</p><p>除了计算单位不同，“面积”一词在两地公寓市场上的定义也不一样。在中国，面积指的是建筑面积；新加坡算的是实用面积。建筑面积的算法比较繁琐。简单来讲，是根据各套房屋的套内建筑面积，求得各套房屋分摊所得的共有建筑分摊面积，比如门口的面积、楼梯等，都按比例算进每一个单位的建筑面积。</p><p>所以，同一个公寓单位，其建筑面积一定会大于实用面积，通常后者比前者少 20％左右。在中国买一个 “100 平方米” 的单位，和在新加坡买一个“1080 平方英尺”（相当于 100 平方米）相比，后者明显感觉宽敞一点，就是这个道理。</p><p>② 地契</p><p>中国的房产地契通常是 70 年左右，而新加坡的则有 99 年、999 年和永久地契之分。新加坡的房产因为地契年限长，颇受外籍人士青睐。其中，永久地契的房产一般要比 99 年地契的贵 20％。尽管如此，永久地契一直很抢手，也深受中国买家欢迎，因为买家看准这块市场的保值与增值。</p><p>这其中很大程度上因为新加坡的地皮比较少，想要建新楼必须拆掉现有的建筑。不像中国地皮比较多，还有可开发的地段。新加坡永久地契的地段价值比较高，所以如果进行集体出售、或是被政府征用的话，永久地契房地产的房主会可得到较高的补偿。</p><p>物以稀为贵，永久地契房产越是少见，也就越炙手可热。此外，永久地契对中国买家还有另一大吸引力，那就是永久地契满足了 “总觉得要给后代留下点什么” 的传统华人心愿。所以说，新加坡房产能如此吸引外国买家，与地契久脱不了关系。</p><p>③ 贷款</p><p>在新加坡首次购房的买家，可向金融机构贷款的房贷比率顶限为 80％，外籍人士一般则最高 70％。在中国，外国人一般不能向本土中国银行贷款，只能通过外资银行或中国银行境外支行。</p><p>原本新加坡和中国在房贷比率顶限方面有很大差别。不过两国都不断调整房贷比率顶限，因此两国的房贷比率顶限差别已缩小。</p><p>④ 税收</p><p>在新加坡，如果在一定期限里卖掉公寓，卖家需要上缴印花税。在 2011 年 1 月 14 日过后买房的购屋者，只要在四年内卖房屋都需要支付卖方印花税，第一、二、三和四年卖掉房产的税率分别是 16％、12％、8％和 4％。此后就不必上缴卖家印花税。</p><p>在中国，除了印花税外，还需要上缴增值税。为了给中国房地产市场降温，中国政府在 2013 年实施 20％的房地产买卖增值税。所谓增值税，就是对卖家卖房所得的利润征收的税。譬如，150 万人民币买的房子在几年后以 200 万人民币卖掉，卖家所赚得的 50 万就将需要以一定的比率交税。</p><p>⑤ 车位</p><p>在中国购买中高档住宅，需要另外购买车位。而在新加坡，买家不需要另付车位费，发展商一般会为每个新单位赠送一个车位。可不能小瞧这个车位费。近年来，车位费在中国节节攀升，动辄十几、二十万人民币，是一笔不小的开销。</p><p>新加坡私人公寓不收车位费，而是将停车场的修建和维护等费用，包括在每月的项目管理费之中。管理费除了车库，还包括游泳池、健身房等设施，每月一般是几百元新元。如果每月的管理费是 300 元新元（约 1400 元人民币），一年就是 1 万 7000 元人民币，15 年刚好是 25 万 5000 元人民币。总体来讲，这要比中国的车位 “划算” 得多。</p><h2 id="新加坡医疗指南"><a href="#新加坡医疗指南" class="headerlink" title="新加坡医疗指南"></a>新加坡医疗指南</h2><p>新加坡是一个热带国家，从国内刚过去有可能因水土不服引起的伤风、感冒、皮肤敏感或蚊虫叮咬等。出行之前可以带一些三九胃泰、牛黄解毒等日常药品之类的药品，防范于未然是最好的。</p><p>看医生：在新加坡持有工作签证，所在的公司会按照新加坡劳工部规定给每位员工会购买医疗保险或者费用报销。</p><p>医疗保险：一般是三种模式</p><ol><li>直接去合作门诊，提供公司信息，看病不用自己拿钱。</li><li>直接去合作门诊，提供公司信息，看病前给门诊 5 新币（每个公司不一样），其它的费用不用自己拿。</li><li>直接去合作门诊，自己先付产生的费用，然后去公司报销。意外伤害险等（视公司合同规定）。</li></ol><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191219193504.png" alt=""></p><p><a href="https://toutiaosg.com/%E6%96%B0%E5%8A%A0%E5%9D%A1%E5%8C%BB%E7%96%97%E5%85%A8%E7%90%83%E7%AC%AC%E4%B8%89%EF%BC%8C%E5%87%AD%E4%BB%80%E4%B9%88%EF%BC%9F/" target="_blank" rel="noopener">新加坡医疗全球第三，凭什么？</a></p><h2 id="公立和私立医疗服务"><a href="#公立和私立医疗服务" class="headerlink" title="公立和私立医疗服务"></a>公立和私立医疗服务</h2><blockquote><p>中国人在新加坡看病就好比外国人在中国看病一样不是很方便，价格不便宜，小病也有可能看成大病</p></blockquote><p>新加坡的医疗服务体系以优质高效著称，选择面广, 综合医院，专科医院，私人诊所遍布全国, 随处可见；不仅为全新加坡的公民，永久居民，外籍工作人士提供服务，同时周边国家的高端人群, 包括东南亚、亚洲、欧洲、中东阿拉伯等国家的病患都会将新加坡的国际医疗服务作为他们的首选。</p><p>新加坡的公立医疗机构和私立医疗机构在整个医疗系统中扮演着不同的角色。基础医疗门诊 80% 由私立医疗机构 / 家庭医生诊所提供，另外 20% 则是由政府综合诊疗所提供；而综合医疗，包括各类科室的住院，专科和 24 小时急诊主要由公立医疗机构提供，占 80% 的比例，剩下的 20% 由私立医疗机构提供。由于政府的有效规划和管控，公立医院和私立医院相辅相成, 缺一不可。</p><p>在公立医疗机构就诊一般都需要提前预约, 候诊时间较长, 也不能自由选择医生。由于那里的医生要面对更多的患者, 为每个患者服务的时间相对较短；而私立医疗机构由于患者相对较少, 不需要预约, 候诊时间较短，还可以自己选择医生，医生也能与患者作更多的交流, 提供更细致的服务，收费就相应高一些。</p><p>一些新加坡的公立医院也为自费病人提供高端医疗服务, 设有针对性的部门和项目, 如体检，会诊，专科治疗等。基础的检查和服务, 公立医院比私立医院收费较低；对于外籍人士和高端的服务项目, 公立和私立医院的收费差异不大。</p><p><a href="https://mp.weixin.qq.com/s?__biz=MzIwMTQxODUxNw==&amp;mid=2650871863&amp;idx=3&amp;sn=b9536c73a1b6a0e0ed02019598d75c35&amp;chksm=8d1b8a4dba6c035b898a133fdf30ec613eb6826a0f4a66d5befe6364a04e24fb6bde9a981ce7&amp;scene=21" target="_blank" rel="noopener">8 家新加坡著名的公立和私立医院</a></p><h2 id="货币兑换和汇款"><a href="#货币兑换和汇款" class="headerlink" title="货币兑换和汇款"></a>货币兑换和汇款</h2><blockquote><p>如果时间宽裕，推荐走新加坡工商银行渠道</p></blockquote><p>新加坡实行货币开放政策，货币兑换中心随处可见，尤其是在牛车水 (China Town) 附近。如有汇款需求到国内，可以先去牛车水汇款 (珍珠坊二楼)，方便快捷。等周围熟悉后，推荐去淡宾尼(Tampines) 汇款到国内，汇率会比其它地方高一些。具体的地方，在地图搜索 Tampines Money Exchange Center。 </p><p>小贴士：汇款中心一般可以汇到中国邮政、中国农业、中国交通、中国招商和中国银行等。第一次汇钱到国内，当填写汇款单据的时候一定要知道对方银行卡是在 <strong> 省 </strong> 市 ** 银行支行开户的(很重要)。</p><h2 id="法律法规"><a href="#法律法规" class="headerlink" title="法律法规"></a>法律法规</h2><p>新加坡向来是给世人展示优美环境，井然秩序，舒适安全的名片，然而这些美好的展现离不开新加坡法律制度的约束和规范。Singaporeis a“fine”country 完整的诠释了这两方面。所以在新加坡生活，你需要注意以下细节：</p><ol><li>自动排队：公共场合最经常听到的一句话就是 please queue！</li><li>着装：不同场合穿不同衣服, 建议每天换衣服。</li><li>公共习惯：乘坐公共交通或者在公共场合用餐时, 切忌大声喧哗, 不然你一样会被当做异类奥! 而且记得再饿也要撑到下车再用餐。</li><li>言论：新加坡是多文化和宗教融合的国家, 公共场合不要发表敏感政治言论或者宗教话题, 这也体现互相尊重。</li><li>不当行为：竖中指可能会被当做种族歧视处理的</li><li>如厕：来也匆匆, 去也冲冲。如若不然请准备 500 新币吧。</li><li>口香糖：公共场所不允许嚼口香糖, 不可以随意买卖, 允许带少量入境, 正是这个奇葩的规定维护了公共环境的整洁。</li><li>吸烟：新加坡公共场所绝对禁烟。如若吸烟不幸被抓到, 恭喜你一个月的工资 (高达 2000 新币) 为国家做贡献了!</li><li>垃圾：乱丢垃圾初犯者将处高达 1000 新币罚款, 再犯者将罚款额提高至 2000 新币以及在劳改法令下受罚。</li><li>交通规则：闯红灯, 随便乱穿马路这些不多啰嗦。违反的是规则, 伤害的是人身安全, 因为小编也感觉马路上的车如同闪电般行驶。</li><li>不可非法聚会和使用暴力</li></ol><p>以上内容是提醒大家在生活细节方面应遵守的规则, 但有些行为未必就可以罚款结案的, 比如: 签证到期后逾期逗留、抢劫、公共场所涂鸦、纵火、携带毒品等这些可都是在鞭刑的定罪范围内的。</p><p><strong> 最后郑重的提醒各位：</strong> 在机场不要发扬助人为乐精神帮陌生人携带物品, 因为很有可能你同时把生命交给了别人(运输毒品和贩毒同罪)。</p><h2 id="工作准证遗失如何处理"><a href="#工作准证遗失如何处理" class="headerlink" title="工作准证遗失如何处理"></a>工作准证遗失如何处理</h2><ol><li>发现丢失后立即携带护照或者工作准证的复印件到任何一间警察局报案，记得保存报案记录原件。</li><li>通知雇主公司 HR, 让其在 7 天之内在新加坡人力部网上提交补办工作准证的申请。</li><li>费用: 首次补办 100 新币, 第二次是 300 新币(一般在提交申请补办 4 个工作日可去新卡)</li></ol><h2 id="银行卡遗失如何处理"><a href="#银行卡遗失如何处理" class="headerlink" title="银行卡遗失如何处理"></a>银行卡遗失如何处理</h2><ol><li>发现遗失后立即拨打银行客户服务中心热线挂失</li><li>银行客户专员会核对护照和工作准证信息, 然后等待新卡邮寄到住处或者去支行直接领取。</li></ol><p>POSB 用户请拨打 18003396963<br>DBS 用户请拨打 18001111111<br>UOB 用户请拨打 18002222121<br>OCBC 用户请拨打 18003633333</p><h2 id="护照遗失如何处理"><a href="#护照遗失如何处理" class="headerlink" title="护照遗失如何处理"></a>护照遗失如何处理</h2><p>如护照遗失或被盗, 请立即到中国驻新加坡大使馆如实填写《护照遗失陈述表》，提供关于护照遗失或被盗的情况说明, 以及提供报警记录原件及复印件。如护照损毁, 请提交损毁的护照, 以及护照损毁的原因说明。</p><p>具体的更换护照和网上预约等等详细流程请参考大使馆的官网：<a href="http://www.chinaembassy.org.sg/chn/" target="_blank" rel="noopener">http://www.chinaembassy.org.sg/chn/</a></p><p>中国驻新加坡大使馆信息:</p><p>地址: 150 TANGLIN ROAD,SINGAPORE 247969</p><p>领事部：64712117；92971517(仅限紧急领保求助, 不接受证件咨询)</p><p>Email: <a href="mailto:chinaemb_sg@mfa.gov.cn" target="_blank" rel="noopener">chinaemb_sg@mfa.gov.cn</a></p><p>办公时间：周一至周五(节假日除外)</p><p>上午 9:00-11:30</p><h2 id="新加坡日常-App-推荐"><a href="#新加坡日常-App-推荐" class="headerlink" title="新加坡日常 App 推荐"></a>新加坡日常 App 推荐</h2><blockquote><p>如果是 Android 记得安装 Google 框架，如果是 iOS 记得调整更改 Apple ID 国家或地区</p></blockquote><p>交通: Grab(类似国内滴滴)、Google Map(谷歌地图)、SG Buses(公交时刻表)、Mobike（摩拜单车国内账户通用）</p><p>社交: Facebook、WhatsApp、Twitter、Instagram</p><p>购物: Shopee、Lazada、eBay、Amazon、淘宝国际、京东国际、网易考拉、网易严选、小米有品、拼多多</p><p>娱乐: Youtube(视频必备)、 Golden Village(电影院)、CATHAY (电影院)</p><p>快递: <a href="http://www.xiaopodao.com/" target="_blank" rel="noopener">小坡岛集运</a>、淘宝直送 / 集运</p><p>微信公众号: </p><ul><li>新加坡眼</li><li>新加坡狮城椰子</li></ul><p>视频 / 音频播客:</p><ul><li><a href="https://www.youtube.com/channel/UClL3IBde8AhRSqGXioa3FiA?sub_confirmation=1" target="_blank" rel="noopener">AbbieLu 新加坡</a></li><li><a href="https://www.ximalaya.com/toutiao/5218657/" target="_blank" rel="noopener">俊玮谈新</a></li></ul><p>特别推荐: </p><ul><li><a href="https://zero1.sg/" target="_blank" rel="noopener">Zero1</a>: 9.9 每月无限流量手机卡</li><li><a href="https://originallyus.sg/products/" target="_blank" rel="noopener">SG BusLeh</a>: 个人认为是比 SG Buses 更好用的公交时刻表</li><li><a href="http://refer.eatigo.com/eati17aqf-1v9" target="_blank" rel="noopener">eatigo</a>: 开启新加坡美食 5 折之旅</li><li><a href="https://app.shopback.com/sgp?raf=kxg2ZG" target="_blank" rel="noopener">ShopBack</a>: 类似于国内的购物返现平台</li><li><a href="http://www.xiaopodao.com/" target="_blank" rel="noopener">小坡岛集运</a>: 从中国寄送包裹到新加坡空运最低仅需 19RMB/kg, 海运小包 10RMB/kg</li></ul><p>推荐信息聚合平台:</p><ul><li><a href="https://toutiaosg.com/" target="_blank" rel="noopener">新加坡头条</a>: 聚合了主流的新加坡本地中文站点，用来搜索历史记录比较合适</li><li><a href="https://blog.seedly.sg/" target="_blank" rel="noopener">Seedly</a>: 熟悉新加坡本地的银行金融，保险，买房投资规则</li></ul><h2 id="新加坡至其他国家旅游"><a href="#新加坡至其他国家旅游" class="headerlink" title="新加坡至其他国家旅游"></a>新加坡至其他国家旅游</h2><blockquote><p>旅游可以具体向专业旅行社咨询，以政策变化为准</p></blockquote><p><a href="http://cs.mfa.gov.cn/wgrlh/lhqz/cjwdn_660600/t1175681.shtml" target="_blank" rel="noopener">境外中国公民赴香港特区怎么办理？</a></p><ol><li>持中华人民共和国护照，在海外过境香港特区前往中国内地或其他国家（或地区），凭有效护照和联程机票，可免办进入许可并在港停留 7 天。持中华人民共和国护照，自内地经香港特区前往其他国家（或地区），出示联程机票和前往国家或地区的签证，或合法居留证件 (如 “绿卡”) 后，可免办进入许可并在香港特区停留 7 天。 </li><li>如预计在香港特区停留超过 7 天，应事先申请进入许可。中国驻外使领馆可根据申请人情况签发 3 个月一次或两次有效，每次停留不超过 30 天的进入许可。持有外国永久居留证件，并在海外居住不少于 1 年者，可申请两年多次有效进入许可。</li></ol><p><a href="https://mp.weixin.qq.com/s?__biz=MzAxMjA4NzQzNA==&amp;mid=503621899&amp;idx=1&amp;sn=62d66af2463312f4d66adf0a272e71f8&amp;chksm=004730ee3730b9f8b6a0ece62952493af344cce03f3a9fb8504a3e3a9a15777f6e351d285d26&amp;mpshare=1&amp;scene=23&amp;srcid=08022k223Jxs2MD7XXeHCXxT&amp;sharer_sharetime=1564734537933&amp;sharer_shareid=456ba82bbd1a1c9f32e5725824095308%23rd" target="_blank" rel="noopener">新加坡到各国签证办理条例</a></p><h2 id="新加坡父母签证"><a href="#新加坡父母签证" class="headerlink" title="新加坡父母签证"></a>新加坡父母签证</h2><blockquote><p>网上找到的，忘记出处了，如果有错误描述请及时指正</p></blockquote><p>本人 PR，老婆七月份预产期。打算让父母 6 月中旬来。计划步骤如下:<br>1, 先买往返机票（返程可更改的）。<br>=== 对的。<br>2,5 月份申请父母旅游签证。<br>=== 旅游签证可提前一个月内申请，有效期多数 63 天，也有一年，两年，非固定。有效期内入境即可。<br>3, 父母来新后申请延期至 89 天。<br>=== 对的。<br>4, 同时申请 LTVP。<br>=== 也没错。<br>5, 悲剧后申诉。<br>=== 步骤没错。<br>请指点一下按这样做有什么不拖吗？<br>=== 有什么不妥是吧？没什么不妥的，如果觉得自己条件还可以，就可以早点安排申请 LTVP，如果觉得条件比较牵强，可以晚一点入境，晚一点延期，晚一点申请 ltvp，争取在月子后多待一点时间帮你们带孩子。<br>可以现在就申请旅行签证吗?<br>=== 提前一个月内申请，一个月内，内。<br>旅行签证有效期多久? 一年多次吗？<br>=== 上面已经回答了。<br>申请 LTVP 必须人在新加坡吗？<br>=== 是的。必须入境后申请。</p><p><a href="https://www.ica.gov.sg/" target="_blank" rel="noopener">https://www.ica.gov.sg/</a></p><h2 id="新加坡婚礼红包份子钱"><a href="#新加坡婚礼红包份子钱" class="headerlink" title="新加坡婚礼红包份子钱"></a>新加坡婚礼红包份子钱</h2><blockquote><p>婚礼怎么随份子钱，是个讲究活儿。它不仅是人情的体现，也是婚礼平衡开支的一种方式</p></blockquote><p>切记要分清是 “午宴” 还是 “晚宴”，时间是在工作日还是周末。毕竟在不同时段，价格差异很大。</p><p>想知道新加坡各大酒店在工作日、周末或公共假期时的婚礼餐标，可以查看<a href="http://www.weddingangbao.com" target="_blank" rel="noopener">Wedding Ang Bao</a></p><p>这可以通过知道婚礼举办地每桌的费用来推算出最合适的红包金额。计算方式是，每桌的基本费用处以 10，就能得到最低应给红包金额。比如婚宴每桌需要 1000 新币（包括了消费税 7% 和服务税 10%）。每桌 10 位客人。将 1000 除以 10，平均每人需要送红包 100 新币。</p><p>另外，由于红包的价格通常是整数，最好包一些新加坡人认为是比较吉利的数字。礼金金额切忌有 1，3 或 4，因为它被认为是不吉利的。最常见的礼金金额是 100 新币、120 新币、128 新币、150 新币、160 新币。</p><ul><li>红包的行情，是在餐馆还是酒店举行，午宴或晚宴，平日或周末，都不相同<ul><li>CAPELLA，ST.REGIS 等这种超级高大上的酒店一般要给 200-250 新币 / 人</li><li>金沙，香格里拉等酒店则是 160-200 新币 / 人</li><li>希尔顿，圣淘沙的酒店则是 150-200 新币 / 人</li><li>凯悦，泛太平洋酒店则是 120-150 新币</li><li>非酒店的餐馆，一般 100-120 新币 / 人</li><li>如果是自助餐档次的呢，80-100 新币 / 人</li></ul></li><li>红包的数目其实就是按人头计算，常用的计算方式是每桌的基本费用处以 10</li><li>关系特别好的时候，有些朋友也会在最少红包数额的基础上加 100-200 新币哦</li></ul><h2 id="新加坡公民-永久居民-外国人的区别"><a href="#新加坡公民-永久居民-外国人的区别" class="headerlink" title="新加坡公民 / 永久居民 / 外国人的区别"></a>新加坡公民 / 永久居民 / 外国人的区别</h2><blockquote><p>我们大多数人的起点是外国人，这点与国内的户口制度类似，无论是中国还是新加坡始终绕不开买房和教育这两座大山</p></blockquote><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190802162244.png" alt=""></p><p><a href="https://docs.qq.com/sheet/B80RhZ2ZATLC0ge3Bi2bLYpr2iY5PC1nE3031LWRcK1rTcgj0Z2bvD00bDO63Ie3tz2ovOwW4" target="_blank" rel="noopener">如果发现表有错误请点击链接申请编辑更新，谢谢</a></p><h3 id="EP-申请-PR"><a href="#EP-申请-PR" class="headerlink" title="EP 申请 PR"></a>EP 申请 PR</h3><blockquote><p>在新加坡工作满半年即可申请 PR，不过大概率是被拒的，失败后等待半年继续申请挑战吧</p></blockquote><p><a href="https://www.ica.gov.sg/apply/PR/apply_PR_who" target="_blank" rel="noopener">Becoming a Permanent Resident</a></p><blockquote><p>申请步骤均在网上完成，务必提前准备好申请材料，重点检查 4、6、7、9、10</p></blockquote><ol><li>有效的护照个人信息和官方备注页面，原件与复印件</li><li>EP 或 S Pass 准证原件及复印件</li><li>身份证（如有）</li><li>出生证明或者家庭户口（非英文需要公证书翻译）</li><li>更名证明文件（如有）</li><li>标准护照尺寸照片</li><li>最高学历（成绩单，资格证，会员资质等也可提供）(非英文需要公证书翻译)</li><li>以前雇主的推荐信，说明就业的性质，持续时间以及基本工资（如有）</li><li>过去六个月的工资单</li><li>现任雇主的信函，说明就业日期，过去六个月的每月工资，包括加班和津贴，可以找 HR 准备，要在申请前一个月内开具此信件</li><li>IRAS 同意书，表示同意 ICA 获取和核实与此相关的财务信息</li><li>对于自雇人士，需出示有效商业登记证明书并显示合伙人姓名</li><li>对于自雇人士，与工作有关的职业执照（例如小贩执照，营业执照， 物业代理牌照）</li></ol><blockquote><p>已婚人士还需要这些：</p></blockquote><ol><li>结婚证书（非英文需要公证书翻译）</li><li>关于之前婚姻的死亡证明或离婚证明（如有）</li><li>关于以前婚姻的子女的监护文件（如有）</li><li>配偶的最高教育证书（包括大专学历），成绩单，职业资格证等（非英文需要公证书翻译）</li></ol><blockquote><p>如果配偶一同申请：</p></blockquote><ol><li>配偶的有效旅行证件及有效的入境通行证，护照（资料页）</li><li>配偶的出生证明（非英文需要公证书翻译）</li><li>更名文件（如有）</li><li>配偶的身份证（如适用）</li><li>关于配偶以前的婚姻离婚证明以及孩子的监护文件，或者死亡证明（如有）</li></ol><blockquote><p>如果孩子一起申请：</p></blockquote><ol><li>孩子的护照资料页</li><li>孩子的出生证明，显示孩子和父母的姓名（非英文需要公证书翻译）</li><li>儿童收养文件（如适用）</li><li>儿童改名证明（如适用）</li></ol><p>关于其他的申请条件可以访问移民局网站，查询需要提交的资料。</p><h3 id="PR-申请公民"><a href="#PR-申请公民" class="headerlink" title="PR 申请公民"></a>PR 申请公民</h3><blockquote><p>等 PR 满两年后再申请</p></blockquote><p><a href="https://www.ica.gov.sg/application/singapore-citizenship/becoming-a-singapore-citizen" target="_blank" rel="noopener">Becoming a Singapore Citizen</a></p><p><a href="https://toutiaosg.com/%E5%90%90%E8%A1%80%E6%95%B4%E7%90%86%EF%BC%81%E5%A6%82%E4%BD%95%E5%9C%A8%E7%BD%91%E4%B8%8A%E7%94%B3%E8%AF%B7%E6%96%B0%E5%8A%A0%E5%9D%A1pr%E5%92%8C%E5%85%AC%E6%B0%91%E6%9C%80%E5%BC%BA%E6%94%BB%E7%95%A5/" target="_blank" rel="noopener">吐血整理！如何在网上申请新加坡 PR 和公民最强攻略！收藏~</a></p><h2 id="我的新加坡之旅时间轴"><a href="#我的新加坡之旅时间轴" class="headerlink" title="我的新加坡之旅时间轴"></a>我的新加坡之旅时间轴</h2><blockquote><p>时间轴不再描述细节，如果需要了解详细信息可以阅读后面的内容</p></blockquote><p>201804</p><ul><li>LinkedIn 收到 100offer 猎头来自 Sea 的工作邀请机会</li><li>经历 3 轮远程 Skype 视频面试，时间约为 3 周</li><li>提出辞职由 Sea HR 帮忙开始申请 EP，时间约为 3 周</li></ul><p>201805</p><ul><li>完成离职流程，时间约为 1 个月</li><li>收到 EP 的 IPA，由 Sea HR 帮忙开始申请 DP，时间约为 1 周(申请 DP 请提前准备好结婚证公正)</li><li>完成新加坡机票，住宿，货币，各种材料纸质化和电子扫描化的准备(可选为申请 PR 准备国内学历学位公证和出生证公证)</li></ul><blockquote><p>再强调一下出国前的建议</p></blockquote><ol><li>随身携带好护照和相关入境材料，非常重要，非常重要，非常重要</li><li>证件，学历和结婚证公正翻译等材料可以通过扫描全能王 (CamScanner) 录入为电子版，水印是可以很方便去除的，这里就不多说了。如果觉得好用请购买正版服务支持下总部位于上海的合合信息，名片全能王 (CamCard) 也是他们家的产品</li><li>提前规划好到达新加坡后的住宿(新加坡 Airbnb 违法)，交通出行，手机应用，SIM 卡，入职流程</li><li>准备好足够的新币现金建议 4k+，因为银行卡和租房都是大头，有条件至少准备一张以上的 Visa/Mastercard 信用卡</li><li>出国前检查下国内的银行，手机，社保，人事档案是否安排妥当，身份证和护照离过期更换时间是否可控</li><li>如果有条件出国前做下全面的体检至少对自己身体有一个清晰的认识，把牙齿之类的小毛小病尽可能提前扫除隐患</li><li>现在的网络通信都很发达，记得和家人保持联系，减少他们的担心，自己照顾好自己</li></ol><p>201806</p><ul><li>20180609 星期六晚上 20 点第一次来到新加坡</li><li>完成住宿，EZ-Link 交通卡和 Singtel Prepaid 手机卡，时间约为 1 天</li><li>入职一周左右由 HR 协助申请 EP，需要本人预约 MOM 现场办理 EP，收到 EP 实体卡时间约为 1 周内</li><li>收到 EP 实体卡使用 SGWorkPass 扫描获取有效期并保存照片，注册 SingPass，约 1 周左右收到密码信封然后激活</li><li>办理 Zero1.sg 的无合约限制，无限流量的 Postpaid 手机卡，背后运营商为 Singtel 质量靠谱</li><li>携带相关证明办理银行卡，我选择 UOB 但是推荐各位选择 DBS，如需转账回国可以再额外开通工商银行</li></ul><p>201903</p><ul><li>全年在新加坡工作满 183 天以上需要报税，新加坡税率较低平均缴税额度大概年收入 5%-8%，对外国人来说可以理解为税前≈税后或者到手收入</li><li>工作满半年可以开始申请 PR，但一般建议等满 2 年，可以提前准备各种材料，国内学历学位和出生证公证在新加坡本地认证机构都可以代办</li><li>在半年时间中根据自身状况可选办理信用卡，健身卡，住院保险 + 重疾意外，保障自己的身体健康很重要</li><li>基本熟悉新加坡的生活节奏，明白新加坡的优缺点，规划自己下一个阶段目标</li></ul><p><img src="https://cdn-blog.seedly.sg/wp-content/uploads/2018/06/30020702/Personal-finance-guide-01.png" alt=""></p><p>READ ME FIRST: Your Personal Finance Journey Starts With This Article<br><a href="https://blog.seedly.sg/read-me-first-your-personal-finance-journey-starts-with-this-article/" target="_blank" rel="noopener">https://blog.seedly.sg/read-me-first-your-personal-finance-journey-starts-with-this-article/</a></p><p>201912</p><ul><li>新加坡保险的思考和决策</li><li>我购买的是 AIA 储蓄 + 终生人寿重疾险 30 万新币保障额度</li></ul><p>我身边很多购买过保险的人基本是 AIA 和 Prudential，我为什么会买 AIA 因为一直在房产投资群潜水，偶然冒泡后误打误撞结识了 AIA 团队排名第一的 (真) 学霸，大佬开玩笑邀请我去他们团队私人会所检验其专业性，我拖了半年觉得自己对保险的认知仅停留在皮毛阶段，最后选择在年末去了解下，对方因为私人原因跨行业横向切入保险的经历挺不容易的，我简单说下我理解的新加坡保险，不正确的地方也欢迎补充，毕竟这对每个人来说都息息相关：</p><ol><li>公司配置的一般是团体险，覆盖门诊 + 住院医疗，福利好可以不用担心看不起病。如果额度不高就建议单独购买住院医疗，大家应该清楚新加坡住院的费用是很贵的，保险费用在 1000 新币 / 年左右不算贵，选择哪家保险都差不多，这也是大多数人在新加坡自费购买的第一个保险。如果是 PR/SC 可以升级政府 CPF 中的私人医疗保险。</li><li>新加坡的寿险分定期和终生，保额高费用低，单独购买每年 800 新币即可配置 100w 保额，这也是很多人从国内飞来新加坡购买寿险的原因。</li><li>新加坡的重疾险和国内一样都是最贵的险种，但核心优势是新加坡保险协会制定的保障范围覆盖初期 + 中期 + 重疾种类市场最多，而且购买和赔付流程合理清晰。需要根据家庭收入分配，年龄，保额，初期，倍数等仔细评估</li><li>新加坡的意外险比较简单，注意并理解赔付规则为意外的含义</li><li>新加坡投资类保险收益没有香港的乐观</li></ol><p>如果买保险只需要找同类型最便宜的，那我们也就不用这么累去仔细比较。保险中存在很多影响价格的关键参数，不少细节也需要你和保险代理一一沟通确认清楚，无论你选择哪一家保险公司一个专业且靠谱的保险代理会让你省心不少，如果你在国内买过保险或者房子应该能感同身受。</p><p>对于买保险这个事情千万不能像父母那一代认为是骗子或者买成了人情险，要对自己的家庭生活品质和风险管理负责，新加坡保险代理相对国内比较靠谱，购买保险前多和已经买过的朋友或者不同的保险公司对比咨询如何合理搭配，在不同阶段买适合的保险产品，不要等到大病意外或被拒绝赔付后才意识到为什么没有提前配置正确的保险产品。微信朋友圈中你也许已经看到过大量真实的水滴筹大病求助信息，我希望你或者你的家人朋友能通过保险的来应对生活的挑战。</p><p><a href="http://m.opinion.caixin.com/zknews/2017-01-22/101047816.html" target="_blank" rel="noopener">我为什么要去新加坡买定期寿险 - 财新网专栏作家 - 明宏义</a></p><h2 id="新加坡-1-个月感想"><a href="#新加坡-1-个月感想" class="headerlink" title="新加坡 1 个月感想"></a>新加坡 1 个月感想</h2><blockquote><p>选择新加坡的理由：给自己多一种选择</p></blockquote><ul><li>MOM: Ministry of Manpower 新加坡人力部</li><li>IPA: In-Principle Approval 批准信</li><li>EP: Employment Pass 人才准证</li><li>DP: Dependant’s Pass 家属准证</li><li>PR: Singapore Permanent Resident 新加坡永久居民</li><li>SC: Singapore Citizen 新加坡公民</li><li>HDB: Housing &amp; Development 政府组屋</li><li>Condo: 私人公寓</li><li>Food Court: 食阁</li><li>CPF: 公积金</li><li>NUS: National University of Singapore 新加坡国立大学</li><li>NTU: Nanyang Technological University 新加坡南洋理工大学</li></ul><ol><li>原始坐标：上海，无留学经验也没有去过新加坡</li><li>猎头推荐新加坡的职位，想想自己那被遗忘的蹩脚英语抱着试一试的心态</li><li>一共 3 轮 Skype 远程视频面试，约 4 周时间到最后确认 offer</li><li>约 1 天时间思考，离职申请，签电子合同</li><li>检查护照有效期，下载学信网英文翻译认证，由 HR 帮助提交申请 EP，约 3 周内收到 IPA</li><li>在上海户口所在区公证处办理结婚证公证翻译，约 3 周时间完成，又慢又麻烦</li><li>完成 EP 后由 HR 帮助提交申请 DP，约 1 周内收到 IPA</li><li>购买机票，打印 IPA，带上护照，打包行李，兑换 4000 新币，确认人事档案存放地址，选择不缴纳每月养老保险和医疗保险约 1500 元人民币(可由父母代缴，中断非连续缴纳暂时不影响回国养老，以政策变化为准)</li><li>飞机上填写好新加坡入境卡，完成入境登记，无需录入指纹，开启华为天际通</li><li>抵达公司提前安排好的住址，熟悉新加坡环境</li><li>办理 EZ-Link 交通卡和 Singtel Prepaid 手机卡(如果没有强需求可以暂时不办理)</li><li>公司 HR 提交 EP 现场办理申请，收到邮件后预约 MOM 办理时间（我没有被要求体检，根据不同公司情况而定）</li><li>约 1 周后收到 EP 绿色实体卡，使用 SGWorkPass 扫描保存照片，注册 SingPass 后约 1 周左右收到密码信封</li><li>公司开具证明办理银行卡，新加坡本地我选择 UOB(保持 1000 新币存款)，另外强烈推荐再办理工商银行卡(持卡 0 门槛，转账回国 0 费用)</li><li>网上申请 Zero1 的无限流量手机卡，约 3 个工作日收到直接使用，弃用 Singtel Prepaid（浪费了 25 新币）</li><li>新加坡日常消费以现金为主，我本人习惯手机支付无奈降级至刷信用卡阶段(持有浦发 AE 白 / Visa/Master)，怀念下国内的支付宝和微信</li></ol><p>我刚来新加坡 1 个多月，不用担心语言不通，大部分人都会说华语。新加坡真的不算大，地铁和公交都很方便，空气质量很好至少我的鼻炎消失了，天气没有国内那么热，居然没有蚊子，没有蚊子，没有蚊子。在这段时间里我幸运了结识了交大和复旦的校友，跟随专业的中介实地考察了新加坡的租房和买房市场，走遍了几个重要的核心区域，顺便吃了几顿亲民的米其林一星。之后我应该还会继续更新自己在新加坡的经历，比如健身、快递、看病等日常生活，希望对大家有所帮助。</p><h3 id="新加坡-3-个月感想"><a href="#新加坡-3-个月感想" class="headerlink" title="新加坡 3 个月感想"></a>新加坡 3 个月感想</h3><blockquote><p>咋们就从最传统的衣食住行说起吧</p></blockquote><p><strong> 衣 </strong></p><p>因为新加坡全年都是夏季，平时的正常温度基本在 30° 上下，对于我来说已经把家里的夏装的家底全部带过来了，所以也没有什么特别需要单独购买，作为男生如果以后缺衣服的话在新加坡线下就是优衣库，线上还是优衣库。</p><p>女生的选择实在太多了，乌节路和 VivoCity 等都可以逛好久，这里就跳过吧</p><p>新加坡本地的 Outlet(奥特莱斯)是 IMM，如果你喜欢跑步运动，那么只卖 80 新币的 adidas Ultraoost X 和 Asics GEL-Kayano 会有一定吸引力</p><p>在新加坡网购，和国内激烈竞争的胜出者相比，还有很长一段路要走，当然也证明东南亚市场是一块巨大的蛋糕等待挖掘</p><p>新加坡室内空调冷气普遍开得比较足，建议怕冷的同学多备件长袖外套在公司，长时间逛商场时注意冷热交替避免生病</p><p>从中国快递至新加坡的方式已经快捷不少，淘宝直运和集运，小坡岛集运单人小包团都是很方便的选择</p><p><strong> 食 </strong></p><p>新加坡最有特点的饮食文化莫过于食阁(Food Court)，其实有点类似于上海的大食代，但价格亲民而且还有米其林一星的神奇存在，平均一顿的价格区间在 3-7 新币，整体口味偏重。每个食阁上方都会标注 A/B/C 卫生评级，新加坡本地的习惯一般不在家做饭，大家都出去吃所以种类也还算多，不知道吃什么可以认准 Singapore Best Foods 红色标志，和国内相比关键是放心。</p><p>如果平时想吃顿大餐类似国内海底捞、小龙坎那种，平均每人大概 30-50 新币左右，评级更高的餐厅价格自然也水涨船高</p><p>自己在家做饭的成本其实和外面吃也差不了多少，如果居住的房子允许大炒和大煮当然可以选择自己动手丰衣足食</p><p>新加坡的菜市场比较少见可能是我没有刻意去寻找或者需求的缘故吧，买蔬菜和肉类基本都在 Sheng Siong(昇菘)，FairPrice(NTUC)，Cold Storage，喜欢日本食物还可以选择 DON DON DONKI，我个人很喜欢这只萌企鹅的魔性主题曲</p><p><a href="https://www.bilibili.com/video/av32078102" target="_blank" rel="noopener">https://www.bilibili.com/video/av32078102</a></p><p>新加坡的便利店清一色 7-Eleven，部分大一点的屈臣氏 (Watsons) 支持支付宝(Alipay)，上面提到的 Sheng Siong 已经全部支持 Alipay</p><p>外卖大家就不要指望 GrabFood 或 Foodpanda 有饿了么和美团外卖的速度了，老老实实去附近的食阁按时吃饭才是正道</p><p>我每个周末都会使用 <a href="http://refer.eatigo.com/eati17aqf-1v9" target="_blank" rel="noopener">eatigo</a> 开启 5 折美食之旅打打牙祭</p><p><strong> 住 </strong></p><p>(1) 租房</p><p>我在租房这个环节基本上算是跳过了，刚来时建议找好房源，这边的酒店居住成本很高的。因为目前是长租在公司提供的组屋 (HDB) 内，毕竟室友都是公司自己人很放心，合同限制不多每月会安排阿姨定期打扫和保养空调等，手机银行转账支付租金也方便。回想当时刚来的 1 个月每周都跟随专业的中介校友出去找房子都十分辛苦，更不要说自己联系中介一家一家看了，说多了都是泪。这边的房产中介需要考证，据说通过率只有 10-15%，每个中介都会展示唯一的证书编号，所以不用太担心被骗，不过每个中介的态度千差万别，找到靠谱的中介能够加快找房的速度。</p><blockquote><p>备注: 公司已经不再提供租房支持，可以联系 HR 询问中介联系方式提前沟通房源</p></blockquote><p>由于地理位置和房屋面积质量差异，下面的租房价格仅仅是一个参考区间，数字单位为新币 / 月<br>组屋(HBD)，普通房 600-800，主人房 1000-1200，整租 1000+<br>公寓(Condo)，普通房 800-1500，主人房 1200-2000，整租 1500+</p><p>房源信息可以来自于同事，也可以自己在线挑选，方法我都写在前面了，和同事咨询过新加坡租房的大致流程</p><ol><li>看准自己喜欢的房子</li><li>看清楚合同，看清楚合同，看清楚合同，签约</li><li>签 1 年一般押一付一，签 2 年押二付一</li><li>中介费是根据实际情况由房东或者租客来承担，一般根据合约长短支付 0.5 或 1 个月的房租作为中介费</li></ol><p>(2) 买房</p><p>虽然是否决定买房的话题为时尚早，但经历了魔都十几年房地产的上涨自然也不会错过对新加坡房地产的研究，如果你是冲着 30w 新币的组屋 (HDB) 那么找新加坡本地人结婚是最快的途径。新加坡在 2018 年 07 月 06 日 0 点开始调整了印花税，对于我们普通人来说 2-3 年内拿到永久居民 (PR) 已然不易。新加坡私人公寓 (Condo) 的价格和质量相对国内来说是有优势的，但是 1 室 80w，2 室 100w，3 室 120w 这样的价格加上印花税还是会让我们感到一丢丢肉疼，好在房地产市场涨幅长期平稳且退出机制清晰，租房市场也足够活跃，而且银行可以贷款 7 成 + 2% 左右的低利率还是足以让我们拥有奋力一搏的勇气，不用牺牲 6 个钱包。</p><p>这里给未来的新加坡买房经历留个坑位吧</p><p><a href="https://toutiaosg.com/%E6%96%B0%E5%8A%A0%E5%9D%A1%E7%A8%8B%E5%BA%8F%E5%91%98%E4%BA%B2%E5%8E%86%EF%BC%9A%E5%A6%82%E4%BD%95%E5%9C%A81%E4%B8%AA%E6%9C%88%E5%86%85%E4%BA%91%E6%B7%A1%E9%A3%8E%E8%BD%BB%E5%9C%B0%E4%B9%B0%E6%88%BF/" target="_blank" rel="noopener">新加坡程序员亲历：如何在 1 个月内云淡风轻地买房卖房</a></p><p><a href="https://zhuanlan.zhihu.com/p/32493002" target="_blank" rel="noopener">新加坡买房小记</a></p><p><strong> 行 </strong></p><p>现在无论在哪里手机的使用比重都是极高的，我自己来新加坡前把小米 6 替换为华为 P20 Pro，妻子还是用的小米 MIX2，在国内早已习惯电信乐享家 199 元全国无限流量，我们的老卡 1 个是移动，1 个是联通，来到新加坡之后选择了无合约限制价格为 29.99 新币无限流量的虚拟运营商 Zero1.sg，因为背后是 Singtel 所以质量有保障。在新加坡接收国内短信验证码之类不要钱，双卡双待都是没有问题的，不过我妻子还是很期待 iPhone 即将推出的双卡功能，毕竟她在美国时的 iPhone5s 也用了 4 年多，被我硬生生拖入 Android 阵营实属不易。 </p><p>新加坡公共交通发达，Google Map 在手说走就走。我的选择和国内类似，能坐地铁尽量就不会选择公交车，因为坐公交车有几点不爽，如果你不熟悉新加坡或者不会熟练使用 Google Map 建议不要轻易乘坐公交车。</p><blockquote><p>乘坐地铁切记不可吃喝、吸烟、携带榴莲、大声喧哗和带宠物，乘坐公交车的规定与地铁类似但有以下额外注意事项</p></blockquote><ol><li>公交车来之前一定要招手才会停</li><li>在到达下一站前一定要按 Stop 红色停车按钮，不然不会停</li><li>下车时还要再刷一次交通卡确认付款</li></ol><p>除了公交车和国内差异较大以外，平时过马路记得按一下身边的指示灯，你不按或者对面也没人按，那你就不用想着过去了</p><p>这边的公交卡称为 EZ-Link，想刷 NFC 不好意思没有小米和华为，请购买 NFC SIM card。虽然充值很方便支持国内双币信用卡，但我还是很想念上海二维码扫码进闸机。另外新加坡地铁站没有安检，没有安检，没有安检。</p><p>我丢过一次地铁卡，为了挽回里面 25 新币我第一次主动走进新加坡警察局开具丢失证明，他们做事确实负责而高效，不过我因为操作失误导致旧卡数据没有正常转移到新卡，超过 7 天申报时间我也没有办法无力回天，所以再一次怀念下国内的手机刷卡。</p><p>~~ 新加坡已经遍布 Mobike 和 ofo，摩拜的国内账户可以在这里直接使用，ofo 需要重新注册。~~ 单车市场基本倒闭</p><p>新加坡打车市场已经被 Grab 一统江湖，Uber 和滴滴出行都入股 Grab，另外 Grab 打车很安全而且支持支付宝(Alipay)，普通出租车都支持微信和支付宝。目前能看到的对手只有 Gojek。</p><p>关于机票从上海往返新加坡的航班很多，价格和飞行时间比较透明就不多说了，我这里还是推荐大家体验下新加坡航空 (Singapore Airlines) 的服务，今年航空公司评选又站回全球第一，即使乘坐经济舱也不要忘记品尝一下新加坡司令哈。</p><p>今年国庆节期间我和老婆买了新加坡至四川成都的 5 日往返机票，新加坡航空旗下的胜安航空(SilkAir)，令我感到惊喜的是 2 人机票往返价格总共才 1600 人民币，单人往返 800 人民币，可能是 bug 价格了。</p><p>新加坡和国内的走位不一样，行走避让和司机开车位置与国内正好相反。</p><p>新加坡拥车成本比较高，虽然公共交通发达，但是开车的梦想还是要有的，万一实现了呢？</p><blockquote><p>传统的四大金刚扯完了，我们再聊一些逆转未来的话题</p></blockquote><p><strong> 安全 </strong></p><p>新加坡的安全本质上是基于严格的法律加上遍布各地的摄像头，你如果想挑战下不如先了解下鞭刑的酸爽和罚款罚到你肉疼的数字。</p><p>吸烟，喝酒，乱扔垃圾在法律中都有明确要求，虽然不能百分百杜绝抽烟现象，但你走在马路上不会遇到随意吐痰也不需要提防狗屎。穿过十字路口车辆都会早早的自觉停下来等你先过去，新加坡随处可见的就是无障碍设施，地铁沿线基本都设置了棚顶，既可以防晒又可以躲雨，即便每天都能遇到短时暴雨由于出色的排水系统也从来不会看到有积水。</p><p>在国内随时会收到的垃圾短信和房产金融中介等骚扰电话，在新加坡基本是看不到的，不过 Email 和 WhatsApp 这种网络骚扰还是无法消灭的。这边的违法成本比较高只要被投诉就会收到法律的严格制裁，当然注意保护自己的隐私安全始终不能掉以轻心，毕竟再文明的社会偶尔也会遇上小人。</p><p>在新加坡你基本不用担心丢失物品，因为大概率都能找回来，包包也不用刻意放在前面，拉链忘记拉上也没关系，不用担心人口贩子和小孩走丢，更不用担心一个人走夜路会不会不安全，犯罪成本高促成的低犯罪率给你带来的不仅仅是安全感更是幸福感。</p><p>由于新加坡的地理位置极好，无论是过去还是未来基本是不会受到任何灾难气候影响，台风、海啸或者地震是不存在的</p><p>新加坡的人际关系相对简单，与人为善的过程中也不要忘记多留个心眼谨慎一些，在这边和他人发生误会大多数都会听到 Sorry 和 I am fine 而不是争吵，规规矩矩排队而很少有人随意插队，政府办事效率高以廉洁著称也是难能可贵，在新加坡未必有国内这么亲切有人情味，但你能感受到的是相对的公平和简单。</p><p><strong> 健康 </strong></p><p>我在上海的时候就饱受着变态反应性鼻炎的痛苦，每次体检医生都开玩笑要不住到外环去吧，没想到现在离家这么远。至少来新加坡后我的鼻子就彻底舒畅了，我原来对空气质量也不以为然，买个小米净化器放在家里，直到离开上海前看见基因检测报告提醒风险最高的是鼻咽癌，我才明白空气对于每个人的未来都是如此重要。</p><p>新加坡的温度常年保持在 30° 上下，不会像上海夏季烈日炎炎，但新加坡比较像“蓝天白云 晴空万里 突然暴风雨”，有云有风有遮雨棚，身体其实会觉得很舒服.</p><p>之前已经说过新加坡的饮食文化以食阁 (Food Court) 为主，这些小店很多都有几十年的历史，食物未必都符合你的胃口但至少足够安全，不用担心地沟油。合理的饮食搭配以及规律的生活节奏才是根本。</p><p>新加坡本地人都注重健身，如果不想花太多钱在健身房可以考虑在小区附近的体育馆免费跑步或者花费 1.3 新币游泳。私人公寓 (Condo) 一般自带小型游泳池和健身房，虽然小但有总比没有好。如果公司有补贴健身房的价格 (一般 150-200 新币每月) 其实也不算太贵，每月 99 新币可以选择像 Fitness First or Pure Fitness(Pure Yoga)等专业健身房。</p><p>关于看病，因为前段时间工作比较忙抵抗力突然下降导致出现额头皮肤红肿，在国内经历过不注意小病而酿成大病的惨痛教训，<a href="https://wsgzao.github.io/post/wisdom-tooth/">我是如何做到花 8000 元拔智齿的</a>，所以这次特地请 1 天病假去公司合作的 Raffles Medical 私人诊所看病，事后看诊断结果比较准确且看病过程十分高科技 + 高效率，病因是 <code>带状疱疹</code>，总共 99 新币，30 是问诊费其余都是买药钱。只不过第二天我发现未有起色且眼皮红肿都快睁不开了就先让昨天的医生开具的急症介绍信，然后直奔 Raffles Hospital，在了解基本无大碍和每位专科医生复查至少 300 新币起步的情况下果断申请放弃继续治疗赶紧溜回去休养生息，这一趟花了 199 新币，其中 130 为问诊费(节假日看病费用翻翻)。命固然重要，但人只要一生病真的可能失去一切甚至连累家人。</p><p>2019 年去了 2 次新加坡伊丽莎白医院 - Mount Elizabeth Hospital，还增加了人生中第一次坐救护车的经历，好软好舒服。首先是价格没有想象中那么贵，当然还是优先建议购买住院保险以防万一，其次是建议能选择私立医院就不要选择公立，看病的效率真让人着急。未来有机会再探索下新加坡鹰阁医院 - Gleneagles Hospital。</p><p>和同事回顾了他们看病的流程，作为外国人一般也是建议直接去附近的私人医院，价格其实差不多但不用排队。如果选择去政府医院比如 NUH 等可能存在排队现象，这个体验对于国内看病来说大家心里应该很明白有多痛苦，如果各位有足额的医疗保险在国内其实可以选择特需医疗(免排队 + 专家门诊)。关于新加坡医院的更多信息可以参考最上面的介绍。</p><p>印尼 “烧芭” 引发空气污染和马来西亚动不动就拿断水挑事也是新加坡需要持续努力解决的问题之一。</p><p>新加坡的蔬菜和水果算不上贵但也不会像国内一样便宜，除了猫山王榴莲和部分进口水果质量和价格有优势，也没有太多的种类可供选择，我自己会从网易考拉购买 Swisse 作为补充，话说新加坡的营养品真心贵，同样的 Swisse 一小瓶卖 56 新币，其它品牌价格也是高居不下。</p><p><strong> 娱乐消费 </strong></p><p>新加坡本身就很小，加上我和我妻子都倾向于工作，学习和健身。平时的娱乐活动也就停留在节假日出去寻找下亲民美食，慢慢游览新加坡仅有的几个景点，新加坡环球影城，S.E.A. 海洋馆，新加坡动物园，新加坡夜间动物园，滨海湾花园，金沙酒店附近的鱼尾狮和摩天轮，圣淘沙和赌场，其它像植物园，大学校园很多都是免费的，旅游一般 2 天可以快速结束，如果需要细细品味也就再多增加 1-2 天足够了。</p><p>新加坡娱乐设施真的不算很多，看电影还得去现场买票，网上购买需要多花钱。吃喝玩乐想看看附近的活动和评价都没有像美团点评类似的产品，毕竟需求不像国内这么大，但我觉得让国内的美团猫眼或者阿里淘票票来进攻新加坡市场，相信分分钟钟可以拿下。</p><p>新加坡本地目前小额仍然以现金为主，商场一般支持刷卡，而主要的景点和购物中心区域全部覆盖支付宝(Alipay)</p><p><strong> 教育培训 </strong></p><p>虽然现在谈教育太早但是新加坡本地的教育资源始终都是偏向本国公民的，对我们来说永久居民 (PR) 只是万里长征的第一步，要不要买学区房，要不要做义工，也是留给自己的问题。感觉这又有上海户口，学区房，拼父母，何其相似？</p><p>新加坡和中国一样都很注重基础教育，对子女的教育支出都很高，新加坡第三方教育机构或者成人专业类培训机构的市场也很大。最近在微信朋友圈看到英国 BBC 邀请 3 名威尔士的优等生体验韩国鸡血教育的文章，除了深刻感受到教育的重要性，更加理解韩国快速崛起的因素，成熟而完整的教育产业链对孩子很重要，对国家来说更重要。</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20200109110126.png" alt=""></p><p><a href="https://zhuanlan.zhihu.com/p/46043323" target="_blank" rel="noopener">谈新加坡教育的分流制度</a></p><p><strong> 工作生活 </strong></p><p>我目前在一家新加坡互联网公司 Sea 上班，旗下知名度比较高的是 Garena 和 Shopee。工作制度是弹性的，没有严格的打卡要求，正常时间为 09:30-19:00，周围以中国同事居多，大部分是在这边读书毕业工作，学校几乎清一色新加坡国立大学 (NUS) 和新加坡南洋理工大学(NTU)，工作语言为英文，核心生产力工具包括 Google Suite，顶配 MacBook Pro，Herman Miller，Dell 2417H，还有无限制的饮料，水果和零食。原以为只能在国内的创业公司和少数尊重技术的优质公司才能看到的办公环境，可能在国外是很常见的事情吧。新加坡互联网公司在 IT 方面的人才非常短缺，也许是因为本地人大都投身于金融行业，所以很多技术人才也是会考虑从中国引进，甚至直接在国内开设分公司。</p><p>因为我以 EP 身份把我老婆也带了过来，目前还是 DP。对她来说在新加坡找一份金融行业的工作真的非常不容易，花了 2 个多月时间扫光了 LinkedIn 在新加坡几乎所有公开招聘，遗憾的是很少有金融行业愿意招聘非新加坡公民 (SZ) 和永久居民 (PR) 以外的人群，得到的回复大多数都是 Sorry，毕竟新加坡政府在很多地方都会优先照顾本国人的利益，这个道理放在中国也很好理解。不过目前经历了 6 轮面试最终拿到了一个还不错的 offer，后续 DP 也要转成 EP，这是一件值得庆幸的事情。</p><p>新加坡月薪中位数是 4500 新币左右，新加坡人力部公布了 2018 年全国的工资中位数 4437 新币 / 月，如果你对各行业数据感兴趣可以参考<a href="https://www.michaelpage.com.sg/salary-guide" target="_blank" rel="noopener">Singapore Salary Benchmark 2020 Michael Page</a></p><p>在没有明显压缩新加坡生活成本，按 1 人每月估算为 1w 人民币，如果是 2 个人差不多是 1.5w 人民币</p><p>HDB 合租主人房: 1100<br>水电网: 50<br>移动套餐: 9.9<br>饭费: 20x30<br>交通: 2x30<br>健身: 99<br>理发: 12<br>其他: 100</p><p>≈2030.9 新币≈10000 人民币，如果你是单人还可以选择普通房大概 800 每月。不过我相信新加坡贵的部分体现在后期的看病和生娃教育上<br><a href="https://mp.weixin.qq.com/s?__biz=MzIwMTQxODUxNw==&amp;mid=2650896087&amp;idx=1&amp;sn=9eb1be6f3e8ff3a5acc908e2c983cb37&amp;chksm=8d1be4adba6c6dbbb26bb7a8f6e99cff210306f1f1f856297851bc10ed378f532081f08a298b&amp;mpshare=1&amp;scene=23&amp;srcid=0627SV9XjUJihYiNxW383bUB&amp;sharer_sharetime=1564742363597&amp;sharer_shareid=456ba82bbd1a1c9f32e5725824095308%23rd" target="_blank" rel="noopener">扒一扒新加坡的精英制度！月薪 14 万的人到底经历了什么？</a><br>中国 VS 新加坡，生娃养娃究竟要花多少钱？</p><p>中国：</p><ul><li>生娃：3000-1 万人民币</li><li>养娃：65 万元 - 130 万人民币</li><li>总计：约 65 万 - 131 万人民币</li></ul><p>新加坡：</p><ul><li>生娃：1003-18912 新币</li><li>养娃：至少 67 万新币</li><li>总计：约 69 万新币</li></ul><p>推荐下 Grammarly for Chrome，在写邮件和文档时可以快速发现并纠正语法错误，对提升英文书写能力非常有帮助。我自己也是第一次开始深度使用 MacBook，记录一些简单的入门过程在 Blog 中，也可以做下参考。</p><p><a href="https://wsgzao.github.io/post/macbook/">MacBook macOS 从小白到入门</a></p><p><strong> 养老政策 </strong></p><p>新加坡不养闲人，你在新加坡的食阁 (Food Court) 仔细观察过就会发现几乎所有打扫卫生的都是老年人，和中国相比新加坡的养老金 CPF 是交多少退多少，不会被平均，所以更多的本地人会提前了解基金股票保险和投资房地产等方式来为自己养老。新加坡、日本、韩国等国家的老龄化问题已经凸显，我们都可以看到未来国内严重的老龄化趋势，谁又能独善其身呢？</p><p>新加坡政府因为楼市过热而提高印花税的闪电行动，中国也吹响了全球征税的集结号，无论身在哪里我们始终躲不开政治不是吗？</p><h2 id="日用品推荐"><a href="#日用品推荐" class="headerlink" title="日用品推荐"></a>日用品推荐</h2><blockquote><p>回顾来新加坡前后的经历，我希望自己分享的一部分实用建议和商品可以帮助大家更好的适应新加坡生活。如果你不喜欢网易严选和网易考拉可以选择性跳过。</p></blockquote><p>我自己携带并且大家都能买到的产品分享：</p><ol><li>药品：我带的是泰诺和夫西地酸乳膏，这边初期看病成本还是比较高，建议最好带一些板蓝根、急用的抗生素、抗过敏药及自己习惯的常用药，如胃药、哮喘喷剂等等。</li><li>其他综合的日用品，我是分 3 批带过来的，这里按照重要性分成 2 部分来推荐，大部分来自网易严选和网易考拉工厂店，关于原因我也记录了自己的观点。</li></ol><p><a href="https://wsgzao.github.io/post/buy/">我的线上线下购物变迁史</a></p><h3 id="必备推荐"><a href="#必备推荐" class="headerlink" title="必备推荐"></a>必备推荐</h3><blockquote><p>我就只推荐适用于男同胞的产品了，虽然我妻子也是在严选和工厂店买，如果各位有需求我日后可以再补充，她的东西实在是多</p></blockquote><p>[手机 / 耳机 / 智能穿戴无推荐]<br>Follow Your Heart</p><p><a href="http://163.lu/I8OGX1" target="_blank" rel="noopener">28 寸 纯 PC“铝框”（非全铝）拉杆箱</a><br>新秀丽制造商，但是怎么看怎么觉得更像是日默瓦(RIMOWA)，虽然有小米 90 分旅行箱但 20 寸太小，为了追求更大容量就买了这款，使用感受非常可靠，五星推荐</p><p>[双肩包无推荐]<br>我自己背的是一加(OnePlus)1 代和 2 代，她带的是 Longchamp 和 Doughnut，都是多年的老包了</p><p><a href="http://wx.uniir.com/" target="_blank" rel="noopener">独美</a><br>眼镜我和妻子每人配了 2 副做主备, 我们买的都是来自京东众筹的独美，3.3g 镜架加镜片只要 398。小米有品太阳镜带了 1 副，不过来新加坡后我从来没佩戴过</p><p>[晴雨伞没有推荐]<br>新加坡经常短时暴雨，平日基本阳光明媚，建议携带一把晴雨伞，既能遮阳、又能挡雨。我自己带了 1 把天堂和 1 把小米晴雨两用，因为比较懒所以买的都是自动伞。只是可惜了 RealBrella 锐乐 不对称设计长柄伞留在家里吃灰，我好喜欢这款大红色啊。</p><p>[跑鞋无推荐]<br>自己带了 2 双旧鞋过来，严选上买过一双类似 Adidas UltraBoost 的鞋子还不错。我妻子带了 Asics GEL-Kayano 24，无论在网易考拉买还是在新加坡本地买 Asics 都很便宜，而且新加坡 NIKE REACT 跑鞋一般也只要 120 新币左右。</p><p><a href="http://163.lu/050tb0" target="_blank" rel="noopener">两带式男女款软木拖鞋 2.0</a><br><a href="http://163.lu/SpQlo1" target="_blank" rel="noopener">两带式男 / 女款拖鞋</a><br>Birkenstock 集团制造商，我特地在国内和新加坡的专卖店对比过，自己穿了 1 代非常舒服然后又买了 2 代，因为在新加坡基本是拖鞋 + 短裤的夏装，如果你的工作要求正装注意带好皮鞋和衣服套装</p><p><a href="http://163.lu/v4KrM2" target="_blank" rel="noopener">软弹速干男 / 女沐浴拖鞋</a><br>Crocs 制造商，浴室必备。本来想分享严选的人字拖，但不知道为什么严选把它下架了，反正我基本是放在室内穿，大家买自己觉得舒服的就好</p><p><a href="http://163.lu/CKQh21" target="_blank" rel="noopener">考拉工厂店 5 双 男士精梳棉防臭休闲袜</a><br>我在新加坡穿袜子的次数就和穿运动鞋的次数保持一致，除了健身和户外活动，几乎都是大拖鞋走起，上次登顶新加坡最高峰武吉知马山也是拖鞋，不过大家还是必要学我穿拖鞋爬山，以免自己给自己挖坑</p><p><a href="http://163.lu/uE5Uz3" target="_blank" rel="noopener">网易严选 男式丝滑莫代尔平角内裤</a><br><a href="http://163.lu/7ZOLU2" target="_blank" rel="noopener">考拉工厂店 男士莫代尔零束缚感内裤</a><br>我买过 CK 也买过网易严选和小米有品的纯棉内裤，但真正可以打动我的材质还是莫代尔，网易严选和网易考拉工厂店的两款我都买了，质感各有特色。严选上还有一款空气内裤，勇于尝鲜的同学要不试试？</p><p><a href="http://163.lu/aXBps0" target="_blank" rel="noopener">考拉工厂店 男式无缝插肩短袖 T 恤</a><br>我买了 3 件来自于严选和考拉工厂店的运动速干衣，但是从品质和舒适度上还是感觉不如自己再 Nike 实体店中购买的 Dri-FIT，考拉工厂店这款已经无限逼近了。小米有品也有很多运动衣，都是可以考虑的。我个人推荐备上 3 套运动衣，因为新加坡常年夏季，出汗是难免的，速干面料可以保持身体的舒适</p><p><a href="http://163.lu/Qxhpq2" target="_blank" rel="noopener">考拉工厂店 男式运动短裤</a><br>这款运动短裤我五星推荐，不仅做工精湛，口袋拉链等细节也非常到位，我自己直接买了 2 条，如果不是因为只有 2 种颜色，我还会继续买。另外还带了一条 Nike Dri-FIT 短裤，不过因为没有拉链所以来新加坡后基本没穿过，在上海的时候也仅仅是健身时穿的，现在因为设计问题算是彻底废了。</p><p><a href="http://163.lu/FPubq0" target="_blank" rel="noopener">考拉工厂店 男式针织轻薄运动裤</a><br>这款运动长裤我五星推荐，空气面料在夏天也依旧舒爽，内口袋拉链细节设计极赞，我索性买了 2 条一模一样的黑色款。新加坡平时上班我基本是穿这款长裤，原因和上面说过的新加坡室内空调温度较低有关，注意保暖。</p><p>[睡衣没有推荐]<br>我就直接把以前优衣库的全棉联名 T 恤全部带过来当睡衣穿了，有时候出门也可以穿哈</p><p>[外套没有推荐]<br>我自己带了 Under Armour 防风防雨衣，小米有品夜跑皮肤衣，小米有品防雨皮肤衣，除了 Under Armour 放在公司偶尔冷的时候会披一下，其它皮肤衣还没穿过。</p><p>[衬衫没有推荐]<br>我把原来公司定制的各种正装带过来了，可惜就入职时穿过一次，后来就是拖鞋加运动套装上班了</p><p><a href="http://163.lu/N7voR2" target="_blank" rel="noopener">成人款 高清时尚电镀泳镜</a><br><a href="http://163.lu/tDJJb2" target="_blank" rel="noopener">黑闪系列 硅胶防水泳帽 （男女通用）</a><br><a href="http://163.lu/Egc5c1" target="_blank" rel="noopener">男式基础泳裤</a><br>严选做了游泳装备也出乎我的意料，关键是和我之前买的 Speedo 相比那叫一个便宜啊，我本身是退休多年的游泳二级运动员，看似很简单的游泳装备严选的质量和价格都把控的不错，希望未来增加带度数的游泳镜。新加坡开放的普通游泳馆使用 EZ-link 刷卡，1.3 新币一次非常便宜，关键还多是训练使用的标准泳池人也少，定时清洁的规范让人放心。</p><p><a href="http://163.lu/rDAkF3" target="_blank" rel="noopener">全球通用转换插座</a><br>全球通用转换插座出国的人都应该明白是必备的，严选居然也做出来了，感觉又要干死一片坑爹厂商</p><p>[移动电源必须小米啊]<br>互联网上一直流传着这样的传说，小米什么产品都可以黑但是谁要是敢黑小米移动电源就被其他人反过来喷死。如果不是小米移动电源的出现干掉一众无良商家，现在市场上还不知道有多少人会受到低劣电池爆炸的影响，小米移动电源是真正用产品说话赢得用户口碑的最佳案例之一。我自己买的是紫米新款，我妻子买了一个超薄款就为了好看，哎</p><p><a href="http://163.lu/4ehYt4" target="_blank" rel="noopener">3 头浮动式电动剃须刀</a><br>科技类产品其实很想支持小米，可惜小米生态链不给力，就先用着严选高性价比的剃须刀好了</p><p><a href="http://163.lu/5cpvU0" target="_blank" rel="noopener">THREE SEVEN/777 进口指甲刀便携 4 件套 指甲剪小套装 三色可选</a><br>被淘宝坑过电动指甲刀和匠技指甲刀，也被严选坑过过于简约的指甲刀，没想到最后还是要选择韩国原装进口的 777 牌 4 件套，我以前不了解斜口指甲刀，后来才发现这货是剪脚指甲的神器啊，我以前剪脚指甲是有多痛苦哇</p><p><a href="http://163.lu/RNu3A1" target="_blank" rel="noopener">8 件装 折叠多功能衣架</a><br><a href="http://163.lu/dtCu31" target="_blank" rel="noopener">18 头多功能晾衣架</a><br>必备推荐，折叠携带很方便，18 头多功能晾衣架晾衣服的时候一个顶百，我都差点可以不用普通衣架了</p><p><a href="http://163.lu/pAmCc4" target="_blank" rel="noopener">旅行分装瓶套装</a><br>洗护用品我建议用分装瓶或者带最小包装的出国，因为这些日常用品本身价值不高但分量重，在当地超市购买就好了，除非你非常在意使用某些品牌</p><p><a href="http://163.wyh5.top/OsArG4" target="_blank" rel="noopener">考拉工厂店 智能清洁电动牙刷</a><br>我给父母买的也是同款，建议再带上 2 个以上刷头。如果你之前从来没有使用过电动牙刷，非常建议你尝试，清洁牙齿更加彻底和方便，爱上之后就无法回到过去手动刷牙啦</p><p><a href="http://163.lu/H03jR2" target="_blank" rel="noopener">电动式硅胶洁面仪</a><br>我还记得我给妻子送的第一个礼物就是 FOREO LUNA MINI2 Plus，这个也是我在网易考拉上买的第一个商品，当时这款网红洁面仪被招商银行垄断，没办法直接购买，逼着自己了解到网易考拉在国内海淘市场的领先地位，也算是缘分吧。现在严选自己也推出类似洁面仪才十分之一的价格，买个给自己吧</p><p><a href="http://163.lu/ZKkRz3" target="_blank" rel="noopener">韩国制造 硅胶洁面刷</a><br><a href="http://163.lu/RJS3r0" target="_blank" rel="noopener">韩国制造 硅胶沐浴按摩手套</a><br><a href="http://163.lu/Rv9KI2" target="_blank" rel="noopener">韩国制造 多功能硅胶清洁刷</a><br>严选从韩国引进来相当专业的硅胶产品制造商，其中这 3 件小东西在洗脸，沐浴，洗碗上极大的提升了我的幸福感，强烈推荐人手一件</p><p><a href="http://163.lu/womXA3" target="_blank" rel="noopener">皇室御用超柔毛巾</a><br>内野制造商，这是网易严选当年备受争议的产品之一，我不知道内野是什么，但我只知道这款毛巾确实舒服</p><p>[床单 / 床笠 / 被套 / 毯子]<br>我从家里带了 2 套旧的，然后又从考拉工厂店买了外国人比较喜欢的床笠，因为晚上睡觉都是关闭空调，没有被子就一层薄薄的毯子，一般租房子房东都会提供床板和床上用品，如果你不习惯或者运气不好，在新加坡本地宜家采购也很方便的</p><p><a href="http://163.lu/VY4v73" target="_blank" rel="noopener">考拉工厂店 100% 桑蚕丝双面美肤枕套</a><br>我和妻子一人一个，带过去非常方便，水洗之后也没有出现质量问题，面料实在丝滑</p><p><a href="http://163.lu/pBhg61" target="_blank" rel="noopener">AQR 创口贴</a><br>在新加坡常年夏装，像脚和皮肤很容易受伤，带上一盒以备不时之需</p><h3 id="可选推荐"><a href="#可选推荐" class="headerlink" title="可选推荐"></a>可选推荐</h3><blockquote><p>分享自己购买过的东西真的好累，没想到不知不觉买了这么多，但是能够对自己派上用场没有浪费也值了</p></blockquote><p><a href="http://163.lu/23D8k4" target="_blank" rel="noopener">泰国制造 天然乳胶枕 护颈优眠 升级抗菌</a><br>我买过记忆枕，空气枕，乳胶枕还有各种酒店的枕头体验。小米 8H 的乳胶枕和网易严选的相比我更推荐严选的升级款，这也属于严选的爆款商品了</p><p><a href="http://163.lu/6iWZ74" target="_blank" rel="noopener">日式多功能颈枕 舒滑款</a><br>第一次看到 MUJI 的微粒子 U 型枕就被深深吸引，现在小米和网易严选都有同样类型的，我自己购买的是光滑面料，毕竟新加坡非常热，原来在国内我还买过一个经典款</p><p><a href="http://163.lu/9iYPC2" target="_blank" rel="noopener">舒眠真丝眼罩</a><br>折叠床是带不过去了，很早之前买过零听眼罩，用过真丝眼罩后才明白丝的舒服，就和上面买真丝枕套的理由一样。如果你对声音也很敏感，除了戴耳机以外，再购置几副耳塞也是不错的选择</p><p>[鼻毛修剪器]<br>~~ 没有看到小米和严选有~~ 现在严选和小米素士都做了，看了张大妈的评测最后淘宝购入松下 ER-BN50，虽然不知道和国产的飞科相比有多大优势，至少用下来还行吧</p><p>[洗护 / 牙膏 / 洗面奶 / 防晒霜]<br>我推荐带上便携装，其实选择什么不重要，重要的是理解背后的成分，我唯一推荐的就是自己在上海和新加坡都长期使用的<a href="http://163.lu/lWFct2" target="_blank" rel="noopener"> 熊野油脂 无硅弱酸性马油洗发水</a></p><p><a href="http://163.lu/M8IW72" target="_blank" rel="noopener">Swisse 男士复合维生素 120 片 / 瓶</a><br>加上我在上海之前吃的半瓶，一共带了 2.5 瓶过去，现在回头看这个决定是非常明智的，因为新加坡本地蔬菜和水果不算便宜，关键是营养品价格奇高，一小瓶都要五六十新币。营养品不能代替药物，更不能代替你规律的饮食作息和身体锻炼，请记住这只是用来辅助身体营养平衡。我妻子还会购买 Swisse 的女士复合维生素片 + 葡萄籽和 Unichi 玫瑰果 + 葡萄籽</p><p><a href="http://163.lu/PsXds0" target="_blank" rel="noopener">考拉工厂店 便携式手持蒸汽挂烫机</a><br>我妻子要买的，方便小巧，出席正式场合会排上用场</p><p><a href="http://163.lu/WXcRz2" target="_blank" rel="noopener">考拉工厂店 强力除螨吸尘器</a><br>我没同意我妻子买养生壶和破壁料理机，原本这么大个头的除螨仪其实也是拒绝的，但是在阅读过网易浪潮工作室的一篇《中国人为什么爱晒被子》后我认为在美国或者韩国流行的洗衣烘干一体机可能不适合现在的我们，但是我不希望自己身边的人因为痘痘或者皮肤细菌感染而受到伤害，既然网易工厂店降低了除螨仪的购买门槛，为什么不尝试改变下自己的习惯呢？</p><p><a href="http://163.lu/oCJS84" target="_blank" rel="noopener">春风 TryFun 超润滑避孕套</a><br>好孩子就不要点击了，尤其是不要淘气切换到春风 TryFun 系列</p><h2 id="工作招聘"><a href="#工作招聘" class="headerlink" title="工作招聘"></a>工作招聘</h2><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191226105334.png" alt=""></p><p><a href="https://docs.qq.com/doc/BqI21X2yZIht1vALQM0Mf73G24se4c4wv0v31gLPCn3U4vsH0IQmKC2Cjyb927Q9Ok0PRkXB3WYpg82K1GXC4" target="_blank" rel="noopener">中金所技术公司最新招聘岗位</a></p><p><a href="https://docs.qq.com/doc/B80RhZ2ZATLC0DsTVf3kFjA01XR7Mg1x8BG42bVOrs1E5zYc01HWAZ0vDTku39xOdU3cS99t2" target="_blank" rel="noopener">Sea Job Openings</a></p><p>这是我第一次创建微信个人公众号，不会向大家推送文章，只是作为信息分享的渠道。我和上家公司以及现在公司的人力关系都还不错，在征得允许的前提下给大家分享上海和新加坡这两家公司目前的内部招聘动态，上海的职位真的的是进去的多出来的少，如果你希望相对稳定那这是很不错的机会。新加坡这边我会跟随公司内部招聘邮件每半个月左右更新，工作语言以英文为主，周围的中国同事还比较多，不用太担心在新加坡的语言关。这两家公司的介绍都可以在互联网上轻松获取，如果你相信自己的能力可以直接投递简历至文章内的联系方式。努力奋斗未必都能达到预想的结果，但至少你做出了自己的选择。</p><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><blockquote><p>如果你无法访问 github.io 的原文可以查看知乎专栏的文章，如果你只想了解我前往新加坡的求职过程可以看微信公众号的提炼内容</p></blockquote><p>从国内跳槽至新加坡工作的经验分享<br><a href="https://zhuanlan.zhihu.com/p/44280335" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/44280335</a></p><p>从国内跳槽至新加坡的最初半年，我都经历了什么？<br><a href="https://mp.weixin.qq.com/s/gDntToVrvFoQbyfrNf7XqA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/gDntToVrvFoQbyfrNf7XqA</a></p><p>从小到大我都没有离开过父母的保护，感谢你们的理解和支持，也同样感谢老婆的付出和双方家庭的包容。<br>引用领结婚证那天分享在朋友圈的一句话作为结语: I never grow up, but I never stop growing.</p>]]></content>
    
    <summary type="html">
    
      为帮助大家玩转新加坡、快速适应当地生活
    
    </summary>
    
      <category term="生活 | Life" scheme="https://wsgzao.github.io/categories/%E7%94%9F%E6%B4%BB-Life/"/>
    
    
  </entry>
  
  <entry>
    <title>Jenkins Plugins 常用插件推荐</title>
    <link href="https://wsgzao.github.io/post/jenkins-plugins/"/>
    <id>https://wsgzao.github.io/post/jenkins-plugins/</id>
    <published>2019-12-16T06:59:49.000Z</published>
    <updated>2019-12-26T07:43:05.821Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>开源版本的 Jenkins 具有三大能力：Master-Slave 的分布式构建调度能力、Pipeline 编排能力、强大的开源生态（插件）能力。2017 年 4 月，Jenkins 创始人 KK（Kohsuke Kawaguchi ）来到中国，交流中他也明确表示 Jenkins 的成功主要取决于其开源生态系统，Jenkins 有 1400 多个插件可供使用。因为有开源的插件生态系统的存在，Jenkins 要用得好，插件一定是不能少的，需要我们充分发现和使用插件来实现我们的需求，而不是重复造轮子，自己去实现。</p><blockquote><p>Jenkins Plugins 常用插件推荐</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 12 月 16 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/jenkins-plugins/">https://wsgzao.github.io/post/jenkins-plugins/</a></p><p><strong> 扩展阅读 </strong></p><p><a href="https://plugins.jenkins.io/" target="_blank" rel="noopener">Jenkins Plugins Index</a></p><hr><h2 id="用户及权限"><a href="#用户及权限" class="headerlink" title="用户及权限"></a>用户及权限</h2><p>Jenkins 用户权限管理是 Jenkins Administration 中非常很重要的环节，由于大部分企业都会有自己的域控管理，所以和 LDAP 集成并基于用户组实现权限模型设计与管理是企业级 Jenkins 实践的重要内容。</p><ol><li><a href="https://plugins.jenkins.io/ldap" target="_blank" rel="noopener">LDAP</a> 这个插件允许使用 LDAP 对用户进行认证，LDAP 服务器可以为 Active Directory 或者 OpenLDAP。</li><li><a href="https://plugins.jenkins.io/active-directory" target="_blank" rel="noopener">Active Directory</a> 这个插件允许使用 Active Directory 对用户进行认证，同时结合诸如 Matrix Authorization Strategy 插件，可以识别用户所在的所有用户组，对用户授权进行灵活配置。<br> 基于 Windows Active Directory 进行域管理的企业，推荐采用 Active Directory。</li><li><a href="https://plugins.jenkins.io/github-oauth" target="_blank" rel="noopener">GitHub Authentication</a> 这个插件提供了使用 GitHub 进行用户认证和授权的方案。</li><li><a href="https://plugins.jenkins.io/gitlab-oauth" target="_blank" rel="noopener">Gitlab Authentication</a> 这个插件提供了使用 GitLab 进行用户认证和授权的方案。</li><li><a href="https://plugins.jenkins.io/matrix-auth" target="_blank" rel="noopener">Matrix Authorization Strategy</a> 这个插件提供了基于矩阵的授权策略，支持全局和项目级别的配置。</li><li><a href="https://plugins.jenkins.io/role-strategy" target="_blank" rel="noopener">Role-based Authorization Strategy</a> 这个插件提供了一种基于角色（Role）的用户权限管理策略，支持创建 global 角色、Project 角色、Slave 角色，以及给用户分配这些角色。这款插件是最常用的 Jenkins 权限策略和管理插件。</li></ol><p><a href="https://www.jianshu.com/p/6c274d9b22ad" target="_blank" rel="noopener">Jenkins 自动化部署 - 权限管控篇 (六)</a></p><h2 id="代码管理"><a href="#代码管理" class="headerlink" title="代码管理"></a>代码管理</h2><p>Jenkins 项目中配置 Source Code Management 去下载代码进行构建任务，是非常普遍的应用场景。Jenkins 插件支持很多 SCM 的系统，使用最常见的是 Git 和 SVN。</p><ol><li><a href="https://plugins.jenkins.io/git" target="_blank" rel="noopener">Git</a> 支持使用 Github、GitLab、Gerrit 等系统管理代码仓库。</li><li><a href="https://plugins.jenkins.io/subversion" target="_blank" rel="noopener">Subversion</a> 支持 Subversion 系统管理源代码。</li></ol><h2 id="项目及视图"><a href="#项目及视图" class="headerlink" title="项目及视图"></a>项目及视图</h2><p>Jenkins 中对 Project 和 view 的管理，是用户日常工作中使用很多的功能。</p><ol><li><a href="https://plugins.jenkins.io/cloudbees-folder" target="_blank" rel="noopener">Folder</a> 这个插件支持用户使用目录管理项目，目录支持嵌套，并且支持目录中创建视图。</li><li>List view Jenkins 默认支持 List 类型的视图，用户可以创建 List 视图过滤所关心的项目。</li><li><a href="https://plugins.jenkins.io/sectioned-view" target="_blank" rel="noopener">Sectioned View</a> 这个插件支持一种新的视图，视图可以分为多个部分，每部分可以单独配置显示所选择的项目信息。</li><li><a href="https://plugins.jenkins.io/nested-view" target="_blank" rel="noopener">Nested View</a> 这个插件支持一种新的视图，其表示直接显示项目，而是以目录图标显示所包含的子视图，每个子视图显示所选项目信息。</li><li><a href="https://plugins.jenkins.io/build-pipeline-plugin" target="_blank" rel="noopener">Build Pipeline</a> 这个插件提供了一种 Build Pipeline 视图，用于显示上、下游项目构建的关系。</li></ol><h2 id="构建触发"><a href="#构建触发" class="headerlink" title="构建触发"></a>构建触发</h2><p>Jenkins 支持多种 Build 触发方式，尤其一些自动化触发方式非常有用</p><ol><li>Build periodically，Jenkins 内置功能，可以设置类似 crontab 时间，周期性地自动触发构建。Poll SCM，Jenkins 内置功能，类似 Build periodically，可以设置类似 crontab 时间，不同的是不是直接进行构建，而是周期性地在后台检查所配置的 SCM 有没有更新，只有当有代码更新时才会触发构建。</li><li>Trigger builds remotely (e.g., from scripts)，Jenkins 内置功能，远程触发构建，通过设置 token 可以支持远程脚本中触发 Jenkins 构建。</li><li><a href="https://plugins.jenkins.io/gerrit-trigger" target="_blank" rel="noopener">Gerrit Trigger</a> 这个插件将 Jenkins 集成到 Gerrit code review 中，支持 Jenkins 配置 Gerrit 服务器等信息，实现 Gerrit event 触发 Jenkins 构建。</li><li><a href="https://plugins.jenkins.io/gitlab-plugin" target="_blank" rel="noopener">GitLab</a> 这个插件将 Jenkins 集成到 GitLab web hook 中，支持 Gitlab 分支及 Merge Request 等相关事件触发 Jenkins 构建。</li><li><a href="https://plugins.jenkins.io/github-pullrequest" target="_blank" rel="noopener">GitHub Integration</a> 这个插件将 Jenkins 集成到 GitHub 中，支持 Gitgub 分支及 Pull requests 触发 Jenkins 构建。</li><li><a href="https://plugins.jenkins.io/jira-trigger" target="_blank" rel="noopener">JIRA Trigger</a> 这个插件将 Jenkins 集成到 Jira WebHooks 中，支持 Jira issue 的状态等变化时触发 Jenkins 构建。</li></ol><h2 id="构建参数"><a href="#构建参数" class="headerlink" title="构建参数"></a>构建参数</h2><p>Jenkins 除了支持普通的参数类型（布尔型、字符串型、多行文本型、选择型和文件型 ）外，还有一些插件支持更加丰富实用的参数类型，比如参数间动态关联、多层级参数、隐藏参数等 。</p><ol><li><a href="https://plugins.jenkins.io/nodelabelparameter" target="_blank" rel="noopener">nodelabelparameter</a> 这个插件增加了一个新的参数类型，Node 和 Label，从而使用户通过参数可以选择项目构建运行的节点。<br> 其他插件不一一列举，可以查看插件说明<ul><li><a href="https://plugins.jenkins.io/hidden-parameter" target="_blank" rel="noopener">https://plugins.jenkins.io/hidden-parameter</a></li><li><a href="https://plugins.jenkins.io/extended-choice-parameter" target="_blank" rel="noopener">https://plugins.jenkins.io/extended-choice-parameter</a></li><li><a href="https://plugins.jenkins.io/validating-string-parameter" target="_blank" rel="noopener">https://plugins.jenkins.io/validating-string-parameter</a></li><li><a href="https://plugins.jenkins.io/extensible-choice-parameter" target="_blank" rel="noopener">https://plugins.jenkins.io/extensible-choice-parameter</a></li><li><a href="https://wiki.jenkins.io/display/JENKINS/Active+Choices+Plugin" target="_blank" rel="noopener">https://wiki.jenkins.io/display/JENKINS/Active+Choices+Plugin</a></li></ul></li></ol><h2 id="构建任务及环境"><a href="#构建任务及环境" class="headerlink" title="构建任务及环境"></a>构建任务及环境</h2><p>围绕构建任务，有许多小的插件，却提供了一些实用的功能</p><ol><li><a href="https://plugins.jenkins.io/ws-cleanup" target="_blank" rel="noopener">Workspace Cleanup</a> 这个插件支持在构建前后 删除或者部分删除 workspace</li><li><a href="https://plugins.jenkins.io/description-setter" target="_blank" rel="noopener">description setter</a> 这个插件支持正则表达式匹配构建 log 输出，设置构建的描述</li><li><a href="https://plugins.jenkins.io/build-name-setter" target="_blank" rel="noopener">build-name-setter</a> 这个插件支持设置构建的显示名字，而不是默认的为 #1，#2，……，#buildnum</li><li><a href="https://plugins.jenkins.io/envinject" target="_blank" rel="noopener">Environment Injector</a> 这个插件支持在构建任务的不同阶段插入环境变量，并且在构建结束导出所有的环境变量等功能。</li></ol><h2 id="构建通知"><a href="#构建通知" class="headerlink" title="构建通知"></a>构建通知</h2><p>把构建状态及时地通知用户，是 Jenkins 的一个必不可少的功能。Jenkins 支持多种主动和被动的通知方式。</p><ol><li><a href="https://plugins.jenkins.io/mailer" target="_blank" rel="noopener">Mailer</a> 这个插件支持基本的邮件通知功能，比如构建失败和构建恢复成功可以发送邮件通知给相关人员。</li><li><a href="https://plugins.jenkins.io/email-ext" target="_blank" rel="noopener">Email Extension</a> 这个插件是邮件通知的扩展，支持定制邮件内容，触发条件以及邮件接收者，功能比基本邮件通知要灵活强大的多。</li><li><a href="https://plugins.jenkins.io/slack" target="_blank" rel="noopener">Slack Notification</a> 这个插件支持把构建结果推送到 Slack channel。</li></ol><h2 id="容器化-Slave"><a href="#容器化-Slave" class="headerlink" title="容器化 Slave"></a>容器化 Slave</h2><p>Jenkins 的 Master-Slave 架构实现了分布式构建，可以充分的横向扩展 Slave 来提升构建能力，将 Slave 容器化是目前主流的构建环境标准化、集群化和弹性化的方式。</p><ol><li><a href="https://plugins.jenkins.io/docker-plugin" target="_blank" rel="noopener">https://plugins.jenkins.io/docker-plugin</a> 这个插件可以配置 docker host ，从而动态的提供 Jenkins Agent（Slave），运行构建后再销毁这个 slave。</li><li><a href="https://plugins.jenkins.io/kubernetes" target="_blank" rel="noopener">https://plugins.jenkins.io/kubernetes</a> 这个插件支持利用 Kubernetes cluster 动态的提供 Jenkins Agent（Slave），利用 Kubernetes 调度机制来优化 Jenkins 负载等。</li></ol><h2 id="Admin-相关插件"><a href="#Admin-相关插件" class="headerlink" title="Admin 相关插件"></a>Admin 相关插件</h2><ol><li>Configuration Slicing <a href="https://plugins.jenkins.io/configurationslicing" target="_blank" rel="noopener">https://plugins.jenkins.io/configurationslicing</a> 这个插件支持批量修改项目配置</li><li>Mask Passwords <a href="https://plugins.jenkins.io/mask-passwords" target="_blank" rel="noopener">https://plugins.jenkins.io/mask-passwords</a> 这个插件支持遮挡构建 log 输出的 password 等敏感信息</li><li>Backup <a href="https://plugins.jenkins.io/backup" target="_blank" rel="noopener">https://plugins.jenkins.io/backup</a> 这个插件添加备份功能到 Jenkins management</li></ol><h2 id="个人推荐的通用插件"><a href="#个人推荐的通用插件" class="headerlink" title="个人推荐的通用插件"></a>个人推荐的通用插件</h2><table><thead><tr><th>Name</th><th>Link</th></tr></thead><tbody><tr><td>Google Login Plugin</td><td><a href="https://plugins.jenkins.io/google-login" target="_blank" rel="noopener">https://plugins.jenkins.io/google-login</a></td></tr><tr><td>Role-based Authorization Strategy</td><td><a href="https://plugins.jenkins.io/role-strategy" target="_blank" rel="noopener">https://plugins.jenkins.io/role-strategy</a></td></tr><tr><td>Periodic Backup</td><td><a href="https://plugins.jenkins.io/periodicbackup" target="_blank" rel="noopener">https://plugins.jenkins.io/periodicbackup</a></td></tr><tr><td>Notification</td><td><a href="https://plugins.jenkins.io/notification" target="_blank" rel="noopener">https://plugins.jenkins.io/notification</a></td></tr><tr><td>Git Parameter</td><td><a href="https://plugins.jenkins.io/git-parameter" target="_blank" rel="noopener">https://plugins.jenkins.io/git-parameter</a></td></tr><tr><td>AnsiColor</td><td><a href="https://plugins.jenkins.io/ansicolor" target="_blank" rel="noopener">https://plugins.jenkins.io/ansicolor</a></td></tr><tr><td>SSH Agent</td><td><a href="https://plugins.jenkins.io/git-parameter" target="_blank" rel="noopener">https://plugins.jenkins.io/git-parameter</a></td></tr><tr><td>Build Name and Description Setter</td><td><a href="https://plugins.jenkins.io/build-name-setter" target="_blank" rel="noopener">https://plugins.jenkins.io/build-name-setter</a></td></tr><tr><td>Publish Over SSH</td><td><a href="https://plugins.jenkins.io/publish-over-ssh" target="_blank" rel="noopener">https://plugins.jenkins.io/publish-over-ssh</a></td></tr><tr><td>user build vars</td><td><a href="https://plugins.jenkins.io/build-user-vars-plugin" target="_blank" rel="noopener">https://plugins.jenkins.io/build-user-vars-plugin</a></td></tr><tr><td>Throttle Concurrent Builds</td><td><a href="https://plugins.jenkins.io/throttle-concurrents" target="_blank" rel="noopener">https://plugins.jenkins.io/throttle-concurrents</a></td></tr><tr><td>Active Choices</td><td><a href="https://plugins.jenkins.io/uno-choice" target="_blank" rel="noopener">https://plugins.jenkins.io/uno-choice</a></td></tr><tr><td>Rebuilder</td><td><a href="https://plugins.jenkins.io/rebuild" target="_blank" rel="noopener">https://plugins.jenkins.io/rebuild</a></td></tr></tbody></table><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://www.jianshu.com/p/a80ed9285537" target="_blank" rel="noopener">Jenkins 自动化部署 - 安装篇 (一)</a></p><p><a href="https://www.cnblogs.com/zndxall/p/8603500.html" target="_blank" rel="noopener">jenkins 常用插件和配置项介绍和使用</a></p>]]></content>
    
    <summary type="html">
    
      Jenkins Plugins常用插件推荐
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>通俗易懂 QPS、TPS、PV、UV、GMV、IP、RPS 的概念解释</title>
    <link href="https://wsgzao.github.io/post/qps/"/>
    <id>https://wsgzao.github.io/post/qps/</id>
    <published>2019-12-09T06:59:49.000Z</published>
    <updated>2019-12-09T08:17:45.141Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>关于 QPS、TPS、PV、UV、GMV、IP、RPS 这些词语，看起来好像挺专业。但实际上，我认为是这是每个程序员必懂的知识点了，你可以搞不懂它们怎么计算的，但是你最少要了解它们分别代表什么意思。</p><blockquote><p>通俗易懂 QPS、TPS、PV、UV、GMV、IP、RPS 的概念解释</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 12 月 09 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/qps/">https://wsgzao.github.io/post/qps/</a></p><p><strong> 扩展阅读 </strong></p><hr><h2 id="QPS"><a href="#QPS" class="headerlink" title="QPS"></a>QPS</h2><p>Queries Per Second，每秒查询数。每秒能够响应的查询次数。</p><p>QPS 是对一个特定的查询服务器在规定时间内所处理流量多少的衡量标准，在因特网上，作为域名系统服务器的机器的性能经常用每秒查询率来衡量。每秒的响应请求数，也即是最大吞吐能力。</p><h2 id="TPS"><a href="#TPS" class="headerlink" title="TPS"></a>TPS</h2><p>Transactions Per Second 的缩写，每秒处理的事务数目。一个事务是指一个客户机向服务器发送请求然后服务器做出反应的过程。客户机在发送请求时开始计时，收到服务器响应后结束计时，以此来计算使用的时间和完成的事务个数，最终利用这些信息作出的评估分。</p><p>TPS 的过程包括：客户端请求服务端、服务端内部处理、服务端返回客户端。</p><p>例如，访问一个 Index 页面会请求服务器 3 次，包括一次 html，一次 css，一次 js，那么访问这一个页面就会产生一个 “T”，产生三个 “Q”。</p><h2 id="PV"><a href="#PV" class="headerlink" title="PV"></a>PV</h2><p>Page View 即页面浏览量，通常是衡量一个网络新闻频道或网站甚至一条网络新闻的主要指标。户每一次对网站中的每个页面访问均被记录 1 次。用户对同一页面的多次刷新，访问量累计。</p><p>根据这个特性，刷网站的 PV 就很好刷了。</p><p>与 PV 相关的还有 <strong>RV</strong>，即重复访问者数量 Repeat Visitors。</p><h2 id="UV"><a href="#UV" class="headerlink" title="UV"></a>UV</h2><p>访问数（Unique Visitor）指独立访客访问数，统计 1 天内访问某站点的用户数 (以 cookie 为依据)，一台电脑终端为一个访客。</p><h2 id="IP"><a href="#IP" class="headerlink" title="IP"></a>IP</h2><p>（Internet Protocol）独立 IP 数，是指 1 天内多少个独立的 IP 浏览了页面，即统计不同的 IP 浏览用户数量。同一 IP 不管访问了几个页面，独立 IP 数均为 1；不同的 IP 浏览页面，计数会加 1。IP 是基于用户广域网 IP 地址来区分不同的访问者的，所以，多个用户（多个局域网 IP）在同一个路由器（同一个广域网 IP）内上网，可能被记录为一个独立 IP 访问者。如果用户不断更换 IP，则有可能被多次统计。</p><h2 id="GMV"><a href="#GMV" class="headerlink" title="GMV"></a>GMV</h2><p>是 Gross Merchandise Volume 的简称。只要是订单，不管消费者是否付款、卖家是否发货、是否退货，都可放进 GMV 。</p><h2 id="RPS"><a href="#RPS" class="headerlink" title="RPS"></a>RPS</h2><p>代表吞吐率，即 Requests Per Second 的缩写。吞吐率是服务器并发处理能力的量化描述，单位是 reqs/s，指的是某个并发用户数下单位时间内处理的请求数。<br>某个并发用户数下单位时间内能处理的最大的请求数，称之为最大吞吐率。</p><blockquote><p>有人把 RPS 说等效于 QPS。其实可以看作同一个统计方式，只是叫法不同而已。RPS/QPS，可以使用 apche ab 工具进行测量。</p></blockquote>]]></content>
    
    <summary type="html">
    
      通俗易懂 QPS、TPS、PV、UV、GMV、IP、RPS的概念解释
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>rsync 安装配置实践</title>
    <link href="https://wsgzao.github.io/post/rsync/"/>
    <id>https://wsgzao.github.io/post/rsync/</id>
    <published>2019-12-01T06:59:49.000Z</published>
    <updated>2019-12-04T06:59:05.885Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Rsync 代表 “remote sync”，它是本地和远程主机文件同步工具。它只同步更改的文件，以此实现最小化传输数据。rsync 的使用场景非常丰富，相信大家会经常使用，这里做下简单的总结。</p><blockquote><p>rsync 安装配置实践</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 12 月 01 日 - 更新 rsync 常见错误和 lsyncd+rsync 实时同步方案<br>2019 年 05 月 23 日 - 更新 rsync 中文帮助和相关实践配置<br>2019 年 03 月 01 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/rsync/">https://wsgzao.github.io/post/rsync/</a></p><p><strong> 扩展阅读 </strong></p><p>rsync - <a href="https://www.samba.org/rsync/" target="_blank" rel="noopener">https://www.samba.org/rsync/</a></p><hr><h2 id="rsync-简介"><a href="#rsync-简介" class="headerlink" title="rsync 简介"></a>rsync 简介</h2><p>rsync is a file transfer program capable of efficient remote update via a fast differencing algorithm.</p><p>rsync 是类 unix 系统下的数据镜像备份工具，从软件的命名上就可以看出来了 ——remote sync。它的特性如下：</p><ol><li>可以镜像保存整个目录树和文件系统</li><li>可以很容易做到保持原来文件的权限、时间、软硬链接等等</li><li>无须特殊权限即可安装</li><li>优化的流程，文件传输效率高</li><li>可以使用 rsh、ssh 等方式来传输文件，当然也可以通过直接的 socket 连接</li><li>支持匿名传输</li></ol><p>在使用 rsync 进行远程同步时，可以使用两种方式：远程 Shell 方式（用户验证由 ssh 负责）和 C/S 方式（即客户连接远程 rsync 服务器，用户验证由 rsync 服务器负责）。</p><p>无论本地同步目录还是远程同步数据，首次运行时将会把全部文件拷贝一次，以后再运行时将只拷贝有变化的文件（对于新文件）或文件的变化部分（对于原有文件）。</p><h2 id="rsync-源配置文件示例"><a href="#rsync-源配置文件示例" class="headerlink" title="rsync 源配置文件示例"></a>rsync 源配置文件示例</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑 rsync 配置文件 </span></span><br><span class="line">vim /etc/rsync.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># /etc/rsyncd: configuration file for rsync daemon mode</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># See rsyncd.conf man page for more options.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># configuration example:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># uid = nobody</span></span><br><span class="line"><span class="comment"># gid = nobody</span></span><br><span class="line"><span class="comment"># use chroot = yes</span></span><br><span class="line"><span class="comment"># max connections = 4</span></span><br><span class="line"><span class="comment"># pid file = /var/run/rsyncd.pid</span></span><br><span class="line"><span class="comment"># exclude = lost+found/</span></span><br><span class="line"><span class="comment"># transfer logging = yes</span></span><br><span class="line"><span class="comment"># timeout = 900</span></span><br><span class="line"><span class="comment"># ignore nonreadable = yes</span></span><br><span class="line"><span class="comment"># dont compress   = *.gz *.tgz *.zip *.z *.Z *.rpm *.deb *.bz2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [ftp]</span></span><br><span class="line"><span class="comment">#        path = /home/ftp</span></span><br><span class="line"><span class="comment">#        comment = ftp export area</span></span><br></pre></td></tr></table></figure><p>rsyncd.conf 官方文档请参考 - <a href="https://www.samba.org/ftp/rsync/rsyncd.conf.html" target="_blank" rel="noopener">https://www.samba.org/ftp/rsync/rsyncd.conf.html</a></p><h2 id="rsync-常用参数"><a href="#rsync-常用参数" class="headerlink" title="rsync 常用参数"></a>rsync 常用参数</h2><p>注: 在指定复制源时，路径是否有最后的 “/” 有不同的含义，例如：</p><p>/data  表示将整个 /data 目录复制到目标目录<br>/data/ 表示将 /data/ 目录中的所有内容复制到目标目录</p><p>man rsync 翻译 (rsync 命令中文手册)<br><a href="http://www.cnblogs.com/f-ck-need-u/p/7221713.html" target="_blank" rel="noopener">http://www.cnblogs.com/f-ck-need-u/p/7221713.html</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">rsync is a file transfer program capable of efficient remote update via a fast differencing algorithm.</span><br><span class="line"></span><br><span class="line">Usage: rsync [OPTION]... SRC [SRC]... DEST</span><br><span class="line">  or   rsync [OPTION]... SRC [SRC]... [USER@]HOST:DEST</span><br><span class="line">  or   rsync [OPTION]... SRC [SRC]... [USER@]HOST::DEST</span><br><span class="line">  or   rsync [OPTION]... SRC [SRC]... rsync://[USER@]HOST[:PORT]/DEST</span><br><span class="line">  or   rsync [OPTION]... [USER@]HOST:SRC [DEST]</span><br><span class="line">  or   rsync [OPTION]... [USER@]HOST::SRC [DEST]</span><br><span class="line">  or   rsync [OPTION]... rsync://[USER@]HOST[:PORT]/SRC [DEST]</span><br><span class="line">The <span class="string">':'</span> usages connect via remote shell, <span class="keyword">while</span> <span class="string">'::'</span> &amp; <span class="string">'rsync://'</span> usages connect</span><br><span class="line">to an rsync daemon, and require SRC or DEST to start with a module name.</span><br><span class="line"></span><br><span class="line">Options</span><br><span class="line"> -v, --verbose               increase verbosity</span><br><span class="line">     --info=FLAGS            fine-grained informational verbosity</span><br><span class="line">     --debug=FLAGS           fine-grained debug verbosity</span><br><span class="line">     --msgs2stderr           special output handling <span class="keyword">for</span> debugging</span><br><span class="line"> -q, --quiet                 suppress non-error messages</span><br><span class="line">     --no-motd               suppress daemon-mode MOTD (see manpage caveat)</span><br><span class="line"> -c, --checksum              skip based on checksum, not mod-time &amp; size</span><br><span class="line"> -a, --archive               archive mode; equals -rlptgoD (no -H,-A,-X)</span><br><span class="line">     --no-OPTION             turn off an implied OPTION (e.g. --no-D)</span><br><span class="line"> -r, --recursive             recurse into directories</span><br><span class="line"> -R, --relative              use relative path names</span><br><span class="line">     --no-implied-dirs       don<span class="string">'t send implied dirs with --relative</span></span><br><span class="line"><span class="string"> -b, --backup                make backups (see --suffix &amp; --backup-dir)</span></span><br><span class="line"><span class="string">     --backup-dir=DIR        make backups into hierarchy based in DIR</span></span><br><span class="line"><span class="string">     --suffix=SUFFIX         set backup suffix (default ~ w/o --backup-dir)</span></span><br><span class="line"><span class="string"> -u, --update                skip files that are newer on the receiver</span></span><br><span class="line"><span class="string">     --inplace               update destination files in-place (SEE MAN PAGE)</span></span><br><span class="line"><span class="string">     --append                append data onto shorter files</span></span><br><span class="line"><span class="string">     --append-verify         like --append, but with old data in file checksum</span></span><br><span class="line"><span class="string"> -d, --dirs                  transfer directories without recursing</span></span><br><span class="line"><span class="string"> -l, --links                 copy symlinks as symlinks</span></span><br><span class="line"><span class="string"> -L, --copy-links            transform symlink into referent file/dir</span></span><br><span class="line"><span class="string">     --copy-unsafe-links     only"unsafe"symlinks are transformed</span></span><br><span class="line"><span class="string">     --safe-links            ignore symlinks that point outside the source tree</span></span><br><span class="line"><span class="string">     --munge-links           munge symlinks to make them safer (but unusable)</span></span><br><span class="line"><span class="string"> -k, --copy-dirlinks         transform symlink to a dir into referent dir</span></span><br><span class="line"><span class="string"> -K, --keep-dirlinks         treat symlinked dir on receiver as dir</span></span><br><span class="line"><span class="string"> -H, --hard-links            preserve hard links</span></span><br><span class="line"><span class="string"> -p, --perms                 preserve permissions</span></span><br><span class="line"><span class="string"> -E, --executability         preserve the file'</span>s executability</span><br><span class="line">     --chmod=CHMOD           affect file and/or directory permissions</span><br><span class="line"> -A, --acls                  preserve ACLs (implies --perms)</span><br><span class="line"> -X, --xattrs                preserve extended attributes</span><br><span class="line"> -o, --owner                 preserve owner (super-user only)</span><br><span class="line"> -g, --group                 preserve group</span><br><span class="line">     --devices               preserve device files (super-user only)</span><br><span class="line">     --copy-devices          copy device contents as regular file</span><br><span class="line">     --specials              preserve special files</span><br><span class="line"> -D                          same as --devices --specials</span><br><span class="line"> -t, --<span class="built_in">times</span>                 preserve modification <span class="built_in">times</span></span><br><span class="line"> -O, --omit-dir-times        omit directories from --<span class="built_in">times</span></span><br><span class="line"> -J, --omit-link-times       omit symlinks from --<span class="built_in">times</span></span><br><span class="line">     --super                 receiver attempts super-user activities</span><br><span class="line">     --fake-super            store/recover privileged attrs using xattrs</span><br><span class="line"> -S, --sparse                handle sparse files efficiently</span><br><span class="line">     --preallocate           allocate dest files before writing them</span><br><span class="line"> -n, --dry-run               perform a trial run with no changes made</span><br><span class="line"> -W, --whole-file            copy files whole (without delta-xfer algorithm)</span><br><span class="line"> -x, --one-file-system       don<span class="string">'t cross filesystem boundaries</span></span><br><span class="line"><span class="string"> -B, --block-size=SIZE       force a fixed checksum block-size</span></span><br><span class="line"><span class="string"> -e, --rsh=COMMAND           specify the remote shell to use</span></span><br><span class="line"><span class="string">     --rsync-path=PROGRAM    specify the rsync to run on the remote machine</span></span><br><span class="line"><span class="string">     --existing              skip creating new files on receiver</span></span><br><span class="line"><span class="string">     --ignore-existing       skip updating files that already exist on receiver</span></span><br><span class="line"><span class="string">     --remove-source-files   sender removes synchronized files (non-dirs)</span></span><br><span class="line"><span class="string">     --del                   an alias for --delete-during</span></span><br><span class="line"><span class="string">     --delete                delete extraneous files from destination dirs</span></span><br><span class="line"><span class="string">     --delete-before         receiver deletes before transfer, not during</span></span><br><span class="line"><span class="string">     --delete-during         receiver deletes during the transfer</span></span><br><span class="line"><span class="string">     --delete-delay          find deletions during, delete after</span></span><br><span class="line"><span class="string">     --delete-after          receiver deletes after transfer, not during</span></span><br><span class="line"><span class="string">     --delete-excluded       also delete excluded files from destination dirs</span></span><br><span class="line"><span class="string">     --ignore-missing-args   ignore missing source args without error</span></span><br><span class="line"><span class="string">     --delete-missing-args   delete missing source args from destination</span></span><br><span class="line"><span class="string">     --ignore-errors         delete even if there are I/O errors</span></span><br><span class="line"><span class="string">     --force                 force deletion of directories even if not empty</span></span><br><span class="line"><span class="string">     --max-delete=NUM        don'</span>t delete more than NUM files</span><br><span class="line">     --max-size=SIZE         don<span class="string">'t transfer any file larger than SIZE</span></span><br><span class="line"><span class="string">     --min-size=SIZE         don'</span>t transfer any file smaller than SIZE</span><br><span class="line">     --partial               keep partially transferred files</span><br><span class="line">     --partial-dir=DIR       put a partially transferred file into DIR</span><br><span class="line">     --delay-updates         put all updated files into place at transfer<span class="string">'s end</span></span><br><span class="line"><span class="string"> -m, --prune-empty-dirs      prune empty directory chains from the file-list</span></span><br><span class="line"><span class="string">     --numeric-ids           don'</span>t map uid/gid values by user/group name</span><br><span class="line">     --usermap=STRING        custom username mapping</span><br><span class="line">     --groupmap=STRING       custom groupname mapping</span><br><span class="line">     --chown=USER:GROUP      simple username/groupname mapping</span><br><span class="line">     --timeout=SECONDS       <span class="built_in">set</span> I/O timeout <span class="keyword">in</span> seconds</span><br><span class="line">     --contimeout=SECONDS    <span class="built_in">set</span> daemon connection timeout <span class="keyword">in</span> seconds</span><br><span class="line"> -I, --ignore-times          don<span class="string">'t skip files that match in size and mod-time</span></span><br><span class="line"><span class="string"> -M, --remote-option=OPTION  send OPTION to the remote side only</span></span><br><span class="line"><span class="string">     --size-only             skip files that match in size</span></span><br><span class="line"><span class="string">     --modify-window=NUM     compare mod-times with reduced accuracy</span></span><br><span class="line"><span class="string"> -T, --temp-dir=DIR          create temporary files in directory DIR</span></span><br><span class="line"><span class="string"> -y, --fuzzy                 find similar file for basis if no dest file</span></span><br><span class="line"><span class="string">     --compare-dest=DIR      also compare destination files relative to DIR</span></span><br><span class="line"><span class="string">     --copy-dest=DIR         ... and include copies of unchanged files</span></span><br><span class="line"><span class="string">     --link-dest=DIR         hardlink to files in DIR when unchanged</span></span><br><span class="line"><span class="string"> -z, --compress              compress file data during the transfer</span></span><br><span class="line"><span class="string">     --compress-level=NUM    explicitly set compression level</span></span><br><span class="line"><span class="string">     --skip-compress=LIST    skip compressing files with a suffix in LIST</span></span><br><span class="line"><span class="string"> -C, --cvs-exclude           auto-ignore files the same way CVS does</span></span><br><span class="line"><span class="string"> -f, --filter=RULE           add a file-filtering RULE</span></span><br><span class="line"><span class="string"> -F                          same as --filter='</span>dir-merge /.rsync-filter<span class="string">'</span></span><br><span class="line"><span class="string">                             repeated: --filter='</span>- .rsync-filter<span class="string">'</span></span><br><span class="line"><span class="string">     --exclude=PATTERN       exclude files matching PATTERN</span></span><br><span class="line"><span class="string">     --exclude-from=FILE     read exclude patterns from FILE</span></span><br><span class="line"><span class="string">     --include=PATTERN       don'</span>t exclude files matching PATTERN</span><br><span class="line">     --include-from=FILE     <span class="built_in">read</span> include patterns from FILE</span><br><span class="line">     --files-from=FILE       <span class="built_in">read</span> list of <span class="built_in">source</span>-file names from FILE</span><br><span class="line"> -0, --from0                 all *-from/filter files are delimited by 0s</span><br><span class="line"> -s, --protect-args          no space-splitting; only wildcard special-chars</span><br><span class="line">     --address=ADDRESS       <span class="built_in">bind</span> address <span class="keyword">for</span> outgoing socket to daemon</span><br><span class="line">     --port=PORT             specify double-colon alternate port number</span><br><span class="line">     --sockopts=OPTIONS      specify custom TCP options</span><br><span class="line">     --blocking-io           use blocking I/O <span class="keyword">for</span> the remote shell</span><br><span class="line">     --stats                 give some file-transfer stats</span><br><span class="line"> -8, --8-bit-output          leave high-bit chars unescaped <span class="keyword">in</span> output</span><br><span class="line"> -h, --human-readable        output numbers <span class="keyword">in</span> a human-readable format</span><br><span class="line">     --progress              show progress during transfer</span><br><span class="line"> -P                          same as --partial --progress</span><br><span class="line"> -i, --itemize-changes       output a change-summary <span class="keyword">for</span> all updates</span><br><span class="line">     --out-format=FORMAT     output updates using the specified FORMAT</span><br><span class="line">     --<span class="built_in">log</span>-file=FILE         <span class="built_in">log</span> what we<span class="string">'re doing to the specified FILE</span></span><br><span class="line"><span class="string">     --log-file-format=FMT   log updates using the specified FMT</span></span><br><span class="line"><span class="string">     --password-file=FILE    read daemon-access password from FILE</span></span><br><span class="line"><span class="string">     --list-only             list the files instead of copying them</span></span><br><span class="line"><span class="string">     --bwlimit=RATE          limit socket I/O bandwidth</span></span><br><span class="line"><span class="string">     --outbuf=N|L|B          set output buffering to None, Line, or Block</span></span><br><span class="line"><span class="string">     --write-batch=FILE      write a batched update to FILE</span></span><br><span class="line"><span class="string">     --only-write-batch=FILE like --write-batch but w/o updating destination</span></span><br><span class="line"><span class="string">     --read-batch=FILE       read a batched update from FILE</span></span><br><span class="line"><span class="string">     --protocol=NUM          force an older protocol version to be used</span></span><br><span class="line"><span class="string">     --iconv=CONVERT_SPEC    request charset conversion of filenames</span></span><br><span class="line"><span class="string">     --checksum-seed=NUM     set block/file checksum seed (advanced)</span></span><br><span class="line"><span class="string"> -4, --ipv4                  prefer IPv4</span></span><br><span class="line"><span class="string"> -6, --ipv6                  prefer IPv6</span></span><br><span class="line"><span class="string">     --version               print version number</span></span><br><span class="line"><span class="string">(-h) --help                  show this help (-h is --help only if used alone)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Use"rsync --daemon --help"to see the daemon-mode command-line options.</span></span><br><span class="line"><span class="string">Please see the rsync(1) and rsyncd.conf(5) man pages for full documentation.</span></span><br><span class="line"><span class="string">See http://rsync.samba.org/ for updates, bug reports, and answers</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rsync 常用参数 </span></span><br><span class="line">-v : 展示详细的同步信息 </span><br><span class="line">-a : 归档模式，相当于 -rlptgoD</span><br><span class="line">    -r : 递归目录 </span><br><span class="line">    -l : 同步软连接文件 </span><br><span class="line">    -p : 保留权限 </span><br><span class="line">    -t : 将源文件的 < span class="string">"modify time"</span> 同步到目标机器 <br><span class="line">    -g : 保持文件属组 </span><br><span class="line">    -o : 保持文件属主 </span><br><span class="line">    -D : 和 --devices --specials 一样，保持设备文件和特殊文件 </span><br><span class="line">-z : 发送数据前，先压缩再传输 </span><br><span class="line">-H : 保持硬链接 </span><br><span class="line">-n : 进行试运行，不作任何更改 </span><br><span class="line">-P same as --partial --progress</span><br><span class="line">    --partial : 支持断点续传 </span><br><span class="line">    --progress : 展示传输的进度 </span><br><span class="line">--delete : 如果源文件消失，目标文件也会被删除 </span><br><span class="line">--delete-excluded : 指定要在目的端删除的文件 </span><br><span class="line">--delete-after : 默认情况下，rsync 是先清理目的端的文件再开始数据同步；如果使用此选项，则 rsync 会先进行数据同步，都完成后再删除那些需要清理的文件。</span><br><span class="line">--exclude=PATTERN : 排除匹配 PATTERN 的文件 </span><br><span class="line">--exclude-from=FILE : 如果要排除的文件很多，可以统一写在某一文件中 </span><br><span class="line">-e ssh : 使用 SSH 加密隧道传输 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 远程 Shell 方式 </span></span><br><span class="line">rsync [OPTION]... SRC [SRC]... [USER@]HOST:DEST <span class="comment"># 执行 “推” 操作 </span></span><br><span class="line">or   rsync [OPTION]... [USER@]HOST:SRC [DEST]   <span class="comment"># 执行 “拉” 操作 </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 远程 C/S 方式 </span></span><br><span class="line">rsync [OPTION]... SRC [SRC]... [USER@]HOST::DEST                    <span class="comment"># 执行 “推” 操作 </span></span><br><span class="line">or   rsync [OPTION]... SRC [SRC]... rsync://[USER@]HOST[:PORT]/DEST <span class="comment"># 执行 “推” 操作 </span></span><br><span class="line">or   rsync [OPTION]... [USER@]HOST::SRC [DEST]                      <span class="comment"># 执行 “拉” 操作 </span></span><br><span class="line">or   rsync [OPTION]... rsync://[USER@]HOST[:PORT]/SRC [DEST]        <span class="comment"># 执行 “拉” 操作 </span></span><br></pre></td></tr></table></figure><h2 id="rsync-同步方式"><a href="#rsync-同步方式" class="headerlink" title="rsync 同步方式"></a>rsync 同步方式</h2><p>Rsync 远程同步主要有两种方式：使用远程 shell（ssh 或 rsh） 或使用 rsync 的 daemon 方式</p><p>rsync 命令和 ssh，scp 命令有点相似。</p><p>我们创建两个测试目录和一些文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mkdir dir1</span><br><span class="line">mkdir dir2</span><br><span class="line">touch dir1/somefile&#123;1..100&#125;</span><br><span class="line"><span class="comment"># dir1 中有 100 文件，dir2 中为空。使用 rsync 把 dir1 内容同步到 dir2，-r 选项代表递归，在同步目录时使用。</span></span><br><span class="line">rsync -r dir1/ dir2</span><br><span class="line"><span class="comment"># 你也可以使用 -a 选项，代表同步所有，包括修改时间、群组、权限、特殊文件、也包括递归。</span></span><br><span class="line">rsync -anv dir1/ dir2</span><br><span class="line"><span class="comment"># 注意上面的 dir1 / 中的 “/” 不能少，它代表同步目录下文件， 如果没有 “/” 代表同步这个目录。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 和远程主机进行同步目录首先，你要确保有远程主机的 SSH 访问权限 </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 把本地目录同步到远程主机：</span></span><br><span class="line">rsync -a dir1/ root@linux:~/dir2</span><br><span class="line"><span class="comment"># 把远程主机目录同步到本地：</span></span><br><span class="line">rsync -a root@linux:~/dir2/ dir1</span><br></pre></td></tr></table></figure><h3 id="本地文件同步"><a href="#本地文件同步" class="headerlink" title="本地文件同步"></a>本地文件同步</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果没有 desc 目录，会自动创建 </span></span><br><span class="line">rsync -avH /opt/resource/ /tmp/desc/</span><br></pre></td></tr></table></figure><h3 id="远程文件同步-–shell-方式"><a href="#远程文件同步-–shell-方式" class="headerlink" title="远程文件同步 –shell 方式"></a>远程文件同步 –shell 方式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从本地传到远端，目标文件会被写成 ssh 登录用户的属组和属主（如下 www）</span></span><br><span class="line">rsync -avH /opt/nginx-1.12.1/ www@172.18.50.125:/tmp/nginx/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 ssh 加密隧道方式传输，保障数据的安全性 </span></span><br><span class="line">rsync -avHe ssh /opt/nginx-1.12.1/ www@172.18.50.125:/tmp/nginx/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从远端传到本地，只要对目标文件有读的权限，就可以同步到本地 </span></span><br><span class="line">rsync -avH www@172.18.50.125:/tmp/nginx/ /tmp/nginx/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果远程服务器 ssh 端口不是默认的 22</span></span><br><span class="line">rsync -avHe <span class="string">"ssh -p 11222"</span> /opt/nginx-1.12.1/ www@172.18.50.125:/tmp/nginx/</span><br></pre></td></tr></table></figure><h3 id="远程文件同步-–daemon-方式"><a href="#远程文件同步-–daemon-方式" class="headerlink" title="远程文件同步 –daemon 方式"></a>远程文件同步 –daemon 方式</h3><blockquote><p>rsync 服务端配置</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 rsync 服务的目录和配置文件 (可选)</span></span><br><span class="line">mkdir /etc/rsync </span><br><span class="line"><span class="built_in">cd</span> /etc/rsync</span><br><span class="line">touch rsyncd.conf</span><br><span class="line">touch rsyncd.secrets</span><br><span class="line">touch rsyncd.motd</span><br><span class="line">chmod 600 rsyncd.secrets</span><br><span class="line"></span><br><span class="line"><span class="comment">### rsyncd.conf 文件的配置 </span></span><br><span class="line">vim /etc/rsync/rsyncd.conf</span><br><span class="line"><span class="comment"># /etc/rsyncd: configuration file for rsync daemon mode</span></span><br><span class="line"><span class="comment"># See rsyncd.conf man page for more options.</span></span><br><span class="line"><span class="comment"># 传输文件使用的用户和用户组，如果是从服务器 =&gt; 客户端，要保证 www 用户对文件有读取的权限；如果是从客户端 =&gt; 服务端，要保证 www 对文件有写权限。</span></span><br><span class="line">uid = www</span><br><span class="line">gid = www</span><br><span class="line"><span class="comment"># 允许 chroot，提升安全性，客户端连接模块，首先 chroot 到模块 path 参数指定的目录下，chroot 为 yes 时必须使用 root 权限，且不能备份 path 路径外的链接文件 </span></span><br><span class="line">use chroot = yes</span><br><span class="line"><span class="comment"># 只读 </span></span><br><span class="line"><span class="built_in">read</span> only = no</span><br><span class="line"><span class="comment"># 只写 </span></span><br><span class="line">write only = no</span><br><span class="line"><span class="comment"># 设定白名单，可以指定 IP 段（172.18.50.1/255.255.255.0）, 各个 Ip 段用空格分开 </span></span><br><span class="line">hosts allow = 172.18.50.110 172.18.50.111</span><br><span class="line">hosts deny = *</span><br><span class="line"><span class="comment"># 允许的客户端最大连接数 </span></span><br><span class="line">max connections = 4</span><br><span class="line"><span class="comment"># 欢迎文件的路径，非必须 </span></span><br><span class="line">motd file = /etc/rsync/rsyncd.motd</span><br><span class="line"><span class="comment"># pid 文件路径 </span></span><br><span class="line">pid file = /var/run/rsyncd.pid</span><br><span class="line"><span class="comment"># 记录传输文件日志 </span></span><br><span class="line">transfer logging = yes</span><br><span class="line"><span class="comment"># 日志文件格式 </span></span><br><span class="line"><span class="built_in">log</span> format = %t %a %m %f %b</span><br><span class="line"><span class="comment"># 指定日志文件 </span></span><br><span class="line"><span class="built_in">log</span> file = /var/<span class="built_in">log</span>/rsync.log</span><br><span class="line"><span class="comment"># 剔除某些文件或目录，不同步 </span></span><br><span class="line">exclude = lost+found/</span><br><span class="line"><span class="comment"># 设置超时时间 </span></span><br><span class="line">timeout = 900</span><br><span class="line">ignore nonreadable = yes</span><br><span class="line"><span class="comment"># 设置不需要压缩的文件 </span></span><br><span class="line">dont compress   = *.gz *.tgz *.zip *.z *.Z *.rpm *.deb *.bz2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模块，可以配置多个，使用如: sate@172.18.50.125::125to110</span></span><br><span class="line">[125to110]</span><br><span class="line"><span class="comment"># 模块的根目录，同步目录，要注意权限 </span></span><br><span class="line">path = /tmp/nginx</span><br><span class="line"><span class="comment"># 是否允许列出模块内容 </span></span><br><span class="line">list = no</span><br><span class="line"><span class="comment"># 忽略错误 </span></span><br><span class="line">ignore errors</span><br><span class="line"><span class="comment"># 添加注释 </span></span><br><span class="line">comment = ftp <span class="built_in">export</span> area</span><br><span class="line"><span class="comment"># 模块验证的用户名称，可使用空格或者逗号隔开多个用户名 </span></span><br><span class="line">auth users = sate</span><br><span class="line"><span class="comment"># 模块验证密码文件 可放在全局配置里 </span></span><br><span class="line">secrets file = /etc/rsync/rsyncd.secrets</span><br><span class="line"><span class="comment"># 剔除某些文件或目录，不同步 </span></span><br><span class="line">exclude = lost+found/ conf/ man/</span><br><span class="line"></span><br><span class="line"><span class="comment">### rsyncd.secrets 文件的配置 </span></span><br><span class="line">cat rsyncd.secrets </span><br><span class="line"><span class="comment"># 用户名: 密码 </span></span><br><span class="line">sate:111111</span><br><span class="line"></span><br><span class="line"><span class="comment">### rsync 启动 </span></span><br><span class="line">rsync --daemon --config=/etc/rsync/rsyncd.conf</span><br></pre></td></tr></table></figure><blockquote><p>rsync 客户端配置</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从 服务端 =&gt; 客户端 同步数据，会提示输入密码 </span></span><br><span class="line">rsync -avzP --delete sate@172.18.50.125::125to110 /tmp/sync/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从 客户端 =&gt; 服务端 同步数据，会提示输入密码 </span></span><br><span class="line">rsync -avzP --delete /tmp/sync/ sate@172.18.50.125::125to110</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注: 如果是 /tmp/sync，则同步 sync 目录；如果 /tmp/sync/，则同步 sync 目录下的文件 </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 免密码同步，将密码写到文件，再通过 --password-file 指定该文件，注：该文件的权限必须是 600</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"111111"</span> &gt; /tmp/secrets.file</span><br><span class="line">chmod 600 /tmp/secrets.file</span><br><span class="line">rsync -avzP --delete --password-file=/tmp/secrets.file sate@172.18.50.125::125to110 /tmp/sync/</span><br><span class="line"></span><br><span class="line"><span class="comment"># --exclude 排除文件目录时，如果有多个同名目录的情况 </span></span><br><span class="line"><span class="comment"># 目录结构 </span></span><br><span class="line">tree</span><br><span class="line">.</span><br><span class="line">├── dir1</span><br><span class="line">│   └── <span class="built_in">test</span></span><br><span class="line">│       ├── 3.file</span><br><span class="line">│       ├── 4.file</span><br><span class="line">│       └── 5.file</span><br><span class="line">├── dir2</span><br><span class="line">└── <span class="built_in">test</span></span><br><span class="line">    ├── 1.file</span><br><span class="line">    ├── 2.file</span><br><span class="line">    └── 3.file</span><br><span class="line"></span><br><span class="line"><span class="comment"># 情况一 ： 排除 /test 目录，同步其他目录（同步的是 / tmp/sync/ 下边的文件）</span></span><br><span class="line">rsync -avP --delete --password-file=/tmp/secrets.file --exclude=<span class="built_in">test</span>  /tmp/sync/ sate@172.18.50.125::125to110 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 会发现，该目录下所有 test 目录都被排除了，如果想只排除第一层目录的 test，可以如下（/ 代表所同步目录第一层）：</span></span><br><span class="line">rsync -avP --delete --password-file=/tmp/secrets.file --exclude=/<span class="built_in">test</span>/  /tmp/sync/ sate@172.18.50.125::125to110 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 情况二 ： 和情况一不同的是 同步的 /tmp/sync 这个目录（同步的是 / tmp/sync 目录本身，导致 exclude 后边的参数也会变化）</span></span><br><span class="line">rsync -avP --delete --password-file=/tmp/secrets.file --exclude=/sync/<span class="built_in">test</span>/  /tmp/sync sate@172.18.50.125::125to110</span><br></pre></td></tr></table></figure><h2 id="rsync-简化配置实践"><a href="#rsync-简化配置实践" class="headerlink" title="rsync 简化配置实践"></a>rsync 简化配置实践</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置服务端 rsyncd.conf</span></span><br><span class="line">vim /etc/rsyncd.conf</span><br><span class="line"></span><br><span class="line"><span class="built_in">read</span> only = no</span><br><span class="line">list = yes</span><br><span class="line">uid = root</span><br><span class="line">gid = root</span><br><span class="line"></span><br><span class="line">[backup]</span><br><span class="line">path= /data/</span><br><span class="line">hosts allow = 10.71.12.0/23</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置服务 </span></span><br><span class="line">systemctl start rsyncd</span><br><span class="line">systemctl <span class="built_in">enable</span> rsyncd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 rsync 客户端 </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑 backup.sh 同步脚本 </span></span><br><span class="line">vim backup.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">SOURCE=<span class="variable">$1</span></span><br><span class="line">DEST=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line">CMD=<span class="string">"rsync -ravz --bwlimit=2000 <span class="variable">$1</span> rsync://&#123;&#123;log_server_ip&#125;&#125;:873/backup/<span class="variable">$2</span>"</span></span><br><span class="line"></span><br><span class="line">PROCS=$(pgrep -f <span class="string">"&#123;&#123;log_server_ip&#125;&#125;:873/backup/<span class="variable">$2</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"x"</span> != <span class="string">"x<span class="variable">$PROCS</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">       <span class="built_in">echo</span> <span class="string">"not finished"</span></span><br><span class="line">       <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$CMD</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 crontab</span></span><br><span class="line">vim /etc/crontab</span><br><span class="line">15 * * * * root <span class="built_in">cd</span> /opt/scripts/ &amp;&amp; ./backup.sh /var/<span class="built_in">log</span>/tmp/ 10.71.12.89/$(date +\%Y-\%m)</span><br></pre></td></tr></table></figure><h2 id="rsync-有用的选项和注意事项"><a href="#rsync-有用的选项和注意事项" class="headerlink" title="rsync 有用的选项和注意事项"></a>rsync 有用的选项和注意事项</h2><p>-n 选项，方便你执行 rsync 命令前预览结果，不会真正执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ rsync -n --delete -r . machineB:/home/userB/</span><br><span class="line">deleting superman/xxx</span><br><span class="line">deleting main.c</span><br><span class="line">deleting acclink</span><br></pre></td></tr></table></figure><p>–delete 选项，如果源端没有此文件，那么目的端也别想拥有，删除之。</p><pre><code>rsync -aP --delete source dest</code></pre><p>-P 选项非常有用，它是 -progress 和 -partial 的组合。第一个选项是用来显示传输进度条，第二个选项允许断点续传和增量传输：</p><pre><code>rsync -aP source dest</code></pre><p>-z 选项，压缩传输的文件，对于已经压缩过的文件不建议添加该参数，针对大文件压缩包传输效率会降低 8 倍，且消耗 CPU</p><pre><code>rsync -az source dest</code></pre><p>–bwlimit 选项，限制传输带宽，参数值的默认单位是 KBPS，也就是每秒多少 KB</p><pre><code>rsync -avzP --bwlimit=100 source dest</code></pre><p>–remove-source-files 该选项告诉 rsync 移除 sender 端已经成功传输到 receiver 端的文件 (不包括任何目录文件)。</p><pre><code>rsync -avP --remove-source-files source dest</code></pre><p>rsync 过滤模块比较复杂，建议参考官网和 Google 实例测试<br>–exclude 选项如果只有前者可以单独使用，多个规则需要写多条<br>–include 选项通常需要配合 –exclude 同时使用<br>过滤规则比较多可以写在文件里读取，由于 rsync 不支持正则表达式，复杂的逻辑建议先使用 bash shell 过滤</p><p>Basically, first include all directories, then exclude all files.</p><pre><code>rsync -a --include=&apos;*/&apos; --exclude=&apos;*&apos; source/ destination/</code></pre><p><a href="https://rsync.samba.org/documentation.html" target="_blank" rel="noopener">https://rsync.samba.org/documentation.html</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/test_backup/gop-live-msdk_api</span><br><span class="line"><span class="built_in">cd</span> data/test_backup/</span><br><span class="line">touch -t 201912020808.20 test1202.txt</span><br><span class="line">touch -t 201912010808.20 test1201.txt</span><br><span class="line">touch -t 201911300808.20 test1130.txt</span><br><span class="line">touch -t 201911290808.20 test1129.txt</span><br><span class="line">touch -t 201911280808.20 test1128.txt</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> data/test_backup/gop-live-msdk_api</span><br><span class="line">touch gop-live-msdk_api-data-2019-12-02_00103  </span><br><span class="line">touch gop-live-msdk_api-data_current</span><br><span class="line">touch gop-live-msdk_api-error-2019-12-02_00103  </span><br><span class="line">touch gop-live-msdk_api-error_current</span><br><span class="line">touch gop-live-msdk_api-data-2019-11-30.tgz</span><br><span class="line"></span><br><span class="line">vim /data/exclude.txt</span><br><span class="line">*_0*</span><br><span class="line">*_current</span><br><span class="line"></span><br><span class="line">vim /data/rsync_backup_mirror_xxx.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">var_src=<span class="string">"/data/test_backup/"</span></span><br><span class="line">var_des=<span class="string">"rsync://xxx:873/backup/"</span></span><br><span class="line"><span class="comment">#rsync -aP --delete --exclude-from '/data/exclude.txt' $&#123;var_src&#125; $&#123;var_des&#125;</span></span><br><span class="line">rsync -aP --exclude-from <span class="string">'/data/exclude.txt'</span> <span class="variable">$&#123;var_src&#125;</span> <span class="variable">$&#123;var_des&#125;</span></span><br></pre></td></tr></table></figure><h2 id="rsync-常见错误"><a href="#rsync-常见错误" class="headerlink" title="rsync 常见错误"></a>rsync 常见错误</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rsync: failed to connect to 192.168.205.135 (192.168.205.135): No route to host (113)</span><br><span class="line">rsync error: error in socket IO (code 10) at clientserver.c(125) [Receiver=3.1.2]</span><br></pre></td></tr></table></figure><p>解决：防火墙问题，放行端口或直接关闭</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@ERROR: auth failed on module rsync_test</span><br><span class="line">rsync error: error starting client-server protocol (code 5) at main.c(1648) [Receiver=3.1.2]</span><br></pre></td></tr></table></figure><p>解决：用户名与密码问题或模块问题，检查用户名与密码是否匹配，服务器端模块是否存在</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rsync: read error: Connection reset by peer (104)</span><br><span class="line">rsync error: error in rsync protocol data stream (code 12) at io.c(759) [Receiver=3.1.2]</span><br></pre></td></tr></table></figure><p>解决：服务器端配置文件 /etc/rsyncd.conf 问题，检查配置文件参数是否出错</p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><blockquote><p>Rsync+Inotify 文件自动同步，推荐使用 lsyncd+rsync</p></blockquote><p><a href="https://wsgzao.github.io/post/sersync/">sersync 基于 rsync+inotify 实现数据实时同步</a></p><p><a href="https://www.xiebruce.top/919.html" target="_blank" rel="noopener">CentOS7 部署 lsyncd+rsync 实现服务器文件实时同步</a></p><p><a href="https://www.cnblogs.com/f-ck-need-u/p/7220009.html" target="_blank" rel="noopener">rsync (一)：基本命令和用法</a></p><p><a href="https://gist.github.com/ilife5/8c5ba280c0c4f84db78a" target="_blank" rel="noopener">Rsync(Remote Sync)：10 个实用的例子</a></p><p><a href="https://segmentfault.com/a/1190000015669114" target="_blank" rel="noopener">rsync 的使用方法</a></p>]]></content>
    
    <summary type="html">
    
      rsync安装配置实践
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>Jenkins 学习使用实践</title>
    <link href="https://wsgzao.github.io/post/jenkins/"/>
    <id>https://wsgzao.github.io/post/jenkins/</id>
    <published>2019-11-28T06:59:49.000Z</published>
    <updated>2020-01-02T09:59:56.823Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Jenkins 就不用做多余的介绍了，作为 CI/CD 首选的开源解决方案，持续集成 (Continous Intergration)/ 持续交付 (Continous Delievery)，本文只是用于记录使用 Jenkins 的一些基本操作，Jenkins 官方文档也率先支持中文，相信对大家的学习热情会有积极地促进作用。</p><blockquote><p>Jenkins 学习使用实践</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 11 月 28 日 - 更新 Jenkins 升级<br>2019 年 02 月 12 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/jenkins/">https://wsgzao.github.io/post/jenkins/</a></p><p><strong> 扩展阅读 </strong></p><p>Jenkins - <a href="https://jenkins.io/zh/" target="_blank" rel="noopener">https://jenkins.io/zh/</a></p><hr><h2 id="Jenkins-简介"><a href="#Jenkins-简介" class="headerlink" title="Jenkins 简介"></a>Jenkins 简介</h2><blockquote><p>构建伟大，无所不能</p></blockquote><p>Jenkins 是开源 CI&amp;CD 软件领导者， 提供超过 1000 个插件来支持构建、部署、自动化，满足任何项目的需要。</p><p>Jenkins 用户手册 - <a href="https://jenkins.io/zh/doc/" target="_blank" rel="noopener">https://jenkins.io/zh/doc/</a></p><p>Jenkins 训练营之基础篇 - <a href="https://ke.qq.com/course/265167" target="_blank" rel="noopener">https://ke.qq.com/course/265167</a><br>Jenkins 训练营之带你玩转 Pipeline - <a href="https://ke.qq.com/course/252785" target="_blank" rel="noopener">https://ke.qq.com/course/252785</a></p><p><a href="https://ke.qq.com/webcourse/index.html#cid=265167&amp;term_id=100312699&amp;taid=1794918372871119&amp;vid=p1423f5tn3g" target="_blank" rel="noopener">https://ke.qq.com/webcourse/index.html#cid=265167&amp;term_id=100312699&amp;taid=1794918372871119&amp;vid=p1423f5tn3g</a></p><p><a href="https://ke.qq.com/webcourse/index.html?cw_id=91852&amp;ac_type=3#cid=252785&amp;term_id=100298102&amp;taid=1707945285114737&amp;type=1024&amp;vid=w1422iqh9q1" target="_blank" rel="noopener">https://ke.qq.com/webcourse/index.html?cw_id=91852&amp;ac_type=3#cid=252785&amp;term_id=100298102&amp;taid=1707945285114737&amp;type=1024&amp;vid=w1422iqh9q1</a></p><h2 id="Jenkins-安装"><a href="#Jenkins-安装" class="headerlink" title="Jenkins 安装"></a>Jenkins 安装</h2><p>Jenkins 项目产生两个发行线，长期支持版本 (LTS) 和每周更新版本。 根据你的组织需求，一个可能比另一个更受欢迎。<br>两个版本都以 .war 文件，原生包，安装程序，和 Docker 容器的形式分发。<br><a href="https://jenkins.io/zh/download/" target="_blank" rel="noopener">https://jenkins.io/zh/download/</a></p><p>这里推荐下载使用 LTS 长期支持版本，以 CentOS 7 作为演示环境</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Java 8</span></span><br><span class="line">yum install java</span><br><span class="line"></span><br><span class="line"><span class="comment"># Jenkins stable version</span></span><br><span class="line">sudo wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo</span><br><span class="line">sudo rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key</span><br><span class="line">yum install jenkins</span><br><span class="line"></span><br><span class="line"><span class="comment"># start jenkins</span></span><br><span class="line">service jenkins start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化配置向导 </span></span><br><span class="line">http://192.168.56.103:8080/</span><br><span class="line"></span><br><span class="line">cat /var/lib/jenkins/secrets/initialAdminPassword</span><br><span class="line">5224fc83b6d84cc2be69a18c53309ea4</span><br><span class="line"></span><br><span class="line">Install suggested plugins</span><br><span class="line"></span><br><span class="line"> 是否创建管理员账户或者跳过</span><br></pre></td></tr></table></figure><h2 id="Jenkins-升级"><a href="#Jenkins-升级" class="headerlink" title="Jenkins 升级"></a>Jenkins 升级</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份 jenkins.war</span></span><br><span class="line"><span class="built_in">cd</span> /usr/lib/jenkins</span><br><span class="line">cp jenkins.war jenkins.war.bak</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止 jenkins 服务</span></span><br><span class="line">service jenkins stop</span><br><span class="line">rm jenkins.war</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载最新稳定版 jenkins.war，国内镜像地址可以选择清华 tuna</span></span><br><span class="line">wget http://mirrors.jenkins.io/war-stable/latest/jenkins.war</span><br><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/jenkins/war-stable/latest/jenkins.war</span><br><span class="line">service jenkins start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关于插件升级，注意版本是否兼容以及是否要求重启</span></span><br></pre></td></tr></table></figure><h2 id="Jenkins-入门"><a href="#Jenkins-入门" class="headerlink" title="Jenkins 入门"></a>Jenkins 入门</h2><h3 id="主要的-Job-类型"><a href="#主要的-Job-类型" class="headerlink" title="主要的 Job 类型"></a>主要的 Job 类型</h3><p>Freestyle project<br>自由风格项目，Jenkins 最主要的项目类型</p><p>Maven Project<br>Maven 项目专用，类似 Freestyle，更简单</p><p>Multi-configuration project<br>多配置项目，适合需要大量不同配置 (环境，平台等) 构建</p><p>Pipeline<br>流水线项目，适合使用 pipeline(workflow)插件功能构建流水线任务，或者使用 Freestyle project 不容易实现的复杂任务</p><p>Multibranch Pipeline<br>多分支流水线项目，根据 SCM 仓库中的分支创建多个 Pipeline 项目</p><h3 id="Freestyle-项目"><a href="#Freestyle-项目" class="headerlink" title="Freestyle 项目"></a>Freestyle 项目</h3><p>General<br>项目基本配置<br>项目名字，描述，参数，禁用项目，并发构建，限制构建默认 node 等等</p><p>Source code Management<br>代码库信息，支持 Git，Subversion 等</p><p>Build Triggers<br>构建触发方式<br>周期性构建，Poll SCM，远程脚本触发构建，其他项目构建结束后触发等</p><p>Build Environment<br>构建环境相关设置<br>构建前删除 workspace，向 Console 输出添加时间戳，设置构建名称，插入环境变量等</p><p>Build<br>项目构建任务<br>添加 1 个或者多个构建步骤</p><p>Post-build Actions<br>构建后行为<br>Artifact 归档，邮件通知，发布单元测试报告，触发下游项目等等</p><h3 id="规范项目必要配置"><a href="#规范项目必要配置" class="headerlink" title="规范项目必要配置"></a>规范项目必要配置</h3><p>本规范尤其适用于较多项目共用同一 Jenkins 的场景</p><ul><li>项目命名规范</li><li>设置项目描述</li><li>设置历史构建清理规则</li><li>设置构建节点 Label</li><li>邮件通知</li></ul><h3 id="常用插件"><a href="#常用插件" class="headerlink" title="常用插件"></a>常用插件</h3><blockquote><p>注意 Jenkins 备份策略，建议结合 rsync 备份远端</p></blockquote><table><thead><tr><th>Name</th><th>Link</th></tr></thead><tbody><tr><td>Google Login Plugin</td><td><a href="https://plugins.jenkins.io/google-login" target="_blank" rel="noopener">https://plugins.jenkins.io/google-login</a></td></tr><tr><td>Role-based Authorization Strategy</td><td><a href="https://plugins.jenkins.io/role-strategy" target="_blank" rel="noopener">https://plugins.jenkins.io/role-strategy</a></td></tr><tr><td>Periodic Backup</td><td><a href="https://plugins.jenkins.io/periodicbackup" target="_blank" rel="noopener">https://plugins.jenkins.io/periodicbackup</a></td></tr><tr><td>Notification</td><td><a href="https://plugins.jenkins.io/notification" target="_blank" rel="noopener">https://plugins.jenkins.io/notification</a></td></tr><tr><td>Git Parameter</td><td><a href="https://plugins.jenkins.io/git-parameter" target="_blank" rel="noopener">https://plugins.jenkins.io/git-parameter</a></td></tr><tr><td>AnsiColor</td><td><a href="https://plugins.jenkins.io/ansicolor" target="_blank" rel="noopener">https://plugins.jenkins.io/ansicolor</a></td></tr><tr><td>SSH Agent</td><td><a href="https://plugins.jenkins.io/git-parameter" target="_blank" rel="noopener">https://plugins.jenkins.io/git-parameter</a></td></tr><tr><td>Build Name and Description Setter</td><td><a href="https://plugins.jenkins.io/build-name-setter" target="_blank" rel="noopener">https://plugins.jenkins.io/build-name-setter</a></td></tr><tr><td>Publish Over SSH</td><td><a href="https://plugins.jenkins.io/publish-over-ssh" target="_blank" rel="noopener">https://plugins.jenkins.io/publish-over-ssh</a></td></tr><tr><td>user build vars</td><td><a href="https://plugins.jenkins.io/build-user-vars-plugin" target="_blank" rel="noopener">https://plugins.jenkins.io/build-user-vars-plugin</a></td></tr><tr><td>Throttle Concurrent Builds</td><td><a href="https://plugins.jenkins.io/throttle-concurrents" target="_blank" rel="noopener">https://plugins.jenkins.io/throttle-concurrents</a></td></tr><tr><td>Active Choices</td><td><a href="https://plugins.jenkins.io/uno-choice" target="_blank" rel="noopener">https://plugins.jenkins.io/uno-choice</a></td></tr><tr><td>Rebuilder</td><td><a href="https://plugins.jenkins.io/rebuild" target="_blank" rel="noopener">https://plugins.jenkins.io/rebuild</a></td></tr></tbody></table><p><a href="https://wsgzao.github.io/post/jenkins-plugins/">Jenkins Plugins 常用插件推荐</a></p><h3 id="创建第一个-Job"><a href="#创建第一个-Job" class="headerlink" title="创建第一个 Job"></a>创建第一个 Job</h3><p>安装 Timestamper 插件<br>系统管理 - 插件管理 - 可用插件，搜索到 timestamper 点击 Install without restart</p><p>新建一个 Freestyle 类型的 Job</p><ul><li>General 项目名称: My-first-freestyle-demo</li><li>Build Environment 构建环境: 勾选 Add timestamps to the Console Output</li><li>Build 构建: 屏幕打印出 “这是我的第一个 Jenkins Job, oops” </li><li>Post-build Actions 构建后操作: 无</li><li>点击立刻构建</li><li>找到控制台输出</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Console Output</span><br><span class="line">14:40:59 Started by user admin</span><br><span class="line">14:40:59 Building <span class="keyword">in</span> workspace /var/lib/jenkins/workspace/My-first-freestyle-demo</span><br><span class="line">14:41:00 [My-first-freestyle-demo] $ /bin/sh -xe /tmp/jenkins3737737887278720679.sh</span><br><span class="line">14:41:00 + <span class="built_in">echo</span> <span class="string">'这是我的第一个 Jenkins Job, oops'</span></span><br><span class="line">14:41:00 这是我的第一个 Jenkins Job, oops </span><br><span class="line">14:41:00 Finished: SUCCESS</span><br></pre></td></tr></table></figure><h2 id="Jenkins-Pipeline-介绍"><a href="#Jenkins-Pipeline-介绍" class="headerlink" title="Jenkins Pipeline 介绍"></a>Jenkins Pipeline 介绍</h2><p>Pipeline，简而言之，就是一套运行于 Jenkins 上的工作流框架，将原本独立 运行于单个或者多个节点的任务连接起来，实现单个任务难以完成的复杂流程编排与可视化。</p><p>Pipeline 是 Jenkins2.X 最核心的特性，帮助 Jenkins 实现从 CI 到 CD 与 DevOps 的转变</p><blockquote><p>什么是 Jenkins Pipeline?</p></blockquote><p>Jenkins Pipeline 是一组插件，让 Jenkins 可以实现持续交付管道的落地和实施。持续交付管道 (CD Pipeline) 是将软件从版本控制阶段到交付给用户或客户的完 整过程的自动化表现。软件的每一次更改 (提交到源代码管理系统) 都要经过一个复杂的过程才能被发布。</p><p>Pipeline 提供了一组可扩展的工具，通过 Pipeline Domain Specific Language(DSL) syntax 可以达到 Pipeline as Code 的目的</p><p>Pipeline as Code:Jenkinsfile 存储在项目的源代码库</p><blockquote><p>Jenkins Pipeline 核心概念</p></blockquote><p>Stage<br>– 阶段，一个 Pipeline 可以划分为若干个 Stage，每个 Stage 代表一组操作，例如: “Build”, “Test”, “Deploy” 。<br>– 注意，Stage 是一个逻辑分组的概念，可以跨多个 Node。 </p><p>Node<br>– 节点，一个 Node 就是一个 Jenkins 节点，或者是 Master，或者是 Agent，是执行 Step 的具体 运行环境。</p><p>Step<br>– 步骤，Step 是最基本的操作单元，小到创建一个目录，大到构建一个 Docker 镜像，由各类 Jenkins Plugin 提供，例如: sh ‘make’</p><blockquote><p>为什么要用 Pipeline?</p></blockquote><ul><li>代码: Pipeline 以代码的形式实现，通常被检入源代码控制，使团队能够编辑，审查和迭代其 CD 流程。</li><li>可持续性: Jenkins 重启或者中断后都不会影响 Pipeline Job。</li><li>停顿: Pipeline 可以选择停止并等待人工输入或批准，然后再继续 Pipeline 运行。</li><li>多功能: Pipeline 支持现实世界的复杂 CD 要求，包括 fork/join 子进程，循环和 并行执行工作的能力。</li><li>可扩展: Pipeline 插件支持其 DSL 的自定义扩展以及与其他插件集成的多个选项。</li></ul><blockquote><p>Pipeline 和 Freestyle 的区别</p></blockquote><p>Freestyle:<br>– 上游 / 下游 Job 调度，如 BuildJob -&gt;TestJob -&gt; DeployJob<br>– 在 DSL Job 里面调度多个子 Job(利用 Build Flow plugin)</p><p>Pipeline:<br>– 单个 Job 中完成所有的任务编排<br>– 全局视图</p><blockquote><p>Pipeline 会取代 Freestyle 么?</p></blockquote><ul><li>Pipeline 一定会取代 Build Flow 插件</li><li>会，当你希望做到 Pipeline as code 的时候</li><li>会，当你独立运行一组 Job 没有特殊价值或者意义的时候</li><li>会，当你可以从 Multibranch Pipeline 受益的时候</li><li>会，当你希望获取类似于 TravisCI 风格的工作流的时候</li></ul><h3 id="Jenkins-Pipeline-入门"><a href="#Jenkins-Pipeline-入门" class="headerlink" title="Jenkins Pipeline 入门"></a>Jenkins Pipeline 入门</h3><p>Pipeline 脚本是由 Groovy 语言实现<br>– 无需专门学习 Groovy</p><p>Pipeline 支持两种语法<br>– Declarative 声明式(在 Pipeline plugin 2.5 中引入)<br>– Scripted Pipeline 脚本式</p><p>如何创建基本的 Pipeline<br>– 直接在 Jenkins Web UI 网页界面中输入脚本<br>– 通过创建一个 Jenkinsfile 可以检入项目的源代码管理库</p><p>最佳实践<br>– 通常推荐在 Jenkins 中直接从源代码控制 (SCM) 中载入 Jenkinsfile Pipeline</p><h3 id="快速创建一个简单的-Pipeline"><a href="#快速创建一个简单的-Pipeline" class="headerlink" title="快速创建一个简单的 Pipeline"></a>快速创建一个简单的 Pipeline</h3><ol><li>新建 Job: Jenkins -&gt; 新建 -&gt; 输入 Job 名称: “My-first-pipeline-demo” -&gt; 选择 Pipeline -&gt; 点击 “OK”</li><li>配置: 在 Pipeline -&gt; Script 文本输入框中输入下列语句，点击 ”保存”</li><li>立即构建</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">'Build'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">'Build'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">'Test'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">'Test'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">'Deploy'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">'Deploy'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Jenkins-忘记密码怎么办"><a href="#Jenkins-忘记密码怎么办" class="headerlink" title="Jenkins 忘记密码怎么办"></a>Jenkins 忘记密码怎么办</h2><p>如果权限设置错误，或者忘记密码，导致 admin 自己都无法登陆 Jenkins 怎么办?</p><ul><li>命令行停止 Jenkins;</li><li>先备份 $JENKINS_HOME 中的 config.xml;</li><li>用编辑器打开 $JENKINS_HOME 中的 config.xml;</li><li>将 &lt; useSecurity&gt;true 元素中的 true 改为 false;</li><li>将 &lt; authorizationStrategy &gt; 和 &lt; securityRealm &gt; 元素的内容删掉; </li><li>命令行启动 Jenkins。</li></ul><h2 id="Ansible-Jenkins-API-Token-使用技巧"><a href="#Ansible-Jenkins-API-Token-使用技巧" class="headerlink" title="Ansible Jenkins API Token 使用技巧"></a>Ansible Jenkins API Token 使用技巧</h2><p>Jenkins REST API 提供了 API token，使得可以在程序中使用 API token 进行认证（而不是使用你真实的密码）。</p><p>API token 可以在用户个人设置界面查看<br>到用户→用户 id→设置页面，在 API Token 区域点击 Show API token 按钮，便可查看 API token，同时还可以更改 API token<br>相应的 URL 是<br>http://&lt;JENKINS_URL&gt;/user/<userid>/configure</userid></p><p>Manage Jenkins jobs by using Jenkins REST API</p><p>jenkins_job_facts – Get facts about Jenkins jobs<br><a href="https://docs.ansible.com/ansible/latest/modules/jenkins_job_facts_module.html" target="_blank" rel="noopener">https://docs.ansible.com/ansible/latest/modules/jenkins_job_facts_module.html</a></p><p>jenkins_job – Manage jenkins jobs<br><a href="https://docs.ansible.com/ansible/latest/modules/jenkins_job_module.html" target="_blank" rel="noopener">https://docs.ansible.com/ansible/latest/modules/jenkins_job_module.html</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># python-jenkins package</span></span><br><span class="line">pip install python-jenkins lxml</span><br><span class="line"></span><br><span class="line"><span class="comment"># jenkins_job_facts.yml</span></span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  gather_facts: no</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Get host info</span><br><span class="line">      local_action:</span><br><span class="line">        module: jenkins_job_facts</span><br><span class="line">        url: https://xxx</span><br><span class="line">        user: xxx</span><br><span class="line">        token: xxx</span><br><span class="line">        glob: <span class="string">'*mh_kg*'</span></span><br><span class="line">      register: my_jenkins_job_facts</span><br><span class="line"></span><br><span class="line">    - debug:</span><br><span class="line">        msg: <span class="string">"&#123;&#123;my_jenkins_job_facts&#125;&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># shell awk</span></span><br><span class="line">cat reg | grep <span class="string">'"name"'</span> | awk -F <span class="string">'"'</span> <span class="string">'&#123;print $4&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># jenkins_job_delete.yml</span></span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  gather_facts: no</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Delete <span class="built_in">jobs</span></span><br><span class="line">      local_action:</span><br><span class="line">        module: jenkins_job</span><br><span class="line">        url: xxx</span><br><span class="line">        user: xxx</span><br><span class="line">        token: xxx</span><br><span class="line">        name: <span class="string">"&#123;&#123; item &#125;&#125;"</span></span><br><span class="line">        state: absent</span><br><span class="line">      loop: </span><br><span class="line">        - gop_live___mh_kg_garena_auth_nginx_static_files</span><br><span class="line">        - gop_live___mh_kg_nginx_reload</span><br><span class="line">        - gop_live___mh_kg_nginx_update_config</span><br><span class="line">        - gop_live___mh_kg_restart_service</span><br><span class="line">        - gop_live___mh_kg_setup_server</span><br><span class="line">        - gop_live___mh_kg_stop_service</span><br><span class="line">        - gop_live_mh_kg_app_point</span><br><span class="line">        - gop_live_mh_kg_game_service</span><br><span class="line">        - gop_live_mh_kg_payment_center_backend</span><br><span class="line">        - gop_live_mh_kg_sso_website</span><br></pre></td></tr></table></figure><h2 id="Jenkins-迁移"><a href="#Jenkins-迁移" class="headerlink" title="Jenkins 迁移"></a>Jenkins 迁移</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建迁移脚本</span></span><br><span class="line">vim jenkins_jobs_migration.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#/bin/bash</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> -r line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$line</span></span><br><span class="line">curl -s --user &lt;name&gt;:&lt;token&gt; https://&lt;<span class="built_in">source</span>-jenkins-url&gt;/job/<span class="variable">$line</span>/config.xml | curl -XPOST --user &lt;name&gt;:&lt;token&gt; https://&lt;target-jenkins-url&gt;/createItem?name=<span class="variable">$line</span> --header <span class="string">"Content-Type: application/xml"</span> -d @-</span><br><span class="line"><span class="keyword">done</span> &lt; jobs.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建需要迁移的 jobs</span></span><br><span class="line">vim jobs.txt</span><br><span class="line">gop_k8s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行迁移脚本</span></span><br><span class="line">chmod +x jenkins_jobs_migration.sh</span><br><span class="line">./jenkins_jobs_migration.sh</span><br><span class="line">gop_k8s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查迁移后的 jobs 兼容性</span></span><br></pre></td></tr></table></figure><h2 id="参考内容"><a href="#参考内容" class="headerlink" title="参考内容"></a>参考内容</h2><blockquote><p>官方手册永远是你的最佳参考内容</p></blockquote><p>Jenkins 用户手册 - <a href="https://jenkins.io/zh/doc/" target="_blank" rel="noopener">https://jenkins.io/zh/doc/</a></p><p><a href="http://www.51niux.com/?cate=46" target="_blank" rel="noopener">Jenkins</a></p><p><a href="https://blog.mafeifan.com/Jenkins/" target="_blank" rel="noopener">Jenkins2 系列</a></p><p><a href="https://www.linuxba.com/archives/tag/jenkins" target="_blank" rel="noopener">《Jenkins 2.x 实践指南》读书笔记</a></p><p><a href="https://www.w3cschool.cn/jenkins/" target="_blank" rel="noopener">Jenkins 中文文档</a></p><p><a href="http://www.eryajf.net/2415.html" target="_blank" rel="noopener">Jenkins 入门系列笔记汇总整理</a></p>]]></content>
    
    <summary type="html">
    
      Jenkins学习使用实践
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>MacBook macOS 从小白到入门</title>
    <link href="https://wsgzao.github.io/post/macbook/"/>
    <id>https://wsgzao.github.io/post/macbook/</id>
    <published>2019-11-21T08:59:49.000Z</published>
    <updated>2019-11-22T09:59:37.477Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><img src="https://i.v2ex.co/y2JB0IAD.png" alt=""></p><p>这里做下 MacBook macOS 从小白到入门的持续更新记录</p><blockquote><p>MacBook macOS 从小白到入门</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 11 月 21 日 - 增加 macOS 生产力工具链推荐<br>2019 年 03 月 16 日 - 更新 macOS vim 语法高亮的设置方法<br>2019 年 02 月 28 日 - 更新 macOS 开启关闭 SIP<br>2019 年 01 月 24 日 - 增加开启 HiDPI 和解决黑屏问题<br>2018 年 10 月 19 日 - 更新升级 macOS Mojave 后的各种小问题解决方法<br>2018 年 07 月 25 日 - 补充细节<br>2018 年 07 月 05 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/macbook/">https://wsgzao.github.io/post/macbook/</a></p><p><strong> 扩展阅读 </strong></p><p>Awesome Mac - <a href="http://wangchujiang.com/awesome-mac/index.zh.html" target="_blank" rel="noopener">http://wangchujiang.com/awesome-mac/index.zh.html</a><br>BestApp - <a href="https://github.com/hzlzh/Best-App" target="_blank" rel="noopener">https://github.com/hzlzh/Best-App</a><br><a href="https://github.com/Louiszhai/tool" target="_blank" rel="noopener">开发效率提升：Mac 生产力工具链推荐</a></p><hr><h2 id="System-Preferences"><a href="#System-Preferences" class="headerlink" title="System Preferences"></a>System Preferences</h2><blockquote><p>在任何的操作系统中，首先你需要做一件事就是更新系统，点击窗口左上角的  &gt; 关于本机 &gt; 软件更新 。此外，如果这是一部新的电脑，你还需要到系统设置进行一些适当调整。如何调整，取决于个人喜好。</p></blockquote><h3 id="触控板"><a href="#触控板" class="headerlink" title="触控板"></a>触控板</h3><p>系统设置 &gt; 触控板</p><p>光标与点击</p><ul><li>轻拍来点按</li><li>辅助点按</li><li>查找</li><li>三指拖移</li></ul><p>滚动缩放</p><ul><li>默认全选</li></ul><p>更多手势</p><ul><li>默认全选</li></ul><h3 id="Dock"><a href="#Dock" class="headerlink" title="Dock"></a>Dock</h3><p>置于屏幕上的位置：左边<br>设置 Dock 图标更小（大小随个人喜好）</p><ul><li>自动显示和隐藏 Dock</li></ul><h3 id="Finder"><a href="#Finder" class="headerlink" title="Finder"></a>Finder</h3><p>Finder &gt; 显示</p><ul><li>显示标签页栏</li><li>显示路径栏</li><li>显示状态栏</li><li>自定工具栏 &gt; 去除所有按钮，仅剩搜索栏</li></ul><p>Finder &gt; 偏好设置</p><p>通用</p><ul><li>开启新 Finder 窗口时打开：HOME「用户名」目录</li></ul><p>边栏</p><ul><li>添加 HOME「用户名」目录 和 创建代码文件目录</li><li>将 共享的(shared) 和 标记(tags) 目录去掉</li></ul><h3 id="菜单栏"><a href="#菜单栏" class="headerlink" title="菜单栏"></a>菜单栏</h3><ul><li>去掉蓝牙等无需经常使用的图标</li><li>将电池显示设置为百分比</li></ul><h3 id="Spotlight"><a href="#Spotlight" class="headerlink" title="Spotlight"></a>Spotlight</h3><ul><li>去掉字体和书签与历史记录等不需要的内容</li><li>设置合适的快捷键</li></ul><h3 id="互联网帐户"><a href="#互联网帐户" class="headerlink" title="互联网帐户"></a>互联网帐户</h3><ul><li>添加 iCloud 用户，同步日历，联系人和 Find my mac 等等</li></ul><h3 id="English"><a href="#English" class="headerlink" title="English"></a>English</h3><p>Trackpad</p><ul><li>Tap to click</li></ul><p>Accessibility -&gt; Mouse &amp; Trackpad -&gt; Trackpad Options</p><ul><li>Enable dragging | three finger drag</li></ul><p>Language &amp; Region</p><ul><li>Time format | 24-Hour Time</li><li>click add button | Chinese, Simplified</li></ul><p>Language &amp; Region -&gt; Keyboard Preferences -&gt; Shortcuts -&gt; Input Sources</p><ul><li>Select the previous input source</li></ul><p>Display -&gt; Arrangement</p><ul><li>Drag the graphics and just make what you want</li><li>if the display rotates 90 degrees then change Rotation to 90° or 270° and click confirm button to save</li></ul><h2 id="Mac-键盘快捷键"><a href="#Mac-键盘快捷键" class="headerlink" title="Mac 键盘快捷键"></a>Mac 键盘快捷键</h2><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191122174620.png" alt=""></p><table><thead><tr><th style="text-align:center">Symbol</th><th style="text-align:center">Key</th></tr></thead><tbody><tr><td style="text-align:center">&#8984;</td><td style="text-align:center">Command Key</td></tr><tr><td style="text-align:center">&#8963;</td><td style="text-align:center">Control Key</td></tr><tr><td style="text-align:center">&#8997;</td><td style="text-align:center">Option Key</td></tr><tr><td style="text-align:center">&#8679;</td><td style="text-align:center">Shift Key</td></tr></tbody></table><blockquote><p>我自己常用的快捷键</p></blockquote><table><thead><tr><th>快捷键</th><th>描述</th></tr></thead><tbody><tr><td>Command(⌘)-C</td><td>复制</td></tr><tr><td>Command(⌘)-V</td><td>粘贴</td></tr><tr><td>Command(⌘)-Z</td><td>撤销</td></tr><tr><td>Command(⌘)-Option-V</td><td>剪切粘贴</td></tr><tr><td>Command(⌘)-A</td><td>全选</td></tr><tr><td>Command(⌘)-F</td><td>查找</td></tr><tr><td>Command(⌘)-S</td><td>保存</td></tr><tr><td>Command(⌘)-W</td><td>关闭当前窗口</td></tr><tr><td>Command(⌘)- 空格键</td><td>聚焦</td></tr><tr><td>Command(⌘)- 方向左键</td><td>后退</td></tr><tr><td>Command(⌘)- 方向右键</td><td>前进</td></tr><tr><td>Control-A</td><td>移至行或段落的开头</td></tr><tr><td>Control-E</td><td>移至行或段落的末尾</td></tr><tr><td>Control - 空格键</td><td>切换输入法（需要手动设置）</td></tr><tr><td>Control-Command-Q</td><td>系统自带锁屏快捷键</td></tr><tr><td>Option-Command-C</td><td>复制文件路径，当然也可以直接拖拽到命令行</td></tr></tbody></table><p><a href="https://support.apple.com/zh-cn/HT201236" target="_blank" rel="noopener">https://support.apple.com/zh-cn/HT201236</a></p><h2 id="Mac-Soft"><a href="#Mac-Soft" class="headerlink" title="Mac Soft"></a>Mac Soft</h2><p>Homebrew - Mac 下必备的包管理工具<br><a href="https://brew.sh/" target="_blank" rel="noopener">https://brew.sh/</a></p><p>Alfred - Mac 下被无数人安利的效率工具，虽然我觉得 Spotlight 暂时够用了<br><a href="https://www.alfredapp.com/" target="_blank" rel="noopener">https://www.alfredapp.com/</a></p><p>Mounty for NTFS - 免费的 NTFS 支持软件<br><a href="http://enjoygineering.com/mounty/" target="_blank" rel="noopener">http://enjoygineering.com/mounty/</a><br><a href="https://www.seagate.com/sg/en/support/software/paragon/#downloads" target="_blank" rel="noopener">Seagate</a></p><p>Sougou Input - 陪伴大家多年的搜狗输入法<br><a href="https://pinyin.sogou.com/mac/" target="_blank" rel="noopener">https://pinyin.sogou.com/mac/</a></p><p>Youdao Dict - 网易开发的老牌翻译工具<br><a href="http://cidian.youdao.com/index-mac.html" target="_blank" rel="noopener">http://cidian.youdao.com/index-mac.html</a></p><p>Adobe Reader - Adobe 官方免费的 PDF 阅读工具<br><a href="https://get.adobe.com/reader/" target="_blank" rel="noopener">https://get.adobe.com/reader/</a></p><p>Clearview - 支持 PDF, EPUB, CHM, MOBI 的免费阅读器<br><a href="https://itunes.apple.com/app/clearview/id557090104?mt=12&amp;ls=1" target="_blank" rel="noopener">https://itunes.apple.com/app/clearview/id557090104?mt=12&amp;ls=1</a></p><p>Evernote - 轻量级的在线笔记类应用内<br><a href="https://evernote.com/" target="_blank" rel="noopener">https://evernote.com/</a></p><p>Dropbox - 最佳的实时同步工具之一<br><a href="https://www.dropbox.com/" target="_blank" rel="noopener">https://www.dropbox.com/</a></p><p>eZip - 国人编写的转为 macOS 而设计的压缩软件，代替 Keka<br><a href="https://ezip.awehunt.com/" target="_blank" rel="noopener">https://ezip.awehunt.com/</a></p><p>Mac 迅雷 - 支持协议多广告也多，FOLX、Free Download Manager、qBittorrent 都可以作为备选方案<br><a href="http://mac.xunlei.com/" target="_blank" rel="noopener">http://mac.xunlei.com/</a></p><p>百度网盘 - 国内的网盘共享基本只剩下百度一家独大了，有时候迅雷离线无法下载可以尝试<br><a href="https://pan.baidu.com/" target="_blank" rel="noopener">https://pan.baidu.com/</a></p><p>IINA - 国人编写的开源视频播放器<br><a href="https://lhc70000.github.io/iina/" target="_blank" rel="noopener">https://lhc70000.github.io/iina/</a></p><p>Snipaste - 或许是最好的截图软件，愿意每年付 12 元推荐 Xnip<br><a href="https://zh.snipaste.com/" target="_blank" rel="noopener">https://zh.snipaste.com/</a></p><p>FileZilla - 免费开源的 FTP/SFTP 应用<br><a href="https://filezilla-project.org/download.php?type=client" target="_blank" rel="noopener">https://filezilla-project.org/download.php?type=client</a></p><p>Clipy - 记录多条粘贴板小工具<br><a href="https://github.com/Clipy/Clipy" target="_blank" rel="noopener">https://github.com/Clipy/Clipy</a></p><p>Spectacle - 快速调整程序窗口位置的效率工具<br><a href="https://www.spectacleapp.com/" target="_blank" rel="noopener">https://www.spectacleapp.com/</a></p><p>Sourcetree - 图形化 Git 管理工具<br><a href="https://www.sourcetreeapp.com/" target="_blank" rel="noopener">https://www.sourcetreeapp.com/</a></p><p>Microsoft Remote Desktop - Mac 下的微软 RDP 远程桌面登录工具<br><a href="https://itunes.apple.com/us/app/microsoft-remote-desktop-10/id1295203466?mt=12" target="_blank" rel="noopener">https://itunes.apple.com/us/app/microsoft-remote-desktop-10/id1295203466?mt=12</a></p><p>VirtualBox - 免费的虚拟机工具<br><a href="http://www.oracle.com/technetwork/server-storage/virtualbox/downloads/index.html" target="_blank" rel="noopener">http://www.oracle.com/technetwork/server-storage/virtualbox/downloads/index.html</a></p><p>PostMan - 免费强大的 HTTP 调试工具<br><a href="https://www.getpostman.com/" target="_blank" rel="noopener">https://www.getpostman.com/</a></p><p>VMware OS Optimization Tool - VMware 开发的 Windows 虚拟机优化工具<br><a href="https://labs.vmware.com/flings/vmware-os-optimization-tool" target="_blank" rel="noopener">https://labs.vmware.com/flings/vmware-os-optimization-tool</a></p><h3 id="Homebrew"><a href="#Homebrew" class="headerlink" title="Homebrew"></a>Homebrew</h3><p><a href="https://docs.brew.sh/Installation" target="_blank" rel="noopener">https://docs.brew.sh/Installation</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install xcode first</span></span><br><span class="line">https://itunes.apple.com/us/app/xcode/id497799835</span><br><span class="line"></span><br><span class="line"><span class="comment"># install homebrew</span></span><br><span class="line">/usr/bin/ruby -e <span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># install packages</span></span><br><span class="line">brew tap dteoh/sqa</span><br><span class="line">brew install zsh</span><br><span class="line">brew install wget</span><br><span class="line">brew install git</span><br><span class="line"><span class="comment"># default install is python3 now, if you need python2 just run `brew install python2`</span></span><br><span class="line">brew install python</span><br></pre></td></tr></table></figure><h3 id="iTerm2-zsh-Oh-My-Zsh"><a href="#iTerm2-zsh-Oh-My-Zsh" class="headerlink" title="iTerm2 + zsh + Oh My Zsh"></a>iTerm2 + zsh + Oh My Zsh</h3><p>iTerm2<br><a href="https://www.iterm2.com/" target="_blank" rel="noopener">https://www.iterm2.com/</a></p><p>Oh My Zsh<br><a href="http://ohmyz.sh/" target="_blank" rel="noopener">http://ohmyz.sh/</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install latest zsh zsh-syntax-highlighting</span></span><br><span class="line">brew install zsh zsh-syntax-highlighting</span><br><span class="line"><span class="comment"># 修改默认 shell，在 /etc/shells 文件中加入如下一行</span></span><br><span class="line">vi /etc/shells</span><br><span class="line"></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/zsh</span><br><span class="line"><span class="comment"># 然后运行命令切换 shell</span></span><br><span class="line">chsh -s /usr/<span class="built_in">local</span>/bin/zsh</span><br><span class="line"></span><br><span class="line"><span class="comment"># install oh-my-zsh</span></span><br><span class="line">sh -c <span class="string">"<span class="variable">$(curl -fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh)</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改主题为 agnoster，增加一行 zsh-syntax-highlighting</span></span><br><span class="line">vi ~/.zshrc</span><br><span class="line"></span><br><span class="line">ZSH_THEME=<span class="string">"agnoster"</span></span><br><span class="line"><span class="built_in">source</span> /usr/<span class="built_in">local</span>/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可选增加 visual studio code 命令行 code 支持 zsh</span></span><br><span class="line"><span class="keyword">function</span> code &#123;</span><br><span class="line">    <span class="keyword">if</span> [[ <span class="variable">$#</span> = 0 ]]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        open -a <span class="string">"Visual Studio Code"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">local</span> argPath=<span class="string">"<span class="variable">$1</span>"</span></span><br><span class="line">        [[ <span class="variable">$1</span> = /* ]] &amp;&amp; argPath=<span class="string">"<span class="variable">$1</span>"</span> || argPath=<span class="string">"<span class="variable">$PWD</span>/<span class="variable">$&#123;1#./&#125;</span>"</span></span><br><span class="line">        open -a <span class="string">"Visual Studio Code"</span> <span class="string">"<span class="variable">$argPath</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决 Too many files open error</span></span><br><span class="line"><span class="built_in">ulimit</span> -n 10000</span><br><span class="line"><span class="built_in">ulimit</span> -u 2048</span><br><span class="line"></span><br><span class="line"><span class="comment"># 刷新环境变量</span></span><br><span class="line"><span class="built_in">source</span> ~/.zshrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 powerline 字体</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/powerline/fonts.git</span><br><span class="line"><span class="built_in">cd</span> fonts</span><br><span class="line">./install.sh</span><br></pre></td></tr></table></figure><blockquote><p>配置 iTerm2 主题，主题可以从 iterm2colorschemes 下载</p></blockquote><p><a href="https://iterm2colorschemes.com/" target="_blank" rel="noopener">https://iterm2colorschemes.com/</a></p><ol><li>Download iTerm2 color you like</li><li>Open iTerm2 that we already downloaded at the first section</li><li>Go to iTerm2 &gt; Preferences &gt; Profiles &gt; Colors Tab</li><li>Click Color Presets at the bottom right</li><li>Click Import</li><li>Select the *.itermcolors file</li><li>Select the * from Load Presets</li></ol><p>在 Keys -&gt; Hotkey 中设置 <code>command + i</code> 快速显示和隐藏 iTerm<br>在 Profiles -&gt; Default -&gt; Colors -&gt; Load Presets 导入主题，作为默认颜色，我的主题是 <code>3024 Night</code><br>在 Profiles -&gt; Text -&gt; Change Font 调整字体 / 大小 / 颜色等，我的字体是 <code>18pt Ubuntu Mono derivative Powerline</code></p><p>macOS 使用笔记：终端配置 - <a href="http://lizhiqiang.me/mac_terminal/" target="_blank" rel="noopener">http://lizhiqiang.me/mac_terminal/</a><br>打造 Mac 下高颜值好用的终端环境 - <a href="https://blog.biezhi.me/2018/11/build-a-beautiful-mac-terminal-environment.html" target="_blank" rel="noopener">https://blog.biezhi.me/2018/11/build-a-beautiful-mac-terminal-environment.html</a></p><blockquote><p>macOS vim 语法高亮的设置方法</p></blockquote><p>打开 terminal 复制 /usr/share/vim/vimrc 到家目录下并重命名为 “.vimrc”, 然后编辑该文件，增加以下几行：</p><p>VimConfig - <a href="https://vimconfig.com/" target="_blank" rel="noopener">https://vimconfig.com/</a><br>My .vimrc - <a href="https://chrisyeh96.github.io/2017/12/18/vimrc.html" target="_blank" rel="noopener">https://chrisyeh96.github.io/2017/12/18/vimrc.html</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/share/vim/vimrc ~/.vimrc</span><br><span class="line"><span class="built_in">set</span> ai                  <span class="string">"auto indenting</span></span><br><span class="line"><span class="string">set ruler"</span> show the cursor position</span><br><span class="line"><span class="built_in">set</span> hlsearch            <span class="string">"highlight the last searched term</span></span><br><span class="line"><span class="string">set history=1000"</span> keep 1000 lines of <span class="built_in">history</span></span><br><span class="line">syntax on               <span class="string">"syntax highlighting</span></span><br><span class="line"><span class="string">filetype plugin on"</span> use the file <span class="built_in">type</span> plugins</span><br></pre></td></tr></table></figure><h2 id="Others"><a href="#Others" class="headerlink" title="Others"></a>Others</h2><p><img src="http://wx4.sinaimg.cn/large/7207510dgy1fxgwknz69qg20jg0b5hdz.gif" alt=""></p><h3 id="升级-macOS-Mojave-新版卡顿黑屏和字体发虚解决方案"><a href="#升级-macOS-Mojave-新版卡顿黑屏和字体发虚解决方案" class="headerlink" title="升级 macOS Mojave 新版卡顿黑屏和字体发虚解决方案"></a>升级 macOS Mojave 新版卡顿黑屏和字体发虚解决方案</h3><blockquote><p>输入文字卡顿</p></blockquote><p>如果你的 Mac 已经更新至 macOS Mojave，在输入文字时经常卡顿，频繁出现小风车，那很有可能是搜狗输入法造成的，只需将它升级至最新的 4.8.0 版本，即可完美解决。</p><blockquote><p>字体发虚</p></blockquote><p>升级 macOS Mojave 新系统后，苹果默认关闭了子像素抗锯齿，导致字体变细锯齿增多。<br>解决字体渲染过细，打开终端，输入：</p><pre><code>defaults write -g CGFontRenderingFontSmoothingDisabled -bool NO</code></pre><p>重启应用比如 VS Code 后即可看到效果</p><blockquote><p>开启 HiDPI</p></blockquote><p>如果外接显示器字体模糊，可以使用 Scale Resolutions<br>Display Override PropertyList File Parser and Generator with HiDPI support</p><p><a href="https://comsysto.github.io/Display-Override-PropertyList-File-Parser-and-Generator-with-HiDPI-Support-For-Scaled-Resolutions/" target="_blank" rel="noopener">https://comsysto.github.io/Display-Override-PropertyList-File-Parser-and-Generator-with-HiDPI-Support-For-Scaled-Resolutions/</a></p><p>Enable HiDPI on OS X - <a href="https://github.com/syscl/Enable-HiDPI-OSX" target="_blank" rel="noopener">https://github.com/syscl/Enable-HiDPI-OSX</a></p><blockquote><p>解决唤醒时黑屏只看见鼠标的问题</p></blockquote><p>先关机，然后开机快速同时点击 Command + S 按键进入 single-user 单用户模式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/sbin/fsck -fy</span><br><span class="line">/sbin/mount -uw /</span><br><span class="line">rm -f /Library/Preferences/com.apple.loginwindow.plist</span><br><span class="line">rm -f /var/db/.AppleUpgrade</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure><h3 id="解决-Command-Q-经常误按"><a href="#解决-Command-Q-经常误按" class="headerlink" title="解决 Command+Q 经常误按"></a>解决 Command+Q 经常误按</h3><p>Slow Quit Apps</p><p>A macOS app that adds a global delay of 1 second to the Cmd-Q shortcut. In other words, you have to hold down Cmd-Q for 1 second before an application will quit.</p><p>When the delay is active, an overlay is drawn at the center of the screen.</p><p><a href="https://github.com/dteoh/SlowQuitApps" target="_blank" rel="noopener">https://github.com/dteoh/SlowQuitApps</a></p><p>brew cask install slowquitapps</p><p>运行程序按照提示授权后重启应用并设置开机自启动即可享受 1s 延迟关闭提醒，如果觉得时间不够长可以自己设定</p><h3 id="提示应用程序被破坏无法打开"><a href="#提示应用程序被破坏无法打开" class="headerlink" title="提示应用程序被破坏无法打开"></a>提示应用程序被破坏无法打开</h3><blockquote><p>SOLVED: “Application” is damaged and can’t be opened in macOS Sierra</p></blockquote><pre><code>sudo spctl --master-disable</code></pre><p>输入密码重新打开 System Preferences &gt; Security &amp; Privacy &gt; General 即可看到之前隐藏的“Anywhere”<br><a href="https://www.santoshsrinivas.com/disable-gatekeeper-in-macos-sierra/" target="_blank" rel="noopener">https://www.santoshsrinivas.com/disable-gatekeeper-in-macos-sierra/</a></p><blockquote><p>macOS High Seirra 提示 “已损坏，打不开，您应该将它移至垃圾篓”</p></blockquote><p>这是因为在系统偏好设置的 “安全性与隐私” 里面的 “允许从以下位置下载的应用” 没有选中“任何来源”，解决方法如下：</p><ol><li>打开终端，然后输入以下命令：sudo spctl –master-disable</li><li>然后回车，输入系统密码并回车（这里输入密码不会显示，输完密码直接回车即可），如果没有提示即操作成功。</li><li>打开系统偏好设置的 “安全性与隐私”，查看“允许从以下位置下载的应用” 是否选中的是“任何来源”，如果选中说明操作成功。这时再打开软件安装就没有已损坏的提示的了。</li></ol><h3 id="Mac-开启关闭-SIP"><a href="#Mac-开启关闭-SIP" class="headerlink" title="Mac 开启关闭 SIP"></a>Mac 开启关闭 SIP</h3><p>S1. 查看 SIP 状态<br>在终端中输入 csrutil status，就可以看到是 enabled 还是 disabled。</p><p>S2. 关闭 SIP</p><ol><li>重启 MAC，按住 cmd+R 直到屏幕上出现苹果的标志和进度条，进入 Recovery 模式；</li><li>在屏幕最上方的工具栏找到实用工具（左数第 3 个），打开终端，输入：csrutil disable；</li><li>关掉终端，重启 mac；</li><li>重启以后可以在终端中查看状态确认。</li></ol><p>S3. 开启 SIP<br>与关闭的步骤类似，只是在 S2 中输入 csrutil enable 即可。</p><h3 id="更改-Apple-ID-国家或地区"><a href="#更改-Apple-ID-国家或地区" class="headerlink" title="更改 Apple ID 国家或地区"></a>更改 Apple ID 国家或地区</h3><blockquote><p>区域在国内即使身在国外也看不到你需要的很多东东，建议修改</p></blockquote><p><a href="https://support.apple.com/zh-cn/ht201389" target="_blank" rel="noopener">https://support.apple.com/zh-cn/ht201389</a></p><h3 id="USB-Type-C-耳机"><a href="#USB-Type-C-耳机" class="headerlink" title="USB Type-C 耳机"></a>USB Type-C 耳机</h3><ol><li>插入耳机至任意 USB Type-C 接口</li><li>System Preferences -&gt; Sound -&gt; Output -&gt; 选择识别到的耳机设备即可</li></ol><h3 id="Macbook-外置键盘如何更改设置"><a href="#Macbook-外置键盘如何更改设置" class="headerlink" title="Macbook 外置键盘如何更改设置"></a>Macbook 外置键盘如何更改设置</h3><p>option 改成 command（win 版键盘下的四个方块图标按键）<br>command 改成 option</p><p><a href="https://jingyan.baidu.com/article/363872ec2185346e4aa16f61.html" target="_blank" rel="noopener">https://jingyan.baidu.com/article/363872ec2185346e4aa16f61.html</a></p><h3 id="配置从命令提示行启动-vscode"><a href="#配置从命令提示行启动-vscode" class="headerlink" title="配置从命令提示行启动 vscode"></a>配置从命令提示行启动 vscode</h3><p>安装 Visual Studio Code，打开命令面板（按 F1 或 command + shift + p）输入 Shell 命令找到 Shell 命令: 在 PATH 中安装 “code” 命令。命令执行完成之后，重启终端工具使新的 $PATH 可用。现在，您可以简单地在终端中任意文件夹下输入‘code .’来编辑该文件夹下的文件了。</p><h3 id="Git-Ignore"><a href="#Git-Ignore" class="headerlink" title="Git Ignore"></a>Git Ignore</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个新文件 ~/.gitignore ，并将以下内容添加进去，这样全部 git 仓库将会忽略以下内容所提及的文件。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Folder view configuration files</span></span><br><span class="line">.DS_Store</span><br><span class="line">Desktop.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># Thumbnail cache files</span></span><br><span class="line">._*</span><br><span class="line">Thumbs.db</span><br><span class="line"></span><br><span class="line"><span class="comment"># Files that might appear on external disks</span></span><br><span class="line">.Spotlight-V100</span><br><span class="line">.Trashes</span><br><span class="line"></span><br><span class="line"><span class="comment"># Compiled Python files</span></span><br><span class="line">*.pyc</span><br><span class="line"></span><br><span class="line"><span class="comment"># Compiled C++ files</span></span><br><span class="line">*.out</span><br><span class="line"></span><br><span class="line"><span class="comment"># Application specific files</span></span><br><span class="line">venv</span><br><span class="line">node_modules</span><br><span class="line">.sass-cache</span><br><span class="line"></span><br><span class="line"><span class="comment"># Temp File</span></span><br><span class="line">*.swp</span><br><span class="line">*.swa</span><br><span class="line">*.swo</span><br><span class="line"></span><br><span class="line"><span class="comment"># github merge file</span></span><br><span class="line">*.orig</span><br><span class="line"></span><br><span class="line"><span class="comment">#vscode </span></span><br><span class="line">.vscode</span><br></pre></td></tr></table></figure><h3 id="禁止-DS-store-生成"><a href="#禁止-DS-store-生成" class="headerlink" title="禁止. DS_store 生成"></a>禁止. DS_store 生成</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 禁止 .DS_store 生成，打开“终端”，复制黏贴下面的命令，回车执行，重启 Mac 即可生效。</span></span><br><span class="line">defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool TRUE</span><br><span class="line"><span class="comment"># 恢复 .DS_store 生成</span></span><br><span class="line">defaults delete com.apple.desktopservices DSDontWriteNetworkStores</span><br><span class="line"><span class="comment"># 刪除已存在的. DS_Store</span></span><br><span class="line">sudo find . -name <span class="string">".DS_Store"</span> -depth -<span class="built_in">exec</span> rm &#123;&#125; \;</span><br></pre></td></tr></table></figure><h3 id="ssh-相关"><a href="#ssh-相关" class="headerlink" title="ssh 相关"></a>ssh 相关</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -bash: warning: setlocale: LC_CTYPE: cannot change locale (UTF-8): No such file or directory</span></span><br><span class="line"><span class="comment"># 禁止 OpenSSH 客户端从 OS X/Linux/Unix 桌面发送 LC_* 变量</span></span><br><span class="line">vi /etc/ssh/ssh_config</span><br><span class="line"><span class="comment">#SendEnv LANG LC_*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># port forwarding</span></span><br><span class="line">ssh -p 22202 wangao@127.0.0.1</span><br><span class="line">ssh -p 22202 wangao@127.0.0.1 -X</span><br><span class="line">scp -P 22202 -r sysctl.sh sysctl.d/ wangao@127.0.0.1:/tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># ssh tunnel for one-time</span></span><br><span class="line">ssh -t -A wangao@xx.xx.xx.xx ssh wangao@10.65.32.60</span><br><span class="line"></span><br><span class="line"><span class="comment"># config ssh tunnel to make easy connect everyday</span></span><br><span class="line">vim ~/.ssh/config</span><br><span class="line"></span><br><span class="line">StrictHostKeyChecking no</span><br><span class="line">CheckHostIP no</span><br><span class="line"></span><br><span class="line">Host 10.71.12.*</span><br><span class="line">  HostName %h</span><br><span class="line">  ProxyCommand ssh bastion_GOP_SG_NC_MAIN -W %h:%p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Host 10.71.13.*</span><br><span class="line">  HostName %h</span><br><span class="line">  ProxyCommand ssh bastion_GOP_SG_NC_MAIN -W %h:%p</span><br><span class="line"></span><br><span class="line">Host 10.71.14.*</span><br><span class="line">  HostName %h</span><br><span class="line">  ProxyCommand ssh bastion_GOP_SG_NC_MAIN -W %h:%p</span><br><span class="line"></span><br><span class="line">Host 10.71.15.*</span><br><span class="line">  HostName %h</span><br><span class="line">  ProxyCommand ssh bastion_GOP_SG_NC_MAIN -W %h:%p</span><br><span class="line"></span><br><span class="line">Host bastion_GOP_SG_NC_MAIN</span><br><span class="line">  HostName 8.8.8.8</span><br><span class="line">  port 22</span><br><span class="line">  User wangao</span><br></pre></td></tr></table></figure><hr><p>题图 - 苹果 2015 新春广告<a href="http://www.apple.com/cn/start-something-new/#film-holiday" target="_blank" rel="noopener">《老唱片》</a></p>]]></content>
    
    <summary type="html">
    
      MacBook macOS 从小白到入门
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>圈外同学个人发展战略课程</title>
    <link href="https://wsgzao.github.io/post/quanwai/"/>
    <id>https://wsgzao.github.io/post/quanwai/</id>
    <published>2019-11-21T06:59:49.000Z</published>
    <updated>2019-11-21T07:46:29.948Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>圈外同学是什么？各位可以自行通过搜索引擎来了解，这篇文章主要是转载了圈外同学的个人发展战略课程，如果觉得内容实在希望进一步学习，可以直接打开圈外同学官网咨询。</p><blockquote><p>圈外同学个人发展战略课程</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 11 月 21 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/quanwai/">https://wsgzao.github.io/post/quanwai/</a></p><p><strong> 扩展阅读 </strong></p><p>授权转载自圈外同学 - <a href="https://www.iquanwai.com/" target="_blank" rel="noopener">https://www.iquanwai.com/</a></p><hr><h2 id="个人发展战略课程简介"><a href="#个人发展战略课程简介" class="headerlink" title="个人发展战略课程简介"></a>个人发展战略课程简介</h2><p>你好，欢迎来到圈外同学《个人发展战略》的课程，我是孙圈圈，这是我的笔名，原名叫孙园媛。在你开始听课之前，我想先给你做个测试，是关于个人发展的 9 道是非题，看看你能答对多少，然后我再告诉你为什么这么做。如果你怕记不住，可以拿手机或纸笔记录一下答案。</p><ol><li>我对现在的工作没什么热情，应该是因为我不够擅长</li><li>我认同 “以大多数人的努力程度之低，根本达不到拼天赋”</li><li>做技术的，应该专注在做技术上，其他能力不重要</li><li>时代变化太快，我需要紧密关注和学习应对所有变化，避免被淘汰</li><li>我觉得自己好像没什么天赋</li><li>学习一个领域的知识，应该从概念开始，全面地学习</li><li>多学点知识，一定会有用的</li><li>工作让我感觉很心累，肯定是工作量太大了</li><li>很难坚持学习、阅读、健身这类事情，是因为不够自律</li></ol><p>现在，我来公布答案了，你先记录下来，再看答案。</p><p>答案是以上说法全部错误。</p><p>实际上，这些问题，都是我经常碰到的，无论是我的读者、用户还是团队的年轻人，在这些问题上都有很大的认识误区。很多人在职业发展和个人提升方面的无策略、无方法程度，让我感到惊讶。</p><p>但跟很多人聊过之后，我发现，我之所以认识到这些，其实是因为我自身职业的优势，使我具备企业、管理者、咨询顾问、教育创业者四种视角。而这种角度，恰好是大多数人所不具备的。</p><p>企业视角：<br>我曾经在全球排名第一的人力资源咨询公司，美世咨询（Mercer），工作了八年多，为 7 个行业、几十家头部企业，设计人才发展战略。如果你在航空、消费品、互联网等等行业的一些头部公司，很可能我设计过的薪资和晋升体系就直接影响到你了（我希望你不要顺着 wifi 掐死我）。我设计的人才管理体系，直接影响到的职场人士有数百万。而一般人并没有这样的咨询经历，无法看到各类企业的全局。</p><p>管理者视角：<br>一方面，因为此前做咨询的缘故，接触的都是各大企业的高管，因此，我能够知道管理者在想什么，他们如何看待人才。另一方面，我自己也有过很多年带团队的经验，而且我带过的人，都比相同岗位起点的同龄人薪资高出 2-3 倍，所以在这方面有切身体会。</p><p>咨询师视角：<br>作为咨询顾问，最重要的能力就是解决问题。所以我养成了一个习惯，就是每当面临问题的时候，用结构化的方式去解决。比如个人规划，很多人不知道应该如何规划，那我就会将个人类比企业，将企业战略规划的框架进行改良，变成个人规划方法，然后在使用过程中不断完善，最终形成适合自己的方法论。所以，职业发展、自我认知、个人提升等话题，我都可以摸索出一套套实操性较强的方法论，而较少陷入困扰。</p><p>教育创业者视角：<br>我是在线商学院【圈外同学】的创始人，同时也是我们平台上的老师之一，教授过几十门课程。目前有几十万人都上过我们的课程，数万人进入到我们的商学院培养项目。在商学院项目学员里，97% 的学员认为课程对他们带来了明显改变，仅仅 3 个月学习后就有 19% 的人实现了顺利转行跳槽或升职加薪。</p><p>我还写过一本个人发展类的干货畅销书，叫《请停止无效努力：如何用正确的方法快速进阶》，黄色封面，人称 “小黄书”，豆瓣评分是 8.4 分，差不多是同类书籍万分之一的水平。所以，我知道应该怎么教。</p><p>正因为这些特殊的视角，我在个人发展方面习以为常的认知，或许在他人看来，却是颠覆性的。</p><p>但是，我们现在不得不拥有这样的认知，掌握正确的发展方法论了。</p><p>我前公司有过一个调研数据：<br>10 年前，一个人在一家公司所待的时间是 3-4 年，而现在，一个人在一家公司平均只会待 1 年多。</p><p>在这种情况下，企业没有任何动力培养人才，只在公司平均待 1 年多，培养好之后还来不及给公司做贡献就走了，对企业来说根本不划算，更何况外部环境竞争激烈，培养人才所需要的时间，企业根本耗不起。所以，企业越来越倾向于用现成的人。而当所有企业都想用现成人才的时候，其实就是企业将过去所承担的人才培养成本，逐渐转移到了个人身上。</p><p>个人从现在开始，不得不开始培养自己，进入到所谓的终身学习状态。这正是知识付费兴起的大背景之一。</p><p>但是，从未有人教过我们，离开了学校这种应试教育的地方，在职场中应该如何正确地学习和提升。所以，大家一窝蜂买知识付费课程，一窝蜂去学英语，一窝蜂去考证，最后发现好像没用，于是陷入了焦虑和迷茫。</p><p>这个大背景，是我从 2 年多前开始创业做圈外的初衷。</p><p>圈外目前有一些 4-6 个月的体系化学习项目，也有针对单项能力的特训营，进入门槛都相对高，也并非适合每个人的发展阶段。所以我希望通过这个非常短的课程，普及一些基本的职业发展和提升方法，不再让一些毫无专业基础的成功学老师误导我们，每个人都应该有自己的发展策略，当好自己的 CEO。</p><p>好了，那这门课程到底如何帮你呢？</p><p>我会分为 4 个维度、6 节内容来展开叙述：</p><p>一、诊断现状</p><p>1）一个模型，帮你找到真正热爱的工作：分析个人和工作匹配的要素有哪些，知道自己为什么会不喜欢一份工作，以及怎么找到跟自己匹配的工作。</p><p>2）四大要素，决定了你的市场价值：分析应该把时间花在什么要素上面，才能有市场价值的提升，并不是所有努力都有效</p><p>二、发现潜能</p><p>3）四类迹象，发现你的隐藏能力：找到自己的天赋，也就是隐藏的能力，才能事半功倍</p><p>三、学习提升</p><p>4）三种方法，将知识内化成能力：知识是死的，能力才能盘活它</p><p>5）三大系统，让学习不靠意志力：靠意志力学习是不可能的，需要依靠三大系统</p><p>四、规划未来</p><p>6）三个建议，让你不做 “定制化人才：如何找到不变的因素，应对未来的加速变化，避免成为企业定制化人才</p><p>课程只有 6 小节，但不是听完就算，我会在每小节给你一个作业，让你进行练习。我们的班主任，也会在微信群里发起很多讨论，跟同学一起帮助你，如果你有什么困惑，欢迎 “骚扰” 他们。</p><p>我们每个人遇到的问题和烦恼看似不同，但你要知道，你不是这个世界上第一个遇到这些问题的人。人才发展这个话题，本身就是一门科学，已经有很多前人帮你研究过这些问题了，你需要做的，不是自己慢慢摸索、重新造轮子，而是找到最科学的方法，进行学习。</p><h2 id="一个模型，帮你找到真正热爱的工作"><a href="#一个模型，帮你找到真正热爱的工作" class="headerlink" title="一个模型，帮你找到真正热爱的工作"></a>一个模型，帮你找到真正热爱的工作</h2><p><strong> 本节学习收获：</strong> 掌握冰山模型的用法，能够用它来分析自己跟工作的匹配度，从而做出正确的职业选择，并能精准找到自己喜欢并有成就感的工作。</p><p>“我感觉目前的工作状态不是我最想要的，做得也还行，但没有太多成就感，也不知道未来发展会怎么样…… 想有一份真正热爱并且有前途的工作，但不知道应该做什么，感觉很迷茫。”</p><p>这段话，要么是我们当下的状态，要么是曾经有过的状态。</p><p>刚工作发现不喜欢想转行、到了新岗位发现不胜任想提升、人到中年发现这个工作的天花板等等，都是常态。<strong> 因为我们对自己的事业有期许，但当下的工作可能无法承载这样的期许，所以会觉得 “不喜欢”“很迷茫”。</strong></p><p>可是，“不喜欢”“很迷茫” 只是一种情绪，情绪背后的原因是什么呢？我们喜欢、又有前途的工作到底在哪里呢？这节课，我给你介绍一个模型，然后用它来帮你做好职业选择和定位，让你不再迷茫。</p><p>这个模型称为冰山模型，你可能听过，但我还是会简单介绍一下，然后告诉你这个模型有哪些妙用，用好它，差不多可以解决你一半以上的学习和发展问题。</p><p>冰山模型是美国著名心理学家麦克利兰提出来的，它全面地描述了一个人的个体素质要素，也就是说，<strong> 你跟一个岗位是不是匹配、匹配程度如何、市场薪资值多少，都是这个模型可以解释的，几乎所有大公司都会用它来进行人才招聘和培养。</strong></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121153338.png" alt=""></p><p><strong> 第一部分，知识和技能 </strong></p><p><strong> 冰山模型从上到下有很多要素，最上面的要素是知识和技能。</strong></p><p>知识，就是我们在学习和实践中获得的认知和经验，比如财务知识、人力资源知识等等，包括我们现在学习的冰山模型，也属于知识。这跟你大学所学的专业、常看的书、从事的工作、甚至业余爱好都有关系。</p><p>技能是指你所具备的某项专门技术，比如骑自行车、编程、使用 Excel 等等。</p><p>一个人的知识和技能是可以后也是非常显性，容易看出来的。所以，我们称为冰山上的部分。</p><p>知识技能跟工作之间的关系是什么呢？简单来说，<strong> 如果你的工作中有很多陌生的内容，觉得每天都信息量很大、来不及接收，感到慌乱和焦虑，很可能就是你的知识技能跟岗位不匹配。</strong> 但这不是什么大问题，因为知识和技能比较容易补齐，上上课、看看书、跟资深同事学，一段时间之后就能提升。</p><p><strong> 第二部分，能力 </strong></p><p><strong> 冰山模型中间的要素是能力，或叫通用能力，比如学习和思考能力、人际交往能力等。</strong> 相对知识和技能来说，能力高低不是一眼就能看出来的。比如，一个人的创新能力到底如何，很难用一个证书、几道题目来考察，而需要看他在处理很多问题时候的行为。</p><p>能力跟知识技能最大的区别在于：<strong> 知识和技能属于特定领域，而能力则更多是通用领域的。</strong> 比如，知识会分财务、人力资源、金融等等，但是 “创新” 这样的能力，是适用于任何领域的，一旦掌握，是能够迁移的。</p><p>那么，<strong> 如果能力不匹配，在工作中会如何呢？工作效率、沟通效率较低，面对复杂的问题无从下手，缺乏成就感，力不从心。</strong> 能力的培养周期相对长一些，一般要几个月时间，我们后面几节会讲方法。</p><p><strong> 第三部分，价值观、性格、动机 </strong></p><p><strong> 冰山模型最底下包括价值观、性格特质、动机。这些要素在成年之后很难被改变 </strong>，它们会受基因、家庭教育、童年经历等等的影响。简单介绍一下各个要素：</p><p><strong> 价值观是你判断事物的标准 </strong>，比如说，当你在择业的时候，自由和稳定产生了冲突，你选择哪个、放弃哪个；在事业和家庭产生冲突的时候，你怎么处理，等等。<strong> 如果你在工作中经常陷入矛盾和纠结，对所做的事情很难发自内心地认同，很可能就是价值观上不匹配 </strong>，比如你做自媒体，公司为了赚钱让你写一些低俗内容，但你觉得那对用户没有价值。</p><p><strong> 性格特质则是个人的行为偏好 </strong>，比如，你是偏内向还是外向，更关注宏观还是细节，等等。<strong> 如果你在工作中发现，自己好像工作量没有很大，但却觉得心累，很有可能是性格不匹配 </strong>。比如，你是内向性格的人，是从独处中获得能量，但你做了一份每天都要不断跟陌生人沟通的工作。</p><p>至于动机，其实动机的分类方法有很多，最常见的是麦克利兰的理论，分为成就动机、权力动机和亲和动机。成就动机的人，喜欢挑战；权力动机的人，希望影响他人；而亲和动机的人，希望维持更好的团队关系。<strong> 如果你感觉自己没有动力，做事提不起劲儿来，那很可能就是现在的工作跟你的动机不匹配 </strong>，比如你明明是成就感动机，喜欢一定挑战，但你的工作却高度重复。</p><p>好了，我们讲完整个冰山模型，现在你知道了，<strong> 工作跟伴侣是一样的，“匹配” 比 “优秀” 重要 </strong>，而你跟一份工作的匹配要素，其实就是冰山模型中的要素。所以，我们 <strong> 感觉一份工作不喜欢，有可能是缺乏知识技能导致的慌乱和焦虑、缺乏能力导致的挫败和低效、价值观不匹配导致的矛盾和纠结、动机不匹配导致的没热情，或者性格特质不匹配导致的心累。</strong></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121153405.png" alt=""></p><p>而且，所有匹配要素里面，冰山底层的隐性要素起到了更大的作用，就像找伴侣一样，尽管看起来表面条件差不多，但你就是对一个人有感觉而对另一个人没有，这就是冰山底层的隐性要素在发挥作用。</p><p>所以，知道了这个模型，你就可以分析了，如果目前的工作自己不是很喜欢，那么到底是哪里不喜欢。</p><p>好了，现在我们分析的是现有岗位是否喜欢，那么假如我现在是销售，发现并不喜欢，想要转行做互联网运营，面对这样一个陌生岗位，不知道自己是否匹配，这时候应该怎么办呢？或者说，我不喜欢销售工作，但我面对运营、产品经理、市场分析等等这些可能感兴趣的岗位，不知道该去哪一个，又该怎么办呢？<strong> 这世界上有几千种岗位，我们总不能全都干一遍然后再选。</strong></p><p>其实很简单，你 <strong> 把目标岗位用冰山模型分析一下 </strong>，就可以了。</p><p>具体该怎么做呢？分成四步：</p><p><strong> 第一步，先确定一个你要分析的岗位。</strong></p><p>比如你有一个目标岗位，那么很简单，就用这个岗位来分析自己是不是匹配。但如果你没有，可以先从自己的相关经验出发，框定你能做的几个岗位，一个个分析。这里 <strong> 教你一个技巧 </strong>，比如你在某个行业做技术服务，但目前的工作不喜欢，想要换，可又不知道自己能换什么，这时候可以去领英等等这类招聘平台去搜索，就 <strong> 搜这个行业的技术服务岗位，然后会出来一堆人，你看这些人的履历，看看他们后来都去了哪里，你就知道潜在的方向了 </strong>。而且，<strong> 这个方法也能帮你判断，未来你要去的这个行业和岗位，到底有没有前途 </strong>，这些原先做该岗位的人，后面的出路是什么。</p><p><strong> 第二步，在招聘网站上，搜索这个岗位的招聘要求。</strong></p><p>这时候，你会搜到很多公司对这个岗位的招聘要求，找出几份不同的招聘需求。因为不同公司会有自己的细分要求，为了提取出共性要求，你可以尽可能多看几份，找到共性。</p><p><strong> 第三步，按照冰山模型，综合分析这些招聘需求。</strong></p><p>你会发现，<strong> 招聘需求基本上也是按照冰山模型来写的 </strong>，以新媒体运营岗位来说，有对知识的要求，比如传播学或文学专业毕业、了解内容营销的知识、熟悉新媒体平台；有对技能的要求，比如精通公众号排版工具使用；也有对能力的要求，比如文案写作能力、用户思维、学习能力等等；最后，还有对性格特质、动机等等的要求，比如细心、热爱挑战等等。把它们汇总在一起，就可以得到这份岗位的需求模型了。</p><p><strong> 第四步，按照岗位需求模型，与自己进行对比。</strong></p><p>岗位需求模型已经出来了，那么自己就可以对照一下，自己到底是不是符合，是否应该换工作或转行。当然，我们很难找到完全匹配的工作，<strong> 如果是冰山底层的因素不匹配，那么不太建议选择这个职业，因为这些要素后天很难改变；但如果是知识、技能方面不匹配，未必不能选，因为大部分知识和技能都是可以后天学习的 </strong>，只是看你是否愿意投入时间罢了。</p><p>我们平时看一份工作，大都是看冰山表层，比如职责、薪资、办公环境、学历、专业等等因素，可最终你这份工作能不能做好、是否有成就感，其实是很多隐性要素所决定的，今天的内容，其实是把你对工作的感觉给表述出来了，被分解成了你的性格特质、动机、价值观，也就避免了我们一个个去尝试然后看喜不喜欢。</p><p>我一直认为，<strong> 搞明白 “我应该选择什么样的工作”，比 “我应该如何在别人认为的好工作里面成功”，要重要得多 </strong>。毕竟，<strong> 想要让自己获得成就感和满足感，就不应该把它绑在别人的记分牌上 </strong>。</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121153423.png" alt=""></p><p>好了，今天我们讲了冰山模型，你会发现，<strong> 它不只是能用在职业选择方面，还可以用在其他很多方面 </strong>，比如今天稍微提到一点的伴侣选择，还有子女教育，很多父母都给孩子报很多培训班，但孩子时间有限，所以应该选什么培训班呢？是教孩子背背单词和儿歌，还是开发思维的课程呢？如果你知道了冰山模型，相信会有答案。</p><p>所以，我想告诉你的是，<strong> 我们所学习的每个方法论和模型，都不是只能解决一个问题 </strong>，而是可以解决几百甚至几千个问题，<strong> 查理芒格在《穷查理宝典》里面提到，掌握一定数量的思维模型，能解决这世上 90% 的问题 </strong>。你会发现，同样的知识量，如果你能用知识解决更多问题，那你的学习投入产出比就是最高的。</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121153441.png" alt=""></p><p>好了，正如我们刚才说的，<strong> 冰山模型有很多作用，除了帮你匹配工作，其实它还可以用来衡量你的市场价值，也就是薪资 </strong>。公司会通过简历、面试来考察候选人在冰山模型各个要素的表现情况，来确定对方的薪资。</p><h2 id="四大要素，决定了你的市场价值"><a href="#四大要素，决定了你的市场价值" class="headerlink" title="四大要素，决定了你的市场价值"></a>四大要素，决定了你的市场价值</h2><p><strong> 本节学习收获：</strong> 明确冰山模型各个要素的投入产出比，从而更好地分配自己的时间，让自己变得更值钱；同时，理解不同类型的岗位所对应的门槛和天花板，帮助择业</p><p>我们都会发现，同样学校、同样专业的两个人，在毕业几年之后，薪资差异可能非常大。大家起点差不多、毕业时间差不多、每天投入的工作时间也差不多，但最后产出却不一样，到底是什么原因呢？我们自己的时间应该要投入在哪里，才能最大化我们的市场价值也就是薪资呢？今天我们用科学的方法做个分析。</p><p>首先，薪资，也就是一个人的市场价值，无非是跟内部和外部两类因素相关。外部就是机遇、运气、选择等等；而内部，其实就是我们在冰山模型各个要素上的表现，我们的知识技能越多、能力越强、价值观 / 性格特质 / 动机跟所做的事情越匹配，你的市场价值就越高。</p><p>所以，抛开运气、选择这些很难掌控的因素不谈，我们今天从内部角度，也就是冰山模型的各个要素，来聊聊市场价值怎么提升。</p><p>说具体方法之前，我们先得有一个认识，那就是 <strong> 整个冰山模型越往下的要素，越难培养、越难发现 </strong>，比如学一个知识，冰山模型，我跟你讲一下马上就知道，但是提升一种能力，比如解决问题的能力，那不是听讲就行的。可是呢，<strong> 也因为越往下的要素越难，相对也越能成为竞争优势 </strong>。同时，你应该也发现了，这几个要素并不是独立的，<strong> 冰山下面的要素会影响上面的要素 </strong>。举例来说，一个人的知识储备有多少，跟 ta 的学习能力、动机等等都非常相关。如果你的学习和思考能力更强、并以追求真理作为价值观，知识储备就会更高。根据研究，冰山底层的要素中，光个性特质就能够解释员工绩效差异的 35%，而 <strong> 冰山底层的因素加起来，差不多决定了一个人的 70%</strong>。</p><p>好了，有了这个认知，我们接下来挨个分析，<strong> 把时间投入在不同的要素上，会有什么结果 </strong>。</p><p><strong> 首先是投入到知识。</strong></p><p>我们可能觉得知识很值钱，毕竟 “知识付费” 嘛。但说实话，单纯用知识很难赚钱。</p><p>为什么呢？</p><p>其一，当今社会，<strong> 你想知道什么，网上搜索就可以了，可替代性太高 </strong>。比如说，你就算把百科全书背下来，最后可能还得靠卖记忆力课程赚钱，而没法通过这个知识直接赚钱。</p><p>其二，<strong> 知识跟思维，是有差别的 </strong>。有句古语叫 <strong>“学富五车”</strong>，出自《庄子・天下》，形容一个人知识渊博，但那时候不是纸质书、是用竹简的，而且车也是马车，不是火车，所以 <strong> 五车竹简能装多少知识呢？最多十几二十万字，也就一本书。</strong> 所以，现代社会，随便一个人，知识储备都超过孔子、老子、亚里士多德。但你为什么还在学他们呢？因为知识跟思维是不一样的，你学的是他们的思维。而思维是一种能力，用知识解释以及解决问题的能力。</p><p>所以，你会发现，<strong> 单纯的知识储备，如果不能结合思维能力去解决一些具体问题，是很难提升你的市场价值的 </strong>。</p><p><strong> 第二种选择是投入到技能。</strong></p><p>有一些职业是有专业门槛的，比如程序员、设计师，这属于技能型岗位，因为这些岗位有一个进入门槛，往往会让人觉得非常有安全感。反过来，像是做销售、市场、运营类工作的人，或者大学学习经管这种万金油专业的同学，常常会觉得 “哎呀，我没有一技之长，好没安全感”。</p><p>但实际上，<strong> 门槛高，不代表天花板也高，毕竟没人想要一直拿每个工作的门槛工资 </strong>，我们是往上看的。</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121153547.png" alt=""></p><p><strong> 技能的定价如何？天花板在哪里呢？取决于该技能的稀缺性。</strong></p><p>10 多年前，很多大企业都会给有 CPA 证书的人支付一个叫做 Market Premium（市场溢价）的额外工资，因为这个技能当时相对稀缺，所以公司需要支付溢价才能招到人。可是，这个技能的市场价格高，就会有很多人进入到这个领域，人才供需逐渐稳定，那么溢价就消失了。程序员岗位也一样，在移动互联网红利期的时候，行业增长快，所以对程序员的需求非常旺盛，而市场供给还没来得及跟上，所以带来了程序员的高工资。但是，这两年红利消失，增长放缓，对程序员的需求就会下降，可供给没有下降，所以会导致工资水平上不去，但因为不能降薪，所以很多公司规定的工作时间越来越长，以此来变相降薪，“996 事件” 的爆发跟这个趋势有很大关系。</p><p>当然，那些有管理技能、商业思维、能解决复杂问题的程序员，薪资依然很高，但他们已经不单单是靠技能吃饭了，而是具备了很高的能力。</p><p><strong> 一个很有意思的现象，在圈外的付费学员中，工作 5 年以下的人群技术人员占比不高，但是 5 年以上的人群中，就有特别多技术人员 </strong>。因为他们发现技能带来的薪资提升是有天花板的，所以需要提升管理能力、解决问题的能力，来获得更高的职业回报、突破发展瓶颈。</p><p>所以，<strong> 技能在稀缺的时期很值钱，一旦行业变动、人才供给增多，市场价值就会下跌，不得不学习新的技能。</strong></p><p><strong> 第三种选择是投入到能力。</strong></p><p>有一些岗位，<strong> 对技能没有特殊要求，看起来好像门槛不高，但薪资天花板却很高，而且薪资范围很宽 </strong>，例如互联网运营、产品经理、项目经理、还有大多数的管理岗位。厉害的产品经理像上亿年薪的张小龙，而一般的产品经理可能月薪才一万，他们的薪资差异并不在于技能的不同，比如谁画的产品原型图更好，而是能力高低。所以，<strong> 这些岗位也被称为是能力导向型岗位 </strong>。</p><p>圈外商学院有一位深圳的学员，在一家传统行业的 500 强企业做工程师，带公司内部的一些技术项目。工作 5 年，薪资一万多，他觉得支撑不了家庭未来的需要，想要晋升，但他发现，公司的部门经理都在 35-45 岁之间，而自己才 27 岁，还需要熬很多年，于是纠结要不要投身互联网。但他也担心跨行会不会成功，以及不知道如何着手。后来他在圈外学了近半年，知道了不同行业所需要的很多能力是相通的，所以坚定了信心，而且找到圈外的朋友了解目标岗位的情况，最后在一家互联网大厂拿到了项目管理的 offer，薪资翻了倍。他后来跟大家分享的时候提到，<strong> 面试中问了很多如何带团队、带项目的问题，都是课程里面学过的 </strong>。当然，想要了解他的故事，可以跟班主任要文章链接，他太太有在圈外公众号写过一篇文章，提到过这段经历。</p><p>所以，<strong> 能力提升是可以跨行业跨职业的，一旦积累到一定高度，哪怕行业不行，换个地方一样可以值钱 </strong>。</p><p><strong> 第四种选择是投入到冰山模型底层的自我发现。</strong></p><p>冰山底部的性格特质、动机、价值观这些要素，虽然难以改变和发现，但是，<strong> 如果我们对自己能有一个清晰的认识，然后找到跟这些要素相匹配的工作，其实也能大大提升我们的市场价值 </strong>。</p><p>比如说，我是一个高成就动机的人，在亲和动机方面比较弱，从这个角度看，咨询公司就非常适合我，因为工作挑战大、容易有成就感。但如果我去某个注重关系和家庭氛围的国有企业，那我就会感到不适，最终很难得到提升。环境其实是一种外部驱动力，你选到了适合的地方，自然成长效率就会更高。所谓 “橘生淮南则为橘，生于淮北则为枳”。</p><p>好了，从上面的四种选择我们可以看到，从长期来说，<strong> 想要提升自己的市场价值，把大多数时间花在提升能力和认识自己冰山底层要素上面，是最好的选择 </strong>。但事实上，<strong> 大多数人是怎么做的呢？每天打开各种学习产品、不断学很多碎片化知识，练习一些并不稀缺的技能、考各种几个月就能拿下来的证 </strong>，最后收入还是上不去，反而会觉得很挫败。</p><p><strong> 为什么我们大多数人会做出这样的选择呢？</strong></p><p><strong> 第一，知识和技能的学习最容易。</strong> 它们的获得门槛很低，听一堂课、学一个知识，这是几乎所有人都能做到的事情。而能力就不一样了，需要持续投入、刻意练习。<strong> 人们总是倾向于做容易的事情，而不是正确的事情。</strong></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121153605.png" alt=""></p><p><strong> 第二，受限于目前岗位的定位。</strong> 前面有提到，其实一些岗位的性质，本身就是技能导向型的，对你没什么能力要求，只需要表格做得越快越好、流程越熟练越好。而人都是有惰性的，在这种岗位要求下，也就没有动力去提升眼前岗位不需要、但长远更有价值的能力了。所以有时候我会说：<strong> 你选的不是一份工作，而是一个天花板。</strong></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121153616.png" alt=""></p><p><strong> 第三，没有看清楚工作的本质。</strong> 很多人以为值钱的是知识和经验，但并非如此。本质来说，<strong> 任何工作都是在解决问题 </strong>，营销解决的是如何让用户知道我们的产品、HR 解决的是如何让公司有充足的人才供给等等，往大了说，不仅我们的工作，<strong> 一家公司也是在解决某类用户问题 </strong>，滴滴解决打不到车的问题，饿了么解决不想出门吃饭的问题，等等。</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121153627.png" alt=""></p><p>既然本质是解决问题，所以你单有一个知识就是没用的。你会背很多营销理论，但没法帮公司宣传和卖出更多产品，就是没价值的。</p><p>好了，我们现在知道了，要花时间去认识自己和提升能力。</p><p>关于认识自己，圈外商学院里有这个课程，但自我认知是一个持续的、慢慢发现的过程，课程也只是供参考，我们这次先不展开。</p><p>关于提升能力，这是任何职业阶段的人都应该去做的，而且你投入了就一定会有回报。</p><p>但你有没有发现，<strong> 同样两个人，都培养自己的某项能力，比如结构化思维，一个人很快就能提升，但另一个人好像努力了很久也没有太大效果？</strong> 这跟我们每个人的天赋有关，我 <strong> 下一节课告诉你，关于天赋的一些研究成果，以及大多数人对天赋的误解，并且会帮你找出自己的天赋 </strong>，让你能够更快速地提升能力，进入发展快车道。</p><p>好，今天这节课，我们知道了：</p><p><strong> 知识容易获取跟习得，如果不能用它解决问题，几乎就没什么竞争力；</strong></p><p><strong> 技能有进入门槛，其市场价值取决于稀缺程度，但长期来说，所有技能都会走向供需平衡，高收入不可持续；</strong></p><p><strong> 能力可迁移，并且对知识和技能也有很大促进，值得我们多投入；</strong></p><p><strong> 而每个人的性格、动机和价值观不同，所以做不同的工作，也会有产出的不同。</strong></p><p>总之来说，我们的时间应该多投入在后两者上面，但现实是大多数人都在提升前两者。<strong> 我们的时间，永远应该花在正确的事情上，而不是容易的事情上。</strong></p><h2 id="四类迹象，发现你的隐藏能力"><a href="#四类迹象，发现你的隐藏能力" class="headerlink" title="四类迹象，发现你的隐藏能力"></a>四类迹象，发现你的隐藏能力</h2><p><strong> 本节学习收获：</strong> 掌握 SIGN 模型，从而找到自己的天赋，并借此进入发展快车道</p><p><strong> 我还在咨询公司的时候，带过两个相似起点、但结局完全不同的顾问。</strong></p><p>A 顾问大学是学行政管理的，实习期间执行力很强，自己做实习生团队的小头目，但有个很大的问题，她总是点状思考，没有框架。虽然后来我还是争取破格留下了她，但是，我一直担心她未来上升会有瓶颈。</p><p>入职不到一年的时候，我有次让她写份报告，做好了大量修改的心理准备，但我惊讶地发现，结构竟然非常清晰，丝毫不比其他人差。</p><p>后来我问她：你为什么一下子进步了呢？她说：我不知道，好像某天突然顿悟了。</p><p>另一个是 T 顾问，她之前在甲方工作过很短时间。转行过来以后，她的表现跟 A 顾问很像，执行力不错，但常常找不到思路。</p><p>本来以为她也能像 A 顾问一样成长起来，所以我经常带她讨论，一起复盘。</p><p>经过一段时间，她的思维能力有所进步，但是，涉及到新问题，还是不得要领。之后一年，T 顾问每天加班到深夜，觉得很难撑下去，就离开咨询公司回到了甲方。</p><p>当时我一直不明白，两个人的差异在哪里。后来，随着我管理经验增多，加之对人才发展领域更加了解，才找到了答案。结合我们这一节课的主题，相信你也猜到了，答案跟天赋有关。</p><p>优势心理学之父唐纳德・克里夫顿博士，曾经带领团队进行了一项长达 50 年、基于 200 万人的研究。研究表明，<strong> 虽然成功的道路有千万条，但成功人士基本上都遵循了一个原则，就是将自身天赋发挥到了极致。</strong></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121153725.png" alt=""></p><p>更重要的是，他指出：<strong> 天赋并不是少数人的专属，每个人都有自己的天赋。</strong></p><p>这里的天赋是什么呢？<strong> 天赋就是隐藏的能力，让一个人可以在同样起点的情况下，更加快速地成长。</strong></p><p>也就是说，在某个领域内天赋高的人与该领域里的一般人，他们的努力与水平之间的关系，类似于图片里的两条实线。</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121153808.png" alt=""></p><p>但是我们大多数人，往往以为天赋 = 能力，以为天赋是那条虚线，以为只要有天赋，不需要努力就可以达成结果。实际上，<strong> 天赋只是个催化剂，是加快反应的。</strong> 可以说，天赋是一种隐藏能力，是否能够转化为显性的能力，则是需要后天刻意练习的。</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121153825.png" alt=""></p><p>这也就解释了开头那个故事，为什么 A 顾问可以进步得这么迅速，因为系统化思维并非她天生的弱势，只是她之前专业和实习里面，没有让她刻意练习的机会，所以展现不出来。</p><p>而 T 顾问呢？天赋上欠缺系统化思维，后天的练习确实可以起到作用，但没有 A 顾问那么快进步，时间一长，对比身边人，很容易沮丧挫败，从而没有动力去提升。</p><p>当然，A 顾问的事业就一定会比 T 顾问更成功吗？不是，因为世界上不是只有这一份工作。事实上，T 顾问回到甲方后，工作做得很不错。</p><p>所以，找到你的天赋，并且培养它，发挥它，就能够让你事半功倍地获得提升，而且，你做事会更有成就感。</p><p>好了，你肯定很想知道：我的天赋是什么呢？我有什么隐藏能力呢？</p><p><strong> 接下来我给你一个探索方法，让你更快发现自己的天赋。</strong></p><p><strong> 天赋有四个表现，简称为 “SIGN”，可以帮你在日常生活和工作中发现它：</strong></p><p><strong> 表现一：自我效能（Self-efficacy）</strong></p><p>字母 S 对应的表现是 Self-efficacy，自我效能。它的意思是对于某些任务，你的信心很强，觉得自己肯定能做好。</p><p>比如，每当面对细节琐碎的事情时，还没开始，我就觉得自己做不好，但每当要我去解决一个难题时，我会充满信心。</p><p>所以，<strong> 当你对某类事非常有信心，觉得自己可以做成功，这就是天赋的其中一个表现。</strong></p><p><strong> 表现二：本能（Instinct）</strong></p><p>字母 I 对应的表现是 Instinct，本能。意思是当你还没有开始做这件事的时候，你就迫不及待地想要尝试了。</p><p>比如，当我决定要开发课程、教给别人的时候，我会感到异常兴奋，会思考很多方法，会想如何让学员更愿意以及更容易掌握这些内容。</p><p>所以，<strong> 那些让你迫不及待、跃跃欲试的事情，可能意味着你天赋的所在。</strong></p><p><strong> 表现三：成长（Growth）</strong></p><p>字母 G 对应的表现是 Growth，成长。正如前面提到的天赋曲线那样，你发现自己学得很快，相同的时间投入，会带来更多的成长。</p><p>比如，当我为了搞清楚某个商业模式，去阅读大量相关资料的时候，一上午对我来说，就跟 20 分钟一样。</p><p><strong> 如果在某个领域，你一接触就明显比别人进步得要快一些，这也是天赋给你的一个信号。</strong></p><p><strong> 表现四：满足（Needs）</strong></p><p>字母 N 对应的是 Needs，也就是满足。<strong> 做完这件事之后，就算感到疲劳和困倦，你依然会有满足感。</strong> 比如，之前做咨询的时候，每次给客户汇报方案、被各种问题砸过来的时候，我都累到不想再继续了，然而结束之后，又觉得充满了成就感。杨丽萍说 “跳舞就是跳舞最好的回报”，描述的就是这种感受。</p><p>以上就是天赋的四个表现，了解到天赋的表现之后，你就可以开始有意识地去挖掘了。当然，你 <strong> 总结出这些事件之后，还需要再次提炼共性 </strong>，比如我总结出这些事件的共性是数据分析，那么说明我的数据分析方面有很大天赋，所以就可以着力培养，以成为自己的核心竞争力。我曾经写过一篇文章，描述我利用自己的优势，挑选客户，成为晋升最快咨询顾问的故事，感兴趣的话可以跟班主任要链接。</p><p>好了，讲完这些，你可能还是有个疑问：这些事件我要怎么发现呢？因为 <strong> 我们对自己的行为太熟悉，日常工作生活可能很难发现符合 SIGN 的特征，所以这里给两个方法，分别是向自己提问和向他人提问 </strong>：</p><p><strong>1. 问自己 </strong></p><p>你可以通过问自己一些问题，帮自己找到符合天赋表现的事件。</p><p>当然，问题还是围绕天赋的四个特征 SIGN。</p><p><strong> 第一类问题：自我效能 S 相关 </strong></p><p>你认为，自己能够教别人什么？或者，别人常常向你请教什么？</p><p>你跟他人聊天的时候，倾向聊什么？以及，聊什么话题你会更有自信？</p><p>你在做什么事情的时候，不会感到焦虑和担心？</p><p><strong> 第二类问题：本能 I 相关 </strong></p><p>你在做什么事情的时候，很少拖延？</p><p>长时间休假后，你最想念工作的哪个方面、哪个内容？</p><p>你宁愿放弃休息时间，也要做的事情，是什么？</p><p><strong> 第三类问题：成长 / 专注 G 相关 </strong></p><p>有什么事情，让你沉浸其中忘记吃饭 / 睡觉？</p><p>你在做什么事情的时候，会暂时忘记刷社交网络？</p><p>你在做什么事情的时候，不容易感到疲倦和厌烦？</p><p><strong> 第四类问题：满足 N 相关 </strong></p><p>过去的工作和生活中，有什么让你获得巨大的成就感和满足感？</p><p><strong>2. 问他人 </strong></p><p>我们之前说过，天赋是天生的、下意识的，所以很多时候，你很难辨别出来。但是从别人的角度，他们跟自己有对比，会更容易帮你辨别。</p><p>所以，你可以 <strong> 把这些基于 SIGN 模型的问题，发给你亲近的朋友或者同事，让他们帮你回答：</strong></p><p>你觉得，我身上有什么不同于别人的特质？</p><p>你最欣赏或者佩服我的方面是什么？</p><p>在你看来，我做什么事情的时候，看起来最兴奋？</p><p>你曾经看到我做过哪件事情，让你印象深刻？</p><p>在以下这些方面，你觉得我哪些更加擅长？思维方式：条理清晰、逻辑严密、脑洞很大、专注专业；沟通协调：化解冲突、争取资源、知人善任；计划执行：执行力强、追求完美、目标导向，等等。</p><p><strong> 你会发现，你眼中的自己，和别人眼中的自己，常常有很大的差异。</strong></p><p>好了，关于天赋的方法，我们了解到这里。</p><p>我们都应该听过一句话 <strong>“大多数人的努力程度之低，根本达不到拼天赋”，这并不正确。</strong> 虽然这句话是为了安慰我们不要怪先天条件，而要靠后天努力，初衷是好的 <strong>。但天赋不是达到一定程度之后才发挥作用的东西，而是一个在起点就发挥作用的因素 </strong>，它让你快速掌握某项能力，而快速掌握之后产生的成就感和信心，又会让你继续下去，从而形成一个良性循环。</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121153842.png" alt=""></p><p>这里顺便说一下，<strong> 努力固然重要，但没有方法的、无效的努力反而会让你丧失信心，是有害的。</strong> 实际上，我自己是很努力的，可关键问题是，我们都是一天 24 小时，无非是有人工作学习 8 小时、有人工作学习 16 小时，最多也是 2 倍的差异，可最后不同人的市场价值、能达到的高度，远远不是 2 倍，而是 200 倍、20000 倍，而那些最成功的人，也并非智商超群、天赋异禀，那是什么因素导致的差异呢？方法一定是其中很关键的因素。</p><p>所以我一直强调努力要有方法，而 <strong> 这些方法，并不需要你自己去摸索，前人早有很多总结，你只需要站在他们的肩膀上就可以 </strong> 了，就像今天所讲到的天赋一样。这也是我做圈外、做这门课程的原因，初衷之一，就是希望自己作为人才发展领域的专业人士，能够把这些研究和正确的方法，教给更多人，让我们付出同样时间的前提下，能有更多的效果和产出。</p><h2 id="三种方法，将知识内化成能力"><a href="#三种方法，将知识内化成能力" class="headerlink" title="三种方法，将知识内化成能力"></a>三种方法，将知识内化成能力</h2><p><strong> 本节学习收获：</strong> 掌握将所学知识内化成能力的 3 个方法，盘活你脑中的知识</p><p>在课程正式开始之前，我先提个问题，我们第一节课介绍了冰山模型，在这几天里，你有没有用它来解决过问题呢？</p><p>如果没有的话，那么冰山模型对你来说，就是没有用的 <strong>“惰性知识”，它只是待在你的脑海里，在一些明明可以发挥作用的场合，却不能及时被调取出来，白白占据了你大脑的内存 </strong>。</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121154001.png" alt=""></p><p>陈铭在《奇葩说》中举过一个例子，很好地解释了知识和能力的关系。他说：</p><p>水在零度的时候会结冰，这是一个知识，是对外部客观规律的归纳和总结。在未来的时间中，我在什么时候、把什么味道的水、变成什么味道的冰棒、卖给谁，叫做 <strong> 智慧和能力，它是指对知识的处理和运用 </strong>。</p><p>我在咨询公司的时候，很多客户都在自己所在的行业里摸爬滚打了几十年，行业知识和经验肯定比工作几年的咨询顾问丰富，但为什么我们能帮他解决问题、收取那么高的咨询费呢？这也是因为，咨询顾问掌握的是一套思维方式和思维能力，能够更好地用知识来解决问题，发挥每个知识的最大效用。</p><p>所以，如果你只是知道冰山模型这个概念，但在实际的工作和生活中用不上它，没能让它成为自己思维的一部分，那就是没用的。那么，<strong> 究竟该怎么做，才能让知识内化成能力，让自己的能力快速提升呢？今天给你三个方法：1. 掌握 20% 的核心；2. 知识和问题互相靠；3. 做系统化训练。</strong></p><p><strong>1. 掌握 20% 的核心 </strong></p><p>做咨询的时候，需要快速地在 1 周之内了解一个行业。很多人会觉得：咨询顾问很聪明，学习能力超强。</p><p>但在我看来，只是因为他们能够拿到优质信息资源、所以掌握了那个领域的核心而已，倘若把这个核心教给任何一个智商尚可的人，他们也可以做到。</p><p>不信的话，回想一下我们大学的考试，虽然 <strong> 一学期的课很复杂，但大多数人也是用考前一周的时间去突击的 </strong>，只要抓住了核心，最后的考试成绩其实不会差。</p><p>我们常说的 “二八原则”，其实这里也适用：<strong> 一个领域 20% 的核心内容，能够解决这个领域 80% 的问题。</strong></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121154015.png" alt=""></p><p>所以，掌握这 20% 的核心，就是我们快速提升的关键。无论是知识也好，能力也罢，想要快速提升，都是如此。<strong> 那什么是 20% 的核心呢？</strong></p><p>分享一个故事。我在刚做咨询顾问的时候，有一次被项目经理狠批：你 PPT 为什么做得那么难看？有没有审美？</p><p>当时非常沮丧，因为熬了无数个夜晚做出来的方案，最后却得到这样的评价。所以我下决心去美化一下 PPT。</p><p>先说结果：项目经理周五说的这话，我在后面周一的时候，PPT 就全改了，彻底把她惊到了。后来这个事儿在公司广为流传，大概是：一个学习能力超强而且超级拼命的顾问，用 2 天时间提升了 100 页 PPT 的逼格。</p><p>怎么做到的？其实很简单，我当时就是 <strong> 拿了一些高手的 PPT，跟我自己的做对比，然后再问这些高手请教经验，最后找出了 PPT 美观的三个关键点 </strong>：1）饱和度；2）边框；3）行间距。然后我把自己的 PPT 做了三个改动：1）把原先填充颜色改成半透明；2）把表格的边框改细；3）把字的行间距拉到 1.5 倍。这样改好，结合配色一点调整，逼格就高很多。</p><p><strong> 这三点，其实就是让咨询 PPT 变得更加美观的那 20% 核心。</strong></p><p>当然，比起真正的 PPT 高手来说，我差得远，但我并不靠做 PPT 谋生，这 20% 已经够用了。</p><p>上面说的是技能，其实能力也是一样的。比如，我们经常说一个人思维混乱，然后觉得思维混乱是个很大的事情，感觉一辈子都提升不了。但实际上，<strong> 大部分的思维混乱，都是因为缺乏结构化思维，而结构化思维只要掌握三个特征就可以，包括主题鲜明、归类分组、逻辑递进，不管写作、演讲还是会议发言，做到这三点就可以显得思路很清晰。</strong> 按照一定的方法论来训练，根据天赋不同，2 周到 2 个月不等，就能有明显改变。这不是我瞎说，我写过文章、开过课程，按这个方式训练的没有一万也有八千。之所以取得这样的效果，是因为结构化思维属于思维的 20% 核心，而我说的 3 个特征，又是结构化思维的 20% 核心。</p><p>但是，<strong> 每个领域里面，哪些是那 20% 的核心，其实是需要这个领域的专家来指点的 </strong>，因为在你对这个领域一无所知的情况下，你没有方向，绕一大圈也不知道门在哪里，等终于入门了才发现走了不少弯路。<strong> 大多数的成功人士，都很擅长找 “师傅”</strong>，他们都在自己的传记当中提到，受谁谁谁的启发和提携。而我理解的 <strong> 好师傅所起到的作用，除了提供资源之外，另一个重大作用就在于，他们会告诉你，一个领域里面最核心的是什么，从而让你快速入门 </strong>。而我所认为的好书、好课程，除了需要大而全的教科书之外，也应该是这样的定位，不是把所有理论都照搬过来，而应该帮助读者和学员找到那 20%，至于入门之后他是否需要或者愿意深度提升，那是他自己的选择。</p><p>关于 20%，圈外的公众号里面会有一些文章，涵盖了一些常见能力领域，这些文章都是提取了该领域里 20% 左右的核心，可以在班主任那里获取文章链接。</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121154057.png" alt=""></p><p><strong>2. 知识和问题互相靠 </strong></p><p>我们经常有一种感觉，平时明明学了很多知识，但在遇到问题的时候，苦思冥想，试图从记忆里找知识来解决问题，可就是想不出来，没有任何思路。但是，也有极少数人，学一个知识，就可以举一反三地解决很多问题。</p><p>实际上，<strong> 之所以在解决问题的时候想不起用什么知识，是因为知识和问题之间是脱节的，他们是分别存储的 </strong>。</p><p>比如你学习了马斯洛五层次需求的知识，你在学这个知识的时候，就没想过它可以用来解决什么样的问题，只是知道了一个概念，那么当你遇到团队管理问题的时候，自然也想不起来能用这个知识解决，也就是说，你的问题很难把你脑中的知识调用出来。这种现象，是造成我们所学的知识无法内化成能力的关键原因。</p><p>那么，<strong> 如何让知识和问题链接起来、解决问题的时候可以轻易调用知识呢？答案是：知识向问题靠，以及问题向知识靠。</strong></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121154112.png" alt=""></p><p>先说 <strong> 知识向问题靠，就是说，每看到一个知识的时候，就去思考这个知识可以用来解决什么问题。</strong></p><p>比如，你学习了马斯洛的五层次需求，就马上思考一下它可以用来解决什么问题。因为这个知识讲的是人类的需求，而我们跟任何人相处其实都需要知道对方的需求。所以你就会想到，它可以用来管理下属（分析他们的需求层次，并据此激励他们），也可以用来找另一半（分析你自己所处的需求层次，从而确定你需要什么样的人），还可以用来分析奢侈品为什么可以卖那么贵（买奢侈品，满足的不只是物质需求，还有被人尊重的需求等等）。</p><p>这就是知识向问题靠。</p><p>而 <strong> 问题向知识靠呢？就是当你遇到问题的时候，抛弃第一反应，不要先按照自己的思维定式来解决，而要去想有什么方法论模型可以用。</strong></p><p>为什么不能按照第一反应的方式解决呢？因为在我们碰到问题的时候，我们的下意识第一反应，是未经思考的，是在遵循我们过去的模式，但如果我们处理所有问题都靠过去的模式，那么刚刚学习的新知识、新解决方案，要怎么才能掌握呢？所以，试着抛开思维定式，用你学到的知识去解决，这样一来，你的知识就会被不断盘活，你解决问题的能力会越来越强。</p><p><strong> 具体怎么落地呢？分享我的做法。</strong> 当我看书或者学习课程看到一个很有用的理论或者模型，我会记下来，然后思考至少 3 个用该模型解决问题的场景，也一起记下来。下次当我遇到一些难题的时候，我不会下意识反应，而是翻一下这个笔记，对照一下，哪些方法模型能解决这个问题，如果是笔记中没有的场景，这个问题是某个模型的新场景，我就补充进去。长此以往，积累了很多知识和问题之间的链接，自己解决问题的能力也得到了极大提升。</p><p><strong>3. 系统化训练 </strong></p><p><strong> 为什么说要系统化训练呢？一方面，不同的能力并不是相互割裂的，它们之间是有关联的。</strong> 比如说，你要提升自己的演讲能力。而演讲要做得好，首先需要结构化思维，你得表达清晰；在此基础上，你需要会讲故事，能够打动听众，而讲故事也是一种能力。再比如说，很多人说我表达不清晰，那我就去学表达，但表达其实本质上是大脑在说话，大多数人表达不清晰，并不是因为表达能力的问题，而是本身思维就不清晰，所以思维和表达得一起提升。所以说，能力的训练是需要系统化的，因为它们本身相互关联。</p><p><strong> 另一方面，能力需要刻意练习，而刻意练习需要时间。</strong> 我在前面说到的结构化思维的例子，虽然已经帮你挑出那 20% 最关键的部分了，但它也不是一蹴而就的，也是个系统提升。比如，1 个月的计划中，先是每天练习讲三段式，再是练习提炼主题，然后是积累结构，基本上每天是不间断的。</p><p>这样的系统训练需要一段时间的，但很多时候 <strong> 我们的习惯，是高估几天的变化，而低估几个月的变化 </strong>，所以很难坚持系统化训练。</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121154128.png" alt=""></p><p>比如说减肥，你这周有兴致就跑步 2 次，下周有兴致就节食 1 次，再下一周从外卖改自己做饭，之后再参加了几次减肥训练营。你会发现，几个月之后，也不会有什么变化。因为减肥是个系统工程，你得有一个 3 个月计划，按照计划，今天跑步、明天健身房，同时辅助饮食调整。</p><p>学习是一样的，今天学点结构化思维，明天练一下演讲，很难有真正的提升。知识的学习是大脑增加了一段记忆，但能力的提升是行为和思维方式发生改变，而行为和思维方式是短时间内很难改变的。</p><p>所以，<strong> 圈外商学院里面，针对能力提升的学习，只做系统化学习项目 </strong>，包括课程、练习及反馈，也有线上线下学习社群，整个学习持续 4-8 个月。效果如何呢？我在开学的时候，会寄给大家一封入学欢迎信，要求大家在毕业的时候给我回信。我收到过上百封回信，以及近千个微信消息，都提到说，<strong> 原以为几个月很长，但真正结束后，回头看，没有想到几个月可以有这些改变 </strong>。</p><p>好了，总结一下，今天提到了将知识内化成能力的三个方法：掌握核心的 20%、知识和问题互相靠以及系统化训练。具体到我们的行动中，如果我们有需要提升的能力，<strong> 首先要先找到专业人士，了解这个领域的核心 20% 是什么，先去学习那 20%；然后在学习过程中，思考各个知识点的应用场景，并记录下来，遇到问题再返回去找；最后，能力提升是个系统性过程，所以需要坚持至少 1 个月。</strong></p><p>我经常用开车来打比方，你拿着一本开车指南然后背下来，里面的知识背得再熟，一点价值都没有；你把指南里的知识落地，真正上车然后开起来，才是有价值的。知识不能被内化成能力，就像守着一本开车指南却不会开车一样，除了浪费大脑内存之外，毫无意义。互联网时代，我们要记住一句话：<strong> 大脑不单是用来记忆的，更是用来思考的。</strong></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121154147.png" alt=""></p><p>好了，现在我们知道了如何通过学习将知识内化成能力，但学习说到底是一件反人性的事情，很难坚持，更何况是要系统化训练。实际上，<strong> 学习这件事，如果纯靠意志力，的确是不可持续的 </strong>，那如何能够让自己坚持学习呢？这个领域有什么样的研究和方法呢？我们将在下节课揭晓。<strong> 这个方法不仅对学习有用，对任何需要坚持的正面行为，比如健身，都会非常有用。</strong></p><h2 id="三大系统，让学习不靠意志力"><a href="#三大系统，让学习不靠意志力" class="headerlink" title="三大系统，让学习不靠意志力"></a>三大系统，让学习不靠意志力</h2><p><strong> 本节学习收获：</strong> 学会掌控自己的三类方法，让你不靠意志力，也能坚持学习</p><p>我们经常会听到诸如此类：如果坚持每天背 20 个单词，一年词汇量就接近 8000 了，基本是托福的词汇量；如果坚持每天写 2000 字，两个月就 12 万字了，就可以出一本书。</p><p>我们都知道这个积少成多、长期坚持的道理，但是，有多少人真正坚持得了呢？</p><p>上节课我们提到，能力提升比知识学习更难，当然，因为难所以才有价值，如果非常简单，就没什么竞争力了。但是，这么难的事情，要怎么才能坚持呢？</p><p>靠意志力吗？我们都是这么想的，所以经常会说 “xx 很自律”“xx 意志力惊人”。</p><p>但实际上，<strong> 因为人的意志力是有限的，任何让自己坚持的事情，都会消耗它，从而让你感觉非常累。比如你会发现，如果我们一段时间工作压力很大，就会更容易放弃健身等等良好习惯，因为我们的意志力在坚持工作这方面已经耗费光了，所以就没有多余的意志力用在坚持健身上了。</strong></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121154255.png" alt=""></p><p><strong> 学习也是一样，当你坚持学习的时候，不是 “学习” 这件事情累着你，而是 “坚持” 这件事情累着你了，因为意志力会耗费大量能量。</strong></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121154306.png" alt=""></p><p>而且在 <strong> 移动互联网时代，我们会发现，自己的意志力好像越来越薄弱。</strong> 以前高中时期，能坚持学习 2 个小时，但现在看 1 小时书，就觉得如坐针毡。很简单，因为我们面对的诱惑更多了，游戏、短视频、微博等等这些，都比学习的诱惑力更大，只要我们脑子里有这些东西，就需要不断耗费我们的意志力来抵制他们，才能最终坚持学习，所以我们才会很累。</p><p><strong> 威尔海姆・霍夫曼（Wilhelm Hofmann）主持的一项研究表明，人们醒着的时候，把大约 1/4 的时间用来抵制欲望。</strong> 而这个研究是在 BP 机时代做的，近二十年间，移动互联网兴起带来的诱惑，比如游戏、短视频、段子等等，比过去上千年的诱惑加起来还要多，所以 <strong> 我们每天需要抵制更多欲望。这也是为什么，我们常常觉得，没做什么事情，也会感到很心累的原因。</strong></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121154323.png" alt=""></p><p>好了，诱惑那么多，意志力又不够用，那怎么办呢？今天我们就从行为改变的方法论角度，来讲讲，如何不纯靠意志力来学习。这个方法，不只是适用于学习，还适用于其他任何有点 “反人性” 的事情，比如健身、跑步等等。</p><p>心理学家早就对我们的大脑做过研究，学界普遍认为，<strong> 人类大脑内部有两个系统：理性和感性。</strong></p><p><strong> 感性跟情感有关，是天性和本能。而理性则跟理智有关，让我们能够深思熟虑。我们决定做任何事情的时候，都是这两部分在起作用。</strong></p><p>比如说，你在刷抖音，感性会告诉你 “视频很有趣，继续刷吧，你会很快乐”，而理性却告诉你 “别刷了，要去学习，否则将来没有前途”。</p><p>理性和感性是你的内部因素，而做一件事情还有外部因素的影响，这就是情境。关于情境我打个比方，如果你周围都是胖子，那么你变胖的概率会大大增加。如果你周围人都爱学习，那么你也会变得更爱学习。</p><p>所以，总结来说，<strong> 如果要让我们能够坚持做一件事情，比如学习，并不是只能靠意志力的，其实有三个关键因素：理性上知道要学习、情感上愿意去学习、情境上制造适合学习的场景 </strong>。接下来，我们从这三个方面去展开，看看有哪些方法，能让我们坚持做成一些事情，而不是白天堕落，晚上后悔然后发誓，第二天继续这个堕落、后悔和发誓的循环。</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121154339.png" alt=""></p><p><strong>1. 发挥理性的作用：树立明确目标 </strong></p><p>假设我让你追一只猫，如果我跟你说：“目标在东北方向！” 你能快速找到吗？很难。</p><p>但如果跟你说：“目标在东北方向一公里处的圈外办公室！” 那你更有可能会找到。</p><p>所以，我们的目标需要足够明确。</p><p>比如，你跟自己下了无数次决心：要多看书，不能再不学无术了。然后呢？你继续刷剧去了。但如果你跟自己说：每天晚上睡前看 10 分钟书。那么，你更有可能会做到。</p><p>所以，当你有明确目标的时候，同样的事情会有完全不一样的效果，你会更容易坚持。</p><p>这里给个数据，在圈外商学院的课程内，会有一个模块是专门用来写学习目标的。我们曾经做过一个数据分析，分析那些写目标的和不写目标的人，最后课程完成率有没有差异。最后的结果是，写目标的人的完成率是没有写的人的 1.5 倍。</p><p><strong> 所以，给自己一个明确的目标，是你坚持学习的第一步。</strong></p><p><strong>2. 发挥感性的作用：利用情绪冲动 </strong></p><p>比如，如果我讲很多大道理，从理性的角度去说服你，应该给希望工程捐钱以支持失学儿童，你可能很难做出改变。但是，如果我给你一张失学儿童的照片，看到她渴望学校的眼神，你可能会被触动，然后做出了捐款行为。这就是情绪的力量。</p><p>为什么化妆品、医美等等这样的产品，都在不断煽动女性对衰老的恐惧，因为恐惧是一种情绪，会让你有冲动付费。</p><p>而 <strong> 能够促进你行为的情绪不只是恐惧，其实有很多种，比如愧疚感、认同感、成就感，等等。</strong> 这里我给你建议几个利用情感的方法，用圈外过去所做的很多尝试为例 ——</p><p><strong> 方法 1 - 截止日期的紧迫感：</strong></p><p>豆瓣 9.4 分英剧《黑镜》的编剧查理・布洛克，收到过很多邮件，都是问他，怎么写出这么好的剧本。他回复大家说：<strong>“不要谈什么天分、运气，你需要的是一个截稿日，以及一个不交稿就能打爆你狗头的人，然后你就会被自己的才华吓到。”</strong></p><p>圈外商学院的课程，有个规定：在 30 天之内学完，你可以终身永久回看，而且可以看最新版本，因为我们课程会不断迭代；但如果你 30 天之内没有学完，课程就会关闭，哪怕你付了钱。很多人抱怨这个政策，但我们一直没改，因为我们看过数据，截止日前 3 天大家都在拼命学习和写作业，如果取消这个截止日期，谁会去马上学一个终身有效、没有截止日期的课程呢？</p><p><strong> 所以，deadline 是第一生产力。</strong></p><p><strong> 方法 2 - 比较产生的焦虑感：</strong></p><p>举个我自己的例子，其实我在创业之前也纠结了很久，不知道自己能力是不是足够，总觉得没有准备好。当时我的好朋友，也是现在圈外的联合创始人杰西，就跟我说 “你看你都这么大年纪了，现在创始人都很年轻，你再不创业就老了”，后来我就一咬牙出来了，也才有了现在的圈外同学。</p><p>顺便说一句，我现在经常给很多人一个建议：<strong> 你需要一个在关键时刻踹你一脚的人，因为人都是有惰性的。</strong></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121154357.png" alt=""></p><p><strong> 方法 3 - 鼓励带来的成就感：</strong></p><p>在圈外，我们曾经做过一个对比，早期的产品是没有班主任服务的，也没有助教，那时候的完课率只有百分之十几。后来我们先尝试了给学员分班级、配备班主任，主要就是根据学员的学习情况鼓励他们，那时候还没有助教、学习游戏，但是完课率直接提升到了百分之五十多，基本就是社群和班主任鼓励的作用。</p><p>当然，其他还有很多情感很有用，比如对未来的期待感，如果你是想从传统行业到互联网行业，想通过学习来实现，那么有一个已经成功转型、而且实现了 2 倍涨薪的人来告诉你，他是通过学习来实现的，然后给了你他的 3 个月学习计划，你是不是很有信心学习呢？</p><p><strong>3. 发挥情境的作用：创造学习环境 </strong></p><p>好了，理性和情感说完，最后说说情境的作用。</p><p>还记得我们前面举的例子吗？如果你周围的人都是胖子，那你减肥的成功率会低很多。</p><p>这很容易理解，<strong> 人是社会动物，我们会观察周围人的行为来调整自己的行为。</strong></p><p>最简单的，你去一个陌生的社交场合，你会多说话还是少说话、多吃还是少吃呢？大多数人的做法是，看周围人怎么做。</p><p>学习也是一样的，很多人都发现，跟一群人一起讨论学习，会更容易坚持。</p><p>原因很简单，爱学习爱思考的人并不多，现实生活中，大多数人都在看娱乐八卦，如果你在学习，会觉得自己很突兀。但是 <strong> 到了学习社群就不一样了，大家都在学习，你也会模仿其他人 </strong>，这也是为什么，圈外的课程都有线上线下社群的原因，就是为了有这样一个氛围。</p><p>情境里除了同伴因素以外，还有其他因素。举个例子，如果你比较容易被抖音干扰学习，那你把手机锁起来，制造一个专注的环境，这个问题就解决了。所以，<strong> 如果想让你不看电视，最好的方法是别买电视；如果想让你少刷朋友圈，最好的办法是把小红点功能关掉，甚至，把朋友圈关掉；如果想让你别再剁手，最好的方法是把淘宝卸了，或者把信用卡额度冻结了。</strong></p><p><strong> 如果可以用环境，就不要用你的意志力来抵制欲望。</strong></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121154411.png" alt=""></p><p>好了，我们总结一下，学习这件事，是不能纯靠意志力的，因为意志力非常有限，非常耗费能量。所以，你得利用自己的理性和感性两大系统，结合情境，让你愿意学习：首先利用你的理性系统，设定非常清晰量化的目标；然后，利用自己的情绪冲动，包括焦虑感、成就感等等，去促进学习；最后，还要让自己处于一个适合学习的情境。</p><p>2018 年 10 月，在中国拥有近五千万职场用户的 LinkedIn (领英)，做了一个调研，发布了一份 <strong>《职场人转折点报告》。报告中有个有趣的发现：每月收入低于 3000 元的职场人加班时间最长，而相较之下，每月收入大于 4 万元的职场人学习时间最长。</strong> 可以看出，能提升我们市场价值的，可能不是加班，而是学习。所以，希望你在掌握了这些方法之后，可以坚持学习提升。</p><p>到这里，我们的课程已经完成了 5 小节，如果你走到了这里，恭喜你，因为大部分人可能会在前面几天放弃。</p><p>之前的几小节，我们讲了如何选择适合的工作，选了工作之后如何投入时间以获得最大化价值，同时还给出了提升能力的方法，以及告诉你如何坚持学习提升。你有没有想过这些问题，<strong> 为什么我们现在都在说要终身学习呢？以及，为什么个人要自己花钱花时间学习呢？为什么企业越来越不愿意培养人了？不仅不愿意培养人，招来人干了几年之后，甚至会裁人 </strong>，导致我身边 35 岁的中年人每天都很焦虑，生怕遭遇中年失业。</p><h2 id="三个建议，让你不做-“定制化人才”"><a href="#三个建议，让你不做-“定制化人才”" class="headerlink" title="三个建议，让你不做 “定制化人才”"></a>三个建议，让你不做 “定制化人才”</h2><p><strong> 本节学习收获：</strong> 学会 3 个 “不变应万变” 的方法，避免成为 “企业定制化人才”。</p><p>我的一位中学同学，在某个耳熟能详的大外企做工程师。工作 10 年，接受了很多公司培训，还经常有国外出差的机会，自己的表现也一直都属于中上游。3 年前，他所在的业务开始缩减人员，最近一个关系好的同事也离开公司去创业了，他也觉得自己要做些改变，打算转行。</p><p>但是，信心满满地投了几十份简历，几乎没什么回音。唯一拿到的一个 offer，对方公司开出的薪酬只有现在的 70%。</p><p>照理说，我这位同学也算是大公司的优秀人才，怎么出了公司，竟然找不到合适的工作呢？</p><p>《国富论》里亚当・斯密提到的一个扣针工厂的例子：<strong> 一个工人无论如何努力，一天也生产不了 20 枚扣针，但有了分工之后，经过前后十几道工序，每人每天平均可以生产 48000 枚扣针。</strong> 这就是专业化分工的高效性！</p><p>任何一家公司，从老板的角度肯定是要提高效率、多赚钱，所以必然走向专业化分工，<strong> 把一个工作切成很多块，每个人都终日重复其中某一块，这样能提高效率、降低风险，同时也降低对人的依赖。</strong></p><p>但是，这对人才来说是灾难性的。因为亚当・斯密也说过 <strong>“如果一个人的全部心思都用在一只扣针的十几分之一时，见识必然有限”。</strong></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121154525.png" alt=""></p><p>精细化分工的结果是，你成为了一个企业定制化人才，极端一点说，就像一颗螺丝钉，尺寸和材质只能用在一个产品上，挪到别处去，就成了废铁，被这个产品牢牢困住。</p><p>这是我那位同学之所以跳槽失败的原因。</p><p><strong> 那么，我们要如何避免被定制化呢？</strong></p><p>从我过去帮助 7 个行业的近百家头部企业设计人才管理体系的经验来说，我给你三个建议 <strong>。第一，调整主体，给自己定好发展方向；第二，提升能力，让自己成为横向可迁移的人才；第三，提升认知高度，让自己成为纵向可拓展的人才。</strong></p><p><strong>1、调整主体，给自己定好发展方向 </strong></p><p>我之前公司做的一个调研数据很有意思：<strong>10 年前，一个人在一家公司所待的时间是 3-4 年，而现在，一个人在一家公司平均只会待 1 年多 **</strong>。**</p><p><strong> 这是人才侧的数据，而从企业来说，我 10 多年前刚做咨询的时候，企业做战略规划都是 5 年甚至 10 年，而现在，能够拿得出清晰 3 年战略的企业，已经不多了。而中国企业的平均寿命不到 3 年。</strong></p><p>在这种情况下，<strong> 企业没有任何动力培养人才 </strong>，一方面人才只在公司平均待 1 年多，培养好之后还来不及给公司提供足够多的贡献，对企业来说根本不划算；另一方面，外部环境竞争激烈，培养人才所需要的时间，企业根本耗不起。所以，企业越来越倾向于用现成的人。而当所有企业都想用现成人才的时候，其实就是企业将过去所承担的人才培养成本，逐渐转移到了个人身上。</p><p><strong> 在这种趋势下，个人不可能把安全感寄托于企业。</strong></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121154538.png" alt=""></p><p>所以，我们现在倡导所谓 “终身学习”，不是因为人们这两年突然爱学习了，是因为学习变成了生存下去所必须做的事情。企业定制化人才越来越没有竞争力，只有主动学习、提升能力才能适应时代。</p><p>怎么转移主体呢？听起来好像很虚，如何落地？很简单，<strong> 当你进入一家公司的时候，就要想好：如果我离开这里，还能干嘛？</strong> 就像我前面课程所说的，你去领英等等招聘网站上，搜索一下这个职位出去的人都在做什么，就知道将来是否有出路了。</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121154554.png" alt=""></p><p><strong>2、提升能力，让自己成为横向可迁移的人才 </strong></p><p>亚马逊创始人贝佐斯曾说：“人们常问我，未来十年，什么会改变；人们几乎从来不曾问我，未来十年，什么不会变。”</p><p>他觉得，这个世界不管怎么变，都很难想象，人们有一天会希望物品价格越高越好，物流速度越慢越好。所以，这两个因素就是不变的因素，做好这些，比每天追逐变化要有效得多。</p><p><strong> 作为人才也是一样，要想不被企业定制化，让自己成为万能零件，不受环境影响，也是要找到那些不变的因素。</strong></p><p><strong> 那对我们来说，什么是那个不变的因素呢？就是我们之前课程提到的，可迁移能力。</strong></p><p>当然，<strong> 不同发展阶段的能力要求有不同 </strong>。在很多公司内部，针对不同阶段的员工，都会有不同的能力模型，晋升以及招聘的时候就是用这一套标准来筛人的，而且各家公司其实有很多共性，这就是可迁移能力。</p><p><strong> 如果是职场新人 </strong>，要成为资深员工或者主管，需要具备：独立思考的能力、多任务高效工作的能力、清晰表达的能力、基础的人际拓展能力。</p><p><strong> 如果到了要带一个小团队、或者在公司内部管理一些项目的阶段 </strong>，则需要具备：解决复杂问题和创新的思维能力、辅导和激励下属让团队提升效率的能力、在公开场合演讲表达能力、处理复杂人际冲突的沟通能力。</p><p><strong> 而如果是成为管理者，开始带整个部门的时候，需要具备的能力包括 </strong>：在思维方面，掌握战略思维以及理性的经济学思维；在效率方面，需要掌握一些运营和财务的知识，更好地配置资源；同时，需要掌握营销思维，贯穿在工作全流程中；最后，在人际方面，需要全面的领导力。</p><p><strong>3、提升认知高度，让自己成为纵向可拓展的人才 </strong></p><p>上面讲的是提升可迁移能力，这样不局限在某个垂直领域。<strong> 而除了横向可迁移之外，还得纵向可迁移 </strong>，也就是说，提升自己的认知高度。就像亚当・斯密所说的，如果你全部精力都在某个产品的某个工序，见识一定是有限的，所以你得跳出这道工序，了解整个产品。</p><p><strong> 你需要去思考：</strong></p><ul><li><strong> 这个行业和公司的关键成功要素是什么？</strong></li><li><strong> 对用户对社会的价值是什么？</strong></li><li><strong> 你所在的部门和岗位，对公司的核心价值是什么？</strong></li></ul><p>从更加宏观的角度去看问题，至少成为一个比螺丝钉更大的零件。</p><p>而且在职场，职位越高，对专业的要求会降低，而对战略全局观、商业敏感度和领导力的要求是越来越高的。</p><p>那如何去提高这些能力呢？</p><p>大多数人的第一选择是去读个 MBA，领英在 2017 年的报告显示：高达 79% 的职场白领都想过读 MBA。但实际上，去读的只占中国职场人比例的不到 1%。几十万的学费、2 年的时间，都是极大的机会成本。</p><p><strong> 好了，总结一下这节课程，要想不成为 “定制化人才”，我们需要：第一，调整主体，给自己定好发展方向；第二，提升能力，让自己成为横向可迁移的人才；第三，提升认知高度，让自己成为纵向可拓展的人才。</strong></p><p><strong> 到这里呢，你已经完成了这个课程的学习。</strong></p><p><strong> 我们稍微总结一下：</strong> 首先我们学习了冰山模型，知道了自己为什么会不喜欢一份工作，以及怎么找到跟自己匹配的工作；接着，继续从冰山模型出发，分析应该把时间花在什么要素上面，才能有市场价值的提升，我们得出了提升能力的结论；然后我们通过两小节讲了能力如何提升，首先是找到自己的天赋，也就是隐藏的能力，其次是掌握 3 个方法、将学到的知识内化成能力；而要做到这些，离不开对学习的坚持，坚持学习很难，而意志力又很有限，所以要掌握理性、感性和情境三类方法。最后，关于如何应对未来的加速变化，答案是不要成为企业定制化人才。</p><p>通过这 6 小节课程，我想要告诉你的是：无论你对未来迷茫也好、遇到发展瓶颈也好，其实都是有解决方案的。<strong> 社会发展到今天，你所遇到的几乎每个问题，这个世界上都有人曾经成功解决过它，我们要做的，就是去学习 **</strong>，没有太多的问题需要我们重复造轮子。** 克林顿曾提到，世界上几乎每个问题都已经在某个地方被某个人解决，我们的挑战是找到那些有效的解决方案。</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121154610.png" alt=""></p><p><strong> 马斯洛说：“教育是让一个人成为最好版本的自己”</strong>，给自己一个机会，用几个月的时间，真正用正确的方法，来训练一下自己，看看自己最好的状态到底是什么样的！</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191121154624.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      圈外同学个人发展战略课程
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>Linux 后台运行任务 nohup 结合 &amp; 用法以及如何精准查找进程并 kill 后台任务实践</title>
    <link href="https://wsgzao.github.io/post/nohup/"/>
    <id>https://wsgzao.github.io/post/nohup/</id>
    <published>2019-11-15T06:59:49.000Z</published>
    <updated>2019-11-15T12:01:34.699Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>nohup 为什么要跟着 &amp; 一起使用，不知道大家有没有思考过其中的小区别，另外很多人会推崇使用 screen，但是实际生产环境应用场景有限我就不展开了。这次实际遇到的问题主要是因为使用 crontab 调用了多个不同的 nohup 后台执行任务，然而代码逻辑中出现对相同文件的占用导致任务进程产生冲突使得 system load 负载达到 600 之高，需要 kill 任务时也不能盲目操作，需要杀掉的进程多且进程名与其它正常的进程名字有交集，需要合理运用 pstree 找到问题的源头。</p><blockquote><p>Linux 后台运行任务 nohup 结合 &amp; 用法以及如何精准查找进程并 kill 后台任务实践</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 11 月 15 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/nohup/">https://wsgzao.github.io/post/nohup/</a></p><p><strong> 扩展阅读 </strong></p><hr><h2 id="nohup-介绍"><a href="#nohup-介绍" class="headerlink" title="nohup 介绍"></a>nohup 介绍</h2><p>用途：不挂断地运行命令。</p><p>语法：nohup Command [Arg …] [　&amp; ]</p><ul><li>无论是否将 nohup 命令的输出重定向到终端，输出都将附加到当前目录的 nohup.out 文件中。</li><li>如果当前目录的 nohup.out 文件不可写，输出重定向到 $HOME/nohup.out 文件中。</li><li>如果没有文件能创建或打开以用于追加，那么 Command 参数指定的命令不可调用。</li></ul><p>退出状态：该命令返回下列出口值：</p><ul><li>126 可以查找但不能调用 Command 参数指定的命令。</li><li>127 nohup 命令发生错误或不能查找由 Command 参数指定的命令。否则 nohup 命令的退出状态是 Command 参数指定命令的退出状态。</li></ul><h2 id="nohup-和-amp-的关系"><a href="#nohup-和-amp-的关系" class="headerlink" title="nohup 和 &amp; 的关系"></a>nohup 和 &amp; 的关系</h2><p>使用 <code>nohup</code> 运行程序:</p><ul><li>输出重定向，默认重定向到当前目录下 nohup.out 文件</li><li>使用 Ctrl + C 发送 SIGINT 信号，程序关闭</li><li>关闭 Shell Session 发送 SIGHUP 信号，程序免疫</li></ul><p>使用 <code>&amp;</code> 运行程序：</p><ul><li>程序转入后台运行</li><li>结果会输出到终端</li><li>使用 Ctrl + C 发送 SIGINT 信号，程序免疫</li><li>关闭 Shell session 发送 SIGHUP 信号，程序关闭</li></ul><h2 id="nohup-和-amp-使用实例"><a href="#nohup-和-amp-使用实例" class="headerlink" title="nohup 和 &amp; 使用实例"></a>nohup 和 &amp; 使用实例</h2><blockquote><p>一般两个一起组合使用不会受 Ctrl C 和 Shell 关闭的影响：</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 最简单的后台运行 </span></span><br><span class="line">nohup <span class="built_in">command</span> &amp;</span><br><span class="line"><span class="comment"># 输出默认重定向到当前目录下 nohup.out 文件 </span></span><br><span class="line">nohup python main.py &amp;  </span><br><span class="line"><span class="comment"># 自定义输出文件 (标准输出和错误输出合并到 main.log)</span></span><br><span class="line">nohup python main.py &gt;&gt; main.log 2&gt;&amp;1 &amp; </span><br><span class="line"><span class="comment"># 与上一个例子相同作用的简写方法 </span></span><br><span class="line">nohup python main.py &amp;&gt; main.log &amp;</span><br><span class="line"><span class="comment"># 不记录输出信息 </span></span><br><span class="line">nohup python main.py &amp;&gt; /dev/null &amp;</span><br><span class="line"><span class="comment"># 不记录输出信息并将程序的进程号写入 pidfile.txt 文件中，方便后续杀死进程 </span></span><br><span class="line">nohup python main.py &amp;&gt; /dev/null &amp; <span class="built_in">echo</span> $! &gt; pidfile.txt</span><br></pre></td></tr></table></figure><p>由于使用 nohup 时，会自动将输出写入 nohup.out 文件中，如果文件很大的话，nohup.out 就会不停的增大，我们可以利用 Linux 下一个特殊的文件 /dev/null 来解决这个问题，这个文件就相当于一个黑洞，任何输出到这个文件的东西都将消失 只保留输出错误信息 nohup command &gt;/dev/null 2&gt;log &amp; 所有信息都不要 nohup command &gt;/dev/null 2&gt;&amp;1 &amp;</p><p>这里解释一下后面的 2&gt;&amp;1 。 这涉及到 Linux 的重定向，其中 0、1、2 分别是标准输入、标准输出、标准错误输出，用来指定需要重定向的标准输入输出。默认情况下是标出输出，也就是 1 。例如我们而上文提到的 2&gt;&amp;1 是 将错误信息重定向到标准输出。</p><p>还有就是如果不想让程序输出，Linux 下有一个 /dev/null 的特殊文件，就像一个黑洞，所有输出到这个文件的信息全部会消失，如果你不需要输出日志，这样做就不会导致输出日志文件越来越大，占用存储空间的问题了</p><blockquote><p>其他相关命令</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 结束当前任务 </span><br><span class="line">ctrl+c</span><br><span class="line"># 将一个正在前台执行的命令放到后台，并且处于暂停状态 </span><br><span class="line">ctrl+z</span><br><span class="line"># 查看任务，返回任务编号 和 进程号 </span><br><span class="line">jobs -l</span><br><span class="line"># 将一个在后台暂停的命令，变成在后台继续执行。如果后台中有多个命令，可以用 bg %jobnumber 将选中的命令调出。</span><br><span class="line">bg %jobnumber</span><br><span class="line"># 将后台中的命令调至前台继续运行。如果后台中有多个命令，可以用 fg %jobnumber（是命令编号，不是进程号）将选中的命令调出 </span><br><span class="line">fg %jobnumber</span><br></pre></td></tr></table></figure><blockquote><p>编写一个测试脚本</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="keyword">for</span> ((i=1; i&lt;1000; i++))</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    d=`date <span class="string">'+%Y-%m-%d %H:%M:%S'</span>`</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$d</span> print <span class="variable">$&#123;i&#125;</span>"</span></span><br><span class="line">    sleep 2s</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h2 id="查找后台运行程序"><a href="#查找后台运行程序" class="headerlink" title="查找后台运行程序"></a>查找后台运行程序</h2><ol><li>已知 pid 进程号当然最好了</li><li>使用 <code>ps -ef</code> 或者 <code>ps -aux</code> 结合 <code>grep</code> 过滤</li><li>使用 <code>pstree -p</code> 确认复杂进程树结构</li><li>使用 <code>lsof -i:80</code> 查端口获得进程号</li><li>使用 <code>netstat -anp | grep 80</code> 查端口获得进程号，推荐使用 <code>lsof</code></li></ol><h2 id="杀死后台运行程序"><a href="#杀死后台运行程序" class="headerlink" title="杀死后台运行程序"></a>杀死后台运行程序</h2><h3 id="kill"><a href="#kill" class="headerlink" title="kill"></a>kill</h3><p>kill 命令用来删除执行中的程序或工作。kill 可将指定的信息送至程序。预设的信息为 SIGTERM (15), 可将指定程序终止。若仍无法终止该程序，可使用 SIGKILL (9) 信息尝试强制删除程序，即 kill -9。程序或工作的编号可利用 ps 指令或 job 指令查看。</p><p>语法<br>kill(选项)(参数)</p><p>选项<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-a：当处理当前进程时，不限制命令名和进程号的对应关系；</span><br><span class="line">-l &lt; 信息编号 & gt;：若不加 & lt; 信息编号 & gt; 选项，则 - l 参数会列出全部的信息名称；</span><br><span class="line">-p：指定 kill 命令只打印相关进程的进程号，而不发送任何信号；</span><br><span class="line">-s &lt; 信息名称或编号 & gt;：指定要送出的信息；</span><br><span class="line">-u：指定用户。</span><br></pre></td></tr></table></figure></p><p>参数<br>进程或作业识别号：指定要删除的进程或作业。</p><p>实例<br>列出所有信号名称：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> kill -l</span><br><span class="line"> 1) SIGHUP       2) SIGINT       3) SIGQUIT      4) SIGILL</span><br><span class="line"> 5) SIGTRAP      6) SIGABRT      7) SIGBUS       8) SIGFPE</span><br><span class="line"> 9) SIGKILL     10) SIGUSR1     11) SIGSEGV     12) SIGUSR2</span><br><span class="line">13) SIGPIPE     14) SIGALRM     15) SIGTERM     16) SIGSTKFLT</span><br><span class="line">17) SIGCHLD     18) SIGCONT     19) SIGSTOP     20) SIGTSTP</span><br><span class="line">21) SIGTTIN     22) SIGTTOU     23) SIGURG      24) SIGXCPU</span><br><span class="line">25) SIGXFSZ     26) SIGVTALRM   27) SIGPROF     28) SIGWINCH</span><br><span class="line">29) SIGIO       30) SIGPWR      31) SIGSYS      34) SIGRTMIN</span><br><span class="line">35) SIGRTMIN+1  36) SIGRTMIN+2  37) SIGRTMIN+3  38) SIGRTMIN+4</span><br><span class="line">39) SIGRTMIN+5  40) SIGRTMIN+6  41) SIGRTMIN+7  42) SIGRTMIN+8</span><br><span class="line">43) SIGRTMIN+9  44) SIGRTMIN+10 45) SIGRTMIN+11 46) SIGRTMIN+12</span><br><span class="line">47) SIGRTMIN+13 48) SIGRTMIN+14 49) SIGRTMIN+15 50) SIGRTMAX-14</span><br><span class="line">51) SIGRTMAX-13 52) SIGRTMAX-12 53) SIGRTMAX-11 54) SIGRTMAX-10</span><br><span class="line">55) SIGRTMAX-9  56) SIGRTMAX-8  57) SIGRTMAX-7  58) SIGRTMAX-6</span><br><span class="line">59) SIGRTMAX-5  60) SIGRTMAX-4  61) SIGRTMAX-3  62) SIGRTMAX-2</span><br><span class="line">63) SIGRTMAX-1  64) SIGRTMAX</span><br></pre></td></tr></table></figure></p><p>只有第 9 种信号 (SIGKILL) 才可以无条件终止进程，其他信号进程都有权利忽略，下面是常用的信号：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HUP     1    终端断线 </span><br><span class="line">INT     2    中断（同 Ctrl + C）</span><br><span class="line">QUIT    3    退出（同 Ctrl + \）</span><br><span class="line">TERM   15    终止 </span><br><span class="line">KILL    9    强制终止 </span><br><span class="line">CONT   18    继续（与 STOP 相反， fg/bg 命令）</span><br><span class="line">STOP   19    暂停（同 Ctrl + Z）</span><br></pre></td></tr></table></figure></p><p>先用 ps 查找进程，然后用 kill 杀掉：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep vim</span><br><span class="line">root      3268  2884  0 16:21 pts/1    00:00:00 vim install.log</span><br><span class="line">root      3370  2822  0 16:21 pts/0    00:00:00 grep vim</span><br><span class="line"></span><br><span class="line">kill 3268</span><br><span class="line">kill 3268</span><br><span class="line">-bash: kill: (3268) - 没有那个进程 </span><br></pre></td></tr></table></figure></p><h3 id="killall"><a href="#killall" class="headerlink" title="killall"></a>killall</h3><p>killall 和 pill 命令差不多都是使用进程的名称来杀死进程，使用此指令可以杀死一组同名进程。我们可以使用 kill 命令杀死指定进程 PID 的进程，如果要找到我们需要杀死的进程，我们还需要在之前使用 ps 等命令再配合 grep 来查找进程，而 killall 把这两个过程合二为一，是一个很好用的命令。</p><p>语法<br>killall(选项)(参数)</p><p>选项<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-e：对长名称进行精确匹配；</span><br><span class="line">-l：忽略大小写的不同；</span><br><span class="line">-p：杀死进程所属的进程组；</span><br><span class="line">-i：交互式杀死进程，杀死进程前需要进行确认；</span><br><span class="line">-l：打印所有已知信号列表；</span><br><span class="line">-q：如果没有进程被杀死。则不输出任何信息；</span><br><span class="line">-r：使用正规表达式匹配要杀死的进程名称；</span><br><span class="line">-s：用指定的进程号代替默认信号 “SIGTERM”；</span><br><span class="line">-u：杀死指定用户的进程。</span><br></pre></td></tr></table></figure></p><p>参数<br>进程名称：指定要杀死的进程名称。</p><p>实例<br>杀死所有同名进程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">killall vi</span><br></pre></td></tr></table></figure></p><h3 id="使用-pstree-查找和杀死复杂进程"><a href="#使用-pstree-查找和杀死复杂进程" class="headerlink" title="使用 pstree 查找和杀死复杂进程"></a>使用 pstree 查找和杀死复杂进程</h3><p>常见的 3 个 kill 命令</p><ul><li>kill</li><li>pkill</li><li>killall</li></ul><p>搭配查找进程命令</p><ul><li>pidof</li><li>pstree</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 已知进程号，启动时输出后台运行程序的进程号，然后读取进程号杀死后台程序：</span></span><br><span class="line"><span class="built_in">kill</span> -9 `cat pidfile.txt`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进程数量较多且有规律，不和其他正常进程冲突 </span></span><br><span class="line">killall 进程名 </span><br><span class="line"><span class="built_in">kill</span> -9 $(pidof 进程名)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进程数量多，规律不明显，混了正常进程 </span></span><br><span class="line">pstree -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复杂点的情况比如像我遇到的真实案例 </span></span><br><span class="line">|-crond(127436)-+-crond(138887)---bash(138892)---bash(138895)---grep(140604)</span><br><span class="line">|               |-crond(139310)---bash(139323)---bash(139324)---python(139431)</span><br><span class="line">|               |-crond(139311)---bash(139325)---bash(139331)---python(139452)</span><br><span class="line">|               |-crond(139312)---bash(139318)---bash(139319)---python(139442)</span><br><span class="line">|               |-crond(139313)---bash(139317)---bash(139320)---python(139444)</span><br><span class="line">|               |-crond(139314)---bash(139329)---bash(139340)---python(139443)</span><br><span class="line">|               |-crond(139315)---bash(139327)---bash(139339)---grep(140768)</span><br><span class="line">|               |-crond(139651)---bash(139660)---bash(139661)---python(139915)</span><br><span class="line">|               |-crond(139652)---bash(139664)---bash(139666)---python(139916)</span><br><span class="line">|               |-crond(139653)---bash(139663)---bash(139665)---python(139914)</span><br><span class="line">|               |-crond(139654)---bash(139675)---bash(139683)---python(139918)</span><br><span class="line">|               |-crond(139655)---bash(139668)---bash(139677)---python(139913)</span><br><span class="line">|               `-crond(139656)---bash(139669)---bash(139682)---grep(139780)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果你喜欢用 grep 也没有问题，多设置几个过滤条件语句组合在一起即可 </span></span><br><span class="line">ps -ef | grep <span class="string">'python'</span> | grep -v grep | awk <span class="string">'&#123;print $2&#125;'</span> |xargs <span class="built_in">kill</span> -9</span><br></pre></td></tr></table></figure><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://woodenrobot.me/2019/07/04/Linux-%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8C%E4%BB%BB%E5%8A%A1-nohup-%E5%92%8C/" target="_blank" rel="noopener">Linux 后台运行任务 nohup 和 &amp;</a></p><p><a href="https://www.2daygeek.com/kill-terminate-a-process-in-linux-using-kill-pkill-killall-command/" target="_blank" rel="noopener">3 Easy Ways to Kill or Terminate a Process on Linux</a></p>]]></content>
    
    <summary type="html">
    
      Linux后台运行任务nohup结合&amp;用法以及如何精准查找进程并kill后台任务实践
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>Nginx 基础知识从小白到入门</title>
    <link href="https://wsgzao.github.io/post/nginx/"/>
    <id>https://wsgzao.github.io/post/nginx/</id>
    <published>2019-11-12T06:59:49.000Z</published>
    <updated>2019-11-13T11:00:28.776Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Nginx 现在几乎是众多大型网站的必用技术，大家应该都知道 <a href="https://www.nginx.com/blog/nginx-joins-f5/" target="_blank" rel="noopener">Nginx 被 F5 收购</a> 的大事件，章亦春也在专心维护 OpenResty 项目构建和谐家园，无论你选择 Nginx 还是 OpenResty，都需要对 Nginx 有一个比较全面的了解，日后才能做到事半功倍。本文以开发者必备的 Nginx 基础知识为主，在参考文章中罗列了目前比较优秀的 Nginx 和 OpenResty 参考教程，希望对大家有帮助。</p><blockquote><p>Nginx 基础知识从小白到入门</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 11 月 12 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/nginx/">https://wsgzao.github.io/post/nginx/</a></p><p><strong> 扩展阅读 </strong></p><p><a href="https://nginx.org/" target="_blank" rel="noopener">nginx.org</a></p><p><a href="https://www.nginx.com/" target="_blank" rel="noopener">NGINX Plus</a></p><p><a href="https://openresty.org/" target="_blank" rel="noopener">OpenResty</a></p><hr><h2 id="Nginx-基础知识"><a href="#Nginx-基础知识" class="headerlink" title="Nginx 基础知识"></a>Nginx 基础知识</h2><blockquote><p>Nginx 是什么？</p></blockquote><p>Nginx 是一个 web 服务器，主要处理客户端和服务器的请求分发。</p><blockquote><p>特点和优势</p></blockquote><ol><li>高并发</li><li>热部署</li><li>快</li><li>低功耗</li><li>热部署</li></ol><blockquote><p>使用和扩展</p></blockquote><p>开源免费的 Nginx 与商业版 Nginx Plus，与之对应的是免费 OpenResty 与商业版 OpenResty</p><ul><li>开源版 <a href="https://nginx.org/" target="_blank" rel="noopener">nginx.org</a></li><li>商业版 <a href="https://www.nginx.com/" target="_blank" rel="noopener">NGINX Plus</a></li><li>阿里巴巴 <a href="https://tengine.taobao.org/" target="_blank" rel="noopener">Tengine</a></li><li>开源版 <a href="https://openresty.org/" target="_blank" rel="noopener">OpenResty</a></li><li>商业版 <a href="https://openresty.com/" target="_blank" rel="noopener">OpenResty</a></li></ul><blockquote><p>陶辉《深入理解 Nginx》作者在极客时间上的讲义 PDF 已经介绍的非常详细了，如果觉得课程不错可以选择购买尽量少走弯路</p></blockquote><p><a href="https://github.com/russelltao/geektime-nginx" target="_blank" rel="noopener">极客时间：nginx 核心知识 100 讲配置文件与代码分享</a></p><h2 id="nginx-正向代理与反向代理"><a href="#nginx-正向代理与反向代理" class="headerlink" title="nginx 正向代理与反向代理"></a>nginx 正向代理与反向代理</h2><blockquote><p>为了便于理解，首先先来了解一下一些基础知识，nginx 是一个高性能的反向代理服务器那么什么是反向代理呢？</p></blockquote><p>代理是在服务器和客户端之间假设的一层服务器，代理将接收客户端的请求并将它转发给服务器，然后将服务端的响应转发给客户端。</p><p>不管是正向代理还是反向代理，实现的都是上面的功能。</p><p>如果你对 <a href="https://wsgzao.github.io/post/osi/">OSI 七层模型与 TCP/IP 四层模型</a> 不是很熟悉可以再回顾下</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191113180648.png" alt=""></p><blockquote><p>正向代理</p></blockquote><p>正向代理（forward）意思是一个位于客户端和原始服务器 (origin server) 之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标 (原始服务器)，然后代理向原始服务器转交请求并将获得的内容返回给客户端。</p><p>正向代理是为我们服务的，即为客户端服务的，客户端可以根据正向代理访问到它本身无法访问到的服务器资源。</p><p>正向代理对我们是透明的，对服务端是非透明的，即服务端并不知道自己收到的是来自代理的访问还是来自真实客户端的访问。</p><blockquote><p>反向代理</p></blockquote><p>反向代理（Reverse Proxy）方式是指以代理服务器来接受 internet 上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给 internet 上请求连接的客户端，此时代理服务器对外就表现为一个反向代理服务器。</p><p>反向代理是为服务端服务的，反向代理可以帮助服务器接收来自客户端的请求，帮助服务器做请求转发，负载均衡等。</p><p>反向代理对服务端是透明的，对我们是非透明的，即我们并不知道自己访问的是代理服务器，而服务器知道反向代理在为他服务。</p><h2 id="nginx-基本配置"><a href="#nginx-基本配置" class="headerlink" title="nginx 基本配置"></a>nginx 基本配置</h2><p>安装 nginx 时通常需要编译自己需要的模块，可以<a href="https://wsgzao.github.io/post/rpmbuild/">使用 rpmbuild 制作 Nginx 的 RPM 包</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">main                                # 全局配置</span><br><span class="line"></span><br><span class="line">events &#123;                            # nginx 工作模式配置</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;                                # http 设置</span><br><span class="line">    ....</span><br><span class="line"></span><br><span class="line">    server &#123;                        # 服务器主机配置</span><br><span class="line">        ....</span><br><span class="line">        location &#123;                    # 路由配置</span><br><span class="line">            ....</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location path &#123;</span><br><span class="line">            ....</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location otherpath &#123;</span><br><span class="line">            ....</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        ....</span><br><span class="line"></span><br><span class="line">        location &#123;</span><br><span class="line">            ....</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    upstream name &#123;                    # 负载均衡配置</span><br><span class="line">        ....</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果想要生成 nginx 规范配置，可以参考<a href="https://nginxconfig.io/" target="_blank" rel="noopener">nginxconfig.io</a></p><p>下面是 <code>nginx</code> 一些配置中常用的内置全局变量，你可以在配置的任何位置使用它们。</p><table><thead><tr><th>变量名</th><th>功能</th></tr></thead><tbody><tr><td><code>$host</code></td><td>请求信息中的 <code>Host</code>，如果请求中没有 <code>Host</code> 行，则等于设置的服务器名</td></tr><tr><td><code>$request_method</code></td><td>客户端请求类型，如 <code>GET</code>、<code>POST</code></td></tr><tr><td><code>$remote_addr</code></td><td>客户端的 <code>IP</code> 地址</td></tr><tr><td><code>$args</code></td><td>请求中的参数</td></tr><tr><td><code>$content_length</code></td><td>请求头中的 <code>Content-length</code> 字段</td></tr><tr><td><code>$http_user_agent</code></td><td>客户端 agent 信息</td></tr><tr><td><code>$http_cookie</code></td><td>客户端 cookie 信息</td></tr><tr><td><code>$remote_addr</code></td><td>客户端的 IP 地址</td></tr><tr><td><code>$remote_port</code></td><td>客户端的端口</td></tr><tr><td><code>$server_protocol</code></td><td>请求使用的协议，如 <code>HTTP/1.0</code>、<code>HTTP/1.1\</code></td></tr><tr><td><code>$server_addr</code></td><td>服务器地址</td></tr><tr><td><code>$server_name</code></td><td>服务器名称</td></tr><tr><td><code>$server_port</code></td><td>服务器的端口号</td></tr></tbody></table><h2 id="nginx-负载均衡"><a href="#nginx-负载均衡" class="headerlink" title="nginx 负载均衡"></a>nginx 负载均衡</h2><p>Upstream 指定后端服务器地址列表，在 server 中拦截响应请求，并将请求转发到 Upstream 中配置的服务器列表。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">upstream balanceServer &#123;</span><br><span class="line">    server 10.1.22.33:12345;</span><br><span class="line">    server 10.1.22.34:12345;</span><br><span class="line">    server 10.1.22.35:12345;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    server_name  fe.server.com;</span><br><span class="line">    listen 80;</span><br><span class="line">    location /api &#123;</span><br><span class="line">        proxy_pass http://balanceServer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的配置只是指定了 nginx 需要转发的服务端列表，并没有指定分配策略。</p><p>默认情况下采用的是轮询策略，将所有客户端请求轮询分配给服务端。这种策略是可以正常工作的，但是如果其中某一台服务器压力太大，出现延迟，会影响所有分配在这台服务器下的用户。</p><h2 id="nginx-常用命令"><a href="#nginx-常用命令" class="headerlink" title="nginx 常用命令"></a>nginx 常用命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 快速关闭 Nginx，可能不保存相关信息，并迅速终止 web 服务</span></span><br><span class="line">nginx -s stop</span><br><span class="line"><span class="comment"># 平稳关闭 Nginx，保存相关信息，有安排的结束 web 服务</span></span><br><span class="line">nginx -s quit</span><br><span class="line"><span class="comment"># 因改变了 Nginx 相关配置，需要重新加载配置而重载</span></span><br><span class="line">nginx -s reload</span><br><span class="line"><span class="comment"># 重新打开日志文件</span></span><br><span class="line">nginx -s reopen</span><br><span class="line"><span class="comment"># 为 Nginx 指定一个配置文件，来代替缺省的</span></span><br><span class="line">nginx -c filename</span><br><span class="line"><span class="comment"># 不运行，而仅仅测试配置文件。nginx 将检查配置文件的语法的正确性，并尝试打开配置文件中所引用到的文件</span></span><br><span class="line">nginx -t</span><br><span class="line"><span class="comment">#  显示 nginx 的版本</span></span><br><span class="line">nginx -v</span><br><span class="line"><span class="comment"># 显示 nginx 的版本，编译器版本和配置参数</span></span><br><span class="line">nginx -V</span><br><span class="line"><span class="comment"># 格式换显示 nginx 配置参数</span></span><br><span class="line">2&gt;&amp;1 nginx -V | xargs -n1</span><br><span class="line">2&gt;&amp;1 nginx -V | xargs -n1 | grep lua</span><br></pre></td></tr></table></figure><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><blockquote><p>以上内容只是 nginx 的冰山一角，我个人推荐大家跟着官方文档或者类似极客时间的教程学习，可以少走很多弯路</p></blockquote><p><a href="https://nginx.org/en/docs/" target="_blank" rel="noopener">nginx documentation</a></p><p><a href="http://www.conardli.top/blog/article/%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%8C%96/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E8%80%85%E5%BF%85%E5%A4%87%E7%9A%84nginx%E7%9F%A5%E8%AF%86.html" target="_blank" rel="noopener">前端开发者必备的 nginx 知识</a></p><p><a href="https://mp.weixin.qq.com/s?__biz=MzA4Nzg5Nzc5OA==&amp;mid=2651674303&amp;idx=1&amp;sn=b34cbf009aac5f901ce81a65df06359f&amp;chksm=8bcb9516bcbc1c006ff36cd7a8a83d40c7b24143d0c76fc15f61bbb2c210355615125aa95d94&amp;mpshare=1&amp;scene=1&amp;srcid=1031DJIgeaaQj5fafJbAc3mg#rd" target="_blank" rel="noopener">百万并发下 Nginx 的优化之道</a></p><p><a href="http://openresty.org/download/agentzh-nginx-tutorials-zhcn.html" target="_blank" rel="noopener">agentzh 的 Nginx 教程</a></p><p><a href="https://moonbingbing.gitbooks.io/openresty-best-practices/content/index.html" target="_blank" rel="noopener">OpenResty 最佳实践</a></p><blockquote><p>以下为极客时间专栏</p></blockquote><p><a href="https://time.geekbang.org/course/intro/138" target="_blank" rel="noopener">Nginx 核心知识 100 讲</a></p><p><a href="https://github.com/russelltao/geektime-nginx" target="_blank" rel="noopener">极客时间：nginx 核心知识 100 讲配置文件与代码分享</a></p><p><a href="https://time.geekbang.org/column/intro/186" target="_blank" rel="noopener">OpenResty 从入门到实战</a></p>]]></content>
    
    <summary type="html">
    
      Nginx基础知识从小白到入门
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>Linux 日志切割神器 logrotate 原理介绍和配置详解</title>
    <link href="https://wsgzao.github.io/post/logrotate/"/>
    <id>https://wsgzao.github.io/post/logrotate/</id>
    <published>2019-11-05T06:59:49.000Z</published>
    <updated>2019-11-07T03:28:49.545Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在 Linux 环境中能够帮助我们分析问题蛛丝马迹的有效办法之一便是日志，常见的如操作系统 syslog 日志 <code>/var/log/messages</code>，应用程序 Nginx 日志 <code>/var/log/nginx/*.log</code>。但如果服务器数量较多，日志文件大小增长较快，不断消耗磁盘空间就会触发告警，如果需要人为定期按照各种维度去手动清理日志就显得十分棘手。为了节省空间和方便整理，可以将日志文件按时间或大小分成多份，删除时间久远的日志文件，这就是通常说的日志滚动 <a href="https://en.wikipedia.org/wiki/Log_rotation" target="_blank" rel="noopener">(log rotation)</a>。logrotate<a href="https://github.com/logrotate/logrotate" target="_blank" rel="noopener">(GitHub 地址)</a> 诞生于 1996/11/19 是一个 Linux 系统日志的管理工具，本文会详细介绍 Linux 日志切割神器 logrotate 的原理和配置。</p><blockquote><p>Linux 日志切割神器 logrotate 原理介绍和配置详解</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 11 月 05 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/logrotate/">https://wsgzao.github.io/post/logrotate/</a></p><p><strong> 扩展阅读 </strong></p><p><a href="https://linux.die.net/man/8/logrotate" target="_blank" rel="noopener">man logrotate</a></p><hr><h2 id="logrotate-简介"><a href="#logrotate-简介" class="headerlink" title="logrotate 简介"></a>logrotate 简介</h2><blockquote><p>logrotate ‐ rotates, compresses, and mails system logs</p></blockquote><p>logrotate is designed to ease administration of systems that generate large numbers of log files. It allows automatic rotation, compression, removal, and mailing of log files. Each log file may be handled daily, weekly, monthly, or when it grows too large.</p><p>Normally, logrotate is run as a daily cron job. It will not modify a log more than once in one day unless the criterion for that log is based on the log’s size and logrotate is being run more than once each day, or unless the -f or –force option is used.</p><p>Any number of config files may be given on the command line. Later config files may override the options given in earlier files, so the order in which the logrotate config files are listed is important. Normally, a single config file which includes any other config files which are needed should be used. See below for more information on how to<br>use the include directive to accomplish this. If a directory is given on the command line, every file in that directory is used as a config file.</p><p>If no command line arguments are given, logrotate will print version and copyright information, along with a short usage summary. If any errors occur while rotating logs, logrotate will exit with non-zero status.</p><p>logrotate 是一个 linux 系统日志的管理工具。可以对单个日志文件或者某个目录下的文件按时间 / 大小进行切割，压缩操作；指定日志保存数量；还可以在切割之后运行自定义命令。</p><p>logrotate 是基于 crontab 运行的，所以这个时间点是由 crontab 控制的，具体可以查询 crontab 的配置文件 /etc/anacrontab。 系统会按照计划的频率运行 logrotate，通常是每天。在大多数的 Linux 发行版本上，计划每天运行的脚本位于  /etc/cron.daily/logrotate。</p><p>主流 Linux 发行版上都默认安装有 logrotate 包，如果你的 linux 系统中找不到 logrotate, 可以使用 apt-get 或 yum 命令来安装。</p><h2 id="logrotate-运行机制"><a href="#logrotate-运行机制" class="headerlink" title="logrotate 运行机制"></a>logrotate 运行机制</h2><p>logrotate 在很多 Linux 发行版上都是默认安装的。系统会定时运行 logrotate，一般是每天一次。系统是这么实现按天执行的。crontab 会每天定时执行 /etc/cron.daily 目录下的脚本，而这个目录下有个文件叫 logrotate。在 centos 上脚本内容是这样的：</p><p>系统自带 cron task：<code>/etc/cron.daily/logrotate</code>，每天运行一次。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@gop-sg-192-168-56-103 logrotate.d]<span class="comment"># cat /etc/cron.daily/logrotate</span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">/usr/sbin/logrotate -s /var/lib/logrotate/logrotate.status /etc/logrotate.conf</span><br><span class="line">EXITVALUE=$?</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$EXITVALUE</span> != 0 ]; <span class="keyword">then</span></span><br><span class="line">    /usr/bin/logger -t logrotate <span class="string">"ALERT exited abnormally with [<span class="variable">$EXITVALUE</span>]"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure><p>可以看到这个脚本主要做的事就是以 <code>/etc/logrotate.conf</code> 为配置文件执行了 logrotate。就是这样实现了每天执行一次 logrotate。</p><p>因为我的系统执行 <code>/etc/cron.daily</code> 目录下的脚本不是我想滚动日志的时间，所以我把 <code>/etc/cron.daily/logrotate</code> 拷了出来，改了一下 logrotate 配置文件的路径，然后在 crontab 里加上一条指定时间执行这个脚本的记录，自定义周期滚动日志就大功告成了。这种自定义的方式有两点要注意：</p><ol><li>配置文件里一定要配置 <code>rotate 文件数目</code> 这个参数。如果不配置默认是 0 个，也就是只允许存在一份日志，刚切分出来的日志会马上被删除。多么痛的领悟，说多了都是泪。</li><li>执行 logrotate 命令最好加 <code>-f</code> 参数，不然有时候配置文件修改的内容不生效。</li></ol><p>很多程序的会用到 logrotate 滚动日志，比如 nginx。它们安装后，会在 <code>/etc/logrotate.d</code> 这个目录下增加自己的 logrotate 的配置文件。logrotate 什么时候执行 <code>/etc/logrotate.d</code> 下的配置呢？看到 <code>/etc/logrotate.conf</code> 里这行，一切就不言而喻了。</p><pre><code>include /etc/logrotate.d</code></pre><h2 id="logrotate-原理"><a href="#logrotate-原理" class="headerlink" title="logrotate 原理"></a>logrotate 原理</h2><p>logrotate 是怎么做到滚动日志时不影响程序正常的日志输出呢？logrotate 提供了两种解决方案。</p><ol><li>create</li><li>copytruncate</li></ol><h3 id="Linux-文件操作机制"><a href="#Linux-文件操作机制" class="headerlink" title="Linux 文件操作机制"></a>Linux 文件操作机制</h3><p>介绍一下相关的 Linux 下的文件操作机制。</p><p>Linux 文件系统里文件和文件名的关系如下图。</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191106155554.png" alt=""></p><p>目录也是文件，文件里存着文件名和对应的 inode 编号。通过这个 inode 编号可以查到文件的元数据和文件内容。文件的元数据有引用计数、操作权限、拥有者 ID、创建时间、最后修改时间等等。文件件名并不在元数据里而是在目录文件中。因此文件改名、移动，都不会修改文件，而是修改目录文件。</p><p>借《UNIX 环境高级编程》里的图说一下进程打开文件的机制。</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191106155617.png" alt=""></p><p>进程每新打开一个文件，系统会分配一个新的文件描述符给这个文件。文件描述符对应着一个文件表。表里面存着文件的状态信息（<code>O_APPEND</code>/<code>O_CREAT</code>/<code>O_DIRECT</code>…）、当前文件位置和文件的 inode 信息。系统会为每个进程创建独立的文件描述符和文件表，不同进程是不会共用同一个文件表。正因为如此，不同进程可以同时用不同的状态操作同一个文件的不同位置。文件表中存的是 inode 信息而不是文件路径，所以文件路径发生改变不会影响文件操作。</p><h3 id="create"><a href="#create" class="headerlink" title="create"></a>create</h3><p>这也就是默认的方案，可以通过 create 命令配置文件的权限和属组设置；这个方案的思路是重命名原日志文件，创建新的日志文件。详细步骤如下：</p><ol><li>重命名正在输出日志文件，因为重命名只修改目录以及文件的名称，而进程操作文件使用的是 inode，所以并不影响原程序继续输出日志。</li><li>创建新的日志文件，文件名和原日志文件一样，注意，此时只是文件名称一样，而 inode 编号不同，原程序输出的日志还是往原日志文件输出。</li><li>最后通过某些方式通知程序，重新打开日志文件；由于重新打开日志文件会用到文件路径而非 inode 编号，所以打开的是新的日志文件。</li></ol><p>如上也就是 logrotate 的默认操作方式，也就是 mv+create 执行完之后，通知应用重新在新文件写入即可。mv+create 成本都比较低，几乎是原子操作，如果应用支持重新打开日志文件，如 syslog, nginx, mysql 等，那么这是最好的方式。</p><p>不过，有些程序并不支持这种方式，压根没有提供重新打开日志的接口；而如果重启应用程序，必然会降低可用性，为此引入了如下方式。</p><h3 id="copytruncate"><a href="#copytruncate" class="headerlink" title="copytruncate"></a>copytruncate</h3><p>该方案是把正在输出的日志拷 (copy) 一份出来，再清空 (trucate) 原来的日志；详细步骤如下：</p><ol><li>将当前正在输出的日志文件复制为目标文件，此时程序仍然将日志输出到原来文件中，此时，原文件名也没有变。</li><li>清空日志文件，原程序仍然还是输出到预案日志文件中，因为清空文件只把文件的内容删除了，而 inode 并没改变，后续日志的输出仍然写入该文件中。</li></ol><p>如上所述，对于 copytruncate 也就是先复制一份文件，然后清空原有文件。</p><p>通常来说，清空操作比较快，但是如果日志文件太大，那么复制就会比较耗时，从而可能导致部分日志丢失。不过这种方式不需要应用程序的支持即可。</p><h2 id="配置-logrotate"><a href="#配置-logrotate" class="headerlink" title="配置 logrotate"></a>配置 logrotate</h2><p>执行文件： <code>/usr/sbin/logrotate</code><br>主配置文件: <code>/etc/logrotate.conf</code><br>自定义配置文件: <code>/etc/logrotate.d/*.conf</code></p><p>修改配置文件后，并不需要重启服务。<br>由于 logrotate 实际上只是一个可执行文件，不是以 daemon 运行。</p><p><code>/etc/logrotate.conf</code> - 顶层主配置文件，通过 include 指令，会引入 <code>/etc/logrotate.d</code> 下的配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@gop-sg-192-168-56-103 wangao]<span class="comment"># cat /etc/logrotate.conf</span></span><br><span class="line"><span class="comment"># see "man logrotate" for details</span></span><br><span class="line"><span class="comment"># rotate log files weekly</span></span><br><span class="line">weekly</span><br><span class="line"></span><br><span class="line"><span class="comment"># keep 4 weeks worth of backlogs</span></span><br><span class="line">rotate 4</span><br><span class="line"></span><br><span class="line"><span class="comment"># create new (empty) log files after rotating old ones</span></span><br><span class="line">create</span><br><span class="line"></span><br><span class="line"><span class="comment"># use date as a suffix of the rotated file</span></span><br><span class="line">dateext</span><br><span class="line"></span><br><span class="line"><span class="comment"># uncomment this if you want your log files compressed</span></span><br><span class="line"><span class="comment">#compress</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># RPM packages drop log rotation information into this directory</span></span><br><span class="line">include /etc/logrotate.d</span><br><span class="line"></span><br><span class="line"><span class="comment"># no packages own wtmp and btmp -- we'll rotate them here</span></span><br><span class="line">/var/<span class="built_in">log</span>/wtmp &#123;</span><br><span class="line">    monthly</span><br><span class="line">    create 0664 root utmp</span><br><span class="line">minsize 1M</span><br><span class="line">    rotate 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/var/<span class="built_in">log</span>/btmp &#123;</span><br><span class="line">    missingok</span><br><span class="line">    monthly</span><br><span class="line">    create 0600 root utmp</span><br><span class="line">    rotate 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># system-specific logs may be also be configured here.</span></span><br></pre></td></tr></table></figure><p><code>/etc/logrotate.d/</code> 通常一些第三方软件包，会把自己私有的配置文件，也放到这个目录下。 如 yum，zabbix-agent，syslog，nginx 等。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@gop-sg-192-168-56-103 logrotate.d]<span class="comment"># cat yum</span></span><br><span class="line">/var/<span class="built_in">log</span>/yum.log &#123;</span><br><span class="line">    missingok</span><br><span class="line">    notifempty</span><br><span class="line">    size 30k</span><br><span class="line">    yearly</span><br><span class="line">    create 0600 root root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="运行-logrotate"><a href="#运行-logrotate" class="headerlink" title="运行 logrotate"></a>运行 logrotate</h2><p>具体 logrotate 命令格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">logrotate [OPTION...] &lt;configfile&gt;</span><br><span class="line">-d, --debug ：debug 模式，测试配置文件是否有错误。</span><br><span class="line">-f, --force ：强制转储文件。</span><br><span class="line">-m, --mail=command ：压缩日志后，发送日志到指定邮箱。</span><br><span class="line">-s, --state=statefile ：使用指定的状态文件。</span><br><span class="line">-v, --verbose ：显示转储过程。</span><br></pre></td></tr></table></figure><blockquote><p>crontab 定时</p></blockquote><p>通常惯用的做法是配合 crontab 来定时调用。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">crontab -e</span><br><span class="line">*/30 * * * * /usr/sbin/logrotate /etc/logrotate.d/rsyslog &gt; /dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><blockquote><p>手动运行</p></blockquote><p>debug 模式：指定 <code>[-d|--debug]</code></p><pre><code>logrotate -d &lt;configfile&gt;</code></pre><p>并不会真正进行 rotate 或者 compress 操作，但是会打印出整个执行的流程，和调用的脚本等详细信息。</p><p>verbose 模式： 指定 <code>[-v|--verbose]</code></p><pre><code>logrotate -v &lt;configfile&gt;</code></pre><p>会真正执行操作，打印出详细信息（debug 模式，默认是开启 verbose）</p><h3 id="logrotate-参数"><a href="#logrotate-参数" class="headerlink" title="logrotate 参数"></a>logrotate 参数</h3><p>详细介绍请自行 <code>man logrotate</code>， 或者 <a href="https://linux.die.net/man/8/logrotate" target="_blank" rel="noopener">在线 man page</a>。</p><p>主要介绍下完成常用需求会用到的一些参数。</p><p>一个典型的配置文件如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /etc/logrotate.d/log_file </span><br><span class="line"></span><br><span class="line">/var/log/log_file &#123;</span><br><span class="line"></span><br><span class="line">    monthly</span><br><span class="line">    rotate 5</span><br><span class="line">    compress</span><br><span class="line">    delaycompress</span><br><span class="line">    missingok</span><br><span class="line">    notifempty</span><br><span class="line">    create 644 root root</span><br><span class="line">    postrotate</span><br><span class="line">        /usr/bin/killall -HUP rsyslogd</span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>monthly: 日志文件将按月轮循。其它可用值为 <code>daily</code>，<code>weekly</code> 或者 <code>yearly</code>。</li><li>rotate 5: 一次将存储 5 个归档日志。对于第六个归档，时间最久的归档将被删除。</li><li>compress: 在轮循任务完成后，已轮循的归档将使用 gzip 进行压缩。</li><li>delaycompress: 总是与 compress 选项一起用，delaycompress 选项指示 logrotate 不要将最近的归档压缩，压缩 将在下一次轮循周期进行。这在你或任何软件仍然需要读取最新归档时很有用。</li><li>missingok: 在日志轮循期间，任何错误将被忽略，例如 “文件无法找到” 之类的错误。</li><li>notifempty: 如果日志文件为空，轮循不会进行。</li><li>create 644 root root: 以指定的权限创建全新的日志文件，同时 logrotate 也会重命名原始日志文件。</li><li>postrotate/endscript: 在所有其它指令完成后，postrotate 和 endscript 里面指定的命令将被执行。在这种情况下，rsyslogd 进程将立即再次读取其配置并继续运行。</li></ul><p>上面的模板是通用的，而配置参数则根据你的需求进行调整，不是所有的参数都是必要的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/var/log/log_file &#123;</span><br><span class="line">    size=50M</span><br><span class="line">    rotate 5</span><br><span class="line">    dateext</span><br><span class="line">    create 644 root root</span><br><span class="line">    postrotate</span><br><span class="line">        /usr/bin/killall -HUP rsyslogd</span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在上面的配置文件中，我们只想要轮询一个日志文件，size=50M 指定日志文件大小可以增长到 50MB,dateext 指<br>示让旧日志文件以创建日期命名。</p><blockquote><p>常见配置参数</p></blockquote><ul><li>daily ：指定转储周期为每天</li><li>weekly ：指定转储周期为每周</li><li>monthly ：指定转储周期为每月</li><li>rotate count ：指定日志文件删除之前转储的次数，0 指没有备份，5 指保留 5 个备份</li><li>tabooext [+] list：让 logrotate 不转储指定扩展名的文件，缺省的扩展名是：.rpm-orig, .rpmsave, v, 和～</li><li>missingok：在日志轮循期间，任何错误将被忽略，例如 “文件无法找到” 之类的错误。</li><li>size size：当日志文件到达指定的大小时才转储，bytes (缺省) 及 KB (sizek) 或 MB (sizem)</li><li>compress： 通过 gzip 压缩转储以后的日志</li><li>nocompress： 不压缩</li><li>copytruncate：用于还在打开中的日志文件，把当前日志备份并截断</li><li>nocopytruncate： 备份日志文件但是不截断</li><li>create mode owner group ： 转储文件，使用指定的文件模式创建新的日志文件</li><li>nocreate： 不建立新的日志文件</li><li>delaycompress： 和 compress 一起使用时，转储的日志文件到下一次转储时才压缩</li><li>nodelaycompress： 覆盖 delaycompress 选项，转储同时压缩。</li><li>errors address ： 专储时的错误信息发送到指定的 Email 地址</li><li>ifempty ：即使是空文件也转储，这个是 logrotate 的缺省选项。</li><li>notifempty ：如果是空文件的话，不转储</li><li>mail address ： 把转储的日志文件发送到指定的 E-mail 地址</li><li>nomail ： 转储时不发送日志文件</li><li>olddir directory：储后的日志文件放入指定的目录，必须和当前日志文件在同一个文件系统</li><li>noolddir： 转储后的日志文件和当前日志文件放在同一个目录下</li><li>prerotate/endscript： 在转储以前需要执行的命令可以放入这个对，这两个关键字必须单独成行</li></ul><p>更多信息请参考 man logrotate 帮助文档</p><h3 id="手动运行-logrotate-演练"><a href="#手动运行-logrotate-演练" class="headerlink" title="手动运行 logrotate 演练"></a>手动运行 logrotate 演练</h3><p>logrotate 可以在任何时候从命令行手动调用。<br>调用 /etc/lograte.d/ 下配置的所有日志：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# logrotate /etc/logrotate.conf</span><br></pre></td></tr></table></figure><p>要为某个特定的配置调用 logrotate：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# logrotate /etc/logrotate.d/log_file</span><br></pre></td></tr></table></figure><p>排障过程中的最佳选择是使用 <code>-d</code> 选项以预演方式运行 logrotate。要进行验证，不用实际轮循任何日志文件，<br>可以模拟演练日志轮循并显示其输出。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># logrotate -d /etc/logrotate.d/log_file</span></span><br><span class="line"></span><br><span class="line">reading config file /etc/logrotate.d/log_file</span><br><span class="line">reading config info <span class="keyword">for</span> /var/<span class="built_in">log</span>/log_file </span><br><span class="line"></span><br><span class="line">Handling 1 logs</span><br><span class="line"></span><br><span class="line">rotating pattern: /var/<span class="built_in">log</span>/log_file  monthly (5 rotations)</span><br><span class="line">empty <span class="built_in">log</span> files are not rotated, old logs are removed</span><br><span class="line">considering <span class="built_in">log</span> /var/<span class="built_in">log</span>/log_file</span><br><span class="line">  <span class="built_in">log</span> does not need rotating</span><br><span class="line">not running postrotate script, since no logs were rotated</span><br></pre></td></tr></table></figure><p>正如我们从上面的输出结果可以看到的，logrotate 判断该轮循是不必要的。如果文件的时间小于一天，这就会发生了。</p><p>强制轮循即使轮循条件没有满足，我们也可以通过使用 <code>-f</code> 选项来强制 logrotate 轮循日志文件，<code>-v</code> 参数提供了详细的输出。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># logrotate -vf /etc/logrotate.d/log_file </span></span><br><span class="line"></span><br><span class="line">reading config file /etc/logrotate.d/log_file</span><br><span class="line">reading config info <span class="keyword">for</span> /var/<span class="built_in">log</span>/log_file </span><br><span class="line"></span><br><span class="line">Handling 1 logs</span><br><span class="line"></span><br><span class="line">rotating pattern: /var/<span class="built_in">log</span>/log_file  forced from <span class="built_in">command</span> line (5 rotations)</span><br><span class="line">empty <span class="built_in">log</span> files are not rotated, old logs are removed</span><br><span class="line">considering <span class="built_in">log</span> /var/<span class="built_in">log</span>/log_file</span><br><span class="line">  <span class="built_in">log</span> needs rotating</span><br><span class="line">rotating <span class="built_in">log</span> /var/<span class="built_in">log</span>/log_file, <span class="built_in">log</span>-&gt;rotateCount is 5</span><br><span class="line">dateext suffix <span class="string">'-20180503'</span></span><br><span class="line">glob pattern <span class="string">'-[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'</span></span><br><span class="line">previous <span class="built_in">log</span> /var/<span class="built_in">log</span>/log_file.1 does not exist</span><br><span class="line">renaming /var/<span class="built_in">log</span>/log_file.5.gz to /var/<span class="built_in">log</span>/log_file.6.gz (rotatecount 5, logstart 1, i 5), </span><br><span class="line">old <span class="built_in">log</span> /var/<span class="built_in">log</span>/log_file.5.gz does not exist</span><br><span class="line">renaming /var/<span class="built_in">log</span>/log_file.4.gz to /var/<span class="built_in">log</span>/log_file.5.gz (rotatecount 5, logstart 1, i 4), </span><br><span class="line">old <span class="built_in">log</span> /var/<span class="built_in">log</span>/log_file.4.gz does not exist</span><br><span class="line">renaming /var/<span class="built_in">log</span>/log_file.3.gz to /var/<span class="built_in">log</span>/log_file.4.gz (rotatecount 5, logstart 1, i 3), </span><br><span class="line">old <span class="built_in">log</span> /var/<span class="built_in">log</span>/log_file.3.gz does not exist</span><br><span class="line">renaming /var/<span class="built_in">log</span>/log_file.2.gz to /var/<span class="built_in">log</span>/log_file.3.gz (rotatecount 5, logstart 1, i 2), </span><br><span class="line">old <span class="built_in">log</span> /var/<span class="built_in">log</span>/log_file.2.gz does not exist</span><br><span class="line">renaming /var/<span class="built_in">log</span>/log_file.1.gz to /var/<span class="built_in">log</span>/log_file.2.gz (rotatecount 5, logstart 1, i 1), </span><br><span class="line">old <span class="built_in">log</span> /var/<span class="built_in">log</span>/log_file.1.gz does not exist</span><br><span class="line">renaming /var/<span class="built_in">log</span>/log_file.0.gz to /var/<span class="built_in">log</span>/log_file.1.gz (rotatecount 5, logstart 1, i 0), </span><br><span class="line">old <span class="built_in">log</span> /var/<span class="built_in">log</span>/log_file.0.gz does not exist</span><br><span class="line"><span class="built_in">log</span> /var/<span class="built_in">log</span>/log_file.6.gz doesn<span class="string">'t exist -- won'</span>t try to dispose of it</span><br><span class="line">fscreate context <span class="built_in">set</span> to unconfined_u:object_r:var_log_t:s0</span><br><span class="line">renaming /var/<span class="built_in">log</span>/log_file to /var/<span class="built_in">log</span>/log_file.1</span><br><span class="line">creating new /var/<span class="built_in">log</span>/log_file mode = 0644 uid = 0 gid = 0</span><br><span class="line">running postrotate script</span><br><span class="line"><span class="built_in">set</span> default create context</span><br></pre></td></tr></table></figure><h2 id="logrotate-配置文件实例"><a href="#logrotate-配置文件实例" class="headerlink" title="logrotate 配置文件实例"></a>logrotate 配置文件实例</h2><blockquote><p>syslog</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@gop-sg-192-168-56-103 logrotate.d]# cat syslog</span><br><span class="line">/var/log/cron</span><br><span class="line">/var/log/maillog</span><br><span class="line">/var/log/messages</span><br><span class="line">/var/log/secure</span><br><span class="line">/var/log/spooler</span><br><span class="line">&#123;</span><br><span class="line">    missingok</span><br><span class="line">    sharedscripts</span><br><span class="line">    postrotate</span><br><span class="line">/bin/kill -HUP `cat /var/run/syslogd.pid 2&gt; /dev/null` 2&gt; /dev/null || true</span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>zabbix-agent</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@gop-sg-192-168-56-103 logrotate.d]# cat zabbix-agent</span><br><span class="line">/var/log/zabbix/zabbix_agentd.log &#123;</span><br><span class="line">weekly</span><br><span class="line">rotate 12</span><br><span class="line">compress</span><br><span class="line">delaycompress</span><br><span class="line">missingok</span><br><span class="line">notifempty</span><br><span class="line">create 0664 zabbix zabbix</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>nginx</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@gop-sg-192-168-56-103 logrotate.d]# cat nginx</span><br><span class="line">/var/log/nginx/*.log /var/log/nginx/*/*.log&#123;</span><br><span class="line">daily</span><br><span class="line">missingok</span><br><span class="line">rotate 14</span><br><span class="line">compress</span><br><span class="line">delaycompress</span><br><span class="line">notifempty</span><br><span class="line">create 640 root adm</span><br><span class="line">sharedscripts</span><br><span class="line">postrotate</span><br><span class="line">[ ! -f /var/run/nginx.pid ] || kill -USR1 `cat /var/run/nginx.pid`</span><br><span class="line">endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>influxdb</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@gop-sg-192-168-56-103 logrotate.d]# cat influxdb</span><br><span class="line">/var/log/influxdb/influxd.log &#123;</span><br><span class="line">    daily</span><br><span class="line">    rotate 7</span><br><span class="line">    missingok</span><br><span class="line">    dateext</span><br><span class="line">    copytruncate</span><br><span class="line">    compress</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="关于-USR1-信号解释"><a href="#关于-USR1-信号解释" class="headerlink" title="关于 USR1 信号解释"></a>关于 USR1 信号解释</h2><p>USR1 亦通常被用来告知应用程序重载配置文件；例如，向 Apache HTTP 服务器发送一个 USR1 信号将导致以下步骤的发生：停止接受新的连接，等待当前连接停止，重新载入配置文件，重新打开日志文件，重启服务器，从而实现相对平滑的不关机的更改。</p><p>对于 USR1 和 2 都可以用户自定义的，在 POSIX 兼容的平台上，SIGUSR1 和 SIGUSR2 是发送给一个进程的信号，它表示了用户定义的情况。它们的符号常量在头文件 signal.h 中定义。在不同的平台上，信号的编号可能发生变化，因此需要使用符号名称。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kill -HUP pid</span><br><span class="line">killall -HUP pName</span><br></pre></td></tr></table></figure><p>其中 pid 是进程标识，pName 是进程的名称。</p><p>如果想要更改配置而不需停止并重新启动服务，可以使用上面两个命令。在对配置文件作必要的更改后，发出该命令以动态更新服务配置。根据约定，当你发送一个挂起信号 (信号 1 或 HUP) 时，大多数服务器进程 (所有常用的进程) 都会进行复位操作并重新加载它们的配置文件。</p><h2 id="logrotate-日志切割轮询"><a href="#logrotate-日志切割轮询" class="headerlink" title="logrotate 日志切割轮询"></a>logrotate 日志切割轮询</h2><p>由于 logrotate 是基于 cron 运行的，所以这个日志轮转的时间是由 cron 控制的，具体可以查询 cron 的配置文件 /etc/anacrontab，过往的老版本的文件为（/etc/crontab）</p><p>查看轮转文件：/etc/anacrontab</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@gop-sg-192-168-56-103 logrotate.d]<span class="comment"># cat /etc/anacrontab</span></span><br><span class="line"><span class="comment"># /etc/anacrontab: configuration file for anacron</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># See anacron(8) and anacrontab(5) for details.</span></span><br><span class="line"></span><br><span class="line">SHELL=/bin/sh</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">MAILTO=root</span><br><span class="line"><span class="comment"># the maximal random delay added to the base delay of the jobs</span></span><br><span class="line">RANDOM_DELAY=45</span><br><span class="line"><span class="comment"># the jobs will be started during the following hours only</span></span><br><span class="line">START_HOURS_RANGE=3-22</span><br><span class="line"></span><br><span class="line"><span class="comment">#period in days   delay in minutes   job-identifier   command</span></span><br><span class="line">15cron.dailynice run-parts /etc/cron.daily</span><br><span class="line">725cron.weeklynice run-parts /etc/cron.weekly</span><br><span class="line">@monthly 45cron.monthlynice run-parts /etc/cron.monthly</span><br></pre></td></tr></table></figure><p>使用 anacrontab 轮转的配置文件，日志切割的生效时间是在凌晨 3 点到 22 点之间，而且随机延迟时间是 45 分钟，但是这样配置无法满足我们在现实中的应用</p><p>现在的需求是将切割时间调整到每天的晚上 12 点，即每天切割的日志是前一天的 0-24 点之间的内容，操作如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /etc/anacrontab /etc/anacrontab.bak          // 取消日志自动轮转的设置 </span><br></pre></td></tr></table></figure><p>使用 crontab 来作为日志轮转的触发容器来修改 logrotate 默认执行时间</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@gop-sg-192-168-56-103 logrotate.d]<span class="comment"># vim /etc/crontab</span></span><br><span class="line">SHELL=/bin/bash</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">MAILTO=root</span><br><span class="line">HOME=/</span><br><span class="line"></span><br><span class="line"><span class="comment"># run-parts</span></span><br><span class="line">01 * * * * root run-parts /etc/cron.hourly</span><br><span class="line">59 23 * * * root run-parts /etc/cron.daily</span><br><span class="line">22 4 * * 0 root run-parts /etc/cron.weekly</span><br><span class="line">42 4 1 * * root run-parts /etc/cron.monthly</span><br></pre></td></tr></table></figure><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://www.digitalocean.com/community/tutorials/how-to-manage-logfiles-with-logrotate-on-ubuntu-16-04" target="_blank" rel="noopener">How To Manage Logfiles with Logrotate on Ubuntu 16.04</a><br><a href="https://www.linode.com/docs/uptime/logs/use-logrotate-to-manage-log-files/" target="_blank" rel="noopener">How to Use logrotate to Manage Log Files</a><br><a href="https://linux.cn/article-4126-1.html" target="_blank" rel="noopener">Linux 日志文件总管 ——logrotate</a><br><a href="http://www.lightxue.com/how-logrotate-works" target="_blank" rel="noopener">logrotate 机制和原理</a><br><a href="https://blog.51cto.com/luweiv998/2354160" target="_blank" rel="noopener">Linux 自带 Logrotate 日志切割工具配置详解</a></p>]]></content>
    
    <summary type="html">
    
      Linux日志切割神器logrotate原理介绍和配置详解
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>使用 rpmbuild 制作 Nginx 的 RPM 包</title>
    <link href="https://wsgzao.github.io/post/rpmbuild/"/>
    <id>https://wsgzao.github.io/post/rpmbuild/</id>
    <published>2019-11-04T06:59:49.000Z</published>
    <updated>2019-11-05T09:16:10.301Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191104154723.png" alt=""></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>题图为 RPM 包制作原理图，有时候为了方便源码包的安装，和我们自己订制软件包的需求，我们会把一些源码包按照我们的需求来做成 rpm 包，当有了源码包就可以直接编译得到二进制安装包和其他任意包。spec file 是制作 rpm 包最核心的部分，rpm 包的制作就是根据 spec file 来实现的。在制作自定义 rpm 包的时候最好不要使用管理员进行, 因为管理员权限过大，如果一个命令写错了，结果可能是灾难性的，而制件一个 rpm 包普通用户完全可以实现。本文主要介绍使用 rpmbuild 制作 Nginx 的 RPM 包，大部分步骤已经使用 Bash Shell 自动化完成了，大家可以基于此重新定义。</p><blockquote><p>使用 rpmbuild 制作 Nginx 的 RPM 包</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 11 月 04 日 - 更新 openresty/lua-nginx-module<br>2019 年 01 月 16 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/rpmbuild/">https://wsgzao.github.io/post/rpmbuild/</a></p><p><strong> 扩展阅读 </strong></p><p><a href="https://openresty.org/" target="_blank" rel="noopener">OpenResty</a><br>Creating RPM packages - <a href="https://docs.fedoraproject.org/en-US/quick-docs/creating-rpm-packages/index.html" target="_blank" rel="noopener">https://docs.fedoraproject.org/en-US/quick-docs/creating-rpm-packages/index.html</a><br>How to create a GNU Hello RPM - <a href="https://fedoraproject.org/wiki/How_to_create_a_GNU_Hello_RPM_package/zh-cn" target="_blank" rel="noopener">https://fedoraproject.org/wiki/How_to_create_a_GNU_Hello_RPM_package/zh-cn</a><br>使用 rpm-build 制作 nginx 的 rpm 包 - <a href="http://blog.51cto.com/nmshuishui/1583117" target="_blank" rel="noopener">http://blog.51cto.com/nmshuishui/1583117</a></p><hr><h2 id="什么是-RPM"><a href="#什么是-RPM" class="headerlink" title="什么是 RPM"></a>什么是 RPM</h2><p>An RPM package is simply a file containing other files and information about them needed by the system. Specifically, an RPM package consists of the cpio archive, which contains the files, and the RPM header, which contains metadata about the package. The rpm package manager uses this metadata to determine dependencies, where to install files, and other information.</p><p>There are two types of RPM packages:</p><ul><li>source RPM (SRPM)</li><li>binary RPM</li></ul><p>SRPMs and binary RPMs share the file format and tooling, but have different contents and serve different purposes. An SRPM contains source code, optionally patches to it, and a SPEC file, which describes how to build the source code into a binary RPM. A binary RPM contains the binaries built from the sources and patches.</p><p>RPM 有五种基本的操作功能：安装、卸载、升级、查询和验证。</p><p>Linux 软件包分为两大类：</p><ol><li>二进制类包，包括 rpm 安装包（一般分为 i386 和 x86 等几种）</li><li>源码类包，源码包和开发包应该归位此类（.src.rpm）</li></ol><p>在 Redhat 下，rpm 包的默认制作路径在 /usr/src/redhat 下，这其中包含了 6 个目录（要求全部大写）。但 Centos 并没有该目录，因此我们不得不自定义工作车间，即使在 Redhat 下有该目录，一般也是自定义到普通用户的家目录下的</p><table><thead><tr><th>Directory</th><th>Usage</th></tr></thead><tbody><tr><td>BUILD</td><td>源代码解压以后放的位置，只需提供 BUILD 目录，具体里面放什么，不用我们管，所以真正的制作车间是 BUILD 目录</td></tr><tr><td>RPMS</td><td>制作完成后的 rpm 包存放目录，为特定平台指定子目录（i386,i686,ppc）</td></tr><tr><td>SOURCES</td><td>收集的源文件，源材料，补丁文件等存放位置    </td></tr><tr><td>SPECS</td><td>存放 spec 文件，作为制作 rpm 包的领岗文件，以 rpm 名. spec</td></tr><tr><td>SRPMS</td><td>src 格式的 rpm 包位置 ，既然是 src 格式的包，就没有平台的概念了           </td></tr><tr><td>BuiltRoot</td><td>假根，使用 install 临时安装到这个目录，把这个目录当作根来用的，所以在这个目录下的目录文件，才是真正的目录文件。当打包完成后，在清理阶段，这个目录将被删除</td></tr></tbody></table><p>更详细的介绍可以参考 <code>RPM Packaging Guide</code></p><p><a href="https://rpm-packaging-guide.github.io/" target="_blank" rel="noopener">https://rpm-packaging-guide.github.io/</a></p><h2 id="制作-rpm-包"><a href="#制作-rpm-包" class="headerlink" title="制作 rpm 包"></a>制作 rpm 包</h2><blockquote><p>如果你只关心如何使用可以直接跳过看下文，这里主要展示代码和配置文件</p></blockquote><h3 id="build-shell"><a href="#build-shell" class="headerlink" title="build shell"></a>build shell</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># luajit.sh</span></span><br><span class="line">LUAVER=2.0.5</span><br><span class="line">WKDIR=<span class="string">"/root/rpmbuild/SOURCES"</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$WKDIR</span></span><br><span class="line">wget http://luajit.org/download/LuaJIT-<span class="variable">$LUAVER</span>.tar.gz</span><br><span class="line">tar zxf LuaJIT-<span class="variable">$LUAVER</span>.tar.gz</span><br><span class="line">rm LuaJIT-<span class="variable">$LUAVER</span>.tar.gz</span><br><span class="line"><span class="built_in">cd</span> LuaJIT-<span class="variable">$LUAVER</span></span><br><span class="line">make BUILDMODE=static</span><br><span class="line">make install</span><br><span class="line"><span class="built_in">export</span> LUAJIT_LIB=/usr/<span class="built_in">local</span>/lib</span><br><span class="line"><span class="built_in">export</span> LUAJIT_INC=/usr/<span class="built_in">local</span>/include/luajit-2.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># build.sh</span></span><br><span class="line">NGX_VER=1.14.2</span><br><span class="line">WKDIR=<span class="string">"/root/rpmbuild/SOURCES"</span></span><br><span class="line">CURRENTDIR=`dirname $(readlink -f <span class="string">"<span class="variable">$0</span>"</span>)`</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$CURRENTDIR</span></span><br><span class="line"><span class="built_in">export</span> LUAJIT_LIB=/usr/<span class="built_in">local</span>/lib</span><br><span class="line"><span class="built_in">export</span> LUAJIT_INC=/usr/<span class="built_in">local</span>/include/luajit-2.0</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$WKDIR</span></span><br><span class="line">wget http://nginx.org/download/nginx-<span class="variable">$NGX_VER</span>.tar.gz</span><br><span class="line">tar xzf nginx-<span class="variable">$NGX_VER</span>.tar.gz</span><br><span class="line">rm nginx-<span class="variable">$NGX_VER</span>.tar.gz</span><br><span class="line">mv nginx-<span class="variable">$NGX_VER</span> nginx-garena-<span class="variable">$NGX_VER</span></span><br><span class="line"><span class="built_in">cd</span> nginx-garena-<span class="variable">$NGX_VER</span>/</span><br><span class="line"></span><br><span class="line">mkdir -p contrib</span><br><span class="line"><span class="built_in">cd</span> contrib/</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/bigplum/Nginx-limit-traffic-rate-module.git</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/agentzh/headers-more-nginx-module.git</span><br><span class="line"><span class="comment">#git clone git://github.com/gnosek/nginx-upstream-fair.git</span></span><br><span class="line">git <span class="built_in">clone</span> git://github.com/agentzh/<span class="built_in">echo</span>-nginx-module.git</span><br><span class="line"><span class="comment">#git clone git://github.com/arut/nginx-dav-ext-module.git</span></span><br><span class="line">git <span class="built_in">clone</span> git://github.com/r10r/ngx_http_auth_pam_module.git</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/FRiCKLE/ngx_cache_purge.git</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/simpl/ngx_devel_kit.git</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/openresty/lua-nginx-module.git</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/nbs-system/naxsi.git</span><br><span class="line">rm -rf */.git</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line"></span><br><span class="line">cp -r <span class="variable">$CURRENTDIR</span>/nginx-template/* <span class="variable">$WKDIR</span>/nginx-garena-<span class="variable">$NGX_VER</span>/</span><br><span class="line">cp <span class="variable">$CURRENTDIR</span>/nginx-spec /root/rpmbuild/SPECS/</span><br><span class="line"><span class="comment">#cp /root/rules $WKDIR/nginx-garena-$NGX_VER/debian/</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$WKDIR</span></span><br><span class="line">tar zcf nginx-garena-<span class="variable">$NGX_VER</span>.tar.gz nginx-garena-<span class="variable">$NGX_VER</span>/</span><br><span class="line"><span class="built_in">cd</span> /root/rpmbuild/SPECS/</span><br><span class="line">rpmbuild -ba nginx-spec</span><br><span class="line"><span class="built_in">cd</span> /root/rpmbuild/RPMS/noarch</span><br></pre></td></tr></table></figure><h3 id="nginx-spec"><a href="#nginx-spec" class="headerlink" title="nginx-spec"></a>nginx-spec</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.The introduction section </span></span><br><span class="line">Name: nginx-garena                                      <span class="comment"># 软件包名称 </span></span><br><span class="line">Version: 1.14.2                                         <span class="comment"># 版本号 </span></span><br><span class="line">Release: 0                                              <span class="comment"># release 号 </span></span><br><span class="line">Summary: nginx garena rpm                               <span class="comment"># 简要描述信息 </span></span><br><span class="line">Source0: nginx-garena-1.14.1.tar.gz                     <span class="comment"># source 主要是引用一下自己定义好的脚本，配置文件之类的内容 </span></span><br><span class="line">License: GPL                                            <span class="comment"># 一定带上（最好是对方源码包的 License）BSD，GPL，GPLv2</span></span><br><span class="line">Group: Rahul                                            <span class="comment"># 要全用这里面的一个组：less /usr/share/doc/rpm-version/GROUPS</span></span><br><span class="line">BuildArch: noarch               </span><br><span class="line">BuildRoot: %&#123;_tmppath&#125;/%&#123;name&#125;-buildroot                </span><br><span class="line">%description                                            <span class="comment"># 软件包详述 </span></span><br><span class="line">Garena self-build Nginx.</span><br><span class="line">%define _binaries_in_noarch_packages_terminate_build   0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.The Prep section 准备阶段, 主要就是把源码包解压到 build 目录下，设置一下环境变量，并 cd 进去 </span></span><br><span class="line">%prep</span><br><span class="line">%setup -q %&#123;name&#125;-%&#123;version&#125;                            <span class="comment"># 这个宏的作用静默模式解压并 cd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.The Build Section 编译制作阶段，这一节主要用于编译源码 </span></span><br><span class="line">%build</span><br><span class="line">CFLAGS=<span class="string">"<span class="variable">$RPM_OPT_FLAGS</span>"</span> ./configure --prefix=/usr/share/nginx/ \</span><br><span class="line">                    --sbin-path=/usr/sbin/nginx \</span><br><span class="line">                    --conf-path=/etc/nginx/nginx.conf \</span><br><span class="line">                    --error-log-path=/var/<span class="built_in">log</span>/nginx/error.log \</span><br><span class="line">                    --http-log-path=/var/<span class="built_in">log</span>/nginx/access.log \</span><br><span class="line">                    --pid-path=/var/run/nginx.pid \</span><br><span class="line">                    --lock-path=/var/lock/nginx.lock \</span><br><span class="line">                    --http-client-body-temp-path=/var/lib/nginx/body \</span><br><span class="line">                    --http-fastcgi-temp-path=/var/lib/nginx/fastcgi \</span><br><span class="line">                    --http-proxy-temp-path=/var/lib/nginx/proxy \</span><br><span class="line">                    --http-scgi-temp-path=/var/lib/nginx/scgi \</span><br><span class="line">                    --http-uwsgi-temp-path=/var/lib/nginx/uwsgi \</span><br><span class="line">                    --with-pcre-jit \</span><br><span class="line">                    --with-http_flv_module \</span><br><span class="line">                    --with-http_mp4_module \</span><br><span class="line">                    --with-file-aio \</span><br><span class="line">                    --with-http_v2_module \</span><br><span class="line">                    --with-stream \</span><br><span class="line">                    --with-stream_ssl_module \</span><br><span class="line">                    --with-http_auth_request_module \</span><br><span class="line">                    --with-http_slice_module \</span><br><span class="line">                    --with-threads \</span><br><span class="line">                    --with-http_gunzip_module \</span><br><span class="line">                    --with-http_random_index_module \</span><br><span class="line">                    --with-http_secure_link_module \</span><br><span class="line">                    --with-http_geoip_module \</span><br><span class="line">                    --with-http_ssl_module \</span><br><span class="line">                    --with-openssl=/usr/<span class="built_in">local</span>/src/openssl-1.0.2p \</span><br><span class="line">                    --with-http_addition_module \</span><br><span class="line">                    --with-http_geoip_module \</span><br><span class="line">                    --with-http_gzip_static_module \</span><br><span class="line">                    --with-http_realip_module \</span><br><span class="line">                    --with-ipv6 \</span><br><span class="line">                    --without-mail_pop3_module \</span><br><span class="line">                    --without-mail_imap_module \</span><br><span class="line">                    --without-mail_smtp_module \</span><br><span class="line">                    --add-module=contrib/Nginx-limit-traffic-rate-module \</span><br><span class="line">                    --add-module=contrib/headers-more-nginx-module \</span><br><span class="line">                    --add-module=contrib/<span class="built_in">echo</span>-nginx-module \</span><br><span class="line">                    --add-module=contrib/ngx_http_auth_pam_module \</span><br><span class="line">                    --add-module=contrib/ngx_cache_purge \</span><br><span class="line">                    --add-module=contrib/ngx_devel_kit \</span><br><span class="line">                    --add-module=contrib/lua-nginx-module \</span><br><span class="line">                    --add-module=contrib/naxsi/naxsi_src</span><br><span class="line">make -j8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.Install section  这一节主要用于完成实际安装软件必须执行的命令，可包含 4 种类型脚本 </span></span><br><span class="line">%install</span><br><span class="line">[ <span class="string">"<span class="variable">$RPM_BUILD_ROOT</span>"</span> != <span class="string">"/"</span> ] &amp;&amp; rm -rf <span class="variable">$RPM_BUILD_ROOT</span></span><br><span class="line">make DESTDIR=<span class="variable">$RPM_BUILD_ROOT</span> install</span><br><span class="line">install -m 0755 -d <span class="variable">$RPM_BUILD_ROOT</span>/etc/nginx/sites-enabled</span><br><span class="line">install -m 0755 -d <span class="variable">$RPM_BUILD_ROOT</span>/etc/nginx/sites-available</span><br><span class="line">install -m 0755 -d <span class="variable">$RPM_BUILD_ROOT</span>/var/<span class="built_in">log</span>/nginx</span><br><span class="line">install -m 0755 -d <span class="variable">$RPM_BUILD_ROOT</span>/var/lib/nginx</span><br><span class="line">install -D -m 644 conf/sites-available/000_stub_status <span class="variable">$RPM_BUILD_ROOT</span>/etc/nginx/sites-available/000_stub_status</span><br><span class="line">install -D -m 644 conf/django_fastcgi_params <span class="variable">$RPM_BUILD_ROOT</span>/etc/nginx/django_fastcgi_params</span><br><span class="line">install -D -m 644 conf/naxsi_core.rules <span class="variable">$RPM_BUILD_ROOT</span>/etc/nginx/naxsi_core.rules</span><br><span class="line">install -D -m 644 conf/sites-available/000_stub_status <span class="variable">$RPM_BUILD_ROOT</span>/etc/nginx/sites-enabled/000_stub_status</span><br><span class="line">install -D -m 644 logrotate.d/nginx <span class="variable">$RPM_BUILD_ROOT</span>/etc/logrotate.d/nginx</span><br><span class="line">install -D -m 644 nginx.service <span class="variable">$RPM_BUILD_ROOT</span>/usr/lib/systemd/system/nginx.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.clean section 清理段，clean 的主要作用就是删除 BUILD</span></span><br><span class="line">%clean</span><br><span class="line">[ <span class="string">"<span class="variable">$RPM_BUILD_ROOT</span>"</span> != <span class="string">"/"</span> ] &amp;&amp; rm -rf <span class="variable">$RPM_BUILD_ROOT</span></span><br><span class="line">%post</span><br><span class="line">useradd -s /sbin/nologin -d /var/www www-data</span><br><span class="line">chown -R www-data.www-data /var/<span class="built_in">log</span>/nginx /var/lib/nginx</span><br><span class="line">systemctl <span class="built_in">enable</span> nginx</span><br><span class="line"><span class="built_in">echo</span> %&#123;name&#125;-%&#123;version&#125; is successfully installed.</span><br><span class="line">systemctl start nginx</span><br><span class="line"><span class="comment"># 6.file section 文件列表段，这个阶段是把前面已经编译好的内容要打包了 </span></span><br><span class="line">%files</span><br><span class="line">%defattr(-,root,root)</span><br><span class="line">%dir /etc/nginx</span><br><span class="line">/etc/nginx/*</span><br><span class="line">%dir /usr/src/debug/nginx-garena-1.14.1</span><br><span class="line">/usr/src/debug/nginx-garena-1.14.1/*</span><br><span class="line">/usr/sbin/nginx</span><br><span class="line">%dir /usr/share/nginx</span><br><span class="line">/usr/share/nginx/*</span><br><span class="line">/etc/logrotate.d/nginx</span><br><span class="line">/usr/lib/systemd/system/nginx.service</span><br><span class="line">/usr/lib/debug/*</span><br><span class="line">/usr/lib/debug/.build-id/*</span><br><span class="line">%dir /var/<span class="built_in">log</span>/nginx</span><br><span class="line">%dir /var/lib/nginx</span><br><span class="line">%config(noreplace) /etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure><h3 id="nginx-template"><a href="#nginx-template" class="headerlink" title="nginx-template"></a>nginx-template</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line">nginx-template</span><br><span class="line">    ├── conf</span><br><span class="line">    │   ├── django_fastcgi_params</span><br><span class="line">    │   ├── naxsi_core.rules</span><br><span class="line">    │   └── sites-available</span><br><span class="line">    │       └── 000_stub_status</span><br><span class="line">    ├── logrotate.d</span><br><span class="line">    │   └── nginx</span><br><span class="line">    ├── nginx.conf</span><br><span class="line">    └── nginx.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx-rpmbuild-centos7/nginx-template/conf/django_fastcgi_params</span></span><br><span class="line">fastcgi_param  QUERY_STRING       <span class="variable">$query_string</span>;</span><br><span class="line">fastcgi_param  REQUEST_METHOD     <span class="variable">$request_method</span>;</span><br><span class="line">fastcgi_param  CONTENT_TYPE       <span class="variable">$content_type</span>;</span><br><span class="line">fastcgi_param  CONTENT_LENGTH     <span class="variable">$content_length</span>;</span><br><span class="line"></span><br><span class="line">fastcgi_param  PATH_INFO          <span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">fastcgi_param  REQUEST_URI        <span class="variable">$request_uri</span>;</span><br><span class="line">fastcgi_param  DOCUMENT_URI       <span class="variable">$document_uri</span>;</span><br><span class="line">fastcgi_param  DOCUMENT_ROOT      <span class="variable">$document_root</span>;</span><br><span class="line">fastcgi_param  SERVER_PROTOCOL    <span class="variable">$server_protocol</span>;</span><br><span class="line"></span><br><span class="line">fastcgi_param  GATEWAY_INTERFACE  CGI/1.1;</span><br><span class="line">fastcgi_param  SERVER_SOFTWARE    nginx/<span class="variable">$nginx_version</span>;</span><br><span class="line"></span><br><span class="line">fastcgi_param  REMOTE_ADDR        <span class="variable">$remote_addr</span>;</span><br><span class="line">fastcgi_param  REMOTE_PORT        <span class="variable">$remote_port</span>;</span><br><span class="line">fastcgi_param  SERVER_ADDR        <span class="variable">$server_addr</span>;</span><br><span class="line">fastcgi_param  SERVER_PORT        <span class="variable">$server_port</span>;</span><br><span class="line">fastcgi_param  SERVER_NAME        <span class="variable">$server_name</span>;</span><br><span class="line"></span><br><span class="line">fastcgi_param  HTTP_X_FORWARDED_PROTOCOL        <span class="variable">$scheme</span>;</span><br><span class="line"></span><br><span class="line">fastcgi_pass_header Authorization;</span><br><span class="line">fastcgi_intercept_errors off;</span><br><span class="line">fastcgi_keep_conn on;</span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx-rpmbuild-centos7/nginx-template/conf/naxsi_core.rules</span></span><br><span class="line"><span class="comment">##################################</span></span><br><span class="line"><span class="comment">## INTERNAL RULES IDS:1-999     ##</span></span><br><span class="line"><span class="comment">##################################</span></span><br><span class="line"><span class="comment">#@MainRule "msg:weird request, unable to parse" id:1;</span></span><br><span class="line"><span class="comment">#@MainRule "msg:request too big, stored on disk and not parsed" id:2;</span></span><br><span class="line"><span class="comment">#@MainRule "msg:invalid hex encoding, null bytes" id:10;</span></span><br><span class="line"><span class="comment">#@MainRule "msg:unknown content-type" id:11;</span></span><br><span class="line"><span class="comment">#@MainRule "msg:invalid formatted url" id:12;</span></span><br><span class="line"><span class="comment">#@MainRule "msg:invalid POST format" id:13;</span></span><br><span class="line"><span class="comment">#@MainRule "msg:invalid POST boundary" id:14;</span></span><br><span class="line"><span class="comment">#@MainRule "msg:invalid JSON" id:15;</span></span><br><span class="line"><span class="comment">#@MainRule "msg:empty POST" id:16;</span></span><br><span class="line"><span class="comment">#@MainRule "msg:libinjection_sql" id:17;</span></span><br><span class="line"><span class="comment">#@MainRule "msg:libinjection_xss" id:18;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##################################</span></span><br><span class="line"><span class="comment">## SQL Injections IDs:1000-1099 ##</span></span><br><span class="line"><span class="comment">##################################</span></span><br><span class="line">MainRule <span class="string">"rx:select|union|update|delete|insert|table|from|ascii|hex|unhex|drop"</span> <span class="string">"msg:sql keywords"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:4"</span> id:1000;</span><br><span class="line">MainRule <span class="string">"str:\""</span> <span class="string">"msg:double quote"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:8,<span class="variable">$XSS</span>:8"</span> id:1001;</span><br><span class="line">MainRule <span class="string">"str:0x"</span> <span class="string">"msg:0x, possible hex encoding"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:2"</span> id:1002;</span><br><span class="line"><span class="comment">## Hardcore rules</span></span><br><span class="line">MainRule <span class="string">"str:/*"</span> <span class="string">"msg:mysql comment (/*)"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:8"</span> id:1003;</span><br><span class="line">MainRule <span class="string">"str:*/"</span> <span class="string">"msg:mysql comment (*/)"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:8"</span> id:1004;</span><br><span class="line">MainRule <span class="string">"str:|"</span> <span class="string">"msg:mysql keyword (|)"</span>  <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:8"</span> id:1005;</span><br><span class="line">MainRule <span class="string">"str:&amp;&amp;"</span> <span class="string">"msg:mysql keyword (&amp;&amp;)"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:8"</span> id:1006;</span><br><span class="line"><span class="comment">## end of hardcore rules</span></span><br><span class="line">MainRule <span class="string">"str:--"</span> <span class="string">"msg:mysql comment (--)"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:4"</span> id:1007;</span><br><span class="line">MainRule <span class="string">"str:;"</span> <span class="string">"msg:semicolon"</span> <span class="string">"mz:BODY|URL|ARGS"</span> <span class="string">"s:<span class="variable">$SQL</span>:4,<span class="variable">$XSS</span>:8"</span> id:1008;</span><br><span class="line">MainRule <span class="string">"str:="</span> <span class="string">"msg:equal sign in var, probable sql/xss"</span> <span class="string">"mz:ARGS|BODY"</span> <span class="string">"s:<span class="variable">$SQL</span>:2"</span> id:1009;</span><br><span class="line">MainRule <span class="string">"str:("</span> <span class="string">"msg:open parenthesis, probable sql/xss"</span> <span class="string">"mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:4,<span class="variable">$XSS</span>:8"</span> id:1010;</span><br><span class="line">MainRule <span class="string">"str:)"</span> <span class="string">"msg:close parenthesis, probable sql/xss"</span> <span class="string">"mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:4,<span class="variable">$XSS</span>:8"</span> id:1011;</span><br><span class="line">MainRule <span class="string">"str:'"</span> <span class="string">"msg:simple quote"</span> <span class="string">"mz:ARGS|BODY|URL|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:4,<span class="variable">$XSS</span>:8"</span> id:1013;</span><br><span class="line">MainRule <span class="string">"str:,"</span> <span class="string">"msg:comma"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:4"</span> id:1015;</span><br><span class="line">MainRule <span class="string">"str:#"</span> <span class="string">"msg:mysql comment (#)"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:4"</span> id:1016;</span><br><span class="line">MainRule <span class="string">"str:@@"</span> <span class="string">"msg:double arobase (@@)"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:4"</span> id:1017;</span><br><span class="line"></span><br><span class="line"><span class="comment">###############################</span></span><br><span class="line"><span class="comment">## OBVIOUS RFI IDs:1100-1199 ##</span></span><br><span class="line"><span class="comment">###############################</span></span><br><span class="line">MainRule <span class="string">"str:http://"</span> <span class="string">"msg:http:// scheme"</span> <span class="string">"mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$RFI</span>:8"</span> id:1100;</span><br><span class="line">MainRule <span class="string">"str:https://"</span> <span class="string">"msg:https:// scheme"</span> <span class="string">"mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$RFI</span>:8"</span> id:1101;</span><br><span class="line">MainRule <span class="string">"str:ftp://"</span> <span class="string">"msg:ftp:// scheme"</span> <span class="string">"mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$RFI</span>:8"</span> id:1102;</span><br><span class="line">MainRule <span class="string">"str:php://"</span> <span class="string">"msg:php:// scheme"</span> <span class="string">"mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$RFI</span>:8"</span> id:1103;</span><br><span class="line">MainRule <span class="string">"str:sftp://"</span> <span class="string">"msg:sftp:// scheme"</span> <span class="string">"mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$RFI</span>:8"</span> id:1104;</span><br><span class="line">MainRule <span class="string">"str:zlib://"</span> <span class="string">"msg:zlib:// scheme"</span> <span class="string">"mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$RFI</span>:8"</span> id:1105;</span><br><span class="line">MainRule <span class="string">"str:data://"</span> <span class="string">"msg:data:// scheme"</span> <span class="string">"mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$RFI</span>:8"</span> id:1106;</span><br><span class="line">MainRule <span class="string">"str:glob://"</span> <span class="string">"msg:glob:// scheme"</span> <span class="string">"mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$RFI</span>:8"</span> id:1107;</span><br><span class="line">MainRule <span class="string">"str:phar://"</span> <span class="string">"msg:phar:// scheme"</span> <span class="string">"mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$RFI</span>:8"</span> id:1108;</span><br><span class="line">MainRule <span class="string">"str:file://"</span> <span class="string">"msg:file:// scheme"</span> <span class="string">"mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$RFI</span>:8"</span> id:1109;</span><br><span class="line">MainRule <span class="string">"str:gopher://"</span> <span class="string">"msg:gopher:// scheme"</span> <span class="string">"mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$RFI</span>:8"</span> id:1110;</span><br><span class="line"></span><br><span class="line"><span class="comment">#######################################</span></span><br><span class="line"><span class="comment">## Directory traversal IDs:1200-1299 ##</span></span><br><span class="line"><span class="comment">#######################################</span></span><br><span class="line">MainRule <span class="string">"str:.."</span> <span class="string">"msg:double dot"</span> <span class="string">"mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$TRAVERSAL</span>:4"</span> id:1200;</span><br><span class="line">MainRule <span class="string">"str:/etc/passwd"</span> <span class="string">"msg:obvious probe"</span> <span class="string">"mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$TRAVERSAL</span>:4"</span> id:1202;</span><br><span class="line">MainRule <span class="string">"str:c:\\"</span> <span class="string">"msg:obvious windows path"</span> <span class="string">"mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$TRAVERSAL</span>:4"</span> id:1203;</span><br><span class="line">MainRule <span class="string">"str:cmd.exe"</span> <span class="string">"msg:obvious probe"</span> <span class="string">"mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$TRAVERSAL</span>:4"</span> id:1204;</span><br><span class="line">MainRule <span class="string">"str:\\"</span> <span class="string">"msg:backslash"</span> <span class="string">"mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$TRAVERSAL</span>:4"</span> id:1205;</span><br><span class="line"><span class="comment">#MainRule "str:/" "msg:slash in args" "mz:ARGS|BODY|$HEADERS_VAR:Cookie" "s:$TRAVERSAL:2" id:1206;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">########################################</span></span><br><span class="line"><span class="comment">## Cross Site Scripting IDs:1300-1399 ##</span></span><br><span class="line"><span class="comment">########################################</span></span><br><span class="line">MainRule <span class="string">"str:&lt;"</span> <span class="string">"msg:html open tag"</span> <span class="string">"mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$XSS</span>:8"</span> id:1302;</span><br><span class="line">MainRule <span class="string">"str:&gt;"</span> <span class="string">"msg:html close tag"</span> <span class="string">"mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$XSS</span>:8"</span> id:1303;</span><br><span class="line">MainRule <span class="string">"str:["</span> <span class="string">"msg:open square backet ([), possible js"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$XSS</span>:4"</span> id:1310;</span><br><span class="line">MainRule <span class="string">"str:]"</span> <span class="string">"msg:close square bracket (]), possible js"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$XSS</span>:4"</span> id:1311;</span><br><span class="line">MainRule <span class="string">"str:~"</span> <span class="string">"msg:tilde (~) character"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$XSS</span>:4"</span> id:1312;</span><br><span class="line">MainRule <span class="string">"str:`"</span>  <span class="string">"msg:grave accent (`)"</span> <span class="string">"mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$XSS</span>:8"</span> id:1314;</span><br><span class="line">MainRule <span class="string">"rx:%[2|3]."</span>  <span class="string">"msg:double encoding"</span> <span class="string">"mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$XSS</span>:8"</span> id:1315;</span><br><span class="line"></span><br><span class="line"><span class="comment">####################################</span></span><br><span class="line"><span class="comment">## Evading tricks IDs: 1400-1500 ##</span></span><br><span class="line"><span class="comment">####################################</span></span><br><span class="line">MainRule <span class="string">"str:&amp;#"</span> <span class="string">"msg:utf7/8 encoding"</span> <span class="string">"mz:ARGS|BODY|URL|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$EVADE</span>:4"</span> id:1400;</span><br><span class="line">MainRule <span class="string">"str:%U"</span> <span class="string">"msg:M$ encoding"</span> <span class="string">"mz:ARGS|BODY|URL|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$EVADE</span>:4"</span> id:1401;</span><br><span class="line"></span><br><span class="line"><span class="comment">#############################</span></span><br><span class="line"><span class="comment">## File uploads: 1500-1600 ##</span></span><br><span class="line"><span class="comment">#############################</span></span><br><span class="line">MainRule <span class="string">"rx:\.ph|\.asp|\.ht"</span> <span class="string">"msg:asp/php file upload"</span> <span class="string">"mz:FILE_EXT"</span> <span class="string">"s:<span class="variable">$UPLOAD</span>:8"</span> id:1500;</span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx-rpmbuild-centos7/nginx-template/logrotate.d/nginx</span></span><br><span class="line">/var/<span class="built_in">log</span>/nginx/*.<span class="built_in">log</span> /var/<span class="built_in">log</span>/nginx/*/*.<span class="built_in">log</span>&#123;</span><br><span class="line">daily</span><br><span class="line">missingok</span><br><span class="line">rotate 14</span><br><span class="line">compress</span><br><span class="line">delaycompress</span><br><span class="line">notifempty</span><br><span class="line">create 640 root adm</span><br><span class="line">sharedscripts</span><br><span class="line">postrotate</span><br><span class="line">[ ! -f /var/run/nginx.pid ] || <span class="built_in">kill</span> -USR1 `cat /var/run/nginx.pid`</span><br><span class="line">endscript</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx-rpmbuild-centos7/nginx-template/nginx.conf</span></span><br><span class="line">user www-data;</span><br><span class="line">worker_processes auto;</span><br><span class="line"></span><br><span class="line"><span class="comment">#worker_cpu_affinity 00000001 00000010 00000100 00001000 00010000 00100000 01000000 10000000;</span></span><br><span class="line">worker_rlimit_nofile 655650;</span><br><span class="line"></span><br><span class="line">error_log  /var/<span class="built_in">log</span>/nginx/error.log;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">        worker_connections  10240;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line"><span class="comment">#       include       /etc/nginx/naxsi_core.rules;</span></span><br><span class="line">        include       mime.types;</span><br><span class="line">        default_type  application/octet-stream;</span><br><span class="line">log_format garena <span class="string">'$remote_addr - $remote_user [$time_iso8601]"$request"$status $body_bytes_sent'</span></span><br><span class="line">                <span class="string">'"$http_referer" "$http_user_agent" $request_time $upstream_response_time "$http_x_forwarded_for" "$geoip_country_code" "$host"'</span>;</span><br><span class="line">        log_format garena_post <span class="string">'$remote_addr - $remote_user [$time_iso8601]"$request"$status $body_bytes_sent'</span></span><br><span class="line">                <span class="string">'"$http_referer" "$http_user_agent" $request_time $upstream_response_time "$http_x_forwarded_for" "$geoip_country_code" "$host" "$request_body"'</span>;</span><br><span class="line">log_format compact <span class="string">'$time_iso8601|$remote_addr|$geoip_country_code|$http_x_forwarded_for|$status|$request_time|$upstream_response_time|$request_length|$body_bytes_sent|$host|$request|$http_referer|$http_user_agent'</span>;</span><br><span class="line">log_format compact_post <span class="string">'$time_iso8601|$remote_addr|$geoip_country_code|$http_x_forwarded_for|$status|$request_time|$upstream_response_time|$request_length|$body_bytes_sent|$host|$request|$http_referer|$http_user_agent|$request_body'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#       access_log  logs/access.log  main;</span></span><br><span class="line"></span><br><span class="line">        sendfile        on;</span><br><span class="line"><span class="comment">#       tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">        keepalive_timeout  30;</span><br><span class="line">        fastcgi_keep_conn on;</span><br><span class="line">        tcp_nodelay        on;</span><br><span class="line"></span><br><span class="line">        gzip  on;</span><br><span class="line">        gzip_disable <span class="string">"MSIE [1-6]\.(?!.*SV1)"</span>;</span><br><span class="line">        gzip_proxied any;</span><br><span class="line">        gzip_buffers 16 8k;</span><br><span class="line">        gzip_types    text/plain application/javascript application/x-javascript text/javascript text/xml text/css application/json;</span><br><span class="line">        gzip_vary on;</span><br><span class="line">        include /etc/nginx/sites-enabled/*;</span><br><span class="line"></span><br><span class="line">set_real_ip_from 10.0.0.0/8;</span><br><span class="line">real_ip_header    X-Forwarded-For;</span><br><span class="line"><span class="comment">#real_ip_recursive on;</span></span><br><span class="line"><span class="comment">#geoip_country /usr/share/GeoIP/GeoIP.dat;</span></span><br><span class="line"></span><br><span class="line">        server_tokens off;         <span class="comment"># returns "Server: nginx"</span></span><br><span class="line">more_clear_headers Server; <span class="comment"># doesn't return"Server: "header at all</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx-rpmbuild-centos7/nginx-template/nginx.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=The nginx HTTP and reverse proxy server</span><br><span class="line">After=network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/run/nginx.pid</span><br><span class="line">ExecStartPre=/usr/sbin/nginx -t</span><br><span class="line">ExecStart=/usr/sbin/nginx</span><br><span class="line">ExecReload=/bin/<span class="built_in">kill</span> -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">KillMode=process</span><br><span class="line">KillSignal=SIGQUIT</span><br><span class="line">TimeoutStopSec=5</span><br><span class="line">PrivateTmp=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h2 id="Initialize-rpmbuild-env"><a href="#Initialize-rpmbuild-env" class="headerlink" title="Initialize rpmbuild env"></a>Initialize rpmbuild env</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check current os version and kernel</span></span><br><span class="line">cat /etc/redhat-release</span><br><span class="line">CentOS Linux release 7.5.1804 (Core)</span><br><span class="line">uname -r</span><br><span class="line">3.10.0-862.el7.x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment"># install lua</span></span><br><span class="line">sh luajit.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># yum install dependencies</span></span><br><span class="line">yum install -y gcc pam-devel git rpm-build pcre-devel openssl openssl-devel geoip-devel</span><br><span class="line"></span><br><span class="line"><span class="comment"># mkdir</span></span><br><span class="line">mkdir -p /root/rpmbuild/SOURCES/</span><br><span class="line">mkdir -p /root/rpmbuild/SPECS/</span><br><span class="line">mkdir -p /root/rpmbuild/RPMS/noarch</span><br><span class="line"></span><br><span class="line"><span class="comment"># download openssl</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src</span><br><span class="line">wget https://github.com/openssl/openssl/archive/OpenSSL_1_0_2p.tar.gz</span><br><span class="line">tar xf OpenSSL_1_0_2p.tar.gz</span><br><span class="line">mv openssl-OpenSSL_1_0_2p/ openssl-1.0.2p</span><br><span class="line"></span><br><span class="line"><span class="comment"># confirm these files are correct</span></span><br><span class="line">[root@localhost ~]<span class="comment"># tree nginx-rpmbuild-centos7/</span></span><br><span class="line">nginx-rpmbuild-centos7/</span><br><span class="line">├── build.sh</span><br><span class="line">├── conf_buid</span><br><span class="line">│   ├── conf</span><br><span class="line">│   │   ├── django_fastcgi_params</span><br><span class="line">│   │   ├── fastcgi.conf</span><br><span class="line">│   │   ├── fastcgi_params</span><br><span class="line">│   │   ├── koi-utf</span><br><span class="line">│   │   ├── koi-win</span><br><span class="line">│   │   ├── mime.types</span><br><span class="line">│   │   ├── naxsi_core.rules</span><br><span class="line">│   │   ├── nginx.conf</span><br><span class="line">│   │   ├── scgi_params</span><br><span class="line">│   │   ├── sites-available</span><br><span class="line">│   │   │   └── 000_stub_status</span><br><span class="line">│   │   ├── uwsgi_params</span><br><span class="line">│   │   └── win-utf</span><br><span class="line">│   ├── logrotate.d</span><br><span class="line">│   │   └── nginx</span><br><span class="line">│   ├── nginx.conf</span><br><span class="line">│   └── nginx.service</span><br><span class="line">├── luajit.sh</span><br><span class="line">├── nginx-spec</span><br><span class="line">└── nginx-template</span><br><span class="line">    ├── conf</span><br><span class="line">    │   ├── django_fastcgi_params</span><br><span class="line">    │   ├── naxsi_core.rules</span><br><span class="line">    │   └── sites-available</span><br><span class="line">    │       └── 000_stub_status</span><br><span class="line">    ├── logrotate.d</span><br><span class="line">    │   └── nginx</span><br><span class="line">    ├── nginx.conf</span><br><span class="line">    └── nginx.service</span><br><span class="line"></span><br><span class="line">8 directories, 24 files</span><br></pre></td></tr></table></figure><h2 id="How-to-build-Nginx-RPM"><a href="#How-to-build-Nginx-RPM" class="headerlink" title="How to build Nginx RPM"></a>How to build Nginx RPM</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check nginx stable version from official website</span></span><br><span class="line">http://nginx.org/en/download.html</span><br><span class="line"></span><br><span class="line"><span class="comment"># check configuration</span></span><br><span class="line">vim build.sh</span><br><span class="line"></span><br><span class="line">NGX_VER=1.14.2</span><br><span class="line">WKDIR=<span class="string">"/root/rpmbuild/SOURCES"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># check nginx version</span></span><br><span class="line">vim nginx-spec</span><br><span class="line"></span><br><span class="line"><span class="comment"># run build.sh</span></span><br><span class="line">./build.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># RPM package</span></span><br><span class="line">Processing files: nginx-garena-1.14.2-0.noarch</span><br><span class="line">warning: File listed twice: /etc/nginx/nginx.conf</span><br><span class="line">Provides: config(nginx-garena) = 1.14.2-0 nginx-garena = 1.14.2-0</span><br><span class="line">Requires(interp): /bin/sh</span><br><span class="line">Requires(rpmlib): rpmlib(CompressedFileNames) &lt;= 3.0.4-1 rpmlib(FileDigests) &lt;= 4.6.0-1 rpmlib(PayloadFilesHavePrefix) &lt;= 4.0-1</span><br><span class="line">Requires(post): /bin/sh</span><br><span class="line">Requires: libGeoIP.so.1()(64bit) libc.so.6()(64bit) libc.so.6(GLIBC_2.10)(64bit) libc.so.6(GLIBC_2.11)(64bit) libc.so.6(GLIBC_2.14)(64bit) libc.so.6(GLIBC_2.17)(64bit) libc.so.6(GLIBC_2.2.5)(64bit) libc.so.6(GLIBC_2.3)(64bit) libc.so.6(GLIBC_2.3.2)(64bit) libc.so.6(GLIBC_2.3.4)(64bit) libc.so.6(GLIBC_2.4)(64bit) libc.so.6(GLIBC_2.7)(64bit) libcrypt.so.1()(64bit) libcrypt.so.1(GLIBC_2.2.5)(64bit) libdl.so.2()(64bit) libdl.so.2(GLIBC_2.2.5)(64bit) libgcc_s.so.1()(64bit) libgcc_s.so.1(GCC_3.0)(64bit) libgcc_s.so.1(GCC_3.3)(64bit) libm.so.6()(64bit) libm.so.6(GLIBC_2.2.5)(64bit) libpam.so.0()(64bit) libpam.so.0(LIBPAM_1.0)(64bit) libpcre.so.1()(64bit) libpthread.so.0()(64bit) libpthread.so.0(GLIBC_2.2.5)(64bit) libpthread.so.0(GLIBC_2.3.2)(64bit) libz.so.1()(64bit) rtld(GNU_HASH)</span><br><span class="line">warning: Arch dependent binaries <span class="keyword">in</span> noarch package</span><br><span class="line">Checking <span class="keyword">for</span> unpackaged file(s): /usr/lib/rpm/check-files /root/rpmbuild/BUILDROOT/nginx-garena-1.14.2-0.x86_64</span><br><span class="line">Wrote: /root/rpmbuild/SRPMS/nginx-garena-1.14.2-0.src.rpm</span><br><span class="line">Wrote: /root/rpmbuild/RPMS/noarch/nginx-garena-1.14.2-0.noarch.rpm</span><br><span class="line">Executing(%clean): /bin/sh -e /var/tmp/rpm-tmp.iR5dLd</span><br><span class="line">+ <span class="built_in">umask</span> 022</span><br><span class="line">+ <span class="built_in">cd</span> /root/rpmbuild/BUILD</span><br><span class="line">+ <span class="built_in">cd</span> nginx-garena-1.14.2</span><br><span class="line">+ <span class="string">'['</span> /root/rpmbuild/BUILDROOT/nginx-garena-1.14.2-0.x86_64 <span class="string">'!='</span> / <span class="string">']'</span></span><br><span class="line">+ rm -rf /root/rpmbuild/BUILDROOT/nginx-garena-1.14.2-0.x86_64</span><br><span class="line">+ <span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure><h2 id="基于-openresty-制作-nginx-rpm-安装包"><a href="#基于-openresty-制作-nginx-rpm-安装包" class="headerlink" title="基于 openresty 制作 nginx rpm 安装包"></a>基于 openresty 制作 nginx rpm 安装包</h2><blockquote><p>推荐大家向 openresty 转型，我在编译过程中主要遇到以下 4 个小问题</p></blockquote><ol><li>问题 1 沿用官方的 luajit v2.0.5 编译新版本 lua-nginx-module 应该会提示建议切换至 openresty 的 luajit v2.1 分支</li><li>问题 2 的解决方案是使用低版本 lua-nginx-module v0.10.14，使用最新版发现会触发该问题，等待官方修复</li><li>问题 3 的原因是因为 nginx 启动需要一点点时间，而 systemd 在 nginx 完成启动前就去读取 pid file 造成读取 pid 失败</li><li>问题 4 的 libluajit-5.1.so.2 问题跟着我的步骤执行应该不会出现，不需要执行 ln 软链接等操作</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@gop-sg-192-168-56-103 wangao]<span class="comment"># tailf /var/log/nginx/error.log</span></span><br><span class="line"><span class="comment"># 问题 1</span></span><br><span class="line">2019/11/04 11:59:56 [alert] 2749<span class="comment">#2749: detected a LuaJIT version which is not OpenResty's; many optimizations will be disabled and performance will be compromised (see https://github.com/openresty/luajit2 for OpenResty's LuaJIT or, even better, consider using the OpenResty releases from https://openresty.org/en/download.html)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 问题 2</span></span><br><span class="line">2019/11/04 11:59:56 [alert] 2749<span class="comment">#2749: failed to load the 'resty.core' module (https://github.com/openresty/lua-resty-core); ensure you are using an OpenResty release from https://openresty.org/en/download.html (reason: module 'resty.core' not found:</span></span><br><span class="line">no field package.preload[<span class="string">'resty.core'</span>]</span><br><span class="line">no file <span class="string">'./resty/core.lua'</span></span><br><span class="line">no file <span class="string">'/usr/local/share/luajit-2.0.5/resty/core.lua'</span></span><br><span class="line">no file <span class="string">'/usr/local/share/lua/5.1/resty/core.lua'</span></span><br><span class="line">no file <span class="string">'/usr/local/share/lua/5.1/resty/core/init.lua'</span></span><br><span class="line">no file <span class="string">'./resty/core.so'</span></span><br><span class="line">no file <span class="string">'/usr/local/lib/lua/5.1/resty/core.so'</span></span><br><span class="line">no file <span class="string">'/usr/local/lib/lua/5.1/loadall.so'</span></span><br><span class="line">no file <span class="string">'./resty.so'</span></span><br><span class="line">no file <span class="string">'/usr/local/lib/lua/5.1/resty.so'</span></span><br><span class="line">no file <span class="string">'/usr/local/lib/lua/5.1/loadall.so'</span>) <span class="keyword">in</span> /etc/nginx/nginx.conf:117</span><br><span class="line"></span><br><span class="line"><span class="comment"># 问题 3</span></span><br><span class="line">[root@gop-sg-192-168-56-103 wangao]<span class="comment"># systemctl status nginx</span></span><br><span class="line">● nginx.service - The NGINX HTTP and reverse proxy server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/nginx.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2019-08-19 01:36:46 +08; 2 months 17 days ago</span><br><span class="line">  Process: 1105 ExecStart=/usr/sbin/nginx (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 1071 ExecStartPre=/usr/sbin/nginx -t (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 1111 (nginx)</span><br><span class="line">    Tasks: 2</span><br><span class="line">   CGroup: /system.slice/nginx.service</span><br><span class="line">           ├─1111 nginx: master process /usr/sbin/nginx</span><br><span class="line">           └─1112 nginx: worker process</span><br><span class="line"></span><br><span class="line">Aug 19 01:36:46 gop-sg-192-168-56-103 systemd[1]: Starting The NGINX HTTP and reverse proxy server...</span><br><span class="line">Aug 19 01:36:46 gop-sg-192-168-56-103 nginx[1071]: nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">Aug 19 01:36:46 gop-sg-192-168-56-103 nginx[1071]: nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successful</span><br><span class="line">Aug 19 01:36:46 gop-sg-192-168-56-103 systemd[1]: Failed to <span class="built_in">read</span> PID from file /run/nginx.pid: Invalid argument</span><br><span class="line">Aug 19 01:36:46 gop-sg-192-168-56-103 systemd[1]: Started The NGINX HTTP and reverse proxy server.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 问题 4</span></span><br><span class="line">nginx: error <span class="keyword">while</span> loading shared libraries: libluajit-5.1.so.2: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure><h3 id="环境初始化"><a href="#环境初始化" class="headerlink" title="环境初始化"></a>环境初始化</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check current os version and kernel</span></span><br><span class="line">cat /etc/redhat-release</span><br><span class="line">CentOS Linux release 7.5.1804 (Core)</span><br><span class="line">uname -r</span><br><span class="line">3.10.0-862.el7.x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment"># yum</span></span><br><span class="line">yum install -y gcc pam-devel git rpm-build pcre-devel openssl openssl-devel geoip-devel</span><br><span class="line"></span><br><span class="line"><span class="comment"># mkdir</span></span><br><span class="line">mkdir -p /root/rpmbuild/SOURCES/</span><br><span class="line">mkdir -p /root/rpmbuild/SPECS/</span><br><span class="line">mkdir -p /root/rpmbuild/RPMS/noarch</span><br><span class="line"></span><br><span class="line"><span class="comment"># download openssl</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src</span><br><span class="line">wget https://github.com/openssl/openssl/archive/OpenSSL_1_0_2t.tar.gz</span><br><span class="line">tar xf OpenSSL_1_0_2t.tar.gz</span><br><span class="line">mv openssl-OpenSSL_1_0_2t/ openssl-1_0_2t</span><br><span class="line"></span><br><span class="line"><span class="comment"># install lua</span></span><br><span class="line">sh luajit2.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># confirm these files are correct</span></span><br><span class="line">[root@gop-sg-192-168-56-103 ~]<span class="comment"># tree nginx-rpmbuild-centos7/</span></span><br><span class="line">nginx-rpmbuild-centos7/</span><br><span class="line">├── build.sh</span><br><span class="line">├── conf_build</span><br><span class="line">│   ├── conf</span><br><span class="line">│   │   ├── django_fastcgi_params</span><br><span class="line">│   │   ├── fastcgi.conf</span><br><span class="line">│   │   ├── fastcgi_params</span><br><span class="line">│   │   ├── koi-utf</span><br><span class="line">│   │   ├── koi-win</span><br><span class="line">│   │   ├── mime.types</span><br><span class="line">│   │   ├── naxsi_core.rules</span><br><span class="line">│   │   ├── nginx.conf</span><br><span class="line">│   │   ├── scgi_params</span><br><span class="line">│   │   ├── sites-available</span><br><span class="line">│   │   │   └── 000_stub_status</span><br><span class="line">│   │   ├── uwsgi_params</span><br><span class="line">│   │   └── win-utf</span><br><span class="line">│   ├── logrotate.d</span><br><span class="line">│   │   └── nginx</span><br><span class="line">│   ├── nginx.conf</span><br><span class="line">│   └── nginx.service</span><br><span class="line">├── luajit2.sh</span><br><span class="line">├── luajit.sh</span><br><span class="line">├── nginx-spec</span><br><span class="line">└── nginx-template</span><br><span class="line">    ├── conf</span><br><span class="line">    │   ├── django_fastcgi_params</span><br><span class="line">    │   ├── naxsi_core.rules</span><br><span class="line">    │   ├── nginx.conf</span><br><span class="line">    │   └── sites-available</span><br><span class="line">    │       └── 000_stub_status</span><br><span class="line">    ├── logrotate.d</span><br><span class="line">    │   └── nginx</span><br><span class="line">    ├── nginx.conf</span><br><span class="line">    └── nginx.service</span><br><span class="line"></span><br><span class="line">8 directories, 26 files</span><br></pre></td></tr></table></figure><blockquote><p>luajit2.sh</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://github.com/openresty/luajit2/releases</span></span><br><span class="line">LUAVER=<span class="string">"v2.1-20190912"</span></span><br><span class="line">WKDIR=<span class="string">"/root/rpmbuild/SOURCES"</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$WKDIR</span></span><br><span class="line">wget https://github.com/openresty/luajit2/archive/<span class="variable">$LUAVER</span>.tar.gz</span><br><span class="line">tar zxf <span class="variable">$LUAVER</span>.tar.gz</span><br><span class="line">rm -f <span class="variable">$LUAVER</span>.tar.gz</span><br><span class="line"><span class="built_in">cd</span> luajit2*</span><br><span class="line">make BUILDMODE=static</span><br><span class="line">make install</span><br><span class="line"><span class="built_in">export</span> LUAJIT_LIB=/usr/<span class="built_in">local</span>/lib</span><br><span class="line"><span class="built_in">export</span> LUAJIT_INC=/usr/<span class="built_in">local</span>/include/luajit-2.1</span><br><span class="line"><span class="comment"># ln -s /usr/local/lib/libluajit-5.1.so.2 /lib64/libluajit-5.1.so.2</span></span><br><span class="line"><span class="comment"># https://github.com/openresty/lua-nginx-module/issues/8</span></span><br></pre></td></tr></table></figure><blockquote><p>build.sh</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">NGX_VER=1.16.1</span><br><span class="line">BDDIR=<span class="string">"/root/rpmbuild/BUILD"</span></span><br><span class="line">WKDIR=<span class="string">"/root/rpmbuild/SOURCES"</span></span><br><span class="line">CURRENTDIR=`dirname $(readlink -f <span class="string">"<span class="variable">$0</span>"</span>)`</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$CURRENTDIR</span></span><br><span class="line"><span class="built_in">export</span> LUAJIT_LIB=/usr/<span class="built_in">local</span>/lib</span><br><span class="line"><span class="comment"># export LUAJIT_INC=/usr/local/include/luajit-2.0</span></span><br><span class="line"><span class="built_in">export</span> LUAJIT_INC=/usr/<span class="built_in">local</span>/include/luajit-2.1</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$BDDIR</span></span><br><span class="line">rm -rf *</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$WKDIR</span></span><br><span class="line">rm -rf *</span><br><span class="line">wget http://nginx.org/download/nginx-<span class="variable">$NGX_VER</span>.tar.gz</span><br><span class="line">tar xzf nginx-<span class="variable">$NGX_VER</span>.tar.gz</span><br><span class="line">rm -f nginx-<span class="variable">$NGX_VER</span>.tar.gz</span><br><span class="line">mv nginx-<span class="variable">$NGX_VER</span> nginx-garena-<span class="variable">$NGX_VER</span></span><br><span class="line"><span class="built_in">cd</span> nginx-garena-<span class="variable">$NGX_VER</span>/</span><br><span class="line"></span><br><span class="line">mkdir -p contrib</span><br><span class="line"><span class="built_in">cd</span> contrib/</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/openresty/headers-more-nginx-module.git</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/openresty/<span class="built_in">echo</span>-nginx-module.git</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/simplresty/ngx_devel_kit.git</span><br><span class="line"><span class="comment"># git clone git://github.com/openresty/lua-nginx-module</span></span><br><span class="line">wget https://github.com/openresty/lua-nginx-module/archive/v0.10.14.tar.gz</span><br><span class="line">tar xf v0.10.14.tar.gz</span><br><span class="line">mv lua-nginx-module-0.10.14 lua-nginx-module</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/nbs-system/naxsi.git</span><br><span class="line">rm -rf */.git</span><br><span class="line">rm -rf *.tar*</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line"></span><br><span class="line">cp -r <span class="variable">$CURRENTDIR</span>/nginx-template/* <span class="variable">$WKDIR</span>/nginx-garena-<span class="variable">$NGX_VER</span>/</span><br><span class="line">cp <span class="variable">$CURRENTDIR</span>/nginx-spec /root/rpmbuild/SPECS/</span><br><span class="line"><span class="comment"># cp /root/rules $WKDIR/nginx-garena-$NGX_VER/debian/</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$WKDIR</span></span><br><span class="line">tar zcf nginx-garena-<span class="variable">$NGX_VER</span>.tar.gz nginx-garena-<span class="variable">$NGX_VER</span>/</span><br><span class="line"><span class="built_in">cd</span> /root/rpmbuild/SPECS/</span><br><span class="line">rpmbuild -ba nginx-spec</span><br><span class="line"><span class="built_in">cd</span> /root/rpmbuild/RPMS/noarch</span><br></pre></td></tr></table></figure><blockquote><p>nginx-spec</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Name: nginx-garena</span><br><span class="line">Version: 1.16.1</span><br><span class="line">Release: 0</span><br><span class="line">Summary: nginx garena rpm</span><br><span class="line">Source0: nginx-garena-%&#123;version&#125;.tar.gz</span><br><span class="line">License: GPL</span><br><span class="line">Group: Rahul</span><br><span class="line">BuildArch: noarch</span><br><span class="line">BuildRoot: %&#123;_tmppath&#125;/%&#123;name&#125;-buildroot</span><br><span class="line">%description</span><br><span class="line">Garena self-build Nginx.</span><br><span class="line">%define _binaries_in_noarch_packages_terminate_build   0</span><br><span class="line">%prep</span><br><span class="line">%setup -q %&#123;name&#125;-%&#123;version&#125;</span><br><span class="line">%build</span><br><span class="line">CFLAGS=&quot;$RPM_OPT_FLAGS&quot; ./configure --prefix=/usr/share/nginx/ \</span><br><span class="line">                    --with-ld-opt=&quot;-Wl,-rpath,/usr/local/lib&quot; \</span><br><span class="line">                    --sbin-path=/usr/sbin/nginx \</span><br><span class="line">                    --conf-path=/etc/nginx/nginx.conf \</span><br><span class="line">                    --error-log-path=/var/log/nginx/error.log \</span><br><span class="line">                    --http-log-path=/var/log/nginx/access.log \</span><br><span class="line">                    --pid-path=/var/run/nginx.pid \</span><br><span class="line">                    --lock-path=/var/lock/nginx.lock \</span><br><span class="line">                    --http-client-body-temp-path=/var/lib/nginx/body \</span><br><span class="line">                    --http-fastcgi-temp-path=/var/lib/nginx/fastcgi \</span><br><span class="line">                    --http-proxy-temp-path=/var/lib/nginx/proxy \</span><br><span class="line">                    --http-scgi-temp-path=/var/lib/nginx/scgi \</span><br><span class="line">                    --http-uwsgi-temp-path=/var/lib/nginx/uwsgi \</span><br><span class="line">                    --with-pcre-jit \</span><br><span class="line">                    --with-http_flv_module \</span><br><span class="line">                    --with-http_mp4_module \</span><br><span class="line">                    --with-file-aio \</span><br><span class="line">                    --with-http_v2_module \</span><br><span class="line">                    --with-stream \</span><br><span class="line">                    --with-stream_ssl_module \</span><br><span class="line">                    --with-http_auth_request_module \</span><br><span class="line">                    --with-http_slice_module \</span><br><span class="line">                    --with-threads \</span><br><span class="line">                    --with-http_gunzip_module \</span><br><span class="line">                    --with-http_random_index_module \</span><br><span class="line">                    --with-http_secure_link_module \</span><br><span class="line">                    --with-http_geoip_module \</span><br><span class="line">                    --with-http_ssl_module \</span><br><span class="line">                    --with-openssl=/usr/local/src/openssl-1_0_2t \</span><br><span class="line">                    --with-http_addition_module \</span><br><span class="line">                    --with-http_geoip_module \</span><br><span class="line">                    --with-http_gzip_static_module \</span><br><span class="line">                    --with-http_realip_module \</span><br><span class="line">                    --with-ipv6 \</span><br><span class="line">                    --without-mail_pop3_module \</span><br><span class="line">                    --without-mail_imap_module \</span><br><span class="line">                    --without-mail_smtp_module \</span><br><span class="line">                    --add-module=contrib/headers-more-nginx-module \</span><br><span class="line">                    --add-module=contrib/echo-nginx-module \</span><br><span class="line">                    --add-module=contrib/ngx_devel_kit \</span><br><span class="line">                    --add-module=contrib/lua-nginx-module \</span><br><span class="line">                    --add-module=contrib/naxsi/naxsi_src</span><br><span class="line">make -j8</span><br><span class="line"></span><br><span class="line">%install</span><br><span class="line">[ &quot;$RPM_BUILD_ROOT&quot; != &quot;/&quot; ] &amp;&amp; rm -rf $RPM_BUILD_ROOT</span><br><span class="line">make DESTDIR=$RPM_BUILD_ROOT install</span><br><span class="line">install -m 0755 -d $RPM_BUILD_ROOT/etc/nginx/sites-enabled</span><br><span class="line">install -m 0755 -d $RPM_BUILD_ROOT/etc/nginx/sites-available</span><br><span class="line">install -m 0755 -d $RPM_BUILD_ROOT/var/log/nginx</span><br><span class="line">install -m 0755 -d $RPM_BUILD_ROOT/var/lib/nginx</span><br><span class="line">install -D -m 644 conf/sites-available/000_stub_status $RPM_BUILD_ROOT/etc/nginx/sites-available/000_stub_status</span><br><span class="line">install -D -m 644 conf/django_fastcgi_params $RPM_BUILD_ROOT/etc/nginx/django_fastcgi_params</span><br><span class="line">install -D -m 644 conf/naxsi_core.rules $RPM_BUILD_ROOT/etc/nginx/naxsi_core.rules</span><br><span class="line">install -D -m 644 conf/sites-available/000_stub_status $RPM_BUILD_ROOT/etc/nginx/sites-enabled/000_stub_status</span><br><span class="line">install -D -m 644 logrotate.d/nginx $RPM_BUILD_ROOT/etc/logrotate.d/nginx</span><br><span class="line">install -D -m 644 nginx.service $RPM_BUILD_ROOT/usr/lib/systemd/system/nginx.service</span><br><span class="line">%clean</span><br><span class="line">[ &quot;$RPM_BUILD_ROOT&quot; != &quot;/&quot; ] &amp;&amp; rm -rf $RPM_BUILD_ROOT</span><br><span class="line">%post</span><br><span class="line">useradd -s /sbin/nologin -d /var/www www-data</span><br><span class="line">chown -R www-data.www-data /var/log/nginx /var/lib/nginx</span><br><span class="line">systemctl enable nginx</span><br><span class="line">echo %&#123;name&#125;-%&#123;version&#125; is successfully installed.</span><br><span class="line">systemctl start nginx</span><br><span class="line">%files</span><br><span class="line">%defattr(-,root,root)</span><br><span class="line">%dir /etc/nginx</span><br><span class="line">/etc/nginx/*</span><br><span class="line">%dir /usr/src/debug/nginx-garena-%&#123;version&#125;</span><br><span class="line">/usr/src/debug/nginx-garena-%&#123;version&#125;/*</span><br><span class="line">/usr/sbin/nginx</span><br><span class="line">%dir /usr/share/nginx</span><br><span class="line">/usr/share/nginx/*</span><br><span class="line">/etc/logrotate.d/nginx</span><br><span class="line">/usr/lib/systemd/system/nginx.service</span><br><span class="line">/usr/lib/debug/*</span><br><span class="line">/usr/lib/debug/.build-id/*</span><br><span class="line">%dir /var/log/nginx</span><br><span class="line">%dir /var/lib/nginx</span><br><span class="line">%config(noreplace) /etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure><blockquote><p>logrotate.d/nginx</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/var/log/nginx/*.log /var/log/nginx/*/*.log&#123;</span><br><span class="line">daily</span><br><span class="line">missingok</span><br><span class="line">rotate 14</span><br><span class="line">compress</span><br><span class="line">delaycompress</span><br><span class="line">notifempty</span><br><span class="line">create 640 root adm</span><br><span class="line">sharedscripts</span><br><span class="line">postrotate</span><br><span class="line">[ ! -f /var/run/nginx.pid ] || kill -USR1 `cat /var/run/nginx.pid`</span><br><span class="line">endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>nginx.conf</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">user www-data;</span><br><span class="line">worker_processes auto;</span><br><span class="line"></span><br><span class="line">#worker_cpu_affinity 00000001 00000010 00000100 00001000 00010000 00100000 01000000 10000000;</span><br><span class="line">worker_rlimit_nofile 655650;</span><br><span class="line"></span><br><span class="line">error_log  /var/log/nginx/error.log;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">        worker_connections  10240;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">#       include       /etc/nginx/naxsi_core.rules;</span><br><span class="line">        include       mime.types;</span><br><span class="line">        default_type  application/octet-stream;</span><br><span class="line">log_format garena &apos;$remote_addr - $remote_user [$time_iso8601] &quot;$request&quot; $status $body_bytes_sent &apos;</span><br><span class="line">                &apos;&quot;$http_referer&quot; &quot;$http_user_agent&quot; $request_time $upstream_response_time &quot;$http_x_forwarded_for&quot; &quot;$geoip_country_code&quot; &quot;$host&quot;&apos;;</span><br><span class="line">        log_format garena_post &apos;$remote_addr - $remote_user [$time_iso8601] &quot;$request&quot; $status $body_bytes_sent &apos;</span><br><span class="line">                &apos;&quot;$http_referer&quot; &quot;$http_user_agent&quot; $request_time $upstream_response_time &quot;$http_x_forwarded_for&quot; &quot;$geoip_country_code&quot; &quot;$host&quot; &quot;$request_body&quot;&apos;;</span><br><span class="line">log_format compact &apos;$time_iso8601|$remote_addr|$geoip_country_code|$http_x_forwarded_for|$status|$request_time|$upstream_response_time|$request_length|$body_bytes_sent|$host|$request|$http_referer|$http_user_agent&apos;;</span><br><span class="line">log_format compact_post &apos;$time_iso8601|$remote_addr|$geoip_country_code|$http_x_forwarded_for|$status|$request_time|$upstream_response_time|$request_length|$body_bytes_sent|$host|$request|$http_referer|$http_user_agent|$request_body&apos;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#       access_log  logs/access.log  main;</span><br><span class="line"></span><br><span class="line">        sendfile        on;</span><br><span class="line">#       tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">        keepalive_timeout  30;</span><br><span class="line">        fastcgi_keep_conn on;</span><br><span class="line">        tcp_nodelay        on;</span><br><span class="line"></span><br><span class="line">        gzip  on;</span><br><span class="line">        gzip_disable &quot;MSIE [1-6]\.(?!.*SV1)&quot;;</span><br><span class="line">        gzip_proxied any;</span><br><span class="line">        gzip_buffers 16 8k;</span><br><span class="line">        gzip_types    text/plain application/javascript application/x-javascript text/javascript text/xml text/css application/json;</span><br><span class="line">        gzip_vary on;</span><br><span class="line">        include /etc/nginx/sites-enabled/*;</span><br><span class="line"></span><br><span class="line">set_real_ip_from 10.0.0.0/8;</span><br><span class="line">real_ip_header    X-Forwarded-For;</span><br><span class="line">#real_ip_recursive on;</span><br><span class="line">#geoip_country /usr/share/GeoIP/GeoIP.dat;</span><br><span class="line"></span><br><span class="line">        server_tokens off;         # returns &quot;Server: nginx&quot;</span><br><span class="line">more_clear_headers Server; # doesn&apos;t return &quot;Server: &quot; header at all</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>nginx.service</p></blockquote><p><a href="https://www.nginx.com/resources/wiki/start/topics/examples/initscripts/" target="_blank" rel="noopener">https://www.nginx.com/resources/wiki/start/topics/examples/initscripts/</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=The nginx HTTP and reverse proxy server</span><br><span class="line">After=network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/run/nginx.pid</span><br><span class="line">ExecStartPre=/usr/sbin/nginx -t</span><br><span class="line">ExecStart=/usr/sbin/nginx</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">KillMode=process</span><br><span class="line">KillSignal=SIGQUIT</span><br><span class="line">TimeoutStopSec=5</span><br><span class="line">PrivateTmp=true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="编译生成-nginx-rpm"><a href="#编译生成-nginx-rpm" class="headerlink" title="编译生成 nginx rpm"></a>编译生成 nginx rpm</h3><ol><li>编辑 build.sh 和 nginx-spec 定义 NGX_VER=1.16.1</li><li>如果需要改变 contrib 的 module 也是修改上述两处位置</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">sh build.sh</span><br><span class="line"></span><br><span class="line">extracting debug info from /root/rpmbuild/BUILDROOT/nginx-garena-1.16.1-0.x86_64/usr/sbin/nginx</span><br><span class="line">dwz: Too few files <span class="keyword">for</span> multifile optimization</span><br><span class="line">/usr/lib/rpm/sepdebugcrcfix: Updated 1 CRC32s, 0 CRC32s did match.</span><br><span class="line">12776 blocks</span><br><span class="line">+ /usr/lib/rpm/check-buildroot</span><br><span class="line">+ /usr/lib/rpm/redhat/brp-compress</span><br><span class="line">+ /usr/lib/rpm/redhat/brp-strip-static-archive /usr/bin/strip</span><br><span class="line">+ /usr/lib/rpm/brp-python-bytecompile /usr/bin/python 1</span><br><span class="line">+ /usr/lib/rpm/redhat/brp-python-hardlink</span><br><span class="line">+ /usr/lib/rpm/redhat/brp-java-repack-jars</span><br><span class="line">Processing files: nginx-garena-1.16.1-0.noarch</span><br><span class="line">warning: File listed twice: /etc/nginx/nginx.conf</span><br><span class="line">Provides: config(nginx-garena) = 1.16.1-0 nginx-garena = 1.16.1-0</span><br><span class="line">Requires(interp): /bin/sh</span><br><span class="line">Requires(rpmlib): rpmlib(CompressedFileNames) &lt;= 3.0.4-1 rpmlib(FileDigests) &lt;= 4.6.0-1 rpmlib(PayloadFilesHavePrefix) &lt;= 4.0-1</span><br><span class="line">Requires(post): /bin/sh</span><br><span class="line">Requires: libGeoIP.so.1()(64bit) libc.so.6()(64bit) libc.so.6(GLIBC_2.10)(64bit) libc.so.6(GLIBC_2.11)(64bit) libc.so.6(GLIBC_2.14)(64bit) libc.so.6(GLIBC_2.17)(64bit) libc.so.6(GLIBC_2.2.5)(64bit) libc.so.6(GLIBC_2.3)(64bit) libc.so.6(GLIBC_2.3.2)(64bit) libc.so.6(GLIBC_2.3.4)(64bit) libc.so.6(GLIBC_2.4)(64bit) libc.so.6(GLIBC_2.7)(64bit) libcrypt.so.1()(64bit) libcrypt.so.1(GLIBC_2.2.5)(64bit) libdl.so.2()(64bit) libdl.so.2(GLIBC_2.2.5)(64bit) libgcc_s.so.1()(64bit) libgcc_s.so.1(GCC_3.0)(64bit) libgcc_s.so.1(GCC_3.3)(64bit) libm.so.6()(64bit) libm.so.6(GLIBC_2.2.5)(64bit) libpcre.so.1()(64bit) libpthread.so.0()(64bit) libpthread.so.0(GLIBC_2.2.5)(64bit) libpthread.so.0(GLIBC_2.3.2)(64bit) libz.so.1()(64bit) rtld(GNU_HASH)</span><br><span class="line">warning: Arch dependent binaries <span class="keyword">in</span> noarch package</span><br><span class="line">Checking <span class="keyword">for</span> unpackaged file(s): /usr/lib/rpm/check-files /root/rpmbuild/BUILDROOT/nginx-garena-1.16.1-0.x86_64</span><br><span class="line">Wrote: /root/rpmbuild/SRPMS/nginx-garena-1.16.1-0.src.rpm</span><br><span class="line">Wrote: /root/rpmbuild/RPMS/noarch/nginx-garena-1.16.1-0.noarch.rpm</span><br><span class="line">Executing(%clean): /bin/sh -e /var/tmp/rpm-tmp.Qc7JbE</span><br><span class="line">+ <span class="built_in">umask</span> 022</span><br><span class="line">+ <span class="built_in">cd</span> /root/rpmbuild/BUILD</span><br><span class="line">+ <span class="built_in">cd</span> nginx-garena-1.16.1</span><br><span class="line">+ <span class="string">'['</span> /root/rpmbuild/BUILDROOT/nginx-garena-1.16.1-0.x86_64 <span class="string">'!='</span> / <span class="string">']'</span></span><br><span class="line">+ rm -rf /root/rpmbuild/BUILDROOT/nginx-garena-1.16.1-0.x86_64</span><br><span class="line">+ <span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">[root@sg-gop-10-71-49-5 wangao]<span class="comment"># nginx -V</span></span><br><span class="line">nginx version: nginx/1.16.1</span><br><span class="line">built with OpenSSL 1.0.2t  10 Sep 2019</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/share/nginx/ --with-ld-opt=-Wl,-rpath,/usr/<span class="built_in">local</span>/lib --sbin-path=/usr/sbin/nginx --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/<span class="built_in">log</span>/nginx/error.log --http-log-path=/var/<span class="built_in">log</span>/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/lock/nginx.lock --http-client-body-temp-path=/var/lib/nginx/body --http-fastcgi-temp-path=/var/lib/nginx/fastcgi --http-proxy-temp-path=/var/lib/nginx/proxy --http-scgi-temp-path=/var/lib/nginx/scgi --http-uwsgi-temp-path=/var/lib/nginx/uwsgi --with-pcre-jit --with-http_flv_module --with-http_mp4_module --with-file-aio --with-http_v2_module --with-stream --with-stream_ssl_module --with-http_auth_request_module --with-http_slice_module --with-threads --with-http_gunzip_module --with-http_random_index_module --with-http_secure_link_module --with-http_geoip_module --with-http_ssl_module --with-openssl=/usr/<span class="built_in">local</span>/src/openssl-1_0_2t --with-http_addition_module --with-http_geoip_module --with-http_gzip_static_module --with-http_realip_module --with-ipv6 --without-mail_pop3_module --without-mail_imap_module --without-mail_smtp_module --add-module=contrib/headers-more-nginx-module --add-module=contrib/<span class="built_in">echo</span>-nginx-module --add-module=contrib/ngx_devel_kit --add-module=contrib/lua-nginx-module --add-module=contrib/naxsi/naxsi_src</span><br><span class="line"></span><br><span class="line"><span class="comment"># Prettier</span></span><br><span class="line">https://serverfault.com/questions/223509/how-can-i-see-which-flags-nginx-was-compiled-with</span><br><span class="line"></span><br><span class="line">[root@sg-gop-10-71-49-5 wangao]<span class="comment"># 2&gt;&amp;1 nginx -V | xargs -n1</span></span><br><span class="line">nginx</span><br><span class="line">version:</span><br><span class="line">nginx/1.16.1</span><br><span class="line">built</span><br><span class="line">with</span><br><span class="line">OpenSSL</span><br><span class="line">1.0.2t</span><br><span class="line">10</span><br><span class="line">Sep</span><br><span class="line">2019</span><br><span class="line">TLS</span><br><span class="line">SNI</span><br><span class="line">support</span><br><span class="line">enabled</span><br><span class="line">configure</span><br><span class="line">arguments:</span><br><span class="line">--prefix=/usr/share/nginx/</span><br><span class="line">--with-ld-opt=-Wl,-rpath,/usr/<span class="built_in">local</span>/lib</span><br><span class="line">--sbin-path=/usr/sbin/nginx</span><br><span class="line">--conf-path=/etc/nginx/nginx.conf</span><br><span class="line">--error-log-path=/var/<span class="built_in">log</span>/nginx/error.log</span><br><span class="line">--http-log-path=/var/<span class="built_in">log</span>/nginx/access.log</span><br><span class="line">--pid-path=/var/run/nginx.pid</span><br><span class="line">--lock-path=/var/lock/nginx.lock</span><br><span class="line">--http-client-body-temp-path=/var/lib/nginx/body</span><br><span class="line">--http-fastcgi-temp-path=/var/lib/nginx/fastcgi</span><br><span class="line">--http-proxy-temp-path=/var/lib/nginx/proxy</span><br><span class="line">--http-scgi-temp-path=/var/lib/nginx/scgi</span><br><span class="line">--http-uwsgi-temp-path=/var/lib/nginx/uwsgi</span><br><span class="line">--with-pcre-jit</span><br><span class="line">--with-http_flv_module</span><br><span class="line">--with-http_mp4_module</span><br><span class="line">--with-file-aio</span><br><span class="line">--with-http_v2_module</span><br><span class="line">--with-stream</span><br><span class="line">--with-stream_ssl_module</span><br><span class="line">--with-http_auth_request_module</span><br><span class="line">--with-http_slice_module</span><br><span class="line">--with-threads</span><br><span class="line">--with-http_gunzip_module</span><br><span class="line">--with-http_random_index_module</span><br><span class="line">--with-http_secure_link_module</span><br><span class="line">--with-http_geoip_module</span><br><span class="line">--with-http_ssl_module</span><br><span class="line">--with-openssl=/usr/<span class="built_in">local</span>/src/openssl-1_0_2t</span><br><span class="line">--with-http_addition_module</span><br><span class="line">--with-http_geoip_module</span><br><span class="line">--with-http_gzip_static_module</span><br><span class="line">--with-http_realip_module</span><br><span class="line">--with-ipv6</span><br><span class="line">--without-mail_pop3_module</span><br><span class="line">--without-mail_imap_module</span><br><span class="line">--without-mail_smtp_module</span><br><span class="line">--add-module=contrib/headers-more-nginx-module</span><br><span class="line">--add-module=contrib/<span class="built_in">echo</span>-nginx-module</span><br><span class="line">--add-module=contrib/ngx_devel_kit</span><br><span class="line">--add-module=contrib/lua-nginx-module</span><br><span class="line">--add-module=contrib/naxsi/naxsi_src</span><br><span class="line"></span><br><span class="line">[root@sg-gop-10-71-49-5 wangao]<span class="comment"># 2&gt;&amp;1 nginx -V | xargs -n1 | grep ssl</span></span><br><span class="line">--with-stream_ssl_module</span><br><span class="line">--with-http_ssl_module</span><br><span class="line">--with-openssl=/usr/<span class="built_in">local</span>/src/openssl-1_0_2t</span><br><span class="line"></span><br><span class="line">[root@sg-gop-10-71-49-5 wangao]<span class="comment"># 2&gt;&amp;1 nginx -V | xargs -n1 | grep lua</span></span><br><span class="line">--add-module=contrib/lua-nginx-module</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      使用rpmbuild制作Nginx的RPM包
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>Bash 命令语法和 Bash Cheat Sheet 中文速查表</title>
    <link href="https://wsgzao.github.io/post/bash/"/>
    <id>https://wsgzao.github.io/post/bash/</id>
    <published>2019-10-28T06:59:49.000Z</published>
    <updated>2019-10-29T07:13:55.367Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Bash Shell 作为 Linux 的指定合作伙伴我们已经再熟悉不过了，使用 Bash 可以快速编写简单的脚本方便我们的日常比如善用 <code>vim</code>，<code>awk</code> 和 <code>sed</code> 三剑客，也可以创建十分复杂的逻辑，当然我更愿意推荐你使用 Python 代替，之前一直没有刻意去整理因为平时常用的就这么几个，有些经验和技巧都是在实战中形成和记录，需要使用的时候知道大概用什么，查下相关语法和案例即可。</p><blockquote><p>Bash 命令语法和 Bash Cheat Sheet 中文速查表</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 10 月 29 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/bash/">https://wsgzao.github.io/post/bash/</a></p><p><strong> 扩展阅读 </strong></p><p><a href="https://github.com/skywind3000/awesome-cheatsheets/blob/master/languages/bash.sh" target="_blank" rel="noopener">Bash awesome-cheatsheets</a></p><p><a href="https://github.com/OMGZui/bash-step-to-step" target="_blank" rel="noopener">bash-step-to-step</a></p><p><a href="http://sayhiai.com/15614525129972.html" target="_blank" rel="noopener">Linux 上，最常用的一批命令解析（10 年精选）</a></p><hr><h2 id="bash-sh"><a href="#bash-sh" class="headerlink" title="bash.sh"></a>bash.sh</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># BASH CHEATSHEET (中文速查表)  -  by skywind (created on 2018/02/14)</span></span><br><span class="line"><span class="comment"># Version: 47, Last Modified: 2019/09/24 17:58</span></span><br><span class="line"><span class="comment"># https://github.com/skywind3000/awesome-cheatsheets</span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># 常用快捷键（默认使用 Emacs 键位）</span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line">CTRL+A              <span class="comment"># 移动到行首，同 &lt;Home&gt;</span></span><br><span class="line">CTRL+B              <span class="comment"># 向后移动，同 &lt;Left&gt;</span></span><br><span class="line">CTRL+C              <span class="comment"># 结束当前命令 </span></span><br><span class="line">CTRL+D              <span class="comment"># 删除光标前的字符，同 &lt;Delete&gt; ，或者没有内容时，退出会话 </span></span><br><span class="line">CTRL+E              <span class="comment"># 移动到行末，同 &lt;End&gt;</span></span><br><span class="line">CTRL+F              <span class="comment"># 向前移动，同 &lt;Right&gt;</span></span><br><span class="line">CTRL+G              <span class="comment"># 退出当前编辑（比如正在 CTRL+R 搜索历史时）</span></span><br><span class="line">CTRL+H              <span class="comment"># 删除光标左边的字符，同 &lt;Backspace&gt;</span></span><br><span class="line">CTRL+K              <span class="comment"># 删除光标位置到行末的内容 </span></span><br><span class="line">CTRL+L              <span class="comment"># 清屏并重新显示 </span></span><br><span class="line">CTRL+N              <span class="comment"># 移动到命令历史的下一行，同 &lt;Down&gt;</span></span><br><span class="line">CTRL+O              <span class="comment"># 类似回车，但是会显示下一行历史 </span></span><br><span class="line">CTRL+P              <span class="comment"># 移动到命令历史的上一行，同 &lt;Up&gt;</span></span><br><span class="line">CTRL+R              <span class="comment"># 历史命令反向搜索，使用 CTRL+G 退出搜索 </span></span><br><span class="line">CTRL+S              <span class="comment"># 历史命令正向搜索，使用 CTRL+G 退出搜索 </span></span><br><span class="line">CTRL+T              <span class="comment"># 交换前后两个字符 </span></span><br><span class="line">CTRL+U              <span class="comment"># 删除字符到行首 </span></span><br><span class="line">CTRL+V              <span class="comment"># 输入字符字面量，先按 CTRL+V 再按任意键 </span></span><br><span class="line">CTRL+W              <span class="comment"># 删除光标左边的一个单词 </span></span><br><span class="line">CTRL+X              <span class="comment"># 列出可能的补全 </span></span><br><span class="line">CTRL+Y              <span class="comment"># 粘贴前面 CTRL+u/k/w 删除过的内容 </span></span><br><span class="line">CTRL+Z              <span class="comment"># 暂停前台进程返回 bash，需要时可用 fg 将其切换回前台 </span></span><br><span class="line">CTRL+_              <span class="comment"># 撤销（undo），有的终端将 CTRL+_ 映射为 CTRL+/ 或 CTRL+7</span></span><br><span class="line"></span><br><span class="line">ALT+b               <span class="comment"># 向后（左边）移动一个单词 </span></span><br><span class="line">ALT+d               <span class="comment"># 删除光标后（右边）一个单词 </span></span><br><span class="line">ALT+f               <span class="comment"># 向前（右边）移动一个单词 </span></span><br><span class="line">ALT+t               <span class="comment"># 交换字符 </span></span><br><span class="line">ALT+BACKSPACE       <span class="comment"># 删除光标前面一个单词，类似 CTRL+W，但不影响剪贴板 </span></span><br><span class="line"></span><br><span class="line">CTRL+X CTRL+X       <span class="comment"># 连续按两次 CTRL+X，光标在当前位置和行首来回跳转 </span></span><br><span class="line">CTRL+X CTRL+E       <span class="comment"># 用你指定的编辑器，编辑当前命令 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># BASH 基本操作 </span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span>                <span class="comment"># 退出当前登陆 </span></span><br><span class="line">env                 <span class="comment"># 显示环境变量 </span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$SHELL</span>         <span class="comment"># 显示你在使用什么 SHELL</span></span><br><span class="line"></span><br><span class="line">bash                <span class="comment"># 使用 bash，用 exit 返回 </span></span><br><span class="line"><span class="built_in">which</span> bash          <span class="comment"># 搜索 $PATH，查找哪个程序对应命令 bash</span></span><br><span class="line">whereis bash        <span class="comment"># 搜索可执行，头文件和帮助信息的位置，使用系统内建数据库 </span></span><br><span class="line">whatis bash         <span class="comment"># 查看某个命令的解释，一句话告诉你这是干什么的 </span></span><br><span class="line"></span><br><span class="line">clear               <span class="comment"># 清初屏幕内容 </span></span><br><span class="line">reset               <span class="comment"># 重置终端（当你不小心 cat 了一个二进制，终端状态乱掉时使用）</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># 目录操作 </span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span>                  <span class="comment"># 返回自己 $HOME 目录 </span></span><br><span class="line"><span class="built_in">cd</span> &#123;dirname&#125;        <span class="comment"># 进入目录 </span></span><br><span class="line"><span class="built_in">pwd</span>                 <span class="comment"># 显示当前所在目录 </span></span><br><span class="line">mkdir &#123;dirname&#125;     <span class="comment"># 创建目录 </span></span><br><span class="line">mkdir -p &#123;dirname&#125;  <span class="comment"># 递归创建目录 </span></span><br><span class="line"><span class="built_in">pushd</span> &#123;dirname&#125;     <span class="comment"># 目录压栈并进入新目录 </span></span><br><span class="line"><span class="built_in">popd</span>                <span class="comment"># 弹出并进入栈顶的目录 </span></span><br><span class="line"><span class="built_in">dirs</span> -v             <span class="comment"># 列出当前目录栈 </span></span><br><span class="line"><span class="built_in">cd</span> -                <span class="comment"># 回到之前的目录 </span></span><br><span class="line"><span class="built_in">cd</span> -&#123;N&#125;             <span class="comment"># 切换到目录栈中的第 N 个目录，比如 cd -2 将切换到第二个 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># 文件操作 </span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line">ls                  <span class="comment"># 显示当前目录内容，后面可接目录名：ls &#123;dir&#125; 显示指定目录 </span></span><br><span class="line">ls -l               <span class="comment"># 列表方式显示目录内容，包括文件日期，大小，权限等信息 </span></span><br><span class="line">ls -1               <span class="comment"># 列表方式显示目录内容，只显示文件名称，减号后面是数字 1</span></span><br><span class="line">ls -a               <span class="comment"># 显示所有文件和目录，包括隐藏文件（. 开头的文件 / 目录名）</span></span><br><span class="line">ln -s &#123;fn&#125; &#123;link&#125;   <span class="comment"># 给指定文件创建一个软链接 </span></span><br><span class="line">cp &#123;src&#125; &#123;dest&#125;     <span class="comment"># 拷贝文件，cp -r dir1 dir2 可以递归拷贝（目录）</span></span><br><span class="line">rm &#123;fn&#125;             <span class="comment"># 删除文件，rm -r 递归删除目录，rm -f 强制删除 </span></span><br><span class="line">mv &#123;src&#125; &#123;dest&#125;     <span class="comment"># 移动文件，如果 dest 是目录，则移动，是文件名则覆盖 </span></span><br><span class="line">touch &#123;fn&#125;          <span class="comment"># 创建或者更新一下制定文件 </span></span><br><span class="line">cat &#123;fn&#125;            <span class="comment"># 输出文件原始内容 </span></span><br><span class="line">any_cmd &gt; &#123;fn&#125;      <span class="comment"># 执行任意命令并将标准输出重定向到指定文件 </span></span><br><span class="line">more &#123;fn&#125;           <span class="comment"># 逐屏显示某文件内容，空格翻页，q 退出 </span></span><br><span class="line">less &#123;fn&#125;           <span class="comment"># 更高级点的 more，更多操作，q 退出 </span></span><br><span class="line">head &#123;fn&#125;           <span class="comment"># 显示文件头部数行，可用 head -3 abc.txt 显示头三行 </span></span><br><span class="line">tail &#123;fn&#125;           <span class="comment"># 显示文件尾部数行，可用 tail -3 abc.txt 显示尾部三行 </span></span><br><span class="line">tail -f &#123;fn&#125;        <span class="comment"># 持续显示文件尾部数据，可用于监控日志 </span></span><br><span class="line">nano &#123;fn&#125;           <span class="comment"># 使用 nano 编辑器编辑文件 </span></span><br><span class="line">vim &#123;fn&#125;            <span class="comment"># 使用 vim 编辑文件 </span></span><br><span class="line">diff &#123;f1&#125; &#123;f2&#125;      <span class="comment"># 比较两个文件的内容 </span></span><br><span class="line">wc &#123;fn&#125;             <span class="comment"># 统计文件有多少行，多少个单词 </span></span><br><span class="line">chmod 644 &#123;fn&#125;      <span class="comment"># 修改文件权限为 644，可以接 -R 对目录循环改权限 </span></span><br><span class="line">chgrp group &#123;fn&#125;    <span class="comment"># 修改文件所属的用户组 </span></span><br><span class="line">chown user1 &#123;fn&#125;    <span class="comment"># 修改文件所有人为 user1, chown user1:group1 fn 可以修改组 </span></span><br><span class="line">file &#123;fn&#125;           <span class="comment"># 检测文件的类型和编码 </span></span><br><span class="line">basename &#123;fn&#125;       <span class="comment"># 查看文件的名字（不包括路径）</span></span><br><span class="line">dirname &#123;fn&#125;        <span class="comment"># 查看文件的路径（不包括名字）</span></span><br><span class="line">grep &#123;pat&#125; &#123;fn&#125;     <span class="comment"># 在文件中查找出现过 pat 的内容 </span></span><br><span class="line">grep -r &#123;pat&#125; .     <span class="comment"># 在当前目录下递归查找所有出现过 pat 的文件内容 </span></span><br><span class="line"><span class="built_in">stat</span> &#123;fn&#125;           <span class="comment"># 显示文件的详细信息 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># 用户管理 </span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line">whoami              <span class="comment"># 显示我的用户名 </span></span><br><span class="line">who                 <span class="comment"># 显示已登陆用户信息，w / who / users 内容略有不同 </span></span><br><span class="line">w                   <span class="comment"># 显示已登陆用户信息，w / who / users 内容略有不同 </span></span><br><span class="line">users               <span class="comment"># 显示已登陆用户信息，w / who / users 内容略有不同 </span></span><br><span class="line">passwd              <span class="comment"># 修改密码，passwd &#123;user&#125; 可以用于 root 修改别人密码 </span></span><br><span class="line">finger &#123;user&#125;       <span class="comment"># 显示某用户信息，包括 id, 名字, 登陆状态等 </span></span><br><span class="line">adduser &#123;user&#125;      <span class="comment"># 添加用户 </span></span><br><span class="line">deluser &#123;user&#125;      <span class="comment"># 删除用户 </span></span><br><span class="line">w                   <span class="comment"># 查看谁在线 </span></span><br><span class="line">su                  <span class="comment"># 切换到 root 用户 </span></span><br><span class="line">su -                <span class="comment"># 切换到 root 用户并登陆（执行登陆脚本）</span></span><br><span class="line">su &#123;user&#125;           <span class="comment"># 切换到某用户 </span></span><br><span class="line">su -&#123;user&#125;          <span class="comment"># 切换到某用户并登陆（执行登陆脚本）</span></span><br><span class="line">id &#123;user&#125;           <span class="comment"># 查看用户的 uid，gid 以及所属其他用户组 </span></span><br><span class="line">id -u &#123;user&#125;        <span class="comment"># 打印用户 uid</span></span><br><span class="line">id -g &#123;user&#125;        <span class="comment"># 打印用户 gid</span></span><br><span class="line">write &#123;user&#125;        <span class="comment"># 向某用户发送一句消息 </span></span><br><span class="line">last                <span class="comment"># 显示最近用户登陆列表 </span></span><br><span class="line">last &#123;user&#125;         <span class="comment"># 显示登陆记录 </span></span><br><span class="line">lastb               <span class="comment"># 显示失败登陆记录 </span></span><br><span class="line">lastlog             <span class="comment"># 显示所有用户的最近登陆记录 </span></span><br><span class="line">sudo &#123;<span class="built_in">command</span>&#125;      <span class="comment"># 以 root 权限执行某命令 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># 进程管理 </span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line">ps                        <span class="comment"># 查看当前会话进程 </span></span><br><span class="line">ps ax                     <span class="comment"># 查看所有进程，类似 ps -e</span></span><br><span class="line">ps aux                    <span class="comment"># 查看所有进程详细信息，类似 ps -ef</span></span><br><span class="line">ps auxww                  <span class="comment"># 查看所有进程，并且显示进程的完整启动命令 </span></span><br><span class="line">ps -u &#123;user&#125;              <span class="comment"># 查看某用户进程 </span></span><br><span class="line">ps axjf                   <span class="comment"># 列出进程树 </span></span><br><span class="line">ps xjf -u &#123;user&#125;          <span class="comment"># 列出某用户的进程树 </span></span><br><span class="line">ps -eo pid,user,<span class="built_in">command</span>   <span class="comment"># 按用户指定的格式查看进程 </span></span><br><span class="line">ps aux | grep httpd       <span class="comment"># 查看名为 httpd 的所有进程 </span></span><br><span class="line">ps --ppid &#123;pid&#125;           <span class="comment"># 查看父进程为 pid 的所有进程 </span></span><br><span class="line">pstree                    <span class="comment"># 树形列出所有进程，pstree 默认一般不带，需安装 </span></span><br><span class="line">pstree &#123;user&#125;             <span class="comment"># 进程树列出某用户的进程 </span></span><br><span class="line">pstree -u                 <span class="comment"># 树形列出所有进程以及所属用户 </span></span><br><span class="line">pgrep &#123;procname&#125;          <span class="comment"># 搜索名字匹配的进程的 pid，比如 pgrep apache2</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">kill</span> &#123;pid&#125;                <span class="comment"># 结束进程 </span></span><br><span class="line"><span class="built_in">kill</span> -9 &#123;pid&#125;             <span class="comment"># 强制结束进程，9/SIGKILL 是强制不可捕获结束信号 </span></span><br><span class="line"><span class="built_in">kill</span> -KILL &#123;pid&#125;          <span class="comment"># 强制执行进程，kill -9 的另外一种写法 </span></span><br><span class="line"><span class="built_in">kill</span> -l                   <span class="comment"># 查看所有信号 </span></span><br><span class="line"><span class="built_in">kill</span> -l TERM              <span class="comment"># 查看 TERM 信号的编号 </span></span><br><span class="line">killall &#123;procname&#125;        <span class="comment"># 按名称结束所有进程 </span></span><br><span class="line">pkill &#123;procname&#125;          <span class="comment"># 按名称结束进程，除名称外还可以有其他参数 </span></span><br><span class="line"></span><br><span class="line">top                       <span class="comment"># 查看最活跃的进程 </span></span><br><span class="line">top -u &#123;user&#125;             <span class="comment"># 查看某用户最活跃的进程 </span></span><br><span class="line"></span><br><span class="line">any_command &amp;             <span class="comment"># 在后台运行某命令，也可用 CTRL+Z 将当前进程挂到后台 </span></span><br><span class="line"><span class="built_in">jobs</span>                      <span class="comment"># 查看所有后台进程（jobs）</span></span><br><span class="line"><span class="built_in">bg</span>                        <span class="comment"># 查看后台进程，并切换过去 </span></span><br><span class="line"><span class="built_in">fg</span>                        <span class="comment"># 切换后台进程到前台 </span></span><br><span class="line"><span class="built_in">fg</span> &#123;job&#125;                  <span class="comment"># 切换特定后台进程到前台 </span></span><br><span class="line"></span><br><span class="line"><span class="built_in">trap</span> cmd sig1 sig2        <span class="comment"># 在脚本中设置信号处理命令 </span></span><br><span class="line"><span class="built_in">trap</span> <span class="string">""</span> sig1 sig2         <span class="comment"># 在脚本中屏蔽某信号 </span></span><br><span class="line"><span class="built_in">trap</span> - sig1 sig2          <span class="comment"># 恢复默认信号处理行为 </span></span><br><span class="line"></span><br><span class="line">nohup &#123;<span class="built_in">command</span>&#125;           <span class="comment"># 长期运行某程序，在你退出登陆都保持它运行 </span></span><br><span class="line">nohup &#123;<span class="built_in">command</span>&#125; &amp;         <span class="comment"># 在后台长期运行某程序 </span></span><br><span class="line"><span class="built_in">disown</span> &#123;PID|JID&#125;          <span class="comment"># 将进程从后台任务列表（jobs）移除 </span></span><br><span class="line"></span><br><span class="line"><span class="built_in">wait</span>                      <span class="comment"># 等待所有后台进程任务结束 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># 常用命令：SSH / 系统信息 / 网络 </span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line">ssh user@host             <span class="comment"># 以用户 user 登陆到远程主机 host</span></span><br><span class="line">ssh -p &#123;port&#125; user@host   <span class="comment"># 指定端口登陆主机 </span></span><br><span class="line">ssh-copy-id user@host     <span class="comment"># 拷贝你的 ssh key 到远程主机，避免重复输入密码 </span></span><br><span class="line">scp &#123;fn&#125; user@host:path   <span class="comment"># 拷贝文件到远程主机 </span></span><br><span class="line">scp user@host:path dest   <span class="comment"># 从远程主机拷贝文件回来 </span></span><br><span class="line">scp -P &#123;port&#125; ...         <span class="comment"># 指定端口远程拷贝文件 </span></span><br><span class="line"></span><br><span class="line">uname -a                  <span class="comment"># 查看内核版本等信息 </span></span><br><span class="line">man &#123;<span class="built_in">help</span>&#125;                <span class="comment"># 查看帮助 </span></span><br><span class="line">man -k &#123;keyword&#125;          <span class="comment"># 查看哪些帮助文档里包含了该关键字 </span></span><br><span class="line">info &#123;<span class="built_in">help</span>&#125;               <span class="comment"># 查看 info pages，比 man 更强的帮助系统 </span></span><br><span class="line">uptime                    <span class="comment"># 查看系统启动时间 </span></span><br><span class="line">date                      <span class="comment"># 显示日期 </span></span><br><span class="line">cal                       <span class="comment"># 显示日历 </span></span><br><span class="line">vmstat                    <span class="comment"># 显示内存和 CPU 使用情况 </span></span><br><span class="line">vmstat 10                 <span class="comment"># 每 10 秒打印一行内存和 CPU 情况，CTRL+C 退出 </span></span><br><span class="line">free                      <span class="comment"># 显示内存和交换区使用情况 </span></span><br><span class="line">df                        <span class="comment"># 显示磁盘使用情况 </span></span><br><span class="line">du                        <span class="comment"># 显示当前目录占用，du . --max-depth=2 可以指定深度 </span></span><br><span class="line">uname                     <span class="comment"># 显示系统版本号 </span></span><br><span class="line">hostname                  <span class="comment"># 显示主机名称 </span></span><br><span class="line">showkey -a                <span class="comment"># 查看终端发送的按键编码 </span></span><br><span class="line"></span><br><span class="line">ping &#123;host&#125;               <span class="comment"># ping 远程主机并显示结果，CTRL+C 退出 </span></span><br><span class="line">ping -c N &#123;host&#125;          <span class="comment"># ping 远程主机 N 次 </span></span><br><span class="line">traceroute &#123;host&#125;         <span class="comment"># 侦测路由连通情况 </span></span><br><span class="line">mtr &#123;host&#125;                <span class="comment"># 高级版本 traceroute</span></span><br><span class="line">host &#123;domain&#125;             <span class="comment"># DNS 查询，&#123;domain&#125; 前面可加 -a 查看详细信息 </span></span><br><span class="line">whois &#123;domain&#125;            <span class="comment"># 取得域名 whois 信息 </span></span><br><span class="line">dig &#123;domain&#125;              <span class="comment"># 取得域名 dns 信息 </span></span><br><span class="line">route -n                  <span class="comment"># 查看路由表 </span></span><br><span class="line">netstat -a                <span class="comment"># 列出所有端口 </span></span><br><span class="line">netstat -an               <span class="comment"># 查看所有连接信息，不解析域名 </span></span><br><span class="line">netstat -anp              <span class="comment"># 查看所有连接信息，包含进程信息（需要 sudo）</span></span><br><span class="line">netstat -l                <span class="comment"># 查看所有监听的端口 </span></span><br><span class="line">netstat -t                <span class="comment"># 查看所有 TCP 链接 </span></span><br><span class="line">netstat -lntu             <span class="comment"># 显示所有正在监听的 TCP 和 UDP 信息 </span></span><br><span class="line">netstat -lntup            <span class="comment"># 显示所有正在监听的 socket 及进程信息 </span></span><br><span class="line">netstat -i                <span class="comment"># 显示网卡信息 </span></span><br><span class="line">netstat -rn               <span class="comment"># 显示当前系统路由表，同 route -n</span></span><br><span class="line">ss -an                    <span class="comment"># 比 netstat -an 更快速更详细 </span></span><br><span class="line">ss -s                     <span class="comment"># 统计 TCP 的 established, wait 等 </span></span><br><span class="line"></span><br><span class="line">wget &#123;url&#125;                <span class="comment"># 下载文件，可加 --no-check-certificate 忽略 ssl 验证 </span></span><br><span class="line">wget -qO- &#123;url&#125;           <span class="comment"># 下载文件并输出到标准输出（不保存）</span></span><br><span class="line">curl -sL &#123;url&#125;            <span class="comment"># 同 wget -qO- &#123;url&#125; 没有 wget 的时候使用 </span></span><br><span class="line"></span><br><span class="line">sz &#123;file&#125;                 <span class="comment"># 发送文件到终端，zmodem 协议 </span></span><br><span class="line">rz                        <span class="comment"># 接收终端发送过来的文件 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># 变量操作 </span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line">varname=value             <span class="comment"># 定义变量 </span></span><br><span class="line">varname=value <span class="built_in">command</span>     <span class="comment"># 定义子进程变量并执行子进程 </span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$varname</span>             <span class="comment"># 查看变量内容 </span></span><br><span class="line"><span class="built_in">echo</span> $$                   <span class="comment"># 查看当前 shell 的进程号 </span></span><br><span class="line"><span class="built_in">echo</span> $!                   <span class="comment"># 查看最近调用的后台任务进程号 </span></span><br><span class="line"><span class="built_in">echo</span> $?                   <span class="comment"># 查看最近一条命令的返回码 </span></span><br><span class="line"><span class="built_in">export</span> VARNAME=value      <span class="comment"># 设置环境变量（将会影响到子进程）</span></span><br><span class="line"></span><br><span class="line">array[0]=valA             <span class="comment"># 定义数组 </span></span><br><span class="line">array[1]=valB</span><br><span class="line">array[2]=valC</span><br><span class="line">array=([0]=valA [1]=valB [2]=valC)   <span class="comment"># 另一种方式 </span></span><br><span class="line">array=(valA valB valC)               <span class="comment"># 另一种方式 </span></span><br><span class="line"></span><br><span class="line"><span class="variable">$&#123;array[i]&#125;</span>               <span class="comment"># 取得数组中的元素 </span></span><br><span class="line"><span class="variable">$&#123;#array[@]&#125;</span>              <span class="comment"># 取得数组的长度 </span></span><br><span class="line"><span class="variable">$&#123;#array[i]&#125;</span>              <span class="comment"># 取得数组中某个变量的长度 </span></span><br><span class="line"></span><br><span class="line"><span class="built_in">declare</span> -a                <span class="comment"># 查看所有数组 </span></span><br><span class="line"><span class="built_in">declare</span> -f                <span class="comment"># 查看所有函数 </span></span><br><span class="line"><span class="built_in">declare</span> -F                <span class="comment"># 查看所有函数，仅显示函数名 </span></span><br><span class="line"><span class="built_in">declare</span> -i                <span class="comment"># 查看所有整数 </span></span><br><span class="line"><span class="built_in">declare</span> -r                <span class="comment"># 查看所有只读变量 </span></span><br><span class="line"><span class="built_in">declare</span> -x                <span class="comment"># 查看所有被导出成环境变量的东西 </span></span><br><span class="line"><span class="built_in">declare</span> -p varname        <span class="comment"># 输出变量是怎么定义的（类型 + 值）</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$&#123;varname:-word&#125;</span>          <span class="comment"># 如果变量不为空则返回变量，否则返回 word</span></span><br><span class="line"><span class="variable">$&#123;varname:=word&#125;</span>          <span class="comment"># 如果变量不为空则返回变量，否则赋值成 word 并返回 </span></span><br><span class="line"><span class="variable">$&#123;varname:?message&#125;</span>       <span class="comment"># 如果变量不为空则返回变量，否则打印错误信息并退出 </span></span><br><span class="line"><span class="variable">$&#123;varname:+word&#125;</span>          <span class="comment"># 如果变量不为空则返回 word，否则返回 null</span></span><br><span class="line"><span class="variable">$&#123;varname:offset:len&#125;</span>     <span class="comment"># 取得字符串的子字符串 </span></span><br><span class="line"></span><br><span class="line"><span class="variable">$&#123;variable#pattern&#125;</span>       <span class="comment"># 如果变量头部匹配 pattern，则删除最小匹配部分返回剩下的 </span></span><br><span class="line"><span class="variable">$&#123;variable##pattern&#125;</span>      <span class="comment"># 如果变量头部匹配 pattern，则删除最大匹配部分返回剩下的 </span></span><br><span class="line"><span class="variable">$&#123;variable%pattern&#125;</span>       <span class="comment"># 如果变量尾部匹配 pattern，则删除最小匹配部分返回剩下的 </span></span><br><span class="line"><span class="variable">$&#123;variable%%pattern&#125;</span>      <span class="comment"># 如果变量尾部匹配 pattern，则删除最大匹配部分返回剩下的 </span></span><br><span class="line"><span class="variable">$&#123;variable/pattern/str&#125;</span>   <span class="comment"># 将变量中第一个匹配 pattern 的替换成 str，并返回 </span></span><br><span class="line"><span class="variable">$&#123;variable//pattern/str&#125;</span>  <span class="comment"># 将变量中所有匹配 pattern 的地方替换成 str 并返回 </span></span><br><span class="line"></span><br><span class="line"><span class="variable">$&#123;#varname&#125;</span>               <span class="comment"># 返回字符串长度 </span></span><br><span class="line"></span><br><span class="line">*(patternlist)            <span class="comment"># 零次或者多次匹配 </span></span><br><span class="line">+(patternlist)            <span class="comment"># 一次或者多次匹配 </span></span><br><span class="line">?(patternlist)            <span class="comment"># 零次或者一次匹配 </span></span><br><span class="line">@(patternlist)            <span class="comment"># 单词匹配 </span></span><br><span class="line">!(patternlist)            <span class="comment"># 不匹配 </span></span><br><span class="line"></span><br><span class="line">array=(<span class="variable">$text</span>)             <span class="comment"># 按空格分隔 text 成数组，并赋值给变量 </span></span><br><span class="line">IFS=<span class="string">"/"</span> array=(<span class="variable">$text</span>)     <span class="comment"># 按斜杆分隔字符串 text 成数组，并赋值给变量 </span></span><br><span class="line">text=<span class="string">"<span class="variable">$&#123;array[*]&#125;</span>"</span>        <span class="comment"># 用空格链接数组并赋值给变量 </span></span><br><span class="line">text=$(IFS=/; <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;array[*]&#125;</span>"</span>)  <span class="comment"># 用斜杠链接数组并赋值给变量 </span></span><br><span class="line"></span><br><span class="line">A=( foo bar <span class="string">"a  b c"</span> 42 ) <span class="comment"># 数组定义 </span></span><br><span class="line">B=(<span class="string">"<span class="variable">$&#123;A[@]:1:2&#125;</span>"</span>)         <span class="comment"># 数组切片：B=( bar"a  b c")</span></span><br><span class="line">C=(<span class="string">"<span class="variable">$&#123;A[@]:1&#125;</span>"</span>)           <span class="comment"># 数组切片：C=( bar"a  b c"42 )</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;B[@]&#125;</span>"</span>            <span class="comment"># bar a  b c</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;B[1]&#125;</span>"</span>            <span class="comment"># a  b c</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;C[@]&#125;</span>"</span>            <span class="comment"># bar a  b c 42</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;C[@]: -2:2&#125;</span>"</span>      <span class="comment"># a  b c 42  减号前的空格是必须的 </span></span><br><span class="line"></span><br><span class="line">$(UNIX <span class="built_in">command</span>)           <span class="comment"># 运行命令，并将标准输出内容捕获并返回 </span></span><br><span class="line">varname=$(id -u user)     <span class="comment"># 将用户名为 user 的 uid 赋值给 varname 变量 </span></span><br><span class="line"></span><br><span class="line">num=$(expr 1 + 2)         <span class="comment"># 兼容 posix sh 的计算，使用 expr 命令计算结果 </span></span><br><span class="line">num=$(expr <span class="variable">$num</span> + 1)      <span class="comment"># 数字自增 </span></span><br><span class="line">expr 2 \* \( 2 + 3 \)     <span class="comment"># 兼容 posix sh 的复杂计算，输出 10</span></span><br><span class="line"></span><br><span class="line">num=$((1 + 2))            <span class="comment"># 计算 1+2 赋值给 num，使用 bash 独有的 $((..)) 计算 </span></span><br><span class="line">num=$((<span class="variable">$num</span> + 1))         <span class="comment"># 变量递增 </span></span><br><span class="line">num=$((num + 1))          <span class="comment"># 变量递增，双括号内的 $ 可以省略 </span></span><br><span class="line">num=$((1 + (2 + 3) * 2))  <span class="comment"># 复杂计算 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># 事件指示符 </span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line">!!                  <span class="comment"># 上一条命令 </span></span><br><span class="line">!^                  <span class="comment"># 上一条命令的第一个单词 </span></span><br><span class="line">!$                  <span class="comment"># 上一条命令的最后一个单词 </span></span><br><span class="line">!string             <span class="comment"># 最近一条包含 string 的命令 </span></span><br><span class="line">!^string1^string2   <span class="comment"># 最近一条包含 string1 的命令, 快速替换 string1 为 string2</span></span><br><span class="line">!<span class="comment">#                  # 本条命令之前所有的输入内容 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># 函数 </span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义一个新函数 </span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">myfunc</span></span>() &#123;</span><br><span class="line">    <span class="comment"># $1 代表第一个参数，$N 代表第 N 个参数 </span></span><br><span class="line">    <span class="comment"># $# 代表参数个数 </span></span><br><span class="line">    <span class="comment"># $0 代表被调用者自身的名字 </span></span><br><span class="line">    <span class="comment"># $@ 代表所有参数，类型是个数组，想传递所有参数给其他命令用 cmd"$@"</span></span><br><span class="line">    <span class="comment"># $* 空格链接起来的所有参数，类型是字符串 </span></span><br><span class="line">    &#123;shell commands ...&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">myfunc                    <span class="comment"># 调用函数 myfunc </span></span><br><span class="line">myfunc arg1 arg2 arg3     <span class="comment"># 带参数的函数调用 </span></span><br><span class="line">myfunc <span class="string">"<span class="variable">$@</span>"</span>               <span class="comment"># 将所有参数传递给函数 </span></span><br><span class="line">myfunc <span class="string">"<span class="variable">$&#123;array[@]&#125;</span>"</span>      <span class="comment"># 将一个数组当作多个参数传递给函数 </span></span><br><span class="line"><span class="built_in">shift</span>                     <span class="comment"># 参数左移 </span></span><br><span class="line"></span><br><span class="line"><span class="built_in">unset</span> -f myfunc           <span class="comment"># 删除函数 </span></span><br><span class="line"><span class="built_in">declare</span> -f                <span class="comment"># 列出函数定义 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># 条件判断（兼容 posix sh 的条件判断）：man test</span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line">statement1 &amp;&amp; statement2  <span class="comment"># and 操作符 </span></span><br><span class="line">statement1 || statement2  <span class="comment"># or 操作符 </span></span><br><span class="line"></span><br><span class="line">exp1 -a exp2              <span class="comment"># exp1 和 exp2 同时为真时返回真（POSIX XSI 扩展）</span></span><br><span class="line">exp1 -o exp2              <span class="comment"># exp1 和 exp2 有一个为真就返回真（POSIX XSI 扩展）</span></span><br><span class="line">( expression )            <span class="comment"># 如果 expression 为真时返回真，输入注意括号前反斜杆 </span></span><br><span class="line">! expression              <span class="comment"># 如果 expression 为假那返回真 </span></span><br><span class="line"></span><br><span class="line">str1 = str2               <span class="comment"># 判断字符串相等，如 ["$x"="$y"] &amp;&amp; echo yes</span></span><br><span class="line">str1 != str2              <span class="comment"># 判断字符串不等，如 ["$x"!="$y"] &amp;&amp; echo yes</span></span><br><span class="line">str1 &lt; str2               <span class="comment"># 字符串小于，如 ["$x"\&lt;"$y"] &amp;&amp; echo yes</span></span><br><span class="line">str2 &gt; str2               <span class="comment"># 字符串大于，注意 &lt; 或 &gt; 是字面量，输入时要加反斜杆 </span></span><br><span class="line">-n str1                   <span class="comment"># 判断字符串不为空（长度大于零）</span></span><br><span class="line">-z str1                   <span class="comment"># 判断字符串为空（长度等于零）</span></span><br><span class="line"></span><br><span class="line">-a file                   <span class="comment"># 判断文件存在，如 [ -a /tmp/abc ] &amp;&amp; echo"exists"</span></span><br><span class="line">-d file                   <span class="comment"># 判断文件存在，且该文件是一个目录 </span></span><br><span class="line">-e file                   <span class="comment"># 判断文件存在，和 -a 等价 </span></span><br><span class="line">-f file                   <span class="comment"># 判断文件存在，且该文件是一个普通文件（非目录等）</span></span><br><span class="line">-r file                   <span class="comment"># 判断文件存在，且可读 </span></span><br><span class="line">-s file                   <span class="comment"># 判断文件存在，且尺寸大于 0</span></span><br><span class="line">-w file                   <span class="comment"># 判断文件存在，且可写 </span></span><br><span class="line">-x file                   <span class="comment"># 判断文件存在，且执行 </span></span><br><span class="line">-N file                   <span class="comment"># 文件上次修改过后还没有读取过 </span></span><br><span class="line">-O file                   <span class="comment"># 文件存在且属于当前用户 </span></span><br><span class="line">-G file                   <span class="comment"># 文件存在且匹配你的用户组 </span></span><br><span class="line">file1 -nt file2           <span class="comment"># 文件 1 比 文件 2 新 </span></span><br><span class="line">file1 -ot file2           <span class="comment"># 文件 1 比 文件 2 旧 </span></span><br><span class="line"></span><br><span class="line">num1 -eq num2             <span class="comment"># 数字判断：num1 == num2</span></span><br><span class="line">num1 -ne num2             <span class="comment"># 数字判断：num1 != num2</span></span><br><span class="line">num1 -lt num2             <span class="comment"># 数字判断：num1 &lt; num2</span></span><br><span class="line">num1 -le num2             <span class="comment"># 数字判断：num1 &lt;= num2</span></span><br><span class="line">num1 -gt num2             <span class="comment"># 数字判断：num1 &gt; num2</span></span><br><span class="line">num1 -ge num2             <span class="comment"># 数字判断：num1 &gt;= num2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># 分支控制：if 和经典 test，兼容 posix sh 的条件判断语句 </span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">test</span> &#123;expression&#125;         <span class="comment"># 判断条件为真的话 test 程序返回 0 否则非零 </span></span><br><span class="line">[ expression ]            <span class="comment"># 判断条件为真的话返回 0 否则非零 </span></span><br><span class="line"></span><br><span class="line"><span class="built_in">test</span> <span class="string">"abc"</span> = <span class="string">"def"</span>        <span class="comment"># 查看返回值 echo $? 显示 1，因为条件为假 </span></span><br><span class="line"><span class="built_in">test</span> <span class="string">"abc"</span> != <span class="string">"def"</span>       <span class="comment"># 查看返回值 echo $? 显示 0，因为条件为真 </span></span><br><span class="line"></span><br><span class="line"><span class="built_in">test</span> -a /tmp; <span class="built_in">echo</span> $?     <span class="comment"># 调用 test 判断 /tmp 是否存在，并打印 test 的返回值 </span></span><br><span class="line">[ -a /tmp ]; <span class="built_in">echo</span> $?      <span class="comment"># 和上面完全等价，/tmp 肯定是存在的，所以输出是 0</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">test</span> cond &amp;&amp; cmd1         <span class="comment"># 判断条件为真时执行 cmd1</span></span><br><span class="line">[ cond ] &amp;&amp; cmd1          <span class="comment"># 和上面完全等价 </span></span><br><span class="line">[ cond ] &amp;&amp; cmd1 || cmd2  <span class="comment"># 条件为真执行 cmd1 否则执行 cmd2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断 /etc/passwd 文件是否存在 </span></span><br><span class="line"><span class="comment"># 经典的 if 语句就是判断后面的命令返回值为 0 的话，认为条件为真，否则为假 </span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -e /etc/passwd; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"alright it exists ... "</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"it doesn't exist ..."</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 和上面完全等价，[ 是个和 test 一样的可执行程序，但最后一个参数必须为 ]</span></span><br><span class="line"><span class="comment"># 这个名字为 "[" 的可执行程序一般就在 /bin 或 /usr/bin 下面，比 test 优雅些 </span></span><br><span class="line"><span class="keyword">if</span> [ -e /etc/passwd ]; <span class="keyword">then</span>   </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"alright it exists ..."</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"it doesn't exist ... "</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 和上面两个完全等价，其实到 bash 时代 [ 已经是内部命令了，用 enable 可以看到 </span></span><br><span class="line">[ -e /etc/passwd ] &amp;&amp; <span class="built_in">echo</span> <span class="string">"alright it exists"</span> || <span class="built_in">echo</span> <span class="string">"it doesn't exist"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断变量的值 </span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$varname</span>"</span> = <span class="string">"foo"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"this is foo"</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">"<span class="variable">$varname</span>"</span> = <span class="string">"bar"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"this is bar"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"neither"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复杂条件判断，注意 || 和 &amp;&amp; 是完全兼容 POSIX 的推荐写法 </span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$x</span> -gt 10 ] &amp;&amp; [ <span class="variable">$x</span> -lt 20 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"yes, between 10 and 20"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以用 &amp;&amp; 命令连接符来做和上面完全等价的事情 </span></span><br><span class="line">[ <span class="variable">$x</span> -gt 10 ] &amp;&amp; [ <span class="variable">$x</span> -lt 20 ] &amp;&amp; <span class="built_in">echo</span> <span class="string">"yes, between 10 and 20"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 小括号和 -a -o 是 POSIX XSI 扩展写法，小括号是字面量，输入时前面要加反斜杆 </span></span><br><span class="line"><span class="keyword">if</span> [ \( <span class="variable">$x</span> -gt 10 \) -a \( <span class="variable">$x</span> -lt 20 \) ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"yes, between 10 and 20"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 同样可以用 &amp;&amp; 命令连接符来做和上面完全等价的事情 </span></span><br><span class="line">[ \( <span class="variable">$x</span> -gt 10 \) -a \( <span class="variable">$x</span> -lt 20 \) ] &amp;&amp; <span class="built_in">echo</span> <span class="string">"yes, between 10 and 20"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断程序存在的话就执行 </span></span><br><span class="line">[ -x /bin/ls ] &amp;&amp; /bin/ls -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果不考虑兼容 posix sh 和 dash 这些的话，可用 bash 独有的 ((..)) 和 [[..]]:</span></span><br><span class="line">https://www.ibm.com/developerworks/library/l-bash-test/index.html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># 流程控制：while / for / case / until </span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># while 循环 </span></span><br><span class="line"><span class="keyword">while</span> condition; <span class="keyword">do</span></span><br><span class="line">    statements</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">i=1</span><br><span class="line"><span class="keyword">while</span> [ <span class="variable">$i</span> -le 10 ]; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$i</span>; </span><br><span class="line">    i=$(expr <span class="variable">$i</span> + 1)</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for 循环：上面的 while 语句等价 </span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..10&#125;; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$i</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> name [<span class="keyword">in</span> list]; <span class="keyword">do</span></span><br><span class="line">    statements</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for 列举某目录下面的所有文件 </span></span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> /home/*; <span class="keyword">do</span> </span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$f</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># bash 独有的 (( .. )) 语句，更接近 C 语言，但是不兼容 posix sh</span></span><br><span class="line"><span class="keyword">for</span> (( initialisation ; ending condition ; update )); <span class="keyword">do</span></span><br><span class="line">    statements</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 和上面的写法等价 </span></span><br><span class="line"><span class="keyword">for</span> ((i = 0; i &lt; 10; i++)); <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span>; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># case 判断 </span></span><br><span class="line"><span class="keyword">case</span> expression <span class="keyword">in</span> </span><br><span class="line">    pattern1 )</span><br><span class="line">        statements ;;</span><br><span class="line">    pattern2 )</span><br><span class="line">        statements ;;</span><br><span class="line">    * )</span><br><span class="line">        otherwise ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># until 语句 </span></span><br><span class="line">until condition; <span class="keyword">do</span></span><br><span class="line">    statements</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># select 语句 </span></span><br><span class="line">select name [<span class="keyword">in</span> list]; <span class="keyword">do</span></span><br><span class="line">  statements that can use <span class="variable">$name</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># 命令处理 </span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">command</span> ls                         <span class="comment"># 忽略 alias 直接执行程序或者内建命令 ls</span></span><br><span class="line"><span class="built_in">builtin</span> <span class="built_in">cd</span>                         <span class="comment"># 忽略 alias 直接运行内建的 cd 命令 </span></span><br><span class="line"><span class="built_in">enable</span>                             <span class="comment"># 列出所有 bash 内置命令，或禁止某命令 </span></span><br><span class="line"><span class="built_in">help</span> &#123;builtin_command&#125;             <span class="comment"># 查看内置命令的帮助（仅限 bash 内置命令）</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">eval</span> <span class="variable">$script</span>                       <span class="comment"># 对 script 变量中的字符串求值（执行）</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># 输出 / 输入 重定向 </span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line">cmd1 | cmd2                        <span class="comment"># 管道，cmd1 的标准输出接到 cmd2 的标准输入 </span></span><br><span class="line">&lt; file                             <span class="comment"># 将文件内容重定向为命令的标准输入 </span></span><br><span class="line">&gt; file                             <span class="comment"># 将命令的标准输出重定向到文件，会覆盖文件 </span></span><br><span class="line">&gt;&gt; file                            <span class="comment"># 将命令的标准输出重定向到文件，追加不覆盖 </span></span><br><span class="line">&gt;| file                            <span class="comment"># 强制输出到文件，即便设置过：set -o noclobber</span></span><br><span class="line">n&gt;| file                           <span class="comment"># 强制将文件描述符 n 的输出重定向到文件 </span></span><br><span class="line">&lt;&gt; file                            <span class="comment"># 同时使用该文件作为标准输入和标准输出 </span></span><br><span class="line">n&lt;&gt; file                           <span class="comment"># 同时使用文件作为文件描述符 n 的输出和输入 </span></span><br><span class="line">n&gt; file                            <span class="comment"># 重定向文件描述符 n 的输出到文件 </span></span><br><span class="line">n&lt; file                            <span class="comment"># 重定向文件描述符 n 的输入为文件内容 </span></span><br><span class="line">n&gt;&amp;                                <span class="comment"># 将标准输出 dup / 合并 到文件描述符 n</span></span><br><span class="line">n&lt;&amp;                                <span class="comment"># 将标准输入 dump / 合并 定向为描述符 n</span></span><br><span class="line">n&gt;&amp;m                               <span class="comment"># 文件描述符 n 被作为描述符 m 的副本，输出用 </span></span><br><span class="line">n&lt;&amp;m                               <span class="comment"># 文件描述符 n 被作为描述符 m 的副本，输入用 </span></span><br><span class="line">&amp;&gt;file                             <span class="comment"># 将标准输出和标准错误重定向到文件 </span></span><br><span class="line">&lt;&amp;-                                <span class="comment"># 关闭标准输入 </span></span><br><span class="line">&gt;&amp;-                                <span class="comment"># 关闭标准输出 </span></span><br><span class="line">n&gt;&amp;-                               <span class="comment"># 关闭作为输出的文件描述符 n</span></span><br><span class="line">n&lt;&amp;-                               <span class="comment"># 关闭作为输入的文件描述符 n</span></span><br><span class="line">diff &lt;(cmd1) &lt;(cmd2)               <span class="comment"># 比较两个命令的输出 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># 文本处理 - cut</span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line">cut -c 1-16                        <span class="comment"># 截取每行头 16 个字符 </span></span><br><span class="line">cut -c 1-16 file                   <span class="comment"># 截取指定文件中每行头 16 个字符 </span></span><br><span class="line">cut -c3-                           <span class="comment"># 截取每行从第三个字符开始到行末的内容 </span></span><br><span class="line">cut -d<span class="string">':'</span> -f5                      <span class="comment"># 截取用冒号分隔的第五列内容 </span></span><br><span class="line">cut -d<span class="string">';'</span> -f2,10                   <span class="comment"># 截取用分号分隔的第二和第十列内容 </span></span><br><span class="line">cut -d<span class="string">''</span> -f3-7                    <span class="comment"># 截取空格分隔的三到七列 </span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"hello"</span> | cut -c1-3           <span class="comment"># 显示 hel</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"hello sir"</span> | cut -d<span class="string">' '</span> -f2   <span class="comment"># 显示 sir</span></span><br><span class="line">ps | tr -s <span class="string">" "</span> | cut -d <span class="string">" "</span> -f 2,3,4  <span class="comment"># cut 搭配 tr 压缩字符 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># 文本处理 - awk / sed </span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line">awk <span class="string">'&#123;print $5&#125;'</span> file              <span class="comment"># 打印文件中以空格分隔的第五列 </span></span><br><span class="line">awk -F <span class="string">','</span> <span class="string">'&#123;print $5&#125;'</span> file       <span class="comment"># 打印文件中以逗号分隔的第五列 </span></span><br><span class="line">awk <span class="string">'/str/ &#123;print $2&#125;'</span> file        <span class="comment"># 打印文件中包含 str 的所有行的第二列 </span></span><br><span class="line">awk -F <span class="string">','</span> <span class="string">'&#123;print $NF&#125;'</span> file      <span class="comment"># 打印逗号分隔的文件中的每行最后一列 </span></span><br><span class="line">awk <span class="string">'&#123;s+=$1&#125; END &#123;print s&#125;'</span> file   <span class="comment"># 计算所有第一列的合 </span></span><br><span class="line">awk <span class="string">'NR%3==1'</span> file                 <span class="comment"># 从第一行开始，每隔三行打印一行 </span></span><br><span class="line"></span><br><span class="line">sed <span class="string">'s/find/replace/'</span> file         <span class="comment"># 替换文件中首次出现的字符串并输出结果 </span></span><br><span class="line">sed <span class="string">'10s/find/replace/'</span> file       <span class="comment"># 替换文件第 10 行内容 </span></span><br><span class="line">sed <span class="string">'10,20s/find/replace/'</span> file    <span class="comment"># 替换文件中 10-20 行内容 </span></span><br><span class="line">sed -r <span class="string">'s/regex/replace/g'</span> file    <span class="comment"># 替换文件中所有出现的字符串 </span></span><br><span class="line">sed -i <span class="string">'s/find/replace/g'</span> file     <span class="comment"># 替换文件中所有出现的字符并且覆盖文件 </span></span><br><span class="line">sed -i <span class="string">'/find/i\newline'</span> file      <span class="comment"># 在文件的匹配文本前插入行 </span></span><br><span class="line">sed -i <span class="string">'/find/a\newline'</span> file      <span class="comment"># 在文件的匹配文本后插入行 </span></span><br><span class="line">sed <span class="string">'/line/s/find/replace/'</span> file   <span class="comment"># 先搜索行特征再执行替换 </span></span><br><span class="line">sed -e <span class="string">'s/f/r/'</span> -e <span class="string">'s/f/r'</span> file    <span class="comment"># 执行多次替换 </span></span><br><span class="line">sed <span class="string">'s#find#replace#'</span> file         <span class="comment"># 使用 # 替换 / 来避免 pattern 中有斜杆 </span></span><br><span class="line">sed -i -r <span class="string">'s/^\s+//g'</span> file         <span class="comment"># 删除文件每行头部空格 </span></span><br><span class="line">sed <span class="string">'/^$/d'</span> file                   <span class="comment"># 删除文件空行并打印 </span></span><br><span class="line">sed -i <span class="string">'s/\s\+$//'</span> file            <span class="comment"># 删除文件每行末尾多余空格 </span></span><br><span class="line">sed -n <span class="string">'2p'</span> file                   <span class="comment"># 打印文件第二行 </span></span><br><span class="line">sed -n <span class="string">'2,5p'</span> file                 <span class="comment"># 打印文件第二到第五行 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># 排序 - sort</span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line">sort file                          <span class="comment"># 排序文件 </span></span><br><span class="line">sort -r file                       <span class="comment"># 反向排序（降序）</span></span><br><span class="line">sort -n file                       <span class="comment"># 使用数字而不是字符串进行比较 </span></span><br><span class="line">sort -t: -k 3n /etc/passwd         <span class="comment"># 按 passwd 文件的第三列进行排序 </span></span><br><span class="line">sort -u file                       <span class="comment"># 去重排序 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># 快速跳转 - https://github.com/rupa/z</span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> /path/to/z.sh               <span class="comment"># .bashrc 中初始化 z.sh</span></span><br><span class="line">z                                  <span class="comment"># 列出所有历史路径以及他们的权重 </span></span><br><span class="line">z foo                              <span class="comment"># 跳到历史路径中匹配 foo 的权重最大的目录 </span></span><br><span class="line">z foo bar                          <span class="comment"># 跳到历史路径中匹配 foo 和 bar 权重最大的目录 </span></span><br><span class="line">z -l foo                           <span class="comment"># 列出所有历史路径中匹配 foo 的目录及权重 </span></span><br><span class="line">z -r foo                           <span class="comment"># 按照最高访问次数优先进行匹配跳转 </span></span><br><span class="line">z -t foo                           <span class="comment"># 按照最近访问优先进行匹配跳转 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># 键盘绑定 </span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">bind</span> <span class="string">'"\eh":"\C-b"'</span>                <span class="comment"># 绑定 ALT+h 为光标左移，同 CTRL+b / &lt;Left&gt;</span></span><br><span class="line"><span class="built_in">bind</span> <span class="string">'"\el":"\C-f"'</span>                <span class="comment"># 绑定 ALT+l 为光标右移，同 CTRL+f / &lt;Right&gt;</span></span><br><span class="line"><span class="built_in">bind</span> <span class="string">'"\ej":"\C-n"'</span>                <span class="comment"># 绑定 ALT+j 为下条历史，同 CTRL+n / &lt;Down&gt;</span></span><br><span class="line"><span class="built_in">bind</span> <span class="string">'"\ek":"\C-p"'</span>                <span class="comment"># 绑定 ALT+k 为上条历史，同 CTRL+p / &lt;Up&gt;</span></span><br><span class="line"><span class="built_in">bind</span> <span class="string">'"\eH":"\eb"'</span>                 <span class="comment"># 绑定 ALT+H 为光标左移一个单词，同 ALT-b </span></span><br><span class="line"><span class="built_in">bind</span> <span class="string">'"\eL":"\ef"'</span>                 <span class="comment"># 绑定 ALT+L 为光标右移一个单词，同 ALT-f </span></span><br><span class="line"><span class="built_in">bind</span> <span class="string">'"\eJ":"\C-a"'</span>                <span class="comment"># 绑定 ALT+J 为移动到行首，同 CTRL+a / &lt;Home&gt;</span></span><br><span class="line"><span class="built_in">bind</span> <span class="string">'"\eK":"\C-e"'</span>                <span class="comment"># 绑定 ALT+K 为移动到行末，同 CTRL+e / &lt;End&gt;</span></span><br><span class="line"><span class="built_in">bind</span> <span class="string">'"\e;":"ls -l\n"'</span>             <span class="comment"># 绑定 ALT+; 为执行 ls -l 命令 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># 网络管理：ip / ifconfig / nmap ...</span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line">ip a                               <span class="comment"># 显示所有网络地址，同 ip address</span></span><br><span class="line">ip a show eth1                     <span class="comment"># 显示网卡 IP 地址 </span></span><br><span class="line">ip a add 172.16.1.23/24 dev eth1   <span class="comment"># 添加网卡 IP 地址 </span></span><br><span class="line">ip a del 172.16.1.23/24 dev eth1   <span class="comment"># 删除网卡 IP 地址 </span></span><br><span class="line">ip link show dev eth0              <span class="comment"># 显示网卡设备属性 </span></span><br><span class="line">ip link <span class="built_in">set</span> eth1 up                <span class="comment"># 激活网卡 </span></span><br><span class="line">ip link <span class="built_in">set</span> eth1 down              <span class="comment"># 关闭网卡 </span></span><br><span class="line">ip link <span class="built_in">set</span> eth1 address &#123;mac&#125;     <span class="comment"># 修改 MAC 地址 </span></span><br><span class="line">ip neighbour                       <span class="comment"># 查看 ARP 缓存 </span></span><br><span class="line">ip route                           <span class="comment"># 查看路由表 </span></span><br><span class="line">ip route add 10.1.0.0/24 via 10.0.0.253 dev eth0    <span class="comment"># 添加静态路由 </span></span><br><span class="line">ip route del 10.1.0.0/24           <span class="comment"># 删除静态路由 </span></span><br><span class="line"></span><br><span class="line">ifconfig                           <span class="comment"># 显示所有网卡和接口信息 </span></span><br><span class="line">ifconfig -a                        <span class="comment"># 显示所有网卡（包括开机没启动的）信息 </span></span><br><span class="line">ifconfig eth0                      <span class="comment"># 指定设备显示信息 </span></span><br><span class="line">ifconfig eth0 up                   <span class="comment"># 激活网卡 </span></span><br><span class="line">ifconfig eth0 down                 <span class="comment"># 关闭网卡 </span></span><br><span class="line">ifconfig eth0 192.168.120.56       <span class="comment"># 给网卡配置 IP 地址 </span></span><br><span class="line">ifconfig eth0 10.0.0.8 netmask 255.255.255.0 up     <span class="comment"># 配置 IP 并启动 </span></span><br><span class="line">ifconfig eth0 hw ether 00:aa:bb:cc:dd:ee            <span class="comment"># 修改 MAC 地址 </span></span><br><span class="line"></span><br><span class="line">nmap 10.0.0.12                     <span class="comment"># 扫描主机 1-1000 端口 </span></span><br><span class="line">nmap -p 1024-65535 10.0.0.12       <span class="comment"># 扫描给定端口 </span></span><br><span class="line">nmap 10.0.0.0/24                   <span class="comment"># 给定网段扫描局域网内所有主机 </span></span><br><span class="line">nmap -O -sV 10.0.0.12              <span class="comment"># 探测主机服务和操作系统版本 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># 有趣的命令 </span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line">man hier                           <span class="comment"># 查看文件系统的结构和含义 </span></span><br><span class="line">man <span class="built_in">test</span>                           <span class="comment"># 查看 posix sh 的条件判断帮助 </span></span><br><span class="line">man ascii                          <span class="comment"># 显示 ascii 表 </span></span><br><span class="line">getconf LONG_BIT                   <span class="comment"># 查看系统是 32 位还是 64 位 </span></span><br><span class="line"><span class="built_in">bind</span> -P                            <span class="comment"># 列出所有 bash 的快捷键 </span></span><br><span class="line">mount | column -t                  <span class="comment"># 漂亮的列出当前加载的文件系统 </span></span><br><span class="line">curl ip.cn                         <span class="comment"># 取得外网 ip 地址和服务商信息 </span></span><br><span class="line"><span class="built_in">disown</span> -a &amp;&amp; <span class="built_in">exit</span>                  <span class="comment"># 关闭所有后台任务并退出 </span></span><br><span class="line">cat /etc/issue                     <span class="comment"># 查看 Linux 发行版信息 </span></span><br><span class="line">lsof -i port:80                    <span class="comment"># 哪个程序在使用 80 端口？</span></span><br><span class="line">showkey -a                         <span class="comment"># 取得按键的 ASCII 码 </span></span><br><span class="line">svn diff | view -                  <span class="comment"># 使用 Vim 来显示带色彩的 diff 输出 </span></span><br><span class="line">mv filename.&#123;old,new&#125;              <span class="comment"># 快速文件改名 </span></span><br><span class="line">time <span class="built_in">read</span>                          <span class="comment"># 使用 CTRL-D 停止，最简单的计时功能 </span></span><br><span class="line">cp file.txt&#123;,.bak&#125;                 <span class="comment"># 快速备份文件 </span></span><br><span class="line">sudo touch /forcefsck              <span class="comment"># 强制在下次重启时扫描磁盘 </span></span><br><span class="line">find ~ -mmin 60 -<span class="built_in">type</span> f            <span class="comment"># 查找 $HOME 目录中，60 分钟内修改过的文件 </span></span><br><span class="line">curl wttr.in/~beijing              <span class="comment"># 查看北京的天气预报 </span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;SSH_CLIENT%% *&#125;</span>             <span class="comment"># 取得你是从什么 IP 链接到当前主机上的 </span></span><br><span class="line"><span class="built_in">echo</span> $[RANDOM%X+1]                 <span class="comment"># 取得 1 到 X 之间的随机数 </span></span><br><span class="line"><span class="built_in">bind</span> -x <span class="string">'"\C-l":ls -l'</span>             <span class="comment"># 设置 CTRL+l 为执行 ls -l 命令 </span></span><br><span class="line">find / -<span class="built_in">type</span> f -size +5M           <span class="comment"># 查找大于 5M 的文件 </span></span><br><span class="line">chmod --reference f1 f2            <span class="comment"># 将 f2 的权限设置成 f1 一模一样的 </span></span><br><span class="line">curl -L cheat.sh                   <span class="comment"># 速查表大全 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># 常用技巧 </span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出最常使用的命令 </span></span><br><span class="line"><span class="built_in">history</span> | awk <span class="string">'&#123;a[$2]++&#125;END&#123;for(i in a)&#123;print a[i]" "i&#125;&#125;'</span> | sort -rn | head</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出所有网络状态：ESTABLISHED / TIME_WAIT / FIN_WAIT1 / FIN_WAIT2 </span></span><br><span class="line">netstat -n | awk <span class="string">'/^tcp/ &#123;++tt[$NF]&#125; END &#123;for (a in tt) print a, tt[a]&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过 SSH 来 mount 文件系统 </span></span><br><span class="line">sshfs name@server:/path/to/folder /path/to/mount/point</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示前十个运行的进程并按内存使用量排序 </span></span><br><span class="line">ps aux | sort -nk +4 | tail</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在右上角显示时钟 </span></span><br><span class="line"><span class="keyword">while</span> sleep 1;<span class="keyword">do</span> tput sc;tput cup 0 $(($(tput cols)-29));date;tput rc;<span class="keyword">done</span>&amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从网络上的压缩文件中解出一个文件来，并避免保存中间文件 </span></span><br><span class="line">wget -qO - <span class="string">"http://www.tarball.com/tarball.gz"</span> | tar zxvf -</span><br><span class="line"></span><br><span class="line"><span class="comment"># 性能测试：测试处理器性能 </span></span><br><span class="line">python -c <span class="string">"import test.pystone;print(test.pystone.pystones())"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 性能测试：测试内存带宽 </span></span><br><span class="line">dd <span class="keyword">if</span>=/dev/zero of=/dev/null bs=1M count=32768</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux 下挂载一个 iso 文件 </span></span><br><span class="line">mount /path/to/file.iso /mnt/cdrom -oloop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过主机 A 直接 ssh 到主机 B</span></span><br><span class="line">ssh -t hostA ssh hostB</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载一个网站的所有图片 </span></span><br><span class="line">wget -r -l1 --no-parent -nH -nd -P/tmp -A<span class="string">".gif,.jpg"</span> http://example.com/images</span><br><span class="line"></span><br><span class="line"><span class="comment"># 快速创建项目目录 </span></span><br><span class="line">mkdir -p work/&#123;project1,project2&#125;/&#123;src,bin,bak&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按日期范围查找文件 </span></span><br><span class="line">find . -<span class="built_in">type</span> f -newermt <span class="string">"2010-01-01"</span> ! -newermt <span class="string">"2010-06-01"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示当前正在使用网络的进程 </span></span><br><span class="line">lsof -P -i -n | cut -f 1 -d <span class="string">""</span>| uniq | tail -n +2</span><br><span class="line"></span><br><span class="line"><span class="comment"># Vim 中保存一个没有权限的文件 </span></span><br><span class="line">:w !sudo tee &gt; /dev/null %</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 .bashrc / .bash_profile 中加载另外一个文件（比如你保存在 github 上的配置）</span></span><br><span class="line"><span class="built_in">source</span> ~/github/profiles/my_bash_init.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 反向代理：将外网主机（202.115.8.1）端口（8443）转发到内网主机 192.168.1.2:443</span></span><br><span class="line">ssh -CqTnN -R 0.0.0.0:8443:192.168.1.2:443  user@202.115.8.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 正向代理：将本地主机的 8443 端口，通过 192.168.1.3 转发到 192.168.1.2:443 </span></span><br><span class="line">ssh -CqTnN -L 0.0.0.0:8443:192.168.1.2:443  user@192.168.1.3</span><br><span class="line"></span><br><span class="line"><span class="comment"># socks5 代理：把本地 1080 端口的 socks5 的代理请求通过远程主机转发出去 </span></span><br><span class="line">ssh -CqTnN -D localhost:1080  user@202.115.8.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 终端下正确设置 ALT 键和 BackSpace 键 </span></span><br><span class="line">http://www.skywind.me/blog/archives/2021</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># 有用的函数 </span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自动解压：判断文件后缀名并调用相应解压命令 </span></span><br><span class="line"><span class="keyword">function</span> q-<span class="function"><span class="title">extract</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> [ -f <span class="variable">$1</span> ] ; <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">        *.tar.bz2)   tar -xvjf <span class="variable">$1</span>    ;;</span><br><span class="line">        *.tar.gz)    tar -xvzf <span class="variable">$1</span>    ;;</span><br><span class="line">        *.tar.xz)    tar -xvJf <span class="variable">$1</span>    ;;</span><br><span class="line">        *.bz2)       bunzip2 <span class="variable">$1</span>     ;;</span><br><span class="line">        *.rar)       rar x <span class="variable">$1</span>       ;;</span><br><span class="line">        *.gz)        gunzip <span class="variable">$1</span>      ;;</span><br><span class="line">        *.tar)       tar -xvf <span class="variable">$1</span>     ;;</span><br><span class="line">        *.tbz2)      tar -xvjf <span class="variable">$1</span>    ;;</span><br><span class="line">        *.tgz)       tar -xvzf <span class="variable">$1</span>    ;;</span><br><span class="line">        *.zip)       unzip <span class="variable">$1</span>       ;;</span><br><span class="line">        *.Z)         uncompress <span class="variable">$1</span>  ;;</span><br><span class="line">        *.7z)        7z x <span class="variable">$1</span>        ;;</span><br><span class="line">        *)           <span class="built_in">echo</span> <span class="string">"don't know how to extract'<span class="variable">$1</span>'..."</span> ;;</span><br><span class="line">        <span class="keyword">esac</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"'<span class="variable">$1</span>' is not a valid file!"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自动压缩：判断后缀名并调用相应压缩程序 </span></span><br><span class="line"><span class="keyword">function</span> q-<span class="function"><span class="title">compress</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$1</span>"</span> ] ; <span class="keyword">then</span></span><br><span class="line">        FILE=<span class="variable">$1</span></span><br><span class="line">        <span class="keyword">case</span> <span class="variable">$FILE</span> <span class="keyword">in</span></span><br><span class="line">        *.tar) <span class="built_in">shift</span> &amp;&amp; tar -cf <span class="variable">$FILE</span> $* ;;</span><br><span class="line">        *.tar.bz2) <span class="built_in">shift</span> &amp;&amp; tar -cjf <span class="variable">$FILE</span> $* ;;</span><br><span class="line">        *.tar.xz) <span class="built_in">shift</span> &amp;&amp; tar -cJf <span class="variable">$FILE</span> $* ;;</span><br><span class="line">        *.tar.gz) <span class="built_in">shift</span> &amp;&amp; tar -czf <span class="variable">$FILE</span> $* ;;</span><br><span class="line">        *.tgz) <span class="built_in">shift</span> &amp;&amp; tar -czf <span class="variable">$FILE</span> $* ;;</span><br><span class="line">        *.zip) <span class="built_in">shift</span> &amp;&amp; zip <span class="variable">$FILE</span> $* ;;</span><br><span class="line">        *.rar) <span class="built_in">shift</span> &amp;&amp; rar <span class="variable">$FILE</span> $* ;;</span><br><span class="line">        <span class="keyword">esac</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"usage: q-compress &lt;foo.tar.gz&gt; ./foo ./bar"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 漂亮的带语法高亮的 color cat ，需要先 pip install pygments</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">ccat</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> style=<span class="string">"monokai"</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$#</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        pygmentize -P style=<span class="variable">$style</span> -P tabsize=4 -f terminal256 -g</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">for</span> NAME <span class="keyword">in</span> <span class="variable">$@</span>; <span class="keyword">do</span></span><br><span class="line">            pygmentize -P style=<span class="variable">$style</span> -P tabsize=4 -f terminal256 -g <span class="string">"<span class="variable">$NAME</span>"</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># 好玩的配置 </span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 放到你的 ~/.bashrc 配置文件中，给 man 增加漂亮的色彩高亮 </span></span><br><span class="line"><span class="built_in">export</span> LESS_TERMCAP_mb=$<span class="string">'\E[1m\E[32m'</span></span><br><span class="line"><span class="built_in">export</span> LESS_TERMCAP_mh=$<span class="string">'\E[2m'</span></span><br><span class="line"><span class="built_in">export</span> LESS_TERMCAP_mr=$<span class="string">'\E[7m'</span></span><br><span class="line"><span class="built_in">export</span> LESS_TERMCAP_md=$<span class="string">'\E[1m\E[36m'</span></span><br><span class="line"><span class="built_in">export</span> LESS_TERMCAP_ZW=<span class="string">""</span></span><br><span class="line"><span class="built_in">export</span> LESS_TERMCAP_us=$<span class="string">'\E[4m\E[1m\E[37m'</span></span><br><span class="line"><span class="built_in">export</span> LESS_TERMCAP_me=$<span class="string">'\E(B\E[m'</span></span><br><span class="line"><span class="built_in">export</span> LESS_TERMCAP_ue=$<span class="string">'\E[24m\E(B\E[m'</span></span><br><span class="line"><span class="built_in">export</span> LESS_TERMCAP_ZO=<span class="string">""</span></span><br><span class="line"><span class="built_in">export</span> LESS_TERMCAP_ZN=<span class="string">""</span></span><br><span class="line"><span class="built_in">export</span> LESS_TERMCAP_se=$<span class="string">'\E[27m\E(B\E[m'</span></span><br><span class="line"><span class="built_in">export</span> LESS_TERMCAP_ZV=<span class="string">""</span></span><br><span class="line"><span class="built_in">export</span> LESS_TERMCAP_so=$<span class="string">'\E[1m\E[33m\E[44m'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ALT+hjkl/HJKL 快速移动光标，将下面内容添加到 ~/.inputrc 中可作用所有工具，</span></span><br><span class="line"><span class="comment"># 包括 bash/zsh/python/lua 等使用 readline 的工具，帮助见：info rluserman</span></span><br><span class="line"><span class="string">"\eh"</span>: backward-char</span><br><span class="line"><span class="string">"\el"</span>: forward-char</span><br><span class="line"><span class="string">"\ej"</span>: next-history</span><br><span class="line"><span class="string">"\ek"</span>: previous-history</span><br><span class="line"><span class="string">"\eH"</span>: backward-word</span><br><span class="line"><span class="string">"\eL"</span>: forward-word</span><br><span class="line"><span class="string">"\eJ"</span>: beginning-of-line</span><br><span class="line"><span class="string">"\eK"</span>: end-of-line</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># References</span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line">https://github.com/Idnan/bash-guide</span><br><span class="line">http://www.linuxstall.com/linux-command-line-tips-that-every-linux-user-should-know/</span><br><span class="line">https://ss64.com/bash/syntax-keyboard.html</span><br><span class="line">http://wiki.bash-hackers.org/commands/classictest</span><br><span class="line">https://www.ibm.com/developerworks/library/l-bash-test/index.html</span><br><span class="line">https://www.cyberciti.biz/faq/bash-loop-over-file/</span><br><span class="line">https://linuxconfig.org/bash-scripting-tutorial</span><br><span class="line">https://github.com/LeCoupa/awesome-cheatsheets/blob/master/languages/bash.sh</span><br><span class="line">https://devhints.io/bash</span><br><span class="line">https://github.com/jlevy/the-art-of-command-line</span><br><span class="line">https://yq.aliyun.com/articles/68541</span><br><span class="line"></span><br><span class="line"><span class="comment"># vim: set ts=4 sw=4 tw=0 et :</span></span><br></pre></td></tr></table></figure><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://github.com/skywind3000/awesome-cheatsheets/blob/master/languages/bash.sh" target="_blank" rel="noopener">Bash awesome-cheatsheets</a></p><p><a href="https://github.com/OMGZui/bash-step-to-step" target="_blank" rel="noopener">bash-step-to-step</a></p><p><a href="http://sayhiai.com/15614525129972.html" target="_blank" rel="noopener">Linux 上，最常用的一批命令解析（10 年精选）</a></p>]]></content>
    
    <summary type="html">
    
      Bash命令语法和Bash Cheat Sheet中文速查表
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>基于 Keepalived 搭建 Zabbix Server HA 双机高可用</title>
    <link href="https://wsgzao.github.io/post/zabbix-ha/"/>
    <id>https://wsgzao.github.io/post/zabbix-ha/</id>
    <published>2019-10-24T06:59:49.000Z</published>
    <updated>2019-10-30T06:23:54.317Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>之前使用 Zabbix 被动模式存在单点风险，借助这次 Zabbix 4.0 LTS 主动模式改造的机会，使用 Keepalived 搭建 Zabbix Server HA 双击高可用架构，简单记录下做 HA 的过程以备参考。</p><blockquote><p>基于 Keepalived 搭建 Zabbix Server HA 双机高可用</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 10 月 24 日 - 更新 Zabbix 本地数据库迁移至远程数据库集群的调整步骤<br>2019 年 03 月 02 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/zabbix-ha/">https://wsgzao.github.io/post/zabbix-ha/</a></p><p><strong> 扩展阅读 </strong></p><p>Zabbix - <a href="https://www.zabbix.com/" target="_blank" rel="noopener">https://www.zabbix.com/</a></p><hr><h2 id="Zabbix-高可用设计目标"><a href="#Zabbix-高可用设计目标" class="headerlink" title="Zabbix 高可用设计目标"></a>Zabbix 高可用设计目标</h2><p>keepalived 服务优先级选择切换机制：对于 zabbix 服务器来说，只要 zabbix 存活和 mysql 存活，就能够正常记录数据，不会丢失数据，php 和 httpd 只是 web 页面的访问而已，所以我在这里定义 mysql 和 zabbix 为主要服务，php 和 httpd 为次要服务，为了实现主要服务存在，次要服务挂了；次要服务器存在，主要服务器挂了，keepalived 会优先选择主要服务存在的一方作为 master，让 keepalived 切换更为更合理。</p><p>数据库主主同步：不管切到哪一边都需要保持数据一致性，不可出现丢数据或者数据重复，保证数据库的高可用。</p><p>文件双向同步：        </p><ol><li>web 文件同步：任何做 web 文件得配置和修改，保证两边一致，确保切换不会发生任何变化。        </li><li>zabbix 服务文件同步：对 zabbix_servr 的配置文件做的任何修改，和脚本的修改进行同步，也是为了保证两边的服务一致性，没有落后情况，达到无需人工干预自动切换服务可正常时候。        </li><li>到此完成了 zabbix 得无缝切换，无故障时间！</li></ol><h2 id="Zabbix-Server"><a href="#Zabbix-Server" class="headerlink" title="Zabbix Server"></a>Zabbix Server</h2><blockquote><p>基于官方的 LAMP 架构，按照最简单的原生方式来部署 Zabbix 4.0 LTS，不做任何多余优化</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装必要依赖包 </span></span><br><span class="line">yum install -y httpd mariadb-server mariadb php php-mysql php-gd libjpeg* php-ldap php-odbc php-pear php-xml php-xmlrpc php-mhash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 apache 配置 </span></span><br><span class="line">vim /etc/httpd/conf/httpd.conf</span><br><span class="line">ServerName 192.168.56.103</span><br><span class="line">DirectoryIndex index.html index.php</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 php 时区 </span></span><br><span class="line">vim /etc/php.ini</span><br><span class="line">date.timezone = Asia/Singapore</span><br><span class="line">memory_limit = 512M</span><br><span class="line"></span><br><span class="line"><span class="comment"># 优化 php 参数 (可选，建议 memory_limit 根据内存值调高)</span></span><br><span class="line">sed -i <span class="string">'s/post_max_size = 8M/post_max_size = 32M/g'</span> /etc/php.ini</span><br><span class="line">sed -i <span class="string">'s/upload_max_filesize = 2M/upload_max_filesize = 50M/g'</span> /etc/php.ini</span><br><span class="line">sed -i <span class="string">'s/\;date.timezone =/date.timezone = Asia\/Singapore/'</span> /etc/php.ini</span><br><span class="line">sed -i <span class="string">'s/max_execution_time = 30/max_execution_time = 600/g'</span> /etc/php.ini</span><br><span class="line">sed -i <span class="string">'s/max_input_time = 60/max_input_time = 600/g'</span> /etc/php.ini</span><br><span class="line">sed -i <span class="string">'s/memory_limit = 128M/memory_limit = 512M/g'</span> /etc/php.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 httpd 服务 </span></span><br><span class="line">systemctl start httpd.service</span><br><span class="line"><span class="comment"># 启动 mariadb 服务 </span></span><br><span class="line">systemctl start mariadb.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化 mysql 数据库，并配置 root 用户密码 </span></span><br><span class="line">mysql_secure_installation</span><br><span class="line"></span><br><span class="line"><span class="comment"># 万一新版本忘记随机密码可以通过日志获取 </span></span><br><span class="line">grep <span class="string">'temporary password'</span> /var/<span class="built_in">log</span>/mysqld.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个测试页，测试 LAMP 是否搭建成功 </span></span><br><span class="line">cat &gt; /var/www/html/index.php &lt;&lt; EOF</span><br><span class="line">&lt;?php</span><br><span class="line">phpinfo();</span><br><span class="line">?&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 zabbix 数据库 </span></span><br><span class="line">mysql -uroot -p</span><br><span class="line"></span><br><span class="line">mysql&gt; create database zabbix character <span class="built_in">set</span> utf8 collate utf8_bin;</span><br><span class="line">mysql&gt; grant all privileges on zabbix.* to zabbix@localhost identified by <span class="string">'zabbix'</span>;</span><br><span class="line">mysql&gt; quit;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署 zabbix</span></span><br><span class="line">rpm -Uvh https://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-2.el7.noarch.rpm</span><br><span class="line">yum clean all</span><br><span class="line">yum -y install zabbix-server-mysql zabbix-web-mysql zabbix-agent</span><br><span class="line">zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz | mysql -uzabbix -p zabbix</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据库用户及密码 </span></span><br><span class="line">vim /etc/zabbix/zabbix_server.conf</span><br><span class="line">DBPassword=zabbix</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改时区和参数优化 </span></span><br><span class="line">vim /etc/httpd/conf.d/zabbix.conf</span><br><span class="line">php_value date.timezone Asia/Singapore</span><br><span class="line">php_value memory_limit 512M</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 zabbix 并设置自启动服务 </span></span><br><span class="line">systemctl restart zabbix-server zabbix-agent httpd</span><br><span class="line">systemctl <span class="built_in">enable</span> zabbix-server zabbix-agent httpd mariadb</span><br><span class="line"></span><br><span class="line">http://localhost/zabbix</span><br><span class="line">Admin/zabbix</span><br></pre></td></tr></table></figure><h2 id="Zabbix-配置优化"><a href="#Zabbix-配置优化" class="headerlink" title="Zabbix 配置优化"></a>Zabbix 配置优化</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Zabbix 默认原始配置 </span></span><br><span class="line">grep -Ev <span class="string">'^$|#'</span> /etc/zabbix/zabbix_server.conf</span><br><span class="line">LogFile=/var/<span class="built_in">log</span>/zabbix/zabbix_server.log</span><br><span class="line">LogFileSize=0</span><br><span class="line">PidFile=/var/run/zabbix/zabbix_server.pid</span><br><span class="line">SocketDir=/var/run/zabbix</span><br><span class="line">DBName=zabbix</span><br><span class="line">DBUser=zabbix</span><br><span class="line">DBPassword=zabbix</span><br><span class="line">SNMPTrapperFile=/var/<span class="built_in">log</span>/snmptrap/snmptrap.log</span><br><span class="line">Timeout=4</span><br><span class="line">AlertScriptsPath=/usr/lib/zabbix/alertscripts</span><br><span class="line">ExternalScripts=/usr/lib/zabbix/externalscripts</span><br><span class="line">LogSlowQueries=3000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 zabbix_server.conf，通常可以追加在末尾 </span></span><br><span class="line">CacheSize=8G</span><br><span class="line">TrendCacheSize=2G</span><br><span class="line">Timeout=30</span><br><span class="line">StartPollers=500</span><br><span class="line">StartPollersUnreachable=100</span><br><span class="line">StartPingers=50</span><br><span class="line">HousekeepingFrequency=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果服务器性能很好可以继续向上调整参数 </span></span><br><span class="line">LogFile=/var/<span class="built_in">log</span>/zabbix/zabbix_server.log</span><br><span class="line">LogFileSize=0</span><br><span class="line">PidFile=/var/run/zabbix/zabbix_server.pid</span><br><span class="line">SocketDir=/var/run/zabbix</span><br><span class="line">DBName=zabbix</span><br><span class="line">DBUser=zabbix</span><br><span class="line">DBPassword=zabbix</span><br><span class="line">StartPollers=700</span><br><span class="line">StartPreprocessors=100</span><br><span class="line">StartPollersUnreachable=500</span><br><span class="line">StartTrappers=200</span><br><span class="line">StartPingers=500</span><br><span class="line">StartDiscoverers=100</span><br><span class="line">SNMPTrapperFile=/var/<span class="built_in">log</span>/snmptrap/snmptrap.log</span><br><span class="line">CacheSize=8G</span><br><span class="line">StartDBSyncers=64</span><br><span class="line">HistoryCacheSize=2G</span><br><span class="line">HistoryIndexCacheSize=2G</span><br><span class="line">TrendCacheSize=2G</span><br><span class="line">ValueCacheSize=2G</span><br><span class="line">Timeout=30</span><br><span class="line">AlertScriptsPath=/usr/lib/zabbix/alertscripts</span><br><span class="line">ExternalScripts=/usr/lib/zabbix/externalscripts</span><br><span class="line">LogSlowQueries=3000</span><br></pre></td></tr></table></figure><h2 id="数据库配置优化"><a href="#数据库配置优化" class="headerlink" title="数据库配置优化"></a>数据库配置优化</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">grep -Ev <span class="string">'^$|#'</span> /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">symbolic-links=0</span><br><span class="line">max_connections=1000</span><br><span class="line">[mysqld_safe]</span><br><span class="line"><span class="built_in">log</span>-error=/var/<span class="built_in">log</span>/mariadb/mariadb.log</span><br><span class="line">pid-file=/var/run/mariadb/mariadb.pid</span><br><span class="line">!includedir /etc/my.cnf.d</span><br></pre></td></tr></table></figure><h2 id="Zabbix-Partition-分区表优化"><a href="#Zabbix-Partition-分区表优化" class="headerlink" title="Zabbix Partition 分区表优化"></a>Zabbix Partition 分区表优化</h2><blockquote><p>Zabbix &gt;= 3.2, history 30, Trends 120,(‘history’, 30, 24, 14), 最多保存 30 天的数据，每隔 24 小时生成一个分区，每次生成 14 个分区</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> <span class="string">`partition_create`</span>(SCHEMANAME <span class="built_in">varchar</span>(<span class="number">64</span>), TABLENAME <span class="built_in">varchar</span>(<span class="number">64</span>), PARTITIONNAME <span class="built_in">varchar</span>(<span class="number">64</span>), CLOCK <span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">           SCHEMANAME = The DB schema in which to make changes</span></span><br><span class="line"><span class="comment">           TABLENAME = The table with partitions to potentially delete</span></span><br><span class="line"><span class="comment">           PARTITIONNAME = The name of the partition to create</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">           Verify that the partition does not already exist</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">DECLARE</span> RETROWS <span class="built_in">INT</span>;</span><br><span class="line">        <span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(<span class="number">1</span>) <span class="keyword">INTO</span> RETROWS</span><br><span class="line">        <span class="keyword">FROM</span> information_schema.partitions</span><br><span class="line">        <span class="keyword">WHERE</span> table_schema = SCHEMANAME <span class="keyword">AND</span> table_name = TABLENAME <span class="keyword">AND</span> partition_description &gt;= CLOCK;</span><br><span class="line"></span><br><span class="line">        IF RETROWS = 0 THEN</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                   1. Print a message indicating that a partition was created.</span></span><br><span class="line"><span class="comment">                   2. Create the SQL to create the partition.</span></span><br><span class="line"><span class="comment">                   3. Execute the SQL from #2.</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="keyword">SELECT</span> <span class="keyword">CONCAT</span>( <span class="string">"partition_create("</span>, SCHEMANAME, <span class="string">","</span>, TABLENAME, <span class="string">","</span>, PARTITIONNAME, <span class="string">","</span>, CLOCK, <span class="string">")"</span> ) <span class="keyword">AS</span> msg;</span><br><span class="line">                <span class="keyword">SET</span> @<span class="keyword">sql</span> = <span class="keyword">CONCAT</span>( <span class="string">'ALTER TABLE'</span>, SCHEMANAME, <span class="string">'.'</span>, TABLENAME, <span class="string">'ADD PARTITION (PARTITION'</span>, PARTITIONNAME, <span class="string">'VALUES LESS THAN ('</span>, CLOCK, <span class="string">'));'</span> );</span><br><span class="line">                <span class="keyword">PREPARE</span> STMT <span class="keyword">FROM</span> @<span class="keyword">sql</span>;</span><br><span class="line">                <span class="keyword">EXECUTE</span> STMT;</span><br><span class="line">                <span class="keyword">DEALLOCATE</span> <span class="keyword">PREPARE</span> STMT;</span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line">DELIMITER ;</span><br><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> <span class="string">`partition_drop`</span>(SCHEMANAME <span class="built_in">VARCHAR</span>(<span class="number">64</span>), TABLENAME <span class="built_in">VARCHAR</span>(<span class="number">64</span>), DELETE_BELOW_PARTITION_DATE <span class="built_in">BIGINT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">           SCHEMANAME = The DB schema in which to make changes</span></span><br><span class="line"><span class="comment">           TABLENAME = The table with partitions to potentially delete</span></span><br><span class="line"><span class="comment">           DELETE_BELOW_PARTITION_DATE = Delete any partitions with names that are dates older than this one (yyyy-mm-dd)</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">DECLARE</span> done <span class="built_in">INT</span> <span class="keyword">DEFAULT</span> <span class="literal">FALSE</span>;</span><br><span class="line">        <span class="keyword">DECLARE</span> drop_part_name <span class="built_in">VARCHAR</span>(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">           Get a list of all the partitions that are older than the date</span></span><br><span class="line"><span class="comment">           in DELETE_BELOW_PARTITION_DATE.  All partitions are prefixed with</span></span><br><span class="line"><span class="comment">           a "p", so use SUBSTRING TO get rid of that character.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">DECLARE</span> myCursor <span class="keyword">CURSOR</span> <span class="keyword">FOR</span></span><br><span class="line">                <span class="keyword">SELECT</span> partition_name</span><br><span class="line">                <span class="keyword">FROM</span> information_schema.partitions</span><br><span class="line">                <span class="keyword">WHERE</span> table_schema = SCHEMANAME <span class="keyword">AND</span> table_name = TABLENAME <span class="keyword">AND</span> <span class="keyword">CAST</span>(<span class="keyword">SUBSTRING</span>(partition_name <span class="keyword">FROM</span> <span class="number">2</span>) <span class="keyword">AS</span> <span class="keyword">UNSIGNED</span>) &lt; DELETE_BELOW_PARTITION_DATE;</span><br><span class="line">        <span class="keyword">DECLARE</span> CONTINUE <span class="keyword">HANDLER</span> <span class="keyword">FOR</span> <span class="keyword">NOT</span> <span class="keyword">FOUND</span> <span class="keyword">SET</span> done = <span class="literal">TRUE</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">           Create the basics for when we need to drop the partition.  Also, create</span></span><br><span class="line"><span class="comment">           @drop_partitions to hold a comma-delimited list of all partitions that</span></span><br><span class="line"><span class="comment">           should be deleted.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">SET</span> @alter_header = <span class="keyword">CONCAT</span>(<span class="string">"ALTER TABLE"</span>, SCHEMANAME, <span class="string">"."</span>, TABLENAME, <span class="string">"DROP PARTITION"</span>);</span><br><span class="line">        <span class="keyword">SET</span> @drop_partitions = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">           Start looping through all the partitions that are too old.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        OPEN myCursor;</span><br><span class="line">        read_loop: LOOP</span><br><span class="line">                FETCH myCursor INTO drop_part_name;</span><br><span class="line">                IF done THEN</span><br><span class="line">                        LEAVE read_loop;</span><br><span class="line">                <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line">                <span class="keyword">SET</span> @drop_partitions = <span class="keyword">IF</span>(@drop_partitions = <span class="string">""</span>, drop_part_name, <span class="keyword">CONCAT</span>(@drop_partitions, <span class="string">","</span>, drop_part_name));</span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">LOOP</span>;</span><br><span class="line">        IF @drop_partitions != ""THEN</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                   1. Build the SQL to drop all the necessary partitions.</span></span><br><span class="line"><span class="comment">                   2. Run the SQL to drop the partitions.</span></span><br><span class="line"><span class="comment">                   3. Print out the table partitions that were deleted.</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="keyword">SET</span> @full_sql = <span class="keyword">CONCAT</span>(@alter_header, @drop_partitions, <span class="string">";"</span>);</span><br><span class="line">                <span class="keyword">PREPARE</span> STMT <span class="keyword">FROM</span> @full_sql;</span><br><span class="line">                <span class="keyword">EXECUTE</span> STMT;</span><br><span class="line">                <span class="keyword">DEALLOCATE</span> <span class="keyword">PREPARE</span> STMT;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">SELECT</span> <span class="keyword">CONCAT</span>(SCHEMANAME, <span class="string">"."</span>, TABLENAME) <span class="keyword">AS</span> <span class="string">`table`</span>, @drop_partitions <span class="keyword">AS</span> <span class="string">`partitions_deleted`</span>;</span><br><span class="line">        ELSE</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                   No partitions are being deleted, so print out"N/A"(Not applicable) to indicate</span></span><br><span class="line"><span class="comment">                   that no changes were made.</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="keyword">SELECT</span> <span class="keyword">CONCAT</span>(SCHEMANAME, <span class="string">"."</span>, TABLENAME) <span class="keyword">AS</span> <span class="string">`table`</span>, <span class="string">"N/A"</span> <span class="keyword">AS</span> <span class="string">`partitions_deleted`</span>;</span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line">DELIMITER ;</span><br><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> <span class="string">`partition_maintenance`</span>(SCHEMA_NAME <span class="built_in">VARCHAR</span>(<span class="number">32</span>), TABLE_NAME <span class="built_in">VARCHAR</span>(<span class="number">32</span>), KEEP_DATA_DAYS <span class="built_in">INT</span>, HOURLY_INTERVAL <span class="built_in">INT</span>, CREATE_NEXT_INTERVALS <span class="built_in">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">DECLARE</span> OLDER_THAN_PARTITION_DATE <span class="built_in">VARCHAR</span>(<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">DECLARE</span> PARTITION_NAME <span class="built_in">VARCHAR</span>(<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">DECLARE</span> OLD_PARTITION_NAME <span class="built_in">VARCHAR</span>(<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">DECLARE</span> LESS_THAN_TIMESTAMP <span class="built_in">INT</span>;</span><br><span class="line">        <span class="keyword">DECLARE</span> CUR_TIME <span class="built_in">INT</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">CALL</span> partition_verify(SCHEMA_NAME, TABLE_NAME, HOURLY_INTERVAL);</span><br><span class="line">        <span class="keyword">SET</span> CUR_TIME = <span class="keyword">UNIX_TIMESTAMP</span>(<span class="keyword">DATE_FORMAT</span>(<span class="keyword">NOW</span>(), <span class="string">'%Y-%m-%d 00:00:00'</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">SET</span> @__interval = <span class="number">1</span>;</span><br><span class="line">        create_loop: LOOP</span><br><span class="line">                IF @__interval &gt; CREATE_NEXT_INTERVALS THEN</span><br><span class="line">                        LEAVE create_loop;</span><br><span class="line">                <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">SET</span> LESS_THAN_TIMESTAMP = CUR_TIME + (HOURLY_INTERVAL * @__interval * <span class="number">3600</span>);</span><br><span class="line">                <span class="keyword">SET</span> PARTITION_NAME = FROM_UNIXTIME(CUR_TIME + HOURLY_INTERVAL * (@__interval - <span class="number">1</span>) * <span class="number">3600</span>, <span class="string">'p%Y%m%d%H00'</span>);</span><br><span class="line">                IF(PARTITION_NAME != OLD_PARTITION_NAME) THEN</span><br><span class="line">                        <span class="keyword">CALL</span> partition_create(SCHEMA_NAME, TABLE_NAME, PARTITION_NAME, LESS_THAN_TIMESTAMP);</span><br><span class="line">                <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line">                <span class="keyword">SET</span> @__interval=@__interval+<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">SET</span> OLD_PARTITION_NAME = PARTITION_NAME;</span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">LOOP</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">SET</span> OLDER_THAN_PARTITION_DATE=<span class="keyword">DATE_FORMAT</span>(<span class="keyword">DATE_SUB</span>(<span class="keyword">NOW</span>(), <span class="built_in">INTERVAL</span> KEEP_DATA_DAYS <span class="keyword">DAY</span>), <span class="string">'%Y%m%d0000'</span>);</span><br><span class="line">        <span class="keyword">CALL</span> partition_drop(SCHEMA_NAME, TABLE_NAME, OLDER_THAN_PARTITION_DATE);</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line">DELIMITER ;</span><br><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> <span class="string">`partition_verify`</span>(SCHEMANAME <span class="built_in">VARCHAR</span>(<span class="number">64</span>), TABLENAME <span class="built_in">VARCHAR</span>(<span class="number">64</span>), HOURLYINTERVAL <span class="built_in">INT</span>(<span class="number">11</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">DECLARE</span> PARTITION_NAME <span class="built_in">VARCHAR</span>(<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">DECLARE</span> RETROWS <span class="built_in">INT</span>(<span class="number">11</span>);</span><br><span class="line">        <span class="keyword">DECLARE</span> FUTURE_TIMESTAMP <span class="keyword">TIMESTAMP</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Check if any partitions exist for the given SCHEMANAME.TABLENAME.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(<span class="number">1</span>) <span class="keyword">INTO</span> RETROWS</span><br><span class="line">        <span class="keyword">FROM</span> information_schema.partitions</span><br><span class="line">        <span class="keyword">WHERE</span> table_schema = SCHEMANAME <span class="keyword">AND</span> table_name = TABLENAME <span class="keyword">AND</span> partition_name <span class="keyword">IS</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * If partitions do not exist, go ahead and partition the table</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        IF RETROWS = 1 THEN</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * Take the current date at 00:00:00 and add HOURLYINTERVAL to it.  This is the timestamp below which we will store values.</span></span><br><span class="line"><span class="comment">                 * We begin partitioning based on the beginning of a day.  This is because we don't want to generate a random partition</span></span><br><span class="line"><span class="comment">                 * that won't necessarily fall in line with the desired partition naming (ie: if the hour interval is 24 hours, we could</span></span><br><span class="line"><span class="comment">                 * end up creating a partition now named"p201403270600"when all other partitions will be like"p201403280000").</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">SET</span> FUTURE_TIMESTAMP = <span class="keyword">TIMESTAMPADD</span>(<span class="keyword">HOUR</span>, HOURLYINTERVAL, <span class="keyword">CONCAT</span>(<span class="keyword">CURDATE</span>(), <span class="string">" "</span>, <span class="string">'00:00:00'</span>));</span><br><span class="line">                <span class="keyword">SET</span> PARTITION_NAME = <span class="keyword">DATE_FORMAT</span>(<span class="keyword">CURDATE</span>(), <span class="string">'p%Y%m%d%H00'</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">-- Create the partitioning query</span></span><br><span class="line">                <span class="keyword">SET</span> @__PARTITION_SQL = <span class="keyword">CONCAT</span>(<span class="string">"ALTER TABLE "</span>, SCHEMANAME, <span class="string">"."</span>, TABLENAME, <span class="string">" PARTITION BY RANGE(`clock`)"</span>);</span><br><span class="line">                <span class="keyword">SET</span> @__PARTITION_SQL = <span class="keyword">CONCAT</span>(@__PARTITION_SQL, <span class="string">"(PARTITION "</span>, PARTITION_NAME, <span class="string">" VALUES LESS THAN ("</span>, <span class="keyword">UNIX_TIMESTAMP</span>(FUTURE_TIMESTAMP), <span class="string">"));"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">-- Run the partitioning query</span></span><br><span class="line">                <span class="keyword">PREPARE</span> STMT <span class="keyword">FROM</span> @__PARTITION_SQL;</span><br><span class="line">                <span class="keyword">EXECUTE</span> STMT;</span><br><span class="line">                <span class="keyword">DEALLOCATE</span> <span class="keyword">PREPARE</span> STMT;</span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span><span class="string">`partition_maintenance_all`</span>(SCHEMA_NAME <span class="built_in">VARCHAR</span>(<span class="number">32</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">               <span class="keyword">CALL</span> partition_maintenance(SCHEMA_NAME, <span class="string">'history'</span>, <span class="number">30</span>, <span class="number">24</span>, <span class="number">14</span>);</span><br><span class="line">               <span class="keyword">CALL</span> partition_maintenance(SCHEMA_NAME, <span class="string">'history_log'</span>, <span class="number">30</span>, <span class="number">24</span>, <span class="number">14</span>);</span><br><span class="line">               <span class="keyword">CALL</span> partition_maintenance(SCHEMA_NAME, <span class="string">'history_str'</span>, <span class="number">30</span>, <span class="number">24</span>, <span class="number">14</span>);</span><br><span class="line">               <span class="keyword">CALL</span> partition_maintenance(SCHEMA_NAME, <span class="string">'history_text'</span>, <span class="number">30</span>, <span class="number">24</span>, <span class="number">14</span>);</span><br><span class="line">               <span class="keyword">CALL</span> partition_maintenance(SCHEMA_NAME, <span class="string">'history_uint'</span>, <span class="number">30</span>, <span class="number">24</span>, <span class="number">14</span>);</span><br><span class="line">               <span class="keyword">CALL</span> partition_maintenance(SCHEMA_NAME, <span class="string">'trends'</span>, <span class="number">120</span>, <span class="number">24</span>, <span class="number">14</span>);</span><br><span class="line">               <span class="keyword">CALL</span> partition_maintenance(SCHEMA_NAME, <span class="string">'trends_uint'</span>, <span class="number">120</span>, <span class="number">24</span>, <span class="number">14</span>);</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line">DELIMITER ;%</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入 partition.sql</span></span><br><span class="line">mysql -u<span class="string">'zabbix'</span> -p<span class="string">'zabbix'</span> zabbix  &lt; partition.sql</span><br><span class="line"><span class="comment"># 手动后台单次执行 </span></span><br><span class="line">nohup mysql -u<span class="string">'zabbix'</span> -p<span class="string">'zabbix'</span> <span class="string">'zabbix'</span> -e <span class="string">"CALL partition_maintenance_all('zabbix');"</span> &amp;&gt; /root/partition.log&amp;</span><br><span class="line">tail -f /root/partition.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看过程逻辑 </span></span><br><span class="line">show create procedure partition_maintenance_all \G;</span><br><span class="line"><span class="comment"># 删除存储过程 </span></span><br><span class="line">drop procedure <span class="keyword">if</span> exists partition_maintenance_all; </span><br><span class="line"><span class="comment"># 查看存储过程 </span></span><br><span class="line">show procedure status like <span class="string">'partition_maintenance%'</span> \G;</span><br><span class="line"><span class="comment"># 查看 </span></span><br><span class="line">show create table <span class="built_in">history</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建定时任务脚本 </span></span><br><span class="line">[root@sg-gop-10-65-200-90 wangao]<span class="comment"># cat /opt/sa_scripts/zabbix_partitioning.sh</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">user=<span class="string">'zabbix'</span></span><br><span class="line">password=<span class="string">'zabbix'</span></span><br><span class="line">database=<span class="string">'zabbix'</span></span><br><span class="line"></span><br><span class="line">mysql -u<span class="variable">$&#123;user&#125;</span> -p<span class="variable">$password</span> <span class="variable">$database</span> -e <span class="string">"CALL partition_maintenance_all('zabbix');"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改执行权限 </span></span><br><span class="line">chmod 755 /opt/sa_scripts/zabbix_partitioning.sh</span><br><span class="line"><span class="comment"># 修改 crontab</span></span><br><span class="line">vim /etc/crontab</span><br><span class="line">15 3 * * * root bash /opt/sa_scripts/zabbix_partitioning.sh</span><br></pre></td></tr></table></figure><h2 id="Zabbix-Proxy"><a href="#Zabbix-Proxy" class="headerlink" title="Zabbix Proxy"></a>Zabbix Proxy</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># zabbix proxy 的依赖就只有数据库了，用于存储配置信息 </span></span><br><span class="line">yum install -y mariadb-server mariadb</span><br><span class="line"><span class="comment"># 启动 mariadb 服务 </span></span><br><span class="line">systemctl start mariadb.service</span><br><span class="line">systemctl <span class="built_in">enable</span> mariadb.service</span><br><span class="line"><span class="comment"># 初始化 mysql 数据库，并配置 root 用户密码 </span></span><br><span class="line">mysql_secure_installation</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 zabbix_proxy 数据库 </span></span><br><span class="line">mysql -uroot -p</span><br><span class="line"></span><br><span class="line">mysql&gt; create database zabbix_proxy character <span class="built_in">set</span> utf8 collate utf8_bin;</span><br><span class="line">mysql&gt; grant all privileges on zabbix_proxy.* to zabbix@localhost identified by <span class="string">'zabbix'</span>;</span><br><span class="line">mysql&gt; quit;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署 zabbix_proxy</span></span><br><span class="line">rpm -Uvh https://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-1.el7.noarch.rpm</span><br><span class="line">yum install -y zabbix-proxy-mysql</span><br><span class="line">zcat /usr/share/doc/zabbix-proxy-mysql*/schema.sql.gz | mysql -uzabbix -p zabbix_proxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据库用户及密码 </span></span><br><span class="line">vim /etc/zabbix/zabbix_proxy.conf</span><br><span class="line">Server=192.168.56.103</span><br><span class="line">Hostname=zabbix_proxy</span><br><span class="line">DBName=zabbix_proxy</span><br><span class="line">DBUser=zabbix</span><br><span class="line">DBPassword=zabbix</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 Zabbix Server Proxy</span></span><br><span class="line">Administration -&gt; Proxies -&gt; Create proxy</span><br><span class="line">Proxy name: zabbix_proxy</span><br><span class="line">Proxy mode: Active</span><br><span class="line">Proxy address: 192.168.56.101</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 zabbix_proxy</span></span><br><span class="line">systemctl restart zabbix-proxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 zabbix_agent 配置指向 zabbix_proxy</span></span><br><span class="line">vim /etc/zabbix/zabbix_agentd.conf</span><br><span class="line">Server=192.168.56.101,192.168.56.103</span><br><span class="line">ServerActive=192.168.56.101</span><br><span class="line">Hostname=192.168.56.101</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 zabbix_proxy 服务 </span></span><br><span class="line">systemctl <span class="built_in">enable</span> zabbix-proxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 zabbix_server 中添加代理主机 </span></span><br><span class="line">Configuration -&gt; Hosts -&gt; Create host</span><br><span class="line">Monitored by proxy: zabbix_proxy</span><br></pre></td></tr></table></figure><h2 id="Zabbix-Database-迁移"><a href="#Zabbix-Database-迁移" class="headerlink" title="Zabbix Database 迁移"></a>Zabbix Database 迁移</h2><h3 id="本地迁移"><a href="#本地迁移" class="headerlink" title="本地迁移"></a>本地迁移</h3><ol><li>依次关闭 zabbix-server 和 mariadb 数据库</li><li>复制数据库至新的位置</li><li>修改 my.cnf 配置文件</li><li>修改 zabbix 相关配置文件</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建数据库新的 path</span></span><br><span class="line">mkdir /data</span><br><span class="line">service zabbix-server stop</span><br><span class="line">systemctl stop mariadb.service</span><br><span class="line">cp -r /var/lib/mysql/　/data/</span><br><span class="line">chown -R mysql:mysql /data/mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 my.cnf 配置或者使用软链接 ln 方式一步简化 </span></span><br><span class="line">vim /etc/my.cnf</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">socket=/data/mysql/mysql.sock</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="comment">#datadir=/var/lib/mysql</span></span><br><span class="line"><span class="comment">#socket=/var/lib/mysql/mysql.sock</span></span><br><span class="line">datadir=/data/mysql</span><br><span class="line">socket=/data/mysql/mysql.sock</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 zabbix_server.conf 配置 </span></span><br><span class="line">DBSocket=/data/mysql/mysql.sock</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 php.ini 配置 </span></span><br><span class="line">vim /etc/php.ini</span><br><span class="line">pdo_mysql.default_socket=/data/mysql/mysql.sock</span><br><span class="line">mysql.default_socket = /data/mysql/mysql.sock</span><br><span class="line">mysqli.default_socket = /data/mysql/mysql.sock</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启服务观察日志 </span></span><br><span class="line">systemctl start mariadb.service</span><br><span class="line">service zabbix-server start</span><br><span class="line">tailf /var/<span class="built_in">log</span>/zabbix/zabbix_server.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确认数据库前移位置 </span></span><br><span class="line">mysql -uroot -p</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; select @@datadir;</span><br><span class="line">+--------------+</span><br><span class="line">| @@datadir    |</span><br><span class="line">+--------------+</span><br><span class="line">| /data/mysql/ |</span><br><span class="line">+--------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 参考文章 </span></span><br><span class="line">https://www.zabbix.com/forum/zabbix-help/52032-move-var-lib-mysql-and-update-my-cnf-zabbix-gui-reports-error?p=363471<span class="comment">#post363471</span></span><br><span class="line"></span><br><span class="line">1) /etc/my.cnf configuration file has two sections <span class="built_in">where</span> I edited directory name <span class="keyword">for</span> mysql.sock:</span><br><span class="line">- section [mysqld]</span><br><span class="line">socket=/home/mysql/mysql.sock</span><br><span class="line">- section [client]</span><br><span class="line">socket=/home/mysql/mysql.sock</span><br><span class="line"></span><br><span class="line">2) /etc/php.ini also has more than one line <span class="keyword">for</span> mysql.sock:</span><br><span class="line"><span class="comment">#grep "mysql.sock" /etc/php.ini</span></span><br><span class="line">pdo_mysql.default_socket=/home/mysql/mysql.sock</span><br><span class="line">mysql.default_socket = /home/mysql/mysql.sock</span><br><span class="line">mysqli.default_socket = /home/mysql/mysql.sock</span><br><span class="line"></span><br><span class="line">3) And zabbix_server.conf also must be edited</span><br><span class="line"><span class="comment"># grep "mysql.sock" /etc/zabbix/zabbix_server.conf</span></span><br><span class="line"><span class="comment"># DBSocket=/tmp/mysql.sock</span></span><br><span class="line">DBSocket=/home/mysql/mysql.sock</span><br></pre></td></tr></table></figure><h3 id="本地迁移至远程"><a href="#本地迁移至远程" class="headerlink" title="本地迁移至远程"></a>本地迁移至远程</h3><blockquote><p>从本地数据库 localhost 迁移至远程的 DB Cluster 集群</p></blockquote><ol><li>数据量即使很大一般都会设定保留周期，比如 30 天</li><li>最简单的方案当然是整个库全部迁移过去，丢失迁移时间段内的数据是可以接受的</li><li>简单分享下 Zabbix Server 需要修改的地方</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改 zabbix_server.conf</span></span><br><span class="line">vim /etc/zabbix/zabbix_server.conf</span><br><span class="line"></span><br><span class="line">DBHost=xxx</span><br><span class="line">DBName=zabbix</span><br><span class="line">DBUser=zabbix</span><br><span class="line">DBPassword=zabbix</span><br><span class="line">DBPort=3306</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 zabbix web 前端 </span></span><br><span class="line">vim /etc/zabbix/web/zabbix.conf.php</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">// Zabbix GUI configuration file.</span><br><span class="line">global <span class="variable">$DB</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$DB</span>[<span class="string">'TYPE'</span>]     = <span class="string">'MYSQL'</span>;</span><br><span class="line"><span class="variable">$DB</span>[<span class="string">'SERVER'</span>]   = <span class="string">'xxx'</span>;</span><br><span class="line"><span class="variable">$DB</span>[<span class="string">'PORT'</span>]     = <span class="string">'3306'</span>;</span><br><span class="line"><span class="variable">$DB</span>[<span class="string">'DATABASE'</span>] = <span class="string">'zabbix'</span>;</span><br><span class="line"><span class="variable">$DB</span>[<span class="string">'USER'</span>]     = <span class="string">'zabbix'</span>;</span><br><span class="line"><span class="variable">$DB</span>[<span class="string">'PASSWORD'</span>] = <span class="string">'zabbix'</span>;</span><br><span class="line"></span><br><span class="line">// Schema name. Used <span class="keyword">for</span> IBM DB2 and PostgreSQL.</span><br><span class="line"><span class="variable">$DB</span>[<span class="string">'SCHEMA'</span>] = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$ZBX_SERVER</span>      = <span class="string">'localhost'</span>;</span><br><span class="line"><span class="variable">$ZBX_SERVER_PORT</span> = <span class="string">'10051'</span>;</span><br><span class="line"><span class="variable">$ZBX_SERVER_NAME</span> = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$IMAGE_FORMAT_DEFAULT</span> = IMAGE_FORMAT_PNG;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启 zabbix-server 和 httpd</span></span><br><span class="line">service zabbix-server restart</span><br><span class="line">service httpd restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 zabbix_server 日志 </span></span><br><span class="line">tail -f /var/<span class="built_in">log</span>/zabbix/zabbix_server.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 crontab 定时任务脚本 </span></span><br><span class="line">vim /etc/crontab</span><br><span class="line">15 3 * * * root bash /opt/sa_scripts/zabbix_partitioning.sh</span><br><span class="line"></span><br><span class="line">vim /opt/sa_scripts/zabbix_partitioning.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">host=<span class="string">'xxx'</span></span><br><span class="line">user=<span class="string">'zabbix'</span></span><br><span class="line">password=<span class="string">'zabbix'</span></span><br><span class="line">database=<span class="string">'zabbix'</span></span><br><span class="line">port=<span class="string">'3306'</span></span><br><span class="line"></span><br><span class="line">mysql -h<span class="variable">$&#123;host&#125;</span> -u<span class="variable">$&#123;user&#125;</span> -p<span class="variable">$&#123;password&#125;</span> -P<span class="variable">$&#123;port&#125;</span> <span class="variable">$database</span> -e <span class="string">"CALL partition_maintenance_all('zabbix');"</span></span><br></pre></td></tr></table></figure><h2 id="Zabbix-HA-高可用"><a href="#Zabbix-HA-高可用" class="headerlink" title="Zabbix HA 高可用"></a>Zabbix HA 高可用</h2><blockquote><p>基于 Keepalived 搭建 Zabbix HA 高可用</p></blockquote><p>【zabbix HA】zabbixHA 高可用的实现<br><a href="https://www.jianshu.com/p/eecb5e8d1a96" target="_blank" rel="noopener">https://www.jianshu.com/p/eecb5e8d1a96</a></p>]]></content>
    
    <summary type="html">
    
      基于keepalived搭建zabbix server HA双机高可用
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>如何使用 MTR 诊断网络问题</title>
    <link href="https://wsgzao.github.io/post/mtr/"/>
    <id>https://wsgzao.github.io/post/mtr/</id>
    <published>2019-10-22T06:59:49.000Z</published>
    <updated>2019-10-23T09:18:09.056Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>MTR 是一款强大的网络诊断工具，网络管理员使用 MTR 可以诊断和隔离网络问题，并且为上游 ISP 提供有用的网络状态报告。MTR 是传统 traceroute 命令的进化版，并且可以提供强大的数据样本，因为他集合了 traceroute 和 ping 这两个命令的精华。本文带您深入了解 MTR ，从数据如何生成，到如果正确理解报告样本并得出相应的结论。</p><blockquote><p>使用 MTR 诊断网络问题</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 10 月 23 日 - 增加 iOS 和 Android 客户端的 MTR APP<br>2019 年 01 月 22 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/mtr/">https://wsgzao.github.io/post/mtr/</a></p><p><strong> 扩展阅读 </strong></p><p>MTR - <a href="http://www.bitwizard.nl/mtr/" target="_blank" rel="noopener">http://www.bitwizard.nl/mtr/</a><br>Diagnosing Network Issues with MTR - <a href="https://www.linode.com/docs/networking/diagnostics/diagnosing-network-issues-with-mtr/" target="_blank" rel="noopener">https://www.linode.com/docs/networking/diagnostics/diagnosing-network-issues-with-mtr/</a></p><hr><h2 id="网络诊断相关的背景知识"><a href="#网络诊断相关的背景知识" class="headerlink" title="网络诊断相关的背景知识"></a>网络诊断相关的背景知识</h2><p>Networking diagnostic tools including ping, traceroute, and mtr use Internet Control Message Protocol (ICMP) packets to test contention and traffic between two points on the Internet. When a user pings a host on the Internet, a series of ICMP packets are sent to the host, which responds by sending packets in return. The user’s client is then able to compute the round trip time between two points on the Internet.</p><p>In contrast, tools such as traceroute and MTR send ICMP packets with incrementally increasing TTLs in order to view the route or series of hops that the packet makes between the origin and its destination. The TTL, or time to live, controls how many hops a packet will make before “dying” and returning to the host. By sending a series of packets and causing them to return after one hop, then two, then three, MTR is able to assemble the route that traffic takes between hosts on the Internet.</p><p>Rather than provide a simple outline of the route that traffic takes across the Internet, MTR collects additional information regarding the state, connection, and responsiveness of the intermediate hosts. Because of this additional information, MTR can provide a complete overview of the connection between two hosts on the Internet. The following sections outline how to install the MTR software and how to interpret the results provided by this tool.</p><p>网络诊断工具 例如 ping traceroute mtr 都使用的 “ICMP” 包来测试 Internet 两点之间的网络连接状况。当用户使用 ping 命令 ping 网络上的主机后， ICMP 包将会发送到目的主机，然后在目的主机返回响应。这样，就可以得知本机到目的主机 ICMP 包传输所使用的往返时间。</p><p>相对于其他命令仅仅收集传输路径或响应时间，MTR 工具会收集更多的信息，比如 连接状态，连接可用性，以及传输路径中主机的响应性。由于这些额外的信息，我们建议您尽可能完整的展现 Internet 两个主机之间的网络连接信息。接下来我们讲述如何安装 MTR 软件，以及如何看懂这款软件的输出结果。</p><p>Diagnostics and Testing - <a href="https://www.linode.com/docs/networking/diagnostics/" target="_blank" rel="noopener">https://www.linode.com/docs/networking/diagnostics/</a></p><h2 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h2><p>ICMP(Internet Control Message Protocol)<br>IP 协议族的一员，主要用于网络设备间发送错误指示信息, 一般不用于传输数据，常见部署在用户端网络程序中，诸如 traceroute 或 ping 等程序</p><p>TTL(Time To Live)<br>此处的 Time 表示的是次数，而不是时间，表达的是一个包在结束之前还能经过的跳数</p><p>Hop<br>跳数: 网络中两个端路径上的节点，路由器的数目</p><p>ISP(Internet Service Provider)<br>互联网服务提供商</p><h2 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h2><p>ping send ICMP ECHO_REQUEST to network hosts</p><p>ICMP 是（Internet Control Message Protocol）Internet 控制报文协议。它是 TCP/IP 协议族的一个子协议，用于在 IP 主机、路由器之间传递控制消息。控制消息是指网络通不通、主机是否可达、路由是否可用等网络本身的消息。这些控制消息虽然并不传输用户数据，但是对于用户数据的传递起着重要的作用。</p><p>使用 ping 检查连通性有六个步骤：</p><ol><li>使用 ifconfig 观察本地网络设置是否正确；</li><li>ping 127.0.0.1，127.0.0.1 回送地址 Ping 回送地址是为了检查本地的 TCP/IP 协议有没有设置好；</li><li>ping 本机 IP 地址，这样是为了检查本机的 IP 地址是否设置有误；</li><li>ping 本网网关或本网 IP 地址，这样的是为了检查硬件设备是否有问题，也可以检查本机与本地网络连接是否正常；(在非局域网中这一步骤可以忽略)</li><li>ping 本地 DNS 地址，这样做是为了检查 DNS 是否能够将 IP 正确解析。注: /etc/resolv.conf 文件，”nameserver 8.8.8.8” 指定了 dns 服务器的地址，如果启用了 NetworkManager 要注意网卡重启或服务器重启配置被覆盖的问题；</li><li>ping 远程 IP 地址，这主要是检查本网或本机与外部的连接是否正常。</li></ol><h2 id="安装-MTR"><a href="#安装-MTR" class="headerlink" title="安装 MTR"></a>安装 MTR</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CentOS</span></span><br><span class="line">yum install mtr</span><br><span class="line"><span class="comment"># Ubuntu</span></span><br><span class="line">apt-get install mtr</span><br><span class="line"><span class="comment"># macOS</span></span><br><span class="line">brew install mtr</span><br><span class="line"><span class="comment"># Windows</span></span><br><span class="line">BestTrace - https://www.ipip.net/product/client.html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line"> mtr [options] hostname</span><br><span class="line"></span><br><span class="line"> -F, --filename FILE        <span class="built_in">read</span> hostname(s) from a file</span><br><span class="line"> -4                         use IPv4 only</span><br><span class="line"> -6                         use IPv6 only</span><br><span class="line"> -u, --udp                  use UDP instead of ICMP <span class="built_in">echo</span></span><br><span class="line"> -T, --tcp                  use TCP instead of ICMP <span class="built_in">echo</span></span><br><span class="line"> -a, --address ADDRESS      <span class="built_in">bind</span> the outgoing socket to ADDRESS</span><br><span class="line"> -f, --first-ttl NUMBER     <span class="built_in">set</span> what TTL to start</span><br><span class="line"> -m, --max-ttl NUMBER       maximum number of hops</span><br><span class="line"> -U, --max-unknown NUMBER   maximum unknown host</span><br><span class="line"> -P, --port PORT            target port number <span class="keyword">for</span> TCP, SCTP, or UDP</span><br><span class="line"> -L, --localport LOCALPORT  <span class="built_in">source</span> port number <span class="keyword">for</span> UDP</span><br><span class="line"> -s, --psize PACKETSIZE     <span class="built_in">set</span> the packet size used <span class="keyword">for</span> probing</span><br><span class="line"> -B, --bitpattern NUMBER    <span class="built_in">set</span> bit pattern to use <span class="keyword">in</span> payload</span><br><span class="line"> -i, --interval SECONDS     ICMP <span class="built_in">echo</span> request interval</span><br><span class="line"> -G, --gracetime SECONDS    number of seconds to <span class="built_in">wait</span> <span class="keyword">for</span> responses</span><br><span class="line"> -Q, --tos NUMBER           <span class="built_in">type</span> of service field <span class="keyword">in</span> IP header</span><br><span class="line"> -e, --mpls                 display information from ICMP extensions</span><br><span class="line"> -Z, --timeout SECONDS      seconds to keep probe sockets open</span><br><span class="line"> -r, --report               output using report mode</span><br><span class="line"> -w, --report-wide          output wide report</span><br><span class="line"> -c, --report-cycles COUNT  <span class="built_in">set</span> the number of pings sent</span><br><span class="line"> -j, --json                 output json</span><br><span class="line"> -x, --xml                  output xml</span><br><span class="line"> -C, --csv                  output comma separated values</span><br><span class="line"> -l, --raw                  output raw format</span><br><span class="line"> -p, --split                split output</span><br><span class="line"> -t, --curses               use curses terminal interface</span><br><span class="line">     --displaymode MODE     select initial display mode</span><br><span class="line"> -n, --no-dns               <span class="keyword">do</span> not resove host names</span><br><span class="line"> -b, --show-ips             show IP numbers and host names</span><br><span class="line"> -o, --order FIELDS         select output fields</span><br><span class="line"> -y, --ipinfo NUMBER        select IP information <span class="keyword">in</span> output</span><br><span class="line"> -z, --aslookup             display AS number</span><br><span class="line"> -h, --<span class="built_in">help</span>                 display this <span class="built_in">help</span> and <span class="built_in">exit</span></span><br><span class="line"> -v, --version              output version information and <span class="built_in">exit</span></span><br></pre></td></tr></table></figure><h2 id="如何读懂-MTR-报告"><a href="#如何读懂-MTR-报告" class="headerlink" title="如何读懂 MTR 报告"></a>如何读懂 MTR 报告</h2><p>因为 MTR 报告包括了丰富的信息，新手第一次阅读有点困难。下面是我本地到 google.com 的测试报告</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@sg-gop-10-65-200-186 wangao]<span class="comment"># mtr -r google.com</span></span><br><span class="line">Start: Wed Jan 23 16:00:30 2019</span><br><span class="line">HOST: sg-gop-10-65-200-186        Loss%   Snt   Last   Avg  Best  Wrst StDev</span><br><span class="line">  1.|-- 10.65.200.20               0.0%    10    0.3   0.3   0.3   0.5   0.0</span><br><span class="line">  2.|-- ns9.webhostsg.com          0.0%    10    1.0   0.9   0.9   1.0   0.0</span><br><span class="line">  3.|-- 192.168.3.33               0.0%    10    0.9   0.9   0.8   0.9   0.0</span><br><span class="line">  4.|-- vlan242-s4rsm.starhub.net  0.0%    10    1.6   1.8   1.6   1.9   0.0</span><br><span class="line">  5.|-- ancoretl02.starhub.net.sg  0.0%    10    2.0   2.0   1.9   2.1   0.0</span><br><span class="line">  6.|-- anutli12.starhub.net.sg    0.0%    10    1.9   2.1   1.9   3.1   0.3</span><br><span class="line">  7.|-- 72.14.194.0                0.0%    10    2.5   2.7   2.4   4.3   0.5</span><br><span class="line">  8.|-- 74.125.242.35              0.0%    10    2.5   2.5   2.4   2.7   0.0</span><br><span class="line">  9.|-- 216.239.49.74              0.0%    10    3.4   4.4   3.3  12.0   2.6</span><br><span class="line"> 10.|-- 74.125.252.254             0.0%    10    3.7   3.7   3.5   3.9   0.0</span><br><span class="line"> 11.|-- 108.170.233.49             0.0%    10    4.4   4.2   4.0   4.7   0.0</span><br><span class="line"> 12.|-- ???                       100.0    10    0.0   0.0   0.0   0.0   0.0</span><br></pre></td></tr></table></figure><p>返回结果各列数据说明：</p><p>第一列: 显示的是 IP 地址或本机域名，这点和 traceroute 很像</p><p>第二列: Loss% 到达此节点的数据包丢包率，显示的每个对应 IP 的丢包率。</p><p>第三列: Snt:100 设置发送数据包的数量，默认值是 10 通过参数 -c 来自定义数量。</p><p>第四列: Last 显示的最近一次的返回时延</p><p>第五列: Avg 平均值这个应该是发送 ping 包的平均时延</p><p>第六列: Best 最好或者说时延最低的</p><p>第七列: Wrst 最差或者说时延最大的</p><p>第八列: StDev 是标准偏差</p><p>使用 mtr –report google.com 命令来输出这篇报告。使用 report 选项可以给 google.com 主机发送 10 个 ICMP 包，然后输出报告。如果我们不使用 –report 参数， mtr 会不断的动态运行。在动态模式下， mtr 的输出结果表述每个主机的往返时间。大多数情况下，使用 –report 参数就可以提供足够的数据了。</p><p>在命令下面，就是 MTR 产生的输出报告 。在通常情况下， MTR 需要几秒钟的时间来输出报告，但是偶尔可能需要更长的时间。MTR 报告是由一系列跳数组成的（在上述例子中是 12 跳）。“跳” 意味着节点，或路由器，数据包通过它们才能到达目的主机。在上面例子中，数据包经过本地网络的 “内层” 和 “外层”，然后再到一系列的域名主机。主机的域名是通过反向 DNS 查找确定的。如果您想忽略 DNS 查找，您可以使用 –no-dns 参数，使用 –no-dns 参数后，报告结果如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@sg-gop-10-65-200-186 wangao]<span class="comment"># mtr -rn google.com</span></span><br><span class="line">Start: Wed Jan 23 16:01:02 2019</span><br><span class="line">HOST: sg-gop-10-65-200-186        Loss%   Snt   Last   Avg  Best  Wrst StDev</span><br><span class="line">  1.|-- 10.65.200.20               0.0%    10    0.2   0.3   0.2   0.3   0.0</span><br><span class="line">  2.|-- 203.117.178.28             0.0%    10    0.8   0.9   0.8   1.1   0.0</span><br><span class="line">  3.|-- 192.168.3.33               0.0%    10    0.8   0.8   0.7   0.9   0.0</span><br><span class="line">  4.|-- 203.117.6.21               0.0%    10    1.8   1.8   1.6   1.9   0.0</span><br><span class="line">  5.|-- 203.118.15.177             0.0%    10    1.8   1.9   1.8   2.1   0.0</span><br><span class="line">  6.|-- 203.118.12.10              0.0%    10    1.9   1.9   1.8   2.1   0.0</span><br><span class="line">  7.|-- 72.14.194.0                0.0%    10    2.4   2.5   2.4   2.7   0.0</span><br><span class="line">  8.|-- 74.125.242.35              0.0%    10    2.6   4.7   2.5  12.6   3.8</span><br><span class="line">  9.|-- 216.239.49.74              0.0%    10    3.5   3.5   3.3   4.0   0.0</span><br><span class="line"> 10.|-- 74.125.252.254             0.0%    10    3.7   4.1   3.7   6.6   0.8</span><br><span class="line"> 11.|-- 108.170.233.49             0.0%    10    4.3   4.4   4.2   4.7   0.0</span><br><span class="line"> 12.|-- ???                       100.0    10    0.0   0.0   0.0   0.0   0.0</span><br></pre></td></tr></table></figure><p>当我们研究 MTR 报告时候，最好找出每一跳的任何问题。除了可以查看两个服务器之间的路径之外，MTR 在它的七列数据中提供了很多有价值的数据统计报告。 Loss% 列展示了数据包在每一跳的丢失率。 Snt 列记录的多少个数据包被送出。 使用 –report 参数默认会送出 10 个数据包。如果使用 –report-cycles=[number-of-packets] 选项，MTR 就会按照 [number-of-packets] 指定的数量发出 ICMP 数据包。</p><p>Last, Avg, Best 和 Wrst 列都标识数据包往返的时间，使用的是毫秒（ ms ）单位表示。 Last 表示最后一个数据包所用的时间， Avg 表示评价时间， Best 和 Wrst 表示最小和最大时间。在大多数情况下，平均时间（ Avg）列需要我们特别注意。</p><p>最后一列 StDev 提供了数据包在每个主机的标准偏差。如果标准偏差越高，说明数据包在这个节点的延时越不相同。标准偏差会让您了解到平均延时是否是真的延时时间的中心点，或者测量数据受到某些问题的干扰。</p><p>例如，如果标准偏差很大，说明数据包的延迟是不确定的。一些数据包延迟很小（例如：25ms），另一些数据包延迟很大（例如：350ms）。当 10 个数据包全部发出后，得到的平均延迟可能是正常的，但是平均延迟是不能很好的反应实际情况的。如果标准偏差很高，使用最好和最坏的延迟来确定平均延迟是一个较好的方案。</p><p>在大多数情况下，您可以把 MTR 的输出分成三大块。根据配置，第二或第三跳一般都是您的本地 ISP，倒数第二或第三跳一般为您目的主机的 ISP。中间的节点是数据包经过的路由器。</p><h2 id="分析-MTR-报告"><a href="#分析-MTR-报告" class="headerlink" title="分析 MTR 报告"></a>分析 MTR 报告</h2><p>核心的两个参数:</p><ul><li>loss 丢包率</li><li>latency 延迟</li></ul><h3 id="确定丢包率"><a href="#确定丢包率" class="headerlink" title="确定丢包率"></a>确定丢包率</h3><p>当分析 MTR 的输出时，您需要注意两点： loss 和 latency。首先，让我们讨论一下 loss。如果您在任何一跳上看到 loss 的百分比，这就说明这一跳上可能有问题了。当然，很多服务提供商人为限制 ICMP 发送的速率，这也会导致此问题。那么如何才能指定是人为的限制 ICMP 传输还是确定有丢包的现象？我们需要查看下一跳。如果下一跳没有丢包现象，说明上一条是人为限制的。如下示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@localhost:~<span class="comment"># mtr --report www.google.com</span></span><br><span class="line">HOST: example               Loss%   Snt   Last   Avg  Best  Wrst StDev</span><br><span class="line">1. 63.247.74.43                  0.0%    10    0.3   0.6   0.3   1.2   0.3</span><br><span class="line">2. 63.247.64.157                50.0%    10    0.4   1.0   0.4   6.1   1.8</span><br><span class="line">3. 209.51.130.213                0.0%    10    0.8   2.7   0.8  19.0   5.7</span><br><span class="line">4. aix.pr1.atl.google.com        0.0%    10    6.7   6.8   6.7   6.9   0.1</span><br><span class="line">5. 72.14.233.56                  0.0%    10    7.2   8.3   7.1  16.4   2.9</span><br><span class="line">6. 209.85.254.247                0.0%    10   39.1  39.4  39.1  39.7   0.2</span><br><span class="line">7. 64.233.174.46                 0.0%    10   39.6  40.4  39.4  46.9   2.3</span><br><span class="line">8. gw-in-f147.1e100.net          0.0%    10   39.6  40.5  39.5  46.7   2.2</span><br></pre></td></tr></table></figure><p>在此例中，第二跳发生了丢包现象，但是接下来几条都没任何丢包现象，说明第二跳的丢包是人为限制的。如果在接下来的几条中都有丢包，那就可能是第二跳有问题了。请记住，ICMP 包的速率限制和丢失可能会同时发生。如果发生包的丢失情况，我们要用最低百分比来衡量时间情况。为什么这么说呢？请看如下示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@localhost:~<span class="comment"># mtr --report www.google.com</span></span><br><span class="line">HOST: localhost                   Loss%   Snt   Last   Avg  Best  Wrst StDev</span><br><span class="line">1. 63.247.74.43                   0.0%    10    0.3   0.6   0.3   1.2   0.3</span><br><span class="line">2. 63.247.64.157                  0.0%    10    0.4   1.0   0.4   6.1   1.8</span><br><span class="line">3. 209.51.130.213                60.0%    10    0.8   2.7   0.8  19.0   5.7</span><br><span class="line">4. aix.pr1.atl.google.com        60.0%    10    6.7   6.8   6.7   6.9   0.1</span><br><span class="line">5. 72.14.233.56                  50.0%   10    7.2   8.3   7.1  16.4   2.9</span><br><span class="line">6. 209.85.254.247                40.0%   10   39.1  39.4  39.1  39.7   0.2</span><br><span class="line">7. 64.233.174.46                 40.0%   10   39.6  40.4  39.4  46.9   2.3</span><br><span class="line">8. gw-in-f147.1e100.net          40.0%   10   39.6  40.5  39.5  46.7   2.2</span><br></pre></td></tr></table></figure><p>在这个例子中，您可以看打 第 3 跳和第 4 跳都有 60% 的丢包率，从接下来的几跳都有丢包现象，所以不像是人为限制 ICMP 速率的原因。但是最后几跳都是 40% 的丢包率，我们可以猜测到 60% 的丢包率除了网络糟糕的原因之前还有人为限制 ICMP。所以，当我们看到不同的丢包率时，通常要以最后几跳为准。</p><p>还有很多时候问题是在数据包返回途中发生的。数据包可以成功的到达目的主机，但是返回过程中遇到 “困难” 了。所以，当问题发生后，我们通常需要收集反方向的 MTR 报告。</p><p>此外，互联网设施的维护或短暂的网络拥挤可能会带来短暂的丢包率，当出现短暂的 10% 丢包率时候，不必担心，应用层的程序会弥补这点损失。</p><h3 id="读懂网络延迟"><a href="#读懂网络延迟" class="headerlink" title="读懂网络延迟"></a>读懂网络延迟</h3><p>除了可以通过 MTR 报告看到丢包率，我们还可以看到本地到目的主机之间的延时。因为不同的物理位置，延迟通常随着跳数的增加而增加。所以，延迟通常取决于节点之间的物理距离和线路质量。</p><p>例如，在同样的传输距离下，dial-up 连接比 cable modem 连接有更大的延迟。如下示例中显示 MTR 报告：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@localhost:~<span class="comment"># mtr --report www.google.com</span></span><br><span class="line">HOST: localhost                   Loss%   Snt   Last   Avg  Best  Wrst StDev</span><br><span class="line">1. 63.247.74.43                  0.0%    10    0.3   0.6   0.3   1.2   0.3</span><br><span class="line">2. 63.247.64.157                 0.0%    10    0.4   1.0   0.4   6.1   1.8</span><br><span class="line">3. 209.51.130.213                0.0%    10    0.8   2.7   0.8  19.0   5.7</span><br><span class="line">4. aix.pr1.atl.google.com        0.0%    10  388.0 360.4 342.1 396.7   0.2</span><br><span class="line">5. 72.14.233.56                  0.0%    10  390.6 360.4 342.1 396.7   0.2</span><br><span class="line">6. 209.85.254.247                0.0%    10  391.6 360.4 342.1 396.7   0.4</span><br><span class="line">7. 64.233.174.46                 0.0%    10  391.8 360.4 342.1 396.7   2.1</span><br><span class="line">8. gw-in-f147.1e100.net          0.0%    10  392.0 360.4 342.1 396.7   1.2</span><br></pre></td></tr></table></figure><p>在这份报告中，从第三跳到第四跳的延迟猛增，直接导致了后面的延迟也很大。这可能是因为第四跳的路由器配置不当，或者线路很拥堵的原因。</p><p>然而，高延迟并不一定意味着当前路由器有问题。这份报告虽然看到第四跳有点问题，但是数据仍然可以正常达到目的主机并且返回给主机。延迟很大的原因也有可能是在返回过程中引发的。我这份报告我们看不到返回的路径，返回的路径可能是完全不同的线路，所以我们一般要进行双向测试了。</p><p>ICMP 速率限制也可能会增加延迟，如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@localhost:~<span class="comment"># mtr --report www.google.com</span></span><br><span class="line">HOST: localhost                   Loss%   Snt   Last   Avg  Best  Wrst StDev</span><br><span class="line">  1. 63.247.74.43                  0.0%    10    0.3   0.6   0.3   1.2   0.3</span><br><span class="line">  2. 63.247.64.157                 0.0%    10    0.4   1.0   0.4   6.1   1.8</span><br><span class="line">  3. 209.51.130.213                0.0%    10    0.8   2.7   0.8  19.0   5.7</span><br><span class="line">  4. aix.pr1.atl.google.com        0.0%    10    6.7   6.8   6.7   6.9   0.1</span><br><span class="line">  5. 72.14.233.56                  0.0%    10  254.2 250.3 230.1 263.4   2.9</span><br><span class="line">  6. 209.85.254.247                0.0%    10   39.1  39.4  39.1  39.7   0.2</span><br><span class="line">  7. 64.233.174.46                 0.0%    10   39.6  40.4  39.4  46.9   2.3</span><br><span class="line">  8. gw-in-f147.1e100.net          0.0%    10   39.6  40.5  39.5  46.7   2.2</span><br></pre></td></tr></table></figure><p>乍一看，第 4 跳和第 5 跳直接的延迟很大。但是第 5 跳之后，延迟又恢复正常了。最后的延迟差不多为 40ms。像这种情况，是不影响实际情况的。因为可能仅仅是第 5 跳设备限制了 ICMP 传输速率的原因。所以我们一般要用最后一跳的实际延迟为准。</p><h2 id="常见的-MTR-报告类型"><a href="#常见的-MTR-报告类型" class="headerlink" title="常见的 MTR 报告类型"></a>常见的 MTR 报告类型</h2><p>很多网络问题十分麻烦，并且需要上级网络提供商来帮助。然而，这里有很多常见的 MTR 报告所描述的网络问题。如果您正在经历一些网络问题，并且想诊断出原因，可以参考如下示例：</p><h3 id="目的主机网络配置不当"><a href="#目的主机网络配置不当" class="headerlink" title="目的主机网络配置不当"></a>目的主机网络配置不当</h3><p>在下面这个例子中，数据包在目的地出现了 100% 的丢包。乍一看是数据包没有到达，其实未必，很有可能是路由器或主机配置不当。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@meiriyitie.com:~<span class="comment"># mtr --report www.google.com</span></span><br><span class="line">HOST: localhost                   Loss%   Snt   Last   Avg  Best  Wrst StDev</span><br><span class="line">  1. 63.247.74.43                  0.0%    10    0.3   0.6   0.3   1.2   0.3</span><br><span class="line">  2. 63.247.64.157                 0.0%    10    0.4   1.0   0.4   6.1   1.8</span><br><span class="line">  3. 209.51.130.213                0.0%    10    0.8   2.7   0.8  19.0   5.7</span><br><span class="line">  4. aix.pr1.atl.google.com        0.0%    10    6.7   6.8   6.7   6.9   0.1</span><br><span class="line">  5. 72.14.233.56                  0.0%    10    7.2   8.3   7.1  16.4   2.9</span><br><span class="line">  6. 209.85.254.247                0.0%    10   39.1  39.4  39.1  39.7   0.2</span><br><span class="line">  7. 64.233.174.46                 0.0%    10   39.6  40.4  39.4  46.9   2.3</span><br><span class="line">  8. gw-in-f147.1e100.net         100.0    10    0.0   0.0   0.0   0.0   0.0</span><br></pre></td></tr></table></figure><p>MTR 报告数据包没有到达目的主机是因为目的主机没有发送任何应答。这可能是目的主机防火墙的原因，例如： iptables 配置丢掉 ICMP 包所致。</p><h3 id="家庭或办公室路由器的原因"><a href="#家庭或办公室路由器的原因" class="headerlink" title="家庭或办公室路由器的原因"></a>家庭或办公室路由器的原因</h3><p>有时候家庭路由器的原因导致 MTR 报告看起来有点误导。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">% mtr --no-dns --report google.com</span><br><span class="line">HOST: deleuze                     Loss%   Snt   Last   Avg  Best  Wrst StDev</span><br><span class="line">  1. 192.168.1.1                   0.0%    10    2.2   2.2   2.0   2.7   0.2</span><br><span class="line">  2. ???                          100.0    10    8.6  11.0   8.4  17.8   3.0</span><br><span class="line">  3. 68.86.210.126                 0.0%    10    9.1  12.1   8.5  24.3   5.2</span><br><span class="line">  4. 68.86.208.22                  0.0%    10   12.2  15.1  11.7  23.4   4.4</span><br><span class="line">  5. 68.85.192.86                  0.0%    10   17.2  14.8  13.2  17.2   1.3</span><br><span class="line">  6. 68.86.90.25                   0.0%    10   14.2  16.4  14.2  20.3   1.9</span><br><span class="line">  7. 68.86.86.194                  0.0%    10   17.6  16.8  15.5  18.1   0.9</span><br><span class="line">  8. 75.149.230.194                0.0%    10   15.0  20.1  15.0  33.8   5.6</span><br><span class="line">  9. 72.14.238.232                 0.0%    10   15.6  18.7  14.1  32.8   5.9</span><br><span class="line"> 10. 209.85.241.148                0.0%    10   16.3  16.9  14.7  21.2   2.2</span><br><span class="line"> 11. 66.249.91.104                 0.0%    10   22.2  18.6  14.2  36.0   6.5</span><br></pre></td></tr></table></figure><p>不要为 100% 的丢包率所吓到，这并不表明这里有问题。你可以看打在接下来几跳是没有任何丢包的。</p><h3 id="运营商的路由器没有正确配置"><a href="#运营商的路由器没有正确配置" class="headerlink" title="运营商的路由器没有正确配置"></a>运营商的路由器没有正确配置</h3><p>有时候您的运营商的路由器配置原因，导致 ICMP 包永远不能到达目的地，例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@meiriyitie.com:~<span class="comment"># mtr --report www.google.com</span></span><br><span class="line">HOST: localhost                   Loss%   Snt   Last   Avg  Best  Wrst StDev</span><br><span class="line">  1. 63.247.74.43                  0.0%    10    0.3   0.6   0.3   1.2   0.3</span><br><span class="line">  2. 63.247.64.157                 0.0%    10    0.4   1.0   0.4   6.1   1.8</span><br><span class="line">  3. 209.51.130.213                0.0%    10    0.8   2.7   0.8  19.0   5.7</span><br><span class="line">  4. aix.pr1.atl.google.com        0.0%    10    6.7   6.8   6.7   6.9   0.1</span><br><span class="line">  5. ???                           0.0%    10    0.0   0.0   0.0   0.0   0.0</span><br><span class="line">  6. ???                           0.0%    10    0.0   0.0   0.0   0.0   0.0</span><br><span class="line">  7. ???                           0.0%    10    0.0   0.0   0.0   0.0   0.0</span><br><span class="line">  8. ???                           0.0%    10    0.0   0.0   0.0   0.0   0.0</span><br><span class="line">  9. ???                           0.0%    10    0.0   0.0   0.0   0.0   0.0</span><br><span class="line"> 10. ???                           0.0%    10    0.0   0.0   0.0   0.0   0.0</span><br></pre></td></tr></table></figure><p>当没有额外的路由信息时，将会显示问号（???），下面例子也一样：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@meiriyitie.com:~<span class="comment"># mtr --report www.google.com</span></span><br><span class="line">HOST: localhost                   Loss%   Snt   Last   Avg  Best  Wrst StDev</span><br><span class="line">   1. 63.247.74.43                 0.0%    10    0.3   0.6   0.3   1.2   0.3</span><br><span class="line">   2. 63.247.64.157                0.0%    10    0.4   1.0   0.4   6.1   1.8</span><br><span class="line">   3. 209.51.130.213               0.0%    10    0.8   2.7   0.8  19.0   5.7</span><br><span class="line">   4. aix.pr1.atl.google.com       0.0%    10    6.7   6.8   6.7   6.9   0.1</span><br><span class="line">   5. 172.16.29.45                 0.0%    10    0.0   0.0   0.0   0.0   0.0</span><br><span class="line">   6. ???                          0.0%    10    0.0   0.0   0.0   0.0   0.0 </span><br><span class="line">   7. ???                          0.0%    10    0.0   0.0   0.0   0.0   0.0</span><br><span class="line">   8. ???                          0.0%    10    0.0   0.0   0.0   0.0   0.0</span><br><span class="line">   9. ???                          0.0%    10    0.0   0.0   0.0   0.0   0.0</span><br><span class="line">  10. ???                          0.0%    10    0.0   0.0   0.0   0.0   0.0</span><br></pre></td></tr></table></figure><p>有时候，一个错误配置的路由器，将会在一个环路中不断发送数据包，如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@meiriyitie.com:~<span class="comment"># mtr --report www.google.com</span></span><br><span class="line">HOST: localhost                   Loss%   Snt   Last   Avg  Best  Wrst StDev</span><br><span class="line">  1. 63.247.74.43                  0.0%    10    0.3   0.6   0.3   1.2   0.3</span><br><span class="line">  2. 63.247.64.157                 0.0%    10    0.4   1.0   0.4   6.1   1.8</span><br><span class="line">  3. 209.51.130.213                0.0%    10    0.8   2.7   0.8  19.0   5.7</span><br><span class="line">  4. aix.pr1.atl.google.com        0.0%    10    6.7   6.8   6.7   6.9   0.1</span><br><span class="line">  5. 12.34.56.79                   0.0%    10    0.0   0.0   0.0   0.0   0.0</span><br><span class="line">  6. 12.34.56.78                   0.0%    10    0.0   0.0   0.0   0.0   0.0</span><br><span class="line">  7. 12.34.56.79                   0.0%    10    0.0   0.0   0.0   0.0   0.0</span><br><span class="line">  8. 12.34.56.78                   0.0%    10    0.0   0.0   0.0   0.0   0.0</span><br><span class="line">  9. 12.34.56.79                   0.0%    10    0.0   0.0   0.0   0.0   0.0</span><br><span class="line"> 10. 12.34.56.78                   0.0%    10    0.0   0.0   0.0   0.0   0.0</span><br><span class="line"> 11. 12.34.56.79                   0.0%    10    0.0   0.0   0.0   0.0   0.0</span><br><span class="line"> 12. ???                           0.0%    10    0.0   0.0   0.0   0.0   0.0</span><br><span class="line"> 13. ???                           0.0%    10    0.0   0.0   0.0   0.0   0.0</span><br><span class="line"> 14. ???                           0.0%    10    0.0   0.0   0.0   0.0   0.0</span><br></pre></td></tr></table></figure><p>通过报告可以看打第 4 跳的路由器没有正确配置。如果这种状况发生了，您可以连接当地的网络管理员或 ISP 解决问题。</p><h3 id="ICMP-速率限制"><a href="#ICMP-速率限制" class="headerlink" title="ICMP 速率限制"></a>ICMP 速率限制</h3><p>ICMP 速率限制可引起数据包的丢失。如果数据包在这一跳有丢失，但是下面几条都正常，我们可以判断是 ICMP 速率限制的原因。如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@meiriyitie.com:~<span class="comment"># mtr --report www.google.com</span></span><br><span class="line"> HOST: localhost                   Loss%   Snt   Last   Avg  Best  Wrst StDev</span><br><span class="line">   1. 63.247.74.43                  0.0%    10    0.3   0.6   0.3   1.2   0.3</span><br><span class="line">   2. 63.247.64.157                 0.0%    10    0.4   1.0   0.4   6.1   1.8</span><br><span class="line">   3. 209.51.130.213                0.0%    10    0.8   2.7   0.8  19.0   5.7</span><br><span class="line">   4. aix.pr1.atl.google.com        0.0%    10    6.7   6.8   6.7   6.9   0.1</span><br><span class="line">   5. 72.14.233.56                 60.0%    10   27.2  25.3  23.1  26.4   2.9</span><br><span class="line">   6. 209.85.254.247                0.0%    10   39.1  39.4  39.1  39.7   0.2</span><br><span class="line">   7. 64.233.174.46                 0.0%    10   39.6  40.4  39.4  46.9   2.3</span><br><span class="line">   8. gw-in-f147.1e100.net          0.0%    10   39.6  40.5  39.5  46.7   2.2</span><br></pre></td></tr></table></figure><p>这种状况是没关系的。ICMP 速率限制是一种常见的手段，这样可以减少网络数据的负载，让更重要的流量先通过。</p><h3 id="超时"><a href="#超时" class="headerlink" title="超时"></a>超时</h3><p>在很多种情况下会发生超时现象。例如：很多路由器可能会直接丢弃 ICMP 包，这时就会导致超时（???）。另外，也有可能在数据返回的路上出现了问题。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@meiriyitie.com:~<span class="comment"># mtr --report www.google.com</span></span><br><span class="line">HOST: localhost                   Loss%   Snt   Last   Avg  Best  Wrst StDev</span><br><span class="line">  1. 63.247.74.43                  0.0%    10    0.3   0.6   0.3   1.2   0.3</span><br><span class="line">  2. 63.247.64.157                 0.0%    10    0.4   1.0   0.4   6.1   1.8</span><br><span class="line">  3. 209.51.130.213                0.0%    10    0.8   2.7   0.8  19.0   5.7</span><br><span class="line">  4. aix.pr1.atl.google.com        0.0%    10    6.7   6.8   6.7   6.9   0.1</span><br><span class="line">  5. ???                           0.0%    10    7.2   8.3   7.1  16.4   2.9</span><br><span class="line">  6. ???                           0.0%    10   39.1  39.4  39.1  39.7   0.2</span><br><span class="line">  7. 64.233.174.46                 0.0%    10   39.6  40.4  39.4  46.9   2.3</span><br><span class="line">  8. gw-in-f147.1e100.net          0.0%    10   39.6  40.5  39.5  46.7   2.2</span><br></pre></td></tr></table></figure><p>超时不一定是数据包被丢失。如上例，数据包还是安全的到达目的地并且返回。中间节点的超时可能是路由器配置丢弃 ICMP 包，或者 QoS 设置引起的原因，这个是没关系的。</p><h2 id="MTR-客户端"><a href="#MTR-客户端" class="headerlink" title="MTR 客户端"></a>MTR 客户端</h2><p>Windows，macOS，Linux 基本都可以很方便的下载执行 mtr 命令，但 Android 和 iOS 需要安装独立的 APP</p><ul><li>Android: <a href="https://play.google.com/store/apps/details?id=com.inflim.trp" target="_blank" rel="noopener">TracePing</a></li><li>iOS: <a href="https://apps.apple.com/sg/app/beenettools/id1160138136?ign-mpt=uo%3D4" target="_blank" rel="noopener">BeeNetTools</a></li></ul><h2 id="MTR-使用小结"><a href="#MTR-使用小结" class="headerlink" title="MTR 使用小结"></a>MTR 使用小结</h2><ol><li>mtr 的功能是检查在目的地址有丢包的情况下，查出具体在哪一跳丢包，然后反馈给机房，机房再反馈给运营商；</li><li>看 mtr 的截图，先看最后的目的地址是否有丢包，若最后一跳没有丢包，说明线路 ok，若最后一跳有丢包，往下看；</li><li>再看在路由情况，第一次丢包发生在哪一跳，对应的查这一跳的丢包情况即可；</li><li>如果有条件建议双向测试抓取 mtr 返回结果，对比路由是否对等；</li><li>整理邮件发送机房联系本地网络服务商 ISP 或者云主机服务商请求技术支持。</li></ol>]]></content>
    
    <summary type="html">
    
      使用 MTR 诊断网络问题
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>飞猪 F3 会员特价入住成都东大明宇豪雅饭店免费升级行政套房的体验报告</title>
    <link href="https://wsgzao.github.io/post/fliggy/"/>
    <id>https://wsgzao.github.io/post/fliggy/</id>
    <published>2019-10-18T08:40:53.000Z</published>
    <updated>2019-10-23T02:49:37.565Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>2019 年 10 月请了 10 天年假凑了 2 周时间陪老婆从新加坡回四川，再也买不到去年 800 元人民币从新加坡往返成都的 Bug 机票了。标题中出现了 2 个关键词 <code>飞猪 F3 会员</code> 和 <code>成都东大明宇豪雅饭店</code>，我很少会把会员权益单独拎出来写比如从 2017 年使用至今的浦发银行美国运通白金卡 (简称浦发 AE 白)，当时很热门号称神卡就随手网申没想到很幸运地一次通过，目前使用频率最高的也只有机场贵宾厅和接送机服务，20w 积分按年抵扣应该还可以撑 7 年吧，各位对玩信用卡感兴趣可以搜索 DS 三白，浦发 AE 白，招行经典白，交行白麒麟，等花呗权益增强后估计也可以注销信用卡了。飞猪 F3 会员权益隐藏的太深导致我差点入了成都华尔道夫酒店的坑，而使用飞猪 F3 权益可以匹配明宇酒店钻石卡并享受到成都东大明宇豪雅饭店免费升级行政套房，真实入住后的服务体验也远远超出了我的预期，如果我每年都来成都耍那一定会再次选择成都东大明宇豪雅饭店。鉴于国内 OTA 综合性旅游出行服务平台已经被携程垄断，负面新闻时而刷屏但竞争者基本都被收购了，既然我入了飞猪的坑那就借这个机会和大家简单唠叨唠叨吧。</p><blockquote><p>飞猪 F3 会员特价入住成都东大明宇豪雅饭店免费升级行政套房的体验报告</p></blockquote><h2 id="更新记录"><a href="#更新记录" class="headerlink" title="更新记录"></a>更新记录</h2><p>2019 年 10 月 18 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/fliggy/">https://wsgzao.github.io/post/fliggy/</a></p><p><strong> 扩展阅读 </strong></p><p><a href="https://www.fliggy.com/" target="_blank" rel="noopener">飞猪</a><br><a href="http://www.minyounhotels.com/" target="_blank" rel="noopener">明宇酒店</a></p><h2 id="出行记录简述"><a href="#出行记录简述" class="headerlink" title="出行记录简述"></a>出行记录简述</h2><ol><li>计划前往九寨沟 3 天 2 晚未果，无奈转战黄龙。据说高铁 2020 年贯通从成都直达九寨沟只要 2 小时。</li><li>机票和高铁不相关（跳过）</li><li>在成都停留了 3 个晚上，成功打卡 1 家黑珍珠，3 家必吃榜，还有若干建设路小吃</li></ol><h2 id="飞猪-F3-会员权益"><a href="#飞猪-F3-会员权益" class="headerlink" title="飞猪 F3 会员权益"></a>飞猪 F3 会员权益</h2><p>飞猪背靠阿里，目前已经打通了多家航司和酒店的会员体系，如果各位需要比价参考直接选择携程或者 Booking，机票通常是航空公司官网直销比较便宜。</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191016190044.png" alt=""></p><p>我个人目前使用过的 F3 权益:</p><ol><li>酒店特权价，记住每周四和每月 28 日购买最划算，一定要点击图片中正确的入口才能享受</li><li>新航 KrisFlyer 精英金卡，一年有效期但体验很好</li><li>明宇酒店钻石卡，以后只要来成都玩我一定会再次入住成都东大明宇豪雅饭店</li><li>龙腾贵宾厅，如果没有银行信用卡加持可以选择飞猪里程兑换</li></ol><p>大量其它权益可以点击下面的链接查看，我就不再赘述了。</p><p><a href="https://www.douban.com/note/726673818/" target="_blank" rel="noopener">你一定要看的飞猪 F3 撸羊毛攻略</a></p><p>更便宜的渠道一定是客观存在的，你也可以上闲鱼或转转碰碰运气。</p><h2 id="成都东大明宇豪雅饭店"><a href="#成都东大明宇豪雅饭店" class="headerlink" title="成都东大明宇豪雅饭店"></a>成都东大明宇豪雅饭店</h2><blockquote><p>大众点评成都必住榜之一</p></blockquote><p>中文: 成都东大明宇豪雅饭店 - 璞富腾会员酒店<br>英文: Minyoun Chengdu Dongda Hotel - Member of Preferred Hotels &amp; Resorts</p><p>成都东大明宇豪雅饭店地址：<br>四川省・成都・锦江区・成都市锦江区东大街紫东楼段 39 号 (一环路与东大街交汇处，东门大桥地铁站旁，临近太古里)</p><p>购买的原始房型和升级后的房型：</p><ul><li>经典客房大床吸烟，395¥</li><li>豪雅套房，72㎡（和行政套房的差异除了价格，主要是内饰主题比如 HelloKitty、小黄人等，推荐带小朋友的家庭入住）</li></ul><p>我选择主动发邮件和酒店提前 1 个月沟通自己的需求，<a href="mailto:myclub@minyounhotels.com" target="_blank" rel="noopener">myclub@minyounhotels.com</a></p><ol><li>是否可以升级至套房，长这么大还没体验过</li><li>早上 7 点前离开酒店是否可以提前准备早餐或者打包早餐</li></ol><p>其他相关需求也可以咨询，比如:</p><ol><li>是否携带小孩家属</li><li>是否吸烟</li><li>是否需要高层</li><li>是否远离电梯</li></ol><p>关于反馈和沟通</p><ol><li>可爱的 Lucy Yang 小姐姐在我发送邮件后当天晚上直接添加微信告知一切已经打点妥当，非常的效率，点赞加鸡腿</li><li>在准备入住的前一天酒店还会再次电话确认具体的到达时间，是否有新的需求，比心</li></ol><h2 id="酒店细节图片展示"><a href="#酒店细节图片展示" class="headerlink" title="酒店细节图片展示"></a>酒店细节图片展示</h2><h3 id="地理位置"><a href="#地理位置" class="headerlink" title="地理位置"></a>地理位置</h3><ol><li>乘坐地铁选择东门大桥或者牛王庙站下，步行 5 分钟左右就到了</li><li>离成都太古里地铁 1 站，步行 15-20 分钟，很方便的</li></ol><h3 id="酒店细节"><a href="#酒店细节" class="headerlink" title="酒店细节"></a>酒店细节</h3><ol><li>酒店从明宇金融广场背后进入，酒店大堂在 33F，空间大且没有嘈杂的人群</li><li>如果你也和我一样升级行政客房级别以上，可以享受免费下午茶和夜床服务，洗漱用品配备了欧舒丹</li></ol><h3 id="早餐和下午茶"><a href="#早餐和下午茶" class="headerlink" title="早餐和下午茶"></a>早餐和下午茶</h3><ol><li>早餐很丰盛，红油抄手、钟水饺、赖汤圆之类的成都小吃以及常见的中餐和西餐都可以满足你</li><li>下午茶比较简单，我主要点了咖啡和无酒精鸡尾酒，还提供可口的小吃、水果和冷串串</li></ol><p><a href="http://www.flyertea.com/thread-3229227-1-1.html" target="_blank" rel="noopener">http://www.flyertea.com/thread-3229227-1-1.html</a></p><p><a href="https://post.smzdm.com/p/a25g59q2/" target="_blank" rel="noopener">https://post.smzdm.com/p/a25g59q2/</a></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol><li>飞猪 F3 会员有很多福利，我也只是按自己所需列举冰山一角，如何快速升级和查看更多权益，飞猪 APP 和微信公众号都列举的比较清晰了</li><li>成都东大明宇豪雅饭店的入住体验超出自己期望，钻石卡会籍除了和飞猪 F3 匹配以外还支持京东钻石会员以及部分航空公司会员，放弃了 899 购买成都华尔道夫我认为是划得来的，而酒店的钻石卡有效期居然是到 2049 年，假如每年来成都耍都能以如此优惠的价格享受高品质的服务是我的荣幸。</li><li>写真实客观的旅游文章码字和传图片都不容易，如果文章对你有帮助欢迎留言交流，点赞和转发支持，谢谢啦。</li></ol>]]></content>
    
    <summary type="html">
    
      飞猪F3会员特价入住成都东大明宇豪雅饭店免费升级行政套房的体验报告
    
    </summary>
    
      <category term="生活 | Life" scheme="https://wsgzao.github.io/categories/%E7%94%9F%E6%B4%BB-Life/"/>
    
    
  </entry>
  
  <entry>
    <title>在浏览器输入 URL 回车之后发生了什么</title>
    <link href="https://wsgzao.github.io/post/url/"/>
    <id>https://wsgzao.github.io/post/url/</id>
    <published>2019-10-16T05:34:32.000Z</published>
    <updated>2020-01-02T02:28:12.726Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>相信大家作为求职者或者面试官大概率都会遇到一道古老的面试问题：当你在浏览器中输入 google.com 并且按下回车之后发生了什么？这个问题可以考察的面非常广，针对不同岗位侧重点也不一样，更重要的是可以根据对方的回答挖掘知识掌握深度。本文授权转载自 @4Ark 的 Blog，原文虽然偏向前端但作者整理的内容已经非常全面了，如果各位想深入了解可以访问参考文档。</p><blockquote><p>在浏览器输入 URL 回车之后发生了什么</p></blockquote><hr><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 10 月 16 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/url/">https://wsgzao.github.io/post/url/</a></p><p><strong> 授权转载 </strong></p><p><a href="https://4ark.me/post/b6c7c0a2.html" target="_blank" rel="noopener">在浏览器输入 URL 回车之后发生了什么（超详细版）</a></p><hr><h2 id="转载原文前言"><a href="#转载原文前言" class="headerlink" title="转载原文前言"></a>转载原文前言</h2><p>这个问题已经是老生常谈了，更是经常被作为面试的压轴题出现，网上也有很多文章，但最近闲的无聊，然后就自己做了一篇笔记，感觉比之前理解更透彻了。</p><p>这篇笔记是我这两天看了数十篇文章总结出来的，所以相对全面一点，但由于我是做前端的，所以会比较重点分析浏览器渲染页面那一部分，至于其他部分我会罗列出关键词，感兴趣的可以自行查阅，</p><p><strong> 注意：</strong> 本文的步骤是建立在，请求的是一个简单的 HTTP 请求，没有 HTTPS、HTTP2、最简单的 DNS、没有代理、并且服务器没有任何问题的基础上，尽管这是不切实际的。</p><h2 id="大致流程"><a href="#大致流程" class="headerlink" title="大致流程"></a><a href="# 大致流程" title="大致流程"></a>大致流程</h2><ol><li>URL 解析</li><li>DNS 查询</li><li>TCP 连接</li><li>处理请求</li><li>接受响应</li><li>渲染页面</li></ol><h2 id="一、URL-解析"><a href="#一、URL-解析" class="headerlink" title="一、URL 解析"></a><a href="# 一、URL - 解析" title="一、URL 解析"></a>一、URL 解析</h2><p><strong> 地址解析：</strong></p><p>首先判断你输入的是一个合法的 URL 还是一个待搜索的关键词，并且根据你输入的内容进行自动完成、字符编码等操作。</p><p><strong>HSTS</strong></p><p>由于安全隐患，会使用 HSTS 强制客户端使用 HTTPS 访问页面。详见：<a href="https://www.barretlee.com/blog/2015/10/22/hsts-intro/" target="_blank" rel="noopener">你所不知道的 HSTS</a>。</p><p><strong> 其他操作 </strong></p><p>浏览器还会进行一些额外的操作，比如安全检查、访问限制（之前国产浏览器限制 996.icu）。</p><p><strong> 检查缓存 </strong></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191016150329.png" alt=""></p><h2 id="二、DNS-查询"><a href="#二、DNS-查询" class="headerlink" title="二、DNS 查询"></a><a href="# 二、DNS - 查询" title="二、DNS 查询"></a>二、DNS 查询</h2><p><strong> 基本步骤 </strong></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191016150347.png" alt=""></p><p><strong>1. 浏览器缓存 </strong></p><p>浏览器会先检查是否在缓存中，没有则调用系统库函数进行查询。</p><p><strong>2. 操作系统缓存 </strong></p><p>操作系统也有自己的 DNS 缓存，但在这之前，会向检查域名是否存在本地的 Hosts 文件里，没有则向 DNS 服务器发送查询请求。</p><p><strong>3. 路由器缓存 </strong></p><p>路由器也有自己的缓存。</p><p><strong>4. ISP DNS 缓存 </strong></p><p>ISP DNS 就是在客户端电脑上设置的首选 DNS 服务器，它们在大多数情况下都会有缓存。</p><p><strong> 根域名服务器查询 </strong></p><p>在前面所有步骤没有缓存的情况下，本地 DNS 服务器会将请求转发到互联网上的根域，下面这个图很好的诠释了整个流程：</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191016150404.png" alt=""></p><blockquote><p>根域名服务器：<a href="https://zh.wikipedia.org/wiki/%E6%A0%B9%E7%B6%B2%E5%9F%9F%E5%90%8D%E7%A8%B1%E4%BC%BA%E6%9C%8D%E5%99%A8" target="_blank" rel="noopener">维基百科</a></p></blockquote><p><strong> 需要注意的点 </strong></p><ol><li>递归方式：一路查下去中间不返回，得到最终结果才返回信息（浏览器到本地 DNS 服务器的过程）</li><li>迭代方式，就是本地 DNS 服务器到根域名服务器查询的方式。</li><li>什么是 DNS 劫持</li><li>前端 dns-prefetch 优化</li></ol><h2 id="三、TCP-连接"><a href="#三、TCP-连接" class="headerlink" title="三、TCP 连接"></a><a href="# 三、TCP - 连接" title="三、TCP 连接"></a>三、TCP 连接</h2><p>TCP/IP 分为四层，在发送数据时，每层都要对数据进行封装：</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191016150420.png" alt=""></p><h3 id="1-应用层：发送-HTTP-请求"><a href="#1-应用层：发送-HTTP-请求" class="headerlink" title="1. 应用层：发送 HTTP 请求 "></a><a href="#1 - 应用层：发送 - HTTP - 请求" title="1. 应用层：发送 HTTP 请求"></a><strong>1. 应用层：发送 HTTP 请求 </strong></h3><p>在前面的步骤我们已经得到服务器的 IP 地址，浏览器会开始构造一个 HTTP 报文，其中包括：</p><ul><li>请求报头（Request Header）：请求方法、目标地址、遵循的协议等等</li><li>请求主体（其他参数）</li></ul><p>其中需要注意的点：</p><ul><li>浏览器只能发送 GET、POST 方法，而打开网页使用的是 GET 方法</li></ul><h3 id="2-传输层：TCP-传输报文"><a href="#2-传输层：TCP-传输报文" class="headerlink" title="2. 传输层：TCP 传输报文 "></a><a href="#2 - 传输层：TCP - 传输报文" title="2. 传输层：TCP 传输报文"></a><strong>2. 传输层：TCP 传输报文 </strong></h3><p>传输层会发起一条到达服务器的 TCP 连接，为了方便传输，会对数据进行分割（以报文段为单位），并标记编号，方便服务器接受时能够准确地还原报文信息。</p><p>在建立连接前，会先进行 TCP 三次握手。</p><blockquote><p>关于 TCP/IP 三次握手，网上已经有很多段子和图片生动地描述了。</p><p>相关知识点：</p><ol><li>SYN 泛洪攻击</li></ol></blockquote><h3 id="3-网络层：IP-协议查询-Mac-地址"><a href="#3-网络层：IP-协议查询-Mac-地址" class="headerlink" title="3. 网络层：IP 协议查询 Mac 地址 "></a><a href="#3 - 网络层：IP 协议查询 Mac 地址" title="3. 网络层：IP 协议查询 Mac 地址"></a><strong>3. 网络层：IP 协议查询 Mac 地址 </strong></h3><p>将数据段打包，并加入源及目标的 IP 地址，并且负责寻找传输路线。</p><p>判断目标地址是否与当前地址处于同一网络中，是的话直接根据 Mac 地址发送，否则使用路由表查找下一跳地址，以及使用 ARP 协议查询它的 Mac 地址。</p><blockquote><p>注意：在 OSI 参考模型中 ARP 协议位于链路层，但在 TCP/IP 中，它位于网络层。</p></blockquote><h3 id="4-链路层：以太网协议"><a href="#4-链路层：以太网协议" class="headerlink" title="4. 链路层：以太网协议 "></a><a href="#4 - 链路层：以太网协议" title="4. 链路层：以太网协议"></a><strong>4. 链路层：以太网协议 </strong></h3><p><strong> 以太网协议 </strong></p><p>根据以太网协议将数据分为以 “帧” 为单位的数据包，每一帧分为两个部分：</p><ul><li>标头：数据包的发送者、接受者、数据类型</li><li>数据：数据包具体内容</li></ul><p><strong>Mac 地址 </strong></p><p>以太网规定了连入网络的所有设备都必须具备 “网卡” 接口，数据包都是从一块网卡传递到另一块网卡，网卡的地址就是 Mac 地址。每一个 Mac 地址都是独一无二的，具备了一对一的能力。</p><p><strong> 广播 </strong></p><p>发送数据的方法很原始，直接把数据通过 ARP 协议，向本网络的所有机器发送，接收方根据标头信息与自身 Mac 地址比较，一致就接受，否则丢弃。</p><p><strong> 注意 </strong>：接收方回应是单播。</p><blockquote><p>相关知识点：</p><ol><li>ARP 攻击</li></ol></blockquote><h4 id="服务器接受请求"><a href="#服务器接受请求" class="headerlink" title=" 服务器接受请求 "></a><a href="# 服务器接受请求" title="服务器接受请求"></a><strong> 服务器接受请求 </strong></h4><p>接受过程就是把以上步骤逆转过来，参见上图。</p><h2 id="四、服务器处理请求"><a href="#四、服务器处理请求" class="headerlink" title="四、服务器处理请求"></a><a href="# 四、服务器处理请求" title="四、服务器处理请求"></a>四、服务器处理请求</h2><p><strong> 大致流程 </strong></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191016150439.png" alt=""></p><p><strong>HTTPD</strong></p><p>最常见的 HTTPD 有 Linux 上常用的 Apache 和 Nginx，以及 Windows 上的 IIS。</p><p>它会监听得到的请求，然后开启一个子进程去处理这个请求。</p><p><strong> 处理请求 </strong></p><p>接受 TCP 报文后，会对连接进行处理，对 HTTP 协议进行解析（请求方法、域名、路径等），并且进行一些验证：</p><ul><li>验证是否配置虚拟主机</li><li>验证虚拟主机是否接受此方法</li><li>验证该用户可以使用该方法（根据 IP 地址、身份信息等）</li></ul><p><strong> 重定向 </strong></p><p>假如服务器配置了 HTTP 重定向，就会返回一个 <code>301</code> 永久重定向响应，浏览器就会根据响应，重新发送 HTTP 请求（重新执行上面的过程）。</p><blockquote><p>关于更多：<a href="https://www.cnblogs.com/workest/p/3891321.html" target="_blank" rel="noopener">详见这篇文章</a></p></blockquote><p><strong>URL 重写 </strong></p><p>然后会查看 URL 重写规则，如果请求的文件是真实存在的，比如图片、html、css、js 文件等，则会直接把这个文件返回。</p><p>否则服务器会按照规则把请求重写到 一个 REST 风格的 URL 上。</p><p>然后根据动态语言的脚本，来决定调用什么类型的动态文件解释器来处理这个请求。</p><p>以 PHP 语言的 MVC 框架举例，它首先会初始化一些环境的参数，根据 URL 由上到下地去匹配路由，然后让路由所定义的方法去处理请求。</p><h2 id="五、浏览器接受响应"><a href="#五、浏览器接受响应" class="headerlink" title="五、浏览器接受响应"></a><a href="# 五、浏览器接受响应" title="五、浏览器接受响应"></a>五、浏览器接受响应</h2><p>浏览器接收到来自服务器的响应资源后，会对资源进行分析。</p><p>首先查看 Response header，根据不同状态码做不同的事（比如上面提到的重定向）。</p><p>如果响应资源进行了压缩（比如 gzip），还需要进行解压。</p><p>然后，对响应资源做缓存。</p><p>接下来，根据响应资源里的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_types" target="_blank" rel="noopener">MIME</a> 类型去解析响应内容（比如 HTML、Image 各有不同的解析方式）。</p><h2 id="六、渲染页面"><a href="#六、渲染页面" class="headerlink" title="六、渲染页面"></a><a href="# 六、渲染页面" title="六、渲染页面"></a>六、渲染页面</h2><p><strong> 浏览器内核 </strong></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191016150457.png" alt=""></p><p>不同的浏览器内核，渲染过程也不完全相同，但大致流程都差不多。</p><p><strong> 基本流程 </strong></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191016150513.png" alt=""></p><h3 id="1-HTML-解析"><a href="#1-HTML-解析" class="headerlink" title="1.HTML 解析 "></a><a href="#1-HTML - 解析" title="1.HTML 解析"></a><strong>1.HTML 解析 </strong></h3><p>首先要知道浏览器解析是从上往下一行一行地解析的。</p><p>解析的过程可以分为四个步骤：</p><p><strong>1. 解码（encoding）</strong></p><p>传输回来的其实都是一些二进制字节数据，浏览器需要根据文件指定编码（例如 UTF-8）转换成字符串，也就是 HTML 代码。</p><p><strong>2. 预解析（pre-parsing）</strong></p><p>预解析做的事情是提前加载资源，减少处理时间，它会识别一些会请求资源的属性，比如 <code>img</code> 标签的 <code>src</code> 属性，并将这个请求加到请求队列中。</p><p><strong>3. 符号化（Tokenization）</strong></p><p>符号化是词法分析的过程，将输入解析成符号，HTML 符号包括，开始标签、结束标签、属性名和属性值。</p><p>它通过一个状态机去识别符号的状态，比如遇到 <code>&lt;</code>，<code>&gt;</code> 状态都会产生变化。</p><p><strong>4. 构建树（tree construction）</strong></p><blockquote><p>注意：符号化和构建树是并行操作的，也就是说只要解析到一个开始标签，就会创建一个 DOM 节点。</p></blockquote><p>在上一步符号化中，解析器获得这些标记，然后以合适的方法创建 <code>DOM</code> 对象并把这些符号插入到 <code>DOM</code> 对象中。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;Web page parsing&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        &lt;h1&gt;Web page parsing&lt;/h1&gt;</span><br><span class="line">        &lt;p&gt;This is an example Web page.&lt;/p&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191016150529.png" alt=""></p><p><strong> 浏览器容错进制 </strong></p><p>你从来没有在浏览器看过类似” 语法无效” 的错误，这是因为浏览器去纠正错误的语法，然后继续工作。</p><p><strong> 事件 </strong></p><p>当整个解析的过程完成以后，浏览器会通过 <code>DOMContentLoaded</code> 事件来通知 <code>DOM</code> 解析完成。</p><h3 id="2-CSS-解析"><a href="#2-CSS-解析" class="headerlink" title="2. CSS 解析"></a><a href="#2-CSS - 解析" title="2. CSS 解析"></a>2. CSS 解析</h3><p>一旦浏览器下载了 CSS，CSS 解析器就会处理它遇到的任何 CSS，根据 <a href="https://drafts.csswg.org/css-syntax-3/" target="_blank" rel="noopener">语法规范</a> 解析出所有的 CSS 并进行标记化，然后我们得到一个规则表。</p><p><strong>CSS 匹配规则 </strong></p><p>在匹配一个节点对应的 CSS 规则时，是按照从右到左的顺序的，例如：<code>div p { font-size :14px }</code> 会先寻找所有的 <code>p</code> 标签然后判断它的父元素是否为 <code>div</code>。</p><p>所以我们写 CSS 时，尽量用 id 和 class，千万不要过度层叠。</p><h3 id="3-渲染树"><a href="#3-渲染树" class="headerlink" title="3. 渲染树"></a><a href="#3 - 渲染树" title="3. 渲染树"></a>3. 渲染树</h3><p>其实这就是一个 DOM 树和 CSS 规则树合并的过程。</p><blockquote><p>注意：渲染树会忽略那些不需要渲染的节点，比如设置了 <code>display:none</code> 的节点。</p></blockquote><p><strong> 计算 </strong></p><p>通过计算让任何尺寸值都减少到三个可能之一：<code>auto</code>、百分比、px，比如把 <code>rem</code> 转化为 <code>px</code>。</p><p><strong> 级联 </strong></p><p>浏览器需要一种方法来确定哪些样式才真正需要应用到对应元素，所以它使用一个叫做 <code>specificity</code> 的公式，这个公式会通过：</p><ol><li>标签名、class、id</li><li>是否内联样式</li><li><code>!important</code></li></ol><p>然后得出一个权重值，取最高的那个。</p><p><strong> 渲染阻塞 </strong></p><p>当遇到一个 <code>script</code> 标签时，DOM 构建会被暂停，直至脚本完成执行，然后继续构建 DOM 树。</p><p>但如果 JS 依赖 CSS 样式，而它还没有被下载和构建时，浏览器就会延迟脚本执行，直至 CSS Rules 被构建。</p><p>所有我们知道：</p><ul><li>CSS 会阻塞 JS 执行</li><li>JS 会阻塞后面的 DOM 解析</li></ul><p>为了避免这种情况，应该以下原则：</p><ul><li>CSS 资源排在 JavaScript 资源前面</li><li>JS 放在 HTML 最底部，也就是 <code>&lt;/body&gt;</code> 前</li></ul><p>另外，如果要改变阻塞模式，可以使用 defer 与 async，详见：<a href="https://github.com/xiaoyu2er/blog/issues/8" target="_blank" rel="noopener">这篇文章</a></p><h4 id="4-布局与绘制"><a href="#4-布局与绘制" class="headerlink" title="4. 布局与绘制"></a><a href="#4 - 布局与绘制" title="4. 布局与绘制"></a>4. 布局与绘制</h4><p>确定渲染树种所有节点的几何属性，比如：位置、大小等等，最后输入一个盒子模型，它能精准地捕获到每个元素在屏幕内的准确位置与大小。</p><p>然后遍历渲染树，调用渲染器的 paint () 方法在屏幕上显示其内容。</p><h4 id="5-合并渲染层"><a href="#5-合并渲染层" class="headerlink" title="5. 合并渲染层 "></a><a href="#5 - 合并渲染层" title="5. 合并渲染层"></a><strong>5. 合并渲染层 </strong></h4><p>把以上绘制的所有图片合并，最终输出一张图片。</p><h4 id="6-回流与重绘"><a href="#6-回流与重绘" class="headerlink" title="6. 回流与重绘 "></a><a href="#6 - 回流与重绘" title="6. 回流与重绘"></a><strong>6. 回流与重绘 </strong></h4><p><strong> 回流 (reflow)</strong></p><p>当浏览器发现某个部分发现变化影响了布局时，需要倒回去重新渲染，会从 <code>html</code> 标签开始递归往下，重新计算位置和大小。</p><p>reflow 基本是无法避免的，因为当你滑动一下鼠标、resize 窗口，页面就会产生变化。</p><p><strong> 重绘 (repaint)</strong></p><p>改变了某个元素的背景色、文字颜色等等不会影响周围元素的位置变化时，就会发生重绘。</p><p>每次重绘后，浏览器还需要合并渲染层并输出到屏幕上。</p><p>回流的成本要比重绘高很多，所以我们应该尽量避免产生回流。</p><p>比如：</p><ul><li><code>display:none</code> 会触发回流，而 <code>visibility:hidden</code> 只会触发重绘。</li></ul><h4 id="7-JavaScript-编译执行"><a href="#7-JavaScript-编译执行" class="headerlink" title="7. JavaScript 编译执行"></a><a href="#7-JavaScript - 编译执行" title="7. JavaScript 编译执行"></a>7. JavaScript 编译执行</h4><p><strong> 大致流程 </strong></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191016150545.png" alt=""></p><p>可以分为三个阶段：</p><h4 id="1-词法分析"><a href="#1-词法分析" class="headerlink" title="1. 词法分析 "></a><a href="#1 - 词法分析" title="1. 词法分析"></a><strong>1. 词法分析 </strong></h4><p>JS 脚本加载完毕后，会首先进入语法分析阶段，它首先会分析代码块的语法是否正确，不正确则抛出 “语法错误”，停止执行。</p><p>几个步骤：</p><ul><li>分词，例如将 <code>var a = 2</code>，，分成 <code>var</code>、<code>a</code>、<code>=</code>、<code>2</code> 这样的词法单元。</li><li>解析，将词法单元转换成抽象语法树（AST）。</li><li>代码生成，将抽象语法树转换成机器指令。</li></ul><h4 id="2-预编译"><a href="#2-预编译" class="headerlink" title="2. 预编译 "></a><a href="#2 - 预编译" title="2. 预编译"></a><strong>2. 预编译 </strong></h4><p>JS 有三种运行环境：</p><ul><li>全局环境</li><li>函数环境</li><li>eval</li></ul><p>每进入一个不同的运行环境都会创建一个对应的执行上下文，根据不同的上下文环境，形成一个函数调用栈，栈底永远是全局执行上下文，栈顶则永远是当前执行上下文。</p><p><strong> 创建执行上下文 </strong></p><p>创建执行上下文的过程中，主要做了以下三件事：</p><ul><li>创建变量对象<ul><li>参数、函数、变量</li></ul></li><li>建立作用域链<ul><li>确认当前执行环境是否能访问变量</li></ul></li><li>确定 This 指向</li></ul><h4 id="3-执行"><a href="#3-执行" class="headerlink" title="3. 执行 "></a><a href="#3 - 执行" title="3. 执行"></a><strong>3. 执行 </strong></h4><p><strong>JS 线程 </strong></p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191016150601.png" alt=""></p><p>虽然 JS 是单线程的，但实际上参与工作的线程一共有四个：</p><blockquote><p>其中三个只是协助，只有 JS 引擎线程是真正执行的</p></blockquote><ul><li>JS 引擎线程：也叫 JS 内核，负责解析执行 JS 脚本程序的主线程，例如 V8 引擎</li><li>事件触发线程：属于浏览器内核线程，主要用于控制事件，例如鼠标、键盘等，当事件被触发时，就会把事件的处理函数推进事件队列，等待 JS 引擎线程执行</li><li>定时器触发线程：主要控制 <code>setInterval</code> 和 <code>setTimeout</code>，用来计时，计时完毕后，则把定时器的处理函数推进事件队列中，等待 JS 引擎线程。</li><li>HTTP 异步请求线程：通过 XMLHttpRequest 连接后，通过浏览器新开的一个线程，监控 readyState 状态变更时，如果设置了该状态的回调函数，则将该状态的处理函数推进事件队列中，等待 JS 引擎线程执行。</li></ul><p><strong> 注：浏览器对同一域名的并发连接数是有限的，通常为 6 个。</strong></p><p><strong> 宏任务 </strong></p><p>分为：</p><ul><li>同步任务：按照顺序执行，只有前一个任务完成后，才能执行后一个任务</li><li>异步任务：不直接执行，只有满足触发条件时，相关的线程将该异步任务推进任务队列中，等待 JS 引擎主线程上的任务执行完毕时才开始执行，例如异步 Ajax、DOM 事件，setTimeout 等。</li></ul><p><strong> 微任务 </strong></p><p>微任务是 ES6 和 Node 环境下的，主要 API 有：<code>Promise</code>，<code>process.nextTick</code>。</p><p>微任务的执行在宏任务的同步任务之后，在异步任务之前。</p><p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191016150616.png" alt=""></p><p><strong> 代码例子 </strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">console.log(&apos;1&apos;); // 宏任务 同步</span><br><span class="line"></span><br><span class="line">setTimeout(function() &#123;</span><br><span class="line">    console.log(&apos;2&apos;); // 宏任务 异步</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">new Promise(function(resolve) &#123;</span><br><span class="line">    console.log(&apos;3&apos;); // 宏任务 同步</span><br><span class="line">    resolve();</span><br><span class="line">&#125;).then(function() &#123;</span><br><span class="line">    console.log(&apos;4&apos;) // 微任务</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">console.log(&apos;5&apos;) // 宏任务 同步</span><br></pre></td></tr></table></figure><p>以上代码输出顺序为：1,3,5,4,2</p><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a><a href="# 参考文档" title="参考文档"></a>参考文档</h2><ul><li><a href="https://github.com/skyline75489/what-happens-when-zh_CN" target="_blank" rel="noopener">what-happens-when-zh_CN</a></li><li><a href="https://alistapart.com/article/tags-to-dom/" target="_blank" rel="noopener">Tags to DOM</a></li><li><a href="https://heyingye.github.io/2018/04/16/%E5%BD%BB%E5%BA%95%E7%90%86%E8%A7%A3%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6/" target="_blank" rel="noopener">彻底理解浏览器的缓存机制</a></li><li><a href="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/#The_rendering_engine" target="_blank" rel="noopener">浏览器的工作原理：新式网络浏览器幕后揭秘</a></li><li><a href="https://blog.fundebug.com/2019/01/03/understand-browser-rendering/" target="_blank" rel="noopener">深入浅出浏览器渲染原理</a></li><li><a href="https://heyingye.github.io/2018/03/19/js%E5%BC%95%E6%93%8E%E7%9A%84%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B%EF%BC%88%E4%B8%80%EF%BC%89/#%E9%A2%84%E7%BC%96%E8%AF%91%E9%98%B6%E6%AE%B5" target="_blank" rel="noopener">js 引擎的执行过程（一）</a></li><li>还有一些找不到了。。。。。</li></ul><p><a href="https://blog.5udou.cn/blog/Shen-Wei-Qian-Duan-Ni-Bu-De-Bu-Dong-De-Yi-Xie-HTTPZhi-Shi-Fu-Zeng-3Dao-Mian-Shi-Ti-95?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io#wrapper" target="_blank" rel="noopener">身为前端，你不得不懂的一些 HTTP 知识(附赠 3 道面试题)</a></p>]]></content>
    
    <summary type="html">
    
      在浏览器输入URL回车之后发生了什么
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>Google Chrome 浏览器插件和油猴脚本推荐</title>
    <link href="https://wsgzao.github.io/post/chrome-extensions/"/>
    <id>https://wsgzao.github.io/post/chrome-extensions/</id>
    <published>2019-10-09T03:59:49.000Z</published>
    <updated>2019-10-22T06:34:25.586Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191022143419.jpg" alt=""></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>到了新加坡再也不用考虑科学上网的问题，加上 macOS 跨平台浏览器做得比较成熟的自然是 Google Chrome 和 Firefox，在 Windows 平台用了十几年的 Maxthon，期间也尝试过无数第三方浏览器，傲游浏览器努力改变着世界却也渐行渐远，有着同样命运的应该还包括我从 M8 用到 MX2 的魅族吧。回到 Google Chrome 浏览器插件和油猴脚本推荐正题，Google Chrome 除了最重要的快以外，更重要的是 Chrome Web Store 上一系列好用插件，我很喜欢 Chrome 简单纯粹的设计和极致的性能。在插件的推荐上分为 <code>通用</code> 和 <code>开发者</code> 两部分来写方便区分，大部分 Chrome 可用的插件 Firefox 也同样适用，如果有遗漏或有更好用的同类型插件和脚本欢迎留言分享。</p><blockquote><p>Google Chrome 浏览器插件和油猴脚本推荐</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 10 月 09 日 - 更新 OneTab、简悦、广告终结者、Copyfish、Awesome screenshot and screen video<br>2019 年 08 月 20 日 - 添加自用部分插件和脚本，增加谷粒 Chrome 插件英雄榜<br>2019 年 08 月 01 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/chrome-extensions/">https://wsgzao.github.io/post/chrome-extensions/</a></p><p><strong> 扩展阅读 </strong></p><p><a href="https://github.com/zhaoolee/ChromeAppHeroes" target="_blank" rel="noopener">谷粒 Chrome 插件英雄榜</a></p><p><a href="https://www.pcmag.com/article/247971/the-100-best-free-google-chrome-extensions" target="_blank" rel="noopener">The 100 Best Free Google Chrome Extensions</a></p><p><a href="https://www.runningcheese.com/extensions" target="_blank" rel="noopener">Chrome Firefox 双修，2019 年度最喜欢浏览器拓展</a></p><p><a href="https://www.runningcheese.com/userscripts" target="_blank" rel="noopener">脚本里的 “赤兔”，2019 年度最喜欢油猴脚本</a></p><hr><h2 id="Chrome-插件推荐"><a href="#Chrome-插件推荐" class="headerlink" title="Chrome 插件推荐"></a>Chrome 插件推荐</h2><blockquote><p>以下链接大部分都是 Google Chrome Webstore，如果无法访问可以考虑从第三方下载到本地导入</p></blockquote><p><a href="https://chrome.google.com/webstore/category/extensions" target="_blank" rel="noopener">Chrome Web Store</a></p><p><a href="https://www.crx4chrome.com/" target="_blank" rel="noopener">Crx4Chrome</a></p><p><a href="https://chrome-extension-downloader.com/" target="_blank" rel="noopener">Chrome Extension Downloader</a></p><h3 id="通用"><a href="#通用" class="headerlink" title="通用"></a>通用</h3><p><a href="https://chrome.google.com/webstore/detail/simpleextmanager/kniehgiejgnnpgojkdhhjbgbllnfkfdk" target="_blank" rel="noopener">SimpleExtManager</a> - 我个人首推的管理插件小工具，对于插件控们一定灰常有帮助</p><p><a href="https://chrome.google.com/webstore/detail/ie-tab/hehijbfgiekmjfkfjpbkbammjbdenadd" target="_blank" rel="noopener">IE Tab</a> - 为了向下兼容那些没有与时俱进的网站，大多数时候我们只能选择妥协</p><p><a href="https://www.one-tab.com/" target="_blank" rel="noopener">OneTab</a> - 宣称节约 95% 内存的前提是静态网页，类似一个临时书签的记忆功能，习惯保留海量页面的朋友可以试试</p><p><a href="https://chrome.google.com/webstore/detail/undo-closed-tabs-button/ieehkmoiljghfkejgahoheemdjpdinml" target="_blank" rel="noopener">Undo Closed Tabs Button</a> - Google 原生取消了恢复网页的按钮的设计，你可以通过快捷键或者历史记录恢复，但这个小工具确实可以帮到我</p><p><a href="https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo" target="_blank" rel="noopener">Tampermonkey</a> - 老牌的油猴管理工具，和 Violentmonkey 暴力猴相比哪款用得顺手选择哪个</p><p><a href="https://chrome.google.com/webstore/detail/cdonnmffkdaoajfknoeeecmchibpmkmg?hl=en" target="_blank" rel="noopener">沙拉查词 - 聚合词典划词翻译</a> - 我个人觉得这是目前 Chrome 划词翻译插件中体验最好的</p><p><a href="https://chrome.google.com/webstore/detail/grammarly-for-chrome/kbfnbcaeplbcioakkpcpgfkobkghlhen" target="_blank" rel="noopener">Grammarly for Chrome</a> - 智能检查英文语法拼写错误，在 Web 写邮件和文档时会发现它的重要价值</p><p><a href="https://chrome.google.com/webstore/detail/evernote-web-clipper/pioclpoplcdbaefihamjohnefbikjilc" target="_blank" rel="noopener">Evernote Web Clipper</a> - 中文称为印象笔记，平时会把优质的内容保存到 Evernote 中，虽然没有 OneNote 功能强大但胜在简单方便可跨平台同步</p><p><a href="https://chrome.google.com/webstore/detail/simpread-reader-view/ijllcpnolfcooahcekpamkbidhejabll" target="_blank" rel="noopener">简悦 - SimpRead</a> - 沉浸式阅读模式，还支持丰富的导出功能比如 Markdown/PDF 等</p><p><a href="https://chrome.google.com/webstore/detail/enable-right-click/gpeddepmnbmkjfnhifmggnjdggibjjkf" target="_blank" rel="noopener">破解右键锁</a> - 比 Enable Copy 更加强大，不过大众点评的评论好像无解</p><p><a href="https://chrome.google.com/webstore/detail/mbklgpngoohbbagagdfoccaclpdhgihd" target="_blank" rel="noopener">爱搜资源云盘助手</a> - 插件方便是方便，但是可能会涉及用户隐私数据，如果介意需要慎用类似插件</p><p><a href="https://chrome.google.com/webstore/detail/awesome-screenshot-screen/nlipoenfbbikpbjkfpfillcgkoblgpmj" target="_blank" rel="noopener">Awesome screenshot and screen video</a> - 网页截图 + 录屏，代替 FireShot</p><p><a href="https://chrome.google.com/webstore/detail/proxy-switchyomega/padekgcemlokbadohgkifijomclgjgif" target="_blank" rel="noopener">Proxy SwitchyOmega</a> - 轻松快捷地管理和切换多个代理设置</p><p><a href="https://chrome.google.com/webstore/detail/ublock-origin/cjpalhdlnbpafiamejdnhcphjbkeiagm" target="_blank" rel="noopener">uBlock Origin</a> - 类似 Adblock Plus(ABP)，用于代替一款高效的网络请求过滤工具，占用极低的内存和 CPU，推荐额外添加适合自己的规则效果更佳，国内用户可以安装配置更简单的广告终结者</p><h3 id="开发者"><a href="#开发者" class="headerlink" title="开发者"></a>开发者</h3><p><a href="https://github.com/jaywcjlove/oscnews" target="_blank" rel="noopener">oscnews</a> - jaywcjlove 制作的新插件，目前我的主要用途是辅助新建标签页浏览开源中国更新资讯和 GitHub 趋势榜，从作者 TODO 计划来看，Github Start 管理和集成 octotree 部分功能都非常吸引人，加油</p><p><a href="https://github.com/zxlie/FeHelper" target="_blank" rel="noopener">FeHelper</a> - WEB 前端助手，All In One 的一个工具，包含多个独立小应用，比如：Json 工具、代码美化、代码压缩、二维码、Postman、markdown、网页油猴、便签笔记、信息加密与解密、随机密码生成、Crontab 等等</p><p><a href="https://github.com/openstyles/stylus" target="_blank" rel="noopener">Stylus</a> - Stylus 是基于 Stylish 调整网页外观的用户样式管理器</p><p><a href="https://chrome.google.com/webstore/detail/octotree/bkhaagjahfmjljalopjnoealnfndnagc" target="_blank" rel="noopener">Octotree</a> - 在 GitHub 上显示代码树</p><p><a href="http://www.pullywood.com/ImageAssistant/" target="_blank" rel="noopener">ImageAssistant</a> - 国人开发的图片助手 (ImageAssistant) 批量图片下载器</p><p><a href="https://github.com/BlackGlory/copycat" target="_blank" rel="noopener">Copycat</a> - 我主要是为了复制网页直接转化为 markdown</p><p><a href="https://ocr.space/copyfish" target="_blank" rel="noopener">Copyfish</a> - 免费版已经支持中文和英文的 OCR 在线识别，够用且准确</p><p><a href="https://github.com/oppoic/JSONViewer/" target="_blank" rel="noopener">JSONViewer</a> - 一个页面格式化多条 JSON，提升工作效率</p><p><a href="https://github.com/gildas-lormeau/SingleFile" target="_blank" rel="noopener">SingleFile</a> - 将完整的页面保存到一个 HTML 文件中</p><p><a href="https://www.uku.im" target="_blank" rel="noopener">Unblock Youku</a> - 我平时很少看国内在线视频，不过这款良心插件已经坚持了 5 年，作者不容易。如果速度不稳定大家也可以购买国内的阿里云、腾讯云等，我始终相信云即未来</p><p><a href="https://github.com/vinta/pangu.js" target="_blank" rel="noopener">为什么你们就是不能加个空格呢？</a> - 对文字排版有强迫症的福音吧</p><p><a href="https://github.com/sciooga/v2ex-plus" target="_blank" rel="noopener">v2ex plus</a> - 可能是 v2ex 最好用的扩展</p><h2 id="油猴脚本推荐"><a href="#油猴脚本推荐" class="headerlink" title="油猴脚本推荐"></a>油猴脚本推荐</h2><blockquote><p>我个人的选择是 TemperMoneky &gt; ViolentMoneky</p></blockquote><p><a href="https://www.tampermonkey.net" target="_blank" rel="noopener">Tampermonkey</a> - Tampermonkey 是一款免费的浏览器扩展和最为流行的用户脚本管理器</p><p><a href="https://greasyfork.org/zh-CN" target="_blank" rel="noopener">Greasy Fork</a> - 这里是一个提供用户脚本的网站</p><h3 id="通用-1"><a href="#通用-1" class="headerlink" title="通用"></a>通用</h3><p><a href="https://greasyfork.org/zh-CN/scripts/329484" target="_blank" rel="noopener">豆瓣资源下载大师</a> - 装这一个脚本就够了！可能是你遇到的最好的豆瓣增强脚本</p><p><a href="https://greasyfork.org/zh-CN/scripts/29762" target="_blank" rel="noopener">网盘自动填写密码【威力加强版】</a> - 这个功能比插件弱一些，好处就是不涉及上传隐私数据</p><p><a href="https://greasyfork.org/zh-CN/scripts/370634" target="_blank" rel="noopener">懒人专用，自用组合型多功能脚本</a> - 为避免争议，各位可以阅读脚本描述后决定是否使用</p><p><a href="https://greasyfork.org/zh-CN/scripts/25718" target="_blank" rel="noopener">解除 B 站区域限制</a> - 通过替换获取视频地址接口的方式，实现解除 B 站区域限制</p><p><a href="https://tiansh.github.io/yawf/" target="_blank" rel="noopener">YAWF</a> - 新浪微博根据关键词、作者、话题、来源等过滤微博，清理版面，以及其他改造功能</p><p><a href="https://tiansh.github.io/us-else/zhihu_visitor/" target="_blank" rel="noopener">知乎免登录</a> - 如题</p><p><a href="https://greasyfork.org/zh-CN/scripts/2312" target="_blank" rel="noopener">右键在新标签中打开图片时显示最优化图像质量</a> - 支持：谷歌 (G+ blogspot YouTube)、Tumblr、推特、Steam、新浪微博、知乎、豆瓣、百度贴吧、淘宝（天猫）、ArtStation、Pinimg 等</p><h3 id="开发者-1"><a href="#开发者-1" class="headerlink" title="开发者"></a>开发者</h3><blockquote><p>不解释，大伙都是为了努力学习新知识，但你值得拥有一种更舒服的姿势</p></blockquote><p><a href="https://greasyfork.org/zh-CN/scripts/23840" target="_blank" rel="noopener">大人的 Greasyfork</a></p><p><a href="https://sleazyfork.org/zh-CN/scripts/25781" target="_blank" rel="noopener">JAV 老司机</a></p><p><a href="https://greasyfork.org/zh-CN/scripts/23316" target="_blank" rel="noopener">琉神转</a></p>]]></content>
    
    <summary type="html">
    
      Google Chrome浏览器插件和油猴脚本推荐
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
</feed>
