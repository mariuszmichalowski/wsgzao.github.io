
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <script type="text/javascript">
    var host = "wsgzao.github.io";
    if ((host == window.location.host) && (window.location.protocol != "https:"))
        window.location.protocol = "https";
  </script> 
  
    <title>Grafana Loki 开源日志聚合系统代替 ELK 或 EFK | HelloDog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="wsgzao">
    

    
    <meta name="description" content="Grafana Loki开源日志聚合系统代替ELK或EFK">
<meta property="og:type" content="article">
<meta property="og:title" content="Grafana Loki 开源日志聚合系统代替 ELK 或 EFK">
<meta property="og:url" content="https://wsgzao.github.io/post/loki/index.html">
<meta property="og:site_name" content="HelloDog">
<meta property="og:description" content="Grafana Loki开源日志聚合系统代替ELK或EFK">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030154037.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030154333.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030162229.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030162252.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030162315.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030162332.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030162349.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030162405.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030162417.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030162439.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030162457.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030174015.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030174058.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030174206.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030175253.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030175134.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201103003623.png">
<meta property="og:updated_time" content="2020-11-03T03:24:52.525Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Grafana Loki 开源日志聚合系统代替 ELK 或 EFK">
<meta name="twitter:description" content="Grafana Loki开源日志聚合系统代替ELK或EFK">
<meta name="twitter:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030154037.png">

    
    <link rel="alternative" href="/atom.xml" title="HelloDog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="HelloDog" title="HelloDog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="HelloDog">HelloDog</a></h1>
				<h2 class="blog-motto">Keep Calm and Carry On</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页 | Home</a></li>
					
						<li><a href="/index/">索引 | Index</a></li>
					
						<li><a href="/archives/">归档 | Archives</a></li>
					
						<li><a href="/about/">简介 | About</a></li>
					
					<li>
 					
						<form class="search">
							<label>Search</label>
						<input type="text" id="search" class="st-default-search-input" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/post/loki/" title="Grafana Loki 开源日志聚合系统代替 ELK 或 EFK" itemprop="url">Grafana Loki 开源日志聚合系统代替 ELK 或 EFK</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="wsgzao" target="_blank" itemprop="author">wsgzao</a>
		
  <p class="article-time">
    <time datetime="2020-11-02T08:59:49.000Z" itemprop="datePublished"> 发表于 2020-11-02</time>
    
  </p>
</header>
	<div class="article-content">
<!-- 		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更新历史"><span class="toc-number">2.</span> <span class="toc-text">更新历史</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Loki-简介"><span class="toc-number">3.</span> <span class="toc-text">Loki 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#背景和动机"><span class="toc-number">4.</span> <span class="toc-text">背景和动机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ELK-存在的问题"><span class="toc-number">5.</span> <span class="toc-text">ELK 存在的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#成本考量"><span class="toc-number">6.</span> <span class="toc-text">成本考量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#整体架构"><span class="toc-number">7.</span> <span class="toc-text">整体架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#读写"><span class="toc-number">7.1.</span> <span class="toc-text">读写</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Distributor"><span class="toc-number">7.2.</span> <span class="toc-text">Distributor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ingester"><span class="toc-number">7.3.</span> <span class="toc-text">Ingester</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Querier"><span class="toc-number">7.4.</span> <span class="toc-text">Querier</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#可扩展性"><span class="toc-number">7.5.</span> <span class="toc-text">可扩展性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装-Loki"><span class="toc-number">8.</span> <span class="toc-text">安装 Loki</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Installation-methods"><span class="toc-number">8.1.</span> <span class="toc-text">Installation methods</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#General-process"><span class="toc-number">8.2.</span> <span class="toc-text">General process</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Loki-使用"><span class="toc-number">9.</span> <span class="toc-text">Loki 使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#选择器"><span class="toc-number">9.1.</span> <span class="toc-text">选择器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Loki-Cheat-Sheet"><span class="toc-number">9.2.</span> <span class="toc-text">Loki Cheat Sheet</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LogQL"><span class="toc-number">10.</span> <span class="toc-text">LogQL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Log-Stream-Selector"><span class="toc-number">10.1.</span> <span class="toc-text">Log Stream Selector</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Filter-Expression"><span class="toc-number">10.2.</span> <span class="toc-text">Filter Expression</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Metric-Queries"><span class="toc-number">10.3.</span> <span class="toc-text">Metric Queries</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Aggregation-operators"><span class="toc-number">10.4.</span> <span class="toc-text">Aggregation operators</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考文章"><span class="toc-number">11.</span> <span class="toc-text">参考文章</span></a></li></ol>
		
		</div>
		 -->
		<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030154037.png" alt=""></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在对公司容器云的日志方案进行设计的时候，发现主流的 ELK (Elasticsearch, <code>Logstash</code>, Kibana) 或者 EFK (Elasticsearch, <code>Filebeat</code> or <code>Fluentd</code>, Kibana) 比较重，再加上现阶段对于 ES 复杂的搜索功能很多都用不上，最终选择了 Grafana 开源的 Loki 日志系统。下面我们来介绍下 Loki 的一些基本概念和架构，当然 EFK 作为业界成熟的日志聚合解决方案也是大家应该需要熟悉和掌握的。</p>
<p><a href="https://grafana.com/blog/2020/10/28/loki-2.0-released-transform-logs-as-youre-querying-them-and-set-up-alerts-within-loki/" target="_blank" rel="noopener">Loki 2.0 released: Transform logs as you’re querying them, and set up alerts within Loki</a>, Loki 2.0 大版本更新后更好用了</p>
<h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2020 年 11 月 02 日 - 初稿</p>
<p>阅读原文 - <a href="https://wsgzao.github.io/post/loki/">https://wsgzao.github.io/post/loki/</a></p>
<hr>
<h2 id="Loki-简介"><a href="#Loki-简介" class="headerlink" title="Loki 简介"></a>Loki 简介</h2><p>Grafana Loki is a set of components that can be composed into a fully featured logging stack.</p>
<p>Unlike other logging systems, Loki is built around the idea of only indexing metadata about your logs: labels (just like Prometheus labels). Log data itself is then compressed and stored in chunks in object stores such as S3 or GCS, or even locally on the filesystem. A small index and highly compressed chunks simplifies the operation and significantly lowers the cost of Loki.</p>
<p>Loki 是 Grafana Labs 团队最新的开源项目，是一个水平可扩展，高可用性，多租户的日志聚合系统。它的设计非常经济高效且易于操作，因为它不会为日志内容编制索引，而是为每个日志流编制一组标签，专门为 Prometheus 和 Kubernetes 用户做了相关优化。该项目受 Prometheus 启发，官方的介绍就是： <code>Like Prometheus,But For Logs.</code>，类似于 Prometheus 的日志系统。</p>
<p>项目地址：<a href="https://github.com/grafana/loki/" target="_blank" rel="noopener">https://github.com/grafana/loki/</a></p>
<p>与其他日志聚合系统相比， Loki 具有下面的一些特性：</p>
<ul>
<li><p>不对日志进行全文索引。通过存储压缩非结构化日志和仅索引元数据，Loki 操作起来会更简单，更省成本。</p>
</li>
<li><p>通过使用与 Prometheus 相同的标签记录流对日志进行索引和分组，这使得日志的扩展和操作效率更高。</p>
</li>
<li><p>特别适合储存 Kubernetes Pod 日志; 诸如 Pod 标签之类的元数据会被自动删除和编入索引。</p>
</li>
<li><p>受 Grafana 原生支持。</p>
</li>
</ul>
<h2 id="背景和动机"><a href="#背景和动机" class="headerlink" title="背景和动机"></a>背景和动机</h2><p>当我们的容器云运行的应用或者某个节点出现问题了，解决思路应该如下：</p>
<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030154333.png" alt=""></p>
<p>我们的监控使用的是基于 Prometheus 体系进行改造的，Prometheus 中比较重要的是 Metric 和 Alert，Metric 是来说明当前或者历史达到了某个值，Alert 设置 Metric 达到某个特定的基数触发了告警，但是这些信息明显是不够的。</p>
<p>我们都知道，Kubernetes 的基本单位是 Pod，Pod 把日志输出到 Stdout 和 Stderr，平时有什么问题我们通常在界面或者通过命令查看相关的日志。</p>
<p>举个例子：当我们的某个 Pod 的内存变得很大，触发了我们的 Alert。这时管理员，去页面查询确认是哪个 Pod 有问题，然后要确认 Pod 内存变大的原因，我们还需要去查询 Pod 的日志，如果没有日志系统，那么我们就需要到页面或者使用命令进行查询：</p>
<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030162229.png" alt=""></p>
<p>如果，这个时候应用突然挂了，这个时候我们就无法查到相关的日志了。所以需要引入日志系统，统一收集日志。而使用 ELK 的话，就需要在 Kibana 和 Grafana 之间切换，影响用户体验。所以 ，Loki 的第一目的就是最小化度量和日志的切换成本，有助于减少异常事件的响应时间和提高用户的体验。</p>
<h2 id="ELK-存在的问题"><a href="#ELK-存在的问题" class="headerlink" title="ELK 存在的问题"></a>ELK 存在的问题</h2><p>现有的很多日志采集的方案都是采用全文检索对日志进行索引（如 ELK 方案），优点是功能丰富，允许复杂的操作。但是，这些方案往往规模复杂，资源占用高，操作苦难。很多功能往往用不上，大多数查询只关注一定时间范围和一些简单的参数（如：host、service 等），使用这些解决方案就有点杀鸡用牛刀的感觉了。</p>
<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030162252.png" alt=""></p>
<p>因此，Loki 的第二个目的是，在查询语言的易操作性和复杂性之间可以达到一个权衡。</p>
<h2 id="成本考量"><a href="#成本考量" class="headerlink" title="成本考量"></a>成本考量</h2><p>全文检索的方案也带来成本问题，简单的说就是全文搜索（如：ES）的倒排索引的切分和共享的成本较高。后来出现了其他不同的设计方案，如：</p>
<ul>
<li>OKlog</li>
</ul>
<p>项目地址：<a href="https://github.com/oklog/oklog" target="_blank" rel="noopener">https://github.com/oklog/oklog</a></p>
<p>采用最终一致的、基于网格的分布策略。这两个设计决策提供了大量的成本降低和非常简单的操作，但是查询不够方便。因此，Loki 的第三个目的是，提供一个更具成本效益的解决方案。</p>
<h2 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构</h2><p>Loki 的架构如下：</p>
<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030162315.png" alt=""></p>
<p>不难看出，Loki 的架构非常简单，主要由以下 3 个部分组成：</p>
<ul>
<li><p>Loki 是主服务器，负责存储日志和处理查询。</p>
</li>
<li><p>Promtail 是代理，负责收集日志并将其发送给 Loki 。</p>
</li>
<li><p>Grafana 用于 UI 展示。</p>
</li>
</ul>
<p>Loki 使用了和 Prometheus 一样的标签来作为索引。也就是说，你通过这些标签既可以查询日志的内容也可以查询到监控的数据，不但减少了两种查询之间的切换成本，也极大地降低了日志索引的存储。</p>
<p>Loki 使用与 Prometheus 相同的服务发现和标签重新标记库，编写了 Pormtail。在 Kubernetes 中 Promtail 以 DaemonSet 方式运行在每个节点中，通过 Kubernetes API 得到日志的正确元数据，并将它们发送到 Loki。下面是日志的存储架构：</p>
<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030162332.png" alt=""></p>
<h3 id="读写"><a href="#读写" class="headerlink" title="读写"></a>读写</h3><p>日志数据的写主要依托的是 Distributor 和 Ingester 两个组件，整体的流程如下：</p>
<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030162349.png" alt=""></p>
<h3 id="Distributor"><a href="#Distributor" class="headerlink" title="Distributor"></a>Distributor</h3><p>一旦 Promtail 收集日志并将其发送给 Loki，Distributor 就是第一个接收日志的组件。由于日志的写入量可能很大，所以不能在它们传入时将它们写入数据库。这会毁掉数据库。我们需要批处理和压缩数据。</p>
<p>Loki 通过构建压缩数据块来实现这一点，方法是在日志进入时对其进行 Gzip 操作。组件 Ingester 是一个有状态的组件，负责构建和刷新 Chunck，当 Chunk 达到一定的数量或者时间后，刷新到存储中去。每个流的日志对应一个 Ingester，当日志到达 Distributor 后，根据元数据和 Hash 算法计算出应该到哪个 Ingester 上面。</p>
<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030162405.png" alt=""></p>
<p>此外，为了冗余和弹性，我们将其复制 n（默认情况下为 3）次。</p>
<h3 id="Ingester"><a href="#Ingester" class="headerlink" title="Ingester"></a>Ingester</h3><p>Ingester 接收到日志并开始构建 Chunk：</p>
<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030162417.png" alt=""></p>
<p>基本上就是将日志进行压缩并附加到 Chunk 上面。一旦 Chunk 填满（数据达到一定数量或者过了一定期限），Ingester 将其刷新到数据库。我们对块和索引使用单独的数据库，因为它们存储的数据类型不同。</p>
<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030162439.png" alt=""></p>
<p>刷新一个 Chunk 之后，Ingester 然后创建一个新的空 Chunk 并将新条目添加到该 Chunk 中。</p>
<h3 id="Querier"><a href="#Querier" class="headerlink" title="Querier"></a>Querier</h3><p>读取就非常简单了，由 Querier 负责给定一个时间范围和标签选择器，Querier 查看索引以确定哪些块匹配，并通过 Greps 将结果显示出来。它还从 Ingester 获取尚未刷新的最新数据。</p>
<p>对于每个查询，一个查询器将为您显示所有相关日志。实现了查询并行化，提供分布式 Grep，使即使是大型查询也是足够的。</p>
<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030162457.png" alt=""></p>
<h3 id="可扩展性"><a href="#可扩展性" class="headerlink" title="可扩展性"></a>可扩展性</h3><p>Loki 的索引存储可以是 Cassandra/Bigtable/Dynamodb，而 Chuncks 可以是各种对象存储，Querier 和 Distributor 都是无状态的组件。</p>
<p>对于 Ingester，它虽然是有状态的。但是，当新的节点加入或者减少，整节点间的 Chunk 会重新分配，已适应新的散列环。而 Loki 底层存储的实现 Cortex 已经在实际的生产中投入使用多年了。</p>
<h2 id="安装-Loki"><a href="#安装-Loki" class="headerlink" title="安装 Loki"></a>安装 Loki</h2><h3 id="Installation-methods"><a href="#Installation-methods" class="headerlink" title="Installation methods"></a>Installation methods</h3><p>Instructions for different methods of installing Loki and Promtail.</p>
<ul>
<li><a href="https://grafana.com/docs/loki/latest/installation/tanka/" target="_blank" rel="noopener">Install using Tanka (recommended)</a></li>
<li><a href="https://grafana.com/docs/loki/latest/installation/helm/" target="_blank" rel="noopener">Install through Helm</a></li>
<li><a href="https://grafana.com/docs/loki/latest/installation/docker/" target="_blank" rel="noopener">Install through Docker or Docker Compose</a></li>
<li><a href="https://grafana.com/docs/loki/latest/installation/local/" target="_blank" rel="noopener">Install and run locally</a></li>
<li><a href="https://grafana.com/docs/loki/latest/installation/install-from-source/" target="_blank" rel="noopener">Install from source</a></li>
</ul>
<h3 id="General-process"><a href="#General-process" class="headerlink" title="General process"></a>General process</h3><p>In order to run Loki, you must:</p>
<ol>
<li>Download and install both Loki and Promtail.</li>
<li>Download config files for both programs.</li>
<li>Start Loki.</li>
<li>Update the Promtail config file to get your logs into Loki.</li>
<li>Start Promtail.</li>
</ol>
<blockquote>
<p>Loki 官方已经写得很详细了，我以 docker-compose 为例做个简单的演示</p>
</blockquote>
<p>Install with Docker Compose</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;3&quot;</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  loki:</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  loki:</span><br><span class="line">    image: grafana/loki:latest</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;3100:3100&quot;</span><br><span class="line">    command: -config.file=/etc/loki/local-config.yaml</span><br><span class="line">    networks:</span><br><span class="line">      - loki</span><br><span class="line"></span><br><span class="line">  promtail:</span><br><span class="line">    image: grafana/promtail:latest</span><br><span class="line">    volumes:</span><br><span class="line">      - /var/log:/var/log</span><br><span class="line">    command: -config.file=/etc/promtail/config.yml</span><br><span class="line">    networks:</span><br><span class="line">      - loki</span><br><span class="line"></span><br><span class="line">  grafana:</span><br><span class="line">    image: grafana/grafana:latest</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;3000:3000&quot;</span><br><span class="line">    networks:</span><br><span class="line">      - loki</span><br></pre></td></tr></table></figure>
<p>Run the following commands in your command line. They work for Windows or Linux systems.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/grafana/loki/v2.0.0/production/docker-compose.yaml -O docker-compose.yaml</span><br><span class="line">docker-compose -f docker-compose.yaml up -d</span><br><span class="line"></span><br><span class="line">[root@localhost loki]# docker-compose ps</span><br><span class="line">     Name                    Command               State           Ports</span><br><span class="line">---------------------------------------------------------------------------------</span><br><span class="line">loki_grafana_1    /run.sh                          Up      0.0.0.0:3000-&gt;3000/tcp</span><br><span class="line">loki_loki_1       /usr/bin/loki -config.file ...   Up      0.0.0.0:3100-&gt;3100/tcp</span><br><span class="line">loki_promtail_1   /usr/bin/promtail -config. ...   Up</span><br></pre></td></tr></table></figure>
<h2 id="Loki-使用"><a href="#Loki-使用" class="headerlink" title="Loki 使用"></a>Loki 使用</h2><p>安装完成后，访问上面节点的 3000 端口访问 grafana，默认情况下使用 (admin:admin) 访问 -&gt; 选择添加数据源：</p>
<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030174015.png" alt=""></p>
<p>grafana-loki-dashsource</p>
<p>在数据源列表中选择 <code>Loki</code>，配置 Loki 源地址：</p>
<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030174058.png" alt=""></p>
<p>grafana-loki-dashsource-config</p>
<p>源地址配置 <code>http://loki:3100</code> 即可，保存。</p>
<p>保存完成后，切换到 grafana 左侧区域的 <code>Explore</code>，即可进入到 <code>Loki</code> 的页面：</p>
<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030174206.png" alt=""></p>
<p>grafana-loki</p>
<p>然后我们点击 <code>Log labels</code> 就可以把当前系统采集的日志标签给显示出来，可以根据这些标签进行日志的过滤查询：</p>
<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030175253.png" alt=""></p>
<p>grafana-loki-log-labels</p>
<p>比如我们这里选择 <code>/var/log/messages</code>，就会把该文件下面的日志过滤展示出来，不过由于时区的问题，可能还需要设置下时间才可以看到数据：</p>
<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201030175134.png" alt=""></p>
<p>grafana-loki-logs</p>
<h3 id="选择器"><a href="#选择器" class="headerlink" title="选择器"></a>选择器</h3><p>对于查询表达式的标签部分，将其包装在花括号中 <code>{}</code>，然后使用键值对的语法来选择标签，多个标签表达式用逗号分隔，比如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;app="mysql",name="mysql-backup"&#125;</span><br></pre></td></tr></table></figure>
<p>目前支持以下标签匹配运算符：</p>
<ul>
<li><code>=</code> 等于</li>
<li><code>!=</code> 不相等</li>
<li><code>=~</code> 正则表达式匹配</li>
<li><code>!~</code> 不匹配正则表达式</li>
</ul>
<p>比如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;name=~"mysql.+"&#125;</span><br><span class="line">&#123;name!~"mysql.+"&#125;</span><br></pre></td></tr></table></figure>
<p>适用于 <code>Prometheus</code> 标签选择器规则同样也适用于 <code>Loki</code> 日志流选择器。</p>
<p>想要了解 <code>Loki</code> 的原始设计文档的可以点击查看这里的文档：<a href="https://docs.google.com/document/d/11tjK_lvp1-SVsFZjgOTr1vV3-q6vBAsZYIQ5ZeYBkyM/view" target="_blank" rel="noopener"><code>Loki</code> 设计文档</a></p>
<h3 id="Loki-Cheat-Sheet"><a href="#Loki-Cheat-Sheet" class="headerlink" title="Loki Cheat Sheet"></a>Loki Cheat Sheet</h3><p>See your logs</p>
<p>Start by selecting a log stream from the Log labels selector.</p>
<p>Alternatively, you can write a stream selector into the query field:</p>
<p><code>{job=&quot;default/prometheus&quot;}</code></p>
<p>Here are some example streams from your logs:</p>
<p><code>{job=&quot;varlogs&quot;}</code></p>
<p>Combine stream selectors</p>
<p><code>{app=&quot;cassandra&quot;,namespace=&quot;prod&quot;}</code></p>
<p>Returns all log lines from streams that have both labels.</p>
<p>Filtering for search terms.</p>
<p><code>{app=&quot;cassandra&quot;} |~ &quot;(duration|latency)s*(=|is|of)s*[d.]+&quot;</code></p>
<p><code>{app=&quot;cassandra&quot;} |= &quot;exact match&quot;</code></p>
<p><code>{app=&quot;cassandra&quot;} != &quot;do not match&quot;</code></p>
<p><a href="https://github.com/grafana/loki/blob/master/docs/logql.md#filter-expression" target="_blank" rel="noopener">LogQL</a> supports exact and regular expression filters.</p>
<p>Count over time</p>
<p><code>count_over_time({job=&quot;mysql&quot;}[5m])</code></p>
<p>This query counts all the log lines within the last five minutes for the MySQL job.</p>
<p>Rate</p>
<p><code>rate(({job=&quot;mysql&quot;} |= &quot;error&quot; != &quot;timeout&quot;)[10s])</code></p>
<p>This query gets the per-second rate of all non-timeout errors within the last ten seconds for the MySQL job.</p>
<p>Aggregate, count, and group</p>
<p><code>sum(count_over_time({job=&quot;mysql&quot;}[5m])) by (level)</code></p>
<p>Get the count of logs during the last five minutes, grouping by level.</p>
<h2 id="LogQL"><a href="#LogQL" class="headerlink" title="LogQL"></a>LogQL</h2><blockquote>
<p>Loki 使用一种称为 LogQL 的语法来进行日志检索，语法类似 PromQL</p>
</blockquote>
<p>LogQL: Log Query Language</p>
<p>Loki comes with its own PromQL-inspired language for queries called <em>LogQL</em>. LogQL can be considered a distributed <code>grep</code> that aggregates log sources. LogQL uses labels and operators for filtering.</p>
<p>There are two types of LogQL queries:</p>
<ul>
<li><em>Log queries</em> return the contents of log lines.</li>
<li><em>Metric queries</em> extend log queries and calculate sample values based on the content of logs from a log query.</li>
</ul>
<p>受 PromQL 的启发，Loki 也有自己的 LogQL 查询语句。根据官方的说法，它就像一个 <code>分布式的 grep 日志聚合查看器</code>。和 PromeQL 一样，LogQL 也是使用标签和运算符进行过滤，它主要分为两个部分：</p>
<ul>
<li>log stream selector （日志流选择器）</li>
<li>filter expression （过滤器表达式）</li>
</ul>
<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20201103003623.png" alt=""></p>
<p>我们用这两部分就可以在 Loki 中组合出我们想要的功能，通常情况下我们可以拿来做如下功能</p>
<ul>
<li>根据日志流选择器查看日志内容</li>
<li>通过过滤规则在日志流中计算相关的度量指标</li>
</ul>
<h3 id="Log-Stream-Selector"><a href="#Log-Stream-Selector" class="headerlink" title="Log Stream Selector"></a>Log Stream Selector</h3><p>日志流选择器这部分和 PromQL 的语法一样，主要也是通过采集上来的日志 label 来确定你要查询的日志流。通常 label 的匹配运算支持以下几种：</p>
<ul>
<li>\=: 完全匹配</li>
<li>!=: 不匹配</li>
<li>\=~: 正则表达式匹配</li>
<li><p>!~: 正则表达式不匹配</p>
<p>{app=”mysql”,name=~”mysql-backup.+”}</p>
</li>
</ul>
<ul>
<li><code>=</code>: exactly equal.</li>
<li><code>!=</code>: not equal.</li>
<li><code>=~</code>: regex matches.</li>
<li><code>!~</code>: regex does not match.</li>
</ul>
<h3 id="Filter-Expression"><a href="#Filter-Expression" class="headerlink" title="Filter Expression"></a>Filter Expression</h3><pre><code>{instance=~&quot;kafka-[23]&quot;,name=&quot;kafka&quot;} != &quot;kafka.server:type=ReplicaManager&quot;
</code></pre><ul>
<li><code>|=</code>: Log line contains string.</li>
<li><code>!=</code>: Log line does not contain string.</li>
<li><code>|~</code>: Log line matches regular expression.</li>
<li><code>!~</code>: Log line does not match regular expression.</li>
</ul>
<h3 id="Metric-Queries"><a href="#Metric-Queries" class="headerlink" title="Metric Queries"></a>Metric Queries</h3><p>这个其实就跟 prometheus 中的很想像了.</p>
<pre><code>rate({job=&quot;mysql&quot;} |= &quot;error&quot; != &quot;timeout&quot; [5m])
</code></pre><ul>
<li><code>rate</code>: calculates the number of entries per second</li>
<li><code>count_over_time</code>: counts the entries for each log stream within the given range.</li>
<li><code>bytes_rate</code>: calculates the number of bytes per second for each stream.</li>
<li><code>bytes_over_time</code>: counts the amount of bytes used by each log stream for a given range.</li>
</ul>
<h3 id="Aggregation-operators"><a href="#Aggregation-operators" class="headerlink" title="Aggregation operators"></a>Aggregation operators</h3><p>当然还支持一些聚合操作，比如</p>
<pre><code>avg(rate(({job=&quot;nginx&quot;} |= &quot;GET&quot;)[10s])) by (region)
</code></pre><ul>
<li><code>sum</code>: Calculate sum over labels</li>
<li><code>min</code>: Select minimum over labels</li>
<li><code>max</code>: Select maximum over labels</li>
<li><code>avg</code>: Calculate the average over labels</li>
<li><code>stddev</code>: Calculate the population standard deviation over labels</li>
<li><code>stdvar</code>: Calculate the population standard variance over labels</li>
<li><code>count</code>: Count number of elements in the vector</li>
<li><code>bottomk</code>: Select smallest k elements by sample value</li>
<li><code>topk</code>: Select largest k elements by sample value</li>
</ul>
<p>还有很多比如’and, or’的操作都是支持, 就不一一搬运了</p>
<p><a href="https://grafana.com/docs/loki/latest/logql/" target="_blank" rel="noopener">https://grafana.com/docs/loki/latest/logql/</a></p>
<p><a href="https://juejin.im/post/6885882888995209224" target="_blank" rel="noopener">五分钟了解 LogQL</a></p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://grafana.com/docs/loki/latest/" target="_blank" rel="noopener">Loki Documentation</a></p>
<p><a href="https://grafana.com/categories/loki/" target="_blank" rel="noopener">Loki Posts</a></p>
<p><a href="https://grafana.com/blog/2018/12/12/loki-prometheus-inspired-open-source-logging-for-cloud-natives/" target="_blank" rel="noopener">Loki: Prometheus-inspired, open source logging for cloud natives</a></p>
<p><a href="https://blog.csdn.net/Linkthaha/" target="_blank" rel="noopener">Loki 日志系统详解</a></p>
<p><a href="https://www.qikqiak.com/post/grafana-log-tool-loki/" target="_blank" rel="noopener">Grafana 日志聚合工具 Loki</a></p>
<p><a href="https://www.qikqiak.com/post/grafana-loki-usage/" target="_blank" rel="noopener">Grafana Loki 简明教程</a></p>
<p><a href="https://juejin.im/post/6878188974645444621" target="_blank" rel="noopener">Loki 最佳实践（译）</a></p>
<p><a href="https://juejin.im/post/6888510459108917256" target="_blank" rel="noopener">Loki 迎来 2.0 重大更新，LogQL 语法大幅增强​！</a></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/学习-Study/">学习 | Study</a>
</div>


</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://wsgzao.github.io/post/loki/" data-title="Grafana Loki 开源日志聚合系统代替 ELK 或 EFK | HelloDog" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/post/efk/" title="开源日志管理方案 ELK 和 EFK 的区别">
  <strong>上一篇：</strong><br/>
  <span>
  开源日志管理方案 ELK 和 EFK 的区别</span>
</a>
</div>


<div class="next">
<a href="/post/lrzsz/"  title="macOS 使用 iterm2 启用 rz 与 sz 功能">
 <strong>下一篇：</strong><br/> 
 <span>macOS 使用 iterm2 启用 rz 与 sz 功能
</span>
</a>
</div>

</nav>

	

<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>



</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更新历史"><span class="toc-number">2.</span> <span class="toc-text">更新历史</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Loki-简介"><span class="toc-number">3.</span> <span class="toc-text">Loki 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#背景和动机"><span class="toc-number">4.</span> <span class="toc-text">背景和动机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ELK-存在的问题"><span class="toc-number">5.</span> <span class="toc-text">ELK 存在的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#成本考量"><span class="toc-number">6.</span> <span class="toc-text">成本考量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#整体架构"><span class="toc-number">7.</span> <span class="toc-text">整体架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#读写"><span class="toc-number">7.1.</span> <span class="toc-text">读写</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Distributor"><span class="toc-number">7.2.</span> <span class="toc-text">Distributor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ingester"><span class="toc-number">7.3.</span> <span class="toc-text">Ingester</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Querier"><span class="toc-number">7.4.</span> <span class="toc-text">Querier</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#可扩展性"><span class="toc-number">7.5.</span> <span class="toc-text">可扩展性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装-Loki"><span class="toc-number">8.</span> <span class="toc-text">安装 Loki</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Installation-methods"><span class="toc-number">8.1.</span> <span class="toc-text">Installation methods</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#General-process"><span class="toc-number">8.2.</span> <span class="toc-text">General process</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Loki-使用"><span class="toc-number">9.</span> <span class="toc-text">Loki 使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#选择器"><span class="toc-number">9.1.</span> <span class="toc-text">选择器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Loki-Cheat-Sheet"><span class="toc-number">9.2.</span> <span class="toc-text">Loki Cheat Sheet</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LogQL"><span class="toc-number">10.</span> <span class="toc-text">LogQL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Log-Stream-Selector"><span class="toc-number">10.1.</span> <span class="toc-text">Log Stream Selector</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Filter-Expression"><span class="toc-number">10.2.</span> <span class="toc-text">Filter Expression</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Metric-Queries"><span class="toc-number">10.3.</span> <span class="toc-text">Metric Queries</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Aggregation-operators"><span class="toc-number">10.4.</span> <span class="toc-text">Aggregation operators</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考文章"><span class="toc-number">11.</span> <span class="toc-text">参考文章</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="wsgzao" data-theme="medium"></div>
<script type="text/javascript" src="//lab.lepture.com/github-cards/widget.js" ></script>
</div>



  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Hexo/" title="Hexo">Hexo<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/学习-Study/" title="学习 | Study">学习 | Study<sup>179</sup></a></li>
		  
		
		  
			<li><a href="/categories/生活-Life/" title="生活 | Life">生活 | Life<sup>16</sup></a></li>
		  
		
		  
			<li><a href="/categories/软件-Soft/" title="软件 | Soft">软件 | Soft<sup>5</sup></a></li>
		  
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.linkedin.com/in/aowang" target="_blank" title="LinkedIn">LinkedIn</a>
            
          </li>
        
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello, I&#39;m OX. This is my blog on GitHub. <br/>
			Keep Calm and Carry On.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		<a href="https://github.com/wsgzao" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		<a href="https://www.linkedin.com/in/aowang" target="_blank" class="icon-linkedin" title="linkedin"></a>
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2020 
		
		<a href="/about" target="_blank" title="wsgzao">wsgzao</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>




<script type="text/javascript">

var disqus_shortname = 'wsgzao';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>








<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->

<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-77732745-1', 'wsgzao.github.io');  
ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?c2c5fc7d844d0973d9f77abd87f49c3c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- swiftype Begin -->

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','_4qDmKrBPn9Es3UvQHT4','2.0.0');
</script>

<!-- swiftype End -->

  </body>
</html>
