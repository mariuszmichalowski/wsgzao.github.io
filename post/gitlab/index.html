
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <script type="text/javascript">
    var host = "wsgzao.github.io";
    if ((host == window.location.host) && (window.location.protocol != "https:"))
        window.location.protocol = "https";
  </script> 
  
    <title>RHEL7/CentOS7 在线和离线安装 GitLab 配置使用实践 | HelloDog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="wsgzao">
    

    
    <meta name="description" content="RHEL7/CentOS7在线和离线安装GitLab配置实践，GitLab汉化配置使用小结">
<meta property="og:type" content="article">
<meta property="og:title" content="RHEL7&#x2F;CentOS7 在线和离线安装 GitLab 配置使用实践">
<meta property="og:url" content="https://wsgzao.github.io/post/gitlab/index.html">
<meta property="og:site_name" content="HelloDog">
<meta property="og:description" content="RHEL7/CentOS7在线和离线安装GitLab配置实践，GitLab汉化配置使用小结">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://docs-aliyun.cn-hangzhou.oss.aliyun-inc.com/assets/pic/52857/cn_zh/1492756915645/%E5%9B%BE%E7%89%878.png">
<meta property="og:image" content="https://www.ilanni.com/wp-content/uploads/2018/04/clip_image011_thumb-1.png">
<meta property="og:updated_time" content="2018-04-23T06:31:05.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RHEL7&#x2F;CentOS7 在线和离线安装 GitLab 配置使用实践">
<meta name="twitter:description" content="RHEL7/CentOS7在线和离线安装GitLab配置实践，GitLab汉化配置使用小结">
<meta name="twitter:image" content="http://docs-aliyun.cn-hangzhou.oss.aliyun-inc.com/assets/pic/52857/cn_zh/1492756915645/%E5%9B%BE%E7%89%878.png">

    
    <link rel="alternative" href="/atom.xml" title="HelloDog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="HelloDog" title="HelloDog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="HelloDog">HelloDog</a></h1>
				<h2 class="blog-motto">Keep Calm and Carry On</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页 | Home</a></li>
					
						<li><a href="/index/">索引 | Index</a></li>
					
						<li><a href="/archives/">归档 | Archives</a></li>
					
						<li><a href="/about/">简介 | About</a></li>
					
					<li>
 					
						<form class="search">
							<label>Search</label>
						<input type="text" id="search" class="st-default-search-input" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/post/gitlab/" title="RHEL7/CentOS7 在线和离线安装 GitLab 配置使用实践" itemprop="url">RHEL7/CentOS7 在线和离线安装 GitLab 配置使用实践</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="wsgzao" target="_blank" itemprop="author">wsgzao</a>
		
  <p class="article-time">
    <time datetime="2018-04-19T08:40:53.000Z" itemprop="datePublished"> 发表于 2018-04-19</time>
    
  </p>
</header>
	<div class="article-content">
<!-- 		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更新记录"><span class="toc-number">2.</span> <span class="toc-text">更新记录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GitLab-简介"><span class="toc-number">3.</span> <span class="toc-text">GitLab 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Gitlab-的服务构成"><span class="toc-number">3.1.</span> <span class="toc-text">Gitlab 的服务构成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GitLab-工作流程"><span class="toc-number">3.2.</span> <span class="toc-text">GitLab 工作流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GitLab-安装"><span class="toc-number">4.</span> <span class="toc-text">GitLab 安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基础依赖"><span class="toc-number">4.1.</span> <span class="toc-text">基础依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在线安装-gitlab-ce"><span class="toc-number">4.2.</span> <span class="toc-text">在线安装 gitlab-ce</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#离线安装-gitlab-ce"><span class="toc-number">4.3.</span> <span class="toc-text">离线安装 gitlab-ce</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GitLab-汉化"><span class="toc-number">5.</span> <span class="toc-text">GitLab 汉化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GitLab-常用命令"><span class="toc-number">6.</span> <span class="toc-text">GitLab 常用命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#公网邮箱配置"><span class="toc-number">7.</span> <span class="toc-text">公网邮箱配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#QQ-企业邮箱"><span class="toc-number">7.1.</span> <span class="toc-text">QQ 企业邮箱</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#163-邮箱"><span class="toc-number">7.2.</span> <span class="toc-text">163 邮箱</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#阿里云企业邮箱"><span class="toc-number">7.3.</span> <span class="toc-text">阿里云企业邮箱</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GitLab-使用"><span class="toc-number">8.</span> <span class="toc-text">GitLab 使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#登录-GitLab"><span class="toc-number">8.1.</span> <span class="toc-text">登录 GitLab</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建-Project"><span class="toc-number">8.2.</span> <span class="toc-text">创建 Project</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#简单配置"><span class="toc-number">8.3.</span> <span class="toc-text">简单配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置-GitLab"><span class="toc-number">9.</span> <span class="toc-text">配置 GitLab</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#设置外部访问链接"><span class="toc-number">9.1.</span> <span class="toc-text">设置外部访问链接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTPS-配置"><span class="toc-number">9.2.</span> <span class="toc-text">HTTPS 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#应用配置"><span class="toc-number">9.3.</span> <span class="toc-text">应用配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GitLab-备份升级迁移"><span class="toc-number">10.</span> <span class="toc-text">GitLab 备份升级迁移</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GitLab-备份"><span class="toc-number">10.1.</span> <span class="toc-text">GitLab 备份</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GitLab-升级"><span class="toc-number">10.2.</span> <span class="toc-text">GitLab 升级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GitLab-迁移"><span class="toc-number">10.3.</span> <span class="toc-text">GitLab 迁移</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GitLab-常见问题"><span class="toc-number">11.</span> <span class="toc-text">GitLab 常见问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#更改管理员密码"><span class="toc-number">11.1.</span> <span class="toc-text">更改管理员密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The-requested-URL-returned-error-401-while-accessing"><span class="toc-number">11.2.</span> <span class="toc-text">The requested URL returned error: 401 while accessing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#webhooks-不生效"><span class="toc-number">11.3.</span> <span class="toc-text">webhooks 不生效</span></a></li></ol></li></ol>
		
		</div>
		 -->
		<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>GitLab Community Edition 新版本已经集成了 CI/CD 的支持，从某种程度上来说可以告别对于 Jenkins 的依赖，我本来计划是写基于 Docker 部署 GitLab 但感觉还是有点重，对于内网离线环境来说基于容器部署也未必是合理的方案，这里沿用传统的部署方式介绍简单且长期有效的 GitLab 部署方案供大家参考，或许未来会增加基于容器的部署方案和 CI/CD 的分享，因需而变。</p>
<blockquote>
<p>RHEL7/CentOS7 在线和离线安装 GitLab 配置实践，GitLab 汉化配置使用小结</p>
</blockquote>
<h2 id="更新记录"><a href="#更新记录" class="headerlink" title="更新记录"></a>更新记录</h2><p>2018 年 04 月 19 日 - 完善内容<br>2018 年 04 月 10 日 - 初稿</p>
<p>阅读原文 - <a href="https://wsgzao.github.io/post/gitlab/">https://wsgzao.github.io/post/gitlab/</a></p>
<p><strong> 扩展阅读 </strong></p>
<p>GitLab Installation - <a href="https://about.gitlab.com/installation" target="_blank" rel="noopener">https://about.gitlab.com/installation</a></p>
<h2 id="GitLab-简介"><a href="#GitLab-简介" class="headerlink" title="GitLab 简介"></a>GitLab 简介</h2><p>GitLab 是利用 Ruby On Rails 开发的一个开源版本管理系统，实现了一个自托管的 Git 项目仓库，是集代码托管，测试，部署于一体的开源 git 仓库管理软件，可通过 web 界面来进行访问公开的或私人项目。与 Github 类似，GitLab 能够浏览代码，管理缺陷和注释。可以管理团队对仓库的访问，它非常易于浏览提交过的版本，并提供一个文件历史库。它还提供一个代码片段收集功能可以轻松实现代码复用，便于日后需要的时候查找。</p>
<blockquote>
<p>Git 的家族成员</p>
</blockquote>
<ul>
<li>Git：是一种版本控制系统，是一个命令，是一种工具。</li>
<li>Gitlib：是用于实现 Git 功能的开发库。</li>
<li>Github：是一个基于 Git 实现的在线代码托管仓库，公开项目是免费的，也可以付费创建私人项目。</li>
<li>GitLab：是一个基于 Git 实现的在线代码仓库托管软件，可以用 GitLab 搭建一套类似 Github 的系统。</li>
</ul>
<p>GitLab 对硬件还是有一定要求的，1 核心的 CPU 基本上可以满足需求，大概支撑 100 个左右的用户，不过在运行 GitLab 网站的同时还需要运行多个后台 job，就会显得有点捉襟见肘了。需要至少 4GB 的可寻址内存（RAM 交换）来安装和使用 GitLab，操作系统和任何其他正在运行的应用程序也将使用内存，因此请记住，在运行 GitLab 之前，您至少需要 4GB 的可用空间。如果使用更少的内存，GitLab 将在重新配置运行期间给出奇怪的错误，我用虚拟机来分别新建 1G,2G 内存的 CentOS 系统来装 GitLab，确实非常捉襟见肘啊，伤不起。</p>
<h3 id="Gitlab-的服务构成"><a href="#Gitlab-的服务构成" class="headerlink" title="Gitlab 的服务构成"></a>Gitlab 的服务构成</h3><ul>
<li>Nginx：静态 web 服务器</li>
<li>gitlab-shell：用于处理 Git 命令和修改 authorized keys 列表</li>
<li>gitlab-workhorse: 轻量级的反向代理服务器</li>
<li>logrotate：日志文件管理工具</li>
<li>postgresql：数据库</li>
<li>redis：缓存数据库</li>
<li>sidekiq：用于在后台执行队列任务（异步执行）</li>
<li>unicorn：An HTTP server for Rack applications，GitLab Rails 应用是托管在这个服务器上面的</li>
</ul>
<h3 id="GitLab-工作流程"><a href="#GitLab-工作流程" class="headerlink" title="GitLab 工作流程"></a>GitLab 工作流程</h3><p><img src="http://docs-aliyun.cn-hangzhou.oss.aliyun-inc.com/assets/pic/52857/cn_zh/1492756915645/%E5%9B%BE%E7%89%878.png" alt=""></p>
<h2 id="GitLab-安装"><a href="#GitLab-安装" class="headerlink" title="GitLab 安装"></a>GitLab 安装</h2><h3 id="基础依赖"><a href="#基础依赖" class="headerlink" title="基础依赖"></a>基础依赖</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">yum install curl policycoreutils openssh-server openssh-clients -y</span><br><span class="line">systemctl <span class="built_in">enable</span> sshd</span><br><span class="line">systemctl start sshd</span><br><span class="line">yum install postfix</span><br><span class="line">systemctl <span class="built_in">enable</span> postfix</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查修改邮件下面 2 项配置，不配置可以跳过</span></span><br><span class="line">vim /etc/postfix/main.cf </span><br><span class="line"></span><br><span class="line">inet_interfaces = all</span><br><span class="line">inet_protocols = ipv4</span><br><span class="line"></span><br><span class="line">systemctl start postfix</span><br></pre></td></tr></table></figure>
<h3 id="在线安装-gitlab-ce"><a href="#在线安装-gitlab-ce" class="headerlink" title="在线安装 gitlab-ce"></a>在线安装 gitlab-ce</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装必要的依赖包，如果不需要可以考虑跳过</span></span><br><span class="line">yum install pygpgme yum-utils</span><br><span class="line"><span class="comment"># On CentOS 7 (and RedHat/Oracle/Scientific Linux 7), the commands below will also open HTTP and SSH access in the system firewall.</span></span><br><span class="line">sudo yum install -y curl policycoreutils-python openssh-server</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> sshd</span><br><span class="line">sudo systemctl start sshd</span><br><span class="line">sudo firewall-cmd --permanent --add-service=http</span><br><span class="line">sudo systemctl reload firewalld</span><br><span class="line"><span class="comment"># Next, install Postfix to send notification emails. If you want to use another solution to send emails please skip this step and configure an external SMTP server after GitLab has been installed.</span></span><br><span class="line">sudo yum install postfix</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> postfix</span><br><span class="line">sudo systemctl start postfix</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用阿里云作加速</span></span><br><span class="line"><span class="built_in">cd</span> /etc/yum.repos.d/ &amp;&amp; rm -f *.repo</span><br><span class="line">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加 GitLab 镜像源并安装，建议切换国内资源加速访问</span></span><br><span class="line">curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 gitlab-ce 的 repo，使用清华大学加速</span></span><br><span class="line">vim /etc/yum.repos.d/gitlab_gitlab-ce.repo</span><br><span class="line"></span><br><span class="line">[gitlab-ce]</span><br><span class="line">name=gitlab-ce</span><br><span class="line">baseurl=http://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://packages.gitlab.com/gpg.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置并启动 GitLab</span></span><br><span class="line">gitlab-ctl reconfigure</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一次访问 GitLab，系统会重定向页面到重定向到重置密码页面，你需要输入初始化管理员账号的密码，管理员的用户名为 root，重置密码后新密码即为刚输入的密码。</span></span><br><span class="line">0.0.0.0:80</span><br></pre></td></tr></table></figure>
<h3 id="离线安装-gitlab-ce"><a href="#离线安装-gitlab-ce" class="headerlink" title="离线安装 gitlab-ce"></a>离线安装 gitlab-ce</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用阿里云作加速</span></span><br><span class="line"><span class="built_in">cd</span> /etc/yum.repos.d/ &amp;&amp; rm -f *.repo</span><br><span class="line">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加 GitLab 镜像源并安装，建议切换国内资源加速访问</span></span><br><span class="line">curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 gitlab-ce 的 repo，使用清华大学加速</span></span><br><span class="line">vim /etc/yum.repos.d/gitlab_gitlab-ce.repo</span><br><span class="line"></span><br><span class="line">[gitlab-ce]</span><br><span class="line">name=gitlab-ce</span><br><span class="line">baseurl=http://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://packages.gitlab.com/gpg.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 yum-plugin-downloadonly 插件</span></span><br><span class="line">yum install -y yum-plugin-downloadonly</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载 gitlab-ce 相关 rpm 到指定目录</span></span><br><span class="line">mkdir -p /tmp/repo/gitlab-ce/</span><br><span class="line">yum install --downloadonly --downloaddir=/tmp/repo/gitlab-ce/ gitlab-ce</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝文件至内网离线安装</span></span><br><span class="line">rpm -ivh /tmp/repo/gitlab-ce/*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置并启动 GitLab</span></span><br><span class="line">gitlab-ctl reconfigure</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一次访问 GitLab，系统会重定向页面到重定向到重置密码页面，你需要输入初始化管理员账号的密码，管理员的用户名为 root，重置密码后新密码即为刚输入的密码。</span></span><br><span class="line">0.0.0.0:80</span><br></pre></td></tr></table></figure>
<h2 id="GitLab-汉化"><a href="#GitLab-汉化" class="headerlink" title="GitLab 汉化"></a>GitLab 汉化</h2><blockquote>
<p>如果团队里英文水平都不错的话，是没必要汉化的，我个人的建议是坚持使用原版不做汉化</p>
</blockquote>
<p>我这边测试 GitLab 10.6.3 新版本中官方已经集成了简体中文，虽然不完整但应该是一个好的开端，设置方式如下<br>右上角用户头像 - Settings-Profile-Main settings-Preferred language - 简体中文<br>保存选择 Update profile settings，然后 Sign out 重新登录就可以看到效果了<br>当然我还是希望大家习惯 English 界面，Trouble Shooting 也方便</p>
<p>GitLab 中文社区的项目，v7-v8.8 是由 Larry Li 发起的“GitLab 中文社区版项目”<br><a href="https://gitlab.com/larryli/gitlab" target="_blank" rel="noopener">https://gitlab.com/larryli/gitlab</a></p>
<p>从 v8.9 之后由 @xhang 开始继续汉化项目<br><a href="https://gitlab.com/xhang/gitlab" target="_blank" rel="noopener">https://gitlab.com/xhang/gitlab</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如没安装 git，需提前安装 </span></span><br><span class="line">yum install -y git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 gitlba 汉化包下载目录</span></span><br><span class="line">mkdir -p /tmp/gitlab</span><br><span class="line"><span class="built_in">cd</span> /tmp/gitlab</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载最新的汉化包</span></span><br><span class="line">git <span class="built_in">clone</span> https://gitlab.com/xhang/gitlab.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果是要下载老版本的汉化包，需要加上老版本的分支，如果想下载 10.0.2，可以运行如下语句</span></span><br><span class="line">git <span class="built_in">clone</span> https://gitlab.com/xhang/gitlab.git -b v10.0.2-zh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止 GitLab 并执行如下语句</span></span><br><span class="line">gitlab-ctl stop</span><br><span class="line">cp /tmp/gitlab/gitlab/* /opt/gitlab/embedded/service/gitlab-rails/ -rf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制时可能不断提示是否要覆盖，这时可能是系统每次执行 cp 命令时，其实是执行了 cp -i 命令的别名。出现这种情况可以修改~/.bashrc，在“alias cp=’cp-i’” 前加 #注释即可。使用命令或者注销登录即可</span></span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接下来可以重新配置和启动</span></span><br><span class="line">gitlab-ctl reconfigure</span><br><span class="line">gitlab-ctl restart</span><br></pre></td></tr></table></figure>
<h2 id="GitLab-常用命令"><a href="#GitLab-常用命令" class="headerlink" title="GitLab 常用命令"></a>GitLab 常用命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 语法</span></span><br><span class="line">gitlab-ctl <span class="built_in">command</span> (subcommand)</span><br><span class="line"></span><br><span class="line">Service Management Commands</span><br><span class="line"></span><br><span class="line">start <span class="comment"># 启动所有服务</span></span><br><span class="line">stop <span class="comment"># 关闭所有服务</span></span><br><span class="line">restart <span class="comment"># 重启所有服务</span></span><br><span class="line">status <span class="comment"># 查看所有服务状态</span></span><br><span class="line">tail <span class="comment"># 查看日志信息</span></span><br><span class="line">service-list <span class="comment"># 列举所有启动服务</span></span><br><span class="line">graceful-kill <span class="comment"># 平稳停止一个服务</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动所有服务</span></span><br><span class="line">gitlab-ctl start </span><br><span class="line"><span class="comment"># 启动单独一个服务</span></span><br><span class="line">gitlab-ctl start nginx</span><br><span class="line"><span class="comment"># 查看日志，查看所有日志</span></span><br><span class="line">gitlab-ctl tail</span><br><span class="line"><span class="comment"># 查看具体一个日志, 类似 tail -f</span></span><br><span class="line">gitlab-ctl tail nginx</span><br><span class="line"></span><br><span class="line">General Commands</span><br><span class="line"></span><br><span class="line"><span class="built_in">help</span> <span class="comment"># 帮助</span></span><br><span class="line">reconfigure <span class="comment"># 修改配置文件之后，需要重新加载下</span></span><br><span class="line">show-config <span class="comment"># 查看所有服务配置文件信息</span></span><br><span class="line">uninstall <span class="comment"># 卸载这个软件</span></span><br><span class="line">cleanse <span class="comment"># 删除 gitlab 数据，重新白手起家</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示所有服务配置文件</span></span><br><span class="line">gitlab-ctl show-config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载 gitlab</span></span><br><span class="line">gitlab-ctl uninstall</span><br></pre></td></tr></table></figure>
<h2 id="公网邮箱配置"><a href="#公网邮箱配置" class="headerlink" title="公网邮箱配置"></a>公网邮箱配置</h2><p>默认情况下，GitLab 用 qq 邮箱注册是发不出确认邮件的。查看了网上很多邮箱配置的教程，大部分都是误导的。像这类软件，归根到底总结为一句话：一切以官网文档为准。QQ 邮箱最好用企业邮箱，本人用个人邮箱进行测试是有些小问题的，正确配置如下：</p>
<p>其他邮箱可以参考官方给出的 SMTP 配置 SMTP Setting<br><a href="https://docs.gitlab.com/omnibus/settings/smtp.html" target="_blank" rel="noopener">https://docs.gitlab.com/omnibus/settings/smtp.html</a></p>
<h3 id="QQ-企业邮箱"><a href="#QQ-企业邮箱" class="headerlink" title="QQ 企业邮箱"></a>QQ 企业邮箱</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑 gitlab.rb</span></span><br><span class="line">vim /etc/gitlab/gitlab.rb</span><br><span class="line"></span><br><span class="line">gitlab_rails[<span class="string">'smtp_enable'</span>] = <span class="literal">true</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_address'</span>] = <span class="string">"smtp.exmail.qq.com"</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_port'</span>] = 465</span><br><span class="line">gitlab_rails[<span class="string">'smtp_user_name'</span>] = <span class="string">"xxxx@xx.com"</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_password'</span>] = <span class="string">"password"</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_authentication'</span>] = <span class="string">"login"</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_enable_starttls_auto'</span>] = <span class="literal">true</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_tls'</span>] = <span class="literal">true</span></span><br><span class="line">gitlab_rails[<span class="string">'gitlab_email_from'</span>] = <span class="string">'xxxx@xx.com'</span></span><br></pre></td></tr></table></figure>
<h3 id="163-邮箱"><a href="#163-邮箱" class="headerlink" title="163 邮箱"></a>163 邮箱</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑 gitlab.rb</span></span><br><span class="line">vim /etc/gitlab/gitlab.rb</span><br><span class="line"></span><br><span class="line">gitlab_rails[<span class="string">'smtp_enable'</span>] = <span class="literal">true</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_address'</span>] = <span class="string">"smtp.163.com"</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_port'</span>] = 25</span><br><span class="line">gitlab_rails[<span class="string">'smtp_user_name'</span>] = <span class="string">"gitlab@163.com"</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_password'</span>] = <span class="string">"123456"</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_domain'</span>] = <span class="string">"163.com"</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_authentication'</span>] = <span class="string">"login"</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_enable_starttls_auto'</span>] = <span class="literal">true</span></span><br><span class="line">gitlab_rails[<span class="string">'gitlab_email_from'</span>] = <span class="string">'gitlab@163.com'</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_tls'</span>] = <span class="literal">false</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_openssl_verify_mode'</span>] = <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h3 id="阿里云企业邮箱"><a href="#阿里云企业邮箱" class="headerlink" title="阿里云企业邮箱"></a>阿里云企业邮箱</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑 gitlab.rb</span></span><br><span class="line">vim /etc/gitlab/gitlab.rb</span><br><span class="line"></span><br><span class="line">gitlab_rails[<span class="string">'smtp_enable'</span>] = <span class="literal">true</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_address'</span>] = <span class="string">"smtp.mxhichina.com"</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_port'</span>] = 465</span><br><span class="line">gitlab_rails[<span class="string">'smtp_user_name'</span>] = <span class="string">"gitlab@aliyun.com"</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_password'</span>] = <span class="string">"************"</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_domain'</span>] = <span class="string">"aliyun.com"</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_authentication'</span>] = <span class="string">"login"</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_enable_starttls_auto'</span>] = <span class="literal">true</span></span><br><span class="line">gitlab_rails[<span class="string">'gitlab_email_from'</span>] = <span class="string">'gitlab@aliyun.com'</span></span><br></pre></td></tr></table></figure>
<h2 id="GitLab-使用"><a href="#GitLab-使用" class="headerlink" title="GitLab 使用"></a>GitLab 使用</h2><h3 id="登录-GitLab"><a href="#登录-GitLab" class="headerlink" title="登录 GitLab"></a>登录 GitLab</h3><ol>
<li>在浏览器的地址栏中输入 IP 即可登录 GitLab 的界面，老版本第一次登录使用的用户名和密码为 <code>root</code> 和 <code>5iveL!fe</code></li>
<li>首次登录会强制用户修改密码。密码修改成功后，输入新密码进行登录</li>
</ol>
<h3 id="创建-Project"><a href="#创建-Project" class="headerlink" title="创建 Project"></a>创建 Project</h3><ol>
<li><p>安装 Git 工具 linux：安装 Git，使用自带的源安装</p>
<p> yum install git</p>
</li>
<li><p>生成密钥文件：使用 ssh-keygen 生成密钥文件. ssh/id_rsa.pub。</p>
<p> ssh-keygen -t rsa</p>
</li>
<li><p>在 GitLab 的主页中新建一个 Project</p>
</li>
<li><p>添加 ssh key 导入步骤 2 中生成的密钥文件内容：</p>
<p> Profile Settings =&gt; SSH Keys =&gt; Add SSH key</p>
</li>
</ol>
<h3 id="简单配置"><a href="#简单配置" class="headerlink" title="简单配置"></a>简单配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置使用 Git 仓库的人员姓名</span></span><br><span class="line">git config --global user.name <span class="string">"wangao"</span> </span><br><span class="line"><span class="comment"># 配置使用 Git 仓库的人员 email，填写自己的公司邮箱</span></span><br><span class="line">git config --global user.email <span class="string">"wangao@test.com"</span> </span><br><span class="line"><span class="comment"># 克隆项目，在本地生成同名目录，并且目录中会有所有的项目文件</span></span><br><span class="line">git <span class="built_in">clone</span> git@172.28.70.126:root/test.git</span><br><span class="line"><span class="comment"># 进入到项目目录</span></span><br><span class="line"><span class="built_in">cd</span> <span class="built_in">test</span>/ </span><br><span class="line"><span class="comment"># 创建需要上传到 GitLab 中的目标文件</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"test"</span> &gt; test.sh</span><br><span class="line"><span class="comment"># 将 test.sh 文件加入到索引中</span></span><br><span class="line">git add test.sh</span><br><span class="line"><span class="comment"># 将 test.sh 提交到本地仓库</span></span><br><span class="line">git commit -m <span class="string">"test.sh"</span></span><br><span class="line"><span class="comment"># 将文件同步到 GitLab 服务器上</span></span><br><span class="line">git push -u origin master</span><br><span class="line"><span class="comment"># 在网页中查看上传的 test.sh 文件已经同步到 GitLab 中</span></span><br></pre></td></tr></table></figure>
<h2 id="配置-GitLab"><a href="#配置-GitLab" class="headerlink" title="配置 GitLab"></a>配置 GitLab</h2><h3 id="设置外部访问链接"><a href="#设置外部访问链接" class="headerlink" title="设置外部访问链接"></a>设置外部访问链接</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑 /etc/gitlab/gitlab.rb</span></span><br><span class="line">vim /etc/gitlab/gitlab.rb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改第 13 行，改成 http(s)://ip(: 端口) 或者 http(s):// 域名 (: 端口)，（如果云主机上存在 Web 服务占用了 80,443 端口，则 GitLab 不能适用 80,443），比如：</span></span><br><span class="line">external_url <span class="string">"https://repo.gitlab.com"</span></span><br></pre></td></tr></table></figure>
<h3 id="HTTPS-配置"><a href="#HTTPS-配置" class="headerlink" title="HTTPS 配置"></a>HTTPS 配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第 513 行开始，将 SSL 证书以及密钥放入 / etc/gitlab/ssl/</span></span><br><span class="line">nginx[<span class="string">'enable'</span>] = <span class="literal">true</span></span><br><span class="line">nginx[<span class="string">'redirect_http_to_https'</span>] = <span class="literal">true</span></span><br><span class="line">nginx[<span class="string">'ssl_certificate'</span>] = <span class="string">"/etc/gitlab/ssl/server.crt"</span></span><br><span class="line">nginx[<span class="string">'ssl_certificate_key'</span>] = <span class="string">"/etc/gitlab/ssl/server.key"</span></span><br></pre></td></tr></table></figure>
<h3 id="应用配置"><a href="#应用配置" class="headerlink" title="应用配置"></a>应用配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使配置生效</span></span><br><span class="line">sudo gitlab-ctl reconfigure</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启 gitlab</span></span><br><span class="line">sudo gitlab-ctl start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">sudo gitlab-ctl status</span><br></pre></td></tr></table></figure>
<h2 id="GitLab-备份升级迁移"><a href="#GitLab-备份升级迁移" class="headerlink" title="GitLab 备份升级迁移"></a>GitLab 备份升级迁移</h2><h3 id="GitLab-备份"><a href="#GitLab-备份" class="headerlink" title="GitLab 备份"></a>GitLab 备份</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">ansible-rhel7.4@JQ/opt/gitlab/etc<span class="comment">#gitlab-rake gitlab:backup:create</span></span><br><span class="line">Dumping database ... </span><br><span class="line">Dumping PostgreSQL database gitlabhq_production ... [DONE]</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">Dumping repositories ...</span><br><span class="line"> * root/ansible ... [DONE]</span><br><span class="line"> * root/ansible.wiki ...  [SKIPPED]</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">Dumping uploads ... </span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">Dumping builds ... </span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">Dumping artifacts ... </span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">Dumping pages ... </span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">Dumping lfs objects ... </span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">Dumping container registry images ... </span><br><span class="line">[DISABLED]</span><br><span class="line">Creating backup archive: 1524016954_2018_04_18_10.6.3_gitlab_backup.tar ... <span class="keyword">done</span></span><br><span class="line">Uploading backup archive to remote storage  ... skipped</span><br><span class="line">Deleting tmp directories ... <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">Deleting old backups ... skipping</span><br><span class="line"></span><br><span class="line">ansible-rhel7.4@JQ/opt/gitlab<span class="comment">#cd /var/opt/gitlab/backups</span></span><br><span class="line">ansible-rhel7.4@JQ/var/opt/gitlab/backups<span class="comment">#ll</span></span><br><span class="line">total 22372</span><br><span class="line">-rw------- 1 git git 22906880 Apr 18 10:02 1524016954_2018_04_18_10.6.3_gitlab_backup.tar</span><br></pre></td></tr></table></figure>
<h3 id="GitLab-升级"><a href="#GitLab-升级" class="headerlink" title="GitLab 升级"></a>GitLab 升级</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 停止 gitlab 相关服务</span></span><br><span class="line">gitlab-ctl stop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载离线包升级 gitlab，建议不要跨 3 个以上大版本升级，具体升级方案请参考官方文档</span></span><br><span class="line">rpm -Uvh gitlab-ce-10.6.3-ce.0.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新配置 gitlab</span></span><br><span class="line">gitlab-ctl reconfigure</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 gitlab</span></span><br><span class="line">gitlab-ctl start</span><br></pre></td></tr></table></figure>
<h3 id="GitLab-迁移"><a href="#GitLab-迁移" class="headerlink" title="GitLab 迁移"></a>GitLab 迁移</h3><ol>
<li>GitLab 迁移的前提是新旧机器 GitLab 版本必须一致</li>
<li>在旧机器备份, 默认会在 / var/opt/gitlab/backups/ 创建备份文件 #gitlab-rake gitlab:backup:create</li>
<li>复制备份文件到新机器 /var/opt/gitlab/backups/</li>
<li>在新机器运行下面命令, 停止相关数据连接服务, 然后从备份文件恢复</li>
<li>启动 gitlab</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 停止 gitlab</span></span><br><span class="line">gitlab-ctl stop</span><br><span class="line"><span class="comment"># 从 1524016954 编号备份中恢复</span></span><br><span class="line">gitlab-rake gitlab:backup:restore BACKUP=1524016954 </span><br><span class="line"><span class="comment"># 启动 gitlab</span></span><br><span class="line">gitlab-ctl start</span><br></pre></td></tr></table></figure>
<h2 id="GitLab-常见问题"><a href="#GitLab-常见问题" class="headerlink" title="GitLab 常见问题"></a>GitLab 常见问题</h2><h3 id="更改管理员密码"><a href="#更改管理员密码" class="headerlink" title="更改管理员密码"></a>更改管理员密码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">gitlab-rails console production</span><br><span class="line"></span><br><span class="line">Loading production environment (Rails 4.8.5.2)</span><br><span class="line">irb(main):001:0&gt; user = User.where(id: 1).first</span><br><span class="line">=&gt; <span class="comment">#&lt;User id: 1, email: "admin@example.com", ...</span></span><br><span class="line">irb(main):002:0&gt; user.password=123456</span><br><span class="line">=&gt; 123456</span><br><span class="line">irb(main):003:0&gt; user.password_confirmation=123456</span><br><span class="line">=&gt; 123456</span><br><span class="line">irb(main):004:0&gt; user.save!</span><br><span class="line">=&gt; <span class="literal">true</span></span><br><span class="line">irb(main):005:0&gt; quit</span><br></pre></td></tr></table></figure>
<h3 id="The-requested-URL-returned-error-401-while-accessing"><a href="#The-requested-URL-returned-error-401-while-accessing" class="headerlink" title="The requested URL returned error: 401 while accessing"></a>The requested URL returned error: 401 while accessing</h3><blockquote>
<p>这里遇到的问题是因为需要在参数里增加授权后的用户名和密码，不排除可能因为其它问题引起相同报错，如果是 403 可能是私有仓库没有授权导致</p>
</blockquote>
<p>(ox-zRbE61dW) test101@JQ/home/ox/git$git clone <a href="http://172.31.96.248/wangao/ansible.git" target="_blank" rel="noopener">http://172.31.96.248/wangao/ansible.git</a><br>Initialized empty Git repository in /home/ox/git/ansible/.git/<br>error: The requested URL returned error: 401 while accessing <a href="http://172.31.96.248/wangao/ansible.git/info/refs" target="_blank" rel="noopener">http://172.31.96.248/wangao/ansible.git/info/refs</a></p>
<p>fatal: HTTP request failed<br>(ox-zRbE61dW) test101@JQ/home/ox/git$git clone <a href="http://guest:xxxxxx@172.31.96.248/wangao/ansible.git" target="_blank" rel="noopener">http://guest:xxxxxx@172.31.96.248/wangao/ansible.git</a><br>Initialized empty Git repository in /home/ox/git/ansible/.git/<br>remote: Counting objects: 257, done.<br>remote: Compressing objects: 100% (153/153), done.<br>remote: Total 257 (delta 91), reused 254 (delta 91)<br>Receiving objects: 100% (257/257), 21.77 MiB | 19.18 MiB/s, done.<br>Resolving deltas: 100% (91/91), done.<br>(ox-zRbE61dW) test101@JQ/home/ox/git$</p>
<h3 id="webhooks-不生效"><a href="#webhooks-不生效" class="headerlink" title="webhooks 不生效"></a>webhooks 不生效</h3><p><a href="https://gitlab.com/gitlab-org/gitlab-ce/issues/45334" target="_blank" rel="noopener">https://gitlab.com/gitlab-org/gitlab-ce/issues/45334</a><br><a href="https://gitlab.com/gitlab-org/omnibus-gitlab/issues/3307#note_64245578" target="_blank" rel="noopener">https://gitlab.com/gitlab-org/omnibus-gitlab/issues/3307#note_64245578</a></p>
<p>Admin Area - Settings - Outbound request - 勾选以下内容<br>Allow request to the local network from hooks and services</p>
<p><img src="https://www.ilanni.com/wp-content/uploads/2018/04/clip_image011_thumb-1.png" alt=""></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/学习-Study/">学习 | Study</a>
</div>


</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://wsgzao.github.io/post/gitlab/" data-title="RHEL7/CentOS7 在线和离线安装 GitLab 配置使用实践 | HelloDog" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/post/hexo-jacman/" title="Jacman 基于 Pacman 修改的 Hexo 主题">
  <strong>上一篇：</strong><br/>
  <span>
  Jacman 基于 Pacman 修改的 Hexo 主题</span>
</a>
</div>


<div class="next">
<a href="/post/3proxy/"  title="3proxy 使用指北">
 <strong>下一篇：</strong><br/> 
 <span>3proxy 使用指北
</span>
</a>
</div>

</nav>

	

<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>



</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更新记录"><span class="toc-number">2.</span> <span class="toc-text">更新记录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GitLab-简介"><span class="toc-number">3.</span> <span class="toc-text">GitLab 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Gitlab-的服务构成"><span class="toc-number">3.1.</span> <span class="toc-text">Gitlab 的服务构成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GitLab-工作流程"><span class="toc-number">3.2.</span> <span class="toc-text">GitLab 工作流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GitLab-安装"><span class="toc-number">4.</span> <span class="toc-text">GitLab 安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基础依赖"><span class="toc-number">4.1.</span> <span class="toc-text">基础依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在线安装-gitlab-ce"><span class="toc-number">4.2.</span> <span class="toc-text">在线安装 gitlab-ce</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#离线安装-gitlab-ce"><span class="toc-number">4.3.</span> <span class="toc-text">离线安装 gitlab-ce</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GitLab-汉化"><span class="toc-number">5.</span> <span class="toc-text">GitLab 汉化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GitLab-常用命令"><span class="toc-number">6.</span> <span class="toc-text">GitLab 常用命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#公网邮箱配置"><span class="toc-number">7.</span> <span class="toc-text">公网邮箱配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#QQ-企业邮箱"><span class="toc-number">7.1.</span> <span class="toc-text">QQ 企业邮箱</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#163-邮箱"><span class="toc-number">7.2.</span> <span class="toc-text">163 邮箱</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#阿里云企业邮箱"><span class="toc-number">7.3.</span> <span class="toc-text">阿里云企业邮箱</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GitLab-使用"><span class="toc-number">8.</span> <span class="toc-text">GitLab 使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#登录-GitLab"><span class="toc-number">8.1.</span> <span class="toc-text">登录 GitLab</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建-Project"><span class="toc-number">8.2.</span> <span class="toc-text">创建 Project</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#简单配置"><span class="toc-number">8.3.</span> <span class="toc-text">简单配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置-GitLab"><span class="toc-number">9.</span> <span class="toc-text">配置 GitLab</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#设置外部访问链接"><span class="toc-number">9.1.</span> <span class="toc-text">设置外部访问链接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTPS-配置"><span class="toc-number">9.2.</span> <span class="toc-text">HTTPS 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#应用配置"><span class="toc-number">9.3.</span> <span class="toc-text">应用配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GitLab-备份升级迁移"><span class="toc-number">10.</span> <span class="toc-text">GitLab 备份升级迁移</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GitLab-备份"><span class="toc-number">10.1.</span> <span class="toc-text">GitLab 备份</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GitLab-升级"><span class="toc-number">10.2.</span> <span class="toc-text">GitLab 升级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GitLab-迁移"><span class="toc-number">10.3.</span> <span class="toc-text">GitLab 迁移</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GitLab-常见问题"><span class="toc-number">11.</span> <span class="toc-text">GitLab 常见问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#更改管理员密码"><span class="toc-number">11.1.</span> <span class="toc-text">更改管理员密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The-requested-URL-returned-error-401-while-accessing"><span class="toc-number">11.2.</span> <span class="toc-text">The requested URL returned error: 401 while accessing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#webhooks-不生效"><span class="toc-number">11.3.</span> <span class="toc-text">webhooks 不生效</span></a></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="wsgzao" data-theme="medium"></div>
<script type="text/javascript" src="//lab.lepture.com/github-cards/widget.js" ></script>
</div>



  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Hexo/" title="Hexo">Hexo<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/学习-Study/" title="学习 | Study">学习 | Study<sup>137</sup></a></li>
		  
		
		  
			<li><a href="/categories/生活-Life/" title="生活 | Life">生活 | Life<sup>15</sup></a></li>
		  
		
		  
			<li><a href="/categories/软件-Soft/" title="软件 | Soft">软件 | Soft<sup>5</sup></a></li>
		  
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.linkedin.com/in/aowang" target="_blank" title="LinkedIn">LinkedIn</a>
            
          </li>
        
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello, I&#39;m OX. This is my blog on GitHub. <br/>
			Keep Calm and Carry On.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		<a href="https://github.com/wsgzao" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		<a href="https://www.linkedin.com/in/aowang" target="_blank" class="icon-linkedin" title="linkedin"></a>
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2019 
		
		<a href="/about" target="_blank" title="wsgzao">wsgzao</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>




<script type="text/javascript">

var disqus_shortname = 'wsgzao';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>








<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->

<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-77732745-1', 'wsgzao.github.io');  
ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?c2c5fc7d844d0973d9f77abd87f49c3c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- swiftype Begin -->

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','_4qDmKrBPn9Es3UvQHT4','2.0.0');
</script>

<!-- swiftype End -->

  </body>
</html>
